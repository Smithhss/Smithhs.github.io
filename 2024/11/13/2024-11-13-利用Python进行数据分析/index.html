<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>利用Python进行数据分析 | Smith</title><meta name="keywords" content="Python"><meta name="author" content="Smith"><meta name="copyright" content="Smith"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="利用Python进行数据分析"><meta name="application-name" content="利用Python进行数据分析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="利用Python进行数据分析"><meta property="og:url" content="https://smithhs.cn/2024/11/13/2024-11-13-%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/index.html"><meta property="og:site_name" content="Smith"><meta property="og:description" content="第一章 准备工作本书主要内容本书讲的是利用Python进行数据控制、处理、整理、分析等方面的具体细节和基本要点。同时，它也是利用Python进行科学计算的实用指南（专门针对数据密集型应用）。本书重点介绍了用于高效解决各种数据分析问题的Python语言和库。本书没有阐述如何利用Python实现具体的分"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><meta property="article:author" content="Smith"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://smithhs.cn/2024/11/13/2024-11-13-%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//npm.elemecdn.com"/><link rel="preconnect" href="//npm.onmicrosoft.cn"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":240},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#3b70fc","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '利用Python进行数据分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-20 17:14:56',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d20f536c64d06e5fcf4bfe2ec5dc25d.jpg"/><div class="loading-image-dot"></div><div id="loading-percentage">0%</div></div></div><script>if (GLOBAL_CONFIG.preloader.source == "2" || GLOBAL_CONFIG.preloader.source == "3") {
  const loadingPercentage = document.getElementById("loading-percentage");
  let loadingPercentageTimer = setInterval(function() {
    var progressBar = document.querySelector(".pace-progress");
    if (!progressBar) return
    var currentValue = progressBar.getAttribute("data-progress-text");
    if (currentValue !== loadingPercentage.textContent) {
      loadingPercentage.textContent = currentValue;
      if (currentValue === "100%") {
        clearInterval(loadingPercentageTimer);
      }
    }
  }, 100);
}

const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div id="web_box"><div id="web_container"><div id="menu-mask"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://smithhs.cn/" title="博客" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" href="http://robot.onliu.cn/" title="Robot" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/cupfox.png" alt="Robot"/><span class="back-menu-item-text">Robot</span></a><a class="back-menu-item" href="http://res.onliu.cn" title="Sale" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://alandodo-1315761622.cos.ap-beijing.myqcloud.com/blog-tuce/tubiao.jpg" alt="Sale"/><span class="back-menu-item-text">Sale</span></a><a class="back-menu-item" href="http://se.onliu.cn/" title="资源共享" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://alandodo-1315761622.cos.ap-beijing.myqcloud.com/blog/x126.png" alt="资源共享"/><span class="back-menu-item-text">资源共享</span></a><a class="back-menu-item" href="https://github.com/Smithhss" title="Github" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/GitHub.png" alt="Github"/><span class="back-menu-item-text">Github</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Smith</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于我</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1.jpg" target="_blank"><img class="post-qr-code-img" alt="wechat" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1.jpg"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2.jpg" target="_blank"><img class="post-qr-code-img" alt="alipay" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2.jpg"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> <span>最新评论</span></span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Android-Studio/" style="font-size: 1.05rem;">Android Studio<sup>1</sup></a><a href="/tags/App/" style="font-size: 1.05rem;">App<sup>2</sup></a><a href="/tags/Butterfly/" style="font-size: 1.05rem;">Butterfly<sup>1</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C++<sup>1</sup></a><a href="/tags/CSS/" style="font-size: 1.05rem;">CSS<sup>1</sup></a><a href="/tags/Cisco-Packet-Tracer/" style="font-size: 1.05rem;">Cisco Packet Tracer<sup>1</sup></a><a href="/tags/Easypan/" style="font-size: 1.05rem;">Easypan<sup>2</sup></a><a href="/tags/FurtherMathematics/" style="font-size: 1.05rem;">FurtherMathematics<sup>1</sup></a><a href="/tags/GPT/" style="font-size: 1.05rem;">GPT<sup>1</sup></a><a href="/tags/Git2/" style="font-size: 1.05rem;">Git2<sup>1</sup></a><a href="/tags/HTML/" style="font-size: 1.05rem;">HTML<sup>1</sup></a><a href="/tags/Hexo/" style="font-size: 1.05rem;">Hexo<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>6</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem;">JavaScript<sup>1</sup></a><a href="/tags/JavaWeb/" style="font-size: 1.05rem;">JavaWeb<sup>2</sup></a><a href="/tags/LeetCode/" style="font-size: 1.05rem;">LeetCode<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>2</sup></a><a href="/tags/Markdown/" style="font-size: 1.05rem;">Markdown<sup>2</sup></a><a href="/tags/Maven/" style="font-size: 1.05rem;">Maven<sup>2</sup></a><a href="/tags/Mysql/" style="font-size: 1.05rem;">Mysql<sup>1</sup></a><a href="/tags/Navicat/" style="font-size: 1.05rem;">Navicat<sup>1</sup></a><a href="/tags/NoSql/" style="font-size: 1.05rem;">NoSql<sup>1</sup></a><a href="/tags/Nodejs/" style="font-size: 1.05rem;">Nodejs<sup>2</sup></a><a href="/tags/Python/" style="font-size: 1.05rem;">Python<sup>4</sup></a><a href="/tags/Spring/" style="font-size: 1.05rem;">Spring<sup>2</sup></a><a href="/tags/VMware/" style="font-size: 1.05rem;">VMware<sup>2</sup></a><a href="/tags/Vue/" style="font-size: 1.05rem;">Vue<sup>1</sup></a><a href="/tags/YouHou/" style="font-size: 1.05rem;">YouHou<sup>1</sup></a><a href="/tags/books/" style="font-size: 1.05rem;">books<sup>1</sup></a><a href="/tags/butterfly/" style="font-size: 1.05rem;">butterfly<sup>1</sup></a><a href="/tags/clash/" style="font-size: 1.05rem;">clash<sup>1</sup></a><a href="/tags/project/" style="font-size: 1.05rem;">project<sup>4</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 1.05rem;">前端<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/" style="font-size: 1.05rem;">开发框架<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" style="font-size: 1.05rem;">开发环境<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">操作系统<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">数据结构与算法<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" style="font-size: 1.05rem;">计算机组成原理<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">计算机网络<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" style="font-size: 1.05rem;">软件工程<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">17</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" onclick="anzhiyu.switchDarkMode()" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Programming/">Programming</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Python/" tabindex="-1"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Python</span></a></span></div></div><h1 class="post-title">利用Python进行数据分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="post-meta-icon anzhiyufont anzhiyu-icon-calendar-days"></i><span class="post-meta-label">发表于</span><time datetime="2024-11-12T21:24:34.000Z" title="发表于 2024-11-13 05:24:34">2024-11-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">33.3k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>129分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="利用Python进行数据分析"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为石家庄"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>石家庄</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第一章-准备工作"><a href="#第一章-准备工作" class="headerlink" title="第一章 准备工作"></a>第一章 准备工作</h1><h2 id="本书主要内容"><a href="#本书主要内容" class="headerlink" title="本书主要内容"></a>本书主要内容</h2><p>本书讲的是利用Python进行数据控制、处理、整理、分析等方面的具体细节和基本要点。同时，它也是利用Python进行科学计算的实用指南（专门针对数据密集型应用）。本书重点介绍了用于高效解决各种数据分析问题的Python语言和库。本书没有阐述如何利用Python实现具体的分析方法。</p>
<p>当书中出现“数据”时，究竟指的是什么呢？主要指的是结构化数据（structured data），这个故意含糊其辞的术语代指了所有通用格式的数据，例如：</p>
<ul>
<li><p>多维数组（矩阵）。</p>
</li>
<li><p>表格型数据，其中各列可能是不同的类型（字符串、数值、日期等）。比如保存在关系型数据库中或以制表符&#x2F;逗号为分隔符的文本文件中的那些数据。</p>
</li>
<li><p>通过关键列（对于SQL用户而言，就是主键和外键）相互联系的多个表。</p>
</li>
<li><p>间隔平均或不平均的时间序列。</p>
</li>
</ul>
<p>这绝不是一个完整的列表。大部分数据集都能被转化为更加适合分析和建模的结构化形式，虽然有时这并不是很明显。如果不行的话，也可以将数据集的特征提取为某种结构化形式。例如，一组新闻文章可以被处理为一张词频表，而这张词频表就可以用于情感分析。</p>
<p>大部分电子表格软件（比如Microsoft Excel，它可能是世界上使用最广泛的数据分析工具了）的用户不会对此类数据感到陌生。</p>
<h2 id="为什么要使用Python进行数据分析"><a href="#为什么要使用Python进行数据分析" class="headerlink" title="为什么要使用Python进行数据分析"></a>为什么要使用Python进行数据分析</h2><p>许许多多的人（包括我自己）都很容易爱上Python这门语言。自从1991年诞生以来，Python现在已经成为最受欢迎的动态编程语言之一，其他还有Perl、Ruby等。由于拥有大量的Web框架（比如Rails（Ruby）和Django（Python）），最近几年非常流行使用Python和Ruby进行网站建设工作。这些语言常被称作脚本（scripting）语言，因为它们可以用于编写简短而粗糙的小程序（也就是脚本）。我个人并不喜欢“脚本语言”这个术语，因为它好像在说这些语言无法用于构建严谨的软件。在众多解释型语言中，Python最大的特点是拥有一个巨大而活跃的科学计算（scientific computing）社区。进入21世纪以来，在行业应用和学术研究中采用Python进行科学计算的势头越来越猛。</p>
<p>在数据分析和交互、探索性计算以及数据可视化等方面，Python将不可避免地接近于其他开源和商业的领域特定编程语言&#x2F;工具，如R、MATLAB、SAS、Stata等。近年来，由于Python有不断改良的库（主要是pandas），使其成为数据处理任务的一大替代方案。结合其在通用编程方面的强大实力，我们完全可以只使用Python这一种语言去构建以数据为中心的应用程序。</p>
<h3 id="把Python当做粘合剂"><a href="#把Python当做粘合剂" class="headerlink" title="把Python当做粘合剂"></a>把Python当做粘合剂</h3><p>作为一个科学计算平台，Python的成功部分源于其能够轻松地集成C、C＋＋以及Fortran 代码。大部分现代计算环境都利用了一些Fortran和C库来实现线性代数、优选、积分、快速傅里叶变换以及其他诸如此类的算法。许多企业和国家实验室也利用Python来“粘合”那些已经用了30多年的遗留软件系统。</p>
<p>大多数软件都是由两部分代码组成的：少量需要占用大部分执行时间的代码，以及大量不经常执行的“粘合剂代码”。粘合剂代码的执行时间通常是微不足道的。开发人员的精力几乎都是花在优化计算瓶颈上面的，有时更是直接转用更低级的语言（比如C）。</p>
<p>最近这几年，Cython项目（<a target="_blank" rel="noopener" href="http://cython.org)已经成为python领域中创建编译型扩展以及对接c/C%EF%BC%8B%EF%BC%8B%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B8%80%E5%A4%A7%E9%80%94%E5%BE%84%E3%80%82">http://cython.org）已经成为Python领域中创建编译型扩展以及对接C/C＋＋代码的一大途径。</a></p>
<h3 id="解决“两种语言”问题"><a href="#解决“两种语言”问题" class="headerlink" title="解决“两种语言”问题"></a>解决“两种语言”问题</h3><p>很多组织通常都会用一种类似于领域特定的计算语言（如MATLAB和R）对新的想法进行研究、原型构建和测试，然后再将这些想法移植到某个更大的生产系统中去（可能是用Java、C＃或C＋＋编写的）。人们逐渐意识到，Python不仅适用于研究和原型构建，同时也适用于构建生产系统。我相信越来越多的企业也会这样看，因为研究人员和工程技术人员使用同一种编程工具将会给企业带来非常显著的组织效益。</p>
<h3 id="为什么不选Python"><a href="#为什么不选Python" class="headerlink" title="为什么不选Python"></a>为什么不选Python</h3><p>虽然Python非常适合构建计算密集型科学应用程序以及几乎各种各样的通用系统，但它对于不少应用场景仍然力有不逮。</p>
<p>由于Python是一种解释型编程语言，因此大部分Python代码都要比用编译型语言（比如Java和C＋＋）编写的代码运行慢得多。由于程序员的时间通常都比CPU时间值钱，因此许多人也愿意在这里做一些权衡。但是，在那些要求延迟非常小的应用程序中（例如高频交易系统），为了尽最大可能地优化性能，耗费时间使用诸如C＋＋这样更低级、更低生产率的语言进行编程也是值得的。</p>
<p>对于高并发、多线程的应用程序而言（尤其是拥有许多计算密集型线程的应用程序），Python并不是一种理想的编程语言。这是因为Python有一个叫做全局解释器锁（Global Interpreter Lock，GIL）的东西，这是一种防止解释器同时执行多条Python字节码指令的机制。有关“为什么会存在GIL”的技术性原因超出了本书的范围，但是就目前来看，GIL并不会在短时间内消失。虽然很多大数据处理应用程序为了能在较短的时间内完成数据集的处理工作都需要运行在计算机集群上，但是仍然有一些情况需要用单进程多线程系统来解决。</p>
<p>这并不是说Python不能执行真正的多线程并行代码，只不过这些代码不能在单个Python 进程中执行而已。比如说，Cython项目可以集成OpenMP（一个用于并行计算的C框架）以实现并行处理循环进而大幅度提高数值算法的速度。</p>
<h2 id="重要的Python库"><a href="#重要的Python库" class="headerlink" title="重要的Python库"></a>重要的Python库</h2><p>考虑到那些还不太了解Python科学计算生态系统和库的读者，下面我先对各个库做一个简单的介绍。</p>
<h3 id="NumPy"><a href="#NumPy" class="headerlink" title="NumPy"></a>NumPy</h3><p>NumPy（Numerical Python的简称）是Python科学计算的基础包。本书大部分内容都基于NumPy以及构建于其上的库。它提供了以下功能（不限于此）：</p>
<ul>
<li><p>快速高效的多维数组对象ndarray。</p>
</li>
<li><p>用于对数组执行元素级计算以及直接对数组执行数学运算的函数。</p>
</li>
<li><p>用于读写硬盘上基于数组的数据集的工具。</p>
</li>
<li><p>线性代数运算、傅里叶变换，以及随机数生成。</p>
</li>
<li><p>用于将C、C＋＋、Fortran代码集成到Python的工具。</p>
</li>
</ul>
<p>除了为Python提供快速的数组处理能力，NumPy在数据分析方面还有另外一个主要作用，即作为在算法之间传递数据的容器。对于数值型数据，NumPy数组在存储和处理数据时要比内置的Python数据结构高效得多。此外，由低级语言（比如C和Fortran）编写的库可以直接操作NumPy数组中的数据，无需进行任何数据复制工作。</p>
<h3 id="pandas"><a href="#pandas" class="headerlink" title="pandas"></a>pandas</h3><p>pandas提供了使我们能够快速便捷地处理结构化数据的大量数据结构和函数。你很快就会发现，它是使Python成为强大而高效的数据分析环境的重要因素之一。本书用得最多的pandas对象是DataFrame，它是一个面向列（column-oriented）的二维表结构，且含有行标和列标：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/QQ20241120-150037.png"></p>
<p>pandas兼具NumPy高性能的数组计算功能以及电子表格和关系型数据库（如SQL）灵活的数据处理功能。它提供了复杂精细的索引功能，以便更为便捷地完成重塑、切片和切块、聚合以及选取数据子集等操作。pandas将是我在本书中使用的主要工具。</p>
<p>对于金融行业的用户，pandas提供了大量适用于金融数据的高性能时间序列功能和工具。事实上，我一开始就是想把pandas设计为一款适用于金融数据分析应用的工具。</p>
<p>对于使用R语言进行统计计算的用户，肯定不会对DataFrame这个名字感到陌生，因为它源自于R的data.frame对象。但是这两个对象并不相同。R的data.frame对象所提供的功能只是DataFrame对象所提供的功能的一个子集。虽然本书讲的是Python，但我偶尔还是会用R做对比，因为它毕竟是最流行的开源数据分析环境，而且很多读者都对它很熟悉。</p>
<p>pandas这个名字本身源自于panel data（面板数据，这是计量经济学中关于多维结构化数据集的一个术语）以及Python data analysis（Python数据分析）。</p>
<h3 id="matplotlib"><a href="#matplotlib" class="headerlink" title="matplotlib"></a>matplotlib</h3><p>matplotlib是最流行的用于绘制数据图表的Python库。它最初由John D* Hunter （JDH）创建，目前由一个庞大的开发人员团队维护。它非常适合创建出版物上用的图表。它跟IPython（马上就会讲到）结合得很好，因而提供了一种非常好用的交互式数据绘图环境。绘制的图表也是交互式的，你可以利用绘图窗口中的工具栏放大图表中的某个区域或对整个图表进行平移浏览。</p>
<h3 id="IPython"><a href="#IPython" class="headerlink" title="IPython"></a>IPython</h3><p>IPyhon是Python科学计算标准工具集的组成部分，它将其他所有的东西联系到了一起。它为交互式和探索式计算提供了一个强健而高效的环境。它是一个增强的Python shell，目的是提高编写、测试、调试Python代码的速度。它主要用于交互式数据处理和利用matplotlib对数据进行可视化处理。我在用Python编程时，经常会用到IPython，包括运行、调试和测试代码。</p>
<p>除标准的基于终端的IPython shell外，该项目还提供了：</p>
<ul>
<li><p>一个类似于Mathematica的HTML笔记本（通过Web浏览器连接IPython，稍后将对此进行详细介绍）。</p>
</li>
<li><p>一个基于Qt框架的GUI控制台，其中含有绘图、多行编辑以及语法高亮显示等功能。</p>
</li>
</ul>
<p>.用于交互式并行和分布式计算的基础架构。</p>
<p>我将在一章中专门讲解IPython，详细地介绍其大部分功能。强烈建议在阅读本书的过程中使用IPython。</p>
<h3 id="SciPy"><a href="#SciPy" class="headerlink" title="SciPy"></a>SciPy</h3><p>SciPy是一组专门解决科学计算中各种标准问题域的包的集合，主要包括下面这些包：</p>
<ul>
<li><p>scipy.integrate：数值积分例程和微分方程求解器。</p>
</li>
<li><p>scipy.linalg：扩展了由numpy.linalg提供的线性代数例程和矩阵分解功能。</p>
</li>
<li><p>scipy.optimize：函数优化器（最小化器）以及根查找算法。</p>
</li>
<li><p>scipy.signal：信号处理工具。</p>
</li>
<li><p>scipy.sparse：稀疏矩阵和稀疏线性系统求解器。</p>
</li>
<li><p>scipy.special：SPECFUN（这是一个实现了许多常用数学函数（如伽玛函数）的Fortran库）的包装器。</p>
</li>
<li><p>scipy.stats：标准连续和离散概率分布（如密度函数、采样器、连续分布函数等）、各种统计检验方法，以及更好的描述统计法。</p>
</li>
<li><p>scipy.weave：利用内联C＋＋代码加速数组计算的工具。</p>
</li>
</ul>
<p>NumPy跟SciPy的有机结合完全可以替代MATLAB的计算功能（包括其插件工具箱）。</p>
<h2 id="安装和设置"><a href="#安装和设置" class="headerlink" title="安装和设置"></a>安装和设置</h2><p>由于人们用Python所做的事情不同，所以没有一个普适的Python及其插件包的安装方案。由于许多读者的Python科学计算环境都不能完全满足本书的需要，所以接下来我将详细介绍各个操作系统上的安装方法。我建议使用下列Python安装包之一：</p>
<ul>
<li><p>Enthought Python Distribution译注：来自Enthought（<a target="_blank" rel="noopener" href="http://continumm.io/downloads%EF%BC%89%E7%9A%84%E9%9D%A2%E5%90%91%E7%A7%91%E5%AD%A6%E8%AE%A1%E7%AE%97%E7%9A%84Python%E5%AE%89%E8%A3%85%E5%8C%85%E3%80%82%E5%8C%85%E6%8B%ACEPDFree%EF%BC%88%E5%85%8D%E8%B4%B9%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%89%88%EF%BC%8C%E5%B8%A6%E6%9C%89NumPy%E3%80%81SciPy%E3%80%81matplotli%E3%80%81Chaco%E4%BB%A5%E5%8F%8AIPython%EF%BC%89%E5%92%8CEPD">http://continumm.io/downloads）的面向科学计算的Python安装包。包括EPDFree（免费的基本版，带有NumPy、SciPy、matplotli、Chaco以及IPython）和EPD</a> Full（完整版，含有100多个针对各种领域的科学计算包）。EPD Full对高校免费，非高校用户需要缴纳年费。</p>
</li>
<li><p>Python(x,y)（<a href="http://pythonxy.googlecode.com）：Windows平台上免费的Python科学计算安装包。">http://pythonxy.googlecode.com）：Windows平台上免费的Python科学计算安装包。</a></p>
</li>
</ul>
<p>我将用EPDFree来说明安装过程，当然如果有需要的话，你也可以选择其他产品。编写本书时，EPD用的是Python 2.7，今后可能会有些变动。安装完毕之后，你将可以用到下面这些包：</p>
<ul>
<li><p>Python科学计算基础库：NumPy、SciPy、matplotlib以及IPython。这些都包含在EPDFree中了。</p>
</li>
<li><p>IPython Notebook依赖项：tornado和pyzmq。这些也都包含在EPDFree中了。</p>
</li>
<li><p>pandas（0.8.2版或更高版本）。</p>
</li>
</ul>
<p>在阅读本书的过程中，你可能还需要安装：statsmodels、PyTables、PyQt（PySide也行）、xlrd、lxml、basemap、pymongo以及requests等（它们被用在不同的示例中）。现在暂时还不需要安装这些库，我建议你在需要的时候再安装。例如，在OS X或Linux上安装PyQt或PyTables可能会很困难。目前最重要的事情是先用EPDFree和pandas这种最小配置运行起来再说。</p>
<p>关于各个Python库及其安装文件和帮助信息，请访问Python Package Index（即PyPI，<a target="_blank" rel="noopener" href="http://pypi.python.org).你还可以在这里找到不少新的python库./">http://pypi.python.org）。你还可以在这里找到不少新的Python库。</a></p>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>先从<a target="_blank" rel="noopener" href="http://www.enthought.com下载epdfree的安装包,它可能是一个名字类似于epd_free-7.3-1-win-x86.m/">http://www.enthought.com下载EPDFree的安装包，它可能是一个名字类似于epd_free-7.3-1-win-x86.m</a> s i的MSI安装包。运行该安装包并接受默认的安装位置C:\Python27。如果你之前在这里安装过Python，可能需要先将其删除（可以手工删除，也<br>可以使用控制面板中的“添加&#x2F;或删除程序”功能）。</p>
<p>接下来，你需要验证是否已经成功将Python添加到系统路径，并且没有跟早期安装的Python版本发生冲突。首先，打开命令提示符（打开“开始”菜单，启动“命令提示符”应用程序，即cmd.exe）。输入python尝试启动Python解释器。你应该可以看到与已安装的EPDFree版本相匹配的一段消息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/QQ20241120-152846.png"></p>
<p>如果你看到的是其他版本的EPD信息或根本什么也看不到，那就需要清理Windows环境变量。在Windows 7上，可以在程序搜索框中输入“environment variables”，然后编辑你的账户下的环境变量。在Windows XP上，需要进入“控制面板”→“系统”→“高级”→“环境变量”。在弹出窗口中找到Path变量。它需要含有下面这两个以分号隔开的目录路径：<br>C:\Python27;C:\Python27\Scripts</p>
<p>如果你之前安装了其他版本的Python，那就需要删除系统和用户Path变量中与之相关的一切路径。修改路径之后，需要重启命令提示符才能使修改生效。</p>
<p>能够在命令提示符中成功启动Python之后，就该安装pandas了。最简单的办法就是直接到<a target="_blank" rel="noopener" href="http://pypi.python.org/pypi/pandas%E4%B8%8B%E8%BD%BD%E5%90%88%E9%80%82%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E5%8C%85%E3%80%82%E5%AF%B9%E4%BA%8EEPDFree%EF%BC%8C%E5%BA%94%E8%AF%A5%E9%80%89%E6%8B%A9pandas-0.9.0.win32-py2.7.exe%E3%80%82%E5%B0%86%E5%85%B6%E5%AE%89%E8%A3%85%E5%A5%BD%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%90%AF%E5%8A%A8IPython%E6%9D%A5%E9%AA%8C%E8%AF%81%E4%B8%80%E4%B8%8B%E6%98%AF%E4%B8%8D%E6%98%AF%E4%B8%87%E4%BA%8B%E4%BF%B1%E5%A4%87%E4%BA%86%EF%BC%9A%E5%BC%95%E5%85%A5pandas%EF%BC%8C%E7%84%B6%E5%90%8E%E7%BB%98%E5%88%B6%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84matplotlib%E5%9B%BE%E5%BD%A2%E3%80%82">http://pypi.python.org/pypi/pandas下载合适的二进制安装包。对于EPDFree，应该选择pandas-0.9.0.win32-py2.7.exe。将其安装好之后，接下来启动IPython来验证一下是不是万事俱备了：引入pandas，然后绘制一个简单的matplotlib图形。</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/QQ20241120-152854.png"></p>
<p>如果成功，就不会出现错误信息，而且会弹出一个绘图窗口。还可以输入下列指令<strong>译注4</strong>来检查IPython HTML notebook是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipython notebook --pylab=inline</span><br></pre></td></tr></table></figure>

<p>Windows上的EPDFree只有32位版本。如果需要使用64位版本，最简单的办法就是直接使用EPD Ful1<strong>译注6</strong>。如果你不想购买EPD订阅且愿意自己动手一步步安装，可以试<br>试由加州大学欧文分校的Christoph Gohlke提供的非官方安装包（<a target="_blank" rel="noopener" href="http://www.lfd.uci.edu/~gohlke/pythonlibs/%EF%BC%89%EF%BC%8C%E5%AE%83%E6%97%A2%E6%9C%8932%E4%BD%8D%E7%89%88%E4%B9%9F%E6%9C%8964%E4%BD%8D%E7%89%88%EF%BC%8C%E4%B8%94%E5%8C%85%E5%90%AB%E6%9C%AC%E4%B9%A6%E6%89%80%E9%9C%80%E7%9A%84%E6%89%80%E6%9C%89%E5%BA%93%E3%80%82">http://www.lfd.uci.edu/~gohlke/pythonlibs/），它既有32位版也有64位版，且包含本书所需的所有库。</a></p>
<h3 id="苹果OSX"><a href="#苹果OSX" class="headerlink" title="苹果OSX"></a>苹果OSX</h3><p>在OSX上，首先需要安装Xcode，它含有苹果的软件开发工具套件。我们所需的部分是gcc C和C＋＋编译器。Xcode安装包可以在随计算机发布的OS X安装光盘中找到，也可以直接从苹果公司的网站上下载。</p>
<p>装好Xcode之后，到“Applications→Utilities”去启动终端（Terminal.app）。输入gcc并按回车键。你将会看到如下信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gcc</span><br><span class="line">i686-apple-darwin10-gcc-4.2.1: no input files</span><br></pre></td></tr></table></figure>
<p>现在就该安装EPDFree了。下载一个名为epd_free-7.3-1-macosx-i386.dmg的磁盘镜像文件。双击该.dmg文件以将其挂载到系统，然后双击其中的.mpkg文件来运行安装程序。</p>
<p>安装文件启动之后，会自动将EPDFree可执行文件的路径添加到你的.bash_profile文件中。该文件位于该文件位于&#x2F;Users&#x2F;your_uname&#x2F;.bash_profile：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Setting PATH for EPD_free-7.3-1</span></span><br><span class="line">PATH=<span class="string">&quot;/Library/Frameworks/Python.framework/Versions/Current/bin:<span class="variable">$&#123;PATH&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">export</span> PATH</span><br></pre></td></tr></table></figure>

<p>如果在后续步骤中遇到任何问题，首先应该检查一下你的.bash_profile，看看是否需要将上面那个目录添加进去。</p>
<p>现在就该安装pandas了。在终端中执行下面这条命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> easy_install pandas</span><br><span class="line">Searching <span class="keyword">for</span> pandas</span><br><span class="line">Reading http://pypi.python.org/simple/pandas/</span><br><span class="line">Reading http://pandas.pydata.org</span><br><span class="line">Reading http://pandas.sourceforge.net</span><br><span class="line">Best match: pandas 0.9.0</span><br><span class="line">Downloading http://pypi.python.org/packages/source/p/pandas/pandas-0.9.0.zip</span><br><span class="line">Processing pandas-0.9.0.zip</span><br><span class="line">Writing /tmp/easy_install-H5mIX6/pandas-0.9.0/setup.cfg</span><br><span class="line">Running pandas-0.9.0/setup.py -q bdist_egg --dist-dir /tmp/easy_install-H5mIX6/</span><br><span class="line">pandas-0.9.0/egg-dist-tmp-RhLG0z</span><br><span class="line">Adding pandas 0.9.0 to easy-install.pth file</span><br><span class="line">Installed /Library/Frameworks/Python.framework/Versions/7.3/lib/python2.7/</span><br><span class="line">site-packages/pandas-0.9.0-py2.7-macosx-10.5-i386.egg</span><br><span class="line">Processing dependencies <span class="keyword">for</span> pandas</span><br><span class="line">Finished processing dependencies <span class="keyword">for</span> pandas</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为了验证是否一切正常，我们以Pylab模式启动IPython，然后尝试加载pandas并绘制一<br>张图片：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ipython --pylab</span><br><span class="line">22:29 ~/VirtualBox VMs/WindowsXP $ ipython</span><br><span class="line">Python 2.7.3 |EPD_free 7.3-1 (32-bit)| (default, Apr 12 2012, 11:28:34)</span><br><span class="line">Type <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> or <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">IPython 0.12.1 -- An enhanced Interactive Python.</span><br><span class="line">? -&gt; Introduction and overview of IPython<span class="string">&#x27;s features.</span></span><br><span class="line"><span class="string">%quickref -&gt; Quick reference.</span></span><br><span class="line"><span class="string">help -&gt; Python&#x27;</span>s own <span class="built_in">help</span> system.</span><br><span class="line">object? -&gt; Details about <span class="string">&#x27;object&#x27;</span>, use <span class="string">&#x27;object??&#x27;</span> <span class="keyword">for</span> extra details.</span><br><span class="line">Welcome to pylab, a matplotlib-based Python environment [backend: WXAgg].</span><br><span class="line">For more information, <span class="built_in">type</span> <span class="string">&#x27;help(pylab)&#x27;</span>.</span><br><span class="line">In [1]: import pandas</span><br><span class="line">In [2]: plot(arange(10))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果成功，将会弹出一个绘图窗口，其中画的是一条直线。</p>
<h3 id="GNU-Linux"><a href="#GNU-Linux" class="headerlink" title="GNU&#x2F;Linux"></a>GNU&#x2F;Linux</h3><p>注意：有些（但不是全部）Linux产品自带的Python包版本较新，且可以通过内置的包管理工具（如apt）进行安装。我将详细讲解EPDFree的安装步骤，因为它在不同的Linux发行版之间是差不多的。</p>
<p>对于不同的Linux产品，具体的安装过程会有一些不同，我这里将以基于Debian的GNU&#x2F;Linux系统（如Ubuntu和Mint）为例来进行讲解。除EPDFree之外，其他的安装过程跟OS X差不多。其安装包是一个只能在终端中执行的shell脚本。根据系统是32位还是64位，需要相应地安装x86版（32位）或x86_64版（64位）。然后你将会得到一个名为epd_free-7.3-1-rh5-x86_64.sh的文件。通过bash执行该脚本即可开始安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash epd_free-7.3-1-rh5-x86_64.sh</span><br></pre></td></tr></table></figure>

<p>在接受了许可协议之后，你需要选择EPDFree文件的存放位置。我建议将这些文件安装在你的home目录中，比如比如&#x2F;home&#x2F;wesm&#x2F;epd（将wesm替换为你的用户名即可）。</p>
<p>安装完毕之后，你需要将EPDFree的bin目录添加到＄PATH变量中去。如果你用的是bash shell（比如Ubuntu默认用的就是这个），则在你的.bashrc中加上下面这句路径添加指令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/home/wesm/epd/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
<p>很明显，需要将&#x2F;home&#x2F;wesm&#x2F;epd&#x2F;替换为你所使用的安装目录。做完这些事情之后，你可以启动一个新的终端进程，也可以通过source~&#x2F;.bashrc重启你的.bashrc。</p>
<p>接下来还需要用到一个C编译器（比如gcc）。许多Linux产品都含有gcc,，但有些则没有。在Debian系统中，可以执行下面这条指令来安装gcc：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install gcc</span><br></pre></td></tr></table></figure>

<p>如果在命令行中输入gcc，就可以看到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gcc</span><br><span class="line">gcc: no input files</span><br></pre></td></tr></table></figure>

<p>现在可以安装pandas了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ easy_install pandas</span><br></pre></td></tr></table></figure>

<p>如果你是以root权限来安装EPDFree的，就需要在命令中加上sudo并输入sudo或root密码。使用跟OSX相同的检测方式即可验证是否一切正常。</p>
<h3 id="Python-2和Python-3"><a href="#Python-2和Python-3" class="headerlink" title="Python 2和Python 3"></a>Python 2和Python 3</h3><p>Python社区正在慢慢地从Python 2系列解释器过渡到Python 3系列。在Python 3.0问世以前，所有的Python代码都是向后兼容的。为了让Python语言更加先进，Python社区认为作出一些向后不兼容的修改是必要的。</p>
<p>本书是基于Python 2.7编写的，这是因为大部分Python科学计算社区还没有转向Python 3。好消息是，如果你碰巧正在使用Python 3.2，在学习本书的过程中一般也不会遇到什么麻烦。</p>
<h3 id="集成开发环境（IDE）"><a href="#集成开发环境（IDE）" class="headerlink" title="集成开发环境（IDE）"></a>集成开发环境（IDE）</h3><p>当有人问我“你的标准开发环境是怎样的”时，我几乎总是回答“IPython外加一个文本编辑器”。我通常都在IPython中编写和调试程序，而且它可以交互式地处理数据，并通过可视化的方式验证某个数据操作的结果是否正确。诸如pandas和NumPy这样的库也可以轻松便捷地在这个shell中使用。</p>
<p>但是相对于文本编辑器，总有人会更喜欢IDE。因为它们提供了许多不错的“代码智能化”功能，比如自动完成以及快速获取函数和类的文档等。你可以试试下面这些：</p>
<ul>
<li><p>Python Tools for Visual Studio（针对Windows用户）</p>
</li>
<li><p>PyCharm</p>
</li>
<li><p>Spyder</p>
</li>
<li><p>Komodo IDE</p>
</li>
</ul>
<h2 id="社区和研讨会"><a href="#社区和研讨会" class="headerlink" title="社区和研讨会"></a>社区和研讨会</h2><p>除搜索引擎之外，Python科学计算邮件列表也是很不错的资源，其上的问题几乎都会有人回答。可以看看下面这些：</p>
<ul>
<li><p>pydata：这是一个Google Group邮件列表，其中的问题都是Python数据分析和pandas方面的。</p>
</li>
<li><p>pystatsmodels：针对与statsmodels和pandas相关的问题。</p>
</li>
<li><p>numpy-discussion：针对与NumPy相关的问题。</p>
</li>
<li><p>scipy-user：针对与SciPy和Python科学计算相关的问题。</p>
</li>
</ul>
<p>我没有给出具体的URL，因为它们经常在变。通过搜索引擎即可轻松地找到它们。</p>
<p>全世界每年都会召开许多针对Python程序员的研讨会。PyCon和EuroPython分别是美国和欧洲最主要的Python研讨会。在阅读本书之后，如果你越来越深入地用Python进行数据分析，就可以在SciPy和EuroSciPy这两个面向科学计算的Python研讨会上找到许多“臭味相投的同道中人”。</p>
<h2 id="使用本书"><a href="#使用本书" class="headerlink" title="使用本书"></a>使用本书</h2><p>如果之前从未使用过Python，那你可能需要先看看本书最后的附录部分，那是一个讲解Python的语法、语言特性以及内置数据结构（如元组、列表和字典等）的简单教程。这部分内容可以看做本书其他内容的预备知识。</p>
<p>本书首先讲解的是IPython环境，然后简单地介绍了NumPy的关键特性，NumPy其他的高级功能则在本书最后一章讲解。然后我介绍了pandas。本书其余部分则介绍了综合运用pandas、NumPy和matplotlib（用于可视化）进行数据分析的相关知识。我尽量以增量的形式组织各种材料，但偶尔还是会出现一些跨章节的知识点。</p>
<p>各章的数据文件及相关材料存放在GitHub上：<br><a target="_blank" rel="noopener" href="http://github.com/pydata/pydata-book">http://github.com/pydata/pydata-book</a></p>
<p>我强烈建议你下载这些数据，然后用各章所介绍的工具重写示例代码。我非常欢迎大家为本书的git库提供文稿、脚本、IPython笔记本以及其他各种有用的资源。</p>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><p>本书大部分代码示例的输入形式和输出结果都会按照其在IPython shell中执行时的样子进行排版。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: code</span><br><span class="line">Out[<span class="number">5</span>]: output</span><br></pre></td></tr></table></figure>

<p>有时，为了简洁明了，多个代码示例将会并排显示。这些代码示例应该从左到右进行阅读，且应该分别执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: code In [<span class="number">6</span>]: code2</span><br><span class="line">Out[<span class="number">5</span>]: output Out[<span class="number">6</span>]: output2</span><br></pre></td></tr></table></figure>
<h3 id="示例数据"><a href="#示例数据" class="headerlink" title="示例数据"></a>示例数据</h3><p>各章的示例数据都存放在GitHub上：<a target="_blank" rel="noopener" href="http://github.com/pydata/pydata-book%E3%80%82%E4%B8%8B%E8%BD%BD%E8%BF%99%E4%BA%9B%E6%95%B0%E6%8D%AE%E7%9A%84%E6%96%B9%E6%B3%95%E6%9C%89%E4%BA%8C%EF%BC%9A%E4%BD%BF%E7%94%A8git%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%A8%8B%E5%BA%8F%EF%BC%9B%E7%9B%B4%E6%8E%A5%E4%BB%8E%E7%BD%91%E7%AB%99%E4%B8%8A%E4%B8%8B%E8%BD%BD%E8%AF%A5GitHub%E5%BA%93%E7%9A%84zip%E6%96%87%E4%BB%B6%E3%80%82">http://github.com/pydata/pydata-book。下载这些数据的方法有二：使用git版本控制命令行程序；直接从网站上下载该GitHub库的zip文件。</a></p>
<p>为了让所有示例都能重现，我尽量使其包含所有必需的东西，但仍然可能会有一些错误或遗漏。如果出现这种情况的话，请给我发邮件：<a href="mailto:&#119;&#x65;&#115;&#x6d;&#x63;&#107;&#105;&#110;&#x6e;&#x40;&#103;&#109;&#x61;&#105;&#x6c;&#46;&#99;&#111;&#x6d;">&#119;&#x65;&#115;&#x6d;&#x63;&#107;&#105;&#110;&#x6e;&#x40;&#103;&#109;&#x61;&#105;&#x6c;&#46;&#99;&#111;&#x6d;</a>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/8eb7b8792dc65c07.jpg"></p>
<h3 id="引入惯例"><a href="#引入惯例" class="headerlink" title="引入惯例"></a>引入惯例</h3><p>Python社区已经广泛接受了一些常用模块的命名惯例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br></pre></td></tr></table></figure>
<p>也就是说，当你看到np.arange时，就应该想到它引用的是NumPy中的arange函数。这样做的原因是：在Python软件开发过程中，不建议直接引入类似NumPy这种大型库的全部内容（from numpy import *）。</p>
<h3 id="行话"><a href="#行话" class="headerlink" title="行话"></a>行话</h3><p>由于你可能不太熟悉书中使用的一些有关编程和数据科学方面的常用术语，所以我在这里先给出其简单定义：</p>
<p>数据规整（Munge&#x2F;Munging&#x2F;Wrangling）<strong>译注8</strong></p>
<p>指的是将非结构化和（或）散乱数据处理为结构化或整洁形式的整个过程。这几个词已经悄悄成为当今数据黑客们的行话了。Munge这个词跟Lunge押韵。</p>
<p>伪码（Pseudocode）</p>
<p>算法或过程的“代码式”描述，而这些代码本身并不是实际有效的源代码。</p>
<p>语法糖（Syntactic sugar）</p>
<p>这是一种编程语法，它并不会带来新的特性，但却能使代码更易读、更易写。</p>
<h1 id="第2章-引言"><a href="#第2章-引言" class="headerlink" title="第2章 引言"></a>第2章 引言</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>本书将要向你介绍的是用于高效处理数据的Python工具。虽然读者各自工作的最终目的千差万别，但基本都需要完成以下几个大类的任务：</p>
<p><strong>与外界进行交互</strong></p>
<p>读写各种各样的文件格式和数据库。</p>
<p><strong>准备</strong></p>
<p>对数据进行清理、修整、整合、规范化、重塑、切片切块、变形等处理以便进行分析。</p>
<p><strong>转换</strong></p>
<p>对数据集做一些数学和统计运算以产生新的数据集。比如说，根据分组变量对一个大表进行聚合。</p>
<p><strong>建模和计算</strong></p>
<p>将数据跟统计模型、机器学习算法或其他计算工具联系起来。</p>
<p><strong>展示</strong></p>
<p>创建交互式的或静态的图片或文字摘要。</p>
<p>我将在本章中给出一些范例数据集，并讲解我们能对其做些什么。这些例子仅仅是为了提起你的兴趣，因此只会在一个比较高的层次进行讲解。即使你从来没用过这些东西也没关系，本书后续的章节将会对此进行非常详细的讲解。在这些代码示例中，你可以看到诸如In[15]：之类的输入输出提示符，它们来自IPython shell。</p>
<h2 id="来自bit-ly的1-usa-gov数据"><a href="#来自bit-ly的1-usa-gov数据" class="headerlink" title="来自bit.ly的1.usa.gov数据"></a>来自bit.ly的1.usa.gov数据</h2><p>2011年，URL缩短服务bit.ly跟美国政府网站usa.gov合作，提供了一份从生成.gov或.mil 短链接的用户那里收集来的匿名数据译注1。直到编写本书时为止，除实时数据<strong>译注2</strong>之外，还可以下载文本文件形式的每小时快照注1。</p>
<p>以每小时快照为例，文件中各行的格式为JSON（即JavaScript Object Notation，这是一种常用的Web数据格式）。例如，如果我们只读取某个文件中的第一行，那么你所看到的结果应该是下面这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">15</span>]: path = <span class="string">&#x27;ch02/usagov_bitly_data2012-03-16-1331923249.txt&#x27;</span></span><br><span class="line">In [<span class="number">16</span>]: <span class="built_in">open</span>(path).readline()</span><br><span class="line">Out[<span class="number">16</span>]: <span class="string">&#x27;&#123; &quot;a&quot;: &quot;Mozilla\\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\\/535.11 (KHTML,</span></span><br><span class="line"><span class="string">like Gecko) Chrome\\/17.0.963.78 Safari\\/535.11&quot;, &quot;c&quot;: &quot;US&quot;, &quot;nk&quot;: 1, &quot;tz&quot;:</span></span><br><span class="line"><span class="string">&quot;America\\/New_York&quot;, &quot;gr&quot;: &quot;MA&quot;, &quot;g&quot;: &quot;A6qOVH&quot;, &quot;h&quot;: &quot;wfLQtf&quot;, &quot;l&quot;: &quot;orofrog&quot;,</span></span><br><span class="line"><span class="string">&quot;al&quot;: &quot;en-US,en;q=0.8&quot;, &quot;hh&quot;: &quot;1.usa.gov&quot;, &quot;r&quot;: &quot;http:\\/\\/www.facebook.com\\/</span></span><br><span class="line"><span class="string">l\\/7AQEFzjSi\\/1.usa.gov\\/wfLQtf&quot;, &quot;u&quot;: &quot;http:\\/\\/www.ncbi.nlm.nih.gov\\/</span></span><br><span class="line"><span class="string">pubmed\\/22415991&quot;, &quot;t&quot;: 1331923247, &quot;hc&quot;:1331822918, &quot;cy&quot;: &quot;Danvers&quot;, &quot;ll&quot;: [</span></span><br><span class="line"><span class="string">42.576698, -70.954903 ] &#125;\n&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Python有许多内置或第三方模块可以将JSON字符串转换成Python字典对象。这里，我将使用json模块及其loads函数逐行加载已经下载好的数据文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">path = <span class="string">&#x27;ch02/usagov_bitly_data2012-03-16-1331923249.txt&#x27;</span></span><br><span class="line">records = [json.loads(line) <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(path)]</span><br></pre></td></tr></table></figure>
<p>你可能之前没用过Python，解释一下上面最后那行表达式，它叫做列表推导式（list comprehension），这是一种在一组字符串（或一组别的对象）上执行一条相同操作（如json.loads）的简洁方式。在一个打开的文件句柄上进行迭代即可获得一个由行组成的序列。现在，records对象就成为一组Python字典了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">18</span>]: records[<span class="number">0</span>]</span><br><span class="line">Out[<span class="number">18</span>]:</span><br><span class="line">&#123;<span class="string">u&#x27;a&#x27;</span>: <span class="string">u&#x27;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko)</span></span><br><span class="line"><span class="string">Chrome/17.0.963.78 Safari/535.11&#x27;</span>, <span class="string">u&#x27;al&#x27;</span>: <span class="string">u&#x27;en-US,en;q=0.8&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;c&#x27;</span>: <span class="string">u&#x27;US&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;cy&#x27;</span>: <span class="string">u&#x27;Danvers&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;g&#x27;</span>: <span class="string">u&#x27;A6qOVH&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;gr&#x27;</span>: <span class="string">u&#x27;MA&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;h&#x27;</span>: <span class="string">u&#x27;wfLQtf&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;hc&#x27;</span>: <span class="number">1331822918</span>,</span><br><span class="line"><span class="string">u&#x27;hh&#x27;</span>: <span class="string">u&#x27;1.usa.gov&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;l&#x27;</span>: <span class="string">u&#x27;orofrog&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;ll&#x27;</span>: [<span class="number">42.576698</span>, -<span class="number">70.954903</span>],</span><br><span class="line"><span class="string">u&#x27;nk&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">u&#x27;r&#x27;</span>: <span class="string">u&#x27;http://www.facebook.com/l/7AQEFzjSi/1.usa.gov/wfLQtf&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;t&#x27;</span>: <span class="number">1331923247</span>,</span><br><span class="line"><span class="string">u&#x27;tz&#x27;</span>: <span class="string">u&#x27;America/New_York&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;u&#x27;</span>: <span class="string">u&#x27;http://www.ncbi.nlm.nih.gov/pubmed/22415991&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>译注1：由于可以通过短链接伪造.gov后缀的URL，导致用户访问恶意域名，所以美国政府开始着手处理这种事情了。</p>
<p><strong>译注2</strong>：以Feed形式提供。</p>
<p>注1： 网址：<a target="_blank" rel="noopener" href="http://www.usa.gov/About/developer-resources/1usagov.shtml%E3%80%82">http://www.usa.gov/About/developer-resources/1usagov.shtml。</a></p>
<p>注意，Python的索引是从0开始的，不像其他某些语言是从1开始的（如R）。现在，只要以字符串的形式给出想要访问的键就可以得到当前记录中相应的值了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">19</span>]: records[<span class="number">0</span>][<span class="string">&#x27;tz&#x27;</span>]</span><br><span class="line">Out[<span class="number">19</span>]: <span class="string">u&#x27;America/New_York&#x27;</span></span><br></pre></td></tr></table></figure>


<p>单引号前面的u表示unicode（一种标准的字符串编码格式）。注意，IPython在这里给出的是时区的字符串对象形式，而不是其打印形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">20</span>]: <span class="built_in">print</span> records[<span class="number">0</span>][<span class="string">&#x27;tz&#x27;</span>]</span><br><span class="line">America/New_York</span><br></pre></td></tr></table></figure>

<h2 id="用纯Python代码对时区进行计数"><a href="#用纯Python代码对时区进行计数" class="headerlink" title="用纯Python代码对时区进行计数"></a>用纯Python代码对时区进行计数</h2><p>假设我们想要知道该数据集中最常出现的是哪个时区（即tz字段），得到答案的办法有很多。首先，我们用列表推导式取出一组时区：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">25</span>]: time_zones = [rec[<span class="string">&#x27;tz&#x27;</span>] <span class="keyword">for</span> rec <span class="keyword">in</span> records]</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">KeyError Traceback (most recent call last)</span><br><span class="line">/home/wesm/book_scripts/whetting/&lt;ipython&gt; <span class="keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; <span class="number">1</span> time_zones = [rec[<span class="string">&#x27;tz&#x27;</span>] <span class="keyword">for</span> rec <span class="keyword">in</span> records]</span><br><span class="line">KeyError: <span class="string">&#x27;tz&#x27;</span></span><br></pre></td></tr></table></figure>

<p>晕！原来并不是所有记录都有时区字段。这个好办，只需在列表推导式末尾加上一个if ‘tz’ in rec判断即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">26</span>]: time_zones = [rec[<span class="string">&#x27;tz&#x27;</span>] <span class="keyword">for</span> rec <span class="keyword">in</span> records <span class="keyword">if</span> <span class="string">&#x27;tz&#x27;</span> <span class="keyword">in</span> rec]</span><br><span class="line">In [<span class="number">27</span>]: time_zones[:<span class="number">10</span>]</span><br><span class="line">Out[<span class="number">27</span>]:</span><br><span class="line">[<span class="string">u&#x27;America/New_York&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;America/Denver&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;America/New_York&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;America/Sao_Paulo&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;America/New_York&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;America/New_York&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;Europe/Warsaw&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;&#x27;</span>,</span><br><span class="line"><span class="string">u&#x27;&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>只看前10个时区，我们发现有些是未知的（即空的）。虽然可以将它们过滤掉，但现在暂时先留着。接下来，为了对时区进行计数，这里介绍两个办法：一个较难（只使用标准Python库），另一个较简单（使用pandas）。计数的办法之一是在遍历时区的过程中将计数值保存在字典中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_counts</span>(<span class="params">sequence</span>):</span><br><span class="line">counts = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> sequence:</span><br><span class="line"><span class="keyword">if</span> x <span class="keyword">in</span> counts:</span><br><span class="line">counts[x] += <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">counts[x] = <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> counts</span><br></pre></td></tr></table></figure>

<p>如果非常了解Python标准库，那么你可能会将代码写得更简洁一些：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_counts2</span>(<span class="params">sequence</span>):</span><br><span class="line">counts = defaultdict(<span class="built_in">int</span>) <span class="comment"># 所有的值均会被初始化为0</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> sequence:</span><br><span class="line">counts[x] += <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> counts</span><br></pre></td></tr></table></figure>
<p>我将代码写到函数中是为了获得更高的可重用性。要用它对时区进行处理，只需将time_zones传入即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">31</span>]: counts = get_counts(time_zones)</span><br><span class="line">In [<span class="number">32</span>]: counts[<span class="string">&#x27;America/New_York&#x27;</span>]</span><br><span class="line">Out[<span class="number">32</span>]: <span class="number">1251</span></span><br><span class="line">In [<span class="number">33</span>]: <span class="built_in">len</span>(time_zones)</span><br><span class="line">Out[<span class="number">33</span>]: <span class="number">3440</span></span><br></pre></td></tr></table></figure>

<p>如果想要得到前10位的时区及其计数值，我们需要用到一些有关字典的处理技巧：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">top_counts</span>(<span class="params">count_dict, n=<span class="number">10</span></span>):</span><br><span class="line">value_key_pairs = [(count, tz) <span class="keyword">for</span> tz, count <span class="keyword">in</span> count_dict.items()]</span><br><span class="line">value_key_pairs.sort()</span><br><span class="line"><span class="keyword">return</span> value_key_pairs[-n:]</span><br></pre></td></tr></table></figure>

<p>现在我们就可以：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">35</span>]: top_counts(counts)</span><br><span class="line">Out[<span class="number">35</span>]:</span><br><span class="line">[(<span class="number">33</span>, <span class="string">u&#x27;America/Sao_Paulo&#x27;</span>),</span><br><span class="line">(<span class="number">35</span>, <span class="string">u&#x27;Europe/Madrid&#x27;</span>),</span><br><span class="line">(<span class="number">36</span>, <span class="string">u&#x27;Pacific/Honolulu&#x27;</span>),</span><br><span class="line">(<span class="number">37</span>, <span class="string">u&#x27;Asia/Tokyo&#x27;</span>),</span><br><span class="line">(<span class="number">74</span>, <span class="string">u&#x27;Europe/London&#x27;</span>),</span><br><span class="line">(<span class="number">191</span>, <span class="string">u&#x27;America/Denver&#x27;</span>),</span><br><span class="line">(<span class="number">382</span>, <span class="string">u&#x27;America/Los_Angeles&#x27;</span>),</span><br><span class="line">(<span class="number">400</span>, <span class="string">u&#x27;America/Chicago&#x27;</span>),</span><br><span class="line">(<span class="number">521</span>, <span class="string">u&#x27;&#x27;</span>),</span><br><span class="line">(<span class="number">1251</span>, <span class="string">u&#x27;America/New_York&#x27;</span>)]</span><br></pre></td></tr></table></figure>
<p>你可以在Python标准库中找到collections.Counter类，它能使这个任务变得更简单：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">49</span>]: <span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line">In [<span class="number">50</span>]: counts = Counter(time_zones)</span><br><span class="line">In [<span class="number">51</span>]: counts.most_common(<span class="number">10</span>)</span><br><span class="line">Out[<span class="number">51</span>]:</span><br><span class="line">[(<span class="string">u&#x27;America/New_York&#x27;</span>, <span class="number">1251</span>),</span><br><span class="line">(<span class="string">u&#x27;&#x27;</span>, <span class="number">521</span>),</span><br><span class="line">(<span class="string">u&#x27;America/Chicago&#x27;</span>, <span class="number">400</span>),</span><br><span class="line">(<span class="string">u&#x27;America/Los_Angeles&#x27;</span>, <span class="number">382</span>),</span><br><span class="line">(<span class="string">u&#x27;America/Denver&#x27;</span>, <span class="number">191</span>),</span><br><span class="line">(<span class="string">u&#x27;Europe/London&#x27;</span>, <span class="number">74</span>),</span><br><span class="line">(<span class="string">u&#x27;Asia/Tokyo&#x27;</span>, <span class="number">37</span>),</span><br><span class="line">(<span class="string">u&#x27;Pacific/Honolulu&#x27;</span>, <span class="number">36</span>),</span><br><span class="line">(<span class="string">u&#x27;Europe/Madrid&#x27;</span>, <span class="number">35</span>),</span><br><span class="line">(<span class="string">u&#x27;America/Sao_Paulo&#x27;</span>, <span class="number">33</span>)]</span><br></pre></td></tr></table></figure>

<h2 id="用pandas对时区进行计数"><a href="#用pandas对时区进行计数" class="headerlink" title="用pandas对时区进行计数"></a>用pandas对时区进行计数</h2><p>DataFrame是pandas中最重要的数据结构，它用于将数据表示为一个表格。从一组原始<br>记录中创建DataFrame是很简单的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">289</span>]: <span class="keyword">from</span> pandas <span class="keyword">import</span> DataFrame, Series</span><br><span class="line">In [<span class="number">290</span>]: <span class="keyword">import</span> pandas <span class="keyword">as</span> pd; <span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">In [<span class="number">291</span>]: frame = DataFrame(records)</span><br><span class="line">In [<span class="number">292</span>]: frame</span><br><span class="line">Out[<span class="number">292</span>]:</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;pandas.core.frame.DataFrame&#x27;</span>&gt;</span><br><span class="line">Int64Index: <span class="number">3560</span> entries, <span class="number">0</span> to <span class="number">3559</span></span><br><span class="line">Data columns:</span><br><span class="line">_heartbeat_ <span class="number">120</span> non-null values</span><br><span class="line">a <span class="number">3440</span> non-null values</span><br><span class="line">al <span class="number">3094</span> non-null values</span><br><span class="line">c <span class="number">2919</span> non-null values</span><br><span class="line">cy <span class="number">2919</span> non-null values</span><br><span class="line">g <span class="number">3440</span> non-null values</span><br><span class="line">gr <span class="number">2919</span> non-null values</span><br><span class="line">h <span class="number">3440</span> non-null values</span><br><span class="line">hc <span class="number">3440</span> non-null values</span><br><span class="line">hh <span class="number">3440</span> non-null values</span><br><span class="line">kw <span class="number">93</span> non-null values</span><br><span class="line">l <span class="number">3440</span> non-null values</span><br><span class="line">ll <span class="number">2919</span> non-null values</span><br><span class="line">nk <span class="number">3440</span> non-null values</span><br><span class="line">r <span class="number">3440</span> non-null values</span><br><span class="line">t <span class="number">3440</span> non-null values</span><br><span class="line">tz <span class="number">3440</span> non-null values</span><br><span class="line">u <span class="number">3440</span> non-null values</span><br><span class="line">dtypes: float64(<span class="number">4</span>), <span class="built_in">object</span>(<span class="number">14</span>)</span><br><span class="line">In [<span class="number">293</span>]: frame[<span class="string">&#x27;tz&#x27;</span>][:<span class="number">10</span>]</span><br><span class="line">Out[<span class="number">293</span>]:</span><br><span class="line"><span class="number">0</span> America/New_York</span><br><span class="line"><span class="number">1</span> America/Denver</span><br><span class="line"><span class="number">2</span> America/New_York</span><br><span class="line"><span class="number">3</span> America/Sao_Paulo</span><br><span class="line"><span class="number">4</span> America/New_York</span><br><span class="line"><span class="number">5</span> America/New_York</span><br><span class="line"><span class="number">6</span> Europe/Warsaw</span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line">Name: tz</span><br></pre></td></tr></table></figure>
<p>这里frame的输出形式是摘要视图（summary view），主要用于较大的DataFrame对象。frame[‘tz’]所返回的Series对象有一个value_counts方法，该方法可以让我们得到所需的信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">294</span>]: tz_counts = frame[<span class="string">&#x27;tz&#x27;</span>].value_counts()</span><br><span class="line">In [<span class="number">295</span>]: tz_counts[:<span class="number">10</span>]</span><br><span class="line">Out[<span class="number">295</span>]:</span><br><span class="line">America/New_York <span class="number">1251</span></span><br><span class="line"><span class="number">521</span></span><br><span class="line">America/Chicago <span class="number">400</span></span><br><span class="line">America/Los_Angeles <span class="number">382</span></span><br><span class="line">America/Denver <span class="number">191</span></span><br><span class="line">Europe/London <span class="number">74</span></span><br><span class="line">Asia/Tokyo <span class="number">37</span></span><br><span class="line">Pacific/Honolulu <span class="number">36</span></span><br><span class="line">Europe/Madrid <span class="number">35</span></span><br><span class="line">America/Sao_Paulo <span class="number">33</span></span><br></pre></td></tr></table></figure>

<p>然后，我们想利用绘图库（即matplotlib）为这段数据生成一张图片。为此，我们先给记录中未知或缺失的时区填上一个替代值。fillna函数可以替换缺失值（NA），而未知值（空字符串）则可以通过布尔型数组索引加以替换：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">296</span>]: clean_tz = frame[<span class="string">&#x27;tz&#x27;</span>].fillna(<span class="string">&#x27;Missing&#x27;</span>)</span><br><span class="line">In [<span class="number">297</span>]: clean_tz[clean_tz == <span class="string">&#x27;&#x27;</span>] = <span class="string">&#x27;Unknown&#x27;</span></span><br><span class="line">In [<span class="number">298</span>]: tz_counts = clean_tz.value_counts()</span><br><span class="line">In [<span class="number">299</span>]: tz_counts[:<span class="number">10</span>]</span><br><span class="line">Out[<span class="number">299</span>]:</span><br><span class="line">America/New_York <span class="number">1251</span></span><br><span class="line">Unknown <span class="number">521</span></span><br><span class="line">America/Chicago <span class="number">400</span></span><br><span class="line">America/Los_Angeles <span class="number">382</span></span><br><span class="line">America/Denver <span class="number">191</span></span><br><span class="line">Missing <span class="number">120</span></span><br><span class="line">Europe/London <span class="number">74</span></span><br><span class="line">Asia/Tokyo <span class="number">37</span></span><br><span class="line">Pacific/Honolulu <span class="number">36</span></span><br><span class="line">Europe/Madrid <span class="number">35</span></span><br></pre></td></tr></table></figure>

<p>利用counts<strong>译注3</strong>对象的plot方法即可得到一张水平条形图<strong>译注4</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">301</span>]: tz_counts[:<span class="number">10</span>].plot(kind=<span class="string">&#x27;barh&#x27;</span>, rot=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>最终结果如图2-1所示。我们还可以对这种数据进行很多处理。比如说，a字段含有执行URL短缩操作的浏览器、设备、应用程序的相关信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">302</span>]: frame[<span class="string">&#x27;a&#x27;</span>][<span class="number">1</span>]</span><br><span class="line">Out[<span class="number">302</span>]: <span class="string">u&#x27;GoogleMaps/RochesterNY&#x27;</span></span><br><span class="line">In [<span class="number">303</span>]: frame[<span class="string">&#x27;a&#x27;</span>][<span class="number">50</span>]</span><br><span class="line">Out[<span class="number">303</span>]: <span class="string">u&#x27;Mozilla/5.0 (Windows NT 5.1; rv:10.0.2) Gecko/20100101 Firefox/10.0.2&#x27;</span></span><br><span class="line">In [<span class="number">304</span>]: frame[<span class="string">&#x27;a&#x27;</span>][<span class="number">51</span>]</span><br><span class="line">Out[<span class="number">304</span>]: <span class="string">u&#x27;Mozilla/5.0 (Linux; U; Android 2.2.2; en-us; LG-P925/V10e Build/FRG83G)</span></span><br><span class="line"><span class="string">AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>译注3</strong>：应该是tz_counts。</p>
<p><strong>译注4</strong>：注意，一定要以pylab模式打开，否则这条代码没效果。包括很多缩写，pylab都直接弄好了，如果不是用这种模式打开，后面很多代码一样会遇到问题，虽然不是什么大毛病，但毕竟麻烦。后面如果遇到这没定义那找不到的情况，就请注意是不是因为这个。</p>
<!-- Europe/Madrid Pacific/Honolulu Asia/Tokyo Europe/London Missing America/Denver America/Los_Angeles America/Chicago Unknown America/New_York 0 200 400 600 800 1000 1200 1400  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/5578b59bf8d37972.jpg"></p>
<p>图2-1：1.usa.gov示例数据中最常出现的时区</p>
<p>将这些“a“agent”字符串<strong>译注5</strong>中的所有信息都解析出来是一件挺郁闷的工作。不过只要你掌握了Python内置的字符串函数和正则表达式，事情就好办了。比如说，我们可以将这种字符串的第一节（与浏览器大致对应）分离出来并得到另外一份用户行为摘要：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">305</span>]: results = Series([x.split()[<span class="number">0</span>] <span class="keyword">for</span> x <span class="keyword">in</span> frame.a.dropna()])</span><br><span class="line">In [<span class="number">306</span>]: results[:<span class="number">5</span>]</span><br><span class="line">Out[<span class="number">306</span>]:</span><br><span class="line"><span class="number">0</span> Mozilla/<span class="number">5.0</span></span><br><span class="line"><span class="number">1</span> GoogleMaps/RochesterNY</span><br><span class="line"><span class="number">2</span> Mozilla/<span class="number">4.0</span></span><br><span class="line"><span class="number">3</span> Mozilla/<span class="number">5.0</span></span><br><span class="line"><span class="number">4</span> Mozilla/<span class="number">5.0</span></span><br><span class="line">In [<span class="number">307</span>]: results.value_counts()[:<span class="number">8</span>]</span><br><span class="line">Out[<span class="number">307</span>]:</span><br><span class="line">Mozilla/<span class="number">5.0</span> <span class="number">2594</span></span><br><span class="line">Mozilla/<span class="number">4.0</span> <span class="number">601</span></span><br><span class="line">GoogleMaps/RochesterNY <span class="number">121</span></span><br><span class="line">Opera/<span class="number">9.80</span> <span class="number">34</span></span><br><span class="line">TEST_INTERNET_AGENT <span class="number">24</span></span><br><span class="line">GoogleProducer <span class="number">21</span></span><br><span class="line">Mozilla/<span class="number">6.0</span> <span class="number">5</span></span><br><span class="line">BlackBerry8520/<span class="number">5.0</span><span class="number">.0</span><span class="number">.681</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>现在，假设你想按Windows和非Windows用户对时区统计信息进行分解。为了简单起见，我们假定只要agent字符串中含有“Windows”就认为该用户为Windows用户。由于有的agent缺失，所以首先将它们从数据中移除：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">308</span>]: cframe = frame[frame.a.notnull()]</span><br></pre></td></tr></table></figure>
<p>其次根据a值计算出各行是否是Windows：</p>
<p><strong>译注5</strong>：即浏览器的USER_AGENT信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">309</span>]: operating_system = np.where(cframe[<span class="string">&#x27;a&#x27;</span>].<span class="built_in">str</span>.contains(<span class="string">&#x27;Windows&#x27;</span>),</span><br><span class="line">...: <span class="string">&#x27;Windows&#x27;</span>, <span class="string">&#x27;Not Windows&#x27;</span>)</span><br><span class="line">In [<span class="number">310</span>]: operating_system[:<span class="number">5</span>]</span><br><span class="line">Out[<span class="number">310</span>]:</span><br><span class="line"><span class="number">0</span> Windows</span><br><span class="line"><span class="number">1</span> Not Windows</span><br><span class="line"><span class="number">2</span> Windows</span><br><span class="line"><span class="number">3</span> Not Windows</span><br><span class="line"><span class="number">4</span> Windows</span><br><span class="line">Name: a</span><br></pre></td></tr></table></figure>

<p>接下来就可以根据时区和新得到的操作系统列表对数据进行分组了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">311</span>]: by_tz_os = cframe.groupby([<span class="string">&#x27;tz&#x27;</span>, operating_system])</span><br></pre></td></tr></table></figure>
<p>然后通过size对分组结果进行计数（类似于上面的value_counts函数），并利用unstack对计数结果进行重塑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">312</span>]: agg_counts = by_tz_os.size().unstack().fillna(<span class="number">0</span>)</span><br><span class="line">In [<span class="number">313</span>]: agg_counts[:<span class="number">10</span>]</span><br><span class="line">Out[<span class="number">313</span>]:</span><br><span class="line">a Not Windows Windows</span><br><span class="line">tz</span><br><span class="line"><span class="number">245</span> <span class="number">276</span></span><br><span class="line">Africa/Cairo <span class="number">0</span> <span class="number">3</span></span><br><span class="line">Africa/Casablanca <span class="number">0</span> <span class="number">1</span></span><br><span class="line">Africa/Ceuta <span class="number">0</span> <span class="number">2</span></span><br><span class="line">Africa/Johannesburg <span class="number">0</span> <span class="number">1</span></span><br><span class="line">Africa/Lusaka <span class="number">0</span> <span class="number">1</span></span><br><span class="line">America/Anchorage <span class="number">4</span> <span class="number">1</span></span><br><span class="line">America/Argentina/Buenos_Aires <span class="number">1</span> <span class="number">0</span></span><br><span class="line">America/Argentina/Cordoba <span class="number">0</span> <span class="number">1</span></span><br><span class="line">America/Argentina/Mendoza <span class="number">0</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>


<p>最后，我们来选取最常出现的时区。为了达到这个目的，我根据agg_counts中的行数构造了一个间接索引数组：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用于按升序排列</span></span><br><span class="line">In [<span class="number">314</span>]: indexer = agg_counts.<span class="built_in">sum</span>(<span class="number">1</span>).argsort()</span><br><span class="line">In [<span class="number">315</span>]: indexer[:<span class="number">10</span>]</span><br><span class="line">Out[<span class="number">315</span>]:</span><br><span class="line">tz</span><br><span class="line"><span class="number">24</span></span><br><span class="line">Africa/Cairo <span class="number">20</span></span><br><span class="line">Africa/Casablanca <span class="number">21</span></span><br><span class="line">Africa/Ceuta <span class="number">92</span></span><br><span class="line">Africa/Johannesburg <span class="number">87</span></span><br><span class="line">Africa/Lusaka <span class="number">53</span></span><br><span class="line">America/Anchorage <span class="number">54</span></span><br><span class="line">America/Argentina/Buenos_Aires <span class="number">57</span></span><br><span class="line">America/Argentina/Cordoba <span class="number">26</span></span><br><span class="line">America/Argentina/Mendoza <span class="number">55</span></span><br></pre></td></tr></table></figure>

<p>然后我通过take按照这个顺序截取了最后10行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">316</span>]: count_subset = agg_counts.take(indexer)[-<span class="number">10</span>:]</span><br><span class="line">In [<span class="number">317</span>]: count_subset</span><br><span class="line">Out[<span class="number">317</span>]:</span><br><span class="line">a Not Windows Windows</span><br><span class="line">tz</span><br><span class="line">America/Sao_Paulo <span class="number">13</span> <span class="number">20</span></span><br><span class="line">Europe/Madrid <span class="number">16</span> <span class="number">19</span></span><br><span class="line">Pacific/Honolulu <span class="number">0</span> <span class="number">36</span></span><br><span class="line">Asia/Tokyo <span class="number">2</span> <span class="number">35</span></span><br><span class="line">Europe/London <span class="number">43</span> <span class="number">31</span></span><br><span class="line">America/Denver <span class="number">132</span> <span class="number">59</span></span><br><span class="line">America/Los_Angeles <span class="number">130</span> <span class="number">252</span></span><br><span class="line">America/Chicago <span class="number">115</span> <span class="number">285</span></span><br><span class="line"><span class="number">245</span> <span class="number">276</span></span><br><span class="line">America/New_York <span class="number">339</span> <span class="number">912</span></span><br></pre></td></tr></table></figure>


<p>这里也可以生成一张条形图。我将使用stackeced&#x3D;Tru来生成一张堆积条形图（如图2-2所示）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">319</span>]:count_subset.plot(kind=<span class="string">&#x27;barh&#x27;</span>,stacked=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>由于在这张图中不太容易看清楚较小分组中Windows用户的相对比例，因此我们可以将各行规范化为“总计为1”并重新绘图（如图2-3所示）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">321</span>]: normed_subset = count_subset.div(count_subset.<span class="built_in">sum</span>(<span class="number">1</span>), axis=<span class="number">0</span>)</span><br><span class="line">In [<span class="number">322</span>]: normed_subset.plot(kind=<span class="string">&#x27;barh&#x27;</span>, stacked=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>这里所用到的所有方法都会在本书后续的章节中详细讲解。</p>
<h2 id="MovieLens-1M数据集"><a href="#MovieLens-1M数据集" class="headerlink" title="MovieLens 1M数据集"></a>MovieLens 1M数据集</h2><p>GroupLens Research （http：／／<a href="http://www.grouplens.org／node／73）采集了一组从20世纪90年末到21世纪初由MovieLens用户提供的电影评分数据。这些数据中包括电影评分、电影元数据（风格类型和年代）以及关于用户的人口统计学数据（年龄、邮编、性别和职业等）。基于机器学习算法的推荐系统一般都会对此类数据感兴趣。虽然我不会在本书中详细介绍机器学习技术，但我会告诉你如何对这种数据进行切片切块以满足实际需求。">www.grouplens.org／node／73）采集了一组从20世纪90年末到21世纪初由MovieLens用户提供的电影评分数据。这些数据中包括电影评分、电影元数据（风格类型和年代）以及关于用户的人口统计学数据（年龄、邮编、性别和职业等）。基于机器学习算法的推荐系统一般都会对此类数据感兴趣。虽然我不会在本书中详细介绍机器学习技术，但我会告诉你如何对这种数据进行切片切块以满足实际需求。</a></p>
<!-- America/New_York America/Chicago America/Los_Angeles 2 America/Denver Europe/London Asia/Tokyo Pacific/Honolulu Europe/Madrid a Not Windows America/Sao_Paulo Windows 0 200 400 600 800 1000 1200 1400  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/49befe0b54f45d4d.jpg"></p>
<p>图2-2：按Windows和非Windows用户统计的最常出现的时区</p>
<!-- America/New_York a Not Windows Windows America/Chicago America/Los_Angeles 2 America/Denver Europe/London Asia/Tokyo Pacific/Honolulu Europe/Madrid America/Sao_Paulo 0.0 0.2 0.4 0.6 0.8 1.0  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/190d61952038be9f.jpg"></p>
<p>图2-3：按Windows和非Windows用户比例统计的最常出现的时区</p>
<p>MovieLens 1M数据集含有来自6000名用户对4000部电影的100万条评分数据。它分为三个表：评分、用户信息和电影信息。将该数据从zip文件中解压出来之后，可以通过pandas.read_table将各个表分别读到一个pandas DataFrame对象中：</p>
<p>import pandas as pd</p>
<p>$u n a m e s &#x3D; [ ^ { \prime } u s e r _ { - } i d ^ { \prime }$,’gender’,’a’age’, ‘occupation’, ‘zip’]</p>
<p>$u s e r s &#x3D; p d . r e a d _ t a b l e ( ^ { \prime } m l - 1 m &#x2F; u s e r s .$dat’,$S e p &#x3D; \because : ^ { \prime }$ header&#x3D;None, names&#x3D;unames)</p>
<p>$r n a m e s &#x3D; [ ^ { s } u s e r _ { - } i d ^ { \prime }$,$^ { \prime } m o v i e _ { - } i d ^ { \prime }$,’rating’, ‘timestamp’]</p>
<p>$r a t \in g s &#x3D; p d . r e a d t . t a b l e ( ^ { t } m l - 1 m &#x2F; x a t \in i n g s . d a t ^ { \prime } $secp&#x3D;∵:∵header&#x3D;Nonenames&#x3D;rnames)</p>
<p>$m n a m e s &#x3D; [ ^ { s } m o v i e _ { - } i d ^ { s } ,$’title’, ‘genres’]</p>
<p>$m o v i e s &#x3D; p d . r e a d _ { - } ^ { - } t a b l e ( ^ { \prime } m l - 1 m &#x2F; m o v i e s . d a t ^ { \prime } $ $S e p &#x3D; \because : ^ { \prime }$,header&#x3D;None,names&#x3D;mnames)</p>
<p>利用Python的切片语法，通过查看每个DataFrame的前几行即可验证数据加载工作是否一切顺利：</p>
<p>In[334]:users[:5]</p>
<p>Out[334]:</p>
<table>
<thead>
<tr>
<th>us</th>
<th>er_id</th>
<th>gender</th>
<th>age</th>
<th>occupation</th>
<th>zip</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>1</td>
<td>F</td>
<td>1</td>
<td>10</td>
<td>48067</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>M</td>
<td>56</td>
<td>16</td>
<td>70072</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>M</td>
<td>25</td>
<td>15</td>
<td>55117</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>M</td>
<td>45</td>
<td>7</td>
<td>02460</td>
</tr>
<tr>
<td>4</td>
<td>5</td>
<td>M</td>
<td>25</td>
<td>20</td>
<td>55455</td>
</tr>
</tbody></table>
<p>In [335]:ratings[:5]</p>
<p>Out[335]:</p>
<table>
<thead>
<tr>
<th>user_id</th>
<th>user_id</th>
<th>movie_id</th>
<th>rating</th>
<th>timestamp</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>1</td>
<td>1193</td>
<td>5</td>
<td>978300760</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>661</td>
<td>3</td>
<td>978302109</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>914</td>
<td>3</td>
<td>978301968</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>3408</td>
<td>4</td>
<td>978300275</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>2355</td>
<td>5</td>
<td>978824291</td>
</tr>
</tbody></table>
<p>In [336]:movies:5]</p>
<table>
<thead>
<tr>
<th>movie_id</th>
<th>movie_id</th>
<th>BUtitle</th>
<th>genres</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>1</td>
<td>Toy Story(1995)</td>
<td>Animation</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>Jumanji(1995)</td>
<td>Adventure</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>Grumpier Old Men (1995)</td>
<td>Comedy</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>Waiting to Exhale(1995)</td>
<td>Comedy</td>
</tr>
<tr>
<td>4</td>
<td>5</td>
<td>Father of the Bride Part II (1995)</td>
<td>Comedy</td>
</tr>
</tbody></table>
<p>In [337]:ratings</p>
<p>Out[337]:</p>
<p>&lt;class ‘pandas.core.frame.DataFrame’&gt;</p>
<p>Int64Index: 1000209 entries, 0 to 1000208</p>
<p>Data columns:</p>
<p>user_id 1000209 non-null values</p>
<p>movie_id 1000209 non-null values</p>
<p>rating 1000209 non-null values</p>
<p>timestamp 1000209 non-null values</p>
<p>dtypes:int64(4)</p>
<p>注意，其中的年龄和职业是以编码形式给出的，它们的具体含义请参考该数据集的README文件。分析散布在三个表中的数据可不是一件轻松的事情。假设我们想要根据性别和年龄计算某部电影的平均得分，如果将所有数据都合并到一个表中的话问题就简单</p>
<p>多了。我们先用pandas的merge函数将ratings跟users合并到一起，然后再将movies也合并进去。pandas会根据列名的重叠情况推断出哪些列是合并（或连接）键：</p>
<p>In[338]:deta&#x3D;pd.merge(pd.merge(ratings, users),movies)</p>
<p>In [339]: data</p>
<p>Out[339]:</p>
<p>&lt;class ‘pandas.core.frame.DataFrame’&gt;</p>
<p>Int64Index: 1000209 entries, 0 to 1000208</p>
<p>Data columns:</p>
<table>
<thead>
<tr>
<th>user_id</th>
<th>1000209</th>
<th>non-null values</th>
</tr>
</thead>
<tbody><tr>
<td>movie_id</td>
<td>1000209</td>
<td>non-null values</td>
</tr>
<tr>
<td>rating</td>
<td>1000209</td>
<td>non-null values</td>
</tr>
<tr>
<td>timestamp</td>
<td>1000209</td>
<td>non-null values</td>
</tr>
<tr>
<td>gender</td>
<td>1000209</td>
<td>non-null values</td>
</tr>
<tr>
<td>age</td>
<td>1000209</td>
<td>non-null values</td>
</tr>
<tr>
<td>occupation</td>
<td>1000209</td>
<td>non-null values</td>
</tr>
<tr>
<td>zip</td>
<td>1000209</td>
<td>non-null values</td>
</tr>
<tr>
<td>title</td>
<td>1000209</td>
<td>non-null values</td>
</tr>
<tr>
<td>genres</td>
<td>1000209</td>
<td>non-null values</td>
</tr>
</tbody></table>
<p>dtypes:int64(6),object(4)</p>
<p>In [340]:data.ix[0]</p>
<p>Out[340]:</p>
<p>use$e r _ { - } i d$ 1</p>
<p>movie_id 1</p>
<p>rating 5</p>
<p>timestamp 978824268</p>
<p>gender F</p>
<p>age 1</p>
<p>occupation 10</p>
<p>zip 48067</p>
<p>title Toy Story(1995)</p>
<p>genres Animation|Children’s|Comedy</p>
<p>Name: 0</p>
<p>现在，只要稍微熟悉一下pandas，就能轻松地根据任意个用户或电影属性对评分数据进行聚合操作了。为了按性别计算每部电影的平均得分，我们可以使用pivot_table 方法：</p>
<p>In[341]: mean_ratings &#x3D; data.pivot_table(‘rating’,$r o w s &#x3D; ^ { \prime } t i t l e ^ { \prime } ,$</p>
<p>···.: $c o l ^ { \prime } g e n d e r ^ { \prime } , \arg g f u n c ^ { \prime } m e a n ^ { \prime } )$</p>
<p>In [342]:mean_ratings[:5]</p>
<p>Out[342]:</p>
<table>
<thead>
<tr>
<th>gender</th>
<th>F</th>
<th>M</th>
</tr>
</thead>
<tbody><tr>
<td>title</td>
<td></td>
<td></td>
</tr>
<tr>
<td>&#36;1,000,000 Duck(1971)</td>
<td>3.375000</td>
<td>2.761905</td>
</tr>
<tr>
<td>‘Night Mother(1986)</td>
<td>3.388889</td>
<td>3.352941</td>
</tr>
<tr>
<td>‘Til There Was You (1997)</td>
<td>2.675676</td>
<td>2.733333</td>
</tr>
<tr>
<td>‘burbs,The(1989)</td>
<td>2.793478</td>
<td>2.962085</td>
</tr>
<tr>
<td>…And Justice for Al1 (1979)</td>
<td>3.828571</td>
<td>3.689024</td>
</tr>
</tbody></table>
<p>该操作产生了另一个DataFrame，其内容为电影平均得分，行标为电影名称，列标为性别。现在，我打算过滤掉评分数据不够250条的电影（随便选的一个数字）。为了达到这个目的，我先对title进行分组，然后利用size()得到一个含有各电影分组大小的Series 对象：</p>
<p>In [343]:ratings_by_ttitle&#x3D;data. .size()</p>
<p>In [344]: ratings_by_title[:10]</p>
<p>Out[344]:</p>
<p>title</p>
<p>&#36;1,000,000 Duck (1971) 37</p>
<p>‘Night Mother(1986) 70</p>
<p>‘Til There Was You(1997) 52</p>
<p>‘burbs,The(1989) 303</p>
<p>…And Justice for All (1979) 199</p>
<p>1-900(1994) 2</p>
<p>10 Things I Hate About You (1999) 700</p>
<p>101 Dalmatians(1961) 565</p>
<p>101 Dalmatians(1996) 364</p>
<p>12 Angry Men(1957) 616</p>
<p>In [345]: active_titles &#x3D; ratings_by_title.index[ratings$[ b y _ { - } t i t l e &gt; 2 5 0 $</p>
<p>In [346]:active_titles</p>
<p>Out[346]:</p>
<p>Index([‘burbs, The (1989), 10 Things I Hate About You (1999),</p>
<p>101 Dalmatians (1961),⋯Young Sherlock Holmes(1985),</p>
<p>Zero Effect (1998), eXistenZ (1999)], dtype&#x3D;object)</p>
<p>该索引中含有评分数据大于250条的电影名称，然后我们就可以据此从前面的mean ratings中选取所需的行了：</p>
<p>In [347]:mean_ratings &#x3D; mean_ratings.ix[active_titles]</p>
<p>In [348]:mean_ratings</p>
<p>Out[348]:</p>
<p>&lt;class ‘pandas.core.frame.DataFrame’&gt;</p>
<p>Index: 1216 entries, ‘burbs, The (1989) to eXistenZ (1999)</p>
<p>Data columns:</p>
<p>F 1216 non-null values</p>
<p>M 1216 non-null values</p>
<p>dtypes:float64(2)</p>
<p>为了了解女性观众最喜欢的电影，我们可以对F列降序排列：</p>
<p>In [350]:1top_female_ratin$n g s &#x3D; m e a n \underline { r a t }$ $t \in g s . s o r t \in i n d e \times ( b y &#x3D; ^ { \prime } F ^ { \prime }$,ascendirng&#x3D;FalSe)</p>
<p>In [351]:top_female_ratings[:10]</p>
<p>Out[351]:</p>
<p>gender F M</p>
<p>title</p>
<p>Close Shave, A(1995) 4.644444 4.473795</p>
<table>
<thead>
<tr>
<th>Wrong Trousers, The (1993)</th>
<th>4.588235</th>
<th>4.478261</th>
</tr>
</thead>
<tbody><tr>
<td>Sunset Blvd. (a.k.a. Sunset Boulevard)(1950)</td>
<td>4.572650</td>
<td>4.464589</td>
</tr>
<tr>
<td>Wallace &amp; Gromit: The Best of Aardman Animation (1996)</td>
<td>4.563107</td>
<td>4.385075</td>
</tr>
<tr>
<td>Schindler’s List (1993)</td>
<td>4.562602</td>
<td>4.491415</td>
</tr>
<tr>
<td>Shawshank Redemption, The (1994)</td>
<td>4.539075</td>
<td>4.560625</td>
</tr>
<tr>
<td>Grand Day Out,A(1992)</td>
<td>4.537879</td>
<td>4.293255</td>
</tr>
<tr>
<td>To Kill a Mockingbird (1962)</td>
<td>4.536667</td>
<td>4.372611</td>
</tr>
<tr>
<td>Creature Comforts (1990)</td>
<td>4.513889</td>
<td>4.272277</td>
</tr>
<tr>
<td>Usual Suspects, The(1995)</td>
<td>4.513317</td>
<td>4.518248</td>
</tr>
</tbody></table>
<h2 id="计算评分分歧"><a href="#计算评分分歧" class="headerlink" title="计算评分分歧"></a>计算评分分歧</h2><p>假设我们想要找出男性和女性观众分歧最大的电影。一个办法是给mean_ratings加上一个用于存放平均得分之差的列，并对其进行排序：</p>
<p>$I n [ 3 5 2 ] : m e a n x a t i n g s [ ^ { \prime } d i f ^ { \prime } ] &#x3D; m e a n x a t \in i n g s [ ^ { \prime \prime \prime } ] \cdot m e a n x a t \in i n g s [ ^ { \prime } ]$按“diff”排序即可得到分歧最大且女性观众更喜欢的电影：</p>
<p>In [353]:$5 o r t e d _ { - } b y _ { - } d i f f &#x3D; m e a n _ { - } x a t \in i n g 5 . 5 0 r t - \in d e \times ( b y &#x3D; ^ { \prime } d i f f ^ { \prime } )$</p>
<p>In [354]:$S O r t e d \underline { b } y \underline { d i f f } $:15]</p>
<p>Out[354]:</p>
<table>
<thead>
<tr>
<th>gender</th>
<th>F</th>
<th>M diff</th>
<th>M diff</th>
</tr>
</thead>
<tbody><tr>
<td>title</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Dirty Dancing(1987)</td>
<td>3.790378</td>
<td>2.959596</td>
<td>-0.830782</td>
</tr>
<tr>
<td>Jumpin’ Jack Flash(1986)</td>
<td>3.254717</td>
<td>2.578358</td>
<td>-0.676359</td>
</tr>
<tr>
<td>Grease (1978)</td>
<td>3.975265</td>
<td>3.367041</td>
<td>-0.608224</td>
</tr>
<tr>
<td>Little Women(1994)</td>
<td>3.870588</td>
<td>3.321739</td>
<td>-0.548849</td>
</tr>
<tr>
<td>Steel Magnolias (1989) HZ</td>
<td>3.901734</td>
<td>3.365957</td>
<td>-0.535777</td>
</tr>
<tr>
<td>Anastasia (1997)</td>
<td>3.800000</td>
<td>3.281609</td>
<td>-0.518391</td>
</tr>
<tr>
<td>Rocky Horror Picture Show, The (1975)</td>
<td>3.673016</td>
<td>3.160131</td>
<td>-0.512885</td>
</tr>
<tr>
<td>Color Purple, The (1985)</td>
<td>4.158192</td>
<td>3.659341</td>
<td>-0.498851</td>
</tr>
<tr>
<td>Age of Innocence, The (1993)</td>
<td>3.827068</td>
<td>3.339506</td>
<td>-0.487561</td>
</tr>
<tr>
<td>Free Willy (1993)</td>
<td>2.921348</td>
<td>2.438776</td>
<td>-0.482573</td>
</tr>
<tr>
<td>French Kiss(1995)</td>
<td>3.535714</td>
<td>3.056962 -0.478752</td>
<td>3.056962 -0.478752</td>
</tr>
<tr>
<td>Little Shop of Horrors, The (1960)</td>
<td>3.650000</td>
<td>3.179688 -0.470312</td>
<td>3.179688 -0.470312</td>
</tr>
<tr>
<td>Guys and Dolls (1955)</td>
<td>4.051724</td>
<td>3.583333 -0.468391</td>
<td>3.583333 -0.468391</td>
</tr>
<tr>
<td>Mary Poppins(1964)</td>
<td>4.197740</td>
<td>3.730594 -0.467147</td>
<td>3.730594 -0.467147</td>
</tr>
<tr>
<td>Patch Adams(1998)</td>
<td>3.473282</td>
<td>3.008746 -0.464536</td>
<td>3.008746 -0.464536</td>
</tr>
</tbody></table>
<p>对排序结果反序并取出前15行，得到的则是男性观众更喜欢的电影：</p>
<p>＃对行反序，并取出前15行</p>
<p>In [355]:$S O r t e d \underline { b } y \underline { d i f f } [ : \because - 1 ] [ : 1 5 ]$</p>
<p>Out[355]:</p>
<table>
<thead>
<tr>
<th>gender</th>
<th>F</th>
<th>M</th>
<th>diff</th>
</tr>
</thead>
<tbody><tr>
<td>title</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Good, The Bad and The Ugly, The (1966)</td>
<td>3.494949</td>
<td>4.221300</td>
<td>0.726351</td>
</tr>
<tr>
<td>Kentucky Fried Movie, The(1977)</td>
<td>2.878788</td>
<td>3.555147</td>
<td>0.676359</td>
</tr>
<tr>
<td>Dumb &amp; Dumber(1994)</td>
<td>2.697987</td>
<td>3.336595</td>
<td>0.638608</td>
</tr>
<tr>
<td>Longest Day,The (1962)</td>
<td>3.411765</td>
<td>4.031447</td>
<td>0.619682</td>
</tr>
<tr>
<td>Cable Guy,The(1996)</td>
<td>2.250000</td>
<td>2.863787</td>
<td>0.613787</td>
</tr>
<tr>
<td>Evil Dead II (Dead By Dawn) (1987)</td>
<td>3.297297</td>
<td>3.909283</td>
<td>0.611985</td>
</tr>
<tr>
<td>Hidden,The(1987)</td>
<td>3.137931</td>
<td>3.745098</td>
<td>0.607167</td>
</tr>
<tr>
<td>Rocky III (1982)</td>
<td>2.361702</td>
<td>2.943503</td>
<td>0.581801</td>
</tr>
<tr>
<td>Caddyshack(1980)</td>
<td>3.396135</td>
<td>3.969737</td>
<td>0.573602</td>
</tr>
<tr>
<td>For a Few Dollars More(1965)</td>
<td>3.409091</td>
<td>3.953795</td>
<td>0.544704</td>
</tr>
<tr>
<td>Porky’s (1981)</td>
<td>2.296875</td>
<td>2.836364</td>
<td>0.539489</td>
</tr>
<tr>
<td>Animal House(1978)</td>
<td>3.628906</td>
<td>4.167192</td>
<td>0.538286</td>
</tr>
<tr>
<td>Exorcist,The (1973)</td>
<td>3.537634</td>
<td>4.067239</td>
<td>0.529605</td>
</tr>
<tr>
<td>Fright Night(1985)</td>
<td>2.973684</td>
<td>3.500000</td>
<td>0.526316</td>
</tr>
<tr>
<td>Barb Wire (1996)</td>
<td>1.585366</td>
<td>2.100386</td>
<td>0.515020</td>
</tr>
</tbody></table>
<p>如果只是想要找出分歧最大的电影（不考虑性别因素），则可以计算得分数据的方差或标准差：</p>
<p>＃根据电影名称分组的得分数据的标准差</p>
<p>In[356]:rat∈gstd⊥by±itle&#x3D;data. [‘rating’].std()</p>
<p>＃根据activ$v e _ { - } $titles进行过滤</p>
<p>In [357]:$r a t \in [ g _ { - } s t d _ { - } b y _ { - } t i t ] e &#x3D; r a t \in [ g _ { - } s t d _ { - } b y _ { - }$title.ix[active_titles]</p>
<p>＃根据值对Series进行降序排列</p>
<p>In [358]: rating_std_by_title.order(ascending&#x3D;False)[10</p>
<p>Out[358]:</p>
<p>title</p>
<p>Dumb &amp; Dumber (1994) 1.321333</p>
<p>Blair Witch Project, The (1999) 1.316368</p>
<p>Natural Born Killers (1994) 1.307198</p>
<p>Tank Girl(1995) 1.277695</p>
<p>Rocky Horror Picture Show, The (1975) 1.260177</p>
<p>Eyes Wide Shut (1999) 1.259624</p>
<p>Evita(1996) 1.253631</p>
<p>Billy Madison (1995) 1.249970</p>
<p>Fear and Loathing in Las Vegas (1998) 1.246408</p>
<p>Bicentennial Man(1999) 1.245533</p>
<p>Name:rating</p>
<p>可能你已经注意到了，电影分类是以竖线（1）分隔的字符串形式给出的。如果想对电影分类进行分析的话，就需要先将其转换成更有用的形式才行。我将在本书后续章节中讲到这种转换处理，到时还会再用到这个数据。</p>
<h1 id="1880-2010年间全美婴儿姓名"><a href="#1880-2010年间全美婴儿姓名" class="headerlink" title="1880-2010年间全美婴儿姓名"></a>1880-2010年间全美婴儿姓名</h1><p>美国社会保障总署（SSA）提供了一份从1880年到2010年的婴儿名字频率数据。Hadley Wickham（许多流行R包的作者）经常用这份数据来演示R的数据处理功能。</p>
<p>In [4]:names.head(10)</p>
<p>Out[4]:</p>
<p>name sex births year</p>
<p>0 Mary F 7065 1880</p>
<table>
<thead>
<tr>
<th>1</th>
<th>Anna F</th>
<th>2604</th>
<th>1880</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>Emma F</td>
<td>2003</td>
<td>1880</td>
</tr>
<tr>
<td>3</td>
<td>Elizabeth F</td>
<td>1939</td>
<td>1880</td>
</tr>
<tr>
<td>4</td>
<td>Minnie F</td>
<td>1746</td>
<td>1880</td>
</tr>
<tr>
<td>5</td>
<td>Margaret F</td>
<td>1578</td>
<td>1880</td>
</tr>
<tr>
<td>6</td>
<td>Ida F</td>
<td>1472</td>
<td>1880</td>
</tr>
<tr>
<td>7</td>
<td>Alice F</td>
<td>1414</td>
<td>1880</td>
</tr>
<tr>
<td>8</td>
<td>Bertha F</td>
<td>1320</td>
<td>1880</td>
</tr>
<tr>
<td>9</td>
<td>Sarah F</td>
<td>1288</td>
<td>1880</td>
</tr>
</tbody></table>
<p>你可以用这个数据集做很多事，例如：</p>
<p>. 计算指定名字（可以是你自己的，也可以是别人的）的年度比例。</p>
<p>. 计算某个名字的相对排名。</p>
<p>· 计算各年度最流行的名字，以及增长或减少最快的名字。</p>
<p>. 分析名字趋势：元音、辅音、长度、总体多样性、拼写变化、首尾字母等。</p>
<p>. 分析外源性趋势：圣经中的名字、名人、人口结构变化等。</p>
<p>利用前面介绍过的那些工具，这些分析工作都能很轻松地完成，因此我会尽量多讲一些。我建议你下载这些数据并亲自试一试。如果你在这些数据中找到了某个有趣的模式，我将非常乐意听上一听。</p>
<p>到编写本书时为止，美国社会保障总署将该数据库按年度制成了多个数据文件，其中给出了每个性别／名字组合的出生总数。这些文件的原始档案可以在这里获取： <strong>译注6</strong></p>
<p><a target="_blank" rel="noopener" href="http://www.ssa.gov/oact/babynames/limits.html">http://www.ssa.gov/oact/babynames/limits.html</a>?</p>
<p>如果你在阅读本书的时候这个页面已经不见了，也可以用搜索引擎找找。下载“National data”文件names.zip，解压后的目录中含有一组文件（如yob1880.txt）。我用UNIX的head命令查看了其中一个文件的前10行（在Windows上，你可以用more命令，或直接在文本编辑器中打开）：</p>
<p>In [367]: !head -n 10 names&#x2F;yob1880.txt</p>
<p>Mary,F,7065</p>
<p>Anna,F,2604</p>
<p>Emma,F,2003</p>
<p>Elizabeth,F,1939</p>
<p>Minnie,F,1746</p>
<p>Margaret,F,1578</p>
<p>Ida,F,1472</p>
<p>Alice,F,1414</p>
<p>Bertha,F,1320</p>
<p>Sarah,F,1288</p>
<p><strong>译注6</strong>：如下链接可能不可用，读者可直接在本书的github上下载。</p>
<p>由于这是一个非常标准的以逗号隔开的格式，所以可以用pandas.read_csv将其加载到DataFrame中：</p>
<p>In [368]: import pandas as pd</p>
<p>In [369]: names1880 &#x3D; pd.read_csv(‘names&#x2F;yob1880.txt’, names&#x3D;[‘name’, ‘sex’.’births’])</p>
<p>In [370]:names1880</p>
<p>Out[370]:</p>
<p>&lt;class ‘pandas.core.frame.DataFrame’&gt;</p>
<p>Int64Index: 2000 entries, 0 to 1999</p>
<p>Data columns:</p>
<p>name 2000non-null values</p>
<p>sex 2000 non-null values</p>
<p>births 2000 non-null values</p>
<p>dtypes: int64(1),object(2)</p>
<p>这些文件中仅含有当年出现超过5次的名字。为了简单起见，我们可以用births列的sex分组小计表示该年度的births总计：</p>
<p>.births.sum()</p>
<p>Out[371]:</p>
<p>sex</p>
<p>F 90993</p>
<p>M 110493</p>
<p>Name: births</p>
<p>由于该数据集按年度被分隔成了多个文件，所以第一件事情就是要将所有数据都组装到一个DataFrame里面，并加上一个year字段。使用pandas.concat即可达到这个目的：</p>
<p>＃2010是目前最后一个有效统计年度</p>
<p>years&#x3D;range(1880,2011)</p>
<p>πeces&#x3D;[]</p>
<p>$c o l u m n s &#x3D; [ ^ { 1 } n a m e ^ { \prime } , ^ { \prime }$ $^ { \prime } \sec x ^ { \prime } ,$,’births’]</p>
<p>for year in years:</p>
<p>$p a t h &#x3D; ^ { \prime } a m e s &#x2F; y o b % d . t x t ^ { \prime }$.%year</p>
<p>$f r a m e &#x3D; p d . r e a d _ { - } c s v ( p a t h ,$ names&#x3D;columns)</p>
<p>$f r a m e [ ^ { \prime } y e a r ^ { \prime } ] &#x3D; y e a r$</p>
<p>pieces.append(frame)</p>
<p>＃将所有数据整合到单个DataFrame中</p>
<p>$n a m e s &#x3D; p d . c o n c a t ( p i e c e s , i g n o r e _ { - } \in d e x &#x3D; T r u e )$</p>
<p>这里需要注意几件事情。第一，concat默认是按行将多个DataFrame组合到一起的；第二，必须指定ignore_indeex&#x3D;Tru，因为我们不希望保留read_csv所返回的原始行号。现在我们得到了一个非常大的DataFrame，它含有全部的名字数据。</p>
<p>现在names这个DataFrame对象看上去应该是这个样子：</p>
<p>In [373]:names</p>
<p>Out[373]:</p>
<p>&lt;class ‘pandas.core.frame.DataFrame’&gt;</p>
<p>Int64Index: 1690784 entries, 0 to 1690783</p>
<p>Data columns:</p>
<p>name 1690784 non-null values</p>
<p>sex 1690784 non-null values</p>
<p>births 1690784 non-null values</p>
<p>year 1690784 non-null values</p>
<p>dtypes: int64(2), object(2)</p>
<p>有了这些数据之后，我们就可以利用groupby或pivot_table在year和sex级别上对其进行聚合了，如图2-4所示：</p>
<p>In[374]:totalbirths&#x3D;names.pivot_table(‘births’, $r o w s &#x3D; ^ { \prime } y e a r ^ { \prime } ,$···: $c o l s &#x3D; ^ { \prime } \sec x ^ { \prime } , \arg f u n c &#x3D; s u m )$</p>
<p>In [375]:total_births.tail()</p>
<p>Out[375]:</p>
<table>
<thead>
<tr>
<th>sex</th>
<th>F</th>
<th>M</th>
</tr>
</thead>
<tbody><tr>
<td>year</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2006</td>
<td>1896468</td>
<td>2050234</td>
</tr>
<tr>
<td>2007</td>
<td>1916888</td>
<td>2069242</td>
</tr>
<tr>
<td>2008</td>
<td>1883645</td>
<td>2032310</td>
</tr>
<tr>
<td>2009</td>
<td>1827643</td>
<td>1973359</td>
</tr>
<tr>
<td>2010</td>
<td>1759010</td>
<td>1898382</td>
</tr>
</tbody></table>
<p>In [376]: total_births.plot(title&#x3D;’Total births by sex and year’)</p>
<p>下面我们来插入一个prop列，用于存放指定名字的婴儿数相对于总出生数的比例。prop 值为0.02表示每100名婴儿中有2名取了当前这个名字。因此，我们先按year和sex分组，然后再将新列加到各个分组上：</p>
<p>def add_prop(group):</p>
<p>＃整数除法会向下圆整</p>
<p>bixths&#x3D;group.births.astype(float)</p>
<p>$g r o u p [ ^ { \prime } p r o p ^ { \prime } ] &#x3D; b i r t h s &#x2F;$births.sum()</p>
<p>return group</p>
<p>$a m e s &#x3D; a m e s . g r o u p b y ( [ ^ { * } y e a r ^ { * } ,$ $^ { \prime } \sec ^ { \prime } ] )$.apply(add_prop)</p>
<p>注意：由于births是整数，所以我们在计算分式时必须将分子或分母转换成浮点数（除非你正在使用Python 3！）。</p>
<!-- 2500000 Total births by sex and year sex F 2000000 M 1500000 1000000 500000 0 1880 1900 1920 1940 year 1960 1980 2000 2020  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/6c4b27034f5d6689.jpg"></p>
<p>图2-4：按性别和年度统计的总出生数</p>
<!-- 现在，完整的数据集就有了下面这些列： In [378]:names Out[378]: &lt;class 'pandas.core.frame.DataFrame'&gt; Int64Index: 1690784 entries, 0 to 1690783 Data columns: name 1690784 non-null values sex births 1690784 non-null values 1690784 non-null values year 1690784 non-null values prop 1690784 non-null values dtypes: float64(1),int64(2),object(2)  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/cadd562b1889b8b7.jpg"></p>
<p>在执行这样的分组处理时，一般都应该做一些有效性检查，比如验证所有分组的prop的总和是否为1。由于这是一个浮点型数据，所以我们应该用np.allclose来检查这个分组总计值是否足够近似于（可能不会精确等于）1：</p>
<p>In [379]:np.allclose(names.groupby([‘year’,’$\sec ^ { \prime } ] ) $⋅prop.∑um(),,1)</p>
<p>Out[379]:True</p>
<p>这样就算完活了。为了便于实现更进一步的分析，我需要取出该数据的一个子集：每对sex／year组合的前1000个名字。这又是一个分组操作：</p>
<p>def get_top1000(group):</p>
<p>return group.sort_index(by&#x3D;’births’,ascending&#x3D;False)[:S1000]</p>
<p>$g r o u p e d &#x3D; n a m e s . g r o u p b y ( [ ^ { \prime } y e a r ^ { \prime } , \cdots ^ { \prime } ] )$</p>
<p>top1000&#x3D;grouped.appIy(getttop1000)</p>
<p>如果你喜欢DIY的话，也可以这样：</p>
<p>πeces&#x3D;[]</p>
<p>for year, group in names.groupby([‘year’, ‘sex’]):</p>
<p>pieces.append(group.sort_index(by&#x3D;’births’, scending&#x3D;False)[:1000])</p>
<p>top1000&#x3D; pd.concat(pieces, ignore_index&#x3D;True)</p>
<p>现在的结果数据集就小多了：</p>
<p>In [382]: top1000</p>
<p>Out[382]:</p>
<p>&lt;class ‘pandas.core.frame.DataFrame’&gt;</p>
<p>Int64Index: 261877 entries, 0 to 261876</p>
<p>Data columns:</p>
<p>name 261877 non-null values</p>
<p>sex 261877 non-null values</p>
<p>births 261877 non-null values</p>
<p>year 261877 non-null values</p>
<p>prop 261877 non-null values</p>
<p>dtypes: float64(1), int64(2), object(2)</p>
<p>接下来的数据分析工作就针对这个top1000数据集了。</p>
<h2 id="分析命名趋势"><a href="#分析命名趋势" class="headerlink" title="分析命名趋势"></a>分析命名趋势</h2><p>有了完整的数据集和刚才生成的top1000数据集，我们就可以开始分析各种命名趋势了。首先将前1000个名字分为男女两个部分：</p>
<p>In [383]:boys &#x3D;top1000[top1000.$. \sec x &#x3D; &#x3D; ^ { \prime } M ^ { \prime } ]$</p>
<p>In [384]:$g i r l s &#x3D; t o p 1 0 0 0 [ t o p 1 0 0 0 . s e x &#x3D; ^ { \prime } F ^ { \prime } ]$</p>
<p>这是两个简单的时间序列，只需稍作整理即可绘制出相应的图表（比如每年叫做John和Mary的婴儿数）。我们先生成一张按year和name统计的总出生数透视表：</p>
<p>In [385]:$t o t a l b i r t h s &#x3D; t o p 2 0 0 0 . p i v o t t t t a b l e ( ^ { \prime } b i r t h s ^ { \prime } , r o w s &#x3D; y e a r ^ { \prime } .$ $\cot x + \tan e ^ { \prime }$,…: argfunc&#x3D;sum)</p>
<p>现在，我们用DataFrame的plot方法绘制几个名字的曲线图：</p>
<p>In [386]: tota1_births</p>
<p>Out[386]:</p>
<p>&lt;class ‘pandas.core.frame.DataFrame’&gt;</p>
<p>Int64Index: 131 entries, 1880 to 2010</p>
<p>Columns: 6865 entries, Aaden to Zuri</p>
<p>dtypes:float64(6865)</p>
<p>In[387]::subset &#x3D; total_births[[‘John’,’’Harry’,,’Mary’,,’Marilyn’]]</p>
<p>In [388]: subset.plot(subplotts&#x3D;True, figsize&#x3D;(12,10),grid&#x3D;False</p>
<p>$t i t l e &#x3D; ^ { u } N u m b e r$of births per year”)</p>
<p>最终结果如图2-5所示。从图中可以看出，这几个名字在美国人民的心目中已经风光不再了。但事实并非如此简单，我们在下一节中就能知道是怎么一回事了。</p>
<!-- Number of births per year 80000 000 John 40000 30000 200 10000 10000 year 8000 - Harry 6000 4000 2000 80000 year 70000 60000 Mary 40000 30000 20000 10000 12000 year 10000 8000 Marilyn 6000 4000 2000 1920 year  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/3ae37c73b9892fce.jpg"></p>
<p>图2-5：几个男孩和女孩名字随时间变化的使用数量</p>
<h2 id="评估命名多样性的增长"><a href="#评估命名多样性的增长" class="headerlink" title="评估命名多样性的增长"></a>评估命名多样性的增长</h2><p>图2-5所反映的降低情况可能意味着父母愿意给小孩起常见的名字越来越少。这个假设可以从数据中得到验证。一个办法是计算最流行的1000个名字所占的比例，我按year和sex 进行聚合并绘图：</p>
<p>In [390]:$t a b l e &#x3D; t o p 1 0 0 0 . p i v o t - t a b l e ( ^ { * } p r o p ^ { * } , r o w s &#x3D; ^ { t } y e a r ^ { \prime } ,$</p>
<p>⋯ $c o l s &#x3D; ^ { \prime } \sec x ^ { \prime } , \arg f u n c &#x3D; s u m )$</p>
<p>In[391]: table.plot(title&#x3D;’Sum of table1000.prop by year and sex’,</p>
<p>*⋯: ticks&#x3D;n.linspace(0,1.2,13),.xticks&#x3D;ange(1880,2020,10))</p>
<p>结果如图2-6所示。从图中可以看出，名字的多样性确实出现了增长（前1000项的比例降低）。另一个办法是计算占总出生人数前50％的不同名字的数量，这个数字不太好计算。我们只考虑2010年男孩的名字：</p>
<p>In [392]:df&#x3D;boys[boys.year&#x3D;2010]</p>
<p>In [393]:df</p>
<p>Out[393]:</p>
<p>&lt;class ‘pandas.core.frame.DataFrame’&gt;</p>
<p>Int64Index: 1000 entries, 260877 to 261876</p>
<p>Data columns:</p>
<p>name 1000 non-null values</p>
<p>sex 1000 non-null values</p>
<p>births 1000 non-null values</p>
<p>year 1000 non-null values</p>
<p>prop 1000 non-null values</p>
<p>dtypes: float64(1),int64(2),object(2)</p>
<!-- 1.2 Sum of table1000.prop by yearand sex 1.1 sex 1.0 F 0.9 M 0.8 0.7 0.6 0.5 0.4 0.3 0.2 0.1 0.0 1880 1890 1900 1910 1920 1930 1940 1950 year 1960 1970 1980 1990 2000 2010  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/d4ca4791664213fa.jpg"></p>
<p>图2-6：分性别统计的前1000个名字在总出生人数中的比例</p>
<p>在对prop降序排列之后，我们想知道前面多少个名字的人数加起来才够50％。虽然编写一个for循环确实也能达到目的，但NumPy有一种更聪明的矢量方式。先计算prop的累计和cumsum，然后再通过searchsorted方法找出0.5应该被插入在哪个位置才能保证不破坏顺序：</p>
<p>In [394]:prop_cumsum&#x3D;df.$. s o r t \underline { \in d e \times ( b y &#x3D; ^ { \prime } p r o p ^ { \prime }$,ascendirng&#x3D;False).prop.cumsum()</p>
<p>In [395]:prop_cumsum[:10]</p>
<p>Out[395]:</p>
<p>260877 0.011523</p>
<p>260878 0.020934</p>
<p>260879 0.029959</p>
<p>260880 0.038930</p>
<p>260881 0.047817</p>
<p>260882 0.056579</p>
<p>260883 0.065155</p>
<p>260884 0.073414</p>
<p>260885 0.081528</p>
<p>260886 0.089621</p>
<p>In [396]: prop_cumsum.searchsorted(0.5)</p>
<p>Out[396]:116</p>
<p>由于数组索引是从0开始的，因此我们要给这个结果加1，即最终结果为117。拿1900年的数据来做个比较，这个数字要小得多：</p>
<p>In [397]:df&#x3D;boys[boys.year&#x3D;1900]</p>
<p>In [398]:$\in 1 9 0 0 &#x3D; d f . 5 0 r t \bot n d e \times ( b y &#x3D; ^ { \prime } p r o p ^ { \prime }$,ascending&#x3D;FalSe).prop.cumsum()</p>
<p>In [399]:in1900.searchsorted(0.5)+</p>
<p>Out[399]:25</p>
<p>现在就可以对所有year／sex组合执行这个计算了。按这两个字段进行groupby处理，然后用一个函数计算各分组的这个值：</p>
<p>def get_quantile_count(group,q&#x3D;0.5)</p>
<p>$g r o u p &#x3D; g r o u p \cdot S o r t \underline { \in } \in d e \times ( b y &#x3D; ^ { \prime } p r o p ^ { \prime } $ascend∈g&#x3D;False)</p>
<p>returngroup⋅prop.cumsum()</p>
<p>$\div d i v e r s i t y &#x3D; t o p 1 0 0 0 . g r o u p b y ( [ \begin{matrix} r ^ { \prime } y e a r ^ { \prime } \ d i v e r s i t y &#x3D; d i v e r s i t y . u n s t a c k ( ^ { \prime } s e x ^ { \prime } ) \end{matrix}$ $\sec x ^ { \prime } ] )$ $. a p p l y ( g e t _ q u a n t i l e _ c o u n t )$</p>
<p>现在，diversity这个DataFrame拥有两个时间序列（每个性别各一个，按年度索引）。通过IPython，你可以查看其内容，还可以像之前那样绘制图表（如图2-7所示）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/1f85d4d203904b72.jpg"></p>
<table>
<thead>
<tr>
<th>In [4</th>
<th>01]:</th>
<th>divers</th>
</tr>
</thead>
<tbody><tr>
<td>Out[4sex</td>
<td>01]:F</td>
<td>M</td>
</tr>
<tr>
<td>year</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1880</td>
<td>38</td>
<td>14</td>
</tr>
<tr>
<td>1881</td>
<td>38</td>
<td>14</td>
</tr>
<tr>
<td>1882</td>
<td>38</td>
<td>15</td>
</tr>
<tr>
<td>1883</td>
<td>39</td>
<td>15</td>
</tr>
<tr>
<td>1884</td>
<td>39</td>
<td>16</td>
</tr>
</tbody></table>
<p>In [402]: diversity.plot(title&#x3D;”Number of popular names in top 50%”)</p>
<!-- 250 Number of popular names in top 50% sex F 200 M 150 100 50 1880 1900 1920 1940 year 1960 1980 2000 2020  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/675dcd71bc7f4ecf.jpg"></p>
<p>图2-7：按年度统计的密度表</p>
<p>从图中可以看出，女孩名字的多样性总是比男孩的高，而且还在变得越来越高。读者们可以自己分析一下具体是什么在驱动这个多样性（比如拼写形式的变化）。</p>
<h1 id="“最后一个字母”的变革"><a href="#“最后一个字母”的变革" class="headerlink" title="“最后一个字母”的变革"></a>“最后一个字母”的变革</h1><p>2007年，一名婴儿姓名研究人员Laura Wattenberg在她自己的网站上指出（http：／／<a href="http://www.babynamewizard.com）：近百年来，男孩名字在最后一个字母上的分布发生了显著的变化。为了了解具体的情况，我首先将全部出生数据在年度、性别以及末字母上进行了聚合：">www.babynamewizard.com）：近百年来，男孩名字在最后一个字母上的分布发生了显著的变化。为了了解具体的情况，我首先将全部出生数据在年度、性别以及末字母上进行了聚合：</a></p>
<p>＃从name列取出最后一个字母</p>
<p>get1ast1ettter&#x3D;1ambdax:x[-1]</p>
<p>1ast.1ettters&#x3D;names.name.map(get.1ast.letter)</p>
<p>$1 a s t ] e t t e r s . n a m e &#x3D; ^ { \prime } 1 a s t 1 e t t e r ^ { \prime }$</p>
<p>$t a b l e &#x3D; n a m e s . p i v o t t t a b l e ( ^ { \prime } b i r t h s ^ { \prime } ,$rows&#x3D;lastletters,</p>
<p>$\cos 2 5 &#x3D; [ ^ { \prime } \sec x ^ { \prime } ,$ ‘year’],argfunc&#x3D;sum)</p>
<p>然后，我选出具有一定代表性的三年，并输出前面几行：</p>
<p>In [404]: subtable&#x3D; table.reindex(columns&#x3D;[1910, 1960,2010],$1 e v e 1 &#x3D; ^ { \prime } y e a r ^ { \prime } )$</p>
<p>In [405]: subtable.head()</p>
<p>Out[405]:</p>
<table>
<thead>
<tr>
<th>sex</th>
<th>F</th>
<th>F</th>
<th></th>
<th>M</th>
<th>M</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>year</td>
<td>1910</td>
<td>1960</td>
<td>2010</td>
<td>1910</td>
<td>1960</td>
<td>2010</td>
</tr>
<tr>
<td>last_letter</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>a</td>
<td>108376</td>
<td>691247</td>
<td>670605</td>
<td>977</td>
<td>5204</td>
<td>28438</td>
</tr>
<tr>
<td>b</td>
<td>NaN</td>
<td>694</td>
<td>450</td>
<td>411</td>
<td>3912</td>
<td>38859</td>
</tr>
<tr>
<td>C</td>
<td>5</td>
<td>49</td>
<td>946</td>
<td>482</td>
<td>15476</td>
<td>23125</td>
</tr>
<tr>
<td>d</td>
<td>6750</td>
<td>3729</td>
<td>2607</td>
<td>22111</td>
<td>262112</td>
<td>44398</td>
</tr>
<tr>
<td>e</td>
<td>133569</td>
<td>435013</td>
<td>313833</td>
<td>28655</td>
<td>178823</td>
<td>129012</td>
</tr>
</tbody></table>
<p>接下来我们需要按总出生数对该表进行规范化处理，以便计算出各性别各末字母占总出生人数的比例：</p>
<table>
<thead>
<tr>
<th>In [Out[</th>
<th>406]:406]:</th>
<th>subtable.sum()</th>
</tr>
</thead>
<tbody><tr>
<td>sex</td>
<td>year</td>
<td></td>
</tr>
<tr>
<td>F</td>
<td>1910</td>
<td>396416</td>
</tr>
<tr>
<td></td>
<td>1960</td>
<td>2022062</td>
</tr>
<tr>
<td></td>
<td>2010</td>
<td>1759010</td>
</tr>
<tr>
<td>M</td>
<td>1910</td>
<td>194198</td>
</tr>
<tr>
<td>M</td>
<td>1960</td>
<td>2132588</td>
</tr>
<tr>
<td>M</td>
<td>2010</td>
<td>1898382</td>
</tr>
</tbody></table>
<p>In [407]: letter_prop &#x3D; subtable &#x2F; subtable.sum()</p>
<p>有了这个字母比例数据之后，就可以生成一张各年度各性别的条形图了，如图2-8所示：</p>
<p>import matplotlib.pyplot as plt</p>
<p>fig,a×es&#x3D;plt.subplots(2,1,figsize&#x3D;(108))</p>
<p>letter_prop[‘M’].$\cdot p l o t ( k i n d &#x3D; ^ { * } b a r ^ { \prime } ,$ rot&#x3D;0,$a x &#x3D; a \times e s [ 0 ] , t i t l e &#x3D; ^ { \prime } M a l e ^ { \prime } )$</p>
<p>letter_prop[‘F’].$p l o t ( k \in d &#x3D; ^ { \prime } b a r ^ { \prime }$ rot&#x3D;0,$a x &#x3D; a \times e s [ 1 ] , t i t l e &#x3D; ^ { \prime } F e m a l e ^ { \prime }$,legend&#x3D;False)</p>
<!-- 0.40 Male 0.35 year 0.30 1910 0.25 1960 2010 0.20 0.15 0.10 0.05 0.00 b d f 9 h i j k m n P 0 r S \~ U V W X y z  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/0d4e6953d0f93dc6.jpg"></p>
<!-- last_etter 0.40 Female 0.35 0.30 0.25 0.20 0.15 0.10 0.05 0.00 a b C d 9 h i k 1m n 0 P q r S t U W y Z last_Jetter  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/ff512ab64a9c407c.jpg"></p>
<p>图2-8：男孩女孩名字中各个末字母的比例</p>
<p>从图2-8中可以看出，从20世纪60年代开始，以字母”n” 结尾的男孩名字出现了显著的增长。回到之前创建的那个完整表，按年度和性别对其进行规范化处理，并在男孩名字中选取几个字母，最后进行转置以便将各个列做成一个时间序列：</p>
<p>In [410]:letter_[prop&#x3D;table&#x2F;table.sum()</p>
<p>In[411]:$d n y _ { - } t s &#x3D; 1 e t t e r _ { - } p r o p \cdot i \times [ l ^ { \prime } d ^ { \prime }$,$n ^ { \prime } ,$ $^ { \prime } y ^ { \prime } ] ,$-$^ { \prime } M ^ { \prime } ] . T$</p>
<p>In[412]:dny_ts.head()</p>
<p>Out[412]:</p>
<table>
<thead>
<tr>
<th></th>
<th>d</th>
<th>n</th>
<th>y</th>
</tr>
</thead>
<tbody><tr>
<td>year</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1880</td>
<td>0.083055</td>
<td>0.153213</td>
<td>0.075760</td>
</tr>
<tr>
<td>1881</td>
<td>0.083247</td>
<td>0.153214</td>
<td>0.077451</td>
</tr>
<tr>
<td>1882</td>
<td>0.085340</td>
<td>0.149560</td>
<td>0.077537</td>
</tr>
<tr>
<td>1883</td>
<td>0.084066</td>
<td>0.151646</td>
<td>0.079144</td>
</tr>
<tr>
<td>1884</td>
<td>0.086120</td>
<td>0.149915</td>
<td>0.080405</td>
</tr>
</tbody></table>
<p>有了这个时间序列的DataFrame之后，就可以通过其plot方法绘制出一张趋势图了（如图2-9所示）：</p>
<p>In[414]:dny_ts.plot()</p>
<!-- 0.40 d 0.35 n 0.30 y 0.25 0.20 0.15 0.10 0.05 0.00 1880 1900 1920 1940 year 1960 1980 2000 2020  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/75d202137eff7965.jpg"></p>
<p>图2-9：各年出生的男孩中名字以d／n／y结尾的人数比例</p>
<h2 id="变成女孩名字的男孩名字（以及相反的情况）"><a href="#变成女孩名字的男孩名字（以及相反的情况）" class="headerlink" title="变成女孩名字的男孩名字（以及相反的情况）"></a>变成女孩名字的男孩名字（以及相反的情况）</h2><p>另一个有趣的趋势是，早年流行于男孩的名字近年来“变性了”，例如Lesley或Leslie。回到top1000数据集，找出其中以“lesl”开头的一组名字：</p>
<p>In [415]: all_names &#x3D;top1000.name.unique()</p>
<p>In [416]:mask&#x3D;np. array([‘lesl’ in x.lower()forξallames]</p>
<p>5[417]:$: 1 e s l e y _ { - } 1 i k e &#x3D; a l 1 _ { - }$names[mask]</p>
<p>In [418]:lesley_like</p>
<p>Out[418]: array([Leslie, Lesley, Leslee, Lesli, Lesly], dtype&#x3D;object)</p>
<p>然后利用这个结果过滤其他的名字，并按名字分组计算出生数以查看相对频率：</p>
<p>In [419]: filtered &#x3D;top1000[top1000.name.isin(lesley_like)]</p>
<p>.births.sum()</p>
<p>Out[420]:</p>
<p>name</p>
<p>Leslee 1082</p>
<p>Lesley 35022</p>
<p>Lesli 929</p>
<p>Leslie 370429</p>
<p>Lesly 10067</p>
<p>Name: births</p>
<p>接下来，我们按性别和年度进行聚合，并按年度进行规范化处理：</p>
<p>In [421]:$t a b l e &#x3D; f l t e r e d . p i v o t t t a b l e ( ^ { \prime } b i r t h s ^ { \prime } ,$ $r o w s &#x3D; ^ { \prime } y e a r ^ { \prime } ,$</p>
<p>⋯ $\cot x ^ { \prime } ,$ $a g g f u n c &#x3D; ^ { \prime } s u m ^ { \prime } )$</p>
<p>In [422]: table&#x3D;table.div(table.sum(1),aξs&#x3D;0</p>
<p>In [423]: table.tail()</p>
<p>Out[423]:</p>
<p>sex F M</p>
<p>year</p>
<p>2006 1 NaN</p>
<p>2007 1 NaN</p>
<p>2008 1 NaN</p>
<p>2009 1 NaN</p>
<p>2010 1 NaN</p>
<p>现在，我们就可以轻松绘制一张分性别的年度曲线图了（如图2-10所示）：</p>
<p>In[425]:$: t a b l e . p l o t ( s t y l e &#x3D; { ^ { \prime } M ^ { \prime } $ “k-“, $^ { \prime } F ^ { \prime } : k - \cdot 3 )$</p>
<!-- 1.0 sex 0.8 M 0.6 0.4 0.2 0.0 1880 1900 1920 1940 year 1960 1980 2000 2020  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/aa5335cf6ddafaec.jpg"></p>
<p>图2-10：各年度使用“Lesley型”名字的男女比例</p>
<h2 id="小结及展望"><a href="#小结及展望" class="headerlink" title="小结及展望"></a>小结及展望</h2><p>本章中的这些例子都非常简单，但它们可以让你大致了解后续章节的相关内容。本书关注的焦点是工具而不是那些复杂精妙的分析方法。掌握本书所介绍的技术将使你能够立马开展自己的分析工作（假设你已经知道要做什么了）。</p>
<h1 id="IPython：一种交互式"><a href="#IPython：一种交互式" class="headerlink" title="IPython：一种交互式"></a>IPython：一种交互式</h1><h2 id="计算和开发环境"><a href="#计算和开发环境" class="headerlink" title="计算和开发环境"></a>计算和开发环境</h2><p>为无为，事无事，味无味。大小多少。报怨以德。</p>
<p>图难于其易，为大于其细；</p>
<p>天下难事，必作于易；天下大事，必作于细。</p>
<p>-老子</p>
<p>人们经常问我，“你的Python开发环境是什么？”我的回答基本永远都是“IPython外加一个文本编辑器”。如果想要得到更加高级的图形化工具和代码自动完成功能，你也可以考虑用一款集成开发环境（IDE）来代替文本编辑器。即便如此，我仍然强烈建议你将IPython作为工作中的重要工具。有的IDE甚至本身就集成了IPython，所以说两全其美的办法还是有的。</p>
<p>2001年，Fernando Pérez为了得到一个更为高效的交互式Python解释器而启动了一个业余项目，于是IPython项目诞生了。在接下来的11年中，它逐渐被公认为现代科学计算中最重要的Python工具之一。IPython本身并没有提供任何的计算或数据分析功能，其设计目的是在交互式计算和软件开发这两个方面最大化地提高生产力。它鼓励一种“执行-探索”（execute explore）的工作模式，而不是许多其他编程语言那种“编辑-编译-运行”（edit-complie-run）的传统工作模式。此外，它跟操作系统shell和文件系统之间也有着非常紧密的集成。由于大部分的数据分析代码都含有探索式操作（试误法和迭代法），因此IPython（在绝大多数情况下）将有助于提高你的工作效率。</p>
<p>当然了，IPython项目现在已经不再只是一个加强版的交互式Python shell，它还有一个可以直接进行绘图操作的GUI控制台、一个基于Web的交互式笔记本，以及一个轻量级的快速并行计算引擎。此外，跟许多其他专为程序员设计（以及由程序员设计）的工具一样，它也是高度可定制的。我将在本章最后介绍一些这样的功能。</p>
<p>由于IPython的核心功能是交互，所以在没有动态控制台的情况下，本章中的某些功能很难说得清楚。如果这是你第一次学习IPython，那我建议你照着例子实际动手试试，感觉一下到底是怎么一回事。跟所有由键盘驱动的控制台环境一样，锻炼对常用命令的肌肉记忆是学习曲线中不可或缺的一部分。</p>
<p>注意：在第一次阅读时，本章的许多内容都可跳过不看，因为它们对理解本书其余的内容没有影响。本章的目的是让你对IPython所提供的功能有一个全面的了解。</p>
<h1 id="IPython基础"><a href="#IPython基础" class="headerlink" title="IPython基础"></a>IPython基础</h1><p>你可以通过命令行启动IPython，就像启动标准Python解释器那样，只是把命令改为ipython罢了：</p>
<h1 id="36-ipython"><a href="#36-ipython" class="headerlink" title="&#36;ipython"></a>&#36;ipython</h1><p>Python 2.7.2 (default,May 27 2012,21:26:12)</p>
<p>Type “copyright”, “credits” or “license” for more information.</p>
<p>IPython 0.12 – An enhanced Interactive Python.</p>
<p>? -&gt; Introduction and overview of IPython’s features.</p>
<p>%quickref -&gt; Quick reference.</p>
<p>help-&gt; Python’s own help system.</p>
<p>object? -&gt; Details about ‘object’, use ‘object??’ for extra details.</p>
<p>In [1]:a&#x3D;5</p>
<!-- HZ BOOKS  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/d7f09a4e50294b06.jpg"></p>
<p>In[2]:a</p>
<p>Out[2]:5</p>
<p>你可以在这里执行任何Python语句，只需将其输入然后按下回车键就行了。如果只是在IPython中输入了一个变量，那么它将会显示出该对象的一个字符串表示： 译注1</p>
<p>In[541]:import numpy as np</p>
<p>In[542]:deta&#x3D;{i:randn()for i in range(7)}?</p>
<p>In [543]:data</p>
<p>Out[543]:</p>
<p>{0:0.5580886709219381,</p>
<p>1:0.25701015249982423,</p>
<p>2: 0.8876099192477288,</p>
<p>3:1.0210657329557034,</p>
<p>4: -0.21799201419817044,</p>
<p>译注1：从输入输出提示符来看，作者在这两段之间做了不少事情，所以如果出现randn找不到的情况，请先执行from numpy.random import randn。</p>
<p>5: 1.1388001234975833,</p>
<p>6: -0.5209890532927175}</p>
<p>许多Python对象都被格式化为可读性更好（或者说排版更好）的形式，这跟print的普通输出形式有着显著区别。如果在标准Python解释器中打印上面那个字典对象，其可读性就没那么好了：</p>
<p>&gt;&gt;&gt; from numpy.random import randn</p>
<p>&gt;&gt;&gt;data &#x3D;{i :randn()</p>
<p>&gt;&gt; print data</p>
<p>{0: -1.5948255432744511, 1: 0.10569006472787983,2:1.972367135977295,</p>
<p>3:0.15455217573074576, 4: -0.24058577449429575,5: -1.2904897053651216,6:0.3308507317325902}</p>
<p>IPython还可以方便地执行任意代码块（通过少量优雅的复制粘贴操作）和整个Python脚本。稍后就会对该功能进行介绍。</p>
<h2 id="Tab键自动完成"><a href="#Tab键自动完成" class="headerlink" title="Tab键自动完成"></a>Tab键自动完成</h2><p>从表面上看，IPython就像是一个化了淡妆的交互式Python解释器。数学软件（Mathematica）用户可能会对标号式的输入输出提示符眼熟。Tab键自动完成功能是对标准Python shell的主要改进之一，大部分交互式数据分析环境都有这个功能。在shell中输入表达式时，只要按下Tab键，当前命名空间中任何与已输入的字符串相匹配的变量（对象、函数等）就会被找出来：</p>
<!-- HZ BOOKS  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/478afdea91559d86.jpg"></p>
<p>In [1]:$a n _ a p p l e &#x3D; 2 7$</p>
<p>In[2]:anexample&#x3D;42</p>
<p>In[3]: an&lt;Tab&gt;<strong>译注2</strong>华章图书<strong>译注3</strong></p>
<p>an_apple and an_example any</p>
<p>在这个例子中可以看到，IPython将我定义的两个变量都显示出来了，此外还显示了Python关键字and和内置函数any。当然，你也可以在任何对象后面输入一个句点以便自动完成方法和属性的输入：</p>
<p>In [3]:b&#x3D;[1,2,3]</p>
<p>In[4]:b.&lt;Tab&gt;</p>
<p>b.append b.extend b.insert b.remove b.sort</p>
<p>b.count b.index b.pop b.reverse</p>
<p><strong>译注2</strong>：后面的＜Tab＞只是一个按键说明而已，不用输入。顺便说明一下，按完Tab键之后，已输入的内容会在下一行重复出现，行号也是一样的，直接接着往下输入就行了。</p>
<p><strong>译注3</strong>：根据软件版本、配置以及当前上下文的不同，这里得到的结果可能会比书上的多。</p>
<p>还可以应用在模块上：</p>
<p>In [1]: import datetime</p>
<p>In [2]:datetime.&lt;Tab&gt;</p>
<p>datetime.MAXYEAR datetime.datetime datetime.timedelta</p>
<p>datetime.MINYEAR datetime.datetime_CAPI datetime.tzinfo</p>
<p>datetime.date datetime.time</p>
<p>注意：IPython默认会隐藏那些以下划线开头的方法和属性，比如魔术方法（magic method）以及内部的“私有”方法和属性，其目的是避免在屏幕上显示一堆乱七八糟的东西（也为了避免把Python新人搞晕！）。其实这些也是可以通过Tab键自动完成的，只是你得先输入一个下划线才行。如果你就是喜欢能总是看到这些方法，直接修改IPython配置文件中的相关设置就可以了。</p>
<p>Tab键自动完成功能不只可以用于搜索命名空间和自动完成对象或模块属性。当你输入任何看上去像是文件路径的东西时（即使是在一个Python字符串中），按下Tab键即可找出电脑文件系统中与之匹配的东西：</p>
<p>In [3]: book_scripts&#x2F;&lt;Tab&gt;<strong>译注4</strong></p>
<p>book_scripts&#x2F;cprof_example.py book_scripts&#x2F;ipython_script_test.py book_scripts&#x2F;ipython_bug.py book_scripts&#x2F;prof_mod.py</p>
<p>In [3]: path &#x3D; ‘book_scripts&#x2F;&lt;Tab&gt;</p>
<p>book_scripts&#x2F;cprof_example.py book_scripts&#x2F;ipython_script_test.py book_scripts&#x2F;ipython_bug.py book_scripts&#x2F;prof_mod.py</p>
<p>如果再结合％run命令（参见后面内容），该功能将显著减少你敲键盘的次数。</p>
<p>Tab键自动完成功能还可用于函数关键字参数（包括等号(&#x3D;)!)。</p>
<h2 id="内省"><a href="#内省" class="headerlink" title="内省"></a>内省</h2><p>在变量的前面或后面加上一个问号（？）就可以将有关该对象的一些通用信息显示出来：</p>
<p>In [545]:b?</p>
<p>Type: list</p>
<p>String Form:[1,2,3]</p>
<p>Length: 3</p>
<p>Docstring:</p>
<p>list() -&gt; new empty list</p>
<p>list(iterable) -&gt; new list initialized from iterable’s items</p>
<p><strong>译注4</strong>：注意，要使用正斜杠（／），不然认不出来。此外，文件夹或文件名中间不能有空格，不然也无法正常继续操作。</p>
<p>这就叫做对象内省（object introspection）<strong>译注5</strong>。如果该对象是一个函数或实例方法，则其docstring（如果有的话）也会被显示出来：</p>
<p>def add_numbers(a, b):</p>
<p>Add two numbers together</p>
<p>Returns</p>
<p>$t h e _ { - } s u m$:type of arguments</p>
<p>1.,</p>
<p>returna+b</p>
<p>然后可以利用？来显示这段docstring：</p>
<p>In [547]:add_numbers?</p>
<p>Type: function</p>
<p>String Form:&lt;function add_numbers at 0x5fad848&gt;</p>
<p>File: book_scripts&#x2F;&lt;ipython-input-546-5473012eeb65&gt;</p>
<p>Definition: add_numbers(a, b)</p>
<p>Docstring:</p>
<p>Add two numbers together</p>
<p>Returns</p>
<p>the_sum : type of arguments</p>
<p>使用？？还将显示出该函数的源代码（如果可能的话）：</p>
<p>In [548]:add_numbers??</p>
<p>Type: function</p>
<p>String Form:&lt;function add_numbers at 0x5fad848&gt;</p>
<p>File: book_scripts&#x2F;&lt;ipython-input-546-5473012eeb65&gt;</p>
<p>Definition: add_numbers(a,b)</p>
<p>Source:</p>
<p>def add_numbers(a,b):</p>
<p>…</p>
<p>Add two numbers together</p>
<p>Returns</p>
<p>the sum :type of arguments</p>
<p>returna+b</p>
<p>？还有一个用法，即搜索IPython命名空间，类似于标准UNIX或Windows命令行中的那种用法。一些字符再配以通配符(*)即可显示出所有与该通配符表达式相匹配的名称。例如，我们可以列出NumPy顶级命名空间中含有“load”的所有函数：</p>
<p>In [549]:np⋅<em>load</em>?</p>
<p>np.load</p>
<p>np.loads</p>
<p><strong>译注5</strong>：也有译作内视、自省的，不过更多译作内省。</p>
<p>np.loadtxt</p>
<p>np.pkgload</p>
<h1 id="％run命令"><a href="#％run命令" class="headerlink" title="％run命令"></a>％run命令</h1><p>在IPython会话环境中，所有文件都可以通过％run命令当做Python程序来运行。假设你在ipython_script_test.py中存放了一段简单的脚本，如下所示：</p>
<p>detf(x,y,z):</p>
<p>return(x+y) 1Z</p>
<p>a&#x3D;5</p>
<p>b&#x3D;6</p>
<p>c&#x3D;7.5</p>
<p>result&#x3D;f(a,b,c)</p>
<p>只要将文件名传给％run就可以运行了：</p>
<p>In [550]: %run ipython_script_test.py<strong>译注6</strong></p>
<p>脚本是在一个空的命名空间中运行的（没有任何import，也没有定义任何其他的变量），所以其行为应该跟在标准命令行环境（通过python script.py启动的）中执行时一样。此后，该文件中所定义的全部变量（还有各种import、函数和全局变量）就可以在当前IPython shell中访问了（除非发生了异常）：</p>
<p>In[551]:c</p>
<p>Out[551]:7.5</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/85a81820a8de15b8.jpg"></p>
<p>In [552]:result</p>
<p>Out[552]:1.4666666666666666</p>
<p>如果Python脚本需要用到命令行参数（通过sys.argv访问），可以将参数放到文件路径的后面，就像在命令行上执行那样。</p>
<p>注意：如果希望脚本能够访问在交互式IPython命名空间<strong>译注7</strong>中定义的变量，那就应该使用％run-i 而不是％run。</p>
<h2 id="中断正在执行的代码"><a href="#中断正在执行的代码" class="headerlink" title="中断正在执行的代码"></a>中断正在执行的代码</h2><p>任何代码在执行时（无论是通过％run执行的脚本，还是长时间运行的命令），只要按下</p>
<p><strong>译注6</strong>：注意文件的路径，这里实际上用的是默认路径。简单一点的办法就是直接写绝对路径，肯定不出错。</p>
<p><strong>译注7</strong>：该命名空间的名字就是interactive。</p>
<p>$^ { \prime \prime } C t r l - C ^ { \prime \prime }$，就会引发一个KeyboardInterrupt。除一些非常特殊的情况之外，绝大部分Python程序都将立即停止执行。</p>
<p>警告：当Python代码已经调用了某个已编译的扩展模块时，按下“”Ctrl-C”将无法使程序立即停止执行。在这种情况下，要么只能等待Python解释器重新获得控制权，要么只能通过操作系统的任务管理器强制终止Python进程（比较极端的情况下才需要这么干）。</p>
<h2 id="执行剪贴板中的代码"><a href="#执行剪贴板中的代码" class="headerlink" title="执行剪贴板中的代码"></a>执行剪贴板中的代码</h2><p>在IPython中执行代码的最简单方式是粘贴剪贴板中的代码。虽然这种做法很粗糙，但在实际工作中却很有用。比如说，在开发一个复杂或费时的应用程序时，你可能希望能一段一段地执行脚本，以便查看各个阶段所加载的数据以及产生的结果。又比如说，你在网上找了一段合用的代码，但又不想专门为其新建一个.py文件。</p>
<p>多数情况下，我们都可以通过“Ctrl-Shift-V”将剪贴板中的代码片段粘贴出来<strong>译注8</strong>。注意，这并不是万试万灵的，因为这种粘贴方式模拟的是在IPython中逐行输入代码，换行符会被处理为＜return＞。也就是说，如果你所粘贴的是一段缩进代码，且其中有一个空行，IPython就会认为缩进在空行那里结束了。当执行到缩进块后面那行代码时，就会引发一个IndentationError。例如下面这段代码：</p>
<p>x&#x3D;5</p>
<p>y&#x3D;7</p>
<p>ifx&gt;5:x+&#x3D;1HZ BOOKS</p>
<p>y&#x3D;8华章图书</p>
<p>直接粘贴是不行的：</p>
<p>In[1]:x&#x3D;5</p>
<p>In[2]:y&#x3D;7</p>
<p>In[3]:ifx&gt;5:</p>
<p>⋯⋯x+&#x3D;1</p>
<p>In [4]: y&#x3D;8</p>
<p>IndentationError: unexpected indent</p>
<p>If you want to paste code into IPython, try the %paste and %cpaste magic functions.</p>
<p><strong>译注8</strong>：Windows中此法行不通，需要用右键菜单中的粘贴功能，否则仅显示第一行。</p>
<p>正如错误提示信息所说的那样，我们应该使用％paste和％cpaste这两个魔术函数。％paste 可以承载剪贴板中的一切文本<strong>译注9</strong>，并在shell中以整体形式执行<strong>译注10</strong>：</p>
<p>In[6]:%paste</p>
<p>x&#x3D;5</p>
<p>y&#x3D;7</p>
<p>ifx&gt;5:</p>
<p>x+&#x3D;1</p>
<p>y&#x3D;8</p>
<h2 id="–-End-pasted-text"><a href="#–-End-pasted-text" class="headerlink" title="– End pasted text"></a>– End pasted text</h2><p>警告：根据你的系统平台以及Python的安装情况，％paste可能会不起作用。EPDFree（在第1章中介绍过）等打包发布的版本应该没有问题。</p>
<p>％cpaste跟％paste差不多<strong>译注11</strong>，只不过它多出了一个用于粘贴代码的特殊提示符而已：</p>
<p>In[7]:%cpaste</p>
<p>Pasting code; enter ‘–’ alone on the line to stop or use Ctrl-D.</p>
<p>:x&#x3D;5</p>
<p>:y&#x3D;7</p>
<p>:ifx&gt;5:</p>
<p>: x+&#x3D;1</p>
<p>:</p>
<p>: y&#x3D;8</p>
<p>对于％cpaste块，在最终执行之前，你想粘贴多少代码就粘贴多少。如果想在执行那些粘贴进去的代码之前先检查一番，就可以考虑使用％cpaste。如果发现粘贴的代码有错，只需按下“Ctrl-C”即可终止％cpaste提示符。</p>
<p>后面我将会介绍IPython HTML Notebook，它使我们能以一种基于浏览器的notebook格式逐段对可执行代码单元进行分析。</p>
<h2 id="IPython跟编辑器和IDE之间的交互"><a href="#IPython跟编辑器和IDE之间的交互" class="headerlink" title="IPython跟编辑器和IDE之间的交互"></a>IPython跟编辑器和IDE之间的交互</h2><p>某些文本编辑器（如Emacs和vim）带有一些能将代码块直接发送到IPython shell的第三方扩展。详情请参考IPython网站或搜索引擎。</p>
<p><strong>译注9</strong>：注意，这里说的是“一切”。</p>
<p><strong>译注10</strong>：注意，由于是立即整体执行，所以不要复制％paste。没事干的话倒是可以试试。</p>
<p><strong>译注11</strong>：建议始终用这个，虽然稍微麻烦一点，但是出错的可能性小很多。</p>
<p>某些IDE（如PyDev plugin for Eclipse和Python Tools for Visual Studio（微软出品））都集成了IPython终端应用程序。如果你既想用IDE又不想放弃IPython控制台，这可能是个不错的选择。</p>
<h2 id="键盘快捷键"><a href="#键盘快捷键" class="headerlink" title="键盘快捷键"></a>键盘快捷键</h2><p>IPython提供了许多用于提示符导航（Emacs文本编辑器或UNIX bash shell的用户对此会很熟悉）和查阅历史shell命令（详见下一节）的键盘快捷键。表3-1总结了最常用的一些快捷键。图3-1说明了几个光标移动快捷键的功能。</p>
<!-- C-b C-f In [27]: a _ { - } variable In [27]: a_vari C-k C-a C-e In [27]: C-u  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/87a96b7c331383af.jpg"></p>
<p>图3-1：几个IPython键盘快捷键的用法</p>
<p>表3-1：IPython标准键盘快捷键</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Ctrl-P或上箭头键</td>
<td>后向搜索命令历史中以当前输入的文本开头的命令</td>
</tr>
<tr>
<td>Ctrl-N或下箭头键</td>
<td>前向搜索命令历史中以当前输入的文本开头的命令</td>
</tr>
<tr>
<td>Ctrl-R</td>
<td>按行读取的反向历史搜索（部分匹配）</td>
</tr>
<tr>
<td>Ctrl-Shift-v</td>
<td>从剪贴板粘贴文本</td>
</tr>
<tr>
<td>Ctrl-C</td>
<td>中止当前正在执行的代码</td>
</tr>
<tr>
<td>Ctrl-A</td>
<td>将光标移动到行首</td>
</tr>
<tr>
<td>Ctrl-E</td>
<td>将光标移动到行尾</td>
</tr>
<tr>
<td>Ctrl-K</td>
<td>删除从光标开始至行尾的文本</td>
</tr>
<tr>
<td>Ctrl-U</td>
<td>清除当前行的所有文本<strong>译注12</strong></td>
</tr>
<tr>
<td>Ctrl-F</td>
<td>将光标向前移动一个字符</td>
</tr>
<tr>
<td>Ctrl-b</td>
<td>将光标向后移动一个字符</td>
</tr>
<tr>
<td>Ctrl-L</td>
<td>清屏</td>
</tr>
</tbody></table>
<p><strong>译注12</strong>：这个快捷键的功能只是跟Ctrl-K相反而已，即删除从光标开始至行首的文本，并非完全删除。</p>
<h2 id="异常和跟踪"><a href="#异常和跟踪" class="headerlink" title="异常和跟踪"></a>异常和跟踪</h2><p>如果％run某段脚本或执行某条语句时发生了异常，IPython默认会输出整个调用栈跟踪（traceback），其中还会附上调用栈各点附近的几行代码作为上下文参考。</p>
<p>In [553]:%run ch03&#x2F;ipython_bug.py</p>
<p>AssertionError Traceback (most recent call last)</p>
<p>&#x2F;home&#x2F;wesm&#x2F;code&#x2F;ipython&#x2F;IPython&#x2F;utils&#x2F;py3compat.pyc in execfile(fname, *where)</p>
<p>176 else:</p>
<p>177 filename&#x3D;fname</p>
<p>–&gt; 178 builtin_.execfile(filename,*where)</p>
<p>book_scripts&#x2F;cho3&#x2F;ipython_bug.py in &lt;module&gt;()</p>
<p>13 throws_an_exception()</p>
<p>14</p>
<p>—&gt; 15 calling_things()</p>
<p>book_scripts&#x2F;ch03&#x2F;ipython_bug.py in calling_things()</p>
<p>11 def calling_things():</p>
<p>12 works_fine()</p>
<p>13 throws_an_exception()</p>
<p>14</p>
<p>15 calling_things()</p>
<p>book_scripts&#x2F;ch03&#x2F;ipython_bug.py in throws_an_exception()</p>
<p>7 a&#x3D;5</p>
<p>8 b&#x3D;6</p>
<p>&gt;9 assert(a+b&#x3D;10)</p>
<p>10</p>
<p>11 def calling_things():</p>
<p>AssertionError:</p>
<p>拥有额外的上下文代码参考是它相对于标准Python解释器的一大优势。上下文代码参考的数量可以通过％xmode魔术命令进行控制，既可以少（与标准Python解释器相同）也可以多（带有函数参数值以及其他信息）。本章稍后还会讲到如何在发生异常之后进入跟踪栈进行交互式的事后调试（post-mortem debugging）。</p>
<h2 id="魔术命令"><a href="#魔术命令" class="headerlink" title="魔术命令"></a>魔术命令</h2><p>IPython有一些特殊命令（被称为魔术命令（Magic Command）），它们有的为常见任务提供便利，有的则使你能够轻松控制IPython系统的行为。魔术命令是以百分号％为前缀的命令。例如，你可以通过％timeit这个魔术命令检测任意Python语句（如矩阵乘法）的执行时间（稍后将对此进行详细讲解）：</p>
<p>In [554]:a&#x3D;np..random.randn(100,100)</p>
<p>In [555]: %timeit np.dot(a,a)</p>
<p>10000 loops,best of 3: 69.1 us per loop</p>
<p>魔术命令可以看做运行于IPython系统中的命令行程序。它们大都还有一些“命令行选项”，使用？即可查看其选项：</p>
<p>In[1]:%reset?</p>
<p>Resets the namespace by removing all names defined by the user.</p>
<p>Parameters</p>
<p>-f: force reset without asking for confirmation.</p>
<p>-s : ‘Soft’ reset: Only clears your namespace, leaving history intact.</p>
<p>References to objects may be kept. By default (without this option),</p>
<p>we do a ‘hard’ reset, giving you a new session and removing all</p>
<p>references to objects from the current session.</p>
<p>Examples</p>
<p>In [6]:a&#x3D;1</p>
<p>In [7]:a</p>
<p>Out[7]:1</p>
<p>In [8]:’a’ in _ip.user_ns</p>
<p>Out[8]: True</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/a7ba8c5c53d71269.jpg"></p>
<p>In [9]:%reset -f</p>
<p>In [1]:’a’in_ip.user_ns</p>
<p>Out[1]:False</p>
<p>魔术命令默认是可以不带百分号使用的，只要没有定义与其同名的变量即可。这个技术叫做automagic，可以通过％automagic打开或关闭。</p>
<p>由于可以在IPython系统中直接访问它的文档，因此我建议你浏览一下所有这些特殊的命令（输入％quickref或％magic即可）。我将着重讲解几个重要的有助于交互式计算和Python开发的魔术命令。</p>
<p>表3-2：常用的IPython魔术命令</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>%quickref</td>
<td>显示IPython的快速参考</td>
</tr>
<tr>
<td>%magic</td>
<td>显示所有魔术命令的详细文档</td>
</tr>
<tr>
<td>%debug</td>
<td>从最新的异常跟踪的底部进入交互式调试器</td>
</tr>
<tr>
<td>%hist</td>
<td>打印命令的输入（可选输出）历史</td>
</tr>
<tr>
<td>%pdb</td>
<td>在异常发生后自动进入调试器</td>
</tr>
<tr>
<td>%paste</td>
<td>执行剪贴板中的Python代码</td>
</tr>
</tbody></table>
<p>表3-2：常用的IPython魔术命令（续）</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>%cpaste</td>
<td>打开一个特殊提示符以便手工粘贴待执行的Python代码</td>
</tr>
<tr>
<td>%reset</td>
<td>删除interactive命名空间中的全部变量／名称</td>
</tr>
<tr>
<td>%page OBJECT</td>
<td>通过分页器打印输出OBJECT</td>
</tr>
<tr>
<td>%run script.py</td>
<td>在IPython中执行一个Python脚本文件</td>
</tr>
<tr>
<td>%prun statement</td>
<td>通过cProfile执行statement，并打印分析器的输出结果</td>
</tr>
<tr>
<td>%time statement</td>
<td>报告statement的执行时间</td>
</tr>
<tr>
<td>%timeit statement</td>
<td>多次执行statement以计算系综平均执行时间。对那些执行时间非常小的代码很有用</td>
</tr>
<tr>
<td>％who、％who_ls、％whos%xdel variable</td>
<td>显示interactive命名空间中定义的变量，信息级别／冗余度可变删除variable，并尝试清除其在IPython中的对象上的一切引用</td>
</tr>
</tbody></table>
<h1 id="基于Qt的富GUI控制台"><a href="#基于Qt的富GUI控制台" class="headerlink" title="基于Qt的富GUI控制台"></a>基于Qt的富GUI控制台</h1><p>IPython团队开发了一个基于Qt框架（其目的是为终端应用程序提供诸如内嵌图片、多行编辑、语法高亮之类的富文本编辑功能）的GUI控制台（见图3-2）。如果你已经安装了PyQt或PySide，使用下面这条命令来启动的话即可为其添加绘图功能：</p>
<p>ipython qtconsole-pylab&#x3D;∈l∈</p>
<p>Qt控制台可以通过标签页的形式启动多个IPython进程，这就使你能够在多个任务之间轻松切换。它也可以跟IPython HTML Notebook应用程序共享同一个进程，稍后我将专门对此进行讲解。</p>
<p>matplotlib集成与pylab模式</p>
<p>导致IPython广泛应用于科学计算领域的部分原因是它能跟matplotlib这样的库以及其他GUI工具集默契配合。即使你从未使用过matplotlib也不用担心，本书稍后会对其进行详细讲解。如果在标准Python shell中创建一个matplotlib绘图窗口，你就会郁闷地发现，GUI的事件循环会接管Python会话的控制权，直到该绘图窗口关闭为止。这自然无法实现交互式的数据分析和可视化，因此IPython对各个GUI框架进行了专门的处理以使其能够跟shell配合得天衣无缝。</p>
<p>通常，我们通过在启动IPython时加上–pylab（注意是两个短划线）标记来集成matplotlib（见图3-3）。</p>
<p>&#36; ipython –pylab</p>
<!-- IPython File Edit View Kemel Magic Window Help For more information, type 'help(pylab)'. In [1]:img=plt.imread('book_scripts/ch03/stinkbug.png') In [2]:imshow(img) Out[2]: &lt;matplotlib.image.AxesImage at Ox42ece50&gt; 50 100 150 200 250 300 350 100 200 300 400 .cumsum ( ) Out[3]: I&lt;matplotlib.lines.Line20 at 0x45406d0&gt;] -15 20 30 0 200 400 600 800 1000 In[4]: 2  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/62a06f2fa0193a89.jpg"></p>
<p>图3-2：IPython的Qt控制台</p>
<p>这样会导致几个结果。第一，IPython会启用默认GUI后台集成，这样matplotlib绘图窗口的创建就没问题了。第二，NumPy和matplotlib的大部分功能会被引入到最顶层的interactive命名空间以产生一个交互式的计算环境（就像MATLAB和其他领域特定型科学计算环境那样）。也可以通过％gui对此进行手工设置（详情请执行％gui？）。</p>
<h2 id="使用命令历史"><a href="#使用命令历史" class="headerlink" title="使用命令历史"></a>使用命令历史</h2><p>IPython维护着一个位于硬盘上的小型数据库，其中含有你执行过的每条命令的文本。这样做有几个目的：</p>
<p>. 只需很少的按键次数即可搜索、自动完成并执行之前已经执行过的命令。</p>
<p>. 在会话间持久化命令历史。</p>
<p>. 将输入／输出历史记录到日志文件。</p>
<!-- -心 su:ython File tdt Vine Bookmats Setti Help Hana:Hdj Clase, Length: 252 In 17: spu,clase.plat( Dutt7:cnatplatlib.aues.RuesSubplat at Be4364318&gt; In I8:plt.figure Dut[B]: ( ) atplatlih.Tigura.Figura at Be485ae18&gt; In 150 spu.c10 clase.plot ( ) In 1381: auit Puthag 2.7.1 0000 &#36; Ipython -pulabnat 2.7.2 IEPD 7.1-2(64-bit)cdefauu 3 281,15 Tupe "copurignt", stion IPuthon 0.13.dav--Rn anhanced Interactive Puthon qulckref -&gt; ian and ouaruiau af IFuthon's faatures. ence. help -) object7 on'soun halp susten. -)Dutails about "abject", wse 'abject77' for eutra deta Helcone to pulab, a matptotilb-based Puthon anvtronment tbackend: 20 40 60 80 100 480gl re informatian,tupehelp(pulab)', In I1:plot(ng.randon.randn(18).cusun( DutEil: Ecnotplotllb.lines.LineZ0 at 0-3fd6rdB&gt;1 1n123 plt.figura Duti23: cnatplatiib.figura.Figure at Bu3fa5d58&gt; In 13: fron pandas.ia.data inport gut_data_uahoo 135 In 14: spu_clase= get_data_uahoot"SPY"it"NdJClosa1 130 In 15: -- pu_clace.plot( dut(5]: cnatplatiib.avas.RvesSubplat at Bx3f12d98&gt; 125 In 163 In 161: 120 1n 162:0 115 110 Jan 2012 thon than then xaNov 2011g-117.06  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/ff84dace09e9ac33.jpg"></p>
<p>图3-3：pylab模式：IPython和matplotlib窗□</p>
<h2 id="搜索并重用命令历史"><a href="#搜索并重用命令历史" class="headerlink" title="搜索并重用命令历史"></a>搜索并重用命令历史</h2><p>对于许多人来说，能够搜索并执行前面的命令是非常有用的功能。IPython倡导的是一种迭代的、交互式的开发模式：你可能常常会发现自己总是在重复输入相同的命令（比如％run命令或其他的代码片段）。假设你已经执行了：</p>
<p>In[7]:%run first&#x2F;second&#x2F;third&#x2F;data_script.py</p>
<p>而在查看其执行结果后（假设其已经成功执行完毕）发现计算过程不对。在找出问题原因并修改了data_script.py之后，只需输入％run命令的前几个字符并按“Ctrl-p”键或上箭头键即可。这样就会搜索出命令历史中第一个与你输入的字符相匹配的命令。多次按“Ctrl-p”键或上箭头键就会在命令历史中不断搜索。如果你错过了想要的那条命令也没关系，你可以按“Ctrl-N”键或下箭头键在命令历史中前向搜索。只要多操作几次，以后你会想都不想地按下这些键！</p>
<p>$” C t r l - R ^ { n }$用于实现部分增量搜索，跟UNIX型shell中的readline所提供的功能一样。在Windows上，IPython模拟了readline功能。按下“Ctrl-R”并输入你想搜索的行中的几个字符：</p>
<p>In[1]:$a _ { - } c o m m a n d &#x3D; f o o ( x , y , z )$</p>
<p>(reverse-i-search)&#96;com’:$a _ { - } c o \min a n d &#x3D; f o o ( x , y , z )$</p>
<p>按下“Ctrl-R”将会循环搜索命令历史中每一条与输入相符的行。</p>
<h2 id="输入和输出变量"><a href="#输入和输出变量" class="headerlink" title="输入和输出变量"></a>输入和输出变量</h2><p>忘记把函数结果赋值给变量是一件让人很郁闷的事情。好在IPython会将输入（你输入的那些文本）和输出（返回的对象）的引用保存在一些特殊变量中。最近的两个输出结果分别保存在_（一个下划线）和_（两个下划线）变量中：</p>
<p>In[556]:2**27</p>
<p>Out[556]: 134217728</p>
<p>In[557]:</p>
<p>Out[557]: 134217728</p>
<p>输入的文本被保存在名为_iX的变量中，其中X是输入行的行号。每个输入变量都有一个对应的输出变量_X。比如说，在输入完第27行后，就会产生两个新变量_27（输出变量）和_i27（输入变量）。</p>
<p>In [26]: $f o o &#x3D; ^ { \prime } b a r ^ { \prime }$</p>
<p>In[27]:foo</p>
<p>Out[27]:’bar’</p>
<p>In [28]:-i27</p>
<p>Out[28]:$\overline { u } ^ { \prime } f 0 0 ^ { \prime }$ HZ BOOKS</p>
<p>In [29]:$\underline { } 2 7$</p>
<p>$0 u t [ 2 9 ] : ^ { \overline { \prime } } b a r ^ { \prime }$ 华章图书</p>
<p>由于输入变量是字符串，因此可以用Python的exec关键字重新执行：</p>
<p>In [30]: exec _i27</p>
<p>有几个魔术命令可用于控制输入和输出历史。％hist用于打印全部或部分输入历史，可以选择是否带行号。％reset用于清空interactive命名空间，并可选择是否清空输入和输出缓存。％xdel用于从IPython系统中移除特定对象的一切引用。详细信息请参考相应魔术命令的文档。</p>
<p>警告：在处理非常大的数据集时，一定要注意IPython的输入输出历史，它会导致所有对象引用都无法被垃圾收集器处理（即释放内存），即使用del关键字将变量从interactive命名空间中删除也不行。对于这种情况，谨慎地使用％xde1和％reset将有助于避免出现内存方面的问题。</p>
<h2 id="记录输入和输出"><a href="#记录输入和输出" class="headerlink" title="记录输入和输出"></a>记录输入和输出</h2><p>IPython能够记录整个控制台会话，包括输入和输出。执行％logstart即可开始记录日志：</p>
<p>In [3]:%logstart</p>
<p>Activating auto-logging. Current session state plus future input saved.</p>
<p>Filename :ipython_log.py</p>
<p>Mode : rotate</p>
<p>Output logging: False</p>
<p>Raw input log :False</p>
<p>Timestamping :False</p>
<p>State : active</p>
<p>IPython的日志功能可以在任何时刻开启，它将记录你的整个会话（包括此前的命令）。因此，如果你在写代码的过程中，突然想要保存所有工作的时候，直接启动日志功能就行了。％logstart的具体选项（比如修改输出文件路径）请参考其文档，此外还可以看看几个与之配套的魔术命令％logoff、％logon、％logstate以及％logstop。</p>
<h2 id="与操作系统交互"><a href="#与操作系统交互" class="headerlink" title="与操作系统交互"></a>与操作系统交互</h2><p>IPython的另一个重要特点就是它跟操作系统shell结合得非常紧密。也就是说，你可以直接在IPython中实现标准的Windows或UNIX（Linux、OS X）命令行活动。比如执行shell 命令、更改目录、将命令的执行结果保存在Python对象（列表或字符串）中等。此外，它还提供了shell命令别名以及目录书签等功能。</p>
<p>表3-3总结了用于调用shell命令的魔术命令及其语法。我将在后面几节中简要介绍这些功能。</p>
<p>表3-3：跟系统相关的IPython魔术命令</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>!cmd</td>
<td>在系统shell中执行cmd</td>
</tr>
<tr>
<td>output &#x3D; !cmd args</td>
<td>执行cmd，并将stdout存放在output中</td>
</tr>
<tr>
<td>%alias alias_name cmd</td>
<td>为系统shell命令定义别名</td>
</tr>
<tr>
<td>%bookmark</td>
<td>使用IPython的目录书签系统</td>
</tr>
<tr>
<td>%cd directory</td>
<td>将系统工作目录更改为directory</td>
</tr>
<tr>
<td>%pwd</td>
<td>返回系统的当前工作目录</td>
</tr>
<tr>
<td>%pushd directory</td>
<td>将当前目录入栈，并转向目标目录</td>
</tr>
<tr>
<td>%popd</td>
<td>弹出栈顶目录，并转向该目录</td>
</tr>
<tr>
<td>%dirs</td>
<td>返回一个含有当前目录栈的列表</td>
</tr>
</tbody></table>
<p>表3-3：跟系统相关的IPython魔术命令（续）</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>%dhist</td>
<td>打印目录访问历史</td>
</tr>
<tr>
<td>%env</td>
<td>以dict形式返回系统环境变量</td>
</tr>
</tbody></table>
<h2 id="shell命令和别名"><a href="#shell命令和别名" class="headerlink" title="shell命令和别名"></a>shell命令和别名</h2><p>在IPython中，以感叹号（！）开头的命令行表示其后的所有内容需要在系统shell中执行。也就是说，你可以删除文件（根据OS的不同，使用rm或del）、修改目录或执行任意其他处理过程。甚至还可以启动一些能将控制权从IPython手中夺走的进程（比如另外再启动一个Python解释器）：</p>
<p>In [2]:!python</p>
<p>Python 2.7.2 |EPD 7.1-2 (64-bit)| (default,Jul 3 2011,15:17:51)</p>
<p>[GCC 4.1.2 20080704 (Red Hat 4.1.2-44)] on linux2</p>
<p>Type “packages”, “demo” or “enthought” for more information.</p>
<p>&gt;&gt;&gt;</p>
<p>此外，还可以将shell命令的控制台输出存放到变量中，只需将！开头的表达式赋值给变量即可。例如，我的Linux电脑通过以太网连接到互联网，于是可以将我的IP地址存到一个Python变量中去： <strong>译注13</strong></p>
<p>In[1]:ip_info &#x3D; lifconfig etho | grep “inet”</p>
<p>In[2]: ip_info[0].strip()</p>
<p>Out[2]: ‘inet addr:192.168.1.137 Bcast:192.168.1.255 Mask:255.255.255.0’</p>
<p>返回的Python对象ip_info实际上是一个含有控制台输出结果的自定义列表类型。</p>
<p>在使用！时，IPython还允许使用当前环境中定义的Python值。只需在变量名前面加上美元符号（＄）即可：<strong>译注14</strong></p>
<p>In[3]: $f 0 0 &#x3D; t e s t ^ { * }$</p>
<p>In[4]:!ls &#36;foo</p>
<p>test4.py test.py test.xml</p>
<p>魔术命令％alias可以为shell命令自定义简称。例如：</p>
<p><strong>译注13</strong>：之前已经说过，作者用的不是Windows操作系统，所以这个命令自然无法执行。Windows 上可以用ipconfig，但毕竟不是一样东西，这里的代码自己能看明白即可。</p>
<p><strong>译注14</strong>：在Windows中，将ls换成dir。</p>
<p>In [1]: %alias 11 1s -1</p>
<p>In [2]:11 &#x2F;usr</p>
<table>
<thead>
<tr>
<th>total 332</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>drwxr-xr-x</td>
<td>2</td>
<td>root</td>
<td>root</td>
<td>69632</td>
<td>2012-01-29</td>
<td>20:36</td>
<td>bin&#x2F;</td>
</tr>
<tr>
<td>drwxr-xr-x</td>
<td>2</td>
<td>root</td>
<td>root</td>
<td>4096</td>
<td>2010-08-23</td>
<td>12:05</td>
<td>games&#x2F;</td>
</tr>
<tr>
<td>drwxr-xr-x</td>
<td>123</td>
<td>root</td>
<td>root</td>
<td>20480</td>
<td>2011-12-26</td>
<td>18:08</td>
<td>include&#x2F;</td>
</tr>
<tr>
<td>drwxr-xr-x</td>
<td>265</td>
<td>root</td>
<td>$r o o t$</td>
<td>126976</td>
<td>2012-01-29</td>
<td>20:36</td>
<td>lib&#x2F;</td>
</tr>
<tr>
<td>drwxr-xr-x</td>
<td>44</td>
<td>root</td>
<td>root</td>
<td>69632</td>
<td>2011-12-26</td>
<td>18:08</td>
<td>1ib32&#x2F;</td>
</tr>
<tr>
<td>1rwxrwxrwx</td>
<td>1</td>
<td>root $r o o t$</td>
<td></td>
<td>3</td>
<td>2010-08-23</td>
<td>16:02</td>
<td>1ib64-&gt;lib&#x2F;</td>
</tr>
<tr>
<td>drwxr-xr-x</td>
<td>15</td>
<td>root$r o o t$</td>
<td></td>
<td>4096</td>
<td>2011-10-13</td>
<td>19:03</td>
<td>local&#x2F;</td>
</tr>
<tr>
<td>$d x w x x - x x - x$</td>
<td>2</td>
<td>root$r o o t$</td>
<td></td>
<td>12288</td>
<td>2012-01-12</td>
<td>09:32</td>
<td>sbin&#x2F;</td>
</tr>
<tr>
<td>drwxr-xr-x</td>
<td>387</td>
<td>root</td>
<td>root</td>
<td>12288</td>
<td>2011-11-04</td>
<td>22:53</td>
<td>share&#x2F;</td>
</tr>
<tr>
<td>drwxrwsr-x</td>
<td>24</td>
<td>root</td>
<td>src</td>
<td>4096</td>
<td>2011-07-17</td>
<td>18:38</td>
<td>src&#x2F;</td>
</tr>
</tbody></table>
<p>可以一次执行多条命令，只需将它们写在一行上并以分号隔开即可：</p>
<p>In [558]: %alias test_alias (cd cho8; 1s;cd ..)</p>
<p>In [559]:test_alias</p>
<p>macrodata.csv spx.csv tips.csv</p>
<p>注意，IPython会在会话结束时立即“忘记”你所定义的一切别名。为了创建永久性的别名，你需要使用配置系统。本章稍后会对此进行介绍。</p>
<h2 id="目录书签系统"><a href="#目录书签系统" class="headerlink" title="目录书签系统"></a>目录书签系统</h2><p>IPython有一个简单的目录书签系统，它使你能保存常用目录的别名以便实现快速跳转。比如说，作为一名狂热的Dropbox用户，为了能够快速地转到我的Dropbox目录，我可以定义一个书签：</p>
<p>In [6]:%bookmark db&#x2F;home&#x2F;wesm&#x2F;Dropbox&#x2F;</p>
<p>在定义好书签之后，就可以在执行魔术命令％cd时使用这些书签了：</p>
<p>In [7]:cd db</p>
<p>(bookmark:db)-&gt; &#x2F;home&#x2F;wesm&#x2F;Dropbox&#x2F;</p>
<p>&#x2F;home&#x2F;wesm&#x2F;Dropbox</p>
<p>如果书签名与当前工作目录中的某个目录名冲突，可以通过-b标记（其作用是覆写）使用书签目录。％bookmark的-1选项的作用是列出所有书签：</p>
<p>In [8]:%bookmark -1</p>
<p>Current bookmarks:</p>
<p>db -&gt; &#x2F;home&#x2F;wesm&#x2F;Dropbox&#x2F;</p>
<p>书签跟别名的区别在于，它们会被自动持久化。</p>
<h1 id="软件开发工具"><a href="#软件开发工具" class="headerlink" title="软件开发工具"></a>软件开发工具</h1><p>IPython不仅是一种舒适的交互式计算和数据分析环境，同时也非常适合成为一种软件开发环境。在数据分析应用程序中，最重要的事情就是拥有正确的代码。幸运的是，IPython紧密集成并加强了Python内置的pdb调试器。此外，你还希望代码运行能足够快。为此，IPython提供了一些简单易用的代码运行时间及性能分析工具。下面，我将对这些工具做一个详细介绍。</p>
<h1 id="交互式调试器"><a href="#交互式调试器" class="headerlink" title="交互式调试器"></a>交互式调试器</h1><p>IPython的调试器增强了pdb，如Tab键自动完成、语法高亮、为异常跟踪的每条信息添加上下文参考等。调试代码的最佳时机之一就是错误刚刚发生那会儿。％debug命令（在发生异常之后马上输入）将会调用那个“事后”调试器，并直接跳转到引发异常的那个栈帧（stack frame）：</p>
<p>In [2]: run cho3&#x2F;ipython_bug.py</p>
<p>AssertionError Traceback (most recent call last)</p>
<p>&#x2F;home&#x2F;wesm&#x2F;book_scripts&#x2F;cho3&#x2F;ipython_bug.py in &lt;module&gt;()</p>
<p>13 throws_an_exception()</p>
<p>14</p>
<p>—&gt;15 calling_things()</p>
<p>&#x2F;home&#x2F;wesm&#x2F;book_scripts&#x2F;ch03&#x2F;ipython_bug.py in calling_things()</p>
<p>11 def calling_things():</p>
<p>12 works∈e(</p>
<p>13 throws_an_exception()</p>
<p>14</p>
<p>15 calling_things()</p>
<p>&#x2F;home&#x2F;wesm&#x2F;book_scripts&#x2F;ch03&#x2F;ipython_bug.py in throws_an_exception()</p>
<p>7 a&#x3D;5</p>
<p>8 b&#x3D;6</p>
<p>9 assert(a+b&#x3D;10)</p>
<p>10</p>
<p>11detcalling_things():</p>
<p>AssertionError:</p>
<p>In [3]:%debug</p>
<p>throws_an_exception()</p>
<p>8 b&#x3D;6</p>
<p>—-&gt;9 assert(a+b&#x3D;10)</p>
<p>10</p>
<p>ipdb&gt;</p>
<p>在这个调试器中，你可以执行任意Python代码并查看各个栈帧中的一切对象和数据（也</p>
<p>就是解释器还“留了条生路”的那些）。默认是从最低级开始的（即错误发生的地方）。输入u（或up）和d（或down）即可在栈跟踪的各级别之间切换：</p>
<p>ipdb&gt; u</p>
<p>calling_things()</p>
<p>12 worksf∈e(</p>
<p>—&gt;13 throws_an_exception()</p>
<p>14</p>
<p>执行％pdb命令可以让IPython在出现异常之后自动调用调试器。很多人都认为这是一个非常实用的功能。</p>
<p>此外，调试器还可以为代码开发工作提供帮助，尤其是当你想要设置断点或对函数／脚本进行单步调试以查看各条语句的执行情况时。实现这个目的的方式有几个。第一，使用带有-d选项的％run命令，这将会在执行脚本文件中的代码之前先打开调试器。必须立即输入s（或step）才能进入脚本：<strong>译注15</strong></p>
<p>In [5]: run -d cho3&#x2F;ipython_bug.py</p>
<p>Breakpoint 1 at &#x2F;home&#x2F;wesm&#x2F;book_scripts&#x2F;ch03&#x2F;ipython_bug.py:1</p>
<p>NOTE: Enter ‘c’ at the ipdb&gt; prompt to start your script.</p>
<p>&lt;module&gt;()</p>
<p>ipdb&gt; s</p>
<p>&lt;module&gt;()</p>
<p>1⋯⋯1 def works_fine():</p>
<p>2 a&#x3D;523b&#x3D;6</p>
<p>在此之后，该文件接下来的执行方式就全凭你一句话了。比如说，在上面那个异常中，我们可以在调用works_fine方法的地方设置一个断点，然后输入c（或continue）使脚本一直运行下去直到该断点时为止：</p>
<p>ipdb&gt; b 12</p>
<p>ipdb&gt; c</p>
<p>calling_things()</p>
<p>11 def calling_things():</p>
<p>2–&gt; 12 works_fine()</p>
<p>13 throws_an_exception()</p>
<p>这时可以单步进入works_fine()或执行works_fine()行<strong>译注16</strong>）：</p>
<p>ipdb&gt; n</p>
<p>calling_things()</p>
<p><strong>译注15</strong>：第一，s不一定行，看提示，要用c；第二，这个s实际上是step into。</p>
<p><strong>译注16</strong>：也就是step over。</p>
<p>2 12 works_fine()</p>
<p>—&gt;13 throws_an_exception()</p>
<p>14</p>
<p>然后，我们单步进入throws_an_exception并前进到发生错误的那一行，查看在此范围内的变量。注意，调试器命令的优先级高于变量名。这时在变量前面加上感叹号（！）即可查看其内容。</p>
<p>ipdb&gt; s</p>
<p>–ca11⋯</p>
<p>5throws_an_exception()</p>
<p>-&gt; 6def:throwsanexception():7</p>
<p>ipdb&gt; n</p>
<p>6 def throws_an_exception():throws_an_exception()</p>
<p>⋯⋯7 $a &#x3D; 5 \ b &#x3D; $8</p>
<p>ipdb&gt; n</p>
<p>throws_an_exception()</p>
<p>7 a&#x3D;5</p>
<p>8 b&#x3D;6</p>
<p>9 arccosert(a++b&#x3D;10)</p>
<p>ipdb&gt; n</p>
<p>throws_an_exception()</p>
<p>8 b&#x3D;6</p>
<p>9 assert(a+b&#x3D;10)</p>
<p>10</p>
<p>ipdb&gt; !a</p>
<!-- 华章图书  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/69acbb1573c2c5b2.jpg"></p>
<p>5</p>
<p>ipdb&gt; !b</p>
<p>6</p>
<p>要想精通这个交互式调试器，必须经过大量的实践才行。表3-4列出了该调试器的全部命令。如果你习惯了使用某款IDE，刚开始用这种终端型调试器的时候可能会觉得有点麻烦，但慢慢就会习惯了。虽然大部分Python IDE都拥有优秀的GUI调试器，但是在IPython中调试程序却往往会带来更高的生产率。</p>
<p>表3-4：（I）Python调试器命令</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>h(elp)</td>
<td>显示命令列表</td>
</tr>
<tr>
<td>help command</td>
<td>显示command的文档</td>
</tr>
<tr>
<td>c(ontinue)</td>
<td>恢复程序的执行</td>
</tr>
</tbody></table>
<p>表3-4：（1）Python调试器命令（续）</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>q(uit)</td>
<td>退出调试器，不再执行任何代码</td>
</tr>
<tr>
<td>b(reak)number</td>
<td>在当前文件的第number行设置一个断点</td>
</tr>
<tr>
<td>b path&#x2F;to&#x2F;file.py:number</td>
<td>在指定文件的第number行设置一个断点</td>
</tr>
<tr>
<td>s(tep)</td>
<td>单步进入函数调用</td>
</tr>
<tr>
<td>n(ext)</td>
<td>执行当前行，并前进到当前级别的下一行</td>
</tr>
<tr>
<td>u(p)&#x2F;d(own)</td>
<td>在函数调用栈中向上或向下移动</td>
</tr>
<tr>
<td>a(rgs)</td>
<td>显示当前函数的参数</td>
</tr>
<tr>
<td>debug statement</td>
<td>在新的（递归）调试器中调用语句statement</td>
</tr>
<tr>
<td>I(ist) statementw(here)</td>
<td>显示当前行，以及当前栈级别上的上下文参考代码</td>
</tr>
<tr>
<td>I(ist) statementw(here)</td>
<td>打印当前位置的完整栈跟踪（包括上下文参考代码）</td>
</tr>
</tbody></table>
<h2 id="调试器的其他使用场景"><a href="#调试器的其他使用场景" class="headerlink" title="调试器的其他使用场景"></a>调试器的其他使用场景</h2><p>除上面提到的之外，还有另外几种调用调试器的手段。第一，使用set_trace这个特别的函数（以pdb.set_trace命名），这差不多可以算作一种“穷人的断点<strong>译注17</strong>”。下面这两个方法可能会在你的日常工作中派上用场（你也可以像我一样直接将其添加到IPython配置中）：</p>
<p>def set_trace():</p>
<p>from IPython.core.debugger import Pdb</p>
<p>.set_trace(sys._getframe()</p>
<p>def debug(f, *args, **kwargs):</p>
<p>from IPython.core.debugger import Pdb</p>
<p>pdb &#x3D; Pdb(color_scheme&#x3D;’Linux’)</p>
<p>return pdb.runcall(f, *args,**kwargs)</p>
<p>第一个函数（set_trace）非常简单。你可以将其放在代码中任何希望停下来查看一番的地方（比如发生异常的地方）：</p>
<p>In [7]:run cho3&#x2F;ipython_bug.py</p>
<p>calling_things()</p>
<p>15 set_trace()</p>
<p>⋯⋯16throws_an_exception()</p>
<p>17</p>
<p>按下c（或continue）仍然会使代码恢复执行，不受任何影响。</p>
<p><strong>译注17</strong>：作者在这里的意思是这种断点比较随便，是硬编码的。</p>
<p>另外那个debug函数使你能够直接在任意函数上使用调试器。假设我们写了如下函数：</p>
<p>detf(x,y,z&#x3D;1)</p>
<p>tanp&#x3D;x+y</p>
<p>return tmp&#x2F;z</p>
<p>现在想对其进行单步调试。f的正常使用方式应该类似于f（1，2, z&#x3D;3)这个样子。为了能够单步进入f，将f作为第一个参数传给debug，后面按顺序再跟上各个需要传给f的关键字参数：</p>
<p>In[6]:debug(f,1,2,z&#x3D;3)</p>
<p>f()</p>
<p>1detf(x,y,z):</p>
<p>⋯⋯3 return tmp&#x2F;z 2 tanp&#x3D;x+y</p>
<p>ipdb&gt;</p>
<p>我发现这两个函数虽然简单，但是在日常工作当中却节省了我不少的时间。</p>
<p>此外，这个调试器还可以结合％run使用。通过％run-d执行脚本，你将会直接进入调试器，然后可以设置一些断点并启动脚本：</p>
<p>In [1]: %run -d ch03&#x2F;ipython_bug.py</p>
<p>Breakpoint 1 at &#x2F;home&#x2F;wesm&#x2F;book_scripts&#x2F;ch03&#x2F;ipython_bug.py:1</p>
<p>NOTE: Enter ‘c’ at the ipdb&gt; prompt to start your script.</p>
<p>&lt;module&gt;()</p>
<p>ipdb&gt; HZ BOOKS</p>
<p>如果再加上-b和一个行号，则调试器在启动时就会自动设置一个断点：</p>
<p>In [2]: %run -d -b2 ch03&#x2F;ipython_bug.py</p>
<p>Breakpoint 1 at &#x2F;home&#x2F;wesm&#x2F;book_scripts&#x2F;ch03&#x2F;ipython_bug.py:2</p>
<p>NOTE: Enter ‘c’ at the ipdb&gt; prompt to start your script.</p>
<p>&lt;module&gt;()</p>
<p>ipdb&gt; c</p>
<p>works_fine()</p>
<p>1 def works_fine():</p>
<p>1⋯⋯( $a &#x3D; 5 \ b &#x3D; 6$</p>
<p>ipdb&gt;</p>
<h2 id="测试代码的执行时间：％time和％timeit"><a href="#测试代码的执行时间：％time和％timeit" class="headerlink" title="测试代码的执行时间：％time和％timeit"></a>测试代码的执行时间：％time和％timeit</h2><p>对于规模更大、运行时间更长的数据分析应用程序，你可能会希望测试一下各个部分或函数调用或语句的执行时间。你可能会希望了解某个复杂计算过程中到底是哪些函数占</p>
<p>用的时间最多。幸运的是，在开发和测试代码的过程中，IPython能够让你轻松得到这些信息。使用内置的time模块及其time.clock和time.time函数手工测试代码执行时间是一件令人烦闷的事情，因为你必须编写许多一模一样的了无生趣的公式化代码：</p>
<p>import time</p>
<p>stan&#x3D;ime.∈e()</p>
<p>for i in range(iterations):</p>
<p>＃这里放一些待执行的代码</p>
<p>$e l a p s e d _ { - } p e r &#x3D; ( t i m e . t i m e ( ) - s t a r t )$&#x2F;iterations</p>
<p>由于这是一个非常常用的功能，所以IPython专门提供了两个魔术函数（％time和％timeit）以便自动完成该过程。％time一次执行一条语句，然后报告总体执行时间。假设我们有一大堆字符串，希望对几个“能够选出具有特殊前缀的字符串”的函数进行比较。下面是一个拥有60万字符串的数组，以及两个不同的“能够选出其中以foo开头的字符串”的方法：</p>
<p>＃一个非常大的字符串数组</p>
<p>$s t r \in g s &#x3D; [ ^ { * } f o o ^ { \prime } ,$ $^ { \prime } f o o b a r ^ { \prime } ,$,$b a z ^ { \prime } $’qux’, ‘python’, ‘Guido Van Rossum’]*100000</p>
<p>method1&#x3D;[xforξnstrings if x.startswith(‘foo’)]</p>
<p>method2&#x3D;[xfoxξnstrings if$x [ : 3 ] &#x3D; &#x3D; \cdot f 0 0 ^ { \prime } ]$</p>
<p>看上去它们的性能表现应该差不多，对吧？我们通过％time来确认一下：</p>
<p>In [561]: %time method1 &#x3D; [x for x in strings if x.startswith(‘foo’)]</p>
<p>CPU times: user 0.19 s, sys: 0.00 s, total: 0.19 s</p>
<p>Wall time:0.19 s</p>
<p>In [562]: %time method2 &#x3D; [x for x in strings if×[3]$^ { \prime } f o o ^ { \prime } ]$</p>
<p>CPU times: user 0.09 s, sys: 0.00 s, total: 0.09 s</p>
<p>Wall time: 0.09 s</p>
<p>墙上时间（wall time）是我们最感兴趣的数字。所以，看上去第一个方法耗费了两倍以上的时间，但这并不是一个非常精确的结果。如果你对相同语句多次执行％time的话，就会发现其结果是会变的。为了得到更为精确的结果，需要使用魔术函数％timeit。对于任意语句，它会自动多次执行以产生一个非常精确的平均执行时间。</p>
<p>In [563]:%timeit[x for x in strings if x.startswith(‘foo’)]</p>
<p>10 loops, best of 3: 159 ms per loop</p>
<p>In [564]:%timeit[x for x in stringsif$\times [ : 3 ] &#x3D; &#x3D; ^ { \prime } f 0 0 ^ { \prime } ]$</p>
<p>10 loops, best of 3: 59.3 ms per loop</p>
<p>这个貌似平淡无奇的例子正好说明了一个事实：我们非常有必要了解Python标准库、NumPy、pandas以及本书中所用到的其他库的性能特点。在大型数据分析应用程序中，这些不起眼的毫秒数是会不断累积的！</p>
<p>对于那些执行时间非常短（甚至是那些微秒（1e-6秒）或纳秒（1e-9秒）级的）的分析语句和函数而言，％timeit是非常有用的。虽然这些时间值小到几乎可以忽略不计，但同样执行100万次一个20微秒的函数，所用的时间要比一个5微秒的多15秒。在上面那个例子中，我们可以直接对那两个字符串运算进行比较以了解其性能特点：</p>
<p>In[565]:$x &#x3D; ^ { \prime } f o o b a r ^ { \prime }$</p>
<p>In [566]:$y &#x3D; f o o ^ { \prime }$</p>
<p>In [567]: %timeit x.startswith(y)</p>
<p>1000000 loops, best of 3: 267 ns per loop</p>
<p>In [568]:%timeit×[:3]&#x3D;&#x3D;y</p>
<p>10000000 loops, best of 3: 147 ns per loop</p>
<h1 id="基本性能分析：％prun和％run-p"><a href="#基本性能分析：％prun和％run-p" class="headerlink" title="基本性能分析：％prun和％run-p"></a>基本性能分析：％prun和％run-p</h1><p>代码的性能分析跟代码执行时间密切相关，只不过它关注的是耗费时间的位置。主要的Python性能分析工具是cProfile模块，它不是专为IPython设计的。cProfile在执行一个程序或代码块时，会记录各函数所耗费的时间。</p>
<p>cProfile一般是在命令行上使用的，它将执行整个程序然后输出各函数的执行时间。假设我们有一个简单的脚本：在一个循环中执行一些线性代数计算（计算一个100×100的矩阵的最大本征值绝对值）。</p>
<p>import numpy as np</p>
<p>from numpy.linalg import eigvals</p>
<p>def run_experiment(niter&#x3D;100):华章图书K&#x3D;100</p>
<p>xesults&#x3D;[]</p>
<p>for_in xrange(niter):</p>
<p>mat &#x3D;np.random.randn(K,K)</p>
<p>.max()</p>
<p>results.append(max_eigenvalue)</p>
<p>return results</p>
<p>some_results &#x3D; run_experiment()</p>
<p>print ‘Largest one we saw:%s’% np.max(some_results)</p>
<p>如果你还不懂NumPy，暂时先别管，后面会讲的。在命令行中输入下列命令即可通过cProfile启动该脚本：</p>
<p>python -m cProfile cprof_example.py</p>
<p>执行之后，你会发现输出结果是按函数名排序的。这让我们很难发现哪里才是最花时间的地方，因此通常都会再用-s标记指定一个排序规则：</p>
<p>&#36; python -m cProfile -s cumulative cprof_example.py</p>
<p>Largest one we saw: 11.923204422</p>
<p>15116 function calls (14927 primitive calls) in 0.720 seconds</p>
<p>Ordered by: cumulative time</p>
<table>
<thead>
<tr>
<th>ncal</th>
<th>ls tot</th>
<th>time</th>
<th>percall</th>
<th>cumtim</th>
<th>e percall filename:lineno(functio</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>0.001</td>
<td>0.001</td>
<td>0.721</td>
<td>0.721</td>
<td>cprof_example.py:1(&lt;module&gt;)</td>
</tr>
<tr>
<td>100</td>
<td>0.003</td>
<td>0.000</td>
<td>0.586</td>
<td>0.006</td>
<td>linalg.py:702(eigvals)</td>
</tr>
<tr>
<td>200</td>
<td>0.572</td>
<td>0.003</td>
<td>0.572</td>
<td>0.003{numpy.linalg.lapack_lite.dgeev}</td>
<td>0.003{numpy.linalg.lapack_lite.dgeev}</td>
</tr>
<tr>
<td>1</td>
<td>0.002</td>
<td>0.002</td>
<td>0.075</td>
<td>0.075</td>
<td>init_.py:106(&lt;module&gt;)</td>
</tr>
<tr>
<td>100</td>
<td>0.059</td>
<td>0.001</td>
<td>0.059</td>
<td>0.001 {method ‘randn’)</td>
<td>0.001 {method ‘randn’)</td>
</tr>
<tr>
<td>1</td>
<td>0.000</td>
<td>0.000</td>
<td>0.044</td>
<td>0.044</td>
<td>add_newdocs.py:9(&lt;module&gt;)</td>
</tr>
<tr>
<td>2</td>
<td>0.001</td>
<td>0.001</td>
<td>0.037</td>
<td>0.019</td>
<td>init_.py:1(&lt;module&gt;)</td>
</tr>
<tr>
<td>2</td>
<td>0.003</td>
<td>0.002</td>
<td>0.030</td>
<td>0.015</td>
<td>init_.py:2(&lt;module&gt;)</td>
</tr>
<tr>
<td>1</td>
<td>0.000</td>
<td>0.000</td>
<td>0.030</td>
<td>0.030</td>
<td>type_check.py:3(&lt;module&gt;)</td>
</tr>
<tr>
<td>1</td>
<td>0.001</td>
<td>0.001</td>
<td>0.021</td>
<td>0.021</td>
<td>init_.py:15(&lt;module&gt;)</td>
</tr>
<tr>
<td>1</td>
<td>0.013</td>
<td>0.013</td>
<td>0.013</td>
<td>0.013 numeric.py:1(&lt;module&gt;)</td>
<td>0.013 numeric.py:1(&lt;module&gt;)</td>
</tr>
<tr>
<td>1</td>
<td>0.000</td>
<td>0.000</td>
<td>0.009</td>
<td>0.009</td>
<td>init_·py:6(&lt;module&gt;)</td>
</tr>
<tr>
<td>1</td>
<td>0.001</td>
<td>0.001</td>
<td>0.008</td>
<td>0.008</td>
<td>init_·py:45(&lt;module&gt;)</td>
</tr>
<tr>
<td>262</td>
<td>0.005</td>
<td>0.000</td>
<td>0.007</td>
<td>0.000</td>
<td>function_base.py:3178(add_newdoc)</td>
</tr>
<tr>
<td>100</td>
<td>0.003</td>
<td>0.000</td>
<td>0.005</td>
<td>0.000</td>
<td>linalg.py:162(_assertFinite)</td>
</tr>
</tbody></table>
<p>··.</p>
<p>这里只给出了输出结果中的前15行。只需查看cumtime列即可发现各函数所耗费的总时间。注意，如果一个函数调用了别的函数，计时器是不会停下来重新计时的。cProfile 记录的是各函数调用的起始和结束时间，并依此计算总时间。</p>
<p>除命令行用法之外，cProfile还可以编程的方式分析任意代码块的性能。IPython为此提供了一个方便的接口，即％prun命令和带-p选项的％run。％prun的格式跟cProfile差不多，但它分析的是Python语句而不是整个.py文件：</p>
<p>In[4]:: %prun -1 7 -s cumulative run_experiment()</p>
<p>4203 function calls in 0.643 seconds</p>
<p>Ordered by: cumulative time</p>
<p>List reduced from 32 to 7 due to restriction &lt;7&gt;</p>
<table>
<thead>
<tr>
<th>ncalls</th>
<th>tottime</th>
<th>percall</th>
<th>cumtime</th>
<th>percall filename:lineno(function)</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>0.000</td>
<td>0.000</td>
<td>0.643</td>
<td>0.643 &lt;string&gt;:1(&lt;module&gt;)</td>
</tr>
<tr>
<td>1</td>
<td>0.001</td>
<td>0.001</td>
<td>0.643</td>
<td>0.643 cprof_example.py:4(run_experiment)</td>
</tr>
<tr>
<td>100</td>
<td>0.003</td>
<td>0.000</td>
<td>0.583</td>
<td>0.006 linalg.py:702(eigvals)</td>
</tr>
<tr>
<td>200</td>
<td>0.569</td>
<td>0.003</td>
<td>0.569</td>
<td>0.003 {numpy.linalg.lapack_lite.dgeev}</td>
</tr>
<tr>
<td>100</td>
<td>0.058</td>
<td>0.001</td>
<td>0.058</td>
<td>0.001{method ‘randn’}</td>
</tr>
<tr>
<td>100</td>
<td>0.003</td>
<td>0.000</td>
<td>0.005</td>
<td>0.000 linalg.py:162(_assertFinite)</td>
</tr>
<tr>
<td>200</td>
<td>0.002</td>
<td>0.000</td>
<td>0.002</td>
<td>0.000 {method ‘all’ of ‘numpy.ndarray’ objects}</td>
</tr>
</tbody></table>
<p>执行％run -p-Scumulative cprof_example.py也能达到上面那条系统命令行命令一样的效果，但是却无需退出IPython。</p>
<h2 id="逐行分析函数性能"><a href="#逐行分析函数性能" class="headerlink" title="逐行分析函数性能"></a>逐行分析函数性能</h2><p>有些时候，从％prun（或其他基于cProfile的性能分析手段）得到的信息要么不足以说明函数的执行时间，要么就复杂到难以理解（按函数名聚合）。对于这种情况，我们可以使用一个叫做line_profiler的小型库（可以通过PyPI或随便一种包管理工具获取）。其中有一个新的魔术函数％1prun，它可以对一个或多个函数进行逐行性能分析。你可以修改IPython配置（参考IPython文件或本章稍后关于配置的内容）以启用这个扩展，代码如下所示：</p>
<h1 id="A-list-of-dotted-module-names-of-IPython-extensions-to-load"><a href="#A-list-of-dotted-module-names-of-IPython-extensions-to-load" class="headerlink" title="A list of dotted module names of IPython extensions to load."></a>A list of dotted module names of IPython extensions to load.</h1><p>c.TerminalIPythonApp.extensions &#x3D; [‘line_profiler’]</p>
<p>line_profiler可以通过编程的方式使用（请参阅完整文档），但其最强大的一面却是在IPython中的交互式使用。假设你有一个prof_mod模块，其中有一些用于NumPy数组计算的代码，如下所示：</p>
<p>from numpy.random import randn</p>
<p>def add_and_sum(x,y):</p>
<p>added&#x3D;x+</p>
<p>Summed&#x3D;added.5um(a×i5&#x3D;1)</p>
<p>return summed</p>
<p>def call_function():</p>
<p>x&#x3D;randn(1000,1000)</p>
<p>y&#x3D;xandn(1000,1000)</p>
<p>return$a d d \underline { a } a n d \underline { s u m ( x ,$y)</p>
<p>如果我们想了解add_and_sum函数的性能，％prun会给出如下所示的结果：</p>
<p>In [569]: %run prof_mod</p>
<p>In [570]:x&#x3D;randn(3000,3000)</p>
<p>In[571]y&#x3D;xandn(3000,3000)</p>
<p>In [572]: %prun add_and_sum(x,y)</p>
<p>4 function calls in 0.049 seconds</p>
<p>Ordered by: internal time</p>
<p>ncalls tottime percall cumtime percall filename:lineno(function)</p>
<p>1 0.036 0.036 0.046 0.046 prof_mod.py:3(add_and_sum)</p>
<p>1 0.009 0.009 0.009 0.009 {method ‘sum’ of ‘numpy.ndarray’ objects}</p>
<p>1 0.003 0.003 0.049 0.049 &lt;string&gt;:1(&lt;module&gt;)</p>
<p>1 0.000 0.000 0.000 0.000{method ‘disable’ of ‘_lsprof.Profiler’ objects}</p>
<p>这个结果并不能说明什么问题。启用line_profiler这个IPython扩展之后，就会出现一个新的魔术命令％1prun。用法上唯一的区别就是：必须为％1prun指明想要测试哪个或哪些函数。％lprun的通用语法为：</p>
<p>%1prun -f func1 -f func2 statement_to_profile</p>
<p>在本例中，我们想要测试的是add_and_sum，于是执行：</p>
<p>In [573]:%1prun-f$a d d \underline a n d \underline { s u m }$ $a d d \underline { a n d } \sin ( x , y )$</p>
<p>Timer unit:1e-06 s</p>
<p>File:book_scripts&#x2F;prof_mod.py</p>
<p>Function: add_and_sum at line 3</p>
<p>Total time: 0.045936 s</p>
<p>Line # Hits Time Per Hit % Time Line Contents</p>
<table>
<thead>
<tr>
<th>3</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th>def$a d d a n d \sum S u m ( x , y ) :$$a d d e d &#x3D; x + y$</th>
</tr>
</thead>
<tbody><tr>
<td>4</td>
<td>1</td>
<td>36510</td>
<td>36510.0</td>
<td>79.5</td>
<td>$S u m m e d &#x3D; a d d e d . 5 u m ( a \times i s &#x3D; 1 )$</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>9425</td>
<td>9425.0</td>
<td>20.5</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>1</td>
<td>1</td>
<td>1.0</td>
<td>0.0</td>
<td>return summed</td>
</tr>
</tbody></table>
<p>这个结果就容易理解多了。这里我们测试的只是add_and_sum这一个函数。上面那个模块中还有一个call_function函数，我们可以结合add_and_sum一起测试，于是最终的测试命令就成了下面这个样子：</p>
<p>In[574]:%1prun -f add_and_sum -f call_function call_function()</p>
<p>Timer unit:1e-06 s</p>
<p>File:book_scripts&#x2F;prof_mod.py</p>
<p>Function:$a d d \underline { } a n d \underline { s }$um at line 3</p>
<p>Total time: 0.005526 s</p>
<p>Line # Hits Time Per Hit % Time Line Contents</p>
<p>3 def add_and_sum(x, y):</p>
<p>4 1 4375 4375.0 79.2 added&#x3D;x+</p>
<p>5 1 1149 1149.0 20.8 Summed&#x3D;added.5um(a×is&#x3D;1)</p>
<p>6 1 2 2.0 0.0 return summed</p>
<p>File: book_scripts&#x2F;prof_mod.py</p>
<p>Function: call_function at line 8</p>
<p>Total time: 0.121016 s</p>
<p>Line # Hits Time Per Hit% Time Line Contents</p>
<p>8 def cal1_function():</p>
<p>9 1 57169 57169.0 47.2 x &#x3D; randn(1000,1000)</p>
<p>10 1 58304 58304.0 48.2 y&#x3D;xandn(1000,1000)</p>
<p>11 1 5543 5543.0 4.6 return$a d d \underline { a n d } s u m ( x ,$y)</p>
<p>通常，我会用％prun（cProfile）做“宏观的”性能分析，而用％Iprun （line_profiler）做“微观的”性能分析。这两个工具都很有必要了解一下。</p>
<p>注意：在使用％1prun时，之所以必须显式指明待测试的函数名，是因为“跟踪”每一行代码的执行时间所需的开销很大。对不感兴趣的函数进行跟踪将会对性能分析结果造成显著的影响。</p>
<h1 id="IPython-HTML-Notebook"><a href="#IPython-HTML-Notebook" class="headerlink" title="IPython HTML Notebook"></a>IPython HTML Notebook</h1><p>2011年，由Brian Granger领导的IPython团队开始开发一种基于Web技术的交互式计算文</p>
<p>档格式，即IPython Notebook（见图3-4）。目前，它已经成为一种非常棒的交互式计算工具，同时还是科研和教学的一种理想媒介。本书中大部分示例都是用它编写的.我强烈建议你也试试。</p>
<table>
<thead>
<tr>
<th></th>
<th>127.0.0.1:8888&#x2F;5a085d6e-d135-447b-869d-a4848ec3f771</th>
<th>127.0.0.1:8888&#x2F;5a085d6e-d135-447b-869d-a4848ec3f771</th>
</tr>
</thead>
<tbody><tr>
<td>IP[y]:N</td>
<td>otebook NotebookEx Last saved: Jul 26 1:06 PM</td>
<td>otebook NotebookEx Last saved: Jul 26 1:06 PM</td>
</tr>
<tr>
<td>File Edit View Insert Cell Kernel Help8 x * Code</td>
<td>File Edit View Insert Cell Kernel Help8 x * Code</td>
<td>File Edit View Insert Cell Kernel Help8 x * Code</td>
</tr>
<tr>
<td>In[1]:</td>
<td>import numpy as npimport pandas as pdprint ‘Hello world!’Hello world!</td>
<td></td>
</tr>
<tr>
<td>In [2]: tips&#x3D;pd.read_csv(‘book_scripts&#x2F;ch08&#x2F;tips.csv’)tips.head()out[2]:total_billtip sex smokerdaytime size016.99 1.01FemaleNo SunDinner2110.34 1.66Male No SunDinner3221.01 3.50Male No SunDinner3323.68 3.31Male No SunDinner2424.59 3.61FemaleNo SunDinner4In [4]: img&#x3D;plt.imread(‘book_scripts&#x2F;ch03&#x2F;stinkbug.png’)figure(figsize&#x3D;(4,4))</td>
<td>plt.imshow(img)out[4]:&lt;matplotlib.image.AxesImage at 0x7f465d34a510&gt;0501001502002503003500 100 200 300 400</td>
<td>In [2]: tips&#x3D;pd.read_csv(‘book_scripts&#x2F;ch08&#x2F;tips.csv’)tips.head()out[2]:total_billtip sex smokerdaytime size016.99 1.01FemaleNo SunDinner2110.34 1.66Male No SunDinner3221.01 3.50Male No SunDinner3323.68 3.31Male No SunDinner2424.59 3.61FemaleNo SunDinner4In [4]: img&#x3D;plt.imread(‘book_scripts&#x2F;ch03&#x2F;stinkbug.png’)figure(figsize&#x3D;(4,4))</td>
</tr>
</tbody></table>
<p>图3-4：IPython Notebook</p>
<p>它有一种基于JSON的文档格式.ipynb，使你可以轻松分享代码、输出结果以及图片等内容。目前在各种Python研讨会上，一种流行的演示手段就是使用IPython Notebook，然后再将.ipynb文件发布到网上以供所有人查阅。</p>
<p>IPython Notebook应用程序是一个运行于命令行上的轻量级服务器进程。执行下面这条命令即可启动：</p>
<p>&#36; ipython notebook –pylab&#x3D;inline</p>
<p>[NotebookApp] Using existing profile dir: u’&#x2F;home&#x2F;wesm&#x2F;.config&#x2F;ipython&#x2F;profile_default’[NotebookApp] Serving notebooks from&#x2F;home&#x2F;wesm&#x2F;book_scripts</p>
<p>[NotebookApp] The IPython Notebook is running at: <a target="_blank" rel="noopener" href="http://127.0.0.1:8888/">http://127.0.0.1:8888/</a></p>
<p>[NotebookApp] Use Control-C to stop this server and shut down all kernels.</p>
<p>在大多数平台上，你的首选Web浏览器会自动打开Notebook的仪表板（dashboard）。有时你可能需要手工打开上面列出的那个URL。你可以在这里创建一个新的记事本并开始研究工作。</p>
<p>由于我们是在一个Web浏览器中使用Notebook的，因此该服务器进程可以运行于任何地方。你甚至可以连接到那些运行在云服务（如Amazon EC2）上的Notebook。直到写作本书时为止，一个新的名为NotebookCloud（http：／／notebookcloud.appspot.com）的项目已经诞生了，它可以轻松地在Amazon EC2上启动记事本。</p>
<h1 id="利用IPython提高代码开发效率的几点提示"><a href="#利用IPython提高代码开发效率的几点提示" class="headerlink" title="利用IPython提高代码开发效率的几点提示"></a>利用IPython提高代码开发效率的几点提示</h1><p>为了在IPython中开发、调试代码，并充分发挥其交互优势，许多用户都需要转换一下工作模式。像编码风格以及一些操作细节可能需要做一些调整。</p>
<p>就这点来说，本节的内容更像是艺术而非科学，你需要有一些编程经验才好判断其能否提高你的工作效率。总之，你得让你的代码结构更易于交互且结果更易于查看。我发现通过IPython设计的软件要比独立的命令行应用程序好用。当你执行自己或别人在几个月甚至几年前编写的代码时出现了错误，想找出问题所在时，IPython的交互性就会变得非常重要。</p>
<p>华章图书</p>
<h2 id="重新加载模块依赖项"><a href="#重新加载模块依赖项" class="headerlink" title="重新加载模块依赖项"></a>重新加载模块依赖项</h2><p>在Python中，当你输入import some_lib时，some_lib中的代码就会被执行，且其中所有的变量、函数和引入项都会被保存在一个新建的some_lib模块命名空间中。下次你再输入import some_lib时，就会得到这个模块命名空间的一个引用。而这对于IPython的交互式代码开发模式就会有一个问题，比如说，用％run执行的某段脚本中牵扯到了某个刚刚做了修改的模块。假设我们有一个test_script.py文件，其中有下列代码：</p>
<p>import some_lib</p>
<p>x&#x3D;5</p>
<p>y&#x3D;[1,2,3,4]</p>
<p>result&#x3D;somelib⋅getanswer(x,y)</p>
<p>如果在执行了％run test_script.py之后又对some_lib.py进行了修改，下次再执行％run</p>
<p>test_script.py时将仍然会使用老版的some_lib。其原因就是Python的“一次加载”模块系统。这个行为不同于其他一些数据分析环境（如MATLAB，它会自动应用代码修改注1）。为了解决这个问题，你有两个办法可用。第一个办法是使用Python内置的reload 函数。将test_script.py修改成下面这个样子：</p>
<p>import som$1 e _ { - } 1 i b$</p>
<p>reload(some_lib)</p>
<p>x&#x3D;5</p>
<p>y&#x3D;[1,2,3,4]</p>
<p>$r e s u l t &#x3D; 5 0 m e _ { - } 1 i b . g e t a n s w e r ( x , y )$</p>
<p>这样就保证每次执行test_script.py时都能用上最新版的some_lib了。显然，当依赖变得更强时，就需要在很多地方插入很多的reload。对于这个问题，IPython提供了一个特殊的dreload函数（非魔术函数）来解决模块的“深度”（递归）重加载。如果执行import some_lib之后再输入dreload（some_lib），则它会尝试重新加载some_lib及其所有的依赖项。遗憾的是，这个办法也不是万灵丹，但是如果真的不行了，重启IPython就行了。</p>
<h2 id="代码设计提示"><a href="#代码设计提示" class="headerlink" title="代码设计提示"></a>代码设计提示</h2><p>这个问题不太好讲，但我在日常工作中确实发现了一些高层次的原则。</p>
<h2 id="保留有意义的对象和数据"><a href="#保留有意义的对象和数据" class="headerlink" title="保留有意义的对象和数据"></a>保留有意义的对象和数据</h2><p>人们一般不会在命令行上编写下面这样的程序：</p>
<p>from my_functions import g 华章图书</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/fb835804fadba6c8.jpg"></p>
<p>deff(x,y)</p>
<p>returng(x+y)</p>
<p>def main():</p>
<p>x&#x3D;6</p>
<p>y&#x3D;7.5</p>
<p>resuIt&#x3D;x+y</p>
<p>$f \frac { n a m e } { \min ( ) } &#x3D; \underline { } \min \underline { \min } :$x</p>
<p>如果我们在IPython中执行这段代码的话会出现什么问题？我们在IPython shell中将访问不到任何结果以及main函数中定义的对象。好点的办法是直接在该模块的全局命名空</p>
<p>注1： 由于一个模块或包可能会在一个程序中的不同位置多次引入，所以Python会在第一次引入这些模块时对其进行缓存，而不是每次都执行模块中的代码。否则，应用程序的模块化和良好的代码组织等手段就达不到高效的目的了。</p>
<p>间中执行main中的代码（如果你希望该模块是可引入的，也可以将这些代码放在if name$\underline &#x3D; \underline { } \min \underline { }$：块中）。这样，当你％run这段代码时，就能看到main中定义的所有变量了。对这个简单的例子而言，这个原则意义不大，但对本书后面将要介绍的那些针对大数据集的复杂数据分析问题而言就很重要了。</p>
<h2 id="扁平结构要比嵌套结构好"><a href="#扁平结构要比嵌套结构好" class="headerlink" title="扁平结构要比嵌套结构好"></a>扁平结构要比嵌套结构好</h2><p>深度嵌套的代码让我想到了洋葱。在测试或调试函数时，你要把这个洋葱剥多少层才能找到感兴趣的代码？“扁平结构要比嵌套结构好”的思想来自“Zen of Python”<strong>译注18</strong>，它对交互式的代码开发模式同样有效。编写函数和类时应尽量注意低耦合和模块化，这样可以使它们更易于测试（如果你编写单元测试的话）、调试和交互式使用。</p>
<h1 id="无惧大文件"><a href="#无惧大文件" class="headerlink" title="无惧大文件"></a>无惧大文件</h1><p>如果曾经学过Java（或其他类似的语言），可能会有人告诉你要“尽量保持文件的小型化”。在许多语言中，这都是一个不错的建议。长度太长通常是一种不好的“臭代码”，意味着需要重构或重组。然而在IPython中开发代码时，处理10个小的（但互相关联的）文件（比如都低于100行）可能会让你更为头疼，还不如直接一个大文件或两三个大点的文件来得痛快。更少的文件意味着需要重新加载的模块更少，编辑时需要在各个文件之间的跳转次数也更少。我发现维护更大的（具有高内聚度的）模块会更实用也更具有Python特点。在解决完问题之后，有时将大文件拆分成小文件会更好。</p>
<p>显然，我并不建议将此原则极端化，那可能会让你将所有代码都放到一个巨大的文件里面。对一个大型代码库而言，要找到一种合乎逻辑的模块／包架构需要花点工夫，但这对团队工作非常重要。每个模块都应该具有足够高的内聚度，而且要能足够直观地找到对应各种功能的函数和类。</p>
<h2 id="高级IPython功能"><a href="#高级IPython功能" class="headerlink" title="高级IPython功能"></a>高级IPython功能</h2><h1 id="让你的类对IPython更加友好"><a href="#让你的类对IPython更加友好" class="headerlink" title="让你的类对IPython更加友好"></a>让你的类对IPython更加友好</h1><p>IPython力求为各种对象呈现一个友好的字符串表示。对于许多对象（如字典、列表和元组等），内置的pprint模块就能给出漂亮的格式。但是对于你自己定义的那些类，就必须自己生成所需的字符串输出。假设我们有下面这个简单的类：</p>
<p>class Message:</p>
<p>def ∈it(elf,msg):</p>
<p>self.msg&#x3D;msg</p>
<p><strong>译注18</strong>：这是Tim Peters 2004年写的一首“诗”，执行“import this”就能看到。有网民将其翻译成三字经的形式（又名“蛇宗三字经”）。另外，有兴趣的话，可以看看this的源代码。</p>
<p>如果像下面这样写，你就会失望地发现这个类的默认输出形式非常不好看：</p>
<p>In [576]:x&#x3D; Message(‘I have a secret’)</p>
<p>In [577]:x</p>
<p>Out[577]:$&lt; \underline { } m a \in \underline { }$.Message instance at 0x60ebbd8&gt;</p>
<p>由于IPython会获取$x e p r \underline { }$方法返回的字符串（具体办法是output＝repr（obj）），并将其显示到控制台上。因此，我们可以为上面那个类添加一个简单的-repr方法以得到一个更有意义的输出形式：</p>
<p>class Message:</p>
<p>def-∈it(elf,msg):self.msg&#x3D;ms</p>
<p>def $r e p r _ ( s e l f )$</p>
<p>return ‘Message:%s’ % self.msg</p>
<p>In [579]:x &#x3D; Message(‘I have a secret’)</p>
<p>In [580]:x</p>
<p>Out[580]: Message: I have a secret</p>
<h2 id="个性化和配置"><a href="#个性化和配置" class="headerlink" title="个性化和配置"></a>个性化和配置</h2><p>IPython shell在外观（如颜色、提示符、行间距等）和行为方面的大部分内容都是可以进行配置的。下面是能够通过配置做的部分事情：</p>
<p>· 修改颜色方案。 H</p>
<p>. 修改输入输出提示符。</p>
<p>· 去掉Out提示符跟下一个In提示符之间的空行。</p>
<p>· 执行任意Python语句。这些语句可以用于引入所有常用的东西，还可以做一些你希望每次启动IPython都发生的事情。</p>
<p>· 启用IPython扩展，如line_profiler中的魔术命令％1prun。</p>
<p>. 定义你自己的魔术命令或系统别名。</p>
<p>所有这些配置选项都定义在一个叫做ipython_config.py的文件中，可以在～／.config／ipython／目录（UNIX）和％HOME％／.ipython／ 目录（Windows）中找到。具体的主目录取决于你的系统。配置信息是基于特定个性化设置的。一般来说，正常启动IPython将会加载默认的个性化设置（位于profile_default目录中）。因此，在我的Linux系统中，默认IPython配置文件的完整路径是：</p>
<p>&#x2F;home&#x2F;wesm&#x2F;.config&#x2F;ipython&#x2F;profile_default&#x2F;ipython_config.py</p>
<p>这里我就不对该文件的内容作详细介绍了。因为其注释已经说明了各个配置项的功能，各位读者完全可以自己照着做。还有一个很实用的功能是拥有多个个性化设置。假设你想要专门为某个应用程序或项目量身定做一套IPython配置。输入下面这样的命令即可新建一个个性化设置：</p>
<p>ipython profile create secret_project</p>
<p>然后编辑新建的这个profile_secret_project目录中的配置文件，再用下面这种方式启动IPython:</p>
<p>&#36; ipython –profile&#x3D;secret_project</p>
<p>Python 2.7.2 |EPD 7.1-2(64-bit)|(default,Jul 3 2011, 15:17:51)</p>
<p>Type “copyright”, “credits” or “license” for more information.</p>
<p>IPython 0.13 – An enhanced Interactive Python.</p>
<p>? -&gt; Introduction and overview of IPython’s features.</p>
<p>%quickref -&gt; Quick reference.</p>
<p>help-&gt; Python’s own help system.</p>
<p>object? -&gt; Details about ‘object’, use ‘object??’ for extra details.</p>
<p>IPython profile: secret_project</p>
<p>In [1]:</p>
<p>同样，有关个性化和配置方面的详细信息，请参考IPython的在线文档。</p>
<h2 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h2><p>本章的部分内容由IPython Development Team整理。我对他们创建了如此神奇的工具而感激涕零。</p>
<h2 id="利用Python进行数据分析"><a href="#利用Python进行数据分析" class="headerlink" title="利用Python进行数据分析"></a>利用Python进行数据分析</h2><p>还在苦苦寻觅用Python控制、处理、整理、分析结构化数据的完整课程？本书含有大量的实践案例，你将学会如何利用各种Python库（包括NumPy、pandas、matplotlib以及IPython等）高效地解决各式各样的数据分析问题。</p>
<p>由于作者Wes McKinney是pandas库的主要作者，所以本书也可以作为利用Python实现数据密集型应用的科学计算实践指南。本书适合刚刚接触Python的分析人员以及刚刚接触科学计算的Python程序员。</p>
<p>将IPython这个交互式Shell作为你的首要开发环境。</p>
<p>学习NumPy（Numerical Python）的基础和高级知识。</p>
<p>从pandas库的数据分析工具开始。</p>
<p>利用高性能工具对数据进行加载、清理、转换、合并以及重塑。</p>
<p>利用matplotlib创建散点图以及静态或交互式的可视化结果。</p>
<p> 利用pandas的groupby功能对数据集进行切片、切块和汇总操作。</p>
<p>处理各种各样的时间序列数据。</p>
<p>通过详细的案例学习如何解决Web分析、社会科学、金融学以及经济学等领域的问题。</p>
<p>Wes McKinney 资深数据分析专家，对各种Python库（包括NumPy、pandas、matplotlib以及IPython等）都有深入研究，并在大量的实践中积累了丰富的经验。撰写了大量与Python数据分析相关的经典文章，被各大技术社区争相转载，是Python和开源技术社区公认的权威人物之一。开发了用于数据分析的著名开源Python 库-pandas，广获用户好评。在创建Lambda Foundry（一家致力于企业数据分析的公司）之前，他曾是AQR Capital Management 的定量分析师。</p>
<p>“科学计算和数据分析社区已经等待这本书很多年了：大量具体的实践建议，以及大量综合应用方法。本书在未来几年里肯定会成为Python领域中技术计算的权威指南。”</p>
<p>Fernando Pérez</p>
<p>加州大学伯克利分校</p>
<p>研究科学家，</p>
<p>IPython的创始人之一</p>
<p>O’REILLY®</p>
<p>O’Reilly Media，Inc.授权机械工业出版社出版 oreilly.com.cn</p>
<!-- 上架指导：计算机／程序设计 ISBN 978-7-111-43673-7 9787111436737&gt; 定价：89.00元  -->
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://web-api.textin.com/ocr_image/external/fff9a3f1ea0d3672.jpg"></p>
<p>此简体中文版仅限于在中华人民共和国境内（但不允许在中国香港、澳门特别行政区和中国台湾地区）销售发行This Authorized Edition for sale only in the territory of People’s Republic of China (excluding Hong Kong,Macao and Taiwan)</p>
<p>客服热线：（010）88378991 88361066 数字阅读：<a target="_blank" rel="noopener" href="http://www.hzmedia.com.cn/">www.hzmedia.com.cn</a></p>
<p>购书热线：（010）68326294 88379649 68995259 华章网站：<a target="_blank" rel="noopener" href="http://www.hzbook.com/">www.hzbook.com</a></p>
<p>投稿热线：（010）88379604 网上购书：<a target="_blank" rel="noopener" href="http://www.china-pub.com/">www.china-pub.com</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d20f536c64d06e5fcf4bfe2ec5dc25d.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d20f536c64d06e5fcf4bfe2ec5dc25d.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Smith</div><div class="post-copyright__author_desc">人生太短，要干的事太多，我要争分夺秒</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://smithhs.cn/2024/11/13/2024-11-13-%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://smithhs.cn/2024/11/13/2024-11-13-%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/')">利用Python进行数据分析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://smithhs.cn/2024/11/13/2024-11-13-%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=利用Python进行数据分析&amp;url=https://smithhs.cn/2024/11/13/2024-11-13-%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/&amp;pic=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://smithhs.cn" target="_blank">Smith</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Python/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Python<span class="tagsPageCount">4</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/jupyter.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2024/11/06/2024-11-06-Jupyter/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/jupyter.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Jupyter</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/10/22/2021-10-22-python%E5%AD%A6%E4%B9%A0/" title="Python学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/python.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2021-10-22</div><div class="title">Python学习</div></div></a></div><div><a href="/2022/04/20/2022-04-20-python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" title="Python数据分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/dataanalysis.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-04-20</div><div class="title">Python数据分析</div></div></a></div><div><a href="/2022/04/15/2022-04-15-python%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98/" title="Python数据挖掘"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/data%20mining.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-04-15</div><div class="title">Python数据挖掘</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">第一章 准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E4%B9%A6%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9"><span class="toc-number">1.1.</span> <span class="toc-text">本书主要内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">为什么要使用Python进行数据分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%8APython%E5%BD%93%E5%81%9A%E7%B2%98%E5%90%88%E5%89%82"><span class="toc-number">1.2.1.</span> <span class="toc-text">把Python当做粘合剂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E2%80%9C%E4%B8%A4%E7%A7%8D%E8%AF%AD%E8%A8%80%E2%80%9D%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.2.</span> <span class="toc-text">解决“两种语言”问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E9%80%89Python"><span class="toc-number">1.2.3.</span> <span class="toc-text">为什么不选Python</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E7%9A%84Python%E5%BA%93"><span class="toc-number">1.3.</span> <span class="toc-text">重要的Python库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NumPy"><span class="toc-number">1.3.1.</span> <span class="toc-text">NumPy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pandas"><span class="toc-number">1.3.2.</span> <span class="toc-text">pandas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#matplotlib"><span class="toc-number">1.3.3.</span> <span class="toc-text">matplotlib</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPython"><span class="toc-number">1.3.4.</span> <span class="toc-text">IPython</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SciPy"><span class="toc-number">1.3.5.</span> <span class="toc-text">SciPy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.4.</span> <span class="toc-text">安装和设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows"><span class="toc-number">1.4.1.</span> <span class="toc-text">Windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8B%B9%E6%9E%9COSX"><span class="toc-number">1.4.2.</span> <span class="toc-text">苹果OSX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GNU-Linux"><span class="toc-number">1.4.3.</span> <span class="toc-text">GNU&#x2F;Linux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Python-2%E5%92%8CPython-3"><span class="toc-number">1.4.4.</span> <span class="toc-text">Python 2和Python 3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%EF%BC%88IDE%EF%BC%89"><span class="toc-number">1.4.5.</span> <span class="toc-text">集成开发环境（IDE）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BE%E5%8C%BA%E5%92%8C%E7%A0%94%E8%AE%A8%E4%BC%9A"><span class="toc-number">1.5.</span> <span class="toc-text">社区和研讨会</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%9C%AC%E4%B9%A6"><span class="toc-number">1.6.</span> <span class="toc-text">使用本书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text">代码示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">1.6.2.</span> <span class="toc-text">示例数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E6%83%AF%E4%BE%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text">引入惯例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%8C%E8%AF%9D"><span class="toc-number">1.6.4.</span> <span class="toc-text">行话</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC2%E7%AB%A0-%E5%BC%95%E8%A8%80"><span class="toc-number">2.</span> <span class="toc-text">第2章 引言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-number">2.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E8%87%AAbit-ly%E7%9A%841-usa-gov%E6%95%B0%E6%8D%AE"><span class="toc-number">2.2.</span> <span class="toc-text">来自bit.ly的1.usa.gov数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E7%BA%AFPython%E4%BB%A3%E7%A0%81%E5%AF%B9%E6%97%B6%E5%8C%BA%E8%BF%9B%E8%A1%8C%E8%AE%A1%E6%95%B0"><span class="toc-number">2.3.</span> <span class="toc-text">用纯Python代码对时区进行计数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8pandas%E5%AF%B9%E6%97%B6%E5%8C%BA%E8%BF%9B%E8%A1%8C%E8%AE%A1%E6%95%B0"><span class="toc-number">2.4.</span> <span class="toc-text">用pandas对时区进行计数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MovieLens-1M%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-number">2.5.</span> <span class="toc-text">MovieLens 1M数据集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E8%AF%84%E5%88%86%E5%88%86%E6%AD%A7"><span class="toc-number">2.6.</span> <span class="toc-text">计算评分分歧</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1880-2010%E5%B9%B4%E9%97%B4%E5%85%A8%E7%BE%8E%E5%A9%B4%E5%84%BF%E5%A7%93%E5%90%8D"><span class="toc-number">3.</span> <span class="toc-text">1880-2010年间全美婴儿姓名</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%91%BD%E5%90%8D%E8%B6%8B%E5%8A%BF"><span class="toc-number">3.1.</span> <span class="toc-text">分析命名趋势</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%84%E4%BC%B0%E5%91%BD%E5%90%8D%E5%A4%9A%E6%A0%B7%E6%80%A7%E7%9A%84%E5%A2%9E%E9%95%BF"><span class="toc-number">3.2.</span> <span class="toc-text">评估命名多样性的增长</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E2%80%9C%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%AD%97%E6%AF%8D%E2%80%9D%E7%9A%84%E5%8F%98%E9%9D%A9"><span class="toc-number">4.</span> <span class="toc-text">“最后一个字母”的变革</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E6%88%90%E5%A5%B3%E5%AD%A9%E5%90%8D%E5%AD%97%E7%9A%84%E7%94%B7%E5%AD%A9%E5%90%8D%E5%AD%97%EF%BC%88%E4%BB%A5%E5%8F%8A%E7%9B%B8%E5%8F%8D%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">变成女孩名字的男孩名字（以及相反的情况）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B"><span class="toc-number">4.2.</span> <span class="toc-text">小结及展望</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IPython%EF%BC%9A%E4%B8%80%E7%A7%8D%E4%BA%A4%E4%BA%92%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">IPython：一种交互式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%92%8C%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">5.1.</span> <span class="toc-text">计算和开发环境</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IPython%E5%9F%BA%E7%A1%80"><span class="toc-number">6.</span> <span class="toc-text">IPython基础</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#36-ipython"><span class="toc-number">7.</span> <span class="toc-text">$ipython</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tab%E9%94%AE%E8%87%AA%E5%8A%A8%E5%AE%8C%E6%88%90"><span class="toc-number">7.1.</span> <span class="toc-text">Tab键自动完成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%9C%81"><span class="toc-number">7.2.</span> <span class="toc-text">内省</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EF%BC%85run%E5%91%BD%E4%BB%A4"><span class="toc-number">8.</span> <span class="toc-text">％run命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E6%AD%A3%E5%9C%A8%E6%89%A7%E8%A1%8C%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">8.1.</span> <span class="toc-text">中断正在执行的代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%89%AA%E8%B4%B4%E6%9D%BF%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">8.2.</span> <span class="toc-text">执行剪贴板中的代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%80%93-End-pasted-text"><span class="toc-number">8.3.</span> <span class="toc-text">– End pasted text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPython%E8%B7%9F%E7%BC%96%E8%BE%91%E5%99%A8%E5%92%8CIDE%E4%B9%8B%E9%97%B4%E7%9A%84%E4%BA%A4%E4%BA%92"><span class="toc-number">8.4.</span> <span class="toc-text">IPython跟编辑器和IDE之间的交互</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%AE%E7%9B%98%E5%BF%AB%E6%8D%B7%E9%94%AE"><span class="toc-number">8.5.</span> <span class="toc-text">键盘快捷键</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%92%8C%E8%B7%9F%E8%B8%AA"><span class="toc-number">8.6.</span> <span class="toc-text">异常和跟踪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E5%91%BD%E4%BB%A4"><span class="toc-number">8.7.</span> <span class="toc-text">魔术命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EQt%E7%9A%84%E5%AF%8CGUI%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">9.</span> <span class="toc-text">基于Qt的富GUI控制台</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E5%8E%86%E5%8F%B2"><span class="toc-number">9.1.</span> <span class="toc-text">使用命令历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%B9%B6%E9%87%8D%E7%94%A8%E5%91%BD%E4%BB%A4%E5%8E%86%E5%8F%B2"><span class="toc-number">9.2.</span> <span class="toc-text">搜索并重用命令历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA%E5%8F%98%E9%87%8F"><span class="toc-number">9.3.</span> <span class="toc-text">输入和输出变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA"><span class="toc-number">9.4.</span> <span class="toc-text">记录输入和输出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BA%A4%E4%BA%92"><span class="toc-number">9.5.</span> <span class="toc-text">与操作系统交互</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shell%E5%91%BD%E4%BB%A4%E5%92%8C%E5%88%AB%E5%90%8D"><span class="toc-number">9.6.</span> <span class="toc-text">shell命令和别名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E4%B9%A6%E7%AD%BE%E7%B3%BB%E7%BB%9F"><span class="toc-number">9.7.</span> <span class="toc-text">目录书签系统</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7"><span class="toc-number">10.</span> <span class="toc-text">软件开发工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%A4%E4%BA%92%E5%BC%8F%E8%B0%83%E8%AF%95%E5%99%A8"><span class="toc-number">11.</span> <span class="toc-text">交互式调试器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E7%9A%84%E5%85%B6%E4%BB%96%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">11.1.</span> <span class="toc-text">调试器的其他使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4%EF%BC%9A%EF%BC%85time%E5%92%8C%EF%BC%85timeit"><span class="toc-number">11.2.</span> <span class="toc-text">测试代码的执行时间：％time和％timeit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%EF%BC%9A%EF%BC%85prun%E5%92%8C%EF%BC%85run-p"><span class="toc-number">12.</span> <span class="toc-text">基本性能分析：％prun和％run-p</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%90%E8%A1%8C%E5%88%86%E6%9E%90%E5%87%BD%E6%95%B0%E6%80%A7%E8%83%BD"><span class="toc-number">12.1.</span> <span class="toc-text">逐行分析函数性能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#A-list-of-dotted-module-names-of-IPython-extensions-to-load"><span class="toc-number">13.</span> <span class="toc-text">A list of dotted module names of IPython extensions to load.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IPython-HTML-Notebook"><span class="toc-number">14.</span> <span class="toc-text">IPython HTML Notebook</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A9%E7%94%A8IPython%E6%8F%90%E9%AB%98%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87%E7%9A%84%E5%87%A0%E7%82%B9%E6%8F%90%E7%A4%BA"><span class="toc-number">15.</span> <span class="toc-text">利用IPython提高代码开发效率的几点提示</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="toc-number">15.1.</span> <span class="toc-text">重新加载模块依赖项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AE%BE%E8%AE%A1%E6%8F%90%E7%A4%BA"><span class="toc-number">15.2.</span> <span class="toc-text">代码设计提示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E6%9C%89%E6%84%8F%E4%B9%89%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%95%B0%E6%8D%AE"><span class="toc-number">15.3.</span> <span class="toc-text">保留有意义的对象和数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%81%E5%B9%B3%E7%BB%93%E6%9E%84%E8%A6%81%E6%AF%94%E5%B5%8C%E5%A5%97%E7%BB%93%E6%9E%84%E5%A5%BD"><span class="toc-number">15.4.</span> <span class="toc-text">扁平结构要比嵌套结构好</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A0%E6%83%A7%E5%A4%A7%E6%96%87%E4%BB%B6"><span class="toc-number">16.</span> <span class="toc-text">无惧大文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7IPython%E5%8A%9F%E8%83%BD"><span class="toc-number">16.1.</span> <span class="toc-text">高级IPython功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A9%E4%BD%A0%E7%9A%84%E7%B1%BB%E5%AF%B9IPython%E6%9B%B4%E5%8A%A0%E5%8F%8B%E5%A5%BD"><span class="toc-number">17.</span> <span class="toc-text">让你的类对IPython更加友好</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AA%E6%80%A7%E5%8C%96%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">17.1.</span> <span class="toc-text">个性化和配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%B4%E8%B0%A2"><span class="toc-number">17.2.</span> <span class="toc-text">致谢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="toc-number">17.3.</span> <span class="toc-text">利用Python进行数据分析</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2022 - 2024 By <a class="footer-bar-link" href="/" title="Smith" target="_blank">Smith</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/Smithhss/smithhs.github.io.git" title="Hexo">Hexo</a></div></div></div></footer></div></div></div><div id="sidebar"><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d20f536c64d06e5fcf4bfe2ec5dc25d.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">55</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于我</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8805965276" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/my/m/music/playlist?id=464586318&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.6/translate/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.js"></script><script>var meting_api = "https://meting.qjqq.cn/?server=:server&type=:type&id=:id&auth=:auth&r=:r";
</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("07/01/2022 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2022 By 安知鱼 V1.5.3",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Smith 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "visitor@anheyu.com";</script><script>//动态标题
let leaveTitle = '再看看嘛🌈！';
let backTitle = '欢迎回来✌️！';
let OriginTitile = document.title
let titleTime
document.addEventListener('visibilitychange', function () {
  if (document.hidden) {
    //离开当前页面时标签显示内容
    document.title = leaveTitle
    clearTimeout(titleTime)
  } else {
    //返回当前页面时标签显示内容
    document.title = backTitle + OriginTitile
    //两秒后变回正常标题
    titleTime = setTimeout(function () {
      document.title = OriginTitile
    }, 2000)
  }
})</script><script async data-pjax src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/waterfall.js/1.1.0/waterfall.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script>// 初始化函数
let rm = {};

//禁止图片与超链接拖拽
let aElements = document.getElementsByTagName("a");
for (let i = 0; i < aElements.length; i++) {
  aElements[i].setAttribute("draggable", "false");
  let imgElements = aElements[i].getElementsByTagName("img");
  for (let j = 0; j < imgElements.length; j++) {
    imgElements[j].setAttribute("draggable", "false");
  }
}

// 显示菜单
rm.showRightMenu = function (isTrue, x = 0, y = 0) {
  console.info(x, y)
  let rightMenu = document.getElementById("rightMenu");
  rightMenu.style.top = x + "px";
  rightMenu.style.left = y + "px";
  if (isTrue) {
    rightMenu.style.display = "block";
    stopMaskScroll();
  } else {
    rightMenu.style.display = "none";
  }
};

// 隐藏菜单
rm.hideRightMenu = function () {
  rm.showRightMenu(false);
  let rightMenuMask = document.querySelector("#rightmenu-mask");
  rightMenuMask.style.display = "none";
};

// 尺寸
let rmWidth = document.getElementById("rightMenu").offsetWidth;
let rmHeight = document.getElementById("rightMenu").offsetHeight;

// 重新定义尺寸
rm.reloadrmSize = function () {
  rightMenu.style.visibility = "hidden";
  rightMenu.style.display = "block";
  // 获取宽度和高度
  rmWidth = document.getElementById("rightMenu").offsetWidth;
  rmHeight = document.getElementById("rightMenu").offsetHeight;
  rightMenu.style.visibility = "visible";
};

// 获取点击的href
let domhref = "";
let domImgSrc = "";
let globalEvent = null;

var oncontextmenuFunction = function (event) {
  if (document.body.clientWidth > 768) {
    let pageX = event.clientX + 10; //加10是为了防止显示时鼠标遮在菜单上
    let pageY = event.clientY;

    //其他额外菜单
    const $rightMenuOther = document.querySelector(".rightMenuOther");
    const $rightMenuPlugin = document.querySelector(".rightMenuPlugin");
    const $rightMenuCopyText = document.querySelector("#menu-copytext");
    const $rightMenuPasteText = document.querySelector("#menu-pastetext");
    const $rightMenuCommentText = document.querySelector("#menu-commenttext");
    const $rightMenuNewWindow = document.querySelector("#menu-newwindow");
    const $rightMenuNewWindowImg = document.querySelector("#menu-newwindowimg");
    const $rightMenuCopyLink = document.querySelector("#menu-copylink");
    const $rightMenuCopyImg = document.querySelector("#menu-copyimg");
    const $rightMenuDownloadImg = document.querySelector("#menu-downloadimg");
    const $rightMenuSearch = document.querySelector("#menu-search");
    const $rightMenuSearchBaidu = document.querySelector("#menu-searchBaidu");
    const $rightMenuMusicToggle = document.querySelector("#menu-music-toggle");
    const $rightMenuMusicBack = document.querySelector("#menu-music-back");
    const $rightMenuMusicForward = document.querySelector("#menu-music-forward");
    const $rightMenuMusicPlaylist = document.querySelector("#menu-music-playlist");
    const $rightMenuMusicCopyMusicName = document.querySelector("#menu-music-copyMusicName");

    let href = event.target.href;
    let imgsrc = event.target.currentSrc;

    // 判断模式 扩展模式为有事件
    let pluginMode = false;
    $rightMenuOther.style.display = "block";
    globalEvent = event;

    // 检查是否需要复制 是否有选中文本
    if (selectTextNow && window.getSelection()) {
      pluginMode = true;
      $rightMenuCopyText.style.display = "block";
      $rightMenuCommentText.style.display = "block";
      $rightMenuSearch.style.display = "block";
      $rightMenuSearchBaidu.style.display = "block";
    } else {
      $rightMenuCopyText.style.display = "none";
      $rightMenuCommentText.style.display = "none";
      $rightMenuSearchBaidu.style.display = "none";
      $rightMenuSearch.style.display = "none";
    }

    //检查是否右键点击了链接a标签
    if (href) {
      pluginMode = true;
      $rightMenuNewWindow.style.display = "block";
      $rightMenuCopyLink.style.display = "block";
      domhref = href;
    } else {
      $rightMenuNewWindow.style.display = "none";
      $rightMenuCopyLink.style.display = "none";
    }

    //检查是否需要复制图片
    if (imgsrc) {
      pluginMode = true;
      $rightMenuCopyImg.style.display = "block";
      $rightMenuDownloadImg.style.display = "block";
      $rightMenuNewWindowImg.style.display = "block";
      document.getElementById("rightMenu").style.width="12rem"
      domImgSrc = imgsrc;
    } else {
      $rightMenuCopyImg.style.display = "none";
      $rightMenuDownloadImg.style.display = "none";
      $rightMenuNewWindowImg.style.display = "none";
    }

    // 判断是否为输入框
    if (event.target.tagName.toLowerCase() === "input" || event.target.tagName.toLowerCase() === "textarea") {
      pluginMode = true;
      $rightMenuPasteText.style.display = "block";
    } else {
      $rightMenuPasteText.style.display = "none";
    }
    const navMusicEl = document.querySelector("#nav-music");
    //判断是否是音乐
    if (navMusicEl && navMusicEl.contains(event.target)) {
      pluginMode = true;
      $rightMenuMusicToggle.style.display = "block";
      $rightMenuMusicBack.style.display = "block";
      $rightMenuMusicForward.style.display = "block";
      $rightMenuMusicPlaylist.style.display = "block";
      $rightMenuMusicCopyMusicName.style.display = "block";
    } else {
      $rightMenuMusicToggle.style.display = "none";
      $rightMenuMusicBack.style.display = "none";
      $rightMenuMusicForward.style.display = "none";
      $rightMenuMusicPlaylist.style.display = "none";
      $rightMenuMusicCopyMusicName.style.display = "none";
    }

    // 如果不是扩展模式则隐藏扩展模块
    if (pluginMode) {
      $rightMenuOther.style.display = "none";
      $rightMenuPlugin.style.display = "block";
    } else {
      $rightMenuPlugin.style.display = "none";
    }

    rm.reloadrmSize();

    // 鼠标默认显示在鼠标右下方，当鼠标靠右或靠下时，将菜单显示在鼠标左方\上方
    if (pageX + rmWidth > window.innerWidth) {
      pageX -= rmWidth + 10;
    }
    if (pageY + rmHeight > window.innerHeight) {
      pageY -= pageY + rmHeight - window.innerHeight;
    }

    rm.showRightMenu(true, pageY, pageX);
    document.getElementById("rightmenu-mask").style.display = "flex";
    return false;
  }
};

// 监听右键初始化
window.oncontextmenu = oncontextmenuFunction

// 下载图片状态
rm.downloadimging = false;

// 复制图片到剪贴板
rm.writeClipImg = function (imgsrc) {
  console.log("按下复制");
  rm.hideRightMenu();
  anzhiyu.snackbarShow("正在下载中，请稍后", false, 10000);
  if (rm.downloadimging == false) {
    rm.downloadimging = true;
    setTimeout(function () {
      copyImage(imgsrc);
      anzhiyu.snackbarShow("复制成功！图片已添加盲水印，请遵守版权协议");
      rm.downloadimging = false;
    }, "10000");
  }
};

function imageToBlob(imageURL) {
  const img = new Image();
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  img.crossOrigin = "";
  img.src = imageURL;
  return new Promise(resolve => {
    img.onload = function () {
      c.width = this.naturalWidth;
      c.height = this.naturalHeight;
      ctx.drawImage(this, 0, 0);
      c.toBlob(
        blob => {
          // here the image is a blob
          resolve(blob);
        },
        "image/png",
        0.75
      );
    };
  });
}

async function copyImage(imageURL) {
  const blob = await imageToBlob(imageURL);
  const item = new ClipboardItem({ "image/png": blob });
  navigator.clipboard.write([item]);
}

rm.copyUrl = function (id) {
  const input = document.createElement("input"); // Create a new <input> element
  input.id = "copyVal"; // Set the id of the new element to "copyVal"
  document.body.appendChild(input); // Append the new element to the end of the <body> element
  
  const text = id;
  input.value = text;
  input.select();
  input.setSelectionRange(0, input.value.length);
  document.execCommand("copy");
  
  input.remove(); // Remove the <input> element from the DOM
};

function stopMaskScroll() {
  if (document.getElementById("rightmenu-mask")) {
    let xscroll = document.getElementById("rightmenu-mask");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //阻止浏览器默认方法
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
  if (document.getElementById("rightMenu")) {
    let xscroll = document.getElementById("rightMenu");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //阻止浏览器默认方法
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
}

rm.rightmenuCopyText = function (txt) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt);
  }
  rm.hideRightMenu();
};

rm.copyPageUrl = function (url) {
  if (!url) {
    url = window.location.href;
  }
  rm.copyUrl(url);
  anzhiyu.snackbarShow("复制链接地址成功", false, 2000);
  rm.hideRightMenu();
};

rm.sharePage = function () {
  var content = window.location.href;
  rm.copyUrl(url);
  anzhiyu.snackbarShow("复制链接地址成功", false, 2000);
  rm.hideRightMenu();
};

// 复制当前选中文本
var selectTextNow = "";
document.onmouseup = document.ondblclick = selceText;

function selceText() {
  var txt;
  if (document.selection) {
    txt = document.selection.createRange().text;
  } else {
    txt = window.getSelection().toString();
  }
  selectTextNow = txt !== "" ? txt : "";
}

// 读取剪切板
rm.readClipboard = function () {
  if (navigator.clipboard) {
    navigator.clipboard.readText().then(clipText => rm.insertAtCaret(globalEvent.target, clipText));
  }
};

// 粘贴文本到焦点
rm.insertAtCaret = function (elemt, value) {
  const startPos = elemt.selectionStart,
    endPos = elemt.selectionEnd;
  if (document.selection) {
    elemt.focus();
    var sel = document.selection.createRange();
    sel.text = value;
    elemt.focus();
  } else {
    if (startPos || startPos == "0") {
      var scrollTop = elemt.scrollTop;
      elemt.value = elemt.value.substring(0, startPos) + value + elemt.value.substring(endPos, elemt.value.length);
      elemt.focus();
      elemt.selectionStart = startPos + value.length;
      elemt.selectionEnd = startPos + value.length;
      elemt.scrollTop = scrollTop;
    } else {
      elemt.value += value;
      elemt.focus();
    }
  }
};

//粘贴文本
rm.pasteText = function () {
  const result = rm.readClipboard() || "";
  rm.hideRightMenu();
};

//引用到评论
rm.rightMenuCommentText = function (txt) {
  rm.hideRightMenu();
  const postCommentDom = document.getElementById("post-comment");
  var domTop = postCommentDom.offsetTop;
  window.scrollTo(0, domTop - 80);
  if (txt == "undefined" || txt == "null") txt = "好棒！";
  function setText() {
    setTimeout(() => {
      var input = document.getElementsByClassName("el-textarea__inner")[0];
      if (!input) setText();
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("input", true, true);
      let inputValue = replaceAll(txt, "\n", "\n> ");
      input.value = "> " + inputValue + "\n\n";
      input.dispatchEvent(evt);
      input.focus();
      input.setSelectionRange(-1, -1);
      if (document.getElementById("comment-tips")) {
        document.getElementById("comment-tips").classList.add("show");
      }
    }, 100);
  }
  setText();
};

//替换所有内容
function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

// 百度搜索
rm.searchBaidu = function () {
  anzhiyu.snackbarShow("即将跳转到百度搜索", false, 2000);
  setTimeout(function () {
    window.open("https://www.baidu.com/s?wd=" + selectTextNow);
  }, "2000");
  rm.hideRightMenu();
};

//分享链接
rm.copyLink = function () {
  rm.rightmenuCopyText(domhref);
  anzhiyu.snackbarShow("已复制链接地址");
};

function addRightMenuClickEvent() {
  // 添加点击事件
  document.getElementById("menu-backward").addEventListener("click", function () {
  window.history.back();
    rm.hideRightMenu();
  });

  document.getElementById("menu-forward").addEventListener("click", function () {
    window.history.forward();
    rm.hideRightMenu();
  });

  document.getElementById("menu-refresh").addEventListener("click", function () {
    window.location.reload();
  });

  document.getElementById("menu-top").addEventListener("click", function () {
    anzhiyu.scrollToDest(0, 500);
    rm.hideRightMenu();
  });

  const menuLinks = document.querySelectorAll(".menu-link");
  menuLinks.forEach(function (link) {
    link.addEventListener("click", rm.hideRightMenu);
  });

  document.getElementById("menu-darkmode").addEventListener("click", anzhiyu.switchDarkMode);

  document.getElementById("menu-home") && document.getElementById("menu-home").addEventListener("click", function () {
    window.location.href = window.location.origin;
  });

  document.getElementById("menu-randomPost").addEventListener("click", function () {
    toRandomPost();
  });

  document.getElementById("menu-commentBarrage").addEventListener("click", anzhiyu.switchCommentBarrage);

  document.getElementById("rightmenu-mask").addEventListener("click", rm.hideRightMenu);

  document.getElementById("rightmenu-mask").addEventListener("contextmenu", function (event) {
    rm.hideRightMenu();
    event.preventDefault(); // Prevent the default context menu from appearing
  });

  document.getElementById("menu-copy").addEventListener("click", rm.copyPageUrl);

  document.getElementById("menu-pastetext").addEventListener("click", rm.pasteText);

  document.getElementById("menu-copytext").addEventListener("click", function () {
    rm.rightmenuCopyText(selectTextNow);
    anzhiyu.snackbarShow("复制成功，复制和转载请标注本文地址");
  });

  document.getElementById("menu-commenttext").addEventListener("click", function () {
    rm.rightMenuCommentText(selectTextNow);
  });

  document.getElementById("menu-newwindow").addEventListener("click", function () {
    window.open(domhref, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copylink").addEventListener("click", rm.copyLink);

  document.getElementById("menu-downloadimg").addEventListener("click", function () {
    anzhiyu.downloadImage(domImgSrc, "anzhiyu");
  });

  document.getElementById("menu-newwindowimg").addEventListener("click", function () {
    window.open(domImgSrc, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copyimg").addEventListener("click", function () {
    rm.writeClipImg(domImgSrc);
  });

  document.getElementById("menu-searchBaidu").addEventListener("click", rm.searchBaidu);

  //音乐
  document.getElementById("menu-music-toggle").addEventListener("click", anzhiyu.musicToggle);

  document.getElementById("menu-music-back").addEventListener("click", anzhiyu.musicSkipBack);

  document.getElementById("menu-music-forward").addEventListener("click", anzhiyu.musicSkipForward);

  document.getElementById("menu-music-copyMusicName").addEventListener("click", function () {
    rm.rightmenuCopyText(anzhiyu.musicGetName());
    anzhiyu.snackbarShow("复制歌曲名称成功", false, 3000);
  });

}

addRightMenuClickEvent();</script><script data-pjax>var themeColorMeta = document.querySelector('meta[name="theme-color"]');
var pageHeaderEl = document.getElementById("page-header");
var navMusicEl = document.getElementById("nav-music");
var consoleEl = document.getElementById("console");
// 已随机的歌曲
var selectRandomSong = [];
// 音乐默认声音大小
var musicVolume = 0.8;
// 是否切换了周杰伦音乐列表
var changeMusicListFlag = false;
// 当前默认播放列表
var defaultPlayMusicList = [];

document.getElementById("page-name").innerText = document.title.split(" | Smith")[0];
anzhiyu.initIndexEssay();
anzhiyu.changeTimeInEssay();
anzhiyu.removeBodyPaceClass();
anzhiyu.qrcodeCreate();
anzhiyu.changeTimeInAlbumDetail();
anzhiyu.reflashEssayWaterFall();
anzhiyu.sayhi();
anzhiyu.stopImgRightDrag();
anzhiyu.addNavBackgroundInit();
anzhiyu.setValueToBodyType();
anzhiyu.catalogActive();
anzhiyu.tagsPageActive();
anzhiyu.categoriesBarActive();
anzhiyu.topCategoriesBarScroll();
anzhiyu.switchRightClickMenuHotReview();
anzhiyu.getCustomPlayList();
anzhiyu.addEventListenerConsoleMusicList(false);
setTimeout(() => {if (typeof addFriendLinksInFooter === "function") {addFriendLinksInFooter();}}, 200)</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://npm.elemecdn.com/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div></body></html>