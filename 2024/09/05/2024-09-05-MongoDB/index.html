<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>MongoDB超详细教程 | Smith</title><meta name="keywords" content="MongoDB"><meta name="author" content="Smith"><meta name="copyright" content="Smith"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="MongoDB超详细教程"><meta name="application-name" content="MongoDB超详细教程"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="MongoDB超详细教程"><meta property="og:url" content="https://smithhs.cn/2024/09/05/2024-09-05-MongoDB/index.html"><meta property="og:site_name" content="Smith"><meta property="og:description" content="一、简介1. 简单介绍 MongoDB是一个基于分布式文件存储的数据库 由C++语言编写，旨在为WEB应用提供可扩展的高性能数据存储解决方案。 MongoDB是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。 它支持的数据结构非常松散，是类似json的bs"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/MongoDB.png"><meta property="article:author" content="Smith"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/MongoDB.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://smithhs.cn/2024/09/05/2024-09-05-MongoDB/"><link rel="preconnect" href="//npm.elemecdn.com"/><link rel="preconnect" href="//npm.onmicrosoft.cn"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":240},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#3b70fc","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MongoDB超详细教程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-31 22:28:54',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d20f536c64d06e5fcf4bfe2ec5dc25d.jpg"/><div class="loading-image-dot"></div><div id="loading-percentage">0%</div></div></div><script>if (GLOBAL_CONFIG.preloader.source == "2" || GLOBAL_CONFIG.preloader.source == "3") {
  const loadingPercentage = document.getElementById("loading-percentage");
  let loadingPercentageTimer = setInterval(function() {
    var progressBar = document.querySelector(".pace-progress");
    if (!progressBar) return
    var currentValue = progressBar.getAttribute("data-progress-text");
    if (currentValue !== loadingPercentage.textContent) {
      loadingPercentage.textContent = currentValue;
      if (currentValue === "100%") {
        clearInterval(loadingPercentageTimer);
      }
    }
  }, 100);
}

const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div id="web_box"><div id="web_container"><div id="menu-mask"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://smithhs.cn/" title="博客" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" href="http://robot.onliu.cn/" title="Robot" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/cupfox.png" alt="Robot"/><span class="back-menu-item-text">Robot</span></a><a class="back-menu-item" href="http://res.onliu.cn" title="Sale" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://alandodo-1315761622.cos.ap-beijing.myqcloud.com/blog-tuce/tubiao.jpg" alt="Sale"/><span class="back-menu-item-text">Sale</span></a><a class="back-menu-item" href="http://se.onliu.cn/" title="资源共享" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://alandodo-1315761622.cos.ap-beijing.myqcloud.com/blog/x126.png" alt="资源共享"/><span class="back-menu-item-text">资源共享</span></a><a class="back-menu-item" href="https://github.com/Smithhss" title="Github" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/GitHub.png" alt="Github"/><span class="back-menu-item-text">Github</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Smith</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于我</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1.jpg" target="_blank"><img class="post-qr-code-img" alt="wechat" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1.jpg"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2.jpg" target="_blank"><img class="post-qr-code-img" alt="alipay" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2.jpg"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> <span>最新评论</span></span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Android-Studio/" style="font-size: 1.05rem;">Android Studio<sup>1</sup></a><a href="/tags/App/" style="font-size: 1.05rem;">App<sup>2</sup></a><a href="/tags/Butterfly/" style="font-size: 1.05rem;">Butterfly<sup>1</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C++<sup>1</sup></a><a href="/tags/CSS/" style="font-size: 1.05rem;">CSS<sup>1</sup></a><a href="/tags/Cisco-Packet-Tracer/" style="font-size: 1.05rem;">Cisco Packet Tracer<sup>1</sup></a><a href="/tags/Easypan/" style="font-size: 1.05rem;">Easypan<sup>2</sup></a><a href="/tags/FurtherMathematics/" style="font-size: 1.05rem;">FurtherMathematics<sup>1</sup></a><a href="/tags/GPT/" style="font-size: 1.05rem;">GPT<sup>1</sup></a><a href="/tags/Git2/" style="font-size: 1.05rem;">Git2<sup>1</sup></a><a href="/tags/HTML/" style="font-size: 1.05rem;">HTML<sup>1</sup></a><a href="/tags/Hexo/" style="font-size: 1.05rem;">Hexo<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>6</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem;">JavaScript<sup>1</sup></a><a href="/tags/JavaWeb/" style="font-size: 1.05rem;">JavaWeb<sup>2</sup></a><a href="/tags/LeetCode/" style="font-size: 1.05rem;">LeetCode<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>2</sup></a><a href="/tags/Markdown/" style="font-size: 1.05rem;">Markdown<sup>2</sup></a><a href="/tags/Maven/" style="font-size: 1.05rem;">Maven<sup>2</sup></a><a href="/tags/Mysql/" style="font-size: 1.05rem;">Mysql<sup>1</sup></a><a href="/tags/Navicat/" style="font-size: 1.05rem;">Navicat<sup>1</sup></a><a href="/tags/NoSql/" style="font-size: 1.05rem;">NoSql<sup>1</sup></a><a href="/tags/Nodejs/" style="font-size: 1.05rem;">Nodejs<sup>2</sup></a><a href="/tags/Python/" style="font-size: 1.05rem;">Python<sup>3</sup></a><a href="/tags/Spring/" style="font-size: 1.05rem;">Spring<sup>2</sup></a><a href="/tags/VMware/" style="font-size: 1.05rem;">VMware<sup>2</sup></a><a href="/tags/Vue/" style="font-size: 1.05rem;">Vue<sup>1</sup></a><a href="/tags/YouHou/" style="font-size: 1.05rem;">YouHou<sup>1</sup></a><a href="/tags/books/" style="font-size: 1.05rem;">books<sup>1</sup></a><a href="/tags/butterfly/" style="font-size: 1.05rem;">butterfly<sup>1</sup></a><a href="/tags/clash/" style="font-size: 1.05rem;">clash<sup>1</sup></a><a href="/tags/project/" style="font-size: 1.05rem;">project<sup>4</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 1.05rem;">前端<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/" style="font-size: 1.05rem;">开发框架<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" style="font-size: 1.05rem;">开发环境<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">操作系统<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">数据结构与算法<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" style="font-size: 1.05rem;">计算机组成原理<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">计算机网络<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" style="font-size: 1.05rem;">软件工程<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">17</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" onclick="anzhiyu.switchDarkMode()" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Programming/">Programming</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/MongoDB/" tabindex="-1"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>MongoDB</span></a></span></div></div><h1 class="post-title">MongoDB超详细教程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="post-meta-icon anzhiyufont anzhiyu-icon-calendar-days"></i><span class="post-meta-label">发表于</span><time datetime="2024-09-04T23:24:04.000Z" title="发表于 2024-09-05 07:24:04">2024-09-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">98.9k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>462分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="MongoDB超详细教程"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为石家庄"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>石家庄</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/MongoDB.png"></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h4 id="1-简单介绍"><a href="#1-简单介绍" class="headerlink" title="1. 简单介绍"></a>1. 简单介绍</h4><ul>
<li>MongoDB是一个基于<strong>分布式文件存储</strong>的数据库</li>
<li>由C++语言编写，旨在为WEB应用提供可扩展的高性能数据存储解决方案。</li>
<li>MongoDB是一个介于<strong>关系数据库</strong>和<strong>非关系数据库</strong>之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。</li>
<li>它支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。</li>
<li>Mongo最大的特点是它支持的<strong>查询语言</strong>非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1e38ddc4ff3591858dc7331732c43f6fpng.jpg"></li>
</ul>
<h4 id="2-业务应用场景"><a href="#2-业务应用场景" class="headerlink" title="2. 业务应用场景"></a>2. 业务应用场景</h4><p>传统的关系型数据库(如MySQL)，在数据操作的<code>三高</code>需求以及应对Web2.0的网站需求面前，显得力不从心，而 MongoDB可应对“三高“需求</p>
<ul>
<li><p>High performance：<strong>对数据库高并发读写的需求</strong></p>
</li>
<li><p>Huge Storage：<strong>对海量数据的高效率存储和访问的需求</strong></p>
</li>
<li><p>High Scalability &amp;&amp; High Availability：<strong>对数据库的高可扩展性和高可用性的需求</strong></p>
</li>
</ul>
<p><strong>具体应用场景</strong>：</p>
<ul>
<li>社交场景，使用 MongoDB存储存储用户信息，以及用户发表的朋友圈信息，通过地理位置索引实现附近的人、地点等功能。</li>
<li>游戏场景，使用 MongoDB存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式存储，方便查询、高效率存储和访问。</li>
<li>物流场景，使用 MongoDB存储订单信息，订单状态在运送过程中会不断更新，以 MongoDB内嵌数组的形式来存储，一次查询就能将订单所有的变更读取出来</li>
<li>物联网场景，使用 MongoDB存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析。<br>视频直播，使用 MongoDB存储用户信息、点赞互动信息等。</li>
</ul>
<p>这些应用场景中，数据操作方面的<strong>共同特点</strong>是：</p>
<p>（1）数据量大</p>
<p>（2）写入操作频繁（读写都很频繁）</p>
<p>（3）价值较低的数据，对事务性要求不高</p>
<p>对于这样的数据，我们更适合使用 MongoDB来实现数据的存储。</p>
<h4 id="3-什么时候选择MongoDB"><a href="#3-什么时候选择MongoDB" class="headerlink" title="3. 什么时候选择MongoDB"></a>3. 什么时候选择MongoDB</h4><ul>
<li><p>应用不需要事务及复杂join支持</p>
</li>
<li><p>新应用，需求会变，数据模型无法确定，想快速迭代开发</p>
</li>
<li><p>应用需要2000-3000以上的读写QPS（更高也可以）</p>
</li>
<li><p>应用需要TB甚至PB级别数据存储</p>
</li>
<li><p>应用要求存储的数据不丢失</p>
</li>
<li><p>应用需要99.999%高可用</p>
</li>
<li><p>应用需要大量的地理位置查询、文本查</p>
</li>
</ul>
<ul>
<li>什么是MongoDB</li>
</ul>
<p>MongoDB是一个开源、高性能、无模式（没有具体的列）的文档型数据库，当初的设计就是用于简化开发和方便扩展，是NoSQL数据库产品中的一种。是最像关系型数据库（MySQL）的非关系型数据库。</p>
<p>它支持的数据结构非常松散，是一种类似于 JSON 的 格式叫BSON，所以它既可以存储比较复杂的数据类型，又相当的灵活。<br>MongoDB中的记录是一个文档，它是一个由字段和值对（field:value）组成的数据结构。MongoDB文档类似于JSON对象，即一个文档认为就是一个对象。字段的数据类型是字符型，它的值除了使用基本的一些类型外，还可以包括其他文档、普通数组和文档数组。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 对文档数据库进行操作的基本方式包括了读、写、改、删四种。</span><br><span class="line"></span><br><span class="line"># <span class="number">1</span>、写<span class="keyword">Insert</span>命令</span><br><span class="line">DB.Books.Insert(“Book_ID”:”<span class="number">100002</span>”,”Name”:”《C语言》”,”Price”:”<span class="number">60</span>”)</span><br><span class="line"></span><br><span class="line"># <span class="number">2</span>、选<span class="keyword">Select</span>命令</span><br><span class="line">DB.Books.find(“Name”:”《C语言》”)</span><br><span class="line"></span><br><span class="line"># <span class="number">3</span>、改<span class="keyword">Update</span>命令</span><br><span class="line">DB.Books.Update(&#123;“Book_ID”:”<span class="number">100002</span>”&#125;,&#123;$<span class="keyword">set</span>&#123;“Price”:<span class="number">78</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"># <span class="number">4</span>、删Remove命令</span><br><span class="line">DB.Books.Remove(&#123;“Book_ID”:”<span class="number">100004</span>”&#125;) 。</span><br></pre></td></tr></table></figure>
<p>相对MySQL，在以上以用场景可以以更低的成本解决问题（包括学习、开发、运维等成本）</p>
<h4 id="4-体系机构"><a href="#4-体系机构" class="headerlink" title="4. 体系机构"></a>4. 体系机构</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/f8e0b28e2a41fef2c139e7165286658bpng.jpg"></p>
<p>在MongoDB中，数据库存储着集合和文档。一个数据库可以创建多个集合，原则上我们通常将逻辑相近的集合都放在一个数据库中，不过出于性能和数据量的考虑，也可分开存储。MongoDB默认提供admin、local、config以及test数据库四个数据库，具体介绍如下：</p>
<ul>
<li><strong>admin数据库</strong>，主要存储数据库账号的相关信息。</li>
<li><strong>local数据库</strong>，可以用于存储限于本地单台服务器的任意集合，如oplog日志就存储在local数据库中，该数据库的数据不会被复制到从节点上。</li>
<li><strong>config数据库</strong>，用于存储分片集群中与分片相关的元数据信息。</li>
<li><strong>test数据库</strong>，是MongoDB默认创建的一个测试库，当连接mongod服务时，如果不指定连接的具体数据库，默认就会连接到test数据库。</li>
</ul>
<p><strong>集合</strong>就是MongoDB的一组文档，分为一般集合和上限集合。<strong>一般集合</strong>我们通常称之为集合，集合是<strong>无模式或动态模式</strong>的，也就意味着集合没有固定的格式。在读写数据前，不需要创建集合模式就可使用，因此集合中的文档可以拥有不同的字段，也可以任意增减某个文档的字段。</p>
<p>需要注意的是，通常插入集合的数据都具有一定的关联性。</p>
<p><strong>上限集合</strong>（Capped collections）与一般集合的主要区别在于其<u>可以限制集合的容量大小</u>，在数据存满时，可以从头开始覆盖最开始的文档，从而进行**<u>循环写入</u>**。</p>
<p><strong>文档</strong>是以 <u>键值对的形式</u> 存储在集合中，其中，键用于唯一标识一个文档，为字符串类型，而值则可以是各种复杂的文件类型，我们称这种存储形式为<strong>BSON</strong>（BSON是类JSON的一种二进制形式的存储格式，简称BinaryJSON，它和JSON一样，<strong>支持内嵌的文档对象和数组对象</strong>，但是BSON有JSON没有的一些数据类型，如Date和BinData类型）。</p>
<p>文档中不能有重复的键，<strong>每个文档都有一个默认的_id键</strong>，它相当于关系型数据库中的主键，这个键的值在同一个集合中必须是唯一的，_id键值默认是ObjectId类型，在插入文档的时候，如果用户不设置文档的_id值，MongoDB会<strong>自动生成一个唯一的ObjectId值</strong>进行填充。</p>
<p><strong>MongoDB的最小存储单位就是文档(document)对象</strong>。文档(document)对象对应于关系型数据库的行。数据在MongoDB中以BSON（Binary-JSON）文档的格式存储在磁盘上。</p>
<p><strong>BSON</strong>（Binary Serialized Document Format）<strong>是一种类json的一种二进制形式的存储格式</strong>，简称Binary JSON。BSON和JSON一样，支持内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。</p>
<p>BSON采用了类似于 C 语言结构体的名称、对表示方法，支持内嵌的文档对象和数组对象，具有轻量性、可遍历性、高效性的三个特点，可以有效描述非结构化数据和结构化数据。这种格式的优点是灵活性高，但它的缺点是空间利用率不是很理想。</p>
<p>Bson中，<strong>除了基本的JSON类型：string,integer,boolean,double,null,array和object</strong>，mongo还使用了特殊的数据类型。这些类型<strong>包括date,object id,binary data,regular expression 和code</strong>。每一个驱动都以特定语言的方式实现了这些类型，查看你的驱动的文档来获取详细信息。BSON数据类型参考列表：</p>
<p>文档的键是字符串类型，而值除字符串类型外，还可以为内嵌文档、数组、Date等类型，文档内容具体如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: ObjectId(&quot;5099803df3f4948bd2f98391&quot;),</span><br><span class="line">	name: &#123; <span class="keyword">first</span>: &quot;Alan&quot;, <span class="keyword">last</span>: &quot;Turing&quot; &#125;,</span><br><span class="line">	birth: <span class="keyword">new</span> <span class="type">Date</span>(<span class="string">&#x27;Jun 23, 1912&#x27;</span>),</span><br><span class="line">	death: <span class="keyword">new</span> <span class="type">Date</span>(<span class="string">&#x27;Jun 07, 1954&#x27;</span>),</span><br><span class="line">	contribs: [ &quot;Turing machine&quot;, &quot;Turing test&quot;, &quot;Turingery&quot; ],</span><br><span class="line">	views : NumberLong(<span class="number">1250000</span>)&#125;</span><br><span class="line"></span><br><span class="line">_id：该字段的值为ObjectId类型。</span><br><span class="line">name：该字段的值是由<span class="keyword">first</span>、<span class="keyword">last</span>字段组成的内嵌文档。</span><br><span class="line">birth和death：这两个字段对应的值均为<span class="type">Date</span>类型。</span><br><span class="line">contribs：该字段的值为字符串数组类型。</span><br><span class="line">views：该字段的值为NumberLong类型。</span><br></pre></td></tr></table></figure>

<h5 id="数字类型"><a href="#数字类型" class="headerlink" title="数字类型"></a>数字类型</h5><p>MongoDB支持三种数字类型（即32位整数（<strong>Int32</strong>）、64位整数（<strong>Int64</strong>）和64位浮点数（<strong>Double</strong>））。 使用mongo shell命令行交互界面和JavaScript命令这两种方式查看和操作MongoDB时，数值被默认转为64位浮点数。可通过Java等语言可存储包含整数（32位和64位整型）的文档。 如果想要通过mongo shell插入&#x2F;更新文档内的整数（32位&#x2F;64位）类型数值，则可以通过函数NumberInt(“Number”)和NumberLong(“Number”)进行操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 在mongo shell查看文档中的<span class="number">64</span>位整数时，会通过封装函数NumberLong()显示。</span><br><span class="line">&#123;</span><br><span class="line">	&quot;_id&quot;:Objectld(&quot;5e042c88b2275b76df53b302&quot;),</span><br><span class="line">	&quot;age32&quot;:<span class="number">32</span>,</span><br><span class="line">	&quot;age64&quot;:NumberLong(<span class="number">64</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="日期类型"><a href="#日期类型" class="headerlink" title="日期类型"></a>日期类型</h5><p>在mongo shell中<strong>创建包含日期类型数值的文档</strong>，类似于在javascript中创建日期的方式，需要使用**new Date(…)**的方式。MongoDB会将存储的日期自动保存成ISODate日期类型。默认情况下MongoDB中存储的是标准的时间（GMT），中国时间是东八区(GMT+8)，若是我们将当前时间存储至MongoDB中会发现减少8个小时。不过有些编程语言已对此进行相关处理，比如Java读取时会自动加上时区8小时。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 在mongo shell插入<span class="type">Date</span>类型文档的操作。</span><br><span class="line">    <span class="operator">&gt;</span> db.bigdata.insert(&#123;&quot;time&quot;:<span class="keyword">new</span> <span class="type">Date</span>(&quot;2019-02-12 12:12:12&quot;)&#125;)</span><br><span class="line">     <span class="operator">&gt;</span> db.bigdata.find()</span><br><span class="line">        &#123;</span><br><span class="line">	&quot;_id&quot;:Objectld(&quot;5de915201bc9accea9a23154&quot;),</span><br><span class="line">	&quot;time&quot;:ISODate(&quot;2019-02-12T04:12:12Z&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h5><p>MongoDB<strong>数组是一系列元素的集合</strong>，使用<strong>中括号“[ ]”表示数组</strong>。数组元素允许重复且位置固定，数组中可以存在不同数据类型的元素。在关系数据库中，数组的这种设计实现方式是不常见的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 数组类型文档的结构。</span><br><span class="line">    &#123;</span><br><span class="line">	&quot;_id&quot;:Objectld(&quot;5de91c6f1bc9accea9a2315b&quot;),</span><br><span class="line">	&quot;hobby&quot;:[</span><br><span class="line">		&quot;swim&quot;,</span><br><span class="line">		&quot;run&quot;,</span><br><span class="line">		&quot;sing&quot;,</span><br><span class="line">		<span class="number">4.0</span>,</span><br><span class="line">		&quot;sing&quot;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ObjectId类型"><a href="#ObjectId类型" class="headerlink" title="ObjectId类型"></a>ObjectId类型</h5><p><strong>ObjectId 是一个12字节BSON类型</strong>，由一组十六进制的24位字符串构成，每个字节存储2位十六进制字符，总共使用了12字节的存储空间，具有格式如下所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204092222036.png"></p>
<p><strong>Time：ObjectId的前4个字节表示时间戳，即前8位字符“5de91c6f”</strong>，通过十六进制转换成十进制内容为“1575558255”，这个数字就是一个时间戳格式，通过时间戳的转换，可变为常见的时间格式。</p>
<p><strong>Machine：在Time后的3个字节表示所在主机的唯一标识符，即Time之后的6位字符“1bc9ac”</strong>，一般是机器主机名的散列值，这样就确保了不同主机生成不同的机器hash值，这样可以防止在分布式中出现ObjectId相同的冲突情况，这也就是**<u>在同一台机器生成的ObjectId中间字符串都是一模一样的原因</u>**。</p>
<p><strong>PID：在Machine后的2个字节表示进程标识符，即Machine后的4位字符“cea9”</strong>，可以**<u>确保在同一台机器不同的MongoDB进程不会出现相同的ObjectId</u>**。</p>
<p><strong>INC：在PID后的3个字节是一个随机值</strong>，即PID之后的4位字符“a2315b”。前面介绍的9个字节是为了保证1秒内<u>不同机器</u><u>不同进程</u>生成的ObjectId不冲突，这3个字节生成的<u><strong>随机值是为了确保1秒内产生的ObjectId不发生冲突</strong></u>。</p>
<h5 id="内嵌文档"><a href="#内嵌文档" class="headerlink" title="内嵌文档"></a>内嵌文档</h5><p>MongoDB一大优势在于能够在一条文档中<strong>存储对象类型的数据</strong>，并适当增加冗余让数据库更便于使用。文档中一个对象类型的字段在MongoDB中被称为<strong>内嵌文档</strong>（Embedded），也是MongoDB推荐的存储格式。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 内嵌文档类型的文档格式（<span class="number">6</span><span class="number">-9</span>行）</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot; : ObjectId(&quot;5de92bda1bc9accea9a2315e&quot;),</span><br><span class="line">    &quot;name&quot; : &quot;mongo&quot;,</span><br><span class="line">    &quot;price&quot; : <span class="number">50.0</span>,</span><br><span class="line">    &quot;size&quot; : &#123;</span><br><span class="line">        &quot;h&quot; : <span class="number">8.5</span>,</span><br><span class="line">        &quot;w&quot; : <span class="number">11.0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;reading&quot; : [ </span><br><span class="line">        &quot;John&quot;, </span><br><span class="line">        &quot;Dave&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Code类型"><a href="#Code类型" class="headerlink" title="Code类型"></a>Code类型</h5><p>在MongoDB数据库的文档中，可以存储一些JavaScript方法，这些方法可以重复使用\</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Code类型的文档格式如下。</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot; : ObjectId(&quot;5de92fdd1bc9accea9a23161&quot;),</span><br><span class="line">    &quot;jscode&quot; : <span class="keyword">function</span> jsCode(a)&#123; b<span class="operator">=</span>a<span class="operator">+</span><span class="number">2</span>;<span class="keyword">return</span> b;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-数据类型"><a href="#5-数据类型" class="headerlink" title="5. 数据类型"></a>5. 数据类型</h4><p>BSON数据类型参考列表：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/b59b23c99029963b36c3458e79261da4png.jpg"></p>
<p><strong>提示</strong>：<br><strong>shell默认使用64位浮点型数值。</strong>{“x”:3.14或{“x”:3}。对于整型值，可以使用NumberInt（4字节符号整数）或 NumberLong（8字节符号整数），{“x”:NumberInt(“3” ){“x”:NumberLong(“3”)}</p>
<h4 id="6-特点"><a href="#6-特点" class="headerlink" title="6. 特点"></a>6. 特点</h4><ol>
<li>高性能<br>MongoDB提供高性能的数据持久性。特别是，</li>
</ol>
<p>对嵌入式数据模型的支持减少了数据库系统上I&#x2F;O活动。</p>
<p>索引支持更快的查询，并且可以包含来自嵌入式文档和数组的键。（文本索引解决搜索的需求、TTL索引解决历史数据自动过期的需求、地理位置索引可用于构建各种O2O应用）</p>
<p>mmapv1、 wiredtiger、 mongorocks（ rocks）、 In-memory等多引擎支持满足各种场景需求</p>
<p>Gridfs解决文件存储的需求</p>
<ol start="2">
<li><p>高可用性<br>MongoDB的复制工具称为副本集（ replica set），它可提供自动故障转移和数据冗余</p>
</li>
<li><p>高扩展性<br>MongoDB提供了水平可扩展性作为其核心功能的一部分。</p>
</li>
</ol>
<p>分片将数据分布在一组集群的机器上。（海量数据存储，服务能力水平扩展）</p>
<p>从3.4开始，MoηgoDB支持基于片键创建数据区域。在一个平衡的集群中， MongoDB将一个区域所覆盖的读写只定向到该区域内的那些片。</p>
<ol start="4">
<li><p>丰富的查询支持<br>MongoDB支持丰富的査询语言，支持读和写操作（CRUD），比如数据聚合、文本搜索和地理空间查询等</p>
</li>
<li><p>其他特点</p>
</li>
</ol>
<p>如无模式（动态模式）、灵活的文档模型</p>
<h2 id="二、Windows安装-启动-连接"><a href="#二、Windows安装-启动-连接" class="headerlink" title="二、Windows安装&amp;启动&amp;连接"></a>二、Windows安装&amp;启动&amp;连接</h2><h4 id="1-下载压缩包"><a href="#1-下载压缩包" class="headerlink" title="1. 下载压缩包"></a>1. 下载压缩包</h4><p>下载地址：<a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/community">https://www.mongodb.com/try/download/community</a></p>
<p>这里以zip的格式进行下载<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/941a3d4d0f624898426033d8ea8d178bpng.jpg"></p>
<p>附加：mongodb的命名格式: x.y.z</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- y为奇数表示当前版本为开发版,如:1.5.2、4.1.13</span><br><span class="line">- y为偶数表示当前版本为稳定版,如:1.6.3、4.0.10</span><br><span class="line">- z为修正版本号,越大越好</span><br></pre></td></tr></table></figure>

<h4 id="2-解压"><a href="#2-解压" class="headerlink" title="2. 解压"></a>2. 解压</h4><p>下载完成后得到压缩包，解压；其中的bin目录就存放着mongodb相关的命令<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d144a434cf9abef4940c0270b53a3a3apng.jpg"></p>
<h4 id="3-安装服务"><a href="#3-安装服务" class="headerlink" title="3. 安装服务"></a>3. 安装服务</h4><p>首先要在安装目录里创建两个目录：</p>
<ul>
<li>数据目录：data</li>
<li>日志目录：logs<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/dc49dfa1444b4dd4a2896dcc182bfe02png.jpg"></li>
</ul>
<p>然后以管理员模式，切换到安装目录下的bin目录运行以下格式命令来指定mongdb的数据及日志目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --install --dbpath 数据目录 --logpath 日志目录\日志名称 </span><br></pre></td></tr></table></figure>

<p>注意整个文件的路径中不能包含中文，中文，中文！踩过坑！</p>
<p>具体的代码为如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --install --dbpath D:\JAVA_Environment\MongoDB\mongodb-win32-x86_64-windows-4.4.2\data --logpath D:\JAVA_Environment\MongoDB\mongodb-win32-x86_64-windows-4.4.2\logs\mongodb.log</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/512b6bb09202cc9985b7785d86fa5f50png.jpg"></p>
<p>没有任何报错和提示，则代表MongoDB服务创建成功</p>
<p>我们可以进行验证，win+r输入<code>services.msc</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/4048f443ad6e4e43a1eb6b230155062cpng.jpg"></p>
<p>看到MongoDB服务即成功</p>
<p>补充一下：如果想要删除MongoDB服务的话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SC DELETE MongoDB</span><br></pre></td></tr></table></figure>

<h4 id="4-启动服务"><a href="#4-启动服务" class="headerlink" title="4. 启动服务"></a>4. 启动服务</h4><p>输入以下命令启动服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net start mongodb</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/c332ad01f68a58968389fbe8ee407a82png.jpg"><br>输入<code>http://localhost:27017/</code>如果看到以下内容,代表启动成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d0602bb14efcd6597b2e5c74c1c1919fpng.jpg"></p>
<h4 id="5-shell连接登录-退出"><a href="#5-shell连接登录-退出" class="headerlink" title="5. shell连接登录&amp;退出"></a>5. shell连接登录&amp;退出</h4><p>输入以下命令进行登录与退出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#登录</span><br><span class="line">mongo</span><br><span class="line">mongo --host=localhost --port=27017</span><br><span class="line"></span><br><span class="line">#退出</span><br><span class="line">exit	</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/f22cb9ca91088120d6f8c9a6e08e3518png.jpg"></p>
<p><strong>相关语法</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mongod --install --dbpath 数据目录 --logpath 日志目录\日志名称	#创建服务</span><br><span class="line">mongod --remove	    #卸载服务		</span><br><span class="line">net start mongodb	#启动服务</span><br><span class="line">net stop mongodb	#关闭服务</span><br><span class="line">mongod #是处理MongoDB系统的主要进程。它处理数据请求，管理数据存储，和执行后台管理操作。当我们运行mongod命令意味着正在启动MongoDB进程,并且在后台运行。</span><br></pre></td></tr></table></figure>

<h4 id="6-Compass图形化连接登录"><a href="#6-Compass图形化连接登录" class="headerlink" title="6. Compass图形化连接登录"></a>6. Compass图形化连接登录</h4><p>MongoDB的GUI。直观地浏览您的数据。在几秒钟内运行查询。借助完整的CRUD功能与您的数据进行交互。查看和优化您的查询性能。在Linux，Mac或Windows上可用。Compass使您能够做出更明智的索引，文档验证等决策。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d3e5e683a7d170a026d659b18343d5dapng.jpg"></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/compass">https://www.mongodb.com/try/download/compass</a></p>
<p>点击<code>Download</code>下载即可，下载完成后得到压缩包<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/4609f3c088603a78843b4e240999a61epng.jpg"></p>
<p>解压，可以看到<code>MongoDBCompass.exe</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2006e6d9d96ddce34105714b8b244be4png.jpg"></p>
<p>双击运行，直接Next，最后Get Stated，默认选项即可<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d841d39eb4319f3b3dcd85a2e096fcb2png.jpg"></p>
<p>然后直接点击CONNECT就会连接本地的数据库<code>localhost:27017</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/21b32e24f4b27b4c8e26606929709e28png.jpg"></p>
<p>可以看到所有的数据库及相关信息<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/6fdb2be5ed04cc4a2e888f9c64746da8png.jpg"></p>
<h2 id="三、Linux安装-启动-连接"><a href="#三、Linux安装-启动-连接" class="headerlink" title="三、Linux安装&amp;启动&amp;连接"></a>三、Linux安装&amp;启动&amp;连接</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">mkdir module</span><br><span class="line">cd module</span><br><span class="line">mkdir mongodb</span><br><span class="line">cd mongodb</span><br><span class="line"></span><br><span class="line">rm -rf /path/to/directory 强制删除文件</span><br></pre></td></tr></table></figure>

<ol>
<li><p>传输、解压、移动安装包</p>
<p>(1). 打开Linux虚拟机并通过<strong>传输工具WinSCP</strong>连接Linux平台，并存储在CentOS中的 &#x2F;opt&#x2F; 路径下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel80-4.4.24.tgz</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204092222228.png" alt="image-20220409222236952"></p>
<p>(2). 在Xshell中执行<code>tar -zxvf mongodb-linux-x86_64-rhel80-4.4.24.tgz</code>命令，解压tgz包。</p>
<p>(3). 执行<code>mv mongodb-linux-x86_64-rhel80-4.4.24/* /opt/module/mongodb</code>,移动解压后的文件夹到<code>/usr/local/mongodb</code></p>
</li>
<li><p>新建并修改配置文件</p>
<p>(1). 新建几个目录，分别用来存储数据和日志。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 数据存储目录</span></span><br><span class="line">[root@localhost mongodb]# <span class="built_in">mkdir</span> -p shihanshuo/data/db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志存储目录</span></span><br><span class="line">[root@localhost mongodb]# <span class="built_in">mkdir</span> -p shihanshuo/logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建日志文件</span></span><br><span class="line">[root@localhost mongodb]# <span class="built_in">touch</span> shihanshuo/logs/mongologs.log</span><br></pre></td></tr></table></figure>

<p>(2). 新建并修改配置文件 <code>vi shihanshuo/mongod.conf</code><br>按键盘 i 键或者insert键，进入编辑（插入）模式，在文件中写入以下内容	</p>
<p>配置文件的内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件 </span></span><br><span class="line">  <span class="comment">##The path of the log file to which mongod or mongos should send all diagnostic logging information</span></span><br><span class="line">  destination: file </span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径 </span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/shihanshuo/logs/mongologs.log&quot;</span> </span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。 </span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。 </span></span><br><span class="line">  <span class="comment">##The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;. </span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/shihanshuo/data/db&quot;</span> </span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。 </span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。 </span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定的IP，默认是localhost </span></span><br><span class="line">  bindIp: localhost,192.168.24.105</span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口，默认是27017 </span></span><br><span class="line">  port: 27017</span><br></pre></td></tr></table></figure>

<p>复制后，按键盘 Esc 键，退出编辑模式，然后键盘组合键 Shift + ：键，输入wq写保存。</p>
<blockquote>
<p>wq：写保存</p>
<p>q：退出</p>
<p>wq！：强制写保存</p>
<p>q！：强制退出</p>
</blockquote>
</li>
<li><p>设置环境变量，使用mongo命令启动服务</p>
<p>(1). 由于Mongodb的相关服务均放在解压后&#x2F;mongodb&#x2F;bin路径下，若想启动服务，必须在bin目录下启动。因此为了避免启动之前需要进入到该路径，我们配置用户的环境变量即可</p>
<p>(2). 执行<code>vi /etc/profile</code>命令，编辑用户环境变量文件。找到export字段在其下方添加代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> MONGODB_HOME=/opt/module/mongodb</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$MONGODB_HOME</span>/bin</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204092223709.png" alt="image-20220409222310519"></p>
<p>(3). 添加并wq写保存</p>
<p>(4). 执行<code>source /etc/profile</code>命令，初始化用户环境变量。</p>
<p>在任意路径下，即可执行<code>mongod -f /opt/module/mongodb/shihanshuo/mongod.conf</code>启动服务mongo连接到服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mongodb]# vi /etc/profile</span><br><span class="line">[root@localhost mongodb]# <span class="built_in">source</span> /etc/profile</span><br><span class="line">[root@localhost mongodb]# <span class="built_in">cd</span></span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/standalone/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8075</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动和关闭MongoDB服务</p>
<p>(1). 执行<code>ps -ef|grep mongod</code>查看服务进程。</p>
<p>(2). 确保mongodb服务启动后，使用客户端连接远程数据库服务器在终端执行 <code>mongo --host=192.168.24.105</code>然后执行<code>show dbs</code>查看当前数据库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongo --host=192.168.24.105</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://192.168.24.105:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;43fc9a44-2f87-443c-9b57-eb55d50aace3&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Welcome to the MongoDB shell.</span><br><span class="line">For interactive <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">For more comprehensive documentation, see</span><br><span class="line"> https://docs.mongodb.com/</span><br><span class="line">Questions? Try the MongoDB Developer Community Forums</span><br><span class="line"> https://community.mongodb.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line"><span class="built_in">local</span>   0.000GB</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>

<p>(3). 执行exit退出mongo shell，执行<code>kill -2 8075</code>结束mongodb服务的进程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line"><span class="built_in">local</span>   0.000GB</span><br><span class="line">&gt; <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">bye</span></span><br><span class="line">[root@Server01 ~]# ps -ef|grep mongod</span><br><span class="line">root        8607       1  0 23:26 ?        00:00:00 mongod -f /usr/local/mongodb/standalone/mongod.conf</span><br><span class="line">root        8664    3744  0 23:27 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@Server01 ~]# <span class="built_in">kill</span> -2 8607</span><br><span class="line">[root@Server01 ~]# ps -ef|grep mongod</span><br><span class="line">root        8674    3744  0 23:27 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@Server01 ~]# </span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="启动报错的解决："><a href="#启动报错的解决：" class="headerlink" title="启动报错的解决："></a>启动报错的解决：</h4><ul>
<li>报错一：ERROR: child process failed, exited with error number 48</li>
</ul>
<p>解决方案：通过mongod –repair检查具体错误。</p>
<p>原来是端口冲突。删除前面没执行成功的文件，然后修改XXX.conf配置文件。将其中端口号改为27016后。重新执行后成功。</p>
<p>如果启动后没有关闭，再起启动也会报错48.则可以先使用关闭命令关闭，然后再次启动。</p>
<ul>
<li>报错二：-bash: &#x2F;usr&#x2F;local&#x2F;mongodb6&#x2F;bin&#x2F;mongod: Permission denied</li>
</ul>
<p>启动的时候报错了，是因为没权限访问该文件</p>
<p>解决方案：给mongodb文件夹分配最高权限</p>
<blockquote>
<p>sudo chmod -R 777 &#x2F;usr&#x2F;local&#x2F;mongodb</p>
</blockquote>
<p>-R 是指级联应用到目录里的所有子目录和文件<br>777 是所有用户拥有的最高权限</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/869dc882da8ccf90c540b4ca5ec635b3png.jpg"></p>
<ul>
<li>centOS启动mongoDB错误：.&#x2F;mongod: error while loading shared libraries: libcrypto.so.10: cannot open share</li>
</ul>
<p>[root]# rpm -qa  | grep libcrypto.so<br>[root]# rpm -qa  | grep libcrypt<br>[root]# dnf install compat-openssl10</p>
<ul>
<li>-conf 使用配置文件方式启动</li>
</ul>
<p>我们发现启动失败，出现这种情况我们编辑用户级配置文件   vim  ~&#x2F;.bashrc</p>
<p>添加配置信息： export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin:$PATH    （中间那部分就是你的安装目录下的bin）</p>
<p>wq保存退出</p>
<p>然后刷新：source ~&#x2F;.bashrc</p>
<p>再次启动</p>
<h4 id="6-Compass图形化连接登录-1"><a href="#6-Compass图形化连接登录-1" class="headerlink" title="6. Compass图形化连接登录"></a>6. Compass图形化连接登录</h4><p>利用Compass进行连接，Hostname为服务器的公网IP，其他默认</p>
<p>连接失败的原因：</p>
<ol>
<li>未打开安全组策略</li>
</ol>
<p>暴露给外部的端口需要打开对应的安全组设置</p>
<ol start="2">
<li>防火墙开放端口未设置</li>
</ol>
<p>首先查看防火墙是否开启，结果为not running表示未开启，则不是防火墙的问题，跳过</p>
<h4 id="查看防火墙是否开启"><a href="#查看防火墙是否开启" class="headerlink" title="查看防火墙是否开启"></a>查看防火墙是否开启</h4><p>firewall-cmd –state</p>
<p>如果显示running，则继续排查，查看防火墙开放的端口</p>
<h4 id="查看防火墙所开放的端口"><a href="#查看防火墙所开放的端口" class="headerlink" title="查看防火墙所开放的端口"></a>查看防火墙所开放的端口</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --list-ports</span><br><span class="line"></span><br><span class="line">[root@zsr ~]# firewall-cmd --list-ports</span><br><span class="line">20/tcp 21/tcp 22/tcp 80/tcp 8888/tcp 39000-40000/tcp 3306/tcp 3306/udp 8080/tcp 8080/udp 3355/tcp</span><br></pre></td></tr></table></figure>

<p>也可以用firewall-cmd –list-all查看防火墙的详细信息</p>
<p>我这里的问题就是防火墙未开放27017端口，所以要开放防火墙的对外暴露的端口</p>
<h4 id="开放90端口-–premanent表示永久添加"><a href="#开放90端口-–premanent表示永久添加" class="headerlink" title="开放90端口(–premanent表示永久添加)"></a>开放90端口(–premanent表示永久添加)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=27017/tcp</span><br></pre></td></tr></table></figure>

<h4 id="重启防火墙-修改配置后要重启防火墙"><a href="#重启防火墙-修改配置后要重启防火墙" class="headerlink" title="重启防火墙(修改配置后要重启防火墙)"></a>重启防火墙(修改配置后要重启防火墙)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>添加完成后再次查看就可以看到27017端口被开放</p>
<h2 id="四、基本常用命令"><a href="#四、基本常用命令" class="headerlink" title="四、基本常用命令"></a>四、基本常用命令</h2><h3 id="1-数据库相关"><a href="#1-数据库相关" class="headerlink" title="1. 数据库相关"></a>1. 数据库相关</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有数据库</span></span><br><span class="line">show databases</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选择数据库(如果数据库不存在,不会报错;会隐式创建:当后期该数据库有数据时自动创建)</span></span><br><span class="line">use 数据库名</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前正在使用的数据库命令:</span></span><br><span class="line">db</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除数据库(先选中数据库)</span></span><br><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>

<h3 id="2-集合相关"><a href="#2-集合相关" class="headerlink" title="2. 集合相关"></a>2. 集合相关</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有集合</span></span><br><span class="line">show collections</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建集合(插入数据会隐式创建)</span></span><br><span class="line">db.createCollection(&#x27;集合名&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除集合</span></span><br><span class="line">db.集合名.drop()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、CURD"><a href="#五、CURD" class="headerlink" title="五、CURD"></a>五、CURD</h2><h3 id="增：插入文档"><a href="#增：插入文档" class="headerlink" title="增：插入文档"></a>增：插入文档</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.集合名.insert(json数据)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>集合存在则直接插入数据，不存在则隐式创建集合并插入数据</p>
</li>
<li><p>json数据格式要求key得加<code>&quot;&quot;</code>，但这里为了方便查看，对象的key统一不加<code>&quot;&quot;</code>；查看集合数据时系统会自动给key加<code>&quot;&quot;</code></p>
</li>
<li><p>mongodb会自动给每条数据创建全球唯一的<code>_id</code>键（我们也可以自定义<code>_id</code>的值，只要给插入的json数据增加<code>_id</code>键即可覆盖，但是不推荐这样做）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/071e693b1b1e5df7bc74494e673b5c52png.jpg" alt="img"></p>
</li>
</ul>
<p><strong>测试</strong>：</p>
<blockquote>
<p>插入一条数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.student.insert(&#123;name:&quot;shs&quot;,age:20&#125;)</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/368195d2422d2bb77dc94c6d28eaa521png.jpg" alt="image-20210222235515711"></p>
<blockquote>
<p>一次插入多条数据并指定<code>_id</code></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.stuent.insert([&#123;_id:1,namme:&quot;z&quot;,age:20&#125;,&#123;_id:2,namme:&quot;x&quot;,age:21&#125;,&#123;_id:3,namme:&quot;c&quot;,age:23&#125;])</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/117a0ebfb4aa9a97098d8bdf7eccb9d0png.jpg" alt="image-20210223000501376"></p>
<blockquote>
<p>批量插入多条文章评论：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insertMany([ </span><br><span class="line">    &#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:<span class="keyword">new</span> <span class="type">Date</span>(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(<span class="number">1000</span>),&quot;state&quot;:&quot;1&quot;&#125;, </span><br><span class="line">    &#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:<span class="keyword">new</span> <span class="type">Date</span>(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(<span class="number">888</span>),&quot;state&quot;:&quot;1&quot;&#125;, </span><br><span class="line">    &#123;&quot;_id&quot;:&quot;3&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我一直喝凉开水，冬天夏天都喝。&quot;,&quot;userid&quot;:&quot;1004&quot;,&quot;nickname&quot;:&quot;杰克船长&quot;,&quot;createdatetime&quot;:<span class="keyword">new</span> <span class="type">Date</span>(&quot;2019-08-06T01:05:06.321Z&quot;),&quot;likenum&quot;:NumberInt(<span class="number">666</span>),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p><strong>提示：</strong><br>插入时指定了 _id ，则主键就是该值。</p>
<p>如果某条数据插入失败，将会终止插入，但已经插入成功的数据不会回滚掉。</p>
<p>因为批量插入由于数据较多容易出现失败，因此，<strong>可以使用try catch进行异常捕捉处理</strong>，测试的时候可以不处理。如（掌握）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">try &#123; </span><br><span class="line">db.comment.insertMany([ </span><br><span class="line">    &#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:<span class="keyword">new</span> <span class="type">Date</span>(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(<span class="number">1000</span>),&quot;state&quot;:&quot;1&quot;&#125;, </span><br><span class="line">    &#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:<span class="keyword">new</span> <span class="type">Date</span>(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(<span class="number">888</span>),&quot;state&quot;:&quot;1&quot;&#125;, </span><br><span class="line">    &#123;&quot;_id&quot;:&quot;3&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我一直喝凉开水，冬天夏天都喝。&quot;,&quot;userid&quot;:&quot;1004&quot;,&quot;nickname&quot;:&quot;杰克船长&quot;,&quot;createdatetime&quot;:<span class="keyword">new</span> <span class="type">Date</span>(&quot;2019-08-06T01:05:06.321Z&quot;),&quot;likenum&quot;:NumberInt(<span class="number">666</span>),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">]);</span><br><span class="line">&#125; catch (e) &#123; </span><br><span class="line">    print (e); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>利用for循环插入数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for(var i=1;i&lt;10;i++)&#123;</span><br><span class="line">	db.student.insert(&#123;name:&quot;a&quot;+i,age:i&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/a3caeed5df33c5108928b9deb48a5415png.jpg" alt="image-20210223001002189"></p>
<hr>
<h3 id="删：删除文档"><a href="#删：删除文档" class="headerlink" title="删：删除文档"></a>删：删除文档</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.集合名.remove(条件 [,是否删除一条])</span><br><span class="line"></span><br><span class="line">db.student.remove(&#123;&#125;,true)</span><br><span class="line">db.student.remove(&#123;&#125;,false)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否删除一条</span></span><br><span class="line">- false删除多条,即全部删除(默认)</span><br><span class="line">- true删除一条</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/6b7c90c5ba72b3dcc9ae23ded8997ea1png.jpg" alt="image-20210223132359528"></p>
<hr>
<h3 id="改：修改文档"><a href="#改：修改文档" class="headerlink" title="改：修改文档"></a>改：修改文档</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.集合名.update(条件, 新数据 [,是否新增, 是否修改多条])</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新数据</span></span><br><span class="line">- 默认是对原数据进行替换</span><br><span class="line">- 若要进行修改,格式为 &#123;修改器:&#123;key:value&#125;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否新增</span></span><br><span class="line">- 条件匹配不到数据时是否插入: true插入,false不插入(默认)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否修改多条</span></span><br><span class="line">- 条件匹配成功的数据是否都修改: true都修改,false只修改一条(默认)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><strong>修改器</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td>$inc</td>
<td>递增</td>
</tr>
<tr>
<td>$rename</td>
<td>重命名列</td>
</tr>
<tr>
<td>$set</td>
<td>修改列值</td>
</tr>
<tr>
<td>$unset</td>
<td>删除列</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>准备工作</strong>：插入十条数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for(var i=1;i&lt;=10;i++)&#123;</span><br><span class="line">	db.people.insert(&#123;name:&quot;zsr&quot;+i,age:i&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/7220d213e780b3597633c6e6bf77e1f8png.jpg" alt="image-20210223100253776"></p>
<blockquote>
<p>将{name:“zsr1”}更改为{name:“zsr2”}</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.people.update(&#123;name:&quot;zsr1&quot;&#125;,&#123;name:&quot;zsr2&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>发现问题</strong>：默认不是修改而是替换<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1b0d9cfc4f7c17f423eba611bb9f3380png.jpg" alt="image-20210223101214051"></p>
<p><strong>解决问题</strong>：使用修改器将{name:“zsr3”}更改为{name:“zsr3333”}</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.people.update(&#123;name:&quot;zsr3&quot;&#125;,&#123;$set:&#123;name:&quot;zsr3333&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/9081652dc177046bda5aae02967b4e9fpng.jpg" alt="image-20210223102308690"></p>
<blockquote>
<p>给{name:“zsr10”}的年龄增加或减少2岁</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">增加两岁</span></span><br><span class="line">db.people.update(&#123;name:&quot;zsr10&quot;&#125;,&#123;$inc:&#123;age:2&#125;&#125;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">减少两岁</span></span><br><span class="line">db.people.update(&#123;name:&quot;zsr10&quot;&#125;,&#123;$inc:&#123;age:-2&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/5e50cba50bcf5dde2acd945669c74f3apng.jpg" alt="image-20210223130651064"></p>
<blockquote>
<p>一次写多个修改器</p>
</blockquote>
<p>首先插入一条数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.people.insert(&#123;username:&quot;gcc&quot;,age:20,sex:&quot;女&quot;,address:&quot;unknown&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>任务：修改gcc的username为bareth，age+11，sex字段重命名为sexuality，删除address字段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.people.update(&#123;username:&quot;gcc&quot;&#125;,&#123;</span><br><span class="line"><span class="meta prompt_">	$</span><span class="language-bash"><span class="built_in">set</span>:&#123;username:<span class="string">&quot;bareth&quot;</span>&#125;,</span></span><br><span class="line"><span class="meta prompt_">	$</span><span class="language-bash">inc:&#123;age:11&#125;,</span></span><br><span class="line"><span class="meta prompt_">	$</span><span class="language-bash">rename:&#123;sex:<span class="string">&quot;sexuality&quot;</span>&#125;,</span></span><br><span class="line"><span class="meta prompt_">	$</span><span class="language-bash"><span class="built_in">unset</span>:&#123;address:<span class="literal">true</span>&#125;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/be625c8f58206a3c11ff27cb05c014b7png.jpg" alt="image-20210223131538737"></p>
<hr>
<h3 id="查：查询文档"><a href="#查：查询文档" class="headerlink" title="查：查询文档"></a>查：查询文档</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.集合名.find(条件 [,查询的列])</span><br><span class="line">db.集合名.find(条件 [,查询的列]).pretty()	#格式化查看</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">条件</span></span><br><span class="line">- 查询所有数据	&#123;&#125;或不写</span><br><span class="line">- 查询指定要求数据	&#123;key:value&#125;或&#123;key:&#123;运算符:value&#125;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询的列(可选参数)</span></span><br><span class="line">- 不写则查询全部列</span><br><span class="line">- &#123;key:1&#125;	只显示key列</span><br><span class="line">- &#123;key:0&#125;	除了key列都显示</span><br><span class="line">- 注意:_id列都会存在</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><strong>运算符</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td>$gt</td>
<td>大于</td>
</tr>
<tr>
<td>$gte</td>
<td>大于等于</td>
</tr>
<tr>
<td>$lt</td>
<td>小于</td>
</tr>
<tr>
<td>$lte</td>
<td>小于等于</td>
</tr>
<tr>
<td>$ne</td>
<td>不等于</td>
</tr>
<tr>
<td>$in</td>
<td>in</td>
</tr>
<tr>
<td>$nin</td>
<td>not in</td>
</tr>
</tbody></table>
<blockquote>
<p>查询指定列的所有数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.student.find(&#123;&#125;,&#123;name:1&#125;) 只查询name列</span><br><span class="line"></span><br><span class="line">db.student.find(&#123;&#125;,&#123;name:0&#125;) 查询除了name列以外的列</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/c0d5a5e1c06b90d501c8d7b7c5226ec1png.jpg" alt="image-20210223093306196"></p>
<blockquote>
<p>查询指定条件的数据</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d1de59de358ffe6306866ec2f5313a1bpng.jpg" alt="image-20210223094819105"></p>
<h4 id="统计查询"><a href="#统计查询" class="headerlink" title="统计查询"></a>统计查询</h4><p>使用count()方法</p>
<p>【示例】<br>（1）统计所有记录数：<br>统计comment集合的所有的记录数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count()</span><br></pre></td></tr></table></figure>

<p>（2）按条件统计记录数：<br>例如：统计userid为1003的记录条数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count(&#123;userid:1003&#125;)</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="六、排序-分页-复杂查询"><a href="#六、排序-分页-复杂查询" class="headerlink" title="六、排序&amp;分页&amp;复杂查询"></a>六、排序&amp;分页&amp;复杂查询</h2><p><strong>数据准备</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for(var i=1;i&lt;5;i++)&#123;</span><br><span class="line">	db.person.insert(&#123;_id:i,name:&quot;p&quot;+i,age:10+i&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/93f33c5caa4d6cedd6bc15f1d76f7ed6png.jpg" alt="image-20210301134521650"></p>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.集合名.find().sort(json数据)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">json数据(key:value)</span></span><br><span class="line">- key就是要排序的字段</span><br><span class="line">- value为1表示升序,-1表示降序</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.people.find().sort(&#123;age:-1&#125;)  按年龄降序排列  </span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/9861baa97b9dd0c67065f3f85ca9f751png.jpg" alt="image-20210223183828304"></p>
<hr>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.集合名.find().sort().skip(数字).limit(数字)[.count()]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">skip(数字)</span></span><br><span class="line">- 指定跳过的数量(可选)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">limit</span>(数字)</span></span><br><span class="line">- 限制查询的数量</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">count()</span></span><br><span class="line">- 统计数量</span><br></pre></td></tr></table></figure>

<p>测试：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d312de8b7aa1b47d56f6c5b6847b830bpng.jpg" alt="image-20210223184455261"></p>
<p><strong>实战</strong>：数据库有1~10条数据，每页显示2条，一共5页</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">skip计算公式: (当前页-1)*每页显示的条数</span><br><span class="line"></span><br><span class="line">页数 起始 终止 跳过数</span><br><span class="line">1页	1	2	0</span><br><span class="line">2页	3	4	2</span><br><span class="line">3页	5	6	4</span><br><span class="line">4页	7	8	6</span><br><span class="line">5页	9	10	8</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据准备</span></span><br><span class="line">for(var i=1;i&lt;11;i++)&#123;</span><br><span class="line">	db.page.insert(&#123;_id:i,name:&quot;p&quot;+i&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分5页,每页2条显示</span></span><br><span class="line">for(var i=0;i&lt;10;i=i+2)&#123;</span><br><span class="line">	db.page.find().skip(i).limit(2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="复杂查询"><a href="#复杂查询" class="headerlink" title="复杂查询"></a>复杂查询</h3><h4 id="文档的正则复杂条件查询"><a href="#文档的正则复杂条件查询" class="headerlink" title="文档的正则复杂条件查询"></a>文档的正则复杂条件查询</h4><p>MongoDB的模糊查询是通过正则表达式的方式实现的。格式为：</p>
<p> <code>db.collection.find(&#123;field:/正则表达式/&#125;)</code> </p>
<p>或</p>
<p><code>db.集合.find(&#123;字段:/正则表达式/&#125;)</code>	</p>
<p>提示：正则表达式是js的语法，直接量的写法。</p>
<p>例如，我要查询评论内容包含“开水”的所有文档，代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;content:<span class="operator">/</span>开水<span class="operator">/</span>&#125;)</span><br></pre></td></tr></table></figure>


<p>如果要查询评论的内容中以“专家”开头的，代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;content:<span class="operator">/</span><span class="operator">^</span>专家<span class="operator">/</span>&#125;)</span><br></pre></td></tr></table></figure>


<h4 id="文档的比较查询"><a href="#文档的比较查询" class="headerlink" title="文档的比较查询"></a>文档的比较查询</h4><p><strong>&lt;, &lt;&#x3D;, &gt;, &gt;&#x3D; 这个操作符也是很常用的</strong>，格式如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gt: value &#125;&#125;) // 大于: field &gt; value </span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lt: value &#125;&#125;) // 小于: field &lt; value </span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gte: value &#125;&#125;) // 大于等于: field &gt;= value </span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lte: value &#125;&#125;) // 小于等于: field &lt;= value </span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $ne: value &#125;&#125;) // 不等于: field != value</span><br></pre></td></tr></table></figure>
<p>示例：查询评论点赞数量大于700的记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;likenum:&#123;$gt:NumberInt(<span class="number">700</span>)&#125;&#125;)</span><br></pre></td></tr></table></figure>


<h4 id="文档的包含查询"><a href="#文档的包含查询" class="headerlink" title="文档的包含查询"></a>文档的包含查询</h4><p>包含使用$in操作符。 示例：查询评论的集合中userid字段包含1003或1004的文档</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#123;$<span class="keyword">in</span>:[&quot;1003&quot;,&quot;1004&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>


<p>不包含使用$nin操作符。 示例：查询评论集合中userid字段不包含1003和1004的文档</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#123;$nin:[&quot;1003&quot;,&quot;1004&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>


<h4 id="文档的条件连接查询"><a href="#文档的条件连接查询" class="headerlink" title="文档的条件连接查询"></a>文档的条件连接查询</h4><p>我们如果需要<strong>查询同时满足两个以上条件，需要使用$and操作符将条件进行关联</strong>。（相当于SQL的and）格式为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">and:[ &#123; &#125;,&#123; &#125;,&#123; &#125; ]</span></span><br></pre></td></tr></table></figure>
<p>示例：查询评论集合中likenum大于等于700 并且小于2000的文档：　</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;$<span class="keyword">and</span>:[&#123;likenum:&#123;$gte:NumberInt(<span class="number">700</span>)&#125;&#125;,&#123;likenum:&#123;$lt:NumberInt(<span class="number">2000</span>)&#125;&#125;]&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204092231702.png" alt="image-20220409223159485"></p>
<p>如果<strong>两个以上条件之间是或者的关系，我们使用操作符进行关联</strong>，与前面and的使用方式相同格式为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">or:[ &#123; &#125;,&#123; &#125;,&#123; &#125; ]</span></span><br></pre></td></tr></table></figure>
<p>示例：查询评论集合中userid为1003，或者点赞数小于1000的文档记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;$<span class="keyword">or</span>:[ &#123;userid:&quot;1003&quot;&#125; ,&#123;likenum:&#123;$lt:<span class="number">1000</span>&#125; &#125;]&#125;)</span><br></pre></td></tr></table></figure>


<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">选择切换数据库：use articledb </span><br><span class="line"></span><br><span class="line">插入数据：db.comment.insert(&#123;bson数据&#125;) </span><br><span class="line"></span><br><span class="line">查询所有数据：db.comment.find(); </span><br><span class="line"></span><br><span class="line">条件查询数据：db.comment.find(&#123;条件&#125;) </span><br><span class="line"></span><br><span class="line">查询符合条件的第一条记录：db.comment.findOne(&#123;条件&#125;) </span><br><span class="line"></span><br><span class="line">查询符合条件的前几条记录：db.comment.find(&#123;条件&#125;).limit(条数) </span><br><span class="line"></span><br><span class="line">查询符合条件的跳过的记录：db.comment.find(&#123;条件&#125;).skip(条数) </span><br><span class="line"></span><br><span class="line">修改数据：db.comment.update(&#123;条件&#125;,&#123;修改后的数据&#125;) 或db.comment.update(&#123;条件&#125;,&#123;$set:&#123;要修改部分的字段:数据&#125;) </span><br><span class="line"></span><br><span class="line">修改数据并自增某字段值：db.comment.update(&#123;条件&#125;,&#123;$inc:&#123;自增的字段:步进值&#125;&#125;) </span><br><span class="line"></span><br><span class="line">删除数据：db.comment.remove(&#123;条件&#125;) </span><br><span class="line"></span><br><span class="line">统计查询：db.comment.count(&#123;条件&#125;) </span><br><span class="line"></span><br><span class="line">模糊查询：db.comment.find(&#123;字段名:/正则表达式/&#125;) </span><br><span class="line"></span><br><span class="line">条件比较运算：db.comment.find(&#123;字段名:&#123;$gt:值&#125;&#125;) </span><br><span class="line"></span><br><span class="line">包含查询：db.comment.find(&#123;字段名:&#123;$in:[值1，值2]&#125;&#125;)或db.comment.find(&#123;字段名:&#123;$nin:[值1，值2]&#125;&#125;) </span><br><span class="line">条件连接查询：db.comment.find(&#123;$and:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)或db.comment.find(&#123;$or:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="七、聚合查询"><a href="#七、聚合查询" class="headerlink" title="七、聚合查询"></a>七、聚合查询</h2><h3 id="1-语法"><a href="#1-语法" class="headerlink" title="1. 语法"></a>1. 语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.集合名.aggregate([</span><br><span class="line">	&#123;管道:&#123;表达式&#125;&#125;</span><br><span class="line">	...</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p><strong>常用管道</strong>：</p>
<table>
<thead>
<tr>
<th>$group</th>
<th>将集合中的文档分组，用于统计结果</th>
</tr>
</thead>
<tbody><tr>
<td>$match</td>
<td>过滤数据，只输出符合条件的文档</td>
</tr>
<tr>
<td>$sort</td>
<td>聚合数据进一步排序</td>
</tr>
<tr>
<td>$skip</td>
<td>跳过指定文档数</td>
</tr>
<tr>
<td>$limit</td>
<td>限制集合数据返回文档数</td>
</tr>
</tbody></table>
<p><strong>常用表达式</strong>：</p>
<table>
<thead>
<tr>
<th>$sum</th>
<th>总和（$num:1同count表示统计）</th>
</tr>
</thead>
<tbody><tr>
<td>$avg</td>
<td>平均</td>
</tr>
<tr>
<td>$min</td>
<td>最小值</td>
</tr>
<tr>
<td>$max</td>
<td>最大值</td>
</tr>
</tbody></table>
<hr>
<h3 id="2-测试"><a href="#2-测试" class="headerlink" title="2. 测试"></a>2. 测试</h3><p>数据准备：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.people.insert(&#123;_id:1,name:&quot;a&quot;,sex:&quot;男&quot;,age:21&#125;)</span><br><span class="line">db.people.insert(&#123;_id:2,name:&quot;b&quot;,sex:&quot;男&quot;,age:20&#125;)</span><br><span class="line">db.people.insert(&#123;_id:3,name:&quot;c&quot;,sex:&quot;女&quot;,age:20&#125;)</span><br><span class="line">db.people.insert(&#123;_id:4,name:&quot;d&quot;,sex:&quot;女&quot;,age:18&#125;)</span><br><span class="line">db.people.insert(&#123;_id:5,name:&quot;e&quot;,sex:&quot;男&quot;,age:19&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>统计男生、女生的总年龄</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.people.aggregate([</span><br><span class="line">	&#123;$group:&#123;_id:&quot;$sex&quot;,age_sum:&#123;$sum:&quot;$age&quot;&#125;&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/e71f5763a08a3aeaada8f310b543db81png.jpg" alt="image-20210223234358509"></p>
<blockquote>
<p>统计男生女生的总人数</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.people.aggregate([</span><br><span class="line">	&#123;$group:&#123;_id:&quot;$sex&quot;,sum:&#123;$sum:1&#125;&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/ad0f703c0a70d3649f63fc12839d0be0png.jpg" alt="image-20210223234722079"></p>
<blockquote>
<p>求学生总数和平均年龄</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.people.aggregate([</span><br><span class="line">	&#123;$group:&#123;_id:null,total_num:&#123;$sum:1&#125;,total_avg:&#123;$avg:&quot;$age&quot;&#125;&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/c09d267fd27f4690e3e9d700c5464a30png.jpg" alt="image-20210224103820145"></p>
<blockquote>
<p>查询男生、女生人数，按人数升序</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.people.aggregate([</span><br><span class="line">	&#123;$group:&#123;_id:&quot;$sex&quot;,rs:&#123;$sum:1&#125;&#125;&#125;,</span><br><span class="line">	&#123;$sort:&#123;rs:1&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/215288b57996c616f975251b809ad896png.jpg" alt="image-20210224104707963"></p>
<hr>
<h3 id="Map-Reduce操作"><a href="#Map-Reduce操作" class="headerlink" title="Map-Reduce操作"></a>Map-Reduce操作</h3><p>MongoDB提供Map-Reduce操作来进行聚合操作。通常，Map-Reduce操作有两个阶段，<strong>即Map和Reduce阶段</strong>，<strong>其中Map阶段是对集合中的每个输入文档进行处理，处理结束后输出一个或多个结果，****Reduce阶段是将Map阶段输出的一个或多个结果进行合并输出</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/QQ20241026-142130.png"></p>
<p>①query阶段，查询集合orders中字段status为A的文档</p>
<p>②map阶段，按照字段cust_id进行分组，将字段cust_id相同的amount值放到一个数组中</p>
<p>③reduce阶段，通过函数sum对每组的amount值进行求和</p>
<p>④output阶段，将结果输出到集合order_totals中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.mapReduce(</span><br><span class="line">	<span class="keyword">function</span>()&#123;emit(key,<span class="keyword">value</span>);&#125;,   <span class="operator">/</span><span class="operator">/</span>map函数</span><br><span class="line">	<span class="keyword">function</span>(key,<span class="keyword">values</span>)&#123;<span class="keyword">return</span> reduceFunction&#125;,	<span class="operator">/</span><span class="operator">/</span>reduce函数</span><br><span class="line">	&#123;</span><br><span class="line">		query:条件,</span><br><span class="line">		<span class="keyword">out</span>:New_COLLECTION_NAME,</span><br><span class="line">		sort:条件,</span><br><span class="line">		limit:number</span><br><span class="line">		&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>示例：</strong></p>
<p>查询集合comment中字段state为1的文档，按照字段nickname对文档进行分组，计算出每个评论者的评论条数。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.comment.mapReduce(</span><br><span class="line">	<span class="keyword">function</span>()&#123;emit(this.nickname,<span class="number">1</span>);&#125;,</span><br><span class="line">	<span class="keyword">function</span>(key,<span class="keyword">values</span>)&#123;<span class="keyword">return</span> Array.<span class="built_in">sum</span>(<span class="keyword">values</span>)&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		query:&#123;state:&quot;1&quot;&#125;,</span><br><span class="line">		<span class="keyword">out</span>:&quot;comment_total&quot;</span><br><span class="line">	&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/QQ20241026-142310.png"></p>
<p>查询结果集合comment_total中的结果数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment_total.find()</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/QQ20241026-142334.png"></p>
<h2 id="八、索引"><a href="#八、索引" class="headerlink" title="八、索引"></a>八、索引</h2><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><p><strong>索引</strong>是一种排序好的便于快速查询数据的数据结构，用于帮助数据库高效的查询数据<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/6c636fdb1eaff9d36dcb82efdcf62835png.jpg" alt="image-20210224110005650"></p>
<p><strong>优点</strong>：</p>
<ul>
<li>提高数据查询的效率，降低数据库的IO成本</li>
<li>通过索引对数据进行排序，降低数据排序的成本，降低CPU的消耗</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>占用磁盘空间</li>
<li>大量索引影响SQL语句的执行效率，因为每次插入和修改数据都要更新索引</li>
</ul>
<hr>
<h3 id="2-语法"><a href="#2-语法" class="headerlink" title="2. 语法"></a>2. 语法</h3><p><strong>创建索引语法</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建索引</span></span><br><span class="line">db.集合名.createIndex(待创建索引的列:方式 [,额外选项])</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建复合索引</span></span><br><span class="line">db.集合名.createIndex(&#123;key1:方式,key2:方式&#125; [,额外选项])</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数说明：</span></span><br><span class="line">- `待创建索引的列:方式`：&#123;key:1&#125;/&#123;key:-1&#125;</span><br><span class="line">   1表示升序，-1表示降序; 例如&#123;age:1&#125;表示创建age索引并按照升序方法排列</span><br><span class="line">- `额外选项`：设置索引的名称或者唯一索引等</span><br><span class="line">   设置名称:&#123;name:索引名&#125;</span><br><span class="line">   唯一索引:&#123;unique:列名&#125;</span><br></pre></td></tr></table></figure>

<p><strong>删除索引语法</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除全部索引</span></span><br><span class="line">db.集合名.dropIndexes()</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除指定索引</span></span><br><span class="line">db.集合名.dropIndex(索引名)</span><br></pre></td></tr></table></figure>

<p><strong>查看索引语法</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看索引</span></span><br><span class="line">db.集合名.getIndexes()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-练习"><a href="#3-练习" class="headerlink" title="3. 练习"></a>3. 练习</h3><p><strong>十万条数据准备</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选择数据库</span></span><br><span class="line">use test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">插入100000条数据</span></span><br><span class="line">for(var i=0;i&lt;100000;i++)&#123;</span><br><span class="line">	db.data.insert(&#123;name:&quot;zsr&quot;+i,age:i&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/f0dd736799668d96f461f4df19575c1fpng.jpg" alt="image-20210224112318002"></p>
<p><strong>创建普通索引</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给name添加普通升序索引</span></span><br><span class="line">db.data.createIndex(&#123;name:1&#125;)</span><br><span class="line"></span><br><span class="line">db.data.getIndexes()</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看索引</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/784867d7310e5b267333e299b9869869png.jpg" alt="image-20210224112835226"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给age创建索引并起名age_up</span></span><br><span class="line">db.data.createIndex(&#123;age:1&#125;,&#123;name:&quot;age_up&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/5df22a1e421f598039cac3e218268292png.jpg" alt="image-20210224113629158"></p>
<p><strong>删除索引</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除name列的索引</span></span><br><span class="line">db.data.dropIndex(&quot;name_1&quot;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/c374bda5175d3b1044b617abfcd3cde4png.jpg" alt="image-20210224112949548"></p>
<p><strong>创建复合&#x2F;组合索引</strong>：也就是一次给两个字段建立索引</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给name和age添加组合索引</span></span><br><span class="line">db.data.createIndex(&#123;name:1,age:1&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/12763c7b1ea33d1e80866668ecb9c56cpng.jpg" alt="image-20210224170703739"></p>
<p><strong>创建唯一索引</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除所有索引</span></span><br><span class="line">db.data.dropIndexes()</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给name创建唯一索引</span></span><br><span class="line">db.data.createIndex(&#123;name:1&#125;,&#123;unique:&quot;name&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/572ef26d7b0d9f86b18a29facec61e10png.jpg" alt="image-20210224171614328"></p>
<hr>
<h3 id="4-分析索引-explain"><a href="#4-分析索引-explain" class="headerlink" title="4. 分析索引(explain)"></a>4. 分析索引(explain)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.集合名.find().explain(&#x27;executionStats&#x27;)</span><br></pre></td></tr></table></figure>

<p>我们通过简单的案例来测试索引的好处</p>
<ul>
<li>不加索引时查询<code>age=500</code>的数据</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.data.find(&#123;age:500&#125;).explain(<span class="string">&#x27;executionStats&#x27;</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        &quot;queryPlanner&quot; : &#123;</span><br><span class="line">                &quot;plannerVersion&quot; : 1,</span><br><span class="line">                &quot;namespace&quot; : &quot;test.data&quot;,</span><br><span class="line">                &quot;indexFilterSet&quot; : false,</span><br><span class="line">                &quot;parsedQuery&quot; : &#123;</span><br><span class="line">                        &quot;age&quot; : &#123;</span><br><span class="line">                                &quot;$eq&quot; : 500</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;winningPlan&quot; : &#123;</span><br><span class="line">                        &quot;stage&quot; : &quot;COLLSCAN&quot;,</span><br><span class="line">                        &quot;filter&quot; : &#123;</span><br><span class="line">                                &quot;age&quot; : &#123;</span><br><span class="line">                                        &quot;$eq&quot; : 500</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;direction&quot; : &quot;forward&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;executionStats&quot; : &#123;	#执行计划相关统计信息</span><br><span class="line">                &quot;executionSuccess&quot; : true,	#执行成功的状态</span><br><span class="line">                &quot;nReturned&quot; : 1,	#返回结果集数目</span><br><span class="line">                &quot;executionTimeMillis&quot; : 37,	#执行所需要的ms数</span><br><span class="line">                &quot;totalKeysExamined&quot; : 0,	#索引检查的时间</span><br><span class="line">                &quot;totalDocsExamined&quot; : 100000,	#检查文档总数</span><br><span class="line">                &quot;executionStages&quot; : &#123;</span><br><span class="line">                        &quot;stage&quot; : &quot;COLLSCAN&quot;,	#索引扫描方式</span><br><span class="line">                        &quot;filter&quot; : &#123;	#过滤条件</span><br><span class="line">                                &quot;age&quot; : &#123;</span><br><span class="line">                                        &quot;$eq&quot; : 500</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;nReturned&quot; : 1,	#返回结果集数目</span><br><span class="line">                        &quot;executionTimeMillisEstimate&quot; : 1,	#预估执行时间(ms)</span><br><span class="line">                        &quot;works&quot; : 100002,	#工作单元数,一个查询会被派生为一个小的工作单元</span><br><span class="line">                        &quot;advanced&quot; : 1,	#优先返回的结果数</span><br><span class="line">                        &quot;needTime&quot; : 100000,</span><br><span class="line">                        &quot;needYield&quot; : 0,</span><br><span class="line">                        &quot;saveState&quot; : 100,</span><br><span class="line">                        &quot;restoreState&quot; : 100,</span><br><span class="line">                        &quot;isEOF&quot; : 1,</span><br><span class="line">                        &quot;direction&quot; : &quot;forward&quot;,	 </span><br><span class="line">                        &quot;docsExamined&quot; : 100000	#文档检查数目</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;serverInfo&quot; : &#123;</span><br><span class="line">                &quot;host&quot; : &quot;LAPTOP-8J48VF43&quot;,</span><br><span class="line">                &quot;port&quot; : 27017,</span><br><span class="line">                &quot;version&quot; : &quot;4.4.2&quot;,</span><br><span class="line">                &quot;gitVersion&quot; : &quot;15e73dc5738d2278b688f8929aee605fe4279b0e&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>给age添加一个升序索引后</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给age添加升序索引</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.data.createIndex(&#123;age:1&#125;)</span></span><br><span class="line">&#123;</span><br><span class="line">        &quot;createdCollectionAutomatically&quot; : false,</span><br><span class="line">        &quot;numIndexesBefore&quot; : 2,</span><br><span class="line">        &quot;numIndexesAfter&quot; : 3,</span><br><span class="line">        &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">性能分析</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.data.find(&#123;age:500&#125;).explain(<span class="string">&#x27;executionStats&#x27;</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        &quot;queryPlanner&quot; : &#123;</span><br><span class="line">                &quot;plannerVersion&quot; : 1,</span><br><span class="line">                &quot;namespace&quot; : &quot;test.data&quot;,</span><br><span class="line">                &quot;indexFilterSet&quot; : false,</span><br><span class="line">                &quot;parsedQuery&quot; : &#123;</span><br><span class="line">                        &quot;age&quot; : &#123;</span><br><span class="line">                                &quot;$eq&quot; : 500</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;winningPlan&quot; : &#123;</span><br><span class="line">                        &quot;stage&quot; : &quot;FETCH&quot;,</span><br><span class="line">                        &quot;inputStage&quot; : &#123;</span><br><span class="line">                                &quot;stage&quot; : &quot;IXSCAN&quot;,</span><br><span class="line">                                &quot;keyPattern&quot; : &#123;</span><br><span class="line">                                        &quot;age&quot; : 1</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;indexName&quot; : &quot;age_1&quot;,</span><br><span class="line">                                &quot;isMultiKey&quot; : false,</span><br><span class="line">                                &quot;multiKeyPaths&quot; : &#123;</span><br><span class="line">                                        &quot;age&quot; : [ ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;isUnique&quot; : false,</span><br><span class="line">                                &quot;isSparse&quot; : false,</span><br><span class="line">                                &quot;isPartial&quot; : false,</span><br><span class="line">                                &quot;indexVersion&quot; : 2,</span><br><span class="line">                                &quot;direction&quot; : &quot;forward&quot;,</span><br><span class="line">                                &quot;indexBounds&quot; : &#123;</span><br><span class="line">                                        &quot;age&quot; : [</span><br><span class="line">                                                &quot;[500.0, 500.0]&quot;</span><br><span class="line">                                        ]</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;executionStats&quot; : &#123;	#执行计划相关统计信息</span><br><span class="line">                &quot;executionSuccess&quot; : true,	#执行成功的状态</span><br><span class="line">                &quot;nReturned&quot; : 1,	#返回结果集数目</span><br><span class="line">                &quot;executionTimeMillis&quot; : 1,	#执行所需要的ms数</span><br><span class="line">                &quot;totalKeysExamined&quot; : 1,	#索引检查的时间</span><br><span class="line">                &quot;totalDocsExamined&quot; : 1,	#检查文档总数</span><br><span class="line">                &quot;executionStages&quot; : &#123;</span><br><span class="line">                        &quot;stage&quot; : &quot;FETCH&quot;,	#索引扫描方式</span><br><span class="line">                        &quot;nReturned&quot; : 1,	#返回结果集数目</span><br><span class="line">                        &quot;executionTimeMillisEstimate&quot; : 0,	#预估执行时间(ms)</span><br><span class="line">                        &quot;works&quot; : 2,	#工作单元数,一个查询会被派生为一个小的工作单元</span><br><span class="line">                        &quot;advanced&quot; : 1,	#优先返回的结果数</span><br><span class="line">                        &quot;needTime&quot; : 0,</span><br><span class="line">                        &quot;needYield&quot; : 0,</span><br><span class="line">                        &quot;saveState&quot; : 0,</span><br><span class="line">                        &quot;restoreState&quot; : 0,</span><br><span class="line">                        &quot;isEOF&quot; : 1,</span><br><span class="line">                        &quot;docsExamined&quot; : 1,</span><br><span class="line">                        &quot;alreadyHasObj&quot; : 0,</span><br><span class="line">                        &quot;inputStage&quot; : &#123;</span><br><span class="line">                                &quot;stage&quot; : &quot;IXSCAN&quot;,</span><br><span class="line">                                &quot;nReturned&quot; : 1,</span><br><span class="line">                                &quot;executionTimeMillisEstimate&quot; : 0,</span><br><span class="line">                                &quot;works&quot; : 2,</span><br><span class="line">                                &quot;advanced&quot; : 1,</span><br><span class="line">                                &quot;needTime&quot; : 0,</span><br><span class="line">                                &quot;needYield&quot; : 0,</span><br><span class="line">                                &quot;saveState&quot; : 0,</span><br><span class="line">                                &quot;restoreState&quot; : 0,</span><br><span class="line">                                &quot;isEOF&quot; : 1,</span><br><span class="line">                                &quot;keyPattern&quot; : &#123;</span><br><span class="line">                                        &quot;age&quot; : 1</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;indexName&quot; : &quot;age_1&quot;,</span><br><span class="line">                                &quot;isMultiKey&quot; : false,</span><br><span class="line">                                &quot;multiKeyPaths&quot; : &#123;</span><br><span class="line">                                        &quot;age&quot; : [ ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;isUnique&quot; : false,</span><br><span class="line">                                &quot;isSparse&quot; : false,</span><br><span class="line">                                &quot;isPartial&quot; : false,</span><br><span class="line">                                &quot;indexVersion&quot; : 2,</span><br><span class="line">                                &quot;direction&quot; : &quot;forward&quot;,</span><br><span class="line">                                &quot;indexBounds&quot; : &#123;</span><br><span class="line">                                        &quot;age&quot; : [</span><br><span class="line">                                                &quot;[500.0, 500.0]&quot;</span><br><span class="line">                                        ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;keysExamined&quot; : 1,</span><br><span class="line">                                &quot;seeks&quot; : 1,</span><br><span class="line">                                &quot;dupsTested&quot; : 0,</span><br><span class="line">                                &quot;dupsDropped&quot; : 0</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;serverInfo&quot; : &#123;</span><br><span class="line">                &quot;host&quot; : &quot;LAPTOP-8J48VF43&quot;,</span><br><span class="line">                &quot;port&quot; : 27017,</span><br><span class="line">                &quot;version&quot; : &quot;4.4.2&quot;,</span><br><span class="line">                &quot;gitVersion&quot; : &quot;15e73dc5738d2278b688f8929aee605fe4279b0e&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三种扫描方式</p>
<ul>
<li><code>COLLSCAN</code>：全盘扫描</li>
<li><code>INSCAN</code>：索引扫描</li>
<li><code>FETCH</code>：根据索引去检索指定document</li>
</ul>
<h3 id="5-选择规则"><a href="#5-选择规则" class="headerlink" title="5. 选择规则"></a>5. 选择规则</h3><p>如何选择合适的列创建索引？</p>
<ul>
<li>为常做条件、排序、分组的字段建立索引</li>
<li>选择唯一性索引</li>
<li>选择较小的数据列，为较长的字符串使用前缀索引</li>
</ul>
<hr>
<h2 id="九、权限机制"><a href="#九、权限机制" class="headerlink" title="九、权限机制"></a>九、权限机制</h2><blockquote>
<p>安装完<code>Mongodb</code>后，在命令行输入<code>mongo</code>命令即可登录数据库，这肯定是不安全的，我们需要使用权限机制，开启验证模式</p>
</blockquote>
<h3 id="创建账号语法"><a href="#创建账号语法" class="headerlink" title="创建账号语法"></a>创建账号语法</h3><p><strong>创建账号</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.createUser(&#123;</span><br><span class="line">	&quot;user&quot;:&quot;账号&quot;,</span><br><span class="line">	&quot;pwd&quot;:&quot;密码&quot;,</span><br><span class="line">	&quot;roles&quot;:[&#123;</span><br><span class="line">		role:&quot;角色&quot;,</span><br><span class="line">		db:&quot;所属数据库&quot;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>角色种类</strong></p>
<ul>
<li>超级用户角色：<code>root</code></li>
<li>数据库用户角色：<code>read</code>、<code>readWrite</code></li>
<li>数据库管理角色：<code>dbAdmin</code>、<code>userAdmin</code></li>
<li>集群管理角色： <code>clusterAdmin</code>、<code>clusterManager</code>、<code>clusterMonitor</code>、<code>hostManager</code></li>
<li>备份恢复角色： <code>backup</code>、<code>restore</code></li>
<li>所有数据库角色： <code>readAnyDatabase</code>、<code>readWriteAnyDatabase</code>、<code>userAdminAnyDatabase</code>、<code>dbAdminAnyDatabase</code></li>
</ul>
<p><strong>角色说明</strong></p>
<ul>
<li><code>root</code>：只在admin数据库中可用。超级账号，超级权限；</li>
<li><code>read</code>：允许用户读取指定数据库；</li>
<li><code>readWrite</code>：允许用户读写指定数据库</li>
</ul>
<hr>
<h3 id="开启验证模式"><a href="#开启验证模式" class="headerlink" title="开启验证模式"></a>开启验证模式</h3><blockquote>
<p><strong>验证模式</strong>：值用户需要输入账号密码才能登录使用</p>
</blockquote>
<h4 id="1-添加超级管理员账号"><a href="#1-添加超级管理员账号" class="headerlink" title="1. 添加超级管理员账号"></a>1. 添加超级管理员账号</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">必须使用admin数据库</span></span><br><span class="line">use admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建超级用户</span></span><br><span class="line">db.createUser(&#123;</span><br><span class="line">	&quot;user&quot;:&quot;zsr&quot;,</span><br><span class="line">	&quot;pwd&quot;:&quot;123456&quot;,</span><br><span class="line">	&quot;roles&quot;:[&#123;</span><br><span class="line">		role:&quot;root&quot;,</span><br><span class="line">		db:&quot;admin&quot;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/cd58510739d30618ea219115fc2df0f1png.jpg" alt="image-20210224183401582"><br>然后查看admin数据库中的集合<code>system.users</code>可以查看详细信息<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/f673b754c54fc839b7e57d0a6337f693png.jpg" alt="image-20210224183540573"></p>
<h4 id="2-卸载服务"><a href="#2-卸载服务" class="headerlink" title="2. 卸载服务"></a>2. 卸载服务</h4><p>首先<code>exit</code>退出登录，然后以管理员模式打开终端输入如下命令卸载服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">卸载服务</span></span><br><span class="line">mongod --remove</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/baf8da633e5b9e048ebe760bed644336png.jpg" alt="image-20210224191707674"></p>
<h4 id="3-安装需要身份验证的服务"><a href="#3-安装需要身份验证的服务" class="headerlink" title="3. 安装需要身份验证的服务"></a>3. 安装需要身份验证的服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --install --dbpath 数据目录 --logpath 日志目录\日志名称 --auth</span><br></pre></td></tr></table></figure>

<p>这里为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --install --dbpath D:\JAVA_Environment\MongoDB\mongodb-win32-x86_64-windows-4.4.2\data --logpath D:\JAVA_Environment\MongoDB\mongodb-win32-x86_64-windows-4.4.2\logs\mongodb-zsr.log --auth</span><br></pre></td></tr></table></figure>

<h4 id="4-启动服务-1"><a href="#4-启动服务-1" class="headerlink" title="4. 启动服务"></a>4. 启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net start mongodb</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/f01088b8094b1fe2d5da48a1895c145bpng.jpg" alt="image-20210224192124655"></p>
<h4 id="5-登录测试"><a href="#5-登录测试" class="headerlink" title="5. 登录测试"></a>5. 登录测试</h4><p>输入<code>mongo</code>命令登录，可以发现不再显示警告，且查看数据库看不到，这是因为还没有身份验证，没有通过账号登录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/c06e8a9a804e901f3f6a0ce74efee1ddpng.jpg" alt="image-20210224192324211"></p>
<h4 id="6-通过超级管理员账号登录"><a href="#6-通过超级管理员账号登录" class="headerlink" title="6. 通过超级管理员账号登录"></a>6. 通过超级管理员账号登录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方法一</span></span><br><span class="line">mongo 服务器ip地址:端口号/数据库 -u 用户名 -p 密码</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/e82a67a26617b2eeacdcc63dfd04cb48png.jpg" alt="image-20210224193541511"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方法二</span></span><br><span class="line">mongo	#先登录</span><br><span class="line">use admin	#选择数据库</span><br><span class="line">db.auth(用户名,密码)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d2258f050662676a190d28e9df6f663bpng.jpg" alt="image-20210224205733706"></p>
<hr>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><ul>
<li><strong>需求</strong></li>
</ul>
<blockquote>
<p>添加用户shop1可以读shop数据库</p>
<p>添加用户shop2可以读写shop数据库</p>
<p>注意：必须在对应的数据库中创建用户</p>
</blockquote>
<ul>
<li><strong>准备</strong>：创建测试数据</li>
</ul>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use shop</span><br><span class="line">for(var i=1;i&lt;=10;i++)&#123;</span><br><span class="line">	db.goods.insert(&#123;name:&quot;goods&quot;+i,price:i&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/23bf7429921d28f4eeb4b70d07535ba7png.jpg" alt="image-20210224210448805"></p>
</blockquote>
<ul>
<li><strong>添加用户并设置权限</strong></li>
</ul>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">use shop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建shop1用户</span></span><br><span class="line">db.createUser(&#123;</span><br><span class="line">	&quot;user&quot;:&quot;shop1&quot;,</span><br><span class="line">	&quot;pwd&quot;:&quot;123456&quot;,</span><br><span class="line">	&quot;roles&quot;:[&#123;</span><br><span class="line">		role:&quot;read&quot;,</span><br><span class="line">		db:&quot;shop&quot;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建shop2用户</span></span><br><span class="line">db.createUser(&#123;</span><br><span class="line">	&quot;user&quot;:&quot;shop2&quot;,</span><br><span class="line">	&quot;pwd&quot;:&quot;123456&quot;,</span><br><span class="line">	&quot;roles&quot;:[&#123;</span><br><span class="line">		role:&quot;readWrite&quot;,</span><br><span class="line">		db:&quot;shop&quot;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d36a4bd8097fd5029fdd65f53deb5001png.jpg" alt="image-20210224211009044"></p>
</blockquote>
<ul>
<li><strong>验证</strong>：shop1可读，shop2可读可写</li>
</ul>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证shop1可读</span></span><br><span class="line">C:\WINDOWS\system32&gt;mongo localhost:27017/shop -u shop1 -p 123456</span><br><span class="line">MongoDB shell version v4.4.2</span><br><span class="line">connecting to: mongodb://localhost:27017/shop?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;727ada5f-985f-4858-bb30-523d1777fa3a&quot;) &#125;</span><br><span class="line">MongoDB server version: 4.4.2</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">show dbs</span></span><br><span class="line">shop  0.000GB</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.goods.find()	<span class="comment">#可读</span></span></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f431&quot;), &quot;name&quot; : &quot;goods1&quot;, &quot;price&quot; : 1 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f432&quot;), &quot;name&quot; : &quot;goods2&quot;, &quot;price&quot; : 2 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f433&quot;), &quot;name&quot; : &quot;goods3&quot;, &quot;price&quot; : 3 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f434&quot;), &quot;name&quot; : &quot;goods4&quot;, &quot;price&quot; : 4 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f435&quot;), &quot;name&quot; : &quot;goods5&quot;, &quot;price&quot; : 5 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f436&quot;), &quot;name&quot; : &quot;goods6&quot;, &quot;price&quot; : 6 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f437&quot;), &quot;name&quot; : &quot;goods7&quot;, &quot;price&quot; : 7 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f438&quot;), &quot;name&quot; : &quot;goods8&quot;, &quot;price&quot; : 8 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f439&quot;), &quot;name&quot; : &quot;goods9&quot;, &quot;price&quot; : 9 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f43a&quot;), &quot;name&quot; : &quot;goods10&quot;, &quot;price&quot; : 10 &#125;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.goods.insert(&#123;name:<span class="string">&quot;zsr&quot;</span>&#125;)	<span class="comment">#不可写</span></span></span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">      &quot;ok&quot; : 0,</span><br><span class="line">      &quot;errmsg&quot; : &quot;not authorized on shop to execute command &#123; insert: \&quot;goods\&quot;, ordered: true, lsid: &#123; id: UUID(\&quot;727ada5f-985f-4858-bb30-523d1777fa3a\&quot;) &#125;, $db: \&quot;shop\&quot; &#125;&quot;,</span><br><span class="line">      &quot;code&quot; : 13,</span><br><span class="line">      &quot;codeName&quot; : &quot;Unauthorized&quot;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证shop2可读可写</span></span><br><span class="line">C:\WINDOWS\system32&gt;mongo localhost:27017/shop -u shop2 -p 123456</span><br><span class="line">MongoDB shell version v4.4.2</span><br><span class="line">connecting to: mongodb://localhost:27017/shop?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;1fbca023-aeb3-4514-b2e4-700934000cc9&quot;) &#125;</span><br><span class="line">MongoDB server version: 4.4.2</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.goods.find()	<span class="comment">#可读</span></span></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f431&quot;), &quot;name&quot; : &quot;goods1&quot;, &quot;price&quot; : 1 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f432&quot;), &quot;name&quot; : &quot;goods2&quot;, &quot;price&quot; : 2 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f433&quot;), &quot;name&quot; : &quot;goods3&quot;, &quot;price&quot; : 3 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f434&quot;), &quot;name&quot; : &quot;goods4&quot;, &quot;price&quot; : 4 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f435&quot;), &quot;name&quot; : &quot;goods5&quot;, &quot;price&quot; : 5 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f436&quot;), &quot;name&quot; : &quot;goods6&quot;, &quot;price&quot; : 6 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f437&quot;), &quot;name&quot; : &quot;goods7&quot;, &quot;price&quot; : 7 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f438&quot;), &quot;name&quot; : &quot;goods8&quot;, &quot;price&quot; : 8 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f439&quot;), &quot;name&quot; : &quot;goods9&quot;, &quot;price&quot; : 9 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;60364ec9fd9e42c81a76f43a&quot;), &quot;name&quot; : &quot;goods10&quot;, &quot;price&quot; : 10 &#125;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.goods.insert(&#123;name:<span class="string">&quot;zsr&quot;</span>&#125;)	可写</span></span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br></pre></td></tr></table></figure>
</blockquote>
<hr>
<h2 id="十、备份还原"><a href="#十、备份还原" class="headerlink" title="十、备份还原"></a>十、备份还原</h2><h3 id="下载MongoDB数据库工具"><a href="#下载MongoDB数据库工具" class="headerlink" title="下载MongoDB数据库工具"></a>下载MongoDB数据库工具</h3><blockquote>
<p>进行备份还原之前，首先要下载相关的工具</p>
<p><code>MongoDB Database Tools</code>：<a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/database-tools">https://www.mongodb.com/try/download/database-tools</a></p>
<p>MongoDB数据库工具是用于处理MongoDB部署的命令行实用程序的集合。这些工具独立于MongoDB Server计划发布，使您能够获得更频繁的更新，并在新功能可用时立即加以利用。有关更多信息，请参阅MongoDB数据库工具文档。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/0966bddca28f666fe9fcda76fb5cd5f5png.jpg" alt="image-20210227112227492"><br>下载后得到压缩包<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1dd0d49b4fe7933d97ae4ad95eb07675png.jpg" alt="image-20210227112502136"><br>解压<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/df0769604da87a7677ae12416bdf9c61png.jpg" alt="image-20210227112533887"><br>然后点击进入<code>bin</code>目录，可以看到各种工具，接下来的备份还原就需要用到其中的<code>mongodump</code>和<code>mongorestore</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/6e86802faff622b503306459a294178fpng.jpg" alt="image-20210227112550024"><br>将其中的所有<code>exe</code>文件拷贝到<code>MongoDB</code>安装目录下的<code>bin</code>目录中<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/6c2de28f7ab80be9ab1e489cb9dac4b2png.jpg" alt="image-20210227112729196"></p>
<hr>
<h3 id="备份数据库mongodump"><a href="#备份数据库mongodump" class="headerlink" title="备份数据库mongodump"></a>备份数据库mongodump</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导出数据</span></span><br><span class="line">mongodump -h -port -u -p -d -o</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">说明</span></span><br><span class="line">-h 服务器ip地址(一般不写,默认本机)</span><br><span class="line">-port 端口(一般不写,默认27017)</span><br><span class="line">-u 账号</span><br><span class="line">-p 密码</span><br><span class="line">-d 数据库(不写则表示导出全部)</span><br><span class="line">-o 备份到指定目录下 </span><br></pre></td></tr></table></figure>

<p><strong>1️⃣ 备份所有数据：</strong></p>
<p>在<code>MongoDB</code>安装目录下新建一个<code>data_backup</code>目录用于存放所有的备份数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodump -u zsr -p 123456 -o D:\JAVA_Environment\MongoDB\mongodb-win32-x86_64-windows-4.4.2\data_backup</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/75162d693c7c3ffad75edaf9164f72e1png.jpg" alt="image-20210227112856405"><br>然后再查看<code>data_backup</code>目录，可以看到备份的所有的数据库<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/4fcaa4a479642d4b4b2dd51748497c56png.jpg" alt="image-20210227113046764"></p>
<p><strong>2️⃣ 备份指定数据：</strong></p>
<p>在<code>MongoDB</code>安装目录下新建一个<code>data_backup2</code>目录用于存放备份的shop数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用具有读权限的shop1/shop2用户都可以</span></span><br><span class="line">mongodump -u shop1 -p 123456 -d shop -o D:\JAVA_Environment\MongoDB\mongodb-win32-x86_64-windows-4.4.2\data_backup2</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/52d68ce11f84f8883a6ec09eebac4184png.jpg" alt="image-20210227121409952"><br>然后再查看<code>data_backu2</code>目录，可以看到备份的shop数据库<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/e350c7c33659de64bfe23de5f6b778efpng.jpg" alt="image-20210227121447341"></p>
<h3 id="还原数据库mongorestore"><a href="#还原数据库mongorestore" class="headerlink" title="还原数据库mongorestore"></a>还原数据库mongorestore</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mongostore -h -port -u -p -d --drop 备份数据目录</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">说明</span></span><br><span class="line">-h 服务器ip地址(一般不写,默认本机)</span><br><span class="line">-port 端口(一般不写,默认27017)</span><br><span class="line">-u 账号</span><br><span class="line">-p 密码</span><br><span class="line">-d 数据库(不写则表示还原全部数据)</span><br><span class="line">--drop 先删除数据库再导入,不写则覆盖</span><br></pre></td></tr></table></figure>

<p><strong>1️⃣ 还原所有数据：</strong></p>
<p>首先删除几个数据库<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2884f546316db10bd9af8ae2b8d2a2c1png.jpg" alt="image-20210227121856694"><br>然后输入如下命令从<code>data_backup</code>目录进行恢复</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongorestore -u zsr -p 123456 --drop D:\JAVA_Environment\MongoDB\mongodb-win32-x86_64-windows-4.4.2\data_backup</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/e5473ee764448ec0614bb069905aa5d1png.jpg" alt="image-20210227122122487"><br>然后再次登录查看数据库，可以发现已经恢复<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/4fbcfbd998a796565689fd678d7aa0b9png.jpg" alt="image-20210227123501811"></p>
<p><strong>2️⃣ 还原指定数据：</strong></p>
<p>首先删除shop数据库<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/ec407030d504583eb069c091e4170749png.jpg" alt="image-20210227123652763"><br>然后输入如下命令从<code>data_backup2</code>目录恢复shop数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用具有写权限的shop2用户</span></span><br><span class="line">mongorestore -u shop2 -p 123456 -d shop --drop D:\JAVA_Environment\MongoDB\mongodb-win32-x86_64-windows-4.4.2\data_backup2\shop</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/e89cb48621e7bc2ef7a7b3515fad18f4png.jpg" alt="image-20210227124130659"><br>然后再次登录查看shop数据库，可以发现已经恢复<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/a6c0c6833027b908911abb2f059c2cd1png.jpg" alt="image-20210227124223756"></p>
<hr>
<h2 id="十一、测试使用Java操作MongoDB"><a href="#十一、测试使用Java操作MongoDB" class="headerlink" title="十一、测试使用Java操作MongoDB"></a>十一、测试使用Java操作MongoDB</h2><h3 id="搭建Java环境"><a href="#搭建Java环境" class="headerlink" title="搭建Java环境"></a>搭建Java环境</h3><h4 id="JDK的卸载"><a href="#JDK的卸载" class="headerlink" title="JDK的卸载"></a>JDK的卸载</h4><p><strong>删除JDK的文件夹</strong></p>
<p>1、在控制面板–程序中，卸载java8的旧版本</p>
<p>2、然后找到安装路径后，直接删除</p>
<p><strong>删除环境变量的配置</strong></p>
<p>此电脑–高级系统设置–环境变量–删除JAVA_HOME</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202209282005013.png" alt="image-20220928200458817"></p>
<p>删除Path中关于java的目录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202209282006855.png" alt="image-20220928200608756"></p>
<p><strong>测试是否卸载成功</strong></p>
<p>WIN + R 打开CMD，输入java -version 测试是否卸载成功。</p>
<h4 id="安装新版的JDK"><a href="#安装新版的JDK" class="headerlink" title="安装新版的JDK"></a>安装新版的JDK</h4><p>1<strong>、百度搜索JDK 8</strong></p>
<p>2<strong>、同意协议3、下载电脑对应的版本</strong></p>
<p>4<strong>、双击安装JDK</strong></p>
<p>5<strong>、记住安装路径（避免使用中文路径）</strong></p>
<p>6<strong>、配置环境变量</strong></p>
<p>1.此电脑–右键–属性–高级系统设置–环境变量</p>
<p>2.环境变量–&gt;JAVA_HOME</p>
<p>3.配置Path变量</p>
<p>新建 %JAVA_HOME%\bin</p>
<p>新建 %JAVA_HOME%\jre\bin</p>
<p>4.测试是否成功</p>
<p>CMD中，输入java -version</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202209282007557.png" alt="image-20220928200736501" style="zoom: 67%;" />

<h4 id="maven的安装"><a href="#maven的安装" class="headerlink" title="maven的安装"></a>maven的安装</h4><p>访问maven官网下载Windows系统下的Maven安装包，本书下载的是maven 3.8.3版本，即apache-maven-3.8.3-bin.zip安装包。</p>
<p>将Maven安装路径下的bin目录添加到系统环境变量的Path变量中，这里添加的C:\Environment\Maven\apache-maven-3.8.3\bin。</p>
<p>Maven环境变量配置完成后，在Windows的DOS窗口执行“mvn -version”命令，查看Maven是否安装配置成功。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204111616087.png" alt="image-20220411161618916"></p>
<p>修改Maven配置文件settings.xml，该文件位于Maven安装路径下的conf文件夹内，向配置文件中添加本地仓库路径和远程仓库路径，需要注意的是本地仓库路径需要提前创建。</p>
<p>本地仓库</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204111617447.png" alt="image-20220411161724356"></p>
<p>远程仓库（可配阿里云-自行百度）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204111617614.png" alt="image-20220411161755525"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mirror</span></span><br><span class="line"><span class="comment">     | Specifies a repository mirror site to use instead of a given repository. The repository that</span></span><br><span class="line"><span class="comment">     | this mirror serves has an ID that matches the mirrorOf element of this mirror. IDs are used</span></span><br><span class="line"><span class="comment">     | for inheritance and direct lookup purposes, and must be unique across the set of mirrors.</span></span><br><span class="line"><span class="comment">     |     --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置阿里云--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>      </span><br><span class="line">       <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">       <span class="tag">&lt;<span class="name">name</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span>    </span><br><span class="line">         <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven-central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven central<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven-spring<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven-spring<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/spring<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Maven Repository Switchboard<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo1.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>jboss-public-repository-group<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>JBoss Public Repository Group<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repository.jboss.org/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-default-http-blocker<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>external:http:*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Pseudo repository to mirror external repositories initially using HTTP.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://0.0.0.0/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">blocked</span>&gt;</span>true<span class="tag">&lt;/<span class="name">blocked</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Java-API操作MongoDB"><a href="#基于Java-API操作MongoDB" class="headerlink" title="基于Java API操作MongoDB"></a>基于Java API操作MongoDB</h3><h4 id="idea项目建立"><a href="#idea项目建立" class="headerlink" title="idea项目建立"></a>idea项目建立</h4><p>配置IDEA工具，在IDEA安装完成后的界面，单击“Configure”→“Settings”→“Build，Execution，Deployment”→“Build Tools”→“Maven”，将Maven添加至IDEA工具中。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202210090918163.png" alt="image-20221009091830802"></p>
<p>配置IDEA工具，在IDEA安装完成后的界面，“Configure”→“Structure for New Projects”→“Project”，将jdk添加至IDEA工具中。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202210090921328.png" alt="image-20221009092138195"></p>
<p>打开IDEA工具，单击“Create New Project”→“Maven”，选择创建一个Maven项目。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202210090923343.png" alt="image-20221009092316062"></p>
<p>添加Maven项目的名称和指定项目的存储路径。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202210090926313.png" alt="image-20221009092651032"></p>
<p>完成Maven项目的创建。</p>
<p>在项目article中配置pom.xml文件，引入MongoDB相关的依赖和单元测试的<a target="_blank" rel="noopener" href="https://mvnrepository.com/">依赖</a>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202210090930524.png" alt="image-20221009093040265"></p>
<h3 id="项目实训-文章评论"><a href="#项目实训-文章评论" class="headerlink" title="项目实训  文章评论"></a>项目实训  文章评论</h3><h4 id="需要实现"><a href="#需要实现" class="headerlink" title="需要实现"></a>需要实现</h4><p>以下功能：</p>
<p>1）基本增删改查API</p>
<p>2）根据文章id查询评论</p>
<p>3）评论点赞</p>
<p>数据库：articledb</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://yicopap-images.oss-cn-beijing.aliyuncs.com/imgs/202204092346660.png" alt="image-20220409234637444"></p>
<h3 id="文章微服务模块搭建"><a href="#文章微服务模块搭建" class="headerlink" title="文章微服务模块搭建"></a>文章微服务模块搭建</h3><h4 id="（1）搭建项目工程article，并设置pom-xml引入依赖："><a href="#（1）搭建项目工程article，并设置pom-xml引入依赖：" class="headerlink" title="（1）搭建项目工程article，并设置pom.xml引入依赖："></a>（1）搭建项目工程article，并设置pom.xml引入依赖：</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>article<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="（2）在article-src-main-resources下创建文件application-yml"><a href="#（2）在article-src-main-resources下创建文件application-yml" class="headerlink" title="（2）在article\src\main\resources下创建文件application.yml"></a>（2）在article\src\main\resources下创建文件application.yml</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  #数据源配置</span><br><span class="line">  data:</span><br><span class="line">    mongodb:</span><br><span class="line">      uri: mongodb:<span class="comment">//192.168.24.105:27017/articledb</span></span><br></pre></td></tr></table></figure>

<h4 id="（3）创建启动类"><a href="#（3）创建启动类" class="headerlink" title="（3）创建启动类"></a>（3）创建启动类</h4><p>在article\src\main\java下创建类cn.itcast.article.ArticleApplication（此处命名方法使用到包机制）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ArticleApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（4）启动项目，看是否能正常启动，控制台没有错误。"><a href="#（4）启动项目，看是否能正常启动，控制台没有错误。" class="headerlink" title="（4）启动项目，看是否能正常启动，控制台没有错误。"></a>（4）启动项目，看是否能正常启动，控制台没有错误。</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202209282042307.png" alt="image-20220928204230064"></p>
<h3 id="文章评论实体类的编写"><a href="#文章评论实体类的编写" class="headerlink" title="文章评论实体类的编写"></a>文章评论实体类的编写</h3><p>在article\src\main\java下创建实体类，创建包cn.itcast.article，包下建包po用于存放实体类，创建实体类</p>
<p>cn.itcast.article.po.Comment</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.po;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.index.CompoundIndex;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.index.Indexed;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章评论实体类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//把一个java类声明为mongodb的文档，可以通过collection参数指定这个类对应的文档。</span></span><br><span class="line"><span class="comment">//@Document(collection=&quot;mongodb 对应 collection 名&quot;)</span></span><br><span class="line"><span class="comment">// 若未加 @Document ，该 bean save 到 mongo 的 comment collection</span></span><br><span class="line"><span class="comment">// 若添加 @Document ，则 save 到 comment collection</span></span><br><span class="line"><span class="meta">@Document(collection=&quot;comment&quot;)</span><span class="comment">//可以省略，如果省略，则默认使用类名小写映射集合</span></span><br><span class="line"><span class="comment">//复合索引</span></span><br><span class="line"><span class="meta">@CompoundIndex( def = &quot;&#123;&#x27;userid&#x27;: 1, &#x27;nickname&#x27;: -1&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Comment</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//主键标识，该属性的值会自动对应mongodb的主键字段&quot;_id&quot;，如果该属性名就叫“id”,则该注解可以省略，否则必须写</span></span><br><span class="line"><span class="comment">//    @Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;<span class="comment">//主键</span></span><br><span class="line">    <span class="comment">//该属性对应mongodb的字段的名字，如果一致，则无需该注解</span></span><br><span class="line">    <span class="meta">@Field(&quot;content&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String content;<span class="comment">//吐槽内容</span></span><br><span class="line">    <span class="keyword">private</span> Date publishtime;<span class="comment">//发布日期</span></span><br><span class="line">    <span class="comment">//添加了一个单字段的索引</span></span><br><span class="line">    <span class="meta">@Indexed</span></span><br><span class="line">    <span class="keyword">private</span> String userid;<span class="comment">//发布人ID</span></span><br><span class="line">    <span class="keyword">private</span> String nickname;<span class="comment">//昵称</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createdatetime;<span class="comment">//评论的日期时间</span></span><br><span class="line">    <span class="keyword">private</span> Integer likenum;<span class="comment">//点赞数</span></span><br><span class="line">    <span class="keyword">private</span> Integer replynum;<span class="comment">//回复数</span></span><br><span class="line">    <span class="keyword">private</span> String state;<span class="comment">//状态</span></span><br><span class="line">    <span class="keyword">private</span> String parentid;<span class="comment">//上级ID</span></span><br><span class="line">    <span class="keyword">private</span> String articleid;</span><br><span class="line">    <span class="comment">//getter and setter.....</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getPublishtime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> publishtime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPublishtime</span><span class="params">(Date publishtime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.publishtime = publishtime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserid</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserid</span><span class="params">(String userid)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userid = userid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNickname</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nickname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNickname</span><span class="params">(String nickname)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nickname = nickname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LocalDateTime <span class="title function_">getCreatedatetime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createdatetime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreatedatetime</span><span class="params">(LocalDateTime createdatetime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createdatetime = createdatetime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getLikenum</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> likenum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLikenum</span><span class="params">(Integer likenum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.likenum = likenum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getReplynum</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> replynum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReplynum</span><span class="params">(Integer replynum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.replynum = replynum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(String state)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getParentid</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parentid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParentid</span><span class="params">(String parentid)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.parentid = parentid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getArticleid</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> articleid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setArticleid</span><span class="params">(String articleid)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.articleid = articleid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Comment&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, content=&#x27;&quot;</span> + content + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, publishtime=&quot;</span> + publishtime +</span><br><span class="line">                <span class="string">&quot;, userid=&#x27;&quot;</span> + userid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, nickname=&#x27;&quot;</span> + nickname + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, createdatetime=&quot;</span> + createdatetime +</span><br><span class="line">                <span class="string">&quot;, likenum=&quot;</span> + likenum +</span><br><span class="line">                <span class="string">&quot;, replynum=&quot;</span> + replynum +</span><br><span class="line">                <span class="string">&quot;, state=&#x27;&quot;</span> + state + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, parentid=&#x27;&quot;</span> + parentid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, articleid=&#x27;&quot;</span> + articleid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="文章评论的基本增删改查"><a href="#文章评论的基本增删改查" class="headerlink" title="文章评论的基本增删改查"></a>文章评论的基本增删改查</h3><h4 id="（1）创建数据访问接口-cn-itcast-article包下创建dao包，包下创建接口"><a href="#（1）创建数据访问接口-cn-itcast-article包下创建dao包，包下创建接口" class="headerlink" title="（1）创建数据访问接口 cn.itcast.article包下创建dao包，包下创建接口"></a>（1）创建数据访问接口 cn.itcast.article包下创建dao包，包下创建接口</h4><p>cn.itcast.article.dao.CommentRepository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.po.Comment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;</span><br><span class="line"></span><br><span class="line"><span class="comment">//评论的dao接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommentRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;Comment,String &gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据父id，查询子评论的分页列表</span></span><br><span class="line">    Page&lt;Comment&gt; <span class="title function_">findByParentid</span><span class="params">(String parentid,Pageable pageable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（2）创建业务逻辑类-cn-itcast-article包下创建service包，包下创建类"><a href="#（2）创建业务逻辑类-cn-itcast-article包下创建service包，包下创建类" class="headerlink" title="（2）创建业务逻辑类 cn.itcast.article包下创建service包，包下创建类"></a>（2）创建业务逻辑类 cn.itcast.article包下创建service包，包下创建类</h4><p>cn.itcast.article.service.CommentService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.dao.CommentRepository;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.po.Comment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Update;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">//评论的业务层</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommentService</span> &#123;</span><br><span class="line">    <span class="comment">//注入dao</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentRepository commentRepository;</span><br><span class="line">    <span class="comment">//注入MongoTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存一个评论</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> comment</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveComment</span><span class="params">(Comment comment)</span>&#123;</span><br><span class="line">        <span class="comment">//如果需要自定义主键，可以在这里指定主键；如果不指定主键，MongoDB会自动生成主键</span></span><br><span class="line">        <span class="comment">//设置一些默认初始值。。。</span></span><br><span class="line">        <span class="comment">//调用dao</span></span><br><span class="line">        commentRepository.save(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新评论</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> comment</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateComment</span><span class="params">(Comment comment)</span>&#123;</span><br><span class="line">        <span class="comment">//调用dao</span></span><br><span class="line">        commentRepository.save(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除评论</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteCommentById</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="comment">//调用dao</span></span><br><span class="line">        commentRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有评论</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Comment&gt; <span class="title function_">findCommentList</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//调用dao</span></span><br><span class="line">        <span class="keyword">return</span> commentRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询评论</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Comment <span class="title function_">findCommentById</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="comment">//调用dao</span></span><br><span class="line">        <span class="keyword">return</span> commentRepository.findById(id).orElse(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Page&lt;Comment&gt; <span class="title function_">findCommentListByParentid</span><span class="params">(String parentid,<span class="type">int</span> page,<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="comment">//为什么要page-1？因为参数穿进去的是zero-based page index.，基于0开始的索引的页码</span></span><br><span class="line">        <span class="keyword">return</span> commentRepository.findByParentid(parentid,PageRequest.of(page-<span class="number">1</span>,size));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 点赞数+1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCommentLikenum</span><span class="params">(String id)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  查询条件</span></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria.where(<span class="string">&quot;_id&quot;</span>).is(id));</span><br><span class="line">        <span class="comment">//  更新条件</span></span><br><span class="line">        <span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">        <span class="comment">//对赞数列递增1</span></span><br><span class="line">        update.inc(<span class="string">&quot;likenum&quot;</span>);</span><br><span class="line">        <span class="comment">//更新点赞数</span></span><br><span class="line">        <span class="comment">//参数1：查询对象</span></span><br><span class="line">        <span class="comment">//参数2：更新对象</span></span><br><span class="line">        <span class="comment">//参数3：集合的名字或实体类的类型Comment.class</span></span><br><span class="line">        mongoTemplate.updateFirst(query,update,Comment.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（3）新建Junit测试类，测试保存和查询所有："><a href="#（3）新建Junit测试类，测试保存和查询所有：" class="headerlink" title="（3）新建Junit测试类，测试保存和查询所有："></a>（3）新建Junit测试类，测试保存和查询所有：</h4><p>在article\src\test\java下新建测试类cn.itcast.article.service.CommentServiceTest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.ArticleApplication;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.po.Comment;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试评论的业务层</span></span><br><span class="line"><span class="comment">//SpringBoot的Junit集成测试</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="comment">//SpringBoot的测试环境初始化，参数：启动类</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = ArticleApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommentServiceTest</span> &#123;</span><br><span class="line">    <span class="comment">//注入Service</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentService commentService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindCommentList</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Comment&gt; commentList = commentService.findCommentList();</span><br><span class="line">        System.out.println(commentList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAll</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;Comment&gt; list = commentService.findCommentList();</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试根据id查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindCommentById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Comment</span> <span class="variable">commentById</span> <span class="operator">=</span> commentService.findCommentById(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        System.out.println(commentById);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存一个评论</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSaveComment</span><span class="params">()</span>&#123;</span><br><span class="line">        Comment comment=<span class="keyword">new</span> <span class="title class_">Comment</span>();</span><br><span class="line">        comment.setArticleid(<span class="string">&quot;100000&quot;</span>);</span><br><span class="line">        comment.setContent(<span class="string">&quot;测试添加的数据&quot;</span>);</span><br><span class="line">        comment.setCreatedatetime(LocalDateTime.now());</span><br><span class="line">        comment.setUserid(<span class="string">&quot;1003&quot;</span>);</span><br><span class="line">        comment.setNickname(<span class="string">&quot;凯撒大帝&quot;</span>);</span><br><span class="line">        comment.setState(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        comment.setLikenum(<span class="number">0</span>);</span><br><span class="line">        comment.setReplynum(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        commentService.saveComment(comment);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试根据父id查询子评论的分页列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindCommentListByParentid</span><span class="params">()</span> &#123;</span><br><span class="line">        Page&lt;Comment&gt; page = commentService.findCommentListByParentid(<span class="string">&quot;3&quot;</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;----总记录数：&quot;</span> + page.getTotalElements());</span><br><span class="line">        System.out.println(<span class="string">&quot;----当前页数据：&quot;</span> + page.getContent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 点赞数+1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateCommentLikenum</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//对1号文档的点赞数+1</span></span><br><span class="line">        commentService.updateCommentLikenum(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>添加一条测试数据</p>
<p>根据上级ID查询文章评论的分页列表</p>
<blockquote>
<p>插入一条测试数据</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert([&#123;&quot;parentid&quot;:&quot;3&quot;,&quot;nickname&quot;:&quot;张三&quot;&#125;])</span><br></pre></td></tr></table></figure>

<p>MongoTemplate实现评论点赞</p>
<h2 id="十二、MongoDB副本集"><a href="#十二、MongoDB副本集" class="headerlink" title="十二、MongoDB副本集"></a>十二、MongoDB副本集</h2><p>MongoDB独立模式可以简单且快速的构建MongoDB数据库系统，然而独立模式存在弊端，即一旦MongoDB发生宕机，将会面临数据丢失的风险，这在生产环境中是不允许发生的，此时我们可以利用MongoDB提供的高可用机制，即复制。<strong>MongoDB支持两种复制类型：传统的主&#x2F;从复制和副本集，副本集可以理解为传统主&#x2F;从复制的一种复杂形式，支持自动故障恢复功能，拥有更高的可用性，是MongoDB部署中的一种推荐方法</strong>。</p>
<h3 id="副本集概述"><a href="#副本集概述" class="headerlink" title="副本集概述"></a>副本集概述</h3><p>副本集（Replica Set）是一组MongoDB实例保持其相同数据集的集群，由一个主（<strong>Primary</strong>）服务器和多个副本（<strong>Secondary</strong>）服务器构成。通过复制（<strong>Replication</strong>）将<u>数据的更新由主服务器推送到其它副本服务器上</u>，在一定的延迟之后，达到每个MongoDB实例维护相同的数据集副本。副本集通过<strong>维护冗余的数据库副本</strong>、<strong>读写分离</strong>和<strong>故障自动转移</strong>的功能，摆脱数据库在使用过程中出现的环境故障影响，是所有生产环境部署的基础。</p>
<ul>
<li><strong>数据的冗余</strong>：副本集可以确保副本节点与主节点数据的自动异步同步，以防止单个数据库服务宕机造成数据丢失的问题。这些副本节点可以和主节点位于同一数据中心或出于安全考虑分布于其它数据中心。</li>
<li><strong>自动故障转移</strong>：副本集没有固定的主节点，整个集群会选举出一个主节点，当这个主节点不能正常工作时，会选举出一个副本节点切换为主节点，客户端会连接到这个新的主节点，并且数据和应用程序都将保持可用。MongoDB副本集实现这样的主&#x2F;副本切换是自动的，因此副本集是保证MongoDB高可用的基础。</li>
<li><strong>读写分离</strong>：副本集可以将读取请求分流到所有副本上，以减轻主节点的读写压力。</li>
</ul>
<h3 id="副本集成员"><a href="#副本集成员" class="headerlink" title="副本集成员"></a>副本集成员</h3><p>副本集有三个主要成员主节点（Primary）、副本节点（Secondary）、仲裁节点（Arbiter）。</p>
<ul>
<li><p><strong>主节点</strong>——主节点是副本集中负责处理客户端请求和读写数据主要成员。主节点通过oplog（操作日志）记录所有操作。副本集中<u>有且只有一个主节点</u>，如果当前主节点不可用，则会从副本节点中<u>选举出新的主节点</u>。</p>
</li>
<li><p><strong>副本节点</strong>——副本节点定期轮询主节点获取oplog记录的操作内容，然后对自己的数据副本执行这些操作，从而保证副本节点的<u>数据副本与主节点保持一致</u>。副本集中可以有一个或多个副本节点。当主节点宕机时，副本集会根据优先级选举出新的主节点。</p>
</li>
<li><p><strong>仲裁节点</strong>——仲裁节点<u>不会同步</u>主节点的数据副本，也<u>不会被选举</u>为主节点，它主要是<u>参与选举投票</u>。仲裁节点需要的资源很小。当副本集中成员个数为偶数时，建议添加一个仲裁节点，防止选举新的主节点过程中出现票数一致，导致无法选举出新的主节点。</p>
</li>
</ul>
<h4 id="副本集成员架构"><a href="#副本集成员架构" class="headerlink" title="副本集成员架构"></a><strong>副本集成员架构</strong></h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202203272158076.png" alt="image-20220327215829965" style="zoom: 67%;" />

<p>客户端程序（Client Application）通过驱动器（Driver）连接副本集主节点（Primary）进行读写操作，当主节点数据副本发生变化，此时副本节点（Secondary）通过Replication（复制）同步主节点的数据副本，使副本集中副本节点与主节点存储相同数据副本。</p>
<p>副本集中的各节点还会通过传递心跳信息（Heartbeat）来检测各自的健康状态。<strong>当主节点故障时，拥有投票权的副本节点和仲裁节点（Arbiter）会触发一次新的选举操作，并从副本节点中选举出新的主节点，以确保副本集正常运行</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202203272202765.png" alt="image-20220327220205644"></p>
<h3 id="部署副本集"><a href="#部署副本集" class="headerlink" title="部署副本集"></a>部署副本集</h3><h4 id="推荐方案"><a href="#推荐方案" class="headerlink" title="推荐方案"></a>推荐方案</h4><p>通过三台虚拟机部署官方推荐方案的副本集，该副本集包含一个主节点和两个副本节点，三台虚拟机的创建可参考本书资源中提供的环境配置文档，副本集各服务器的基本信息及角色分配如下表。</p>
<table>
<thead>
<tr>
<th><strong>虚拟机名称</strong></th>
<th><strong>IP****地址</strong></th>
<th><strong>成员角色</strong></th>
<th><strong>主机名</strong></th>
</tr>
</thead>
<tbody><tr>
<td>NoSQL_01</td>
<td>192.168.24.14</td>
<td>主节点</td>
<td>nosql01</td>
</tr>
<tr>
<td>NoSQL_02</td>
<td>192.168.24.15</td>
<td>副本节点</td>
<td>nosql02</td>
</tr>
<tr>
<td>NoSQL_03</td>
<td>192.168.24.16</td>
<td>副本节点</td>
<td>nosql03</td>
</tr>
</tbody></table>
<p>为了降低资源分配，这里仅使用一台服务器，但是分配3个端口（27017、27018、27019）来分别实现主节点、副本节点、和仲裁节点的功能。</p>
<h4 id="1-创建主节点"><a href="#1-创建主节点" class="headerlink" title="1.创建主节点"></a>1.创建主节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#建立存放数据和日志的目录：</span></span><br><span class="line"><span class="comment">#-----------shihanshuors </span></span><br><span class="line">	<span class="comment">#主节点</span></span><br><span class="line">	<span class="built_in">mkdir</span> -p /opt/module/mongodb/replica_sets/shihanshuors_27017/logs \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/replica_sets/shihanshuors_27017/data/db</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#新建或修改配置文件：</span></span><br><span class="line">	vi /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">systemLog:</span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件 </span></span><br><span class="line">  <span class="comment">##The path of the log file to which mongod or mongos should send all diagnostic logging information</span></span><br><span class="line">  destination: file </span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径 </span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/replica_sets/shihanshuors_27017/logs/mongologs.log&quot;</span> </span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。 </span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。 </span></span><br><span class="line">  <span class="comment">##The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;. </span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/replica_sets/shihanshuors_27017/data/db&quot;</span> </span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。 </span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。 </span></span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/replica_sets/shihanshuors_27017/logs/mongod.pid&quot;</span>  </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105</span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口，默认是27017 </span></span><br><span class="line">  port: 27017</span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuors</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#启动节点服务：</span></span><br><span class="line">	mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span><br></pre></td></tr></table></figure>

<h4 id="2-创建副本节点"><a href="#2-创建副本节点" class="headerlink" title="2.创建副本节点"></a>2.创建副本节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#建立存放数据和日志的目录：</span></span><br><span class="line"><span class="comment">#-----------shihanshuors </span></span><br><span class="line">	<span class="comment">#主节点</span></span><br><span class="line">	<span class="built_in">mkdir</span> -p /opt/module/mongodb/replica_sets/shihanshuors_27018/logs \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/replica_sets/shihanshuors_27018/data/db</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#新建或修改配置文件：</span></span><br><span class="line">	vi /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">systemLog:</span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件 </span></span><br><span class="line">  <span class="comment">##The path of the log file to which mongod or mongos should send all diagnostic logging information</span></span><br><span class="line">  destination: file </span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径 </span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/replica_sets/shihanshuors_27018/logs/mongologs.log&quot;</span> </span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。 </span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。 </span></span><br><span class="line">  <span class="comment">##The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;. </span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/replica_sets/shihanshuors_27018/data/db&quot;</span> </span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。 </span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。 </span></span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/replica_sets/shihanshuors_27018/logs/mongod.pid&quot;</span>  </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105</span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口，默认是27018 </span></span><br><span class="line">  port: 27018</span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuors</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#启动节点服务：</span></span><br><span class="line">	mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br></pre></td></tr></table></figure>

<h4 id="3-创建仲裁节点"><a href="#3-创建仲裁节点" class="headerlink" title="3.创建仲裁节点"></a>3.创建仲裁节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#建立存放数据和日志的目录：</span></span><br><span class="line"><span class="comment">#-----------shihanshuors </span></span><br><span class="line">	<span class="comment">#主节点</span></span><br><span class="line">	<span class="built_in">mkdir</span> -p /opt/module/mongodb/replica_sets/shihanshuors_27019/logs \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/replica_sets/shihanshuors_27019/data/db</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#新建或修改配置文件：</span></span><br><span class="line">	vi /opt/module/mongodb/replica_sets/shihanshuors_27019/mongod.conf</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">systemLog:</span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件 </span></span><br><span class="line">  <span class="comment">##The path of the log file to which mongod or mongos should send all diagnostic logging information</span></span><br><span class="line">  destination: file </span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径 </span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/replica_sets/shihanshuors_27019/logs/mongologs.log&quot;</span> </span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。 </span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。 </span></span><br><span class="line">  <span class="comment">##The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;. </span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/replica_sets/shihanshuors_27019/data/db&quot;</span> </span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。 </span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。 </span></span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/replica_sets/shihanshuors_27019/logs/mongod.pid&quot;</span>  </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105</span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口，默认是27019 </span></span><br><span class="line">  port: 27019</span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuors</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#启动节点服务：</span></span><br><span class="line">	mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27019/mongod.conf</span><br></pre></td></tr></table></figure>

<h4 id="4-启动服务-2"><a href="#4-启动服务-2" class="headerlink" title="4.启动服务"></a>4.启动服务</h4><p>执行 <code>ps -ef|grep mongod</code> 查看端口是否已启动服务</p>
<h4 id="5-初始化配置副本集和主节点"><a href="#5-初始化配置副本集和主节点" class="headerlink" title="5.初始化配置副本集和主节点"></a>5.初始化配置副本集和主节点</h4><p>使用客户端命令连接任意一个节点，但这里尽量要连接主节点(27017节点)：</p>
<p>由于之前已经配置过环境变量且当前是在本机中测试，因此可以使用 <code>mongo --port=27017</code> 连接上之后，很多命令无法使用，比如 <code>show dbs</code> 等，必须初始化副本集才行。准备初始化新的副本集：rs.initiate()</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# ps -ef | grep mongod</span><br><span class="line">root        2454       1  0 20:20 ?        00:00:01 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span><br><span class="line">root        2519       1  0 20:21 ?        00:00:01 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br><span class="line">root        2590       1  6 20:23 ?        00:00:00 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27019/mongod.conf</span><br><span class="line">root        2645    2338  0 20:23 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Server01 ~]# mongo --port=27017</span><br><span class="line">MongoDB shell version v4.4.24</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;aeaf58ca-9271-4d80-9c27-ef91bf1f42ca&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.4.24</span><br><span class="line">---</span><br><span class="line">The server generated these startup warnings when booting: </span><br><span class="line">        2023-10-08T20:20:45.692+08:00: Access control is not enabled <span class="keyword">for</span> the database. Read and write access to data and configuration is unrestricted</span><br><span class="line">        2023-10-08T20:20:45.692+08:00: You are running this process as the root user, <span class="built_in">which</span> is not recommended</span><br><span class="line">        2023-10-08T20:20:45.692+08:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>. We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">        2023-10-08T20:20:45.692+08:00: Soft rlimits too low</span><br><span class="line">        2023-10-08T20:20:45.692+08:00:         currentValue: 1024</span><br><span class="line">        2023-10-08T20:20:45.692+08:00:         recommendedMinimum: 64000</span><br><span class="line">---</span><br><span class="line">&gt; show dbs</span><br><span class="line">uncaught exception: Error: listDatabases failed:&#123;</span><br><span class="line">	<span class="string">&quot;topologyVersion&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;processId&quot;</span> : ObjectId(<span class="string">&quot;65229e9d3d28ff7e81a43fe4&quot;</span>),</span><br><span class="line">		<span class="string">&quot;counter&quot;</span> : NumberLong(0)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;not master and slaveOk=false&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 13435,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotPrimaryNoSecondaryOk&quot;</span></span><br><span class="line">&#125; :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">Mongo.prototype.getDBs/&lt;@src/mongo/shell/mongo.js:147:19</span><br><span class="line">Mongo.prototype.getDBs@src/mongo/shell/mongo.js:99:12</span><br><span class="line">shellHelper.show@src/mongo/shell/utils.js:937:13</span><br><span class="line">shellHelper@src/mongo/shell/utils.js:819:15</span><br><span class="line">@(shellhelp2):1:1</span><br><span class="line">&gt; rs.<span class="function"><span class="title">initiate</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;info2&quot;</span> : <span class="string">&quot;no configuration specified. Using a default configuration for the set&quot;</span>,</span><br><span class="line">	<span class="string">&quot;me&quot;</span> : <span class="string">&quot;192.168.24.105:27017&quot;</span>,</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line"><span class="built_in">local</span>   0.000GB</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br></pre></td></tr></table></figure>

<p>提示：<br>1）“ok”的值为1，说明创建成功。<br>2）命令行提示符发生变化，变成了一个从节点角色，此时默认不能读写。稍等片刻，回车，变成主节点。</p>
<h4 id="6-查看副本集的配置内容"><a href="#6-查看副本集的配置内容" class="headerlink" title="6.查看副本集的配置内容"></a>6.查看副本集的配置内容</h4><p><strong>说明</strong>：<br>返回包含当前副本集配置的文档。<br><strong>语法</strong>：<br>rs.conf(configuration)<br>rs.config() 是该方法的别名。</p>
<p>configuration：可选，如果没有配置，则使用默认主节点配置</p>
<p>【示例】<br>在27017上执行副本集中当前节点的默认节点配置：rs.conf()</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; rs.<span class="function"><span class="title">conf</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuors&quot;</span>,</span><br><span class="line">	<span class="string">&quot;version&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;term&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;protocolVersion&quot;</span> : NumberLong(1),</span><br><span class="line">	<span class="string">&quot;writeConcernMajorityJournalDefault&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;members&quot;</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.24.105:27017&quot;</span>,</span><br><span class="line">			<span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">			<span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">			<span class="string">&quot;priority&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line">				</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line">			<span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="string">&quot;settings&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;chainingAllowed&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">		<span class="string">&quot;heartbeatIntervalMillis&quot;</span> : 2000,</span><br><span class="line">		<span class="string">&quot;heartbeatTimeoutSecs&quot;</span> : 10,</span><br><span class="line">		<span class="string">&quot;electionTimeoutMillis&quot;</span> : 10000,</span><br><span class="line">		<span class="string">&quot;catchUpTimeoutMillis&quot;</span> : -1,</span><br><span class="line">		<span class="string">&quot;catchUpTakeoverDelayMillis&quot;</span> : 30000,</span><br><span class="line">		<span class="string">&quot;getLastErrorModes&quot;</span> : &#123;</span><br><span class="line">			</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;getLastErrorDefaults&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;w&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;wtimeout&quot;</span> : 0</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;replicaSetId&quot;</span> : ObjectId(<span class="string">&quot;65229fa43d28ff7e81a43ffc&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>1） “_id” : “shihanshuors” ：副本集的配置数据存储的主键值，默认就是副本集的名字</p>
<p>2） “members” ：副本集成员数组，此时只有一个： “host” : “192.168.24.105:27017”，该成员不是仲裁节点：”arbiterOnly” : false ，优先级（权重值）： “priority” : 1, </p>
<p>3） “settings” ：副本集的参数配置。</p>
<h4 id="7-查看副本集状态"><a href="#7-查看副本集状态" class="headerlink" title="7.查看副本集状态"></a>7.查看副本集状态</h4><p>检查副本集状态。</p>
<p><strong>说明</strong>：<br>返回包含状态信息的文档。此输出使用从副本集的其他成员发送的心跳包中获得的数据反映副本集的当前状态。<br><strong>语法</strong>：<br>rs.status()</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; rs.<span class="function"><span class="title">status</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;set&quot;</span> : <span class="string">&quot;shihanshuors&quot;</span>,</span><br><span class="line">	<span class="string">&quot;date&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:26:22.897Z&quot;</span>),</span><br><span class="line">	<span class="string">&quot;myState&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;term&quot;</span> : NumberLong(1),</span><br><span class="line">	<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">	<span class="string">&quot;heartbeatIntervalMillis&quot;</span> : NumberLong(2000),</span><br><span class="line">	<span class="string">&quot;majorityVoteCount&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;writeMajorityCount&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;votingMembersCount&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;writableVotingMembersCount&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;optimes&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;lastCommittedOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696767978, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastCommittedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:26:18.962Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;readConcernMajorityOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696767978, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;readConcernMajorityWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:26:18.962Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;appliedOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696767978, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;durableOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696767978, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:26:18.962Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:26:18.962Z&quot;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;lastStableRecoveryTimestamp&quot;</span> : Timestamp(1696767958, 1),</span><br><span class="line">	<span class="string">&quot;electionCandidateMetrics&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;lastElectionReason&quot;</span> : <span class="string">&quot;electionTimeout&quot;</span>,</span><br><span class="line">		<span class="string">&quot;lastElectionDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08.924Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;electionTerm&quot;</span> : NumberLong(1),</span><br><span class="line">		<span class="string">&quot;lastCommittedOpTimeAtElection&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(0, 0),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(-1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastSeenOpTimeAtElection&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696767908, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(-1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;numVotesNeeded&quot;</span> : 1,</span><br><span class="line">		<span class="string">&quot;priorityAtElection&quot;</span> : 1,</span><br><span class="line">		<span class="string">&quot;electionTimeoutMillis&quot;</span> : NumberLong(10000),</span><br><span class="line">		<span class="string">&quot;newTermStartDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08.951Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;wMajorityWriteAvailabilityDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08.969Z&quot;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;members&quot;</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.24.105:27017&quot;</span>,</span><br><span class="line">			<span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;state&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">			<span class="string">&quot;uptime&quot;</span> : 337,</span><br><span class="line">			<span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(1696767978, 1),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:26:18Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:26:18.962Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:26:18.962Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">			<span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;Could not find member to sync from&quot;</span>,</span><br><span class="line">			<span class="string">&quot;electionTime&quot;</span> : Timestamp(1696767908, 2),</span><br><span class="line">			<span class="string">&quot;electionDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;configVersion&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;configTerm&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;self&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1696767978, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1696767978, 1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：<br>1） “set” : “shihanshuors” ：副本集的名字<br>2） “myState” : 1：说明状态正常<br>3） “members” ：副本集成员数组，此时只有一个：”name” : “192.168.24.105:27017”，该成员的角色是”stateStr” : “PRIMARY”,该节点是健康的：”health” : 1 。</p>
<h4 id="8-添加副本从节点"><a href="#8-添加副本从节点" class="headerlink" title="8.添加副本从节点"></a>8.添加副本从节点</h4><p>在主节点添加从节点，将其他成员加入到副本集<br><strong>语法</strong>：rs.add(host, arbiterOnly)<br>选项：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202203272253117.png" alt="image-20220327225319996"></p>
<p>【示例】<br>将27018的副本节点添加到副本集中：rs.add(“192.168.24.105:27018”)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; rs.add(<span class="string">&quot;192.168.24.105:27018&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1696768126, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1696768126, 1)</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; rs.<span class="function"><span class="title">status</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;set&quot;</span> : <span class="string">&quot;shihanshuors&quot;</span>,</span><br><span class="line">	<span class="string">&quot;date&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:15.646Z&quot;</span>),</span><br><span class="line">	<span class="string">&quot;myState&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;term&quot;</span> : NumberLong(1),</span><br><span class="line">	<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">	<span class="string">&quot;heartbeatIntervalMillis&quot;</span> : NumberLong(2000),</span><br><span class="line">	<span class="string">&quot;majorityVoteCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;writeMajorityCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;votingMembersCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;writableVotingMembersCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;optimes&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;lastCommittedOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696768329, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastCommittedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09.024Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;readConcernMajorityOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696768329, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;readConcernMajorityWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09.024Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;appliedOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696768329, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;durableOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696768329, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09.024Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09.024Z&quot;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;lastStableRecoveryTimestamp&quot;</span> : Timestamp(1696768319, 1),</span><br><span class="line">	<span class="string">&quot;electionCandidateMetrics&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;lastElectionReason&quot;</span> : <span class="string">&quot;electionTimeout&quot;</span>,</span><br><span class="line">		<span class="string">&quot;lastElectionDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08.924Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;electionTerm&quot;</span> : NumberLong(1),</span><br><span class="line">		<span class="string">&quot;lastCommittedOpTimeAtElection&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(0, 0),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(-1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastSeenOpTimeAtElection&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696767908, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(-1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;numVotesNeeded&quot;</span> : 1,</span><br><span class="line">		<span class="string">&quot;priorityAtElection&quot;</span> : 1,</span><br><span class="line">		<span class="string">&quot;electionTimeoutMillis&quot;</span> : NumberLong(10000),</span><br><span class="line">		<span class="string">&quot;newTermStartDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08.951Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;wMajorityWriteAvailabilityDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08.969Z&quot;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;members&quot;</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.24.105:27017&quot;</span>,</span><br><span class="line">			<span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;state&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">			<span class="string">&quot;uptime&quot;</span> : 690,</span><br><span class="line">			<span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(1696768329, 1),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09.024Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09.024Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">			<span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;electionTime&quot;</span> : Timestamp(1696767908, 2),</span><br><span class="line">			<span class="string">&quot;electionDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;configVersion&quot;</span> : 2,</span><br><span class="line">			<span class="string">&quot;configTerm&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;self&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.24.105:27018&quot;</span>,</span><br><span class="line">			<span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;state&quot;</span> : 2,</span><br><span class="line">			<span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;SECONDARY&quot;</span>,</span><br><span class="line">			<span class="string">&quot;uptime&quot;</span> : 209,</span><br><span class="line">			<span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(1696768329, 1),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDurable&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(1696768329, 1),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;optimeDurableDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09.024Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:09.024Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastHeartbeat&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:14.434Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatRecv&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:32:15.611Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;pingMs&quot;</span> : NumberLong(0),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;192.168.24.105:27017&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceId&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;configVersion&quot;</span> : 2,</span><br><span class="line">			<span class="string">&quot;configTerm&quot;</span> : 1</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1696768329, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1696768329, 1)</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>说明：<br>1） “ok” : 1 ：说明添加成功。可以查看副本集状态：rs.status()</p>
<p>2） “name” : “192.168.24.105:27018”,是第二个节点的名字，其角色是 “stateStr” : “SECONDARY”</p>
<h4 id="9-添加仲裁从节点"><a href="#9-添加仲裁从节点" class="headerlink" title="9.添加仲裁从节点"></a>9.添加仲裁从节点</h4><p>添加一个仲裁节点到副本集<br><strong>语法</strong>：rs.addArb(host)</p>
<p>【示例】<br>将27019的仲裁节点添加到副本集中：rs.addArb(“192.168.24.105:27019”)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; rs.addArb(<span class="string">&quot;192.168.24.105:27019&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1696768393, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1696768393, 1)</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; rs.<span class="function"><span class="title">status</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;set&quot;</span> : <span class="string">&quot;shihanshuors&quot;</span>,</span><br><span class="line">	<span class="string">&quot;date&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:17.655Z&quot;</span>),</span><br><span class="line">	<span class="string">&quot;myState&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;term&quot;</span> : NumberLong(1),</span><br><span class="line">	<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">	<span class="string">&quot;heartbeatIntervalMillis&quot;</span> : NumberLong(2000),</span><br><span class="line">	<span class="string">&quot;majorityVoteCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;writeMajorityCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;votingMembersCount&quot;</span> : 3,</span><br><span class="line">	<span class="string">&quot;writableVotingMembersCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;optimes&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;lastCommittedOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696768393, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastCommittedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13.643Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;readConcernMajorityOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696768393, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;readConcernMajorityWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13.643Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;appliedOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696768393, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;durableOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696768393, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13.643Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13.643Z&quot;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;lastStableRecoveryTimestamp&quot;</span> : Timestamp(1696768379, 1),</span><br><span class="line">	<span class="string">&quot;electionCandidateMetrics&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;lastElectionReason&quot;</span> : <span class="string">&quot;electionTimeout&quot;</span>,</span><br><span class="line">		<span class="string">&quot;lastElectionDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08.924Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;electionTerm&quot;</span> : NumberLong(1),</span><br><span class="line">		<span class="string">&quot;lastCommittedOpTimeAtElection&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(0, 0),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(-1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastSeenOpTimeAtElection&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1696767908, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(-1)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;numVotesNeeded&quot;</span> : 1,</span><br><span class="line">		<span class="string">&quot;priorityAtElection&quot;</span> : 1,</span><br><span class="line">		<span class="string">&quot;electionTimeoutMillis&quot;</span> : NumberLong(10000),</span><br><span class="line">		<span class="string">&quot;newTermStartDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08.951Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;wMajorityWriteAvailabilityDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08.969Z&quot;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;members&quot;</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.24.105:27017&quot;</span>,</span><br><span class="line">			<span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;state&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">			<span class="string">&quot;uptime&quot;</span> : 752,</span><br><span class="line">			<span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(1696768393, 1),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13.643Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13.643Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">			<span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;electionTime&quot;</span> : Timestamp(1696767908, 2),</span><br><span class="line">			<span class="string">&quot;electionDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:25:08Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;configVersion&quot;</span> : 3,</span><br><span class="line">			<span class="string">&quot;configTerm&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;self&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.24.105:27018&quot;</span>,</span><br><span class="line">			<span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;state&quot;</span> : 2,</span><br><span class="line">			<span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;SECONDARY&quot;</span>,</span><br><span class="line">			<span class="string">&quot;uptime&quot;</span> : 271,</span><br><span class="line">			<span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(1696768393, 1),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDurable&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(1696768393, 1),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;optimeDurableDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13.643Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:13.643Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastHeartbeat&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:17.650Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatRecv&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:17.654Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;pingMs&quot;</span> : NumberLong(0),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;192.168.24.105:27017&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceId&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;configVersion&quot;</span> : 3,</span><br><span class="line">			<span class="string">&quot;configTerm&quot;</span> : 1</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 2,</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.24.105:27019&quot;</span>,</span><br><span class="line">			<span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;state&quot;</span> : 7,</span><br><span class="line">			<span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;ARBITER&quot;</span>,</span><br><span class="line">			<span class="string">&quot;uptime&quot;</span> : 4,</span><br><span class="line">			<span class="string">&quot;lastHeartbeat&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:17.654Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatRecv&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:33:15.670Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;pingMs&quot;</span> : NumberLong(0),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">			<span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;configVersion&quot;</span> : 3,</span><br><span class="line">			<span class="string">&quot;configTerm&quot;</span> : 1</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1696768393, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1696768393, 1)</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br></pre></td></tr></table></figure>

<p><strong>说明</strong>：<br>1） “ok” : 1 ：说明添加成功。可以查看副本集状态：rs.status()</p>
<p>2） “name” : “192.168.24.105:27019” 是第二个节点的名字，其角色是 “stateStr” : “ARBITER”</p>
<h4 id="10-可使用可视化工具创建连接"><a href="#10-可使用可视化工具创建连接" class="headerlink" title="10.可使用可视化工具创建连接"></a>10.可使用可视化工具创建连接</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202203272305284.png" alt="image-20220327230534110"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202203272309742.png" alt="image-20220327230932433"></p>
<p>Studio 3T版本</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231008203753280.png" alt="image-20231008203753280"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231008203945468.png" alt="image-20231008203945468"></p>
<h3 id="副本集操作"><a href="#副本集操作" class="headerlink" title="副本集操作"></a>副本集操作</h3><h4 id="副本集的数据读写操作"><a href="#副本集的数据读写操作" class="headerlink" title="副本集的数据读写操作"></a>副本集的数据读写操作</h4><p>目标：测试三个不同角色的节点的数据读写情况。</p>
<h5 id="1-登录主节点27017"><a href="#1-登录主节点27017" class="headerlink" title="1.登录主节点27017"></a>1.登录主节点27017</h5><p>   使用mongo shell 登录主节点27017，写入和读取数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --host=192.168.24.105 --port=27017</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202203280932466.png" alt="image-20220328093229158" style="zoom:50%;" /> 

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line"><span class="built_in">local</span>   0.000GB</span><br><span class="line">shihanshuors:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuors:PRIMARY&gt; db</span><br><span class="line">articledb</span><br><span class="line">shihanshuors:PRIMARY&gt;db.comment.insert(&#123;<span class="string">&quot;articleid&quot;</span>:<span class="string">&quot;100000&quot;</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;今天天气真好，阳光 明媚&quot;</span>,<span class="string">&quot;userid&quot;</span>:<span class="string">&quot;1001&quot;</span>,<span class="string">&quot;nickname&quot;</span>:<span class="string">&quot;Rose&quot;</span>,<span class="string">&quot;createdatetime&quot;</span>:new Date()&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : 1 &#125;)</span><br><span class="line">shihanshuors:PRIMARY&gt; db.comment.find()</span><br></pre></td></tr></table></figure>

<p> 或使用可视化工具打开主节点服务器</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202203280933637.png" alt="image-20220328093307456" style="zoom: 50%;" />

<p>插入测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert(&#123;&quot;articleid&quot;:&quot;100000&quot;,&quot;content&quot;:&quot;今天天气真好，阳光明媚&quot;,&quot;userid&quot;:&quot;1001&quot;,&quot;nickname&quot;:&quot;Rose&quot;,&quot;createdatetime&quot;:<span class="keyword">new</span> <span class="type">Date</span>()&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202203280940787.png" alt="image-20220328094039496"></p>
<h5 id="2-登录从节点27018："><a href="#2-登录从节点27018：" class="headerlink" title="2.登录从节点27018："></a>2.登录从节点27018：</h5><p>使用mongo shell 登录从节点，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongo --host=192.168.24.105 --port=27018</span><br><span class="line">MongoDB shell version v4.4.24</span><br><span class="line">connecting to: mongodb://192.168.24.105:27018/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;4b677922-4900-45d4-a671-3f5a32659899&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.4.24</span><br><span class="line">---</span><br><span class="line">The server generated these startup warnings when booting: </span><br><span class="line">        2023-10-08T20:21:35.751+08:00: Access control is not enabled <span class="keyword">for</span> the database. Read and write access to data and configuration is unrestricted</span><br><span class="line">        2023-10-08T20:21:35.751+08:00: You are running this process as the root user, <span class="built_in">which</span> is not recommended</span><br><span class="line">        2023-10-08T20:21:35.751+08:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>. We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">        2023-10-08T20:21:35.751+08:00: Soft rlimits too low</span><br><span class="line">        2023-10-08T20:21:35.751+08:00:         currentValue: 1024</span><br><span class="line">        2023-10-08T20:21:35.751+08:00:         recommendedMinimum: 64000</span><br><span class="line">---</span><br><span class="line">shihanshuors:SECONDARY&gt; show dbs</span><br><span class="line">uncaught exception: Error: listDatabases failed:&#123;</span><br><span class="line">	<span class="string">&quot;topologyVersion&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;processId&quot;</span> : ObjectId(<span class="string">&quot;65229ecfc331e179e72265cd&quot;</span>),</span><br><span class="line">		<span class="string">&quot;counter&quot;</span> : NumberLong(4)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1696769379, 1),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;not master and slaveOk=false&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 13435,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotPrimaryNoSecondaryOk&quot;</span>,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1696769379, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">Mongo.prototype.getDBs/&lt;@src/mongo/shell/mongo.js:147:19</span><br><span class="line">Mongo.prototype.getDBs@src/mongo/shell/mongo.js:99:12</span><br><span class="line">shellHelper.show@src/mongo/shell/utils.js:937:13</span><br><span class="line">shellHelper@src/mongo/shell/utils.js:819:15</span><br><span class="line">@(shellhelp2):1:1</span><br><span class="line">shihanshuors:SECONDARY&gt; rs.slaveOk()</span><br><span class="line">WARNING: slaveOk() is deprecated and may be removed <span class="keyword">in</span> the next major release. Please use secondaryOk() instead.</span><br><span class="line">shihanshuors:SECONDARY&gt; show dbs</span><br><span class="line">admin      0.000GB</span><br><span class="line">articledb  0.000GB</span><br><span class="line">config     0.000GB</span><br><span class="line"><span class="built_in">local</span>      0.000GB</span><br><span class="line"></span><br><span class="line">shihanshuors:SECONDARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuors:SECONDARY&gt; db.comment.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6241111d951e2161fb8bb4b9&quot;</span>), <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100000&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;今天天气真好，阳光 明媚&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1001&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;Rose&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-03-28T01:36:29.589Z&quot;</span>) &#125;</span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br></pre></td></tr></table></figure>

<p>发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行。<br>因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置。</p>
<p>设置读操作权限：<br><strong>说明</strong>：<br>设置为奴隶节点，允许在从成员上运行读的操作<br><strong>语法</strong>：<br><code>rs.slaveOk()</code> 或 <code>rs.slaveOk(true)</code><br>提示：<br>该命令是 <code>db.getMongo().setSlaveOk()</code> 的简化命令。</p>
<p>现在可实现了读写分离，让主插入数据，让从来读取数据。<br>如果要取消作为奴隶节点的读权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:SECONDARY&gt; rs.slaveOk(<span class="literal">false</span>)</span><br><span class="line">WARNING: slaveOk() is deprecated and may be removed <span class="keyword">in</span> the next major release. Please use secondaryOk() instead.</span><br><span class="line">shihanshuors:SECONDARY&gt; db.comment.find()</span><br><span class="line">Error: error: &#123;</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1648432243, 1),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;not master and slaveOk=false&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 13435,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotPrimaryNoSecondaryOk&quot;</span>,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1648432243, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:SECONDARY&gt;</span><br></pre></td></tr></table></figure>

<h5 id="3-登录仲裁者节点27019"><a href="#3-登录仲裁者节点27019" class="headerlink" title="3.登录仲裁者节点27019"></a>3.登录仲裁者节点27019</h5><p>仲裁者节点27019，不存放任何业务数据的，可以登录查看，我们发现，arbiter并没有进行数据同步，因为仲裁节点只参与投票，不接收数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongo --host=192.168.24.105 --port=27019</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://192.168.24.105:27019/?</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">shihanshuors:ARBITER&gt; show dbs</span><br><span class="line">2022-03-28T09:52:21.744+0800 E  QUERY    [js] uncaught exception: Error: listDatabases failed:&#123;</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;not master and slaveOk=false&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 13435,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotPrimaryNoSecondaryOk&quot;</span></span><br><span class="line">&#125; :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">Mongo.prototype.getDBs/&lt;@src/mongo/shell/mongo.js:147:19</span><br><span class="line">Mongo.prototype.getDBs@src/mongo/shell/mongo.js:99:12</span><br><span class="line">shellHelper.show@src/mongo/shell/utils.js:906:13</span><br><span class="line">shellHelper@src/mongo/shell/utils.js:790:15</span><br><span class="line">@(shellhelp2):1:1</span><br><span class="line">shihanshuors:ARBITER&gt; rs.slaveOk()</span><br><span class="line">WARNING: slaveOk() is deprecated and may be removed <span class="keyword">in</span> the next major release. Please use secondaryOk() instead.</span><br><span class="line">shihanshuors:ARBITER&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuors:ARBITER&gt; db</span><br><span class="line">articledb</span><br><span class="line">shihanshuors:ARBITER&gt; db.comment.find()</span><br><span class="line">Error: error: &#123;</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;node is not in primary or recovering state&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 13436,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotPrimaryOrSecondary&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:ARBITER&gt;</span><br></pre></td></tr></table></figure>

<h3 id="副本集机制"><a href="#副本集机制" class="headerlink" title="副本集机制"></a>副本集机制</h3><h4 id="同步机制"><a href="#同步机制" class="headerlink" title="同步机制"></a>同步机制</h4><p> 为了保证副本集中各成员中的数据副本一致，副本集的<strong>副本节点默认会以主节点作为同步源</strong>进行数据同步。</p>
<p>MongoDB使用两种形式完成数据同步过程，分别是<strong>完整同步</strong>和<strong>变化同步</strong>。</p>
<p>在副本集<u>新增成员</u>情况下，采用<strong>完整同步</strong>方式同步数据副本。</p>
<ul>
<li>新增成员选择副本集中的主节点作为同步源。</li>
<li>扫描源数据库中的每个集合，并将这些集合中的所有文档插入本地，此过程比较耗时。</li>
<li>通过主节点的oplog重建本地oplog。</li>
<li>完成初始化同步，成为副本节点。</li>
</ul>
<p>在副本集主节点中数据副本发生变化的情况下，采用<strong>变化同步</strong>方式同步数据副本。</p>
<ul>
<li>副本集主节点数据副本发生变化时，oplog会记录变化内容。</li>
<li>副本节点获取主节点oplog记录变化内容并执行相关操作。</li>
<li>副本节点根据主节点oplog重建本地oplog。</li>
</ul>
<h4 id="选举机制"><a href="#选举机制" class="headerlink" title="选举机制"></a>选举机制</h4><p>如果副本集的主节点在使用过程中发生故障导致无法使用，则其它拥有投票权的成员便会通过选举机制从副本集所有符合选举条件的成员中选出新的主节点。<strong>选举的过程可以由任意的非主节点成员发起</strong>，然后根据优先级和Bully算法（评判谁的数据最新）选举出主节点。<strong>在选举出主节点之前，整个集群服务是只读的</strong>，不能执行写入操作。非仲裁节点都有一个优先级的配置，范围为0~100， 值越大，则越优先成为主节点。默认情况下，优先级是1；如果优先级是0，则不能成为主节点。</p>
<h5 id="1-主节点的选举原则"><a href="#1-主节点的选举原则" class="headerlink" title="1.主节点的选举原则"></a>1.主节点的选举原则</h5><p>MongoDB在副本集中，会自动进行主节点的选举，<strong>主节点选举的触发条件</strong>：</p>
<p>​	1） 主节点故障</p>
<p>​	2） 主节点网络不可达（默认心跳信息为10秒）</p>
<p>​	3） 人工干预（rs.stepDown(600)）</p>
<p>一旦触发选举，就要根据一定规则来选主节点。选举规则是根据票数来决定谁获胜：</p>
<p>​	1)	票数最高，且获得了“<strong>大多数</strong>”成员的投票支持的节点获胜。“大多数”的定义为：假设复制集内投票成员数量为N，则大多数为 <strong>N&#x2F;2 + 1</strong>。例如：3个投票成员，则大多数的值是2。当复制集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，复制集将无法提供写服务，处于只读状态。</p>
<p>​	2)	若票数相同，且都获得了“大多数”成员的投票支持的，<strong>数据新的节点获胜</strong>。数据的新旧是通过操作日志oplog来对比的。</p>
<p>在获得票数的时候，优先级（priority）参数影响重大。</p>
<p>可以通过设置优先级（priority）来设置额外票数。优先级即权重，取值为0-1000，相当于可额外增加0-1000的票数，优先级的值越大，就越可能获得多数成员的投票（votes）数。指定较高的值可使成员更有资格成为主要成员，更低的值可使成员更不符合条件。</p>
<p>默认情况下，优先级的值是1。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 mongodb]# mongo --host=192.168.24.105 --port=27017</span><br><span class="line">MongoDB shell version v4.4.24</span><br><span class="line">connecting to: mongodb://192.168.24.105:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;ce47fbae-a157-442f-99f5-354b4e076b84&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.4.24</span><br><span class="line">---</span><br><span class="line">The server generated these startup warnings when booting: </span><br><span class="line">        2023-10-14T19:40:26.611+08:00: Access control is not enabled <span class="keyword">for</span> the database. Read and write access to data and configuration is unrestricted</span><br><span class="line">        2023-10-14T19:40:26.611+08:00: You are running this process as the root user, <span class="built_in">which</span> is not recommended</span><br><span class="line">        2023-10-14T19:40:26.611+08:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>. We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">        2023-10-14T19:40:26.611+08:00: Soft rlimits too low</span><br><span class="line">        2023-10-14T19:40:26.611+08:00:         currentValue: 1024</span><br><span class="line">        2023-10-14T19:40:26.611+08:00:         recommendedMinimum: 64000</span><br><span class="line">        2023-10-14T19:40:26.645+08:00: </span><br><span class="line">        2023-10-14T19:40:26.645+08:00: ** WARNING: This replica <span class="built_in">set</span> has a Primary-Secondary-Arbiter architecture, but readConcern:majority is enabled </span><br><span class="line">        2023-10-14T19:40:26.645+08:00: **          <span class="keyword">for</span> this node. This is not a recommended configuration. Please see </span><br><span class="line">        2023-10-14T19:40:26.645+08:00: **          https://dochub.mongodb.org/core/psa-disable-rc-majority</span><br><span class="line">        2023-10-14T19:40:26.645+08:00: </span><br><span class="line">---</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; rs.<span class="function"><span class="title">conf</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuors&quot;</span>,</span><br><span class="line">	<span class="string">&quot;version&quot;</span> : 3,</span><br><span class="line">	<span class="string">&quot;term&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;protocolVersion&quot;</span> : NumberLong(1),</span><br><span class="line">	<span class="string">&quot;writeConcernMajorityJournalDefault&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;members&quot;</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.24.105:27017&quot;</span>,</span><br><span class="line">			<span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">			<span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">			<span class="string">&quot;priority&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line">				</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line">			<span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.24.105:27018&quot;</span>,</span><br><span class="line">			<span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">			<span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">			<span class="string">&quot;priority&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line">				</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line">			<span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 2,</span><br><span class="line">			<span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.24.105:27019&quot;</span>,</span><br><span class="line">			<span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">			<span class="string">&quot;priority&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line">				</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line">			<span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="string">&quot;settings&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;chainingAllowed&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">		<span class="string">&quot;heartbeatIntervalMillis&quot;</span> : 2000,</span><br><span class="line">		<span class="string">&quot;heartbeatTimeoutSecs&quot;</span> : 10,</span><br><span class="line">		<span class="string">&quot;electionTimeoutMillis&quot;</span> : 10000,</span><br><span class="line">		<span class="string">&quot;catchUpTimeoutMillis&quot;</span> : -1,</span><br><span class="line">		<span class="string">&quot;catchUpTakeoverDelayMillis&quot;</span> : 30000,</span><br><span class="line">		<span class="string">&quot;getLastErrorModes&quot;</span> : &#123;</span><br><span class="line">			</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;getLastErrorDefaults&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;w&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;wtimeout&quot;</span> : 0</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;replicaSetId&quot;</span> : ObjectId(<span class="string">&quot;65229fa43d28ff7e81a43ffc&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br></pre></td></tr></table></figure>

<p>可以看出，主节点和副本节点的优先级各为1，即，默认可以认为都已经有了一票。但选举节点，优先级是0，（要注意是，官方说了，选举节点的优先级必须是0，不能是别的值。即不具备选举权，但具有投票权）</p>
<h4 id="故障测试"><a href="#故障测试" class="headerlink" title="故障测试"></a>故障测试</h4><h5 id="1-副本节点故障测试"><a href="#1-副本节点故障测试" class="headerlink" title="1.副本节点故障测试"></a>1.副本节点故障测试</h5><p>关闭27018副本节点：发现，主节点和仲裁节点对27018的心跳失败。因为主节点还在，因此，没有触发投票选举。如果此时，在主节点写入数据。</p>
<p>1）关闭副本节点27018</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf  --shutdown</span><br><span class="line">killing process with pid: 2677</span><br><span class="line">[root@Server01 ~]# ps -ef | grep mongod</span><br><span class="line">root        2604       1  0 19:40 ?        00:00:13 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span><br><span class="line">root        2752       1  0 19:40 ?        00:00:09 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27019/mongod.conf</span><br><span class="line">root        3455    2308  0 20:15 pts/0    00:00:00 grep --color=auto mongod</span><br></pre></td></tr></table></figure>

<p>2）登入主节点27017，执行 use articledb 切换后执行 db.comment.find() 查看当且数据，最后插入一条新的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; show dbs</span><br><span class="line">admin      0.000GB</span><br><span class="line">articledb  0.000GB</span><br><span class="line">config     0.000GB</span><br><span class="line"><span class="built_in">local</span>      0.000GB</span><br><span class="line">shihanshuors:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuors:PRIMARY&gt; db</span><br><span class="line">articledb</span><br><span class="line">shihanshuors:PRIMARY&gt; db.comment.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;7&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;吃饭前，先喝杯水或一碗汤，可减少饭量，对控制体重有帮助&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1007&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;玛丽莲•梦露&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="string">&quot;18&quot;</span>, <span class="string">&quot;phone&quot;</span> : <span class="string">&quot; 13937165554&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:46:31.423Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : <span class="string">&quot;8888&quot;</span>, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;null&quot;</span> &#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; db.comment.insert(&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1002&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;相忘于江湖&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-03-28T10:08:15.522Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 1000, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;) </span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : 1 &#125;)</span><br><span class="line">shihanshuors:PRIMARY&gt; db.comment.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;7&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;吃饭前，先喝杯水或一碗汤，可减少饭量，对控制体重有帮助&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1007&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;玛丽莲•梦露&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="string">&quot;18&quot;</span>, <span class="string">&quot;phone&quot;</span> : <span class="string">&quot; 13937165554&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:46:31.423Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : <span class="string">&quot;8888&quot;</span>, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;null&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1002&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;相忘于江湖&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-03-28T10:08:15.522Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 1000, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br></pre></td></tr></table></figure>

<p>3）再启动从节点，会发现，主节点写入的数据，会自动同步给从节点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 3494</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@Server01 ~]# ps -ef | grep mongod</span><br><span class="line">root        2604       1  0 19:40 ?        00:00:14 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span><br><span class="line">root        2752       1  0 19:40 ?        00:00:10 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27019/mongod.conf</span><br><span class="line">root        3494       1 26 20:17 ?        00:00:00 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br><span class="line">root        3578    2308  0 20:18 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@Server01 ~]# </span><br><span class="line">[root@Server01 ~]# mongo --host=192.168.24.105 --port=27018</span><br><span class="line">MongoDB shell version v4.4.24</span><br><span class="line">connecting to: mongodb://192.168.24.105:27018/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;172e00ad-5cb7-4f1c-90c5-c7dde3a0f9ff&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.4.24</span><br><span class="line">---</span><br><span class="line">The server generated these startup warnings when booting: </span><br><span class="line">        2023-10-14T20:17:59.369+08:00: Access control is not enabled <span class="keyword">for</span> the database. Read and write access to data and configuration is unrestricted</span><br><span class="line">        2023-10-14T20:17:59.369+08:00: You are running this process as the root user, <span class="built_in">which</span> is not recommended</span><br><span class="line">        2023-10-14T20:17:59.369+08:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>. We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">        2023-10-14T20:17:59.369+08:00: Soft rlimits too low</span><br><span class="line">        2023-10-14T20:17:59.369+08:00:         currentValue: 1024</span><br><span class="line">        2023-10-14T20:17:59.369+08:00:         recommendedMinimum: 64000</span><br><span class="line">        2023-10-14T20:17:59.385+08:00: </span><br><span class="line">        2023-10-14T20:17:59.385+08:00: ** WARNING: This replica <span class="built_in">set</span> has a Primary-Secondary-Arbiter architecture, but readConcern:majority is enabled </span><br><span class="line">        2023-10-14T20:17:59.386+08:00: **          <span class="keyword">for</span> this node. This is not a recommended configuration. Please see </span><br><span class="line">        2023-10-14T20:17:59.386+08:00: **          https://dochub.mongodb.org/core/psa-disable-rc-majority</span><br><span class="line">        2023-10-14T20:17:59.386+08:00: </span><br><span class="line">---</span><br><span class="line">shihanshuors:SECONDARY&gt; show dbs</span><br><span class="line">uncaught exception: Error: listDatabases failed:&#123;</span><br><span class="line">	<span class="string">&quot;topologyVersion&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;processId&quot;</span> : ObjectId(<span class="string">&quot;652a86f6ba6f60e664835b08&quot;</span>),</span><br><span class="line">		<span class="string">&quot;counter&quot;</span> : NumberLong(3)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1697285917, 1),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;not master and slaveOk=false&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 13435,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotPrimaryNoSecondaryOk&quot;</span>,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1697285917, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">Mongo.prototype.getDBs/&lt;@src/mongo/shell/mongo.js:147:19</span><br><span class="line">Mongo.prototype.getDBs@src/mongo/shell/mongo.js:99:12</span><br><span class="line">shellHelper.show@src/mongo/shell/utils.js:937:13</span><br><span class="line">shellHelper@src/mongo/shell/utils.js:819:15</span><br><span class="line">@(shellhelp2):1:1</span><br><span class="line">shihanshuors:SECONDARY&gt; rs.slaveOk()</span><br><span class="line">WARNING: slaveOk() is deprecated and may be removed <span class="keyword">in</span> the next major release. Please use secondaryOk() instead.</span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br><span class="line">shihanshuors:SECONDARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuors:SECONDARY&gt; db.comment.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;7&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;吃饭前，先喝杯水或一碗汤，可减少饭量，对控制体重有帮助&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1007&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;玛丽莲•梦露&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="string">&quot;18&quot;</span>, <span class="string">&quot;phone&quot;</span> : <span class="string">&quot; 13937165554&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:46:31.423Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : <span class="string">&quot;8888&quot;</span>, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;null&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1002&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;相忘于江湖&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-03-28T10:08:15.522Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 1000, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;</span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br></pre></td></tr></table></figure>

<h5 id="2-主节点故障测试"><a href="#2-主节点故障测试" class="headerlink" title="2.主节点故障测试"></a>2.主节点故障测试</h5><p>关闭27017节点：发现，从节点和仲裁节点对27017的心跳失败，当失败超过10秒，此时因为没有主节点了，会自动发起投票。而副本节点只有27018，因此，候选人只有一个就是27018，开始投票。27019向27018投了一票，27018本身自带一票，因此共两票，超过了“大多数”27019是仲裁节点，没有选举权，27018不向其投票，其票数是0。最终结果，27018成为主节点。具备读写功能。在27018写入数据查看。</p>
<p>1）关闭（原）主节点27017</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf --shutdown</span><br><span class="line">killing process with pid: 2604</span><br><span class="line">[root@Server01 ~]# ps -ef | grep mongod</span><br><span class="line">root        2752       1  0 19:40 ?        00:00:10 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27019/mongod.conf</span><br><span class="line">root        3494       1  1 20:17 ?        00:00:01 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br><span class="line">root        3614    2308  0 20:20 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@Server01 ~]# </span><br></pre></td></tr></table></figure>

<p>2）登入（原）副本节点27018（触发选举机制），执行 use articledb 切换后执行 db.comment.find() 查看当且数据，最后插入一条新的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:SECONDARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuors:PRIMARY&gt; db</span><br><span class="line">articledb</span><br><span class="line">shihanshuors:PRIMARY&gt; db.comment.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;7&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;吃饭前，先喝杯水或一碗汤，可减少饭量，对控制体重有帮助&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1007&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;玛丽莲•梦露&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="string">&quot;18&quot;</span>, <span class="string">&quot;phone&quot;</span> : <span class="string">&quot; 13937165554&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:46:31.423Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : <span class="string">&quot;8888&quot;</span>, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;null&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1002&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;相忘于江湖&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-03-28T10:08:15.522Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 1000, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; db.comment.insert(&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1005&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;伊人憔悴&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-01-01T00:00:00Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 888, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : 1 &#125;)</span><br><span class="line">shihanshuors:PRIMARY&gt; db.comment.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;7&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;吃饭前，先喝杯水或一碗汤，可减少饭量，对控制体重有帮助&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1007&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;玛丽莲•梦露&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="string">&quot;18&quot;</span>, <span class="string">&quot;phone&quot;</span> : <span class="string">&quot; 13937165554&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:46:31.423Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : <span class="string">&quot;8888&quot;</span>, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;null&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1002&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;相忘于江湖&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-03-28T10:08:15.522Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 1000, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1005&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;伊人憔悴&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-01-01T00:00:00Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 888, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<p>3）再启动27017节点，发现27017变成了从节点，27018仍保持主节点。登录27017节点，发现是从节点了，数据自动从27018同步。从而实现了高可用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongo --host=192.168.24.105 --port=27017</span><br><span class="line">MongoDB shell version v4.4.24</span><br><span class="line">connecting to: mongodb://192.168.24.105:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;a865267b-fdae-4243-9af1-3b83847358bc&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.4.24</span><br><span class="line">---</span><br><span class="line">The server generated these startup warnings when booting: </span><br><span class="line">        2023-10-14T20:22:09.784+08:00: Access control is not enabled <span class="keyword">for</span> the database. Read and write access to data and configuration is unrestricted</span><br><span class="line">        2023-10-14T20:22:09.784+08:00: You are running this process as the root user, <span class="built_in">which</span> is not recommended</span><br><span class="line">        2023-10-14T20:22:09.784+08:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>. We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">        2023-10-14T20:22:09.784+08:00: Soft rlimits too low</span><br><span class="line">        2023-10-14T20:22:09.784+08:00:         currentValue: 1024</span><br><span class="line">        2023-10-14T20:22:09.784+08:00:         recommendedMinimum: 64000</span><br><span class="line">        2023-10-14T20:22:09.801+08:00: </span><br><span class="line">        2023-10-14T20:22:09.801+08:00: ** WARNING: This replica <span class="built_in">set</span> has a Primary-Secondary-Arbiter architecture, but readConcern:majority is enabled </span><br><span class="line">        2023-10-14T20:22:09.801+08:00: **          <span class="keyword">for</span> this node. This is not a recommended configuration. Please see </span><br><span class="line">        2023-10-14T20:22:09.801+08:00: **          https://dochub.mongodb.org/core/psa-disable-rc-majority</span><br><span class="line">        2023-10-14T20:22:09.801+08:00: </span><br><span class="line">---</span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br><span class="line">shihanshuors:SECONDARY&gt; rs.slaveOk()</span><br><span class="line">WARNING: slaveOk() is deprecated and may be removed <span class="keyword">in</span> the next major release. Please use secondaryOk() instead.</span><br><span class="line">shihanshuors:SECONDARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuors:SECONDARY&gt; db.comment.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;7&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;吃饭前，先喝杯水或一碗汤，可减少饭量，对控制体重有帮助&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1007&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;玛丽莲•梦露&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="string">&quot;18&quot;</span>, <span class="string">&quot;phone&quot;</span> : <span class="string">&quot; 13937165554&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:46:31.423Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : <span class="string">&quot;8888&quot;</span>, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;null&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1002&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;相忘于江湖&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-03-28T10:08:15.522Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 1000, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1005&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;伊人憔悴&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-01-01T00:00:00Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 888, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;</span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br></pre></td></tr></table></figure>

<h5 id="3-仲裁节点和主节点故障"><a href="#3-仲裁节点和主节点故障" class="headerlink" title="3.仲裁节点和主节点故障"></a>3.仲裁节点和主节点故障</h5><p>先关掉仲裁节点27019，再关掉现在的主节点27018</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27019/mongod.conf --shutdown</span><br><span class="line">killing process with pid: 2752</span><br><span class="line">[root@Server01 ~]# ps -ef | grep mongod</span><br><span class="line">root        3494       1  0 20:17 ?        00:00:02 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br><span class="line">root        3641       1  0 20:22 ?        00:00:01 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span><br><span class="line">root        3765    2308  0 20:24 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@Server01 ~]# mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf  --shutdown</span><br><span class="line">killing process with pid: 3494</span><br><span class="line">[root@Server01 ~]# ps -ef | grep mongod</span><br><span class="line">root        3641       1  0 20:22 ?        00:00:01 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span><br><span class="line">root        3782    2308  0 20:25 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@Server01 ~]# </span><br></pre></td></tr></table></figure>

<p>登录27017后，发现，27017仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:SECONDARY&gt; <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">bye</span></span><br><span class="line">[root@Server01 ~]# mongo --host=192.168.24.105 --port=27017</span><br><span class="line">MongoDB shell version v4.4.24</span><br><span class="line">connecting to: mongodb://192.168.24.105:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;f818db1d-cf2c-4d65-bf4e-043639455521&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.4.24</span><br><span class="line">---</span><br><span class="line">The server generated these startup warnings when booting: </span><br><span class="line">        2023-10-14T20:22:09.784+08:00: Access control is not enabled <span class="keyword">for</span> the database. Read and write access to data and configuration is unrestricted</span><br><span class="line">        2023-10-14T20:22:09.784+08:00: You are running this process as the root user, <span class="built_in">which</span> is not recommended</span><br><span class="line">        2023-10-14T20:22:09.784+08:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>. We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">        2023-10-14T20:22:09.784+08:00: Soft rlimits too low</span><br><span class="line">        2023-10-14T20:22:09.784+08:00:         currentValue: 1024</span><br><span class="line">        2023-10-14T20:22:09.784+08:00:         recommendedMinimum: 64000</span><br><span class="line">        2023-10-14T20:22:09.801+08:00: </span><br><span class="line">        2023-10-14T20:22:09.801+08:00: ** WARNING: This replica <span class="built_in">set</span> has a Primary-Secondary-Arbiter architecture, but readConcern:majority is enabled </span><br><span class="line">        2023-10-14T20:22:09.801+08:00: **          <span class="keyword">for</span> this node. This is not a recommended configuration. Please see </span><br><span class="line">        2023-10-14T20:22:09.801+08:00: **          https://dochub.mongodb.org/core/psa-disable-rc-majority</span><br><span class="line">        2023-10-14T20:22:09.801+08:00: </span><br><span class="line">---</span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br><span class="line">shihanshuors:SECONDARY&gt; show dbs</span><br><span class="line">uncaught exception: Error: listDatabases failed:&#123;</span><br><span class="line">	<span class="string">&quot;topologyVersion&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;processId&quot;</span> : ObjectId(<span class="string">&quot;652a87f1c99e4b9d4891fa33&quot;</span>),</span><br><span class="line">		<span class="string">&quot;counter&quot;</span> : NumberLong(4)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1697286312, 1),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;not master and slaveOk=false&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 13435,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotPrimaryNoSecondaryOk&quot;</span>,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1697286312, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">Mongo.prototype.getDBs/&lt;@src/mongo/shell/mongo.js:147:19</span><br><span class="line">Mongo.prototype.getDBs@src/mongo/shell/mongo.js:99:12</span><br><span class="line">shellHelper.show@src/mongo/shell/utils.js:937:13</span><br><span class="line">shellHelper@src/mongo/shell/utils.js:819:15</span><br><span class="line">@(shellhelp2):1:1</span><br><span class="line">shihanshuors:SECONDARY&gt; rs.slaveOk()</span><br><span class="line">WARNING: slaveOk() is deprecated and may be removed <span class="keyword">in</span> the next major release. Please use secondaryOk() instead.</span><br><span class="line">shihanshuors:SECONDARY&gt; show dbs</span><br><span class="line">admin      0.000GB</span><br><span class="line">articledb  0.000GB</span><br><span class="line">config     0.000GB</span><br><span class="line"><span class="built_in">local</span>      0.000GB</span><br><span class="line">shihanshuors:SECONDARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuors:SECONDARY&gt; db.comment.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;7&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;吃饭前，先喝杯水或一碗汤，可减少饭量，对控制体重有帮助&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1007&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;玛丽莲•梦露&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="string">&quot;18&quot;</span>, <span class="string">&quot;phone&quot;</span> : <span class="string">&quot; 13937165554&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2023-10-08T12:46:31.423Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : <span class="string">&quot;8888&quot;</span>, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;null&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1002&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;相忘于江湖&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-03-28T10:08:15.522Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 1000, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>, <span class="string">&quot;articleid&quot;</span> : <span class="string">&quot;100001&quot;</span>, <span class="string">&quot;content&quot;</span> : <span class="string">&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;</span>, <span class="string">&quot;userid&quot;</span> : <span class="string">&quot;1005&quot;</span>, <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;伊人憔悴&quot;</span>, <span class="string">&quot;createdatetime&quot;</span> : ISODate(<span class="string">&quot;2022-01-01T00:00:00Z&quot;</span>), <span class="string">&quot;likenum&quot;</span> : 888, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;1&quot;</span> &#125;</span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br><span class="line">shihanshuors:SECONDARY&gt; rs.<span class="function"><span class="title">status</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;set&quot;</span> : <span class="string">&quot;shihanshuors&quot;</span>,</span><br><span class="line">	<span class="string">&quot;date&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:29:19.062Z&quot;</span>),</span><br><span class="line">	<span class="string">&quot;myState&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;term&quot;</span> : NumberLong(5),</span><br><span class="line">	<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">	<span class="string">&quot;heartbeatIntervalMillis&quot;</span> : NumberLong(2000),</span><br><span class="line">	<span class="string">&quot;majorityVoteCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;writeMajorityCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;votingMembersCount&quot;</span> : 3,</span><br><span class="line">	<span class="string">&quot;writableVotingMembersCount&quot;</span> : 2,</span><br><span class="line">	<span class="string">&quot;optimes&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;lastCommittedOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1697286312, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(4)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastCommittedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12.022Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;readConcernMajorityOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1697286312, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(4)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;readConcernMajorityWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12.022Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;appliedOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1697286312, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(4)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;durableOpTime&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;ts&quot;</span> : Timestamp(1697286312, 1),</span><br><span class="line">			<span class="string">&quot;t&quot;</span> : NumberLong(4)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12.022Z&quot;</span>),</span><br><span class="line">		<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12.022Z&quot;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;lastStableRecoveryTimestamp&quot;</span> : Timestamp(1697286312, 1),</span><br><span class="line">	<span class="string">&quot;members&quot;</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.24.105:27017&quot;</span>,</span><br><span class="line">			<span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;state&quot;</span> : 2,</span><br><span class="line">			<span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;SECONDARY&quot;</span>,</span><br><span class="line">			<span class="string">&quot;uptime&quot;</span> : 430,</span><br><span class="line">			<span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(1697286312, 1),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(4)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12.022Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12.022Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">			<span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;configVersion&quot;</span> : 3,</span><br><span class="line">			<span class="string">&quot;configTerm&quot;</span> : 4,</span><br><span class="line">			<span class="string">&quot;self&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.24.105:27018&quot;</span>,</span><br><span class="line">			<span class="string">&quot;health&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;state&quot;</span> : 8,</span><br><span class="line">			<span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;(not reachable/healthy)&quot;</span>,</span><br><span class="line">			<span class="string">&quot;uptime&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(0, 0),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(-1)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDurable&quot;</span> : &#123;</span><br><span class="line">				<span class="string">&quot;ts&quot;</span> : Timestamp(0, 0),</span><br><span class="line">				<span class="string">&quot;t&quot;</span> : NumberLong(-1)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;1970-01-01T00:00:00Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;optimeDurableDate&quot;</span> : ISODate(<span class="string">&quot;1970-01-01T00:00:00Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastAppliedWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12.022Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastDurableWallTime&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12.022Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastHeartbeat&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:29:18.638Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatRecv&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:25:12.099Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;pingMs&quot;</span> : NumberLong(0),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;Error connecting to 192.168.24.105:27018 :: caused by :: Connection refused&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">			<span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;configVersion&quot;</span> : 3,</span><br><span class="line">			<span class="string">&quot;configTerm&quot;</span> : 4</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;_id&quot;</span> : 2,</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.24.105:27019&quot;</span>,</span><br><span class="line">			<span class="string">&quot;health&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;state&quot;</span> : 8,</span><br><span class="line">			<span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;(not reachable/healthy)&quot;</span>,</span><br><span class="line">			<span class="string">&quot;uptime&quot;</span> : 0,</span><br><span class="line">			<span class="string">&quot;lastHeartbeat&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:29:18.638Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatRecv&quot;</span> : ISODate(<span class="string">&quot;2023-10-14T12:24:24.090Z&quot;</span>),</span><br><span class="line">			<span class="string">&quot;pingMs&quot;</span> : NumberLong(0),</span><br><span class="line">			<span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;Error connecting to 192.168.24.105:27019 :: caused by :: Connection refused&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line">			<span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">			<span class="string">&quot;configVersion&quot;</span> : 3,</span><br><span class="line">			<span class="string">&quot;configTerm&quot;</span> : 4</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1697286312, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1697286312, 1)</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br></pre></td></tr></table></figure>

<p>为啥不选举了？因为27017的票数，没有获得大多数，即没有大于等于2，它只有默认的一票（优先级是1）如果要触发选举，随便加入一个成员即可。</p>
<p>1）如果只加入27019仲裁节点成员，则主节点一定是27017，因为没得选了，仲裁节点不参与选举，但参与投票。（不演示）<br>2）如果只加入27018节点，会发起选举。因为27017和27018都是两票，则按照谁数据新，谁当主节点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 3838</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@Server01 ~]# ps -ef | grep mongod</span><br><span class="line">root        3641       1  0 20:22 ?        00:00:05 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span><br><span class="line">root        3838       1 22 20:30 ?        00:00:00 mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br><span class="line">root        3910    2308  0 20:30 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@Server01 ~]# </span><br><span class="line"><span class="comment"># 原副本节点27017，触发选举机制，数据最新，因此升级为主节点</span></span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt;</span><br><span class="line"><span class="comment"># 原主节点27018在宕机之后重启服务，被降级为副本节点</span></span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:SECONDARY&gt; </span><br></pre></td></tr></table></figure>

<h5 id="4-仲裁节点和从节点故障"><a href="#4-仲裁节点和从节点故障" class="headerlink" title="4.仲裁节点和从节点故障"></a>4.仲裁节点和从节点故障</h5><p>先关掉仲裁节点27019，再关掉现在的副本节点27018<br>10秒后，27017主节点自动降级为副本节点。（服务降级）<br>副本集不可写数据了，已经故障了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:ARBITER&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">shihanshuors:ARBITER&gt; db.shutdownServer()</span><br><span class="line">2022-10-16T18:50:11.394+0800 I  NETWORK  [js] DBClientConnection failed to receive message from 127.0.0.1:27019 - HostUnreachable: Connection closed by peer</span><br><span class="line">server should be down...</span><br><span class="line">2022-10-16T18:50:11.397+0800 I  NETWORK  [js] trying reconnect to 127.0.0.1:27019 failed</span><br><span class="line">2022-10-16T18:50:11.397+0800 I  NETWORK  [js] reconnect 127.0.0.1:27019 failed failed </span><br><span class="line">2022-10-16T18:50:11.400+0800 I  NETWORK  [js] trying reconnect to 127.0.0.1:27019 failed</span><br><span class="line">2022-10-16T18:50:11.400+0800 I  NETWORK  [js] reconnect 127.0.0.1:27019 failed failed </span><br><span class="line">&gt; <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">bye</span></span><br><span class="line">2022-10-16T18:50:13.658+0800 I  NETWORK  [js] trying reconnect to 127.0.0.1:27019 failed</span><br><span class="line">2022-10-16T18:50:13.658+0800 I  NETWORK  [js] reconnect 127.0.0.1:27019 failed failed </span><br><span class="line">2022-10-16T18:50:13.659+0800 I  QUERY    [js] Failed to end session &#123; <span class="built_in">id</span>: UUID(<span class="string">&quot;7310bf73-7d1e-4ef2-9e58-b6969fb9e4b8&quot;</span>) &#125; due to SocketException: socket exception [CONNECT_ERROR] server [couldn<span class="string">&#x27;t connect to server 127.0.0.1:27019, connection attempt failed: SocketException: Error connecting to 127.0.0.1:27019 :: caused by :: Connection refused]</span></span><br><span class="line"><span class="string">[root@localhost ~]# </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">shihanshuors:SECONDARY&gt; use admin</span></span><br><span class="line"><span class="string">switched to db admin</span></span><br><span class="line"><span class="string">shihanshuors:SECONDARY&gt; db.shutdownServer()</span></span><br><span class="line"><span class="string">2022-10-16T18:50:26.186+0800 I  NETWORK  [js] DBClientConnection failed to receive message from 127.0.0.1:27018 - HostUnreachable: Connection closed by peer</span></span><br><span class="line"><span class="string">server should be down...</span></span><br><span class="line"><span class="string">2022-10-16T18:50:26.190+0800 I  NETWORK  [js] trying reconnect to 127.0.0.1:27018 failed</span></span><br><span class="line"><span class="string">2022-10-16T18:50:26.191+0800 I  NETWORK  [js] reconnect 127.0.0.1:27018 failed failed </span></span><br><span class="line"><span class="string">2022-10-16T18:50:26.193+0800 I  NETWORK  [js] trying reconnect to 127.0.0.1:27018 failed</span></span><br><span class="line"><span class="string">2022-10-16T18:50:26.194+0800 I  NETWORK  [js] reconnect 127.0.0.1:27018 failed failed </span></span><br><span class="line"><span class="string">&gt; exit</span></span><br><span class="line"><span class="string">bye</span></span><br><span class="line"><span class="string">2022-10-16T18:50:27.624+0800 I  NETWORK  [js] trying reconnect to 127.0.0.1:27018 failed</span></span><br><span class="line"><span class="string">2022-10-16T18:50:27.624+0800 I  NETWORK  [js] reconnect 127.0.0.1:27018 failed failed </span></span><br><span class="line"><span class="string">2022-10-16T18:50:27.624+0800 I  QUERY    [js] Failed to end session &#123; id: UUID(&quot;ebfe9c0a-93d0-45e3-82db-150c5c79a695&quot;) &#125; due to SocketException: socket exception [CONNECT_ERROR] server [couldn&#x27;</span>t connect to server 127.0.0.1:27018, connection attempt failed: SocketException: Error connecting to 127.0.0.1:27018 :: caused by :: Connection refused]</span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202203281105751.png" alt="image-20220328110529553"></p>
<h4 id="心跳检测机制"><a href="#心跳检测机制" class="headerlink" title="心跳检测机制"></a>心跳检测机制</h4><p>副本集的心跳检测机制是通过副本集每个成员每两秒钟ping一次其它所有成员了解系统的健康状况，该机制发现故障后，会自动选举和故障转移，常见应用场景如下：</p>
<ul>
<li><p>某个节点失去了响应，副本集就会采取相应的措施。这时副本集会判断失去响应的是主节点还是副本节点，如果是多个副本节点中的某一个副本节点，则副本集不做任何处理，只需要等待副本节点重新上线。如果是主节点挂掉了，则副本集会开始选举，选出新的主节点。</p>
</li>
<li><p>副本集中主节点突然失去了其它大多数节点的心跳，主节点会把自己降级为副本节点。这是为了防止网络原因让主节点和其它副本节点断开时，其它的副本节点中推举出了一个新的主节点，如此以来，一旦原来的主节点没有降级，那么网络恢复之后，副本集就会拥有两个主节点。如果客户端继续运行，就会对两个主节点都进行读写操作，导致副本集混乱。</p>
</li>
</ul>
<p>停止服务的方式有两种：<strong>快速关闭和标准关闭</strong>，下面依次说明：</p>
<p><strong>（一）快速关闭方法（快速，简单，数据可能会出错）</strong></p>
<p><strong>目标</strong>：通过系统的kill命令直接杀死进程：<br>杀完要检查一下，避免有的没有杀掉。</p>
<p>kill -2 54410 #通过进程编号关闭节点</p>
<p>【补充】如果一旦是因为数据损坏，则需要进行如下操作（了解）：<br>1）删除lock文件：<br><code>rm  -rf  /mongodb/single/data/db/*.lock</code><br>2 ）修复数据：<br><code>/usr/local/mongdb/bin/mongod --repair --dbpath=/mongodb/single/data/db</code></p>
<p><strong>（二）标准的关闭方法（数据不容易出错，但麻烦）：</strong></p>
<p>目标：通过mongo客户端中的shutdownServer命令来关闭服务<br>主要的操作步骤参考如下：</p>
<p>&#x2F;&#x2F;客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。<br><code>mongo --port 27017</code><br>&#x2F;&#x2F;#切换到admin库<br><code>use admin</code><br>&#x2F;&#x2F;关闭服务<br><code>db.shutdownServer()</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">&gt; db</span><br><span class="line">admin</span><br><span class="line">&gt; db.shutdownServer()</span><br><span class="line">2022-10-12T18:29:41.739+0800 I  NETWORK  [js] DBClientConnection failed to receive message from 127.0.0.1:27017 - HostUnreachable: Connection closed by peer</span><br><span class="line">server should be down...</span><br><span class="line">2022-10-12T18:29:41.743+0800 I  NETWORK  [js] trying reconnect to 127.0.0.1:27017 failed</span><br><span class="line">2022-10-12T18:29:41.743+0800 I  NETWORK  [js] reconnect 127.0.0.1:27017 failed failed </span><br><span class="line">&gt; <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">bye</span></span><br><span class="line">2022-10-12T18:29:45.252+0800 I  NETWORK  [js] trying reconnect to 127.0.0.1:27017 failed</span><br><span class="line">2022-10-12T18:29:45.252+0800 I  NETWORK  [js] reconnect 127.0.0.1:27017 failed failed </span><br><span class="line">2022-10-12T18:29:45.252+0800 I  QUERY    [js] Failed to end session &#123; <span class="built_in">id</span>: UUID(<span class="string">&quot;e0e0b382-53c9-43e6-ac4a-ec1c0babfdf4&quot;</span>) &#125; due to SocketException: socket exception [CONNECT_ERROR] server [couldn<span class="string">&#x27;t connect to server 127.0.0.1:27017, connection attempt failed: SocketException: Error connecting to 127.0.0.1:27017 :: caused by :: Connection refused]</span></span><br><span class="line"><span class="string">[root@localhost ~]# ps -ef | grep mongod</span></span><br><span class="line"><span class="string">root      10774  10300  0 18:29 pts/1    00:00:00 grep --color=auto mongod</span></span><br></pre></td></tr></table></figure>

<h3 id="安全认证"><a href="#安全认证" class="headerlink" title="安全认证"></a>安全认证</h3><p>​       默认情况下部署的MongoDB副本集不会开启安全认证功能，这样会对副本集的安全带来一定影响，任何人都可以操作副本集，这在生产环境中是不允许发生的。<strong>MongoDB 副本集之间通信有两种安全认证机制，一种是通过KeyFile，另外一种是通过证书x.509</strong>，官网推荐使用证书的方式，不过我们这里搭建测试和开发环境没必要去弄证书，因此我们直接通过配置KeyFile就可以实现安全通信，不过在生产环境中推荐使用证书x.509。</p>
<p>​       KeyFile是MongoDB副本集安全认证的一种形式，该形式是通过一个密钥文件使副本集中各服务器进行内部通信使用，当作副本集内部的密码，这个密钥文件基本上是一个明文的文件，副本集中每个成员的密钥文件内容须保持一致。</p>
<p>密钥文件的使用需要注意一下几点：</p>
<ul>
<li>内容至少包含六个字符，文件的大小不能超过1024字节；</li>
<li>文件中的空白字符在认证过程没有实际意义；</li>
<li>文件编码为base64，但不能包含等于号；</li>
<li>密钥文件权限一定要等于或小于 600（rw只有拥有者有读写权限），否则会报权限太高的错误；</li>
</ul>
<p>​       MongoDB副本集中的KeyFile安全认证可以理解为MongoDB单机模式下的auth认证功能，开启KeyFile安全认证，就不需要再使用auth认证（隐含就是开启了auth），这个时候登录MongoDB副本集的客户端就需要用户名和密码进行认证。KeyFile认证不是必选项，不过副本集中一个成员开启了KeyFile认证的情况下，其它成员也必须开启KeyFile认证，否则将不会加入该副本集。</p>
<h4 id="在副本集中开启KeyFile安全认证功能"><a href="#在副本集中开启KeyFile安全认证功能" class="headerlink" title="在副本集中开启KeyFile安全认证功能"></a>在副本集中开启KeyFile安全认证功能</h4><p>1、创建用于存放KeyFile文件的目录。   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# <span class="built_in">mkdir</span> -p /opt/module/mongodb/replica_sets/shihanshuors_27017/key</span><br><span class="line">[root@localhost ~]# <span class="built_in">mkdir</span> -p /opt/module/mongodb/replica_sets/shihanshuors_27018/key</span><br><span class="line">[root@localhost ~]# <span class="built_in">mkdir</span> -p /opt/module/mongodb/replica_sets/shihanshuors_27019/key</span><br></pre></td></tr></table></figure>

<p>2、在&#x2F;opt&#x2F;module&#x2F;mongodb&#x2F;replica_sets&#x2F;shihanshuors_27017&#x2F;key目录下新建KeyFile文件并命名为keyfile。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# <span class="built_in">touch</span> /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile</span><br><span class="line">[root@localhost ~]# ll /opt/module/mongodb/replica_sets/shihanshuors_27017/</span><br><span class="line">总用量 4</span><br><span class="line">drwxr-xr-x 3 root root   16 3月  27 2022 data</span><br><span class="line">drwxr-xr-x 2 root root   21 10月 22 22:25 key</span><br><span class="line">drwxr-xr-x 2 root root   45 3月  27 2022 logs</span><br><span class="line">-rw-r--r-- 1 root root 1486 3月  27 2022 mongod.conf</span><br><span class="line">[root@localhost ~]# ll /opt/module/mongodb/replica_sets/shihanshuors_27017/key/</span><br><span class="line">总用量 0</span><br><span class="line">-rw-r--r-- 1 root root 0 10月 22 22:25 keyfile</span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>

<p>3、通过Linux系统提供的密码工具集 openssl生成符合KeyFile文件标准的密钥并写入。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# openssl rand -out /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile -<span class="built_in">base64</span> 756</span><br></pre></td></tr></table></figure>

<p>4、查看密钥是否成功写入KeyFile文件。  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# <span class="built_in">cat</span> /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile</span><br><span class="line">CttwWzkCdt6BcgDG3xrc+B77hjOvG/kgnuohSfUGQArKRvtxiKHWpuRso5cVIKG2</span><br><span class="line">LyI76Rvl+NE2NfUgOnMCMe86ID4ML6eVRZ/Rz8VsgckEo/v5uXCTLlRRHxWTScaX</span><br><span class="line">y+lX3S8FH2Zv3ecZi81/TTT2Wj6DS4MWnINx4MtEhwMp1lSIrtQ0pFjOn1pUUj5P</span><br><span class="line">6wIDs65RFzSwIeNCr29s7ik9P0npN046FU8AOpapt9lh7wGQRctN6TsAqj+QtH7s</span><br><span class="line">HVs/rQtds1xBLW+Iwkw0cEl98RflrZanaWGLGjQgA/hkFyPUJtBASIJnna2uTfNe</span><br><span class="line">s6MBokQYRJv1eB8Iawe7sDNhAAmmfGh1y0p2p8UHYvuSHgRG7iqAdUKCXWQ4YIDC</span><br><span class="line">yT9PU3kFh0g4If+zGVayYRm6QPYtkHjWL3QKVSzOQziS7EjMeNpHHv59RCLLzMFQ</span><br><span class="line">L+Cehv+V83XiVKphb2YawTv3ik/xj/M8JUkfq82ugSgh/gRQmB5bqvobeV8fpDr/</span><br><span class="line">wXMyYXcQU95HmfJEzjoMZZStCl4Uyfoyf9KPAR6VYj0zJVuhh2ym+UWG31iH8mll</span><br><span class="line">+iANEJ9gnYev9cVRX+vDhrKcqJyNcpKnDCVfkx4qZu1xNYUhm4Fg+AbUvCFJDWrW</span><br><span class="line">E4tMPEkqgeimGSJc0C5w8AnglqMiRGZzI8QtW568feKW7OdsoIDxOwy+DP7izZN2</span><br><span class="line">LYlqtIp25qh6QWgN+XMDsttfl4ssKgY3udcxOCZhocQjt1NTRNXZVY/NL2MMaihU</span><br><span class="line">xebfHz8bQ4qdBFWk3u9XCwI683A9crbg8X2/+UUQXFuDadtYK48bSelAJ9YNhggo</span><br><span class="line">g+EqcE9TZTqgFx6DDmRLWTkxeNbqj73splZhF90Do2jFBd8J9qYtzTlbGBQ814Ef</span><br><span class="line">33EjBJ19KvmAocc0ZAOlIXqjox/cMLLKVlec869OuhTQxAEtpEHdqOfxFURwqqIn</span><br><span class="line">jYCiYQURWp+J/Z9GJYMpGF6D1r6YZ8RrIHHwB62LsqtgxffU</span><br><span class="line">[root@Server01 ~]# </span><br></pre></td></tr></table></figure>

<p>5、修改KeyFile文件权限为600，即只有当前用户拥有可读写权限。如不操作此步后续会因为KeyFile文件默认权限过大，无法启动安全认证的MongDB副本集。  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# ll /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile </span><br><span class="line">-rw-r--r-- 1 root root 1024 10月 18 19:27 /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile</span><br><span class="line">[root@Server01 ~]# <span class="built_in">chmod</span> 600 /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile</span><br><span class="line">[root@Server01 ~]# ll /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile </span><br><span class="line">-rw------- 1 root root 1024 10月 18 19:27 /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile</span><br><span class="line">[root@Server01 ~]# </span><br></pre></td></tr></table></figure>

<p>6、为了保证副本集中各节点的KeyFile文件保持一致，需要将KeyFile文件（keyfile）拷贝到其它节点。  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# <span class="built_in">cp</span> -r /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile /opt/module/mongodb/replica_sets/shihanshuors_27018/key/keyfile</span><br><span class="line">[root@localhost ~]# <span class="built_in">cp</span> -r /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile /opt/module/mongodb/replica_sets/shihanshuors_27019/key/keyfile</span><br><span class="line">[root@localhost ~]# ll /opt/module/mongodb/replica_sets/shihanshuors_27018/key/keyfile </span><br><span class="line">-rw------- 1 root root 1024 10月 22 22:45 /opt/module/mongodb/replica_sets/shihanshuors_27018/key/keyfile</span><br><span class="line">[root@localhost ~]# ll /opt/module/mongodb/replica_sets/shihanshuors_27019/key/keyfile </span><br><span class="line">-rw------- 1 root root 1024 10月 22 22:45 /opt/module/mongodb/replica_sets/shihanshuors_27019/key/keyfile</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>

<p>7、开启安全认证后在不指定用户登录MongoDB客户端时，默认情况下我们是以访客身份登录没有任何操作的权限，也无法创建用户，这会导致开启了安全认证的副本集无法正常使用。因此，需要在没有开启安全认证的MongoDB副本集中添加全局管理用户。  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到admin数据库</span></span><br><span class="line">shihanshuors:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line"><span class="comment"># 创建全局管理用户itcastAdmin   </span></span><br><span class="line">shihanshuors:PRIMARY&gt; db.createUser(&#123;user:<span class="string">&quot;itcastAdmin&quot;</span>,<span class="built_in">pwd</span>:<span class="string">&quot;123456&quot;</span>,roles:</span><br><span class="line">   [&#123;role:<span class="string">&quot;userAdminAnyDatabase&quot;</span>,db:<span class="string">&quot;admin&quot;</span>&#125;,&#123;role:<span class="string">&quot;readWriteAnyDatabase&quot;</span>,</span><br><span class="line">   db:<span class="string">&quot;admin&quot;</span>&#125;,&#123;role:<span class="string">&quot;dbAdminAnyDatabase&quot;</span>,db:<span class="string">&quot;admin&quot;</span>&#125;]&#125;)</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">//   - Run Shell Queries via Studio 3T <span class="keyword">for</span> full access to query results</span><br><span class="line">// --------------------------------------------------------------------------</span><br><span class="line">MongoDB shell version v4.2.14</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">	<span class="string">&quot;user&quot;</span> : <span class="string">&quot;itcastAdmin&quot;</span>,</span><br><span class="line">	<span class="string">&quot;roles&quot;</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;role&quot;</span> : <span class="string">&quot;userAdminAnyDatabase&quot;</span>,</span><br><span class="line">			<span class="string">&quot;db&quot;</span> : <span class="string">&quot;admin&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;role&quot;</span> : <span class="string">&quot;readWriteAnyDatabase&quot;</span>,</span><br><span class="line">			<span class="string">&quot;db&quot;</span> : <span class="string">&quot;admin&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;role&quot;</span> : <span class="string">&quot;dbAdminAnyDatabase&quot;</span>,</span><br><span class="line">			<span class="string">&quot;db&quot;</span> : <span class="string">&quot;admin&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>8、验证用户是否创建成功。   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; db.auth(<span class="string">&quot;itcastAdmin&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>9、关闭副本集，即三台服务器的MongoDB服务（先副后主）。重新以安全认证模式启动副本集,分别编辑几个服务的mongod.conf文件修改配置文件指定keyfile。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span></span><br><span class="line">security:</span><br><span class="line">  <span class="comment">#KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /opt/module/mongodb/replica_sets/shihanshuors_27017/key/keyfile</span><br><span class="line">  <span class="comment">#开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"><span class="comment"># /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span></span><br><span class="line">security:</span><br><span class="line">  <span class="comment">#KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /opt/module/mongodb/replica_sets/shihanshuors_27018/key/keyfile</span><br><span class="line">  <span class="comment">#开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"><span class="comment"># /opt/module/mongodb/replica_sets/shihanshuors_27019/mongod.conf</span></span><br><span class="line">security:</span><br><span class="line">  <span class="comment">#KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /opt/module/mongodb/replica_sets/shihanshuors_27019/key/keyfile</span><br><span class="line">  <span class="comment">#开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure>

<p>10、在服务器27017中MongoDB的目录下启动MongoDB服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27017/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 4499</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>

<p>11、在服务器27018中MongoDB的目录下启动MongoDB服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27018/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 4569</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>

<p>12、在服务器27019中MongoDB的目录下启动MongoDB服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongod -f /opt/module/mongodb/replica_sets/shihanshuors_27019/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 4648</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>



<h4 id="验证安全认证是否成功启动"><a href="#验证安全认证是否成功启动" class="headerlink" title="验证安全认证是否成功启动"></a>验证安全认证是否成功启动</h4><p>1、在服务器27017中MongoDB的目录下不指定用户登录MongoDB客户端。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongo --port=27017</span><br><span class="line">MongoDB shell version v4.4.24</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;2d5d3792-c056-4408-9fc0-3334f2f513a1&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.4.24</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br><span class="line">shihanshuors:PRIMARY&gt; use <span class="built_in">test</span></span><br><span class="line">shihanshuors:PRIMARY&gt; db</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">shihanshuors:PRIMARY&gt; db.user.find()</span><br><span class="line">Error: error: &#123;</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1697633203, 1),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;command find requires authentication&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 13,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;Unauthorized&quot;</span>,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1697633203, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;Z41N4hnWgDlBQuTj9X9gKtTz7Nc=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(<span class="string">&quot;7287562673762336773&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; db.user.insert(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;heima&quot;</span>&#125;)</span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1697633283, 1),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;command insert requires authentication&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 13,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;Unauthorized&quot;</span>,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1697633283, 1),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;bq2wHWqy5YuueLVW3gafs7DQ288=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(<span class="string">&quot;7287562673762336773&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br></pre></td></tr></table></figure>

<p>当我们不指定用户登录时，执行读入和写入操作就会出现类似“command XXXX requires authentication”的错误信息</p>
<p>2、切换到数据库admin，在该数据库下通过全局管理用户itcastAdmin进行身份验证，再次执行查看集合user中的文档并插入一条新的文档。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">shihanshuors:PRIMARY&gt; db</span><br><span class="line">admin</span><br><span class="line">shihanshuors:PRIMARY&gt; db.auth(<span class="string">&quot;itcastAdmin&quot;</span>,<span class="string">&quot;12345&quot;</span>)</span><br><span class="line">Error: Authentication failed.</span><br><span class="line">0</span><br><span class="line">shihanshuors:PRIMARY&gt; db.auth(<span class="string">&quot;itcastAdmin&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">1</span><br><span class="line">shihanshuors:PRIMARY&gt; use <span class="built_in">test</span></span><br><span class="line">switched to db <span class="built_in">test</span></span><br><span class="line">shihanshuors:PRIMARY&gt; db.user.find()</span><br><span class="line">shihanshuors:PRIMARY&gt; db.user.insert(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;heima&quot;</span>&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : 1 &#125;)</span><br><span class="line">shihanshuors:PRIMARY&gt; db.user.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;652fd56687384c473596440a&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;heima&quot;</span> &#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br></pre></td></tr></table></figure>

<p>执行上述操作时，可以看出全局管理用户itcastAdmin进行身份验证后，可以正常对集合进行读取和写入操作。</p>
<p>3、开启安全认证后，副本集操作需要切换到具有root权限的用户去配置副本集，添加root权限用户命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# mongo --port=27017</span><br><span class="line">MongoDB shell version v4.4.24</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;4b281950-459c-4d58-bd76-4a2e1b5ad238&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.4.24</span><br><span class="line">shihanshuors:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">shihanshuors:PRIMARY&gt; db.auth(<span class="string">&quot;itcastAdmin&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">1</span><br><span class="line">shihanshuors:PRIMARY&gt; db.createUser(&#123;user:<span class="string">&quot;admin&quot;</span>,<span class="built_in">pwd</span>:<span class="string">&quot;123456&quot;</span>,roles:[&#123;role:<span class="string">&quot;root&quot;</span>,db:<span class="string">&quot;admin&quot;</span>&#125;]&#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">	<span class="string">&quot;user&quot;</span> : <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">	<span class="string">&quot;roles&quot;</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;role&quot;</span> : <span class="string">&quot;root&quot;</span>,</span><br><span class="line">			<span class="string">&quot;db&quot;</span> : <span class="string">&quot;admin&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; db.auth(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">1</span><br><span class="line">shihanshuors:PRIMARY&gt; </span><br></pre></td></tr></table></figure>



<h2 id="十三、MongoDB分片"><a href="#十三、MongoDB分片" class="headerlink" title="十三、MongoDB分片"></a>十三、MongoDB分片</h2><h3 id="分片概述"><a href="#分片概述" class="headerlink" title="分片概述"></a>分片概述</h3><p>副本集的特点，不管我搭载多少个副本节点， 它存储的数据都是一样的。存储的数据一样就会带来一个问题了，<strong>数据只能存在一台服务器上面</strong>。那完整的数据随着业务量非常大的时候，就会发生一台服务器已经存不下的情况，<strong>我们怎么办</strong>？</p>
<p>那我们就得用<strong>分片集群</strong>的方式来解决问题。</p>
<p><strong>分片（sharding）是一种跨多台机器分布数据的方法</strong>， MongoDB使用分片来支持具有<strong>非常大的数据集</strong>和<strong>高吞吐量操作</strong>的部署。换句话说：分片(sharding)是指将数据拆分，将其分散存在不同的机器上的过程。有时也用分区(partitioning)来表示这个概念。将数据分散到不同的机器上，不需要功能强大的大型计算机就可以储存更多的数据，处理更多的负载。</p>
<p>分片与副本集主要区别在于，<strong>分片</strong>是每个节点存储数据的不同片段，而<strong>副本集</strong>是每个节点存储数据的相同副本。</p>
<p>所有数据库都可以进行<strong>手动分片（Manual Sharding）</strong>，因此，<strong>分片并不是MongoDB特有的</strong>。不同类型的数据均可以通过人为操作被分配到不同的数据库服务器上，然而，人工分片是<strong>需要编写相关代码来实现分片功能</strong>，并且还不容易维护（如集群中节点发生变动的情况）。MongoDB数据库可以实现自动分片，它<strong>内置了多种分片逻辑</strong>，使得MongoDB可以自动处理分片上数据的分布，也可以很容易的管理分片集群。</p>
<ul>
<li>由于数据量太大，导致本地磁盘不足以存储的情况；</li>
<li>为了提高数据库性能，从而将海量数据存储在内存中，导致单个MongoDB数据库内存不足的情况；</li>
<li>若是出现数据请求量太大，导致单MongoDB机器不能满足读写数据的性能情况。</li>
</ul>
<p>若是出现这三种情况，我们就可以使用MongoDB的分片技术来解决。</p>
<p>具有大型数据集或高吞吐量应用程序的数据库系统可以会挑战单个服务器的容量。例如，高查询率会耗尽服务器的CPU容量。工作集大小大于系统的RAM会强调磁盘驱动器的I &#x2F; O容量。</p>
<p>有两种解决系统增长的方法：<strong>垂直扩展和水平扩展</strong>。</p>
<p><strong>垂直扩展意味着增加单个服务器的容量</strong>，例如使用更强大的CPU，添加更多RAM或增加存储空间量。可用技术的局限性可能会限制单个机器对于给定工作负载而言足够强大。此外，基于云的提供商基于可用的硬件配置具有硬性上限。结果，垂直缩放有实际的最大值。</p>
<p><strong>水平扩展意味着划分系统数据集并加载多个服务器</strong>，添加其他服务器以根据需要增加容量。虽然单个机器的总体速度或容量可能不高，但每台机器处理整个工作负载的子集，可能提供比单个高速大容量服务器更高的效率。扩展部署容量只需要根据需要添加额外的服务器，这可能比单个机器的高端硬件的总体成本更低。权衡是基础架构和部署维护的复杂性增加。</p>
<p>MongoDB支持通过分片进行水平扩展。</p>
<h3 id="分片策略"><a href="#分片策略" class="headerlink" title="分片策略"></a>分片策略</h3><p>MongoDB之所以能够实现自动分片，这是因为其内置了分片策略。MongoDB通过分片键（Shard Key）将集合中的数据划分为多个块（Chunk）（默认大小为64MB，每个块均表示集合中数据的一部分），然后MongoDB根据分片策略将划分的块分发到分片集群中。需要注意，分片键可以是集合文档中的一个或多个字段。</p>
<p>MongoDB的分片策略主要包括<strong>范围分片</strong>和<strong>哈希分片</strong>两种，介绍如下：</p>
<h4 id="范围分片"><a href="#范围分片" class="headerlink" title="范围分片"></a>范围分片</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021003653.png" alt="image-20220402100359515"></p>
<p><strong>MongoDB根据分片键的值范围将数据划分为不同块，每个分片都包含了分片键在一定范围内的数据</strong>。这样的话，若有文档写入时，MongoDB会根据该文档的分片键，从而交由指定分片服务器去处理。下面，通过一张图来介绍范围分片策略，具体如图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021003270.png" alt="image-20220402100321054"></p>
<p>从图中可以看出，</p>
<ul>
<li><p>若文档分片键的值范围在[minKey，10）中，则该文档需要交由分片服务器A进行相关处理；</p>
</li>
<li><p>若文档分片键的值范围在[10，20）中，则该文档需要交由分片服务器B进行相关处理；</p>
</li>
<li><p>若文档分片键的值范围在[20，maxKey）中，则该文档需要交由分片服务器C进行相关处理。</p>
</li>
</ul>
<p>使用基于范围分片时，拥有<strong>相近分片键</strong>的文档会存储在同一个分片服务器中，从而提升范围查询的效率。但是，当插入批量文档时，分片键集中在一定范围内，就会导致数据分布不均匀，从而导致其中一个分片服务器负载过重。</p>
<h4 id="哈希分片"><a href="#哈希分片" class="headerlink" title="哈希分片"></a>哈希分片</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021004558.png" alt="image-20220402100444406"></p>
<p>哈希分片类似于范围分片，两者的区别在于<strong>范围分片是MongoDB根据分片键的值</strong>直接进行范围划分，而<strong>哈希分片则先将分片键的值进行哈希计算后，然后对这些哈希值进行范围划分</strong>，从而使得每个分片都包含了哈希值在一定范围内的数据；范围分片可以支持复合分片键，而<strong>哈希分片只支持单个字段</strong>作为分片键。哈希值的随机性，使得数据随机分布在分片集群中不同分片服务器上。下面，通过一张图介绍哈希分片策略，如图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021005581.png" alt="image-20220402100502431"></p>
<p>从图中可以看出，若文档分片键的哈希值为5，则该文档需要交由分片服务器A进行相关处理；若文档分片键的哈希值为12，则该文档需要交由分片服务器B进行相关处理；若文档分片键的哈希值为23，则该文档需要交由分片服务器C进行相关处理。<br>使用基于哈希分片时，拥有“相近”分片键的文档不会存储在同一个分片服务器中，这样的话，数据的分离性会更好，可以保证分片集群中数据分布均衡。但是，由于数据是通过哈希计算进行随机存放的，因此会降低查询性能。</p>
<p>注意：</p>
<ul>
<li><p>分片键</p>
<p>(1）分片键一旦指定，后续则无法改变，并且只能拥有一个分片键。</p>
<p>(2）不允许在已分片的集合文档上插入没有分片键的文档。</p>
<p>(3）分片键的长度大小，不可超过512个字节。</p>
<p>(4）用于作分片键的字段必须创建索引，索引可以是分片键开头的复合索引。</p>
</li>
<li><p>块（chunk）大小</p>
<p>(1）小块可以均匀地分布数据，但会导致迁移很频繁，这样会增大路由服务器的开销。</p>
<p>(2）大块触发的迁移较少，但会导致数据分布不均匀。</p>
<p>(3）块的大小会影响要迁移块的最大文档数。</p>
<p>(4) 块的分片键值范围是（-∞,+∞)，其中﹣0∞表示最小值（minKey),+∞表示最大值（maxKey)。</p>
</li>
</ul>
<h4 id="分片集群架构"><a href="#分片集群架构" class="headerlink" title="分片集群架构"></a>分片集群架构</h4><p>在MongoDB分片集群中，只有各组件间的协同工作，才可使得分片集群正常运行。在学习分片集群的操作之前，有必要先来学习一下分片集群架构。下面，通过一张图来介绍分片集群架构，具体如图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021007061.png" alt="image-20220402100714832"></p>
<p>从图中可以看出，<strong>分片集群中主要由三个部分组成，即分片服务器（Shard）、路由服务器（Mongos）以及配置服务器（Config Server）组成</strong>。其中，分片服务器有三个，即Shard1、Shard2、Shard3；路由服务器有两个，即Mongos1和Mongos2；配置服务器有三个，即主、副、副。下面，我们针对分片集群架构中的组成部分进行详细介绍，具体如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021008707.png" alt="image-20220402100831594"></p>
<p>即MongoDB实例（即mongod，用Shard表示），分片服务器是<strong>实际存储数据的组件</strong>，持有完整数据集中的一部分，每个分片服务器都<strong>可以是一个MongoDB实例</strong>，<strong>也可是一组MongoDB实例组成的集群（副本集）</strong>。从MongoDB 3.6开始，必须将分片部署为副本集，这样具有更好的容错性。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021009884.png" alt="image-20220402100916761"></p>
<p>即mongos，路由服务器主要提供客户端应用程序与分片集群交互的接口，<strong>所有请求都需要通过路由服务器进行协调工作</strong>。路由服务器实际上就是一个<strong>消息分发请求中心</strong>，它负责把客户端应用程序对应的数据请求转发到对应的分片服务器上。应用程序将查询、存储、更新等请求原封不动地发送给路由服务器。路由服务器询问配置服务器操作分片服务器需要获取哪些元数据，然后连接相应的分片服务器进行相关操作，最后将各个分片服务器的响应进行合并，返回给客户端应用程序。<br>生产环境中，一个分片集群通常会有<strong>多个</strong>路由服务器，一方面可以解决多个客户端同时请求，从而达到负载均衡的效果；另一方面可以解决当路由服务器宕机时导致整个分片集群无法使用的问题。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021009853.png" alt="image-20220402100939679"></p>
<p>即Config Server。在生产环境中，通常需要多个配置服务器，因为它<strong>存储了分片集群的元数据，并且这些数据是不允许丢失的</strong>。因此，需要配置多个配置服务器以防止数据丢失，尽管其中一台分片服务器宕机，我们还有其它配置服务器，从而保证MongoDB分片集群依然能够正常工作。从MongoDB 3.4版本开始，配置服务器必须部署副本集，因此我们需要配置三个配置服务器组成的副本集。<br><strong>配置服务器存储着分片集群的持久化元数据</strong>，而<strong>路由服务器存储着分片集群的非持久化元数据</strong>，这些数据均为<strong>内存缓存的数据</strong>。当路由服务器初次启动或关闭重启时，就会从配置服务器中加载分片集群的元数据。若是配置服务器的信息发生变化，则会通知所有路由服务器更新自己的状态，这样路由服务器就能继续准确的协调客户端与分片集群的交互工作。</p>
<h3 id="部署分片集群"><a href="#部署分片集群" class="headerlink" title="部署分片集群"></a>部署分片集群</h3><p>MongoDB分片群集包含以下组件：</p>
<ul>
<li><p>分片（存储）：每个分片包含分片数据的子集。 每个分片都可以部署为副本集。</p>
</li>
<li><p>mongos（路由）：mongos充当查询路由器，在客户端应用程序和分片集群之间提供接口。</p>
</li>
<li><p>confifig servers（“调度”的配置）：配置服务器存储群集的元数据和配置设置（即哪个分片存放哪个数据）。 从MongoDB 3.4开始，必须将配置服务器部署为副本集（CSRS）。</p>
</li>
</ul>
<p>下图描述了分片集群中组件的交互： </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021046747.png" alt="image-20220402104657438"></p>
<p>两个分片节点副本集（3+3）+一个配置节点副本集（3）+两个路由节点（2），共11个服务节点。</p>
<p>2个路由是为了容灾，一个路由挂了之后，我另一个路由 还能用。但2个路由之间是相互独立的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204021041917.png" alt="image-20220402104144613"></p>
<p>分片中有仲裁就是为了节省成本。而配置服务中只是为了存储配置信息，它的数据量不大。</p>
<p>所有的的配置文件都直接放到  <code>sharded_cluster</code> 的相应的子目录下面，默认配置文件名字：<code>mongod.conf</code></p>
<p>在搭建服务架构之前，一定要确保系统是干净的可以使用 <code>ps -ef</code> 命令，查看是否又mongod相关的服务，有的话就把他们的进程 <code>kill</code> 掉，以此来确保你的系统中mongod的端口不被占用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204022236665.png" alt="image-20220402223630325"></p>
<h4 id="分片（存储）节点副本集的创建"><a href="#分片（存储）节点副本集的创建" class="headerlink" title="分片（存储）节点副本集的创建"></a>分片（存储）节点副本集的创建</h4><h5 id="1-第一套副本集"><a href="#1-第一套副本集" class="headerlink" title="1.第一套副本集"></a>1.第一套副本集</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备存放数据和日志的目录：</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/log \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/data/db</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/log \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/data/db</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/log \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/data/db</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204022243582.png" alt="image-20220402224307995"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 4 root root 29 10月 21 19:34 shihanshuoshardrs01_27018</span><br><span class="line">drwxr-xr-x 4 root root 29 10月 21 19:34 shihanshuoshardrs01_27118</span><br><span class="line">drwxr-xr-x 4 root root 29 10月 21 19:34 shihanshuoshardrs01_27218</span><br><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 16 10月 21 19:34 data</span><br><span class="line">drwxr-xr-x 2 root root  6 10月 21 19:34 <span class="built_in">log</span></span><br><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 16 10月 21 19:34 data</span><br><span class="line">drwxr-xr-x 2 root root  6 10月 21 19:34 <span class="built_in">log</span></span><br><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 16 10月 21 19:34 data</span><br><span class="line">drwxr-xr-x 2 root root  6 10月 21 19:34 <span class="built_in">log</span></span><br><span class="line">[root@localhost mongodb]# </span><br></pre></td></tr></table></figure>



<h6 id="27018的配置文件"><a href="#27018的配置文件" class="headerlink" title="27018的配置文件"></a>27018的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新建或修改配置文件：</span></span><br><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/data/db&quot;</span></span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27018 </span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuoshardrs01 </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#分片角色 </span></span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>

<p>注意：<br>设置sharding.clusterRole需要mongod实例运行复制。 要将实例部署为副本集成员，请使用replSetName设置并指定副本集的名称。</p>
<h6 id="27118的配置文件"><a href="#27118的配置文件" class="headerlink" title="27118的配置文件"></a>27118的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/data/db&quot;</span></span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27118 </span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuoshardrs01 </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#分片角色 </span></span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>

<h6 id="27218的配置文件"><a href="#27218的配置文件" class="headerlink" title="27218的配置文件"></a>27218的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/data/db&quot;</span></span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27218 </span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuoshardrs01 </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#分片角色 </span></span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>

<h6 id="启动第一套副本集"><a href="#启动第一套副本集" class="headerlink" title="启动第一套副本集"></a>启动第一套副本集</h6><p>启动第一套副本集：一主一副本一仲裁<br>依次启动三个mongod服务，并查看服务是否启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/mongod.conf </span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 7835</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/mongod.conf </span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 7884</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/mongod.conf </span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 7934</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# ps -ef | grep mongod</span><br><span class="line">root       7835      1  8 22:51 ?        00:00:02 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/mongod.conf</span><br><span class="line">root       7884      1 12 22:51 ?        00:00:01 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/mongod.conf</span><br><span class="line">root       7934      1 19 22:51 ?        00:00:01 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/mongod.conf</span><br><span class="line">root       7977   7599  0 22:51 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>

<h6 id="初始化第一套副本集"><a href="#初始化第一套副本集" class="headerlink" title="初始化第一套副本集"></a>初始化第一套副本集</h6><p>（1）初始化副本集和创建主节点：使用客户端命令连接任意一个节点，但这里尽量要连接主节点：<br><code>mongo --host=192.168.24.105 --port=27018</code><br>执行初始化副本集命令：<code>rs.initiate()</code><br>查看副本集情况：<code>rs.status()</code></p>
<p>（2）主节点配置查看：<code>rs.conf()</code></p>
<p>（3）添加副本节点：<code>rs.add(&quot;192.168.24.105:27118&quot;)</code></p>
<p>（4）添加仲裁节点：<code>rs.addArb(&quot;192.168.24.105:27218&quot;)</code><br>查看副本集的配置情况：<code>rs.status()</code></p>
<p>代码过程如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongo --host=192.168.24.105 --port=27018</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://192.168.24.105:27018/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;f5e3d71c-235d-445e-8438-22ee42c3dd67&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-04-02T22:51:26.943+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T22:51:26.943+0800 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-04-02T22:51:26.943+0800 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-04-02T22:51:26.943+0800 I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-04-02T22:51:26.943+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T22:51:26.943+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T22:51:26.943+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-04-02T22:51:26.943+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-04-02T22:51:26.943+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T22:51:26.944+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-04-02T22:51:26.944+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-04-02T22:51:26.944+0800 I  CONTROL  [initandlisten] </span><br><span class="line">---</span><br><span class="line">Enable MongoDB<span class="string">&#x27;s free cloud-based monitoring service, which will then receive and display</span></span><br><span class="line"><span class="string">metrics about your deployment (disk utilization, CPU, operation statistics, etc).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The monitoring data will be available on a MongoDB website with a unique URL accessible to you</span></span><br><span class="line"><span class="string">and anyone you share the URL with. MongoDB may use this information to make product</span></span><br><span class="line"><span class="string">improvements and to suggest MongoDB products and deployment options to you.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To enable free monitoring, run the following command: db.enableFreeMonitoring()</span></span><br><span class="line"><span class="string">To permanently disable this reminder, run the following command: db.disableFreeMonitoring()</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt; rs.initiate()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;info2&quot; : &quot;no configuration specified. Using a default configuration for the set&quot;,</span></span><br><span class="line"><span class="string">	&quot;me&quot; : &quot;192.168.24.105:27018&quot;,</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoshardrs01:SECONDARY&gt; </span></span><br><span class="line"><span class="string">shihanshuoshardrs01:PRIMARY&gt; </span></span><br><span class="line"><span class="string">shihanshuoshardrs01:PRIMARY&gt; rs.add(&quot;192.168.24.105:27118&quot;)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$clusterTime&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;clusterTime&quot; : Timestamp(1648912062, 1),</span></span><br><span class="line"><span class="string">		&quot;signature&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span></span><br><span class="line"><span class="string">			&quot;keyId&quot; : NumberLong(0)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;operationTime&quot; : Timestamp(1648912062, 1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoshardrs01:PRIMARY&gt; rs.addArb(&quot;192.168.24.105:27218&quot;)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$clusterTime&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;clusterTime&quot; : Timestamp(1648912077, 1),</span></span><br><span class="line"><span class="string">		&quot;signature&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span></span><br><span class="line"><span class="string">			&quot;keyId&quot; : NumberLong(0)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;operationTime&quot; : Timestamp(1648912077, 1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoshardrs01:PRIMARY&gt; rs.status()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;set&quot; : &quot;shihanshuoshardrs01&quot;,</span></span><br><span class="line"><span class="string">	&quot;date&quot; : ISODate(&quot;2022-04-02T15:08:12.233Z&quot;),</span></span><br><span class="line"><span class="string">	&quot;myState&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;term&quot; : NumberLong(1),</span></span><br><span class="line"><span class="string">	&quot;syncingTo&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">	&quot;syncSourceHost&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">	&quot;syncSourceId&quot; : -1,</span></span><br><span class="line"><span class="string">	&quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span></span><br><span class="line"><span class="string">	&quot;majorityVoteCount&quot; : 2,</span></span><br><span class="line"><span class="string">	&quot;writeMajorityCount&quot; : 2,</span></span><br><span class="line"><span class="string">	&quot;optimes&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastCommittedOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912091, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;lastCommittedWallTime&quot; : ISODate(&quot;2022-04-02T15:08:11.986Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;readConcernMajorityOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912091, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;readConcernMajorityWallTime&quot; : ISODate(&quot;2022-04-02T15:08:11.986Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;appliedOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912091, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;durableOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912091, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;lastAppliedWallTime&quot; : ISODate(&quot;2022-04-02T15:08:11.986Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;lastDurableWallTime&quot; : ISODate(&quot;2022-04-02T15:08:11.986Z&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;lastStableRecoveryTimestamp&quot; : Timestamp(1648912091, 1),</span></span><br><span class="line"><span class="string">	&quot;lastStableCheckpointTimestamp&quot; : Timestamp(1648912091, 1),</span></span><br><span class="line"><span class="string">	&quot;electionCandidateMetrics&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastElectionReason&quot; : &quot;electionTimeout&quot;,</span></span><br><span class="line"><span class="string">		&quot;lastElectionDate&quot; : ISODate(&quot;2022-04-02T15:07:11.929Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;electionTerm&quot; : NumberLong(1),</span></span><br><span class="line"><span class="string">		&quot;lastCommittedOpTimeAtElection&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(0, 0),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(-1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;lastSeenOpTimeAtElection&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912031, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(-1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;numVotesNeeded&quot; : 1,</span></span><br><span class="line"><span class="string">		&quot;priorityAtElection&quot; : 1,</span></span><br><span class="line"><span class="string">		&quot;electionTimeoutMillis&quot; : NumberLong(10000),</span></span><br><span class="line"><span class="string">		&quot;newTermStartDate&quot; : ISODate(&quot;2022-04-02T15:07:11.973Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;wMajorityWriteAvailabilityDate&quot; : ISODate(&quot;2022-04-02T15:07:12.031Z&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;members&quot; : [</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			&quot;_id&quot; : 0,</span></span><br><span class="line"><span class="string">			&quot;name&quot; : &quot;192.168.24.105:27018&quot;,</span></span><br><span class="line"><span class="string">			&quot;health&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;state&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;stateStr&quot; : &quot;PRIMARY&quot;,</span></span><br><span class="line"><span class="string">			&quot;uptime&quot; : 1007,</span></span><br><span class="line"><span class="string">			&quot;optime&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912091, 1),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDate&quot; : ISODate(&quot;2022-04-02T15:08:11Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;syncingTo&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceHost&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceId&quot; : -1,</span></span><br><span class="line"><span class="string">			&quot;infoMessage&quot; : &quot;could not find member to sync from&quot;,</span></span><br><span class="line"><span class="string">			&quot;electionTime&quot; : Timestamp(1648912031, 2),</span></span><br><span class="line"><span class="string">			&quot;electionDate&quot; : ISODate(&quot;2022-04-02T15:07:11Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;configVersion&quot; : 3,</span></span><br><span class="line"><span class="string">			&quot;self&quot; : true,</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			&quot;_id&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;name&quot; : &quot;192.168.24.105:27118&quot;,</span></span><br><span class="line"><span class="string">			&quot;health&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;state&quot; : 2,</span></span><br><span class="line"><span class="string">			&quot;stateStr&quot; : &quot;SECONDARY&quot;,</span></span><br><span class="line"><span class="string">			&quot;uptime&quot; : 30,</span></span><br><span class="line"><span class="string">			&quot;optime&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912077, 1),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDurable&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912077, 1),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDate&quot; : ISODate(&quot;2022-04-02T15:07:57Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;optimeDurableDate&quot; : ISODate(&quot;2022-04-02T15:07:57Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeat&quot; : ISODate(&quot;2022-04-02T15:08:11.104Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2022-04-02T15:08:10.653Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;pingMs&quot; : NumberLong(0),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncingTo&quot; : &quot;192.168.24.105:27018&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceHost&quot; : &quot;192.168.24.105:27018&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceId&quot; : 0,</span></span><br><span class="line"><span class="string">			&quot;infoMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;configVersion&quot; : 3</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			&quot;_id&quot; : 2,</span></span><br><span class="line"><span class="string">			&quot;name&quot; : &quot;192.168.24.105:27218&quot;,</span></span><br><span class="line"><span class="string">			&quot;health&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;state&quot; : 7,</span></span><br><span class="line"><span class="string">			&quot;stateStr&quot; : &quot;ARBITER&quot;,</span></span><br><span class="line"><span class="string">			&quot;uptime&quot; : 15,</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeat&quot; : ISODate(&quot;2022-04-02T15:08:11.104Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2022-04-02T15:08:11.151Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;pingMs&quot; : NumberLong(1),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncingTo&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceHost&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceId&quot; : -1,</span></span><br><span class="line"><span class="string">			&quot;infoMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;configVersion&quot; : 3</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	],</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$clusterTime&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;clusterTime&quot; : Timestamp(1648912091, 1),</span></span><br><span class="line"><span class="string">		&quot;signature&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span></span><br><span class="line"><span class="string">			&quot;keyId&quot; : NumberLong(0)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;operationTime&quot; : Timestamp(1648912091, 1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoshardrs01:PRIMARY&gt; exit</span></span><br><span class="line"><span class="string">bye</span></span><br><span class="line"><span class="string">[root@localhost ~]# </span></span><br></pre></td></tr></table></figure>

<p>字段解释：</p>
<ul>
<li>name是副本集节点的ip和端口信息</li>
<li>health表示副本集中该节点是否正常，0表示不正常，1表示正常</li>
<li>state表示节点的身份，0表示非主节点，1表示主节点</li>
<li>stateStr用于对节点身份进行字符描述，PRIMARY表示主节点，SECONDARY表示副节点</li>
<li>uptime 从成员可到达一直到现在经历的时间，单位是秒。</li>
<li>optimeDate 每个成员oplog最后一次操作发生的时间，这个时间是心跳报上来的，因此可能会存在延迟</li>
<li>lastHeartbeat 当前服务器最后一次收到其他成员心跳的时间，如果网络故障等可能这个时间会大于2秒</li>
<li>pinMs 心跳从当前服务器达到某个成员所花费的平均时间</li>
<li>syncingTo 当前服务器从哪个节点在做同步</li>
<li>self 这个信息出现在执行rs.status()函数的成员信息中</li>
<li>errmsg 成员在心跳请求中返回的状态信息，通过是一些状态信息，不全是错误信息。</li>
</ul>
<p>health表示服务器是否可达，可达是1，不可达是0<br>optime与optimeDate表达的信息也是一样的，只是表示的方式不同，一个是用新纪元开始的毫秒数表示的，一个是用一种更容易阅读的方式表示。<br>由于rs.status()是从执行命令成员本身的角度得出的，由于网路等故障，这份报告可能不准确或者有些过时。</p>
<h5 id="2-第二套副本集"><a href="#2-第二套副本集" class="headerlink" title="2.第二套副本集"></a>2.第二套副本集</h5><p>所有的的配置文件都直接放到 sharded_cluster 的相应的子目录下面，默认配置文件名字：mongod.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备存放数据和日志的目录：</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/log \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/data/db</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/log \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/data/db</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/log \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/data/db</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204022254495.png" alt="image-20220402225434152"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 4 root root 48 10月 21 19:36 shihanshuoshardrs01_27018</span><br><span class="line">drwxr-xr-x 4 root root 48 10月 21 19:40 shihanshuoshardrs01_27118</span><br><span class="line">drwxr-xr-x 4 root root 48 10月 21 19:40 shihanshuoshardrs01_27218</span><br><span class="line">drwxr-xr-x 4 root root 29 10月 21 19:41 shihanshuoshardrs02_27318</span><br><span class="line">drwxr-xr-x 4 root root 29 10月 21 19:41 shihanshuoshardrs02_27418</span><br><span class="line">drwxr-xr-x 4 root root 29 10月 21 19:41 shihanshuoshardrs02_27518</span><br><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 16 10月 21 19:41 data</span><br><span class="line">drwxr-xr-x 2 root root  6 10月 21 19:41 <span class="built_in">log</span></span><br><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 16 10月 21 19:41 data</span><br><span class="line">drwxr-xr-x 2 root root  6 10月 21 19:41 <span class="built_in">log</span></span><br><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 16 10月 21 19:41 data</span><br><span class="line">drwxr-xr-x 2 root root  6 10月 21 19:41 <span class="built_in">log</span></span><br><span class="line">[root@localhost mongodb]# </span><br></pre></td></tr></table></figure>


<h6 id="27318的配置文件"><a href="#27318的配置文件" class="headerlink" title="27318的配置文件"></a>27318的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新建或修改配置文件：</span></span><br><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/data/db&quot;</span></span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27318 </span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuoshardrs02 </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#分片角色 </span></span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>

<h6 id="27418的配置文件"><a href="#27418的配置文件" class="headerlink" title="27418的配置文件"></a>27418的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/data/db&quot;</span></span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27418 </span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuoshardrs02 </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#分片角色 </span></span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>

<h6 id="27518的配置文件"><a href="#27518的配置文件" class="headerlink" title="27518的配置文件"></a>27518的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/data/db&quot;</span></span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27518 </span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuoshardrs02 </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#分片角色 </span></span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>

<h6 id="启动第二套副本集"><a href="#启动第二套副本集" class="headerlink" title="启动第二套副本集"></a>启动第二套副本集</h6><p>依次启动三个mongod服务，并查看服务是否启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8466</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8508</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8551</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# ps -ef | grep mongod</span><br><span class="line">root       7835      1  1 22:51 ?        00:00:06 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/mongod.conf</span><br><span class="line">root       7884      1  1 22:51 ?        00:00:06 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/mongod.conf</span><br><span class="line">root       7934      1  1 22:51 ?        00:00:05 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/mongod.conf</span><br><span class="line">root       8466      1  7 22:59 ?        00:00:01 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/mongod.conf</span><br><span class="line">root       8508      1 12 22:59 ?        00:00:01 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/mongod.conf</span><br><span class="line">root       8551      1 25 22:59 ?        00:00:02 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/mongod.conf</span><br><span class="line">root       8593   7599  0 22:59 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>

<h6 id="初始化第二套副本集"><a href="#初始化第二套副本集" class="headerlink" title="初始化第二套副本集"></a>初始化第二套副本集</h6><p>（1）初始化副本集和创建主节点：使用客户端命令连接任意一个节点，但这里尽量要连接主节点：<br><code>mongo --host=192.168.24.105 --port=27318</code><br>执行初始化副本集命令：<code>rs.initiate()</code><br>查看副本集情况：<code>rs.status()</code></p>
<p>（2）主节点配置查看：<code>rs.conf()</code></p>
<p>（3）添加副本节点：<code>rs.add(&quot;192.168.24.105:27418&quot;)</code></p>
<p>（4）添加仲裁节点：<code>rs.addArb(&quot;192.168.24.105:27518&quot;)</code><br>查看副本集的配置情况：<code>rs.status()</code></p>
<p>代码过程如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongo --host=192.168.24.105 --port=27318</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://192.168.24.105:27318/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;1a927c47-bd43-47ad-8ed0-f98b2107e631&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-04-02T22:59:38.644+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T22:59:38.644+0800 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-04-02T22:59:38.644+0800 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-04-02T22:59:38.644+0800 I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-04-02T22:59:38.644+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T22:59:38.644+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T22:59:38.645+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-04-02T22:59:38.645+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-04-02T22:59:38.645+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T22:59:38.645+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-04-02T22:59:38.645+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-04-02T22:59:38.645+0800 I  CONTROL  [initandlisten] </span><br><span class="line">---</span><br><span class="line">Enable MongoDB<span class="string">&#x27;s free cloud-based monitoring service, which will then receive and display</span></span><br><span class="line"><span class="string">metrics about your deployment (disk utilization, CPU, operation statistics, etc).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The monitoring data will be available on a MongoDB website with a unique URL accessible to you</span></span><br><span class="line"><span class="string">and anyone you share the URL with. MongoDB may use this information to make product</span></span><br><span class="line"><span class="string">improvements and to suggest MongoDB products and deployment options to you.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To enable free monitoring, run the following command: db.enableFreeMonitoring()</span></span><br><span class="line"><span class="string">To permanently disable this reminder, run the following command: db.disableFreeMonitoring()</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt; rs.initiate()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;info2&quot; : &quot;no configuration specified. Using a default configuration for the set&quot;,</span></span><br><span class="line"><span class="string">	&quot;me&quot; : &quot;192.168.24.105:27318&quot;,</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoshardrs02:SECONDARY&gt; </span></span><br><span class="line"><span class="string">shihanshuoshardrs02:PRIMARY&gt; rs.add(&quot;192.168.24.105:27418&quot;)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$clusterTime&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;clusterTime&quot; : Timestamp(1648912357, 1),</span></span><br><span class="line"><span class="string">		&quot;signature&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span></span><br><span class="line"><span class="string">			&quot;keyId&quot; : NumberLong(0)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;operationTime&quot; : Timestamp(1648912357, 1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoshardrs02:PRIMARY&gt; rs.addArb(&quot;192.168.24.105:27518&quot;)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$clusterTime&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;clusterTime&quot; : Timestamp(1648912368, 1),</span></span><br><span class="line"><span class="string">		&quot;signature&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span></span><br><span class="line"><span class="string">			&quot;keyId&quot; : NumberLong(0)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;operationTime&quot; : Timestamp(1648912368, 1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoshardrs02:PRIMARY&gt; rs.status()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;set&quot; : &quot;shihanshuoshardrs02&quot;,</span></span><br><span class="line"><span class="string">	&quot;date&quot; : ISODate(&quot;2022-04-02T15:13:00.198Z&quot;),</span></span><br><span class="line"><span class="string">	&quot;myState&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;term&quot; : NumberLong(1),</span></span><br><span class="line"><span class="string">	&quot;syncingTo&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">	&quot;syncSourceHost&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">	&quot;syncSourceId&quot; : -1,</span></span><br><span class="line"><span class="string">	&quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span></span><br><span class="line"><span class="string">	&quot;majorityVoteCount&quot; : 2,</span></span><br><span class="line"><span class="string">	&quot;writeMajorityCount&quot; : 2,</span></span><br><span class="line"><span class="string">	&quot;optimes&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastCommittedOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912368, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;lastCommittedWallTime&quot; : ISODate(&quot;2022-04-02T15:12:48.688Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;readConcernMajorityOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912368, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;readConcernMajorityWallTime&quot; : ISODate(&quot;2022-04-02T15:12:48.688Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;appliedOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912368, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;durableOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912368, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;lastAppliedWallTime&quot; : ISODate(&quot;2022-04-02T15:12:48.688Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;lastDurableWallTime&quot; : ISODate(&quot;2022-04-02T15:12:48.688Z&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;lastStableRecoveryTimestamp&quot; : Timestamp(1648912334, 5),</span></span><br><span class="line"><span class="string">	&quot;lastStableCheckpointTimestamp&quot; : Timestamp(1648912334, 5),</span></span><br><span class="line"><span class="string">	&quot;electionCandidateMetrics&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastElectionReason&quot; : &quot;electionTimeout&quot;,</span></span><br><span class="line"><span class="string">		&quot;lastElectionDate&quot; : ISODate(&quot;2022-04-02T15:12:14.400Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;electionTerm&quot; : NumberLong(1),</span></span><br><span class="line"><span class="string">		&quot;lastCommittedOpTimeAtElection&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(0, 0),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(-1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;lastSeenOpTimeAtElection&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912334, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(-1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;numVotesNeeded&quot; : 1,</span></span><br><span class="line"><span class="string">		&quot;priorityAtElection&quot; : 1,</span></span><br><span class="line"><span class="string">		&quot;electionTimeoutMillis&quot; : NumberLong(10000),</span></span><br><span class="line"><span class="string">		&quot;newTermStartDate&quot; : ISODate(&quot;2022-04-02T15:12:14.602Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;wMajorityWriteAvailabilityDate&quot; : ISODate(&quot;2022-04-02T15:12:14.677Z&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;members&quot; : [</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			&quot;_id&quot; : 0,</span></span><br><span class="line"><span class="string">			&quot;name&quot; : &quot;192.168.24.105:27318&quot;,</span></span><br><span class="line"><span class="string">			&quot;health&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;state&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;stateStr&quot; : &quot;PRIMARY&quot;,</span></span><br><span class="line"><span class="string">			&quot;uptime&quot; : 803,</span></span><br><span class="line"><span class="string">			&quot;optime&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912368, 1),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDate&quot; : ISODate(&quot;2022-04-02T15:12:48Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;syncingTo&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceHost&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceId&quot; : -1,</span></span><br><span class="line"><span class="string">			&quot;infoMessage&quot; : &quot;could not find member to sync from&quot;,</span></span><br><span class="line"><span class="string">			&quot;electionTime&quot; : Timestamp(1648912334, 2),</span></span><br><span class="line"><span class="string">			&quot;electionDate&quot; : ISODate(&quot;2022-04-02T15:12:14Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;configVersion&quot; : 3,</span></span><br><span class="line"><span class="string">			&quot;self&quot; : true,</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			&quot;_id&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;name&quot; : &quot;192.168.24.105:27418&quot;,</span></span><br><span class="line"><span class="string">			&quot;health&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;state&quot; : 2,</span></span><br><span class="line"><span class="string">			&quot;stateStr&quot; : &quot;SECONDARY&quot;,</span></span><br><span class="line"><span class="string">			&quot;uptime&quot; : 22,</span></span><br><span class="line"><span class="string">			&quot;optime&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912368, 1),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDurable&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912368, 1),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDate&quot; : ISODate(&quot;2022-04-02T15:12:48Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;optimeDurableDate&quot; : ISODate(&quot;2022-04-02T15:12:48Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeat&quot; : ISODate(&quot;2022-04-02T15:12:58.706Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2022-04-02T15:12:59.715Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;pingMs&quot; : NumberLong(0),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncingTo&quot; : &quot;192.168.24.105:27318&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceHost&quot; : &quot;192.168.24.105:27318&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceId&quot; : 0,</span></span><br><span class="line"><span class="string">			&quot;infoMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;configVersion&quot; : 3</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			&quot;_id&quot; : 2,</span></span><br><span class="line"><span class="string">			&quot;name&quot; : &quot;192.168.24.105:27518&quot;,</span></span><br><span class="line"><span class="string">			&quot;health&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;state&quot; : 7,</span></span><br><span class="line"><span class="string">			&quot;stateStr&quot; : &quot;ARBITER&quot;,</span></span><br><span class="line"><span class="string">			&quot;uptime&quot; : 11,</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeat&quot; : ISODate(&quot;2022-04-02T15:12:58.706Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2022-04-02T15:12:58.771Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;pingMs&quot; : NumberLong(0),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncingTo&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceHost&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceId&quot; : -1,</span></span><br><span class="line"><span class="string">			&quot;infoMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;configVersion&quot; : 3</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	],</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$clusterTime&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;clusterTime&quot; : Timestamp(1648912368, 1),</span></span><br><span class="line"><span class="string">		&quot;signature&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span></span><br><span class="line"><span class="string">			&quot;keyId&quot; : NumberLong(0)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;operationTime&quot; : Timestamp(1648912368, 1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoshardrs02:PRIMARY&gt; exit</span></span><br><span class="line"><span class="string">bye</span></span><br><span class="line"><span class="string">[root@localhost ~]# </span></span><br></pre></td></tr></table></figure>

<h3 id="配置节点副本集的创建"><a href="#配置节点副本集的创建" class="headerlink" title="配置节点副本集的创建"></a>配置节点副本集的创建</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一步：准备存放数据和日志的目录：</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/log \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/data/db</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/log \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/data/db</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/log \ &amp; <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/data/db</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 4 root root 29 10月 21 19:44 shihanshuoconfigrs_27019</span><br><span class="line">drwxr-xr-x 4 root root 29 10月 21 19:44 shihanshuoconfigrs_27119</span><br><span class="line">drwxr-xr-x 4 root root 29 10月 21 19:44 shihanshuoconfigrs_27219</span><br><span class="line">drwxr-xr-x 4 root root 48 10月 21 19:36 shihanshuoshardrs01_27018</span><br><span class="line">drwxr-xr-x 4 root root 48 10月 21 19:40 shihanshuoshardrs01_27118</span><br><span class="line">drwxr-xr-x 4 root root 48 10月 21 19:40 shihanshuoshardrs01_27218</span><br><span class="line">drwxr-xr-x 4 root root 48 10月 21 19:43 shihanshuoshardrs02_27318</span><br><span class="line">drwxr-xr-x 4 root root 48 10月 21 19:43 shihanshuoshardrs02_27418</span><br><span class="line">drwxr-xr-x 4 root root 48 10月 21 19:44 shihanshuoshardrs02_27518</span><br><span class="line">[1]+  完成                  <span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/log \ </span><br><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 16 10月 21 19:44 data</span><br><span class="line">drwxr-xr-x 2 root root  6 10月 21 19:44 <span class="built_in">log</span></span><br><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 16 10月 21 19:44 data</span><br><span class="line">drwxr-xr-x 2 root root  6 10月 21 19:44 <span class="built_in">log</span></span><br><span class="line">[root@localhost mongodb]# ll /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 16 10月 21 19:44 data</span><br><span class="line">drwxr-xr-x 2 root root  6 10月 21 19:44 <span class="built_in">log</span></span><br><span class="line">[root@localhost mongodb]# </span><br></pre></td></tr></table></figure>


<h6 id="27019的配置文件"><a href="#27019的配置文件" class="headerlink" title="27019的配置文件"></a>27019的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新建或修改配置文件：</span></span><br><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/data/db&quot;</span></span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27019 </span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuoconfigrs </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#分片角色 </span></span><br><span class="line">  clusterRole: configsvr</span><br></pre></td></tr></table></figure>

<h6 id="27119的配置文件"><a href="#27119的配置文件" class="headerlink" title="27119的配置文件"></a>27119的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/data/db&quot;</span></span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27119 </span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuoconfigrs </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#分片角色 </span></span><br><span class="line">  clusterRole: configsvr</span><br></pre></td></tr></table></figure>

<h6 id="27219的配置文件"><a href="#27219的配置文件" class="headerlink" title="27219的配置文件"></a>27219的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">storage: </span><br><span class="line">  <span class="comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/data/db&quot;</span></span><br><span class="line">  journal: </span><br><span class="line">    <span class="comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27219 </span><br><span class="line">replication: </span><br><span class="line">  <span class="comment">#副本集的名称 </span></span><br><span class="line">  replSetName: shihanshuoconfigrs </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#分片角色 </span></span><br><span class="line">  clusterRole: configsvr</span><br></pre></td></tr></table></figure>

<h6 id="启动配置副本集"><a href="#启动配置副本集" class="headerlink" title="启动配置副本集"></a>启动配置副本集</h6><p>启动配置副本集：一主两副本<br>依次启动三个mongod服务，并查看服务是否启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8882</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8932</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8982</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# ps -ef | grep mongod</span><br><span class="line">root       7835      1  1 22:51 ?        00:00:08 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/mongod.conf</span><br><span class="line">root       7884      1  1 22:51 ?        00:00:08 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/mongod.conf</span><br><span class="line">root       7934      1  1 22:51 ?        00:00:08 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/mongod.conf</span><br><span class="line">root       8466      1  1 22:59 ?        00:00:03 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/mongod.conf</span><br><span class="line">root       8508      1  1 22:59 ?        00:00:04 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/mongod.conf</span><br><span class="line">root       8551      1  1 22:59 ?        00:00:04 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/mongod.conf</span><br><span class="line">root       8882      1  7 23:04 ?        00:00:01 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/mongod.conf</span><br><span class="line">root       8932      1 13 23:04 ?        00:00:01 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/mongod.conf</span><br><span class="line">root       8982      1 24 23:04 ?        00:00:01 mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/mongod.conf</span><br><span class="line">root       9032   7599  0 23:04 pts/0    00:00:00 grep --color=auto mongod</span><br><span class="line">[root@localhost ~]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="初始化配置节点副本集"><a href="#初始化配置节点副本集" class="headerlink" title="初始化配置节点副本集"></a>初始化配置节点副本集</h6><p>（1）初始化副本集和创建主节点：使用客户端命令连接任意一个节点，但这里尽量要连接主节点：<br><code>mongo --host=192.168.24.105 --port=27019</code><br>执行初始化副本集命令：<code>rs.initiate()</code><br>查看副本集情况：<code>rs.status()</code></p>
<p>（2）主节点配置查看：<code>rs.conf()</code></p>
<p>（3）添加2个副本节点：<code>rs.add(&quot;192.168.24.105:27119&quot;)</code>  <code>rs.add(&quot;192.168.24.105:27219&quot;)</code><br>查看副本集的配置情况：<code>rs.status()</code></p>
<p>代码过程如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongo --host=192.168.24.105 --port=27019</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://192.168.24.105:27019/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;1fbb4b8b-316f-48c1-aa8c-74e518713381&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-04-02T23:04:14.789+0800 I  CONTROL  [initandlisten] </span><br><span class="line">---</span><br><span class="line">Enable MongoDB<span class="string">&#x27;s free cloud-based monitoring service, which will then receive and display</span></span><br><span class="line"><span class="string">metrics about your deployment (disk utilization, CPU, operation statistics, etc).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The monitoring data will be available on a MongoDB website with a unique URL accessible to you</span></span><br><span class="line"><span class="string">and anyone you share the URL with. MongoDB may use this information to make product</span></span><br><span class="line"><span class="string">improvements and to suggest MongoDB products and deployment options to you.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To enable free monitoring, run the following command: db.enableFreeMonitoring()</span></span><br><span class="line"><span class="string">To permanently disable this reminder, run the following command: db.disableFreeMonitoring()</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt; rs.initiate()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;info2&quot; : &quot;no configuration specified. Using a default configuration for the set&quot;,</span></span><br><span class="line"><span class="string">	&quot;me&quot; : &quot;192.168.24.105:27019&quot;,</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$gleStats&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastOpTime&quot; : Timestamp(1648912625, 1),</span></span><br><span class="line"><span class="string">		&quot;electionId&quot; : ObjectId(&quot;000000000000000000000000&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;lastCommittedOpTime&quot; : Timestamp(0, 0)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoconfigrs:OTHER&gt; </span></span><br><span class="line"><span class="string">shihanshuoconfigrs:PRIMARY&gt; rs.add(&quot;192.168.24.105:27119&quot;)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$gleStats&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912664, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;lastCommittedOpTime&quot; : Timestamp(1648912656, 1),</span></span><br><span class="line"><span class="string">	&quot;$clusterTime&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;clusterTime&quot; : Timestamp(1648912664, 1),</span></span><br><span class="line"><span class="string">		&quot;signature&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span></span><br><span class="line"><span class="string">			&quot;keyId&quot; : NumberLong(0)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;operationTime&quot; : Timestamp(1648912664, 1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoconfigrs:PRIMARY&gt; rs.add(&quot;192.168.24.105:27219&quot;)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$gleStats&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;lastCommittedOpTime&quot; : Timestamp(1648912664, 2),</span></span><br><span class="line"><span class="string">	&quot;$clusterTime&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;clusterTime&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">		&quot;signature&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span></span><br><span class="line"><span class="string">			&quot;keyId&quot; : NumberLong(0)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;operationTime&quot; : Timestamp(1648912676, 2)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoconfigrs:PRIMARY&gt; rs.status()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;set&quot; : &quot;shihanshuoconfigrs&quot;,</span></span><br><span class="line"><span class="string">	&quot;date&quot; : ISODate(&quot;2022-04-02T15:18:11.941Z&quot;),</span></span><br><span class="line"><span class="string">	&quot;myState&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;term&quot; : NumberLong(1),</span></span><br><span class="line"><span class="string">	&quot;syncingTo&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">	&quot;syncSourceHost&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">	&quot;syncSourceId&quot; : -1,</span></span><br><span class="line"><span class="string">	&quot;configsvr&quot; : true,</span></span><br><span class="line"><span class="string">	&quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span></span><br><span class="line"><span class="string">	&quot;majorityVoteCount&quot; : 2,</span></span><br><span class="line"><span class="string">	&quot;writeMajorityCount&quot; : 2,</span></span><br><span class="line"><span class="string">	&quot;optimes&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastCommittedOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;lastCommittedWallTime&quot; : ISODate(&quot;2022-04-02T15:17:56.999Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;readConcernMajorityOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;readConcernMajorityWallTime&quot; : ISODate(&quot;2022-04-02T15:17:56.999Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;appliedOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;durableOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;lastAppliedWallTime&quot; : ISODate(&quot;2022-04-02T15:17:56.999Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;lastDurableWallTime&quot; : ISODate(&quot;2022-04-02T15:17:56.999Z&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;lastStableRecoveryTimestamp&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">	&quot;lastStableCheckpointTimestamp&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">	&quot;electionCandidateMetrics&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastElectionReason&quot; : &quot;electionTimeout&quot;,</span></span><br><span class="line"><span class="string">		&quot;lastElectionDate&quot; : ISODate(&quot;2022-04-02T15:17:05.681Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;electionTerm&quot; : NumberLong(1),</span></span><br><span class="line"><span class="string">		&quot;lastCommittedOpTimeAtElection&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(0, 0),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(-1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;lastSeenOpTimeAtElection&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912625, 1),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(-1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;numVotesNeeded&quot; : 1,</span></span><br><span class="line"><span class="string">		&quot;priorityAtElection&quot; : 1,</span></span><br><span class="line"><span class="string">		&quot;electionTimeoutMillis&quot; : NumberLong(10000),</span></span><br><span class="line"><span class="string">		&quot;newTermStartDate&quot; : ISODate(&quot;2022-04-02T15:17:05.941Z&quot;),</span></span><br><span class="line"><span class="string">		&quot;wMajorityWriteAvailabilityDate&quot; : ISODate(&quot;2022-04-02T15:17:06.450Z&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;members&quot; : [</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			&quot;_id&quot; : 0,</span></span><br><span class="line"><span class="string">			&quot;name&quot; : &quot;192.168.24.105:27019&quot;,</span></span><br><span class="line"><span class="string">			&quot;health&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;state&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;stateStr&quot; : &quot;PRIMARY&quot;,</span></span><br><span class="line"><span class="string">			&quot;uptime&quot; : 838,</span></span><br><span class="line"><span class="string">			&quot;optime&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDate&quot; : ISODate(&quot;2022-04-02T15:17:56Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;syncingTo&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceHost&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceId&quot; : -1,</span></span><br><span class="line"><span class="string">			&quot;infoMessage&quot; : &quot;could not find member to sync from&quot;,</span></span><br><span class="line"><span class="string">			&quot;electionTime&quot; : Timestamp(1648912625, 2),</span></span><br><span class="line"><span class="string">			&quot;electionDate&quot; : ISODate(&quot;2022-04-02T15:17:05Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;configVersion&quot; : 3,</span></span><br><span class="line"><span class="string">			&quot;self&quot; : true,</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			&quot;_id&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;name&quot; : &quot;192.168.24.105:27119&quot;,</span></span><br><span class="line"><span class="string">			&quot;health&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;state&quot; : 2,</span></span><br><span class="line"><span class="string">			&quot;stateStr&quot; : &quot;SECONDARY&quot;,</span></span><br><span class="line"><span class="string">			&quot;uptime&quot; : 27,</span></span><br><span class="line"><span class="string">			&quot;optime&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDurable&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDate&quot; : ISODate(&quot;2022-04-02T15:17:56Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;optimeDurableDate&quot; : ISODate(&quot;2022-04-02T15:17:56Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeat&quot; : ISODate(&quot;2022-04-02T15:18:11.052Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2022-04-02T15:18:10.126Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;pingMs&quot; : NumberLong(0),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncingTo&quot; : &quot;192.168.24.105:27019&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceHost&quot; : &quot;192.168.24.105:27019&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceId&quot; : 0,</span></span><br><span class="line"><span class="string">			&quot;infoMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;configVersion&quot; : 3</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			&quot;_id&quot; : 2,</span></span><br><span class="line"><span class="string">			&quot;name&quot; : &quot;192.168.24.105:27219&quot;,</span></span><br><span class="line"><span class="string">			&quot;health&quot; : 1,</span></span><br><span class="line"><span class="string">			&quot;state&quot; : 2,</span></span><br><span class="line"><span class="string">			&quot;stateStr&quot; : &quot;SECONDARY&quot;,</span></span><br><span class="line"><span class="string">			&quot;uptime&quot; : 14,</span></span><br><span class="line"><span class="string">			&quot;optime&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDurable&quot; : &#123;</span></span><br><span class="line"><span class="string">				&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">				&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;optimeDate&quot; : ISODate(&quot;2022-04-02T15:17:56Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;optimeDurableDate&quot; : ISODate(&quot;2022-04-02T15:17:56Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeat&quot; : ISODate(&quot;2022-04-02T15:18:11.053Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2022-04-02T15:18:11.889Z&quot;),</span></span><br><span class="line"><span class="string">			&quot;pingMs&quot; : NumberLong(0),</span></span><br><span class="line"><span class="string">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncingTo&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceHost&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;syncSourceId&quot; : -1,</span></span><br><span class="line"><span class="string">			&quot;infoMessage&quot; : &quot;&quot;,</span></span><br><span class="line"><span class="string">			&quot;configVersion&quot; : 3</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	],</span></span><br><span class="line"><span class="string">	&quot;ok&quot; : 1,</span></span><br><span class="line"><span class="string">	&quot;$gleStats&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;lastOpTime&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;ts&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">			&quot;t&quot; : NumberLong(1)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		&quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;)</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;lastCommittedOpTime&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">	&quot;$clusterTime&quot; : &#123;</span></span><br><span class="line"><span class="string">		&quot;clusterTime&quot; : Timestamp(1648912676, 2),</span></span><br><span class="line"><span class="string">		&quot;signature&quot; : &#123;</span></span><br><span class="line"><span class="string">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span></span><br><span class="line"><span class="string">			&quot;keyId&quot; : NumberLong(0)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;operationTime&quot; : Timestamp(1648912676, 2)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">shihanshuoconfigrs:PRIMARY&gt; exit</span></span><br><span class="line"><span class="string">bye</span></span><br><span class="line"><span class="string">[root@localhost ~]# </span></span><br></pre></td></tr></table></figure>

<h4 id="路由节点的创建和操作"><a href="#路由节点的创建和操作" class="headerlink" title="路由节点的创建和操作"></a>路由节点的创建和操作</h4><h5 id="1-第一套路由节点的创建和操作"><a href="#1-第一套路由节点的创建和操作" class="headerlink" title="1.第一套路由节点的创建和操作"></a>1.第一套路由节点的创建和操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一步：准备存放数据和日志的目录：</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27017/log</span><br></pre></td></tr></table></figure>

<p>路由节点的作用主要是分发，它 不需要存储具体的数据，因此不需要data目录。</p>
<h6 id="27017的配置文件"><a href="#27017的配置文件" class="headerlink" title="27017的配置文件"></a>27017的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shihanshuomongos_27017节点：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#新建或修改配置文件：</span></span><br><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27017/mongos.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27017/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27017/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27017 </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#指定配置节点副本集</span></span><br><span class="line">  configDB: shihanshuoconfigrs/192.168.24.105:27019,192.168.24.105:27119,192.168.24.105:27219</span><br></pre></td></tr></table></figure>

<h6 id="启动第一个路由mongos"><a href="#启动第一个路由mongos" class="headerlink" title="启动第一个路由mongos"></a>启动第一个路由mongos</h6><p>提示：启动如果失败，可以查看log目录下的日志，查看失败原因。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongos -f /opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27017/mongos.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 10482</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>

<p>客户端登录mongos，此时，写不进去数据，如果写数据会报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongo --host=192.168.24.105 --port=27017</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://192.168.24.105:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;5bd001ce-16ba-464b-993b-9cbd6fbcddaf&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-04-02T23:24:19.966+0800 I  CONTROL  [main] </span><br><span class="line">2022-04-02T23:24:19.966+0800 I  CONTROL  [main] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-04-02T23:24:19.966+0800 I  CONTROL  [main] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-04-02T23:24:19.966+0800 I  CONTROL  [main] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-04-02T23:24:19.966+0800 I  CONTROL  [main] </span><br><span class="line">mongos&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">mongos&gt; use shihanshuo</span><br><span class="line">switched to db shihanshuo</span><br><span class="line">mongos&gt; </span><br><span class="line">mongos&gt; db.shi.insert(&#123;shi:<span class="string">&quot;hanshuo&quot;</span>&#125;)</span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 0,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;unable to initialize targeter for write op for collection shihanshuo.aa :: caused by :: Database shihanshuo could not be created :: caused by :: No shards found&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : 70,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;ShardNotFound&quot;</span>,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1648913224, 2),</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1648913224, 2),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line">mongos&gt; </span><br></pre></td></tr></table></figure>

<p>原因：通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点（<code>caused by :: No shards found</code>），因此无法写入业务数据。</p>
<p>properties配置文件参考：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">logpath=/mongodb/sharded_cluster/shihanshuomongos_27017/log/mongos.log </span><br><span class="line">logappend=<span class="literal">true</span> </span><br><span class="line">bind_ip_all=<span class="literal">true</span> </span><br><span class="line">port=27017 </span><br><span class="line">fork=<span class="literal">true</span> </span><br><span class="line">configdb=shihanshuoconfigrs/192.168.24.105:27019,192.168.24.105:27119,192.168.24.105:27219</span><br></pre></td></tr></table></figure>

<h5 id="2-在路由节点上进行分片配置操作"><a href="#2-在路由节点上进行分片配置操作" class="headerlink" title="2.在路由节点上进行分片配置操作"></a>2.在路由节点上进行分片配置操作</h5><p>使用命令添加分片：</p>
<h6 id="（1）添加分片"><a href="#（1）添加分片" class="headerlink" title="（1）添加分片"></a>（1）添加分片</h6><p>将第一套分片副本集添加进来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.addShard(<span class="string">&quot;shihanshuoshardrs01/192.168.24.105:27018,192.168.24.105:27118,192.168.24.105:27218&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;shardAdded&quot;</span> : <span class="string">&quot;shihanshuoshardrs01&quot;</span>,</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1648913541, 6),</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1648913541, 6),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">mongos&gt; </span><br></pre></td></tr></table></figure>

<p>查看分片状态情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">  	<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">  	<span class="string">&quot;minCompatibleVersion&quot;</span> : 5,</span><br><span class="line">  	<span class="string">&quot;currentVersion&quot;</span> : 6,</span><br><span class="line">  	<span class="string">&quot;clusterId&quot;</span> : ObjectId(<span class="string">&quot;624868f214f17e4ba54f23da&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs01&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs01/192.168.24.105:27018,192.168.24.105:27118&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        <span class="string">&quot;4.2.18&quot;</span> : 1</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: <span class="built_in">yes</span></span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  <span class="built_in">yes</span></span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds <span class="keyword">in</span> last 5 attempts:  0</span><br><span class="line">        Migration Results <span class="keyword">for</span> the last 24 hours: </span><br><span class="line">                No recent migrations</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line">mongos&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>继续将第二套分片副本集添加进来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.addShard(<span class="string">&quot;shihanshuoshardrs02/192.168.24.105:27318,192.168.24.105:27418,192.168.24.105:27518&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;shardAdded&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1648913689, 5),</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1648913689, 5),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看分片状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">  	<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">  	<span class="string">&quot;minCompatibleVersion&quot;</span> : 5,</span><br><span class="line">  	<span class="string">&quot;currentVersion&quot;</span> : 6,</span><br><span class="line">  	<span class="string">&quot;clusterId&quot;</span> : ObjectId(<span class="string">&quot;624868f214f17e4ba54f23da&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs01&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs01/192.168.24.105:27018,192.168.24.105:27118&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs02/192.168.24.105:27318,192.168.24.105:27418&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        <span class="string">&quot;4.2.18&quot;</span> : 1</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: <span class="built_in">yes</span></span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  <span class="built_in">yes</span></span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds <span class="keyword">in</span> last 5 attempts:  0</span><br><span class="line">        Migration Results <span class="keyword">for</span> the last 24 hours: </span><br><span class="line">                4 : Success</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span> &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;_id&quot;</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs01	1020</span><br><span class="line">                                shihanshuoshardrs02	4</span><br><span class="line">                        too many chunks to <span class="built_in">print</span>, use verbose <span class="keyword">if</span> you want to force <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">mongos&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>提示：如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片。</p>
<p>移除分片参考(了解)： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use admin </span><br><span class="line">db.runCommand( &#123; removeShard: <span class="string">&quot;shihanshuoshardrs02&quot;</span> &#125; )</span><br></pre></td></tr></table></figure>

<p>注意：如果只剩下最后一个shard，是无法删除的移除时会自动转移分片数据，需要一个时间过程。</p>
<p>完成后，再次执行删除分片命令才能真正删除。</p>
<h6 id="（2）开启分片功能"><a href="#（2）开启分片功能" class="headerlink" title="（2）开启分片功能"></a>（2）开启分片功能</h6><p>添加分片之后，还需要初始化才可以使用。（即在某一个库中开启分片功能）</p>
<p><code>sh.enableSharding(&quot;库名&quot;)</code>    <code>sh.shardCollection(&quot;库名.集合名&quot;,&#123;&quot;key&quot;:1&#125;)</code></p>
<p>在mongos上的articledb数据库配置sharding:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.enableSharding(<span class="string">&quot;articledb&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1648914039, 11),</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1648914039, 12),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">mongos&gt;</span><br></pre></td></tr></table></figure>

<p>查看分片状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">  	<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">  	<span class="string">&quot;minCompatibleVersion&quot;</span> : 5,</span><br><span class="line">  	<span class="string">&quot;currentVersion&quot;</span> : 6,</span><br><span class="line">  	<span class="string">&quot;clusterId&quot;</span> : ObjectId(<span class="string">&quot;624868f214f17e4ba54f23da&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs01&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs01/192.168.24.105:27018,192.168.24.105:27118&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs02/192.168.24.105:27318,192.168.24.105:27418&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        <span class="string">&quot;4.2.18&quot;</span> : 1</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: <span class="built_in">yes</span></span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  <span class="built_in">yes</span></span><br><span class="line">        Currently running:  <span class="built_in">yes</span></span><br><span class="line">        Collections with active migrations: </span><br><span class="line">                config.system.sessions started at Sat Apr 02 2022 23:42:03 GMT+0800 (CST)</span><br><span class="line">        Failed balancer rounds <span class="keyword">in</span> last 5 attempts:  0</span><br><span class="line">        Migration Results <span class="keyword">for</span> the last 24 hours: </span><br><span class="line">                347 : Success</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;articledb&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span>,  <span class="string">&quot;version&quot;</span> : &#123;  <span class="string">&quot;uuid&quot;</span> : UUID(<span class="string">&quot;c5a85211-06ac-46e4-bd29-47758191f460&quot;</span>),  <span class="string">&quot;lastMod&quot;</span> : 1 &#125; &#125;</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span> &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;_id&quot;</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs01	676</span><br><span class="line">                                shihanshuoshardrs02	348</span><br><span class="line">                        too many chunks to <span class="built_in">print</span>, use verbose <span class="keyword">if</span> you want to force <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">mongos&gt; </span><br></pre></td></tr></table></figure>

<h6 id="（3）集合分片"><a href="#（3）集合分片" class="headerlink" title="（3）集合分片"></a>（3）集合分片</h6><p>对集合分片，你必须使用 sh.shardCollection() 方法指定集合和分片键。</p>
<p><code>sh.shardCollection(namespace, key, unique)</code> </p>
<p>对集合进行分片时,你需要选择一个 片键（Shard Key） , shard key 是每条记录都必须包含的,且建立了索引的单个字段或复合字段，MongoDB按照片键将数据划分到不同的 数据块中,并将 数据块均衡地分布到所有分片中.为了按照片键划分数据块,MongoDB使用 基于哈希的分片方式（随机平均分配）或者基于范围的分片方式（数值大小分配）。</p>
<p>用什么字段当片键都可以，如：nickname作为片键，但一定是必填字段。</p>
<h6 id="分片规则一：哈希策略"><a href="#分片规则一：哈希策略" class="headerlink" title="分片规则一：哈希策略"></a>分片规则一：哈希策略</h6><p>对于 基于哈希的分片 ,MongoDB计算一个字段的哈希值,并用这个哈希值来创建数据块.</p>
<p>在使用基于哈希分片的系统中,拥有”相近”分片键的文档很可能不会存储在同一个数据块中,因此数据的分离性更好一些.</p>
<p>先开启库的分片功能，再开启分片规则，最后查看分片状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先开启articledb库的分片功能</span></span><br><span class="line">mongos&gt; sh.enableSharding(<span class="string">&quot;articledb&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1648914317, 10),</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1648914317, 17),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用nickname作为片键，根据其值的哈希值进行数据分片</span></span><br><span class="line">mongos&gt; sh.shardCollection(<span class="string">&quot;articledb.comment&quot;</span>,&#123;<span class="string">&quot;nickname&quot;</span>:<span class="string">&quot;hashed&quot;</span>&#125;)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;collectionsharded&quot;</span> : <span class="string">&quot;articledb.comment&quot;</span>,</span><br><span class="line">	<span class="string">&quot;collectionUUID&quot;</span> : UUID(<span class="string">&quot;d9e4283f-fa83-48d4-9dac-ea30a05c8356&quot;</span>),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1648914330, 28),</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1648914330, 28),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分片状态</span></span><br><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">  	<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">  	<span class="string">&quot;minCompatibleVersion&quot;</span> : 5,</span><br><span class="line">  	<span class="string">&quot;currentVersion&quot;</span> : 6,</span><br><span class="line">  	<span class="string">&quot;clusterId&quot;</span> : ObjectId(<span class="string">&quot;624868f214f17e4ba54f23da&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs01&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs01/192.168.24.105:27018,192.168.24.105:27118&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs02/192.168.24.105:27318,192.168.24.105:27418&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        <span class="string">&quot;4.2.18&quot;</span> : 1</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: <span class="built_in">yes</span></span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  <span class="built_in">yes</span></span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds <span class="keyword">in</span> last 5 attempts:  0</span><br><span class="line">        Migration Results <span class="keyword">for</span> the last 24 hours: </span><br><span class="line">                512 : Success</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;articledb&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span>,  <span class="string">&quot;version&quot;</span> : &#123;  <span class="string">&quot;uuid&quot;</span> : UUID(<span class="string">&quot;c5a85211-06ac-46e4-bd29-47758191f460&quot;</span>),  <span class="string">&quot;lastMod&quot;</span> : 1 &#125; &#125;</span><br><span class="line">                articledb.comment</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;hashed&quot;</span> &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs01	2</span><br><span class="line">                                shihanshuoshardrs02	2</span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$minKey</span>&quot;</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;-4611686018427387902&quot;</span>) &#125; on : shihanshuoshardrs01 Timestamp(1, 0) </span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;-4611686018427387902&quot;</span>) &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(0) &#125; on : shihanshuoshardrs01 Timestamp(1, 1) </span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(0) &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;4611686018427387902&quot;</span>) &#125; on : shihanshuoshardrs02 Timestamp(1, 2) </span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;4611686018427387902&quot;</span>) &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$maxKey</span>&quot;</span> : 1 &#125; &#125; on : shihanshuoshardrs02 Timestamp(1, 3) </span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span> &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;_id&quot;</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs01	512</span><br><span class="line">                                shihanshuoshardrs02	512</span><br><span class="line">                        too many chunks to <span class="built_in">print</span>, use verbose <span class="keyword">if</span> you want to force <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">mongos&gt; </span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204022350211.png" alt="image-20220402235028892"></p>
<p>依据不同的规则放在分片1和分片2</p>
<h6 id="分片规则二：范围策略"><a href="#分片规则二：范围策略" class="headerlink" title="分片规则二：范围策略"></a>分片规则二：范围策略</h6><p>对于 基于范围的分片 ,MongoDB按照片键的范围把数据分成不同部分.假设有一个数字的片键:想象一个从负无穷到正无穷的直线,每一个片键的值都在直线上画了一个点.MongoDB把这条直线划分为更短的不重叠的片段,并称之为 数据块 ,每个数据块包含了片键在一定范围内的数据.</p>
<p>在使用片键做范围划分的系统中,拥有”相近”片键的文档很可能存储在同一个数据块中,因此也会存储在同一个分片中.</p>
<p>注意：mongodb只能根据集合当中的一个分片键执行分片规则，以此这里不能再次使用comment。使用新的集合author</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用作者年龄字段作为片键，按照点赞数的值进行分片：</span></span><br><span class="line">mongos&gt; sh.shardCollection(<span class="string">&quot;articledb.author&quot;</span>,&#123;<span class="string">&quot;age&quot;</span>:1&#125;)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;collectionsharded&quot;</span> : <span class="string">&quot;articledb.author&quot;</span>,</span><br><span class="line">	<span class="string">&quot;collectionUUID&quot;</span> : UUID(<span class="string">&quot;995c2443-16a2-4412-82e3-64b2c2b8aa28&quot;</span>),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(1648914908, 12),</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(1648914908, 12),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分片状态</span></span><br><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">  	<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">  	<span class="string">&quot;minCompatibleVersion&quot;</span> : 5,</span><br><span class="line">  	<span class="string">&quot;currentVersion&quot;</span> : 6,</span><br><span class="line">  	<span class="string">&quot;clusterId&quot;</span> : ObjectId(<span class="string">&quot;624868f214f17e4ba54f23da&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs01&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs01/192.168.24.105:27018,192.168.24.105:27118&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs02/192.168.24.105:27318,192.168.24.105:27418&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        <span class="string">&quot;4.2.18&quot;</span> : 1</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: <span class="built_in">yes</span></span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  <span class="built_in">yes</span></span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds <span class="keyword">in</span> last 5 attempts:  0</span><br><span class="line">        Migration Results <span class="keyword">for</span> the last 24 hours: </span><br><span class="line">                512 : Success</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;articledb&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span>,  <span class="string">&quot;version&quot;</span> : &#123;  <span class="string">&quot;uuid&quot;</span> : UUID(<span class="string">&quot;c5a85211-06ac-46e4-bd29-47758191f460&quot;</span>),  <span class="string">&quot;lastMod&quot;</span> : 1 &#125; &#125;</span><br><span class="line">                articledb.author</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;age&quot;</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs02	1</span><br><span class="line">                        &#123; <span class="string">&quot;age&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$minKey</span>&quot;</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">&quot;age&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$maxKey</span>&quot;</span> : 1 &#125; &#125; on : shihanshuoshardrs02 Timestamp(1, 0) </span><br><span class="line">                articledb.comment</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;hashed&quot;</span> &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs01	2</span><br><span class="line">                                shihanshuoshardrs02	2</span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$minKey</span>&quot;</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;-4611686018427387902&quot;</span>) &#125; on : shihanshuoshardrs01 Timestamp(1, 0) </span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;-4611686018427387902&quot;</span>) &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(0) &#125; on : shihanshuoshardrs01 Timestamp(1, 1) </span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(0) &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;4611686018427387902&quot;</span>) &#125; on : shihanshuoshardrs02 Timestamp(1, 2) </span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;4611686018427387902&quot;</span>) &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$maxKey</span>&quot;</span> : 1 &#125; &#125; on : shihanshuoshardrs02 Timestamp(1, 3) </span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span> &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;_id&quot;</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs01	512</span><br><span class="line">                                shihanshuoshardrs02	512</span><br><span class="line">                        too many chunks to <span class="built_in">print</span>, use verbose <span class="keyword">if</span> you want to force <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">mongos&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204022358184.png" alt="image-20220402235732517"></p>
<p>范围规则中，此实验环境中数据的存储会默认存放在shihanshuoshardrs02中，根据数据的大小（age索引）来进行自动的分片。</p>
<p>注意的是：</p>
<p>1）一个集合只能指定一个片键，否则报错。</p>
<p>2）一旦对一个集合分片，分片键和分片值就不可改变。 如：不能给集合选择不同的分片键、不能更新分片键的值。</p>
<p>3）根据age索引进行分配数据。</p>
<h6 id="基于范围的分片方式与基于哈希的分片方式性能对比："><a href="#基于范围的分片方式与基于哈希的分片方式性能对比：" class="headerlink" title="基于范围的分片方式与基于哈希的分片方式性能对比："></a>基于范围的分片方式与基于哈希的分片方式性能对比：</h6><p>基于范围的分片方式提供了更高效的范围查询,给定一个片键的范围,分发路由可以很简单地确定哪个数据块存储了请求需要的数据,并将请求转发到相应的分片中.</p>
<p>不过,基于范围的分片会导致数据在不同分片上的不均衡,有时候,带来的消极作用会大于查询性能的积极作用.比如,如果片键所在的字段是线性增长的,一定时间内的所有请求都会落到某个固定的数据块中,最终导致分布在同一个分片中.在这种情况下,一小部分分片承载了集群大部分的数据,系统并不能很好地进行扩展.</p>
<p>与此相比,基于哈希的分片方式以范围查询性能的损失为代价,保证了集群中数据的均衡.哈希值的随机性使数据随机分布在每个数据块中,因此也随机分布在不同分片中.但是也正由于随机性,一个范围查询很难确定应该请求哪些分片,通常为了返回需要的结果,需要请求所有分片.</p>
<p>如无特殊情况，一般推荐使用 Hash Sharding。而使用 _id 作为片键是一个不错的选择，因为它是必有的，你可以使用数据文档 _id 的哈希作为片键。</p>
<p>这个方案能够是的读和写都能够平均分布，并且它能够保证每个文档都有不同的片键所以数据块能够很精细。</p>
<p>似乎还是不够完美，因为这样的话对多个文档的查询必将命中所有的分片。虽说如此，这也是一种比较好的方案了。理想化的 shard key 可以让 documents 均匀地在集群中分布：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20220402210526742.png" alt="image-20220402210526742"></p>
<p>显示集群的详细信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.printShardingStatus()</span><br></pre></td></tr></table></figure>

<p>查看均衡器是否工作（需要重新均衡时系统才会自动启动，不用管它）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.isBalancerRunning()</span><br><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>查看当前Balancer状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.getBalancerState()</span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h5 id="3-分片后插入数据测试"><a href="#3-分片后插入数据测试" class="headerlink" title="3.分片后插入数据测试"></a>3.分片后插入数据测试</h5><h6 id="测试一（哈希规则）："><a href="#测试一（哈希规则）：" class="headerlink" title="测试一（哈希规则）："></a>测试一（哈希规则）：</h6><p>登录mongs后，向comment循环插入1000条数据做测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">mongos&gt; <span class="keyword">for</span>(var i=1;i&lt;=1000;i++)&#123;db.comment.insert(&#123;_id:i+<span class="string">&quot;&quot;</span>,nickname:<span class="string">&quot;BoBo&quot;</span>+i&#125;)&#125;</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : 1 &#125;)</span><br><span class="line">mongos&gt; show collections</span><br><span class="line">author</span><br><span class="line">comment</span><br><span class="line">mongos&gt; show dbs</span><br><span class="line">admin      0.000GB</span><br><span class="line">articledb  0.000GB</span><br><span class="line">config     0.003GB</span><br><span class="line">mongos&gt; db.comment.count()</span><br><span class="line">1000</span><br><span class="line">mongos&gt; </span><br></pre></td></tr></table></figure>

<p>提示：js的语法，因为mongo的shell是一个JavaScript的shell。</p>
<p>注意：从路由上插入的数据，必须包含片键，否则无法插入。</p>
<p>分别登陆两个片的主节点，统计文档数量</p>
<p>第一个分片副本集：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongo --host=192.168.24.105 --port=27018</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://192.168.24.105:27018/?</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">shihanshuoshardrs01:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuoshardrs01:PRIMARY&gt; db.comment.count()</span><br><span class="line">507</span><br><span class="line">shihanshuoshardrs01:PRIMARY&gt; </span><br></pre></td></tr></table></figure>

<p>第二个分片副本集：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongo --host=192.168.24.105 --port=27318</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://192.168.24.105:27318/?</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">shihanshuoshardrs02:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">shihanshuoshardrs02:PRIMARY&gt; db.comment.count()</span><br><span class="line">493</span><br><span class="line">shihanshuoshardrs02:PRIMARY&gt; </span><br></pre></td></tr></table></figure>

<p>可以看到，1000条数据近似均匀的分布到了2个shard上。是根据片键的哈希值分配的。</p>
<p>这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能。</p>
<p>使用db.comment.stats()查看单个集合的完整情况，mongos执行该命令可以查看该集合的数据分片的情况。</p>
<p>使用sh.status()查看本库内所有集合的分片信息。</p>
<h6 id="测试二（范围规则）："><a href="#测试二（范围规则）：" class="headerlink" title="测试二（范围规则）："></a>测试二（范围规则）：</h6><p>提示：</p>
<p>如果查看状态发现没有分片，则可能是由于以下原因造成了：</p>
<p>1）系统繁忙，正在分片中。</p>
<p>2）数据块（chunk）没有填满，默认的数据块尺寸（chunksize）是64M，填满后才会考虑向其他片的数据块填充数据，因此，<strong>为了测试，可以将其改小</strong>，这里改为1M，操作如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use config</span><br><span class="line">switched to db config</span><br><span class="line">mongos&gt; db.settings.save( &#123; _id:<span class="string">&quot;chunksize&quot;</span>, value: 1 &#125; )</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nMatched&quot;</span> : 0, <span class="string">&quot;nUpserted&quot;</span> : 1, <span class="string">&quot;nModified&quot;</span> : 0, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;chunksize&quot;</span> &#125;)</span><br><span class="line">mongos&gt; </span><br></pre></td></tr></table></figure>

<p>登录mongs后，向comment循环插入20000条数据做测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">mongos&gt; <span class="keyword">for</span>(var i=1;i&lt;=20000;i++)&#123;db.author.save(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo&quot;</span>+i,<span class="string">&quot;age&quot;</span>:NumberInt(i%120)&#125;)&#125;</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : 1 &#125;)</span><br><span class="line">mongos&gt; db.author.count()</span><br><span class="line">20118</span><br><span class="line">mongos&gt; db.author.remove(&#123;&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nRemoved&quot;</span> : 20118 &#125;)</span><br><span class="line">mongos&gt; db.author.count()</span><br><span class="line">0</span><br><span class="line">mongos&gt; <span class="keyword">for</span>(var i=1;i&lt;=20000;i++)&#123;db.author.save(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo&quot;</span>+i,<span class="string">&quot;age&quot;</span>:NumberInt(i%120)&#125;)&#125;</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : 1 &#125;)</span><br><span class="line">mongos&gt; db.author.count()</span><br><span class="line">20000</span><br><span class="line">mongos&gt;  </span><br></pre></td></tr></table></figure>

<p>插入失败：</p>
<p>1）不在articledb库中</p>
<p>2）集合中由其他数据 可以使用 <code>db.author.remove(&#123;&#125;)</code> 命令来情况当前集合中所有的文档</p>
<p>插入成功后，仍然要分别查看两个分片副本集的数据情况。</p>
<p>分片效果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看shihanshuoshardrs01中的数据</span></span><br><span class="line">shihanshuoshardrs01:PRIMARY&gt; db.author.count()</span><br><span class="line">166</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看shihanshuoshardrs02中的数据</span></span><br><span class="line">shihanshuoshardrs02:PRIMARY&gt; db.author.count()</span><br><span class="line">19834</span><br><span class="line">shihanshuoshardrs02:PRIMARY&gt; db.author.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c15&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo1&quot;</span>, <span class="string">&quot;age&quot;</span> : 1 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c16&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo2&quot;</span>, <span class="string">&quot;age&quot;</span> : 2 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c17&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo3&quot;</span>, <span class="string">&quot;age&quot;</span> : 3 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c18&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo4&quot;</span>, <span class="string">&quot;age&quot;</span> : 4 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c19&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo5&quot;</span>, <span class="string">&quot;age&quot;</span> : 5 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c1a&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo6&quot;</span>, <span class="string">&quot;age&quot;</span> : 6 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c1b&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo7&quot;</span>, <span class="string">&quot;age&quot;</span> : 7 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c1c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo8&quot;</span>, <span class="string">&quot;age&quot;</span> : 8 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c1d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo9&quot;</span>, <span class="string">&quot;age&quot;</span> : 9 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c1e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo10&quot;</span>, <span class="string">&quot;age&quot;</span> : 10 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c1f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo11&quot;</span>, <span class="string">&quot;age&quot;</span> : 11 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c20&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo12&quot;</span>, <span class="string">&quot;age&quot;</span> : 12 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c21&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo13&quot;</span>, <span class="string">&quot;age&quot;</span> : 13 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c22&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo14&quot;</span>, <span class="string">&quot;age&quot;</span> : 14 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c23&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo15&quot;</span>, <span class="string">&quot;age&quot;</span> : 15 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c24&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo16&quot;</span>, <span class="string">&quot;age&quot;</span> : 16 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c25&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo17&quot;</span>, <span class="string">&quot;age&quot;</span> : 17 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c26&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo18&quot;</span>, <span class="string">&quot;age&quot;</span> : 18 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c27&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo19&quot;</span>, <span class="string">&quot;age&quot;</span> : 19 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c28&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo20&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br><span class="line">Type <span class="string">&quot;it&quot;</span> <span class="keyword">for</span> more</span><br><span class="line">shihanshuoshardrs02:PRIMARY&gt; it</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c29&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo21&quot;</span>, <span class="string">&quot;age&quot;</span> : 21 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c2a&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo22&quot;</span>, <span class="string">&quot;age&quot;</span> : 22 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c2b&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo23&quot;</span>, <span class="string">&quot;age&quot;</span> : 23 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c2c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo24&quot;</span>, <span class="string">&quot;age&quot;</span> : 24 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c2d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo25&quot;</span>, <span class="string">&quot;age&quot;</span> : 25 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c2e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo26&quot;</span>, <span class="string">&quot;age&quot;</span> : 26 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c2f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo27&quot;</span>, <span class="string">&quot;age&quot;</span> : 27 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c30&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo28&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c31&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo29&quot;</span>, <span class="string">&quot;age&quot;</span> : 29 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c32&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo30&quot;</span>, <span class="string">&quot;age&quot;</span> : 30 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c33&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo31&quot;</span>, <span class="string">&quot;age&quot;</span> : 31 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c34&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo32&quot;</span>, <span class="string">&quot;age&quot;</span> : 32 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c35&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo33&quot;</span>, <span class="string">&quot;age&quot;</span> : 33 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c36&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo34&quot;</span>, <span class="string">&quot;age&quot;</span> : 34 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c37&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo35&quot;</span>, <span class="string">&quot;age&quot;</span> : 35 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c38&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo36&quot;</span>, <span class="string">&quot;age&quot;</span> : 36 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c39&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo37&quot;</span>, <span class="string">&quot;age&quot;</span> : 37 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c3a&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo38&quot;</span>, <span class="string">&quot;age&quot;</span> : 38 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c3b&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo39&quot;</span>, <span class="string">&quot;age&quot;</span> : 39 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6248785b60db80fa633b9c3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo40&quot;</span>, <span class="string">&quot;age&quot;</span> : 40 &#125;</span><br><span class="line">Type <span class="string">&quot;it&quot;</span> <span class="keyword">for</span> more</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试完改回来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use config</span><br><span class="line">switched to db config</span><br><span class="line">mongos&gt; db.settings.save( &#123; _id:<span class="string">&quot;chunksize&quot;</span>, value: 64 &#125; )</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nMatched&quot;</span> : 1, <span class="string">&quot;nUpserted&quot;</span> : 0, <span class="string">&quot;nModified&quot;</span> : 1 &#125;)</span><br><span class="line">mongos&gt; </span><br></pre></td></tr></table></figure>

<p>注意：要先改小，再设置分片。测试过程中操作不当引起的错误，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可。</p>
<h5 id="4-再增加一个路由节点"><a href="#4-再增加一个路由节点" class="headerlink" title="4.再增加一个路由节点"></a>4.再增加一个路由节点</h5><h6 id="第二套路由节点的创建和操作"><a href="#第二套路由节点的创建和操作" class="headerlink" title="第二套路由节点的创建和操作"></a>第二套路由节点的创建和操作</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一步：准备存放数据和日志的目录：</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27117/log</span><br></pre></td></tr></table></figure>

<h6 id="27117的配置文件"><a href="#27117的配置文件" class="headerlink" title="27117的配置文件"></a>27117的配置文件</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shihanshuomongos_27117节点：</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建或修改配置文件：</span></span><br><span class="line">vi /opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27117/mongos.conf</span><br><span class="line"></span><br><span class="line">systemLog: </span><br><span class="line">  <span class="comment">#MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line">  <span class="comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27117/log/mongod.log&quot;</span></span><br><span class="line">  <span class="comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">processManagement: </span><br><span class="line">  <span class="comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID </span></span><br><span class="line">  pidFilePath: <span class="string">&quot;/opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27117/log/mongod.pid&quot;</span> </span><br><span class="line">net:</span><br><span class="line">  <span class="comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip </span></span><br><span class="line">  <span class="comment">#bindIpAll: true </span></span><br><span class="line">  <span class="comment">#服务实例绑定的IP </span></span><br><span class="line">  bindIp: localhost,192.168.24.105 </span><br><span class="line">  <span class="comment">#bindIp </span></span><br><span class="line">  <span class="comment">#绑定的端口 </span></span><br><span class="line">  port: 27117 </span><br><span class="line">sharding: </span><br><span class="line">  <span class="comment">#指定配置节点副本集</span></span><br><span class="line">  configDB: shihanshuoconfigrs/192.168.24.105:27019,192.168.24.105:27119,192.168.24.105:27219</span><br></pre></td></tr></table></figure>

<h6 id="启动第二个路由mongos"><a href="#启动第二个路由mongos" class="headerlink" title="启动第二个路由mongos"></a>启动第二个路由mongos</h6><p>提示：启动如果失败，可以查看log目录下的日志，查看失败原因。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongos -f /opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27117/mongos.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 16986</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>

<p>客户端登录mongos 2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongo --host=192.168.24.105 --port=27117</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://192.168.24.105:27117/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;2a6d91dd-aa04-457f-b1af-7190386fceff&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-04-03T00:35:33.115+0800 I  CONTROL  [main] </span><br><span class="line">2022-04-03T00:35:33.115+0800 I  CONTROL  [main] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-04-03T00:35:33.115+0800 I  CONTROL  [main] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-04-03T00:35:33.115+0800 I  CONTROL  [main] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-04-03T00:35:33.115+0800 I  CONTROL  [main] </span><br><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">  	<span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line">  	<span class="string">&quot;minCompatibleVersion&quot;</span> : 5,</span><br><span class="line">  	<span class="string">&quot;currentVersion&quot;</span> : 6,</span><br><span class="line">  	<span class="string">&quot;clusterId&quot;</span> : ObjectId(<span class="string">&quot;624868f214f17e4ba54f23da&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs01&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs01/192.168.24.105:27018,192.168.24.105:27118&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,  <span class="string">&quot;host&quot;</span> : <span class="string">&quot;shihanshuoshardrs02/192.168.24.105:27318,192.168.24.105:27418&quot;</span>,  <span class="string">&quot;state&quot;</span> : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        <span class="string">&quot;4.2.18&quot;</span> : 2</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: <span class="built_in">yes</span></span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  <span class="built_in">yes</span></span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds <span class="keyword">in</span> last 5 attempts:  0</span><br><span class="line">        Migration Results <span class="keyword">for</span> the last 24 hours: </span><br><span class="line">                514 : Success</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;articledb&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;shihanshuoshardrs02&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span>,  <span class="string">&quot;version&quot;</span> : &#123;  <span class="string">&quot;uuid&quot;</span> : UUID(<span class="string">&quot;c5a85211-06ac-46e4-bd29-47758191f460&quot;</span>),  <span class="string">&quot;lastMod&quot;</span> : 1 &#125; &#125;</span><br><span class="line">                articledb.author</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;age&quot;</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs01	2</span><br><span class="line">                                shihanshuoshardrs02	2</span><br><span class="line">                        &#123; <span class="string">&quot;age&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$minKey</span>&quot;</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">&quot;age&quot;</span> : 0 &#125; on : shihanshuoshardrs01 Timestamp(2, 0) </span><br><span class="line">                        &#123; <span class="string">&quot;age&quot;</span> : 0 &#125; --&gt;&gt; &#123; <span class="string">&quot;age&quot;</span> : 59 &#125; on : shihanshuoshardrs02 Timestamp(3, 2) </span><br><span class="line">                        &#123; <span class="string">&quot;age&quot;</span> : 59 &#125; --&gt;&gt; &#123; <span class="string">&quot;age&quot;</span> : 119 &#125; on : shihanshuoshardrs02 Timestamp(3, 3) </span><br><span class="line">                        &#123; <span class="string">&quot;age&quot;</span> : 119 &#125; --&gt;&gt; &#123; <span class="string">&quot;age&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$maxKey</span>&quot;</span> : 1 &#125; &#125; on : shihanshuoshardrs01 Timestamp(3, 0) </span><br><span class="line">                articledb.comment</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;nickname&quot;</span> : <span class="string">&quot;hashed&quot;</span> &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs01	2</span><br><span class="line">                                shihanshuoshardrs02	2</span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$minKey</span>&quot;</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;-4611686018427387902&quot;</span>) &#125; on : shihanshuoshardrs01 Timestamp(1, 0) </span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;-4611686018427387902&quot;</span>) &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(0) &#125; on : shihanshuoshardrs01 Timestamp(1, 1) </span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(0) &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;4611686018427387902&quot;</span>) &#125; on : shihanshuoshardrs02 Timestamp(1, 2) </span><br><span class="line">                        &#123; <span class="string">&quot;nickname&quot;</span> : NumberLong(<span class="string">&quot;4611686018427387902&quot;</span>) &#125; --&gt;&gt; &#123; <span class="string">&quot;nickname&quot;</span> : &#123; <span class="string">&quot;<span class="variable">$maxKey</span>&quot;</span> : 1 &#125; &#125; on : shihanshuoshardrs02 Timestamp(1, 3) </span><br><span class="line">        &#123;  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;primary&quot;</span> : <span class="string">&quot;config&quot;</span>,  <span class="string">&quot;partitioned&quot;</span> : <span class="literal">true</span> &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; <span class="string">&quot;_id&quot;</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shihanshuoshardrs01	512</span><br><span class="line">                                shihanshuoshardrs02	512</span><br><span class="line">                        too many chunks to <span class="built_in">print</span>, use verbose <span class="keyword">if</span> you want to force <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">mongos&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用mongo客户端登录27117，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了。</p>
<h4 id="可视化工具连接"><a href="#可视化工具连接" class="headerlink" title="可视化工具连接"></a>可视化工具连接</h4><p>直接连接到路由节点即可。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204030047637.png" alt="image-20220403004727183"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204030053260.png" alt="image-20220403005347704"></p>
<h4 id="SpringDataMongoDB连接分片集群"><a href="#SpringDataMongoDB连接分片集群" class="headerlink" title="SpringDataMongoDB连接分片集群"></a>SpringDataMongoDB连接分片集群</h4><h5 id="1-启动mongod和mongos服务"><a href="#1-启动mongod和mongos服务" class="headerlink" title="1.启动mongod和mongos服务"></a>1.启动mongod和mongos服务</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动shihanshuoshardrs01副本集：一主一副本一仲裁</span></span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27018/mongod.conf</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27118/mongod.conf</span><br><span class="line"></span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs01_27218/mongod.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动shihanshuoshardrs02副本集：一主一副本一仲裁</span></span><br><span class="line">root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27318/mongod.conf</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27418/mongod.conf</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoshardrs02_27518/mongod.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动配置节点shihanshuoconfigrs副本集：一主两副本</span></span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27019/mongod.conf</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27119/mongod.conf</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mongod -f /opt/module/mongodb/sharded_shihanshuo/shihanshuoconfigrs_27219/mongod.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动2个路由节点shihanshuomongos</span></span><br><span class="line">[root@localhost ~]# mongos -f /opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27017/mongos.conf</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mongos -f /opt/module/mongodb/sharded_shihanshuo/shihanshuomongos_27117/mongos.conf</span><br></pre></td></tr></table></figure>

<h4 id="2-启动idea项目"><a href="#2-启动idea项目" class="headerlink" title="2.启动idea项目"></a>2.启动idea项目</h4><p>打开idea项目中的<code>application.yml</code>文件，改写一下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  #数据源配置</span><br><span class="line">  data:</span><br><span class="line">    mongodb:</span><br><span class="line"></span><br><span class="line">      # 主机地址</span><br><span class="line">      host: <span class="number">192.168</span><span class="number">.24</span><span class="number">.105</span></span><br><span class="line">      # 数据库</span><br><span class="line">      database: articledb</span><br><span class="line">      # 默认端口是<span class="number">27017</span></span><br><span class="line">      port: <span class="number">27017</span></span><br><span class="line">      #也可以使用uri连接</span><br><span class="line">      #uri: mongodb:<span class="comment">//192.168.24.105:27017/articledb</span></span><br><span class="line"></span><br><span class="line">      #连接路由字符串</span><br><span class="line">      uri: mongodb:<span class="comment">//192.168.24.105:27017,192.168.24.105:27117/articledb</span></span><br></pre></td></tr></table></figure>

<p>打开测试类文件<code>CommentServiceTest.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204030113656.png" alt="image-20220403011301271"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204041104009.png" alt="image-20220404110423666"></p>
<h3 id="mongod-无法启动"><a href="#mongod-无法启动" class="headerlink" title="mongod 无法启动"></a>mongod 无法启动</h3><p>warning：千万不能使用kill -9 <pid>,因为MongoDB使用mmap方式进行数据文件管理，也就是说写操作基本是在内存中进行，写操作会被每隔60秒(syncdelay设定)的flush到磁盘里。如果在这60秒内flush处于停止事情我们进行kill -9那么从上次flush之后的写入数据将会全部丢失。<br>如果在flush操作进行时执行kill -9则会造成文件混乱，可能导致数据全丢了，启动时加了repair也无法恢复。</p>
<h4 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//删除db目录里面的/mongod.lock ，否则下面的命令是运行不成功的</span><br><span class="line"><span class="built_in">rm</span> -rf db目录//mongod.lock</span><br><span class="line"></span><br><span class="line">//删除db目录里面的storage.bson </span><br><span class="line"><span class="built_in">rm</span> -rf db目录/storage.bson</span><br><span class="line"></span><br><span class="line">//修复数据</span><br><span class="line">mongod --dbpath db目录 --repair</span><br><span class="line"></span><br><span class="line">//以修复方式启动mongodb</span><br><span class="line">mongod -f 配置文件路径 --repair</span><br><span class="line"></span><br><span class="line">//然后接着在启动一次</span><br><span class="line">mongod -f 配置文件路径 --repair</span><br><span class="line"></span><br><span class="line">//查看进程是否运行</span><br><span class="line">ps aux|grep mongo</span><br></pre></td></tr></table></figure>

<h4 id="具体操作示例："><a href="#具体操作示例：" class="headerlink" title="具体操作示例："></a>具体操作示例：</h4><h5 id="1、服务器重启之后，或者非法操作关闭节点之后，导致mongod服务无法正常启动。"><a href="#1、服务器重启之后，或者非法操作关闭节点之后，导致mongod服务无法正常启动。" class="headerlink" title="1、服务器重启之后，或者非法操作关闭节点之后，导致mongod服务无法正常启动。"></a>1、服务器重启之后，或者非法操作关闭节点之后，导致mongod服务无法正常启动。</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 7494</span><br><span class="line"></span><br><span class="line">^Z</span><br><span class="line">[1]+  已停止               mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/mongod.conf</span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>

<h5 id="2、依次启动其他服务发现，配置节点和路由节点服务启动正常，因此只需要修复2个分片节点的副本集。"><a href="#2、依次启动其他服务发现，配置节点和路由节点服务启动正常，因此只需要修复2个分片节点的副本集。" class="headerlink" title="2、依次启动其他服务发现，配置节点和路由节点服务启动正常，因此只需要修复2个分片节点的副本集。"></a>2、依次启动其他服务发现，配置节点和路由节点服务启动正常，因此只需要修复2个分片节点的副本集。</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ps aux|grep mongo</span><br><span class="line">root       7492  0.0  1.2 155900 23264 pts/0    T    19:10   0:00 mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/mongod.conf</span><br><span class="line">root       7493  0.0  0.6 155900 12856 ?        Ss   19:10   0:00 mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/mongod.conf</span><br><span class="line">root       7494  1.0  4.2 1521920 78376 ?       Sl   19:10   0:01 mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/mongod.conf</span><br><span class="line">root       7560  0.0  0.0 112828   992 pts/0    S+   19:11   0:00 grep --color=auto mongo</span><br><span class="line">[root@localhost ~]# <span class="built_in">kill</span> -9 7494 7493 7492</span><br><span class="line">[root@localhost ~]# ps aux|grep mongo</span><br><span class="line">root       7562  0.0  0.0 112828   992 pts/0    R+   19:12   0:00 grep --color=auto mongo</span><br><span class="line">[1]+  已杀死               mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/mongod.conf</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinconfigrs_27019/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 7573</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinconfigrs_27119/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 7645</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinconfigrs_27219/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 7714</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongos -f /usr/local/mongodb/sharded_cbin/cbinmongos_27017/mongos.conf </span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 7818</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongos -f /usr/local/mongodb/sharded_cbin/cbinmongos_27117/mongos.conf </span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 7867</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# ps aux|grep mongo</span><br><span class="line">root       7573  2.7  6.0 1842432 111864 ?      Sl   19:13   0:01 mongod -f /usr/local/mongodb/sharded_cbin/cbinconfigrs_27019/mongod.conf</span><br><span class="line">root       7645  2.9  5.2 1903924 97812 ?       Sl   19:13   0:01 mongod -f /usr/local/mongodb/sharded_cbin/cbinconfigrs_27119/mongod.conf</span><br><span class="line">root       7714  3.0  5.1 1800584 95308 ?       Sl   19:13   0:00 mongod -f /usr/local/mongodb/sharded_cbin/cbinconfigrs_27219/mongod.conf</span><br><span class="line">root       7818  0.5  1.3 326012 24312 ?        Sl   19:13   0:00 mongos -f /usr/local/mongodb/sharded_cbin/cbinmongos_27017/mongos.conf</span><br><span class="line">root       7867  1.0  1.2 326012 23124 ?        Sl   19:13   0:00 mongos -f /usr/local/mongodb/sharded_cbin/cbinmongos_27117/mongos.conf</span><br><span class="line">root       7906  0.0  0.0 112832   992 pts/0    S+   19:13   0:00 grep --color=auto mongo</span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>

<h5 id="3、在本次运行环境下，只需修复分片节点的数据。因此删除db目录里面的-mongod-lock-和-删除db目录里面的storage-bson"><a href="#3、在本次运行环境下，只需修复分片节点的数据。因此删除db目录里面的-mongod-lock-和-删除db目录里面的storage-bson" class="headerlink" title="3、在本次运行环境下，只需修复分片节点的数据。因此删除db目录里面的&#x2F;mongod.lock 和 删除db目录里面的storage.bson"></a>3、在本次运行环境下，只需修复分片节点的数据。因此删除db目录里面的&#x2F;mongod.lock 和 删除db目录里面的storage.bson</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/data/db/mongod.lock </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs01_27118/data/db/mongod.lock </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs01_27218/data/db/mongod.lock </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs02_27318/data/db/mongod.lock </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs02_27418/data/db/mongod.lock </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs02_27518/data/db/mongod.lock </span><br><span class="line">[root@localhost ~]# </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/data/db/storage.bson </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs01_27118/data/db/storage.bson </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs01_27218/data/db/storage.bson </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs02_27318/data/db/storage.bson </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs02_27418/data/db/storage.bson </span><br><span class="line">[root@localhost ~]# <span class="built_in">rm</span> -rf /usr/local/mongodb/sharded_cbin/cbinshardrs02_27518/data/db/storage.bson </span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>

<h5 id="4、修复数据，依次修复27018–27518的数据"><a href="#4、修复数据，依次修复27018–27518的数据" class="headerlink" title="4、修复数据，依次修复27018–27518的数据"></a>4、修复数据，依次修复27018–27518的数据</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongod --dbpath /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/data/db/ --repair</span><br><span class="line">2022-10-30T19:21:15.919+0800 I  CONTROL  [main] Automatically disabling TLS 1.0, to force-enable TLS 1.0 specify --sslDisabledProtocols <span class="string">&#x27;none&#x27;</span></span><br><span class="line">2022-10-30T19:21:15.921+0800 W  ASIO     [main] No TransportLayer configured during NetworkInterface startup</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten] MongoDB starting : pid=8362 port=27017 dbpath=/usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/data/db/ 64-bit host=localhost.localdomain</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten] db version v4.2.18</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten] git version: f65ce5e25c0b26a00d091a4d24eec1a8b3a4c016</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten] OpenSSL version: OpenSSL 1.0.1e-fips 11 Feb 2013</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten] allocator: tcmalloc</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten] modules: none</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten] build environment:</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten]     distmod: rhel70</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten]     distarch: x86_64</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten]     target_arch: x86_64</span><br><span class="line">2022-10-30T19:21:15.921+0800 I  CONTROL  [initandlisten] options: &#123; repair: <span class="literal">true</span>, storage: &#123; dbPath: <span class="string">&quot;/usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/data/db/&quot;</span> &#125; &#125;</span><br><span class="line">2022-10-30T19:21:15.922+0800 I  STORAGE  [initandlisten] wiredtiger_open config: create,cache_size=397M,cache_overflow=(file_max=0M),session_max=33000,eviction=(threads_min=4,threads_max=4),config_base=<span class="literal">false</span>,statistics=(fast),<span class="built_in">log</span>=(enabled=<span class="literal">true</span>,archive=<span class="literal">true</span>,path=journal,compressor=snappy),file_manager=(close_idle_time=100000,close_scan_interval=10,close_handle_minimum=250),statistics_log=(<span class="built_in">wait</span>=0),verbose=[recovery_progress,checkpoint_progress],</span><br><span class="line">2022-10-30T19:21:16.132+0800 I  STORAGE  [initandlisten] WiredTiger message [1667128876:132206][8362:0x7f47b94dec40], txn-recover: Recovering <span class="built_in">log</span> 12 through 13</span><br><span class="line">2022-10-30T19:21:16.202+0800 I  STORAGE  [initandlisten] WiredTiger message [1667128876:202302][8362:0x7f47b94dec40], txn-recover: Recovering <span class="built_in">log</span> 13 through 13</span><br><span class="line">2022-10-30T19:21:16.353+0800 I  STORAGE  [initandlisten] WiredTiger message [1667128876:353171][8362:0x7f47b94dec40], txn-recover: Main recovery loop: starting at 12/1792 to 13/256</span><br><span class="line">2022-10-30T19:21:16.354+0800 I  STORAGE  [initandlisten] WiredTiger message [1667128876:354029][8362:0x7f47b94dec40], txn-recover: Recovering <span class="built_in">log</span> 12 through 13</span><br><span class="line">2022-10-30T19:21:16.440+0800 I  STORAGE  [initandlisten] WiredTiger message [1667128876:440641][8362:0x7f47b94dec40], file:sizeStorer.wt, txn-recover: Recovering <span class="built_in">log</span> 13 through 13</span><br><span class="line">2022-10-30T19:21:16.524+0800 I  STORAGE  [initandlisten] WiredTiger message [1667128876:524395][8362:0x7f47b94dec40], file:sizeStorer.wt, txn-recover: Set global recovery timestamp: (1667128144, 1)</span><br><span class="line">2022-10-30T19:21:16.529+0800 I  RECOVERY [initandlisten] WiredTiger recoveryTimestamp. Ts: Timestamp(1667128144, 1)</span><br><span class="line">2022-10-30T19:21:16.530+0800 I  STORAGE  [initandlisten] Repairing size cache</span><br><span class="line">2022-10-30T19:21:16.532+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:sizeStorer. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.532+0800 I  STORAGE  [initandlisten] Repairing catalog metadata</span><br><span class="line">2022-10-30T19:21:16.534+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:_mdb_catalog. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.535+0800 I  STORAGE  [initandlisten] Modifying the table logging settings to 1 <span class="keyword">for</span> all existing WiredTiger tables. Repair? 1, has previously incomplete table checks? 0</span><br><span class="line">2022-10-30T19:21:16.537+0800 I  STORAGE  [initandlisten] Timestamp monitor starting</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] ** WARNING: This server is bound to localhost.</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] **          Remote systems will be unable to connect to this server. </span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] **          Start the server with --bind_ip &lt;address&gt; to specify <span class="built_in">which</span> IP </span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] **          addresses it should serve responses from, or with --bind_ip_all to</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] **          <span class="built_in">bind</span> to all interfaces. If this behavior is desired, start the</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] **          server with --bind_ip 127.0.0.1 to <span class="built_in">disable</span> this warning.</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-10-30T19:21:16.539+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-30T19:21:16.540+0800 I  STORAGE  [initandlisten] repairDatabase <span class="built_in">local</span></span><br><span class="line">2022-10-30T19:21:16.540+0800 I  STORAGE  [initandlisten] Repairing collection local.system.replset</span><br><span class="line">2022-10-30T19:21:16.541+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-11--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.542+0800 I  STORAGE  [initandlisten] Repairing collection local.system.rollback.id</span><br><span class="line">2022-10-30T19:21:16.542+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-8--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.543+0800 I  STORAGE  [initandlisten] Repairing collection local.replset.oplogTruncateAfterPoint</span><br><span class="line">2022-10-30T19:21:16.543+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-2--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.543+0800 I  STORAGE  [initandlisten] Repairing collection local.startup_log</span><br><span class="line">2022-10-30T19:21:16.544+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-0--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.545+0800 I  STORAGE  [initandlisten] Repairing collection local.replset.election</span><br><span class="line">2022-10-30T19:21:16.546+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-6--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.546+0800 I  STORAGE  [initandlisten] Repairing collection local.replset.minvalid</span><br><span class="line">2022-10-30T19:21:16.547+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-4--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.547+0800 I  STORAGE  [initandlisten] Repairing collection local.oplog.rs</span><br><span class="line">2022-10-30T19:21:16.550+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-10--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.556+0800 I  INDEX    [initandlisten] index build: starting on local.system.replset properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;local.system.replset&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.556+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.556+0800 I  STORAGE  [initandlisten] Index build initialized: fd395091-0ac1-4746-9201-6fbb0389fe20: local.system.replset: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.557+0800 I  STORAGE  [initandlisten] Index builds manager starting: fd395091-0ac1-4746-9201-6fbb0389fe20: local.system.replset</span><br><span class="line">2022-10-30T19:21:16.558+0800 I  INDEX    [initandlisten] index build: inserted 1 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.559+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns local.system.replset</span><br><span class="line">2022-10-30T19:21:16.559+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: fd395091-0ac1-4746-9201-6fbb0389fe20: local.system.replset. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.563+0800 I  INDEX    [initandlisten] index build: starting on local.system.rollback.id properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;local.system.rollback.id&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.563+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.563+0800 I  STORAGE  [initandlisten] Index build initialized: af0cf901-cf8a-47d8-b70b-2e7fa737b02c: local.system.rollback.id: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.563+0800 I  STORAGE  [initandlisten] Index builds manager starting: af0cf901-cf8a-47d8-b70b-2e7fa737b02c: local.system.rollback.id</span><br><span class="line">2022-10-30T19:21:16.564+0800 I  INDEX    [initandlisten] index build: inserted 1 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.565+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns local.system.rollback.id</span><br><span class="line">2022-10-30T19:21:16.565+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: af0cf901-cf8a-47d8-b70b-2e7fa737b02c: local.system.rollback.id. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.568+0800 I  INDEX    [initandlisten] index build: starting on local.replset.oplogTruncateAfterPoint properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;local.replset.oplogTruncateAfterPoint&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.568+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.568+0800 I  STORAGE  [initandlisten] Index build initialized: cbea78f9-cf53-4d05-8e07-405c2a902a6c: local.replset.oplogTruncateAfterPoint: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.568+0800 I  STORAGE  [initandlisten] Index builds manager starting: cbea78f9-cf53-4d05-8e07-405c2a902a6c: local.replset.oplogTruncateAfterPoint</span><br><span class="line">2022-10-30T19:21:16.569+0800 I  INDEX    [initandlisten] index build: inserted 0 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.571+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns local.replset.oplogTruncateAfterPoint</span><br><span class="line">2022-10-30T19:21:16.571+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: cbea78f9-cf53-4d05-8e07-405c2a902a6c: local.replset.oplogTruncateAfterPoint. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.573+0800 I  INDEX    [initandlisten] index build: starting on local.startup_log properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;local.startup_log&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.573+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.573+0800 I  STORAGE  [initandlisten] Index build initialized: 1cf02f91-70cd-4e0a-8e39-7dd398ffabc9: local.startup_log: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.574+0800 I  STORAGE  [initandlisten] Index builds manager starting: 1cf02f91-70cd-4e0a-8e39-7dd398ffabc9: local.startup_log</span><br><span class="line">2022-10-30T19:21:16.575+0800 I  INDEX    [initandlisten] index build: inserted 4 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.575+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns local.startup_log</span><br><span class="line">2022-10-30T19:21:16.575+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 1cf02f91-70cd-4e0a-8e39-7dd398ffabc9: local.startup_log. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.580+0800 I  INDEX    [initandlisten] index build: starting on local.replset.election properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;local.replset.election&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.581+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.581+0800 I  STORAGE  [initandlisten] Index build initialized: 490c78e4-3e32-4f35-86e3-d436bb1e70d1: local.replset.election: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.581+0800 I  STORAGE  [initandlisten] Index builds manager starting: 490c78e4-3e32-4f35-86e3-d436bb1e70d1: local.replset.election</span><br><span class="line">2022-10-30T19:21:16.582+0800 I  INDEX    [initandlisten] index build: inserted 1 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.583+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns local.replset.election</span><br><span class="line">2022-10-30T19:21:16.583+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 490c78e4-3e32-4f35-86e3-d436bb1e70d1: local.replset.election. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.587+0800 I  INDEX    [initandlisten] index build: starting on local.replset.minvalid properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;local.replset.minvalid&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.587+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.587+0800 I  STORAGE  [initandlisten] Index build initialized: 315a64ca-0c6c-4486-80b8-41ae86aef1ad: local.replset.minvalid: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.587+0800 I  STORAGE  [initandlisten] Index builds manager starting: 315a64ca-0c6c-4486-80b8-41ae86aef1ad: local.replset.minvalid</span><br><span class="line">2022-10-30T19:21:16.588+0800 I  INDEX    [initandlisten] index build: inserted 1 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.589+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns local.replset.minvalid</span><br><span class="line">2022-10-30T19:21:16.589+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 315a64ca-0c6c-4486-80b8-41ae86aef1ad: local.replset.minvalid. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.591+0800 I  STORAGE  [initandlisten] repairDatabase articledb</span><br><span class="line">2022-10-30T19:21:16.591+0800 I  STORAGE  [initandlisten] Repairing collection articledb.comment</span><br><span class="line">2022-10-30T19:21:16.592+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-29--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.593+0800 I  STORAGE  [initandlisten] Repairing collection articledb.author</span><br><span class="line">2022-10-30T19:21:16.593+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-39--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.595+0800 I  INDEX    [initandlisten] index build: starting on articledb.comment properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;articledb.comment&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.595+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.597+0800 I  INDEX    [initandlisten] index build: starting on articledb.comment properties: &#123; v: 2, key: &#123; nickname: <span class="string">&quot;hashed&quot;</span> &#125;, name: <span class="string">&quot;nickname_hashed&quot;</span>, ns: <span class="string">&quot;articledb.comment&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.597+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.597+0800 I  STORAGE  [initandlisten] Index build initialized: ece5c701-677a-47cf-b120-360ab6bf9c67: articledb.comment: indexes: 2</span><br><span class="line">2022-10-30T19:21:16.598+0800 I  STORAGE  [initandlisten] Index builds manager starting: ece5c701-677a-47cf-b120-360ab6bf9c67: articledb.comment</span><br><span class="line">2022-10-30T19:21:16.599+0800 I  INDEX    [initandlisten] index build: inserted 484 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.601+0800 I  INDEX    [initandlisten] index build: inserted 484 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.602+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns articledb.comment</span><br><span class="line">2022-10-30T19:21:16.602+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index nickname_hashed on ns articledb.comment</span><br><span class="line">2022-10-30T19:21:16.602+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: ece5c701-677a-47cf-b120-360ab6bf9c67: articledb.comment. Index specs requested: 2. Indexes <span class="keyword">in</span> catalog before build: 2. Indexes <span class="keyword">in</span> catalog after build: 2</span><br><span class="line">2022-10-30T19:21:16.604+0800 I  INDEX    [initandlisten] index build: starting on articledb.author properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;articledb.author&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.605+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.606+0800 I  INDEX    [initandlisten] index build: starting on articledb.author properties: &#123; v: 2, key: &#123; age: 1.0 &#125;, name: <span class="string">&quot;age_1&quot;</span>, ns: <span class="string">&quot;articledb.author&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.606+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.606+0800 I  STORAGE  [initandlisten] Index build initialized: 7cca3153-46cd-4fd8-844f-83727a6380b2: articledb.author: indexes: 2</span><br><span class="line">2022-10-30T19:21:16.606+0800 I  STORAGE  [initandlisten] Index builds manager starting: 7cca3153-46cd-4fd8-844f-83727a6380b2: articledb.author</span><br><span class="line">2022-10-30T19:21:16.607+0800 I  INDEX    [initandlisten] index build: inserted 0 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.608+0800 I  INDEX    [initandlisten] index build: inserted 0 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.608+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns articledb.author</span><br><span class="line">2022-10-30T19:21:16.608+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index age_1 on ns articledb.author</span><br><span class="line">2022-10-30T19:21:16.608+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 7cca3153-46cd-4fd8-844f-83727a6380b2: articledb.author. Index specs requested: 2. Indexes <span class="keyword">in</span> catalog before build: 2. Indexes <span class="keyword">in</span> catalog after build: 2</span><br><span class="line">2022-10-30T19:21:16.610+0800 I  STORAGE  [initandlisten] repairDatabase config</span><br><span class="line">2022-10-30T19:21:16.610+0800 I  STORAGE  [initandlisten] Repairing collection config.cache.collections</span><br><span class="line">2022-10-30T19:21:16.611+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-21--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.612+0800 I  STORAGE  [initandlisten] Repairing collection config.cache.chunks.articledb.author</span><br><span class="line">2022-10-30T19:21:16.613+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-43--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.614+0800 I  STORAGE  [initandlisten] Repairing collection config.cache.chunks.config.system.sessions</span><br><span class="line">2022-10-30T19:21:16.615+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-23--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.615+0800 I  STORAGE  [initandlisten] Repairing collection config.transactions</span><br><span class="line">2022-10-30T19:21:16.616+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-15--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.617+0800 I  STORAGE  [initandlisten] Repairing collection config.cache.databases</span><br><span class="line">2022-10-30T19:21:16.618+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-33--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.619+0800 I  STORAGE  [initandlisten] Repairing collection config.image_collection</span><br><span class="line">2022-10-30T19:21:16.620+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-17--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.621+0800 I  STORAGE  [initandlisten] Repairing collection config.cache.chunks.articledb.comment</span><br><span class="line">2022-10-30T19:21:16.622+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-35--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.622+0800 I  STORAGE  [initandlisten] Repairing collection config.system.sessions</span><br><span class="line">2022-10-30T19:21:16.623+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-19--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.625+0800 I  INDEX    [initandlisten] index build: starting on config.cache.collections properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;config.cache.collections&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.625+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.625+0800 I  STORAGE  [initandlisten] Index build initialized: 6762e707-93bd-4969-8a84-de0dae311b01: config.cache.collections: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.626+0800 I  STORAGE  [initandlisten] Index builds manager starting: 6762e707-93bd-4969-8a84-de0dae311b01: config.cache.collections</span><br><span class="line">2022-10-30T19:21:16.627+0800 I  INDEX    [initandlisten] index build: inserted 3 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.628+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns config.cache.collections</span><br><span class="line">2022-10-30T19:21:16.628+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 6762e707-93bd-4969-8a84-de0dae311b01: config.cache.collections. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.633+0800 I  INDEX    [initandlisten] index build: starting on config.cache.chunks.articledb.author properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;config.cache.chunks.articledb.author&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.633+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.635+0800 I  INDEX    [initandlisten] index build: starting on config.cache.chunks.articledb.author properties: &#123; v: 2, key: &#123; lastmod: 1 &#125;, name: <span class="string">&quot;lastmod_1&quot;</span>, ns: <span class="string">&quot;config.cache.chunks.articledb.author&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.635+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.635+0800 I  STORAGE  [initandlisten] Index build initialized: 881cf8d7-642b-4d2a-8586-2b3eba1508a0: config.cache.chunks.articledb.author: indexes: 2</span><br><span class="line">2022-10-30T19:21:16.636+0800 I  STORAGE  [initandlisten] Index builds manager starting: 881cf8d7-642b-4d2a-8586-2b3eba1508a0: config.cache.chunks.articledb.author</span><br><span class="line">2022-10-30T19:21:16.637+0800 I  INDEX    [initandlisten] index build: inserted 1 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.638+0800 I  INDEX    [initandlisten] index build: inserted 1 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.639+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns config.cache.chunks.articledb.author</span><br><span class="line">2022-10-30T19:21:16.639+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index lastmod_1 on ns config.cache.chunks.articledb.author</span><br><span class="line">2022-10-30T19:21:16.639+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 881cf8d7-642b-4d2a-8586-2b3eba1508a0: config.cache.chunks.articledb.author. Index specs requested: 2. Indexes <span class="keyword">in</span> catalog before build: 2. Indexes <span class="keyword">in</span> catalog after build: 2</span><br><span class="line">2022-10-30T19:21:16.642+0800 I  INDEX    [initandlisten] index build: starting on config.cache.chunks.config.system.sessions properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;config.cache.chunks.config.system.sessions&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.642+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.644+0800 I  INDEX    [initandlisten] index build: starting on config.cache.chunks.config.system.sessions properties: &#123; v: 2, key: &#123; lastmod: 1 &#125;, name: <span class="string">&quot;lastmod_1&quot;</span>, ns: <span class="string">&quot;config.cache.chunks.config.system.sessions&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.644+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.644+0800 I  STORAGE  [initandlisten] Index build initialized: 1c00c476-83b5-4898-b996-0634edb94e10: config.cache.chunks.config.system.sessions: indexes: 2</span><br><span class="line">2022-10-30T19:21:16.645+0800 I  STORAGE  [initandlisten] Index builds manager starting: 1c00c476-83b5-4898-b996-0634edb94e10: config.cache.chunks.config.system.sessions</span><br><span class="line">2022-10-30T19:21:16.648+0800 I  INDEX    [initandlisten] index build: inserted 1024 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.650+0800 I  INDEX    [initandlisten] index build: inserted 1024 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.650+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns config.cache.chunks.config.system.sessions</span><br><span class="line">2022-10-30T19:21:16.650+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index lastmod_1 on ns config.cache.chunks.config.system.sessions</span><br><span class="line">2022-10-30T19:21:16.650+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 1c00c476-83b5-4898-b996-0634edb94e10: config.cache.chunks.config.system.sessions. Index specs requested: 2. Indexes <span class="keyword">in</span> catalog before build: 2. Indexes <span class="keyword">in</span> catalog after build: 2</span><br><span class="line">2022-10-30T19:21:16.656+0800 I  INDEX    [initandlisten] index build: starting on config.transactions properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;config.transactions&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.656+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.656+0800 I  STORAGE  [initandlisten] Index build initialized: c5c4e5e0-98f0-4d88-bd87-9e1657b344f7: config.transactions: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.657+0800 I  STORAGE  [initandlisten] Index builds manager starting: c5c4e5e0-98f0-4d88-bd87-9e1657b344f7: config.transactions</span><br><span class="line">2022-10-30T19:21:16.657+0800 I  INDEX    [initandlisten] index build: inserted 0 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.658+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns config.transactions</span><br><span class="line">2022-10-30T19:21:16.658+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: c5c4e5e0-98f0-4d88-bd87-9e1657b344f7: config.transactions. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.664+0800 I  INDEX    [initandlisten] index build: starting on config.cache.databases properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;config.cache.databases&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.664+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.664+0800 I  STORAGE  [initandlisten] Index build initialized: 1459571c-949f-4391-811c-64c3a5309bd6: config.cache.databases: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.665+0800 I  STORAGE  [initandlisten] Index builds manager starting: 1459571c-949f-4391-811c-64c3a5309bd6: config.cache.databases</span><br><span class="line">2022-10-30T19:21:16.667+0800 I  INDEX    [initandlisten] index build: inserted 1 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.667+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns config.cache.databases</span><br><span class="line">2022-10-30T19:21:16.667+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 1459571c-949f-4391-811c-64c3a5309bd6: config.cache.databases. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.672+0800 I  INDEX    [initandlisten] index build: starting on config.image_collection properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;config.image_collection&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.672+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.672+0800 I  STORAGE  [initandlisten] Index build initialized: 87eb9648-f676-4c50-87de-067c621d3cd4: config.image_collection: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.672+0800 I  STORAGE  [initandlisten] Index builds manager starting: 87eb9648-f676-4c50-87de-067c621d3cd4: config.image_collection</span><br><span class="line">2022-10-30T19:21:16.673+0800 I  INDEX    [initandlisten] index build: inserted 0 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.674+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns config.image_collection</span><br><span class="line">2022-10-30T19:21:16.674+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 87eb9648-f676-4c50-87de-067c621d3cd4: config.image_collection. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.679+0800 I  INDEX    [initandlisten] index build: starting on config.cache.chunks.articledb.comment properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;config.cache.chunks.articledb.comment&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.679+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.680+0800 I  INDEX    [initandlisten] index build: starting on config.cache.chunks.articledb.comment properties: &#123; v: 2, key: &#123; lastmod: 1 &#125;, name: <span class="string">&quot;lastmod_1&quot;</span>, ns: <span class="string">&quot;config.cache.chunks.articledb.comment&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.680+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.680+0800 I  STORAGE  [initandlisten] Index build initialized: bc9c0a9d-66c5-4012-8f69-79fc58a787d3: config.cache.chunks.articledb.comment: indexes: 2</span><br><span class="line">2022-10-30T19:21:16.681+0800 I  STORAGE  [initandlisten] Index builds manager starting: bc9c0a9d-66c5-4012-8f69-79fc58a787d3: config.cache.chunks.articledb.comment</span><br><span class="line">2022-10-30T19:21:16.682+0800 I  INDEX    [initandlisten] index build: inserted 4 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.684+0800 I  INDEX    [initandlisten] index build: inserted 4 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.685+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns config.cache.chunks.articledb.comment</span><br><span class="line">2022-10-30T19:21:16.685+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index lastmod_1 on ns config.cache.chunks.articledb.comment</span><br><span class="line">2022-10-30T19:21:16.685+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: bc9c0a9d-66c5-4012-8f69-79fc58a787d3: config.cache.chunks.articledb.comment. Index specs requested: 2. Indexes <span class="keyword">in</span> catalog before build: 2. Indexes <span class="keyword">in</span> catalog after build: 2</span><br><span class="line">2022-10-30T19:21:16.688+0800 I  INDEX    [initandlisten] index build: starting on config.system.sessions properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;config.system.sessions&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.688+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.691+0800 I  INDEX    [initandlisten] index build: starting on config.system.sessions properties: &#123; v: 2, key: &#123; lastUse: 1 &#125;, name: <span class="string">&quot;lsidTTLIndex&quot;</span>, ns: <span class="string">&quot;config.system.sessions&quot;</span>, expireAfterSeconds: 1800 &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.691+0800 I  INDEX    [initandlisten] build may temporarily use up to 100 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.691+0800 I  STORAGE  [initandlisten] Index build initialized: 1200bca2-e929-4337-899a-9a61234c7332: config.system.sessions: indexes: 2</span><br><span class="line">2022-10-30T19:21:16.692+0800 I  STORAGE  [initandlisten] Index builds manager starting: 1200bca2-e929-4337-899a-9a61234c7332: config.system.sessions</span><br><span class="line">2022-10-30T19:21:16.693+0800 I  INDEX    [initandlisten] index build: inserted 1 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.694+0800 I  INDEX    [initandlisten] index build: inserted 1 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.694+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns config.system.sessions</span><br><span class="line">2022-10-30T19:21:16.695+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index lsidTTLIndex on ns config.system.sessions</span><br><span class="line">2022-10-30T19:21:16.695+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: 1200bca2-e929-4337-899a-9a61234c7332: config.system.sessions. Index specs requested: 2. Indexes <span class="keyword">in</span> catalog before build: 2. Indexes <span class="keyword">in</span> catalog after build: 2</span><br><span class="line">2022-10-30T19:21:16.700+0800 I  STORAGE  [initandlisten] repairDatabase admin</span><br><span class="line">2022-10-30T19:21:16.700+0800 I  STORAGE  [initandlisten] Repairing collection admin.system.version</span><br><span class="line">2022-10-30T19:21:16.700+0800 I  STORAGE  [initandlisten] Verify succeeded on uri table:collection-13--4639543508041552296. Not salvaging.</span><br><span class="line">2022-10-30T19:21:16.702+0800 I  INDEX    [initandlisten] index build: starting on admin.system.version properties: &#123; v: 2, key: &#123; _id: 1 &#125;, name: <span class="string">&quot;_id_&quot;</span>, ns: <span class="string">&quot;admin.system.version&quot;</span> &#125; using method: Foreground</span><br><span class="line">2022-10-30T19:21:16.702+0800 I  INDEX    [initandlisten] build may temporarily use up to 200 megabytes of RAM</span><br><span class="line">2022-10-30T19:21:16.702+0800 I  STORAGE  [initandlisten] Index build initialized: fe38ccfb-d422-4532-8f3d-a8d8c506720d: admin.system.version: indexes: 1</span><br><span class="line">2022-10-30T19:21:16.703+0800 I  STORAGE  [initandlisten] Index builds manager starting: fe38ccfb-d422-4532-8f3d-a8d8c506720d: admin.system.version</span><br><span class="line">2022-10-30T19:21:16.704+0800 I  INDEX    [initandlisten] index build: inserted 4 keys from external sorter into index <span class="keyword">in</span> 0 seconds</span><br><span class="line">2022-10-30T19:21:16.704+0800 I  INDEX    [initandlisten] index build: <span class="keyword">done</span> building index _id_ on ns admin.system.version</span><br><span class="line">2022-10-30T19:21:16.704+0800 I  STORAGE  [initandlisten] Index builds manager completed successfully: fe38ccfb-d422-4532-8f3d-a8d8c506720d: admin.system.version. Index specs requested: 1. Indexes <span class="keyword">in</span> catalog before build: 1. Indexes <span class="keyword">in</span> catalog after build: 1</span><br><span class="line">2022-10-30T19:21:16.708+0800 W  ASIO     [initandlisten] No TransportLayer configured during NetworkInterface startup</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  STORAGE  [initandlisten] Flow Control is enabled on this deployment.</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  STORAGE  [initandlisten] finished checking dbs</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  REPL     [initandlisten] Stepping down the ReplicationCoordinator <span class="keyword">for</span> shutdown, waitTime: 10000ms</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  SHARDING [initandlisten] Shutting down the WaitForMajorityService</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  NETWORK  [initandlisten] Shutting down the global connection pool</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  STORAGE  [initandlisten] Shutting down the FlowControlTicketholder</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  -        [initandlisten] Stopping further Flow Control ticket acquisitions.</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  STORAGE  [initandlisten] Shutting down the PeriodicThreadToAbortExpiredTransactions</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  STORAGE  [initandlisten] Shutting down the PeriodicThreadToDecreaseSnapshotHistoryIfNotNeeded</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  REPL     [initandlisten] Shutting down the ReplicationCoordinator</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  SHARDING [initandlisten] Shutting down the ShardingInitializationMongoD</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  REPL     [initandlisten] Enqueuing the ReplicationStateTransitionLock <span class="keyword">for</span> shutdown</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  -        [initandlisten] Killing all operations <span class="keyword">for</span> shutdown</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  COMMAND  [initandlisten] Shutting down all open transactions</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  REPL     [initandlisten] Acquiring the ReplicationStateTransitionLock <span class="keyword">for</span> shutdown</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  INDEX    [initandlisten] Shutting down the IndexBuildsCoordinator</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  NETWORK  [initandlisten] Shutting down the ReplicaSetMonitor</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  CONTROL  [initandlisten] Shutting down free monitoring</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  FTDC     [initandlisten] Shutting down full-time data capture</span><br><span class="line">2022-10-30T19:21:16.709+0800 I  STORAGE  [initandlisten] Shutting down the HealthLog</span><br><span class="line">2022-10-30T19:21:16.710+0800 I  STORAGE  [initandlisten] Shutting down the storage engine</span><br><span class="line">2022-10-30T19:21:16.710+0800 I  STORAGE  [initandlisten] Deregistering all the collections</span><br><span class="line">2022-10-30T19:21:16.710+0800 I  STORAGE  [WTOplogJournalThread] Oplog journal thread loop shutting down</span><br><span class="line">2022-10-30T19:21:16.710+0800 I  STORAGE  [initandlisten] Timestamp monitor shutting down</span><br><span class="line">2022-10-30T19:21:16.710+0800 I  STORAGE  [initandlisten] WiredTigerKVEngine shutting down</span><br><span class="line">2022-10-30T19:21:16.710+0800 I  STORAGE  [initandlisten] Shutting down session sweeper thread</span><br><span class="line">2022-10-30T19:21:16.710+0800 I  STORAGE  [initandlisten] Finished shutting down session sweeper thread</span><br><span class="line">2022-10-30T19:21:16.710+0800 I  STORAGE  [initandlisten] Shutting down journal flusher thread</span><br><span class="line">2022-10-30T19:21:16.732+0800 I  STORAGE  [initandlisten] Finished shutting down journal flusher thread</span><br><span class="line">2022-10-30T19:21:16.732+0800 I  STORAGE  [initandlisten] Shutting down checkpoint thread</span><br><span class="line">2022-10-30T19:21:16.732+0800 I  STORAGE  [initandlisten] Finished shutting down checkpoint thread</span><br><span class="line">2022-10-30T19:21:16.738+0800 I  STORAGE  [initandlisten] shutdown: removing fs lock...</span><br><span class="line">2022-10-30T19:21:16.738+0800 I  -        [initandlisten] Dropping the scope cache <span class="keyword">for</span> shutdown</span><br><span class="line">2022-10-30T19:21:16.738+0800 I  CONTROL  [initandlisten] now exiting</span><br><span class="line">2022-10-30T19:21:16.738+0800 I  CONTROL  [initandlisten] shutting down with code:0</span><br><span class="line">[root@localhost ~]# </span><br><span class="line">[root@localhost ~]# mongod --dbpath /usr/local/mongodb/sharded_cbin/cbinshardrs01_27118/data/db/ --repair</span><br><span class="line">[root@localhost ~]# mongod --dbpath /usr/local/mongodb/sharded_cbin/cbinshardrs01_27218/data/db/ --repair</span><br><span class="line">[root@localhost ~]# mongod --dbpath /usr/local/mongodb/sharded_cbin/cbinshardrs02_27318/data/db/ --repair</span><br><span class="line">[root@localhost ~]# mongod --dbpath /usr/local/mongodb/sharded_cbin/cbinshardrs02_27418/data/db/ --repair</span><br><span class="line">[root@localhost ~]# mongod --dbpath /usr/local/mongodb/sharded_cbin/cbinshardrs02_27518/data/db/ --repair</span><br></pre></td></tr></table></figure>

<h5 id="5、先以修复方式启动mongodb，再接着正常启动一次"><a href="#5、先以修复方式启动mongodb，再接着正常启动一次" class="headerlink" title="5、先以修复方式启动mongodb，再接着正常启动一次"></a>5、先以修复方式启动mongodb，再接着正常启动一次</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/mongod.conf --repair</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8791</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8861</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27118/mongod.conf --repair</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8949</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27118/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8980</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27218/mongod.conf --repair</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 9100</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27218/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 9131</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs02_27318/mongod.conf --repair</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 9188</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs02_27318/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 9220</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs02_27418/mongod.conf --repair</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 9308</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs02_27418/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 9339</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs02_27518/mongod.conf --repair</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 9440</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs02_27518/mongod.conf</span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 9494</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# </span><br><span class="line">[root@localhost ~]# ps aux|grep mongo</span><br><span class="line">root       7573  1.1  7.9 1892652 148920 ?      Sl   19:13   0:11 mongod -f /usr/local/mongodb/sharded_cbin/cbinconfigrs_27019/mongod.conf</span><br><span class="line">root       7645  1.1  7.3 1950664 137032 ?      Sl   19:13   0:11 mongod -f /usr/local/mongodb/sharded_cbin/cbinconfigrs_27119/mongod.conf</span><br><span class="line">root       7714  1.0  7.0 1863676 130932 ?      Sl   19:13   0:10 mongod -f /usr/local/mongodb/sharded_cbin/cbinconfigrs_27219/mongod.conf</span><br><span class="line">root       7818  0.3  1.2 328116 22868 ?        Sl   19:13   0:03 mongos -f /usr/local/mongodb/sharded_cbin/cbinmongos_27017/mongos.conf</span><br><span class="line">root       7867  0.3  1.1 328116 22216 ?        Sl   19:13   0:03 mongos -f /usr/local/mongodb/sharded_cbin/cbinmongos_27117/mongos.conf</span><br><span class="line">root       8861  1.2  5.7 1809956 106216 ?      Sl   19:26   0:02 mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27018/mongod.conf</span><br><span class="line">root       8980  1.2  5.4 1889740 101928 ?      Sl   19:26   0:02 mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27118/mongod.conf</span><br><span class="line">root       9131  0.8  4.5 1594008 84064 ?       Sl   19:27   0:01 mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs01_27218/mongod.conf</span><br><span class="line">root       9220  1.3  5.7 1889224 106920 ?      Sl   19:27   0:01 mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs02_27318/mongod.conf</span><br><span class="line">root       9339  1.2  5.1 1866144 96680 ?       Sl   19:27   0:01 mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs02_27418/mongod.conf</span><br><span class="line">root       9494  0.9  4.2 1594008 78768 ?       Sl   19:27   0:01 mongod -f /usr/local/mongodb/sharded_cbin/cbinshardrs02_27518/mongod.conf</span><br><span class="line">root       9687  0.0  0.0 112832   992 pts/0    S+   19:29   0:00 grep --color=auto mongo</span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>









<h2 id="十四、MongoDB-GridFS"><a href="#十四、MongoDB-GridFS" class="headerlink" title="十四、MongoDB GridFS"></a>十四、MongoDB GridFS</h2><p>在之前的学习中，我们学习了MongoDB存储数据的形式并通过实际操作完成数据的存储。默认情况下，MongoDB受BSON文件大小的限制，存储的文件大小不可超过16M，但是在实际系统开发中，上传的图片或者文件会很大。为了满足这种需求，MongoDB提供了GridFS框架，而GridFS框架可以更好的存储大于16M的文件。</p>
<h3 id="GridFS概述"><a href="#GridFS概述" class="headerlink" title="GridFS概述"></a>GridFS概述</h3><p>GridFS 用于存储和恢复那些<strong>超过16M</strong>（BSON文件限制）的文件(如：图片、音频、视频等)。</p>
<p>GridFS是MongoDB的一个子模块，使用GridFS可以基于MongoDB来持久化文件，并且支持分布式应用（即文件分布存储和读取）。GridFS也是文件存储的一种方式，它不会将文件存储在单个文档中，而是<u>将文件分为多个块（chunk），并将每个块存储为单独的文档。</u>默认情况下，GridFS使用的块大小为255KB。也就是说，GridFS将文件分成多个大小为255KB的块，每个chunk将作为MongoDB的一个文档(document)被存储在chunks集合中。</p>
<p>当查询GridFS文件时，GridFS驱动程序将根据查询需求重新组装块，形成完整文件。在查询时还可以指定查询范围，访问文件中的任意部分信息，例如跳转到视频或音频的<u>某个时间点</u>查看。</p>
<p>在某些情况下， MongoDB数据库中存储大型文件可能比系统级文件系统（如：Windows系统、Linux系统）存储效率更高。举例列出一些GridFS常见的应用场景：</p>
<ul>
<li>文件系统限制了一个目录可包含的文件数，可以使用GridFS存储任意数量的文件。</li>
<li>希望文件和元数据自动同步，并使用MongoDB副本集将文件存储到多个系统中。</li>
<li>可以使用GridFS获取文件的部分内容加载到内存中查看想要的信息，而不需要加载整个大文件到内存中去查找。</li>
</ul>
<p>这里需要注意的是，如果文件大小<u>小于16MB的限制，那么使用单个文档存储文件即可，最好不使用GridFS</u>。可以在文档中使用BinData数据类型存储二进制数据。</p>
<h3 id="GridFS存储结构"><a href="#GridFS存储结构" class="headerlink" title="GridFS存储结构"></a>GridFS存储结构</h3><p>GridFS将上传的文件存储在两个集合中。下面，通过一张图介绍一下GridFS存储结构，具体如下所示。</p>
<p>![image-20221031194036044](第6章  MongoDB GridFS.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202210311940182.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202210311940182.png</a>)</p>
<p>文件通过GridFS驱动上传到GridFS中进行存储，GridFS将文件分别存储到集合fs.chunks和fs.files中。</p>
<p>针对GridFS中存储文件的两个集合进行详细介绍，具体如下：</p>
<p><strong>fs.chunks：</strong></p>
<p>​	GridFS将文件切分为多个大小为255KB的二进制数据块（即文件原始数据），将这些数据块存储在fs.chunks集合中。</p>
<p><strong>fs.files：</strong></p>
<p>​	存储文件的元数据（meta data），元数据是关于数据的组织、数据域及其关系的信息。简言之，元数据就是描述文件信息的数据，算是一种电子目录，用来记录文件命、文件大小、文件块存储位置等数据。 </p>
<p>GridFS规范定义了一些fs.files中文档必需的键，具体如下：</p>
<ul>
<li>_id：文件唯一的id，默认使用ObjectId对象，用户也可以自定义其类型。与fs.chunks集合中数据块的files_id键相对应。</li>
<li>Length：文件大小，以字节为单位。</li>
<li>chunkSize：每块的大小，以字节为单位。默认是261120b（255kb），必要时可以调整。</li>
<li>uploadDate：文件上传时间。</li>
<li>filename：文件名称。</li>
<li>metadata：文件的其它信息，默认内容为空，用户可以自己定义。</li>
</ul>
<p>GridFS规范定义了一些fs.chunks中文档必需的键，具体如下：</p>
<ul>
<li>_id：和其它MongoDB文档一样，块也有自己唯一的标记，默认使用ObjectId对象，用户也可以自定义其类型。</li>
<li>_files_id：文件id，对应fs.files集合中文件元数据中的_id键。</li>
<li>n：表示块编号，也就是这个块在原文件中的顺序编号。</li>
<li>data：数据块中的二进制数据。</li>
</ul>
<p>当客户端在GridFS中查询文件时，MongoDB将首先从集合fs.files中获取该文件的元数据信息，然后根据获取的元数据信息在集合fs.chunks查找符合要求的块（即files_id与元数据中_id相同的块），最后将这些块从新组装后返回给客户端。</p>
<h3 id="GridFS基本操作"><a href="#GridFS基本操作" class="headerlink" title="GridFS基本操作"></a>GridFS基本操作</h3><p>MongoDB提供了与GridFS交互的命令行工具mongofiles，通过Shell命令可以很方便地操作GridFS，例如上传文件、下载文件和查询文件等相关操作。</p>
<p>下面，通过两张表来分别介绍一下mongofiles工具常用的options选项和commands命令以及其相关说明。mongofiles工具常用的options选项及相关说明，具体如下所示。</p>
<table>
<thead>
<tr>
<th><strong>options</strong></th>
<th><strong>相关说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>–help</td>
<td>返回有关mongofiles中所有options的用法信息</td>
</tr>
<tr>
<td>–host&#x3D;<hostname>&lt;:port&gt;</td>
<td>指定MongoDB数据库的主机名（或IP）和端口号，默认情况下，mongofiles尝试连接localhost:27017的主机名和端口号</td>
</tr>
<tr>
<td>–port&#x3D;<port></td>
<td>指定MongoDB数据库的端口号</td>
</tr>
<tr>
<td>–username&#x3D;<username>或-u&#x3D;<username></td>
<td>指定用户名，主要用于MongoDB数据库开启了权限认证</td>
</tr>
<tr>
<td>–password&#x3D;<password>或-p&#x3D;<password></td>
<td>指定密码（用于MongoDB数据库开启了权限认证）</td>
</tr>
<tr>
<td>–db&#x3D;<database>或-d&#x3D;<database></td>
<td>指定GridFS存储数据库名称，默认使用MongoDB中test数据库。如数据库名称不存在则创建</td>
</tr>
<tr>
<td>–local&#x3D;<filename>或-l&#x3D;<filename></td>
<td>指定用于获取和存储操作的文件名称</td>
</tr>
<tr>
<td>–replace，-r</td>
<td>替换GridFS中已存在的对象（文件名相同），与put用法类似，区别是put不会覆盖已存在的对象</td>
</tr>
<tr>
<td>–authenticationDatabase&#x3D;<dbname></td>
<td>指定GridFS存储的身份认证数据库名称（用于MongoDB数据库开启了权限认证）</td>
</tr>
<tr>
<td>–db&#x3D;<database>或-d&#x3D;<database></td>
<td>指定GridFS存储数据库名称，默认使用MongoDB中test数据库。如数据库名称不存在则创建</td>
</tr>
</tbody></table>
<p>mongofiles工具常用的commands命令及相关说明，具体如下所示。</p>
<table>
<thead>
<tr>
<th><strong>commands</strong></th>
<th><strong>相关说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>list <prefix></td>
<td>列出GridFS存储中的所有文件。prefix为指定的字符串，这样返回的文件列表限制为以该字符串开头的所有文件，为可选参数</td>
</tr>
<tr>
<td>search <string></td>
<td>列出GridFS存储中名称与指定字符串string匹配的文件</td>
</tr>
<tr>
<td>put <filename></td>
<td>将指定的文件从本地文件系统复制到GridFS存储中。可以和–local选项一起使用以获取指定路径下的文件，如local指定的文件名为a.txt，在put中可重命名为b.txt</td>
</tr>
<tr>
<td>get <filename></td>
<td>将指定的文件从GridFS存储复制到本地文件系统。如果将获取的文件重命名存储在本地或者指定文件的存储路径，可以和–local选项一起使用</td>
</tr>
<tr>
<td>delete <filename></td>
<td>从GridFS存储中删除指定的文件</td>
</tr>
<tr>
<td>get_id “&lt;_id&gt;”</td>
<td>将指定_id的文件从GridFS存储复制到本地文件系统</td>
</tr>
<tr>
<td>delete_id “&lt;_id&gt;”</td>
<td>从GridFS存储中删除指定_id的文件</td>
</tr>
</tbody></table>
<p>本章针对GridFS的操作以开启权限认证的MongoDB副本集为环境基础且副本集的主节点为服务器nosql01。如果读者使用MongoDB分片集群为环境基础操作GridFS，则需要设置fs.chunks集合开启分片功能（通常情况下fs.files集合较小，不需要进行分片处理）。</p>
<p>在执行mongofiles命令行工具前，确保使用user_mongo用户启动MongoDB副本集，如系统中没有user_mongo用户可参考第3章内容进行创建。</p>
<h4 id="上传本地系统文件到GridFS"><a href="#上传本地系统文件到GridFS" class="headerlink" title="上传本地系统文件到GridFS"></a>上传本地系统文件到GridFS</h4><p>通过XShell远程连接工具连接服务器，在目录“&#x2F;opt&#x2F;servers&#x2F;mongo_demo&#x2F;”下创建“&#x2F;gridfs&#x2F;datafile&#x2F;”目录，用于存放要上传到GridFS中的文件，具体命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# <span class="built_in">mkdir</span> -p /opt/servers/mongodb_demo/gridfs/datafile</span><br></pre></td></tr></table></figure>

<p>执行命令“cd  &#x2F;opt&#x2F;servers&#x2F;mongodb_demo&#x2F;gridfs&#x2F;datafile”进入该目录后，再通过执行“rz”命令，将文件从Windows系统上传到服务器nosql01中的&#x2F;opt&#x2F;servers&#x2F;mongodb_demo&#x2F;gridfs&#x2F;datafile目录下。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="第6章  MongoDB GridFS.https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202210311956315.png" alt="image-20221031195632251" style="zoom: 67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="第6章  MongoDB GridFS.https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202210312000776.png" alt="image-20221031200003723" style="zoom:67%;" />

<p>待文件上传完成后，可在&#x2F;opt&#x2F;servers&#x2F;mongodb_demo&#x2F;gridfs&#x2F;datafile目录下执行“ll”命令验证文件是否上传成功，效果如图所示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# <span class="built_in">cd</span>  /opt/servers/mongodb_demo/gridfs/datafile</span><br><span class="line">[root@Server01 datafile]# rz</span><br><span class="line"></span><br><span class="line">[root@Server01 datafile]# <span class="built_in">cp</span> -a /opt/mongodb-linux-x86_64-rhel80-4.2.24.tgz .</span><br><span class="line">[root@Server01 datafile]# ll -h</span><br><span class="line">总用量 128M</span><br><span class="line">-rw-r--r-- 1 root root  231 12月 19 2022 mongodb-linux-x86_64-rhel80-4..tgz</span><br><span class="line">-rw-r--r-- 1 root root 128M 11月  1 22:42 mongodb-linux-x86_64-rhel80-4.2.24.tgz</span><br><span class="line">[root@Server01 datafile]# </span><br></pre></td></tr></table></figure>

<p>通过mongofiles命令行工具将文件mongodb.tgz从Linux本地文件系统上传到MongoDB GridFS存储系统中，具体命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost datafile]# mongod -f /usr/local/mongodb/replica_sets/shihanshuors_27017/mongod.conf </span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8232</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost datafile]# mongod -f /usr/local/mongodb/replica_sets/shihanshuors_27018/mongod.conf </span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8292</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost datafile]# mongod -f /usr/local/mongodb/replica_sets/shihanshuors_27019/mongod.conf </span><br><span class="line">about to fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 8355</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@Server01 datafile]# mongofiles --port=27017 -d testfiles -l /opt/servers/mongodb_demo/gridfs/datafile/mongodb-linux-x86_64-rhel80-4..tgz put mongodb.tgz</span><br><span class="line">2024-04-27T20:13:50.638+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">2024-04-27T20:13:55.394+0800	added gridFile: mongodb.tgz</span><br><span class="line"></span><br><span class="line">[root@Server01 datafile]# </span><br></pre></td></tr></table></figure>

<p>将&#x2F;opt&#x2F;servers&#x2F;mongodb_demo&#x2F;gridfs&#x2F;datafile&#x2F;目录下的mongodb-linux-x86_64-rhel80-4..tgz文件上传到MongoDB副本集中GridFS下的testfiles数据库中，并指定上传到GridFS中的文件名称为mongodb.tgz。</p>
<p>待文件上传完成后，查看控制台返回的信息，若出现“added gridFile: mongodb.tgz”信息，则说明我们成功将文件上传至GridFS中。</p>
<h4 id="查看GridFS集合"><a href="#查看GridFS集合" class="headerlink" title="查看GridFS集合"></a>查看GridFS集合</h4><p>GridFS 默认将上传的文件存储在两个集合中。接下来，我们将演示如何在MongoDB副本集中查看这两个集合。</p>
<p>在MongoDB副本集主节点（服务器nosql01）登陆MongoDB客户端，具体命令如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost datafile]# mongo --port=27017</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;aea70697-f6e0-45a2-af89-6be725669087&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-10-31T20:07:14.191+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] </span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] ** WARNING: This replica <span class="built_in">set</span> has a Primary-Secondary-Arbiter architecture, but readConcern:majority is enabled </span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] **          <span class="keyword">for</span> this node. This is not a recommended configuration. Please see </span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] **          https://dochub.mongodb.org/core/psa-disable-rc-majority</span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] </span><br><span class="line">---</span><br><span class="line">Enable MongoDB<span class="string">&#x27;s free cloud-based monitoring service, which will then receive and display</span></span><br><span class="line"><span class="string">metrics about your deployment (disk utilization, CPU, operation statistics, etc).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The monitoring data will be available on a MongoDB website with a unique URL accessible to you</span></span><br><span class="line"><span class="string">and anyone you share the URL with. MongoDB may use this information to make product</span></span><br><span class="line"><span class="string">improvements and to suggest MongoDB products and deployment options to you.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To enable free monitoring, run the following command: db.enableFreeMonitoring()</span></span><br><span class="line"><span class="string">To permanently disable this reminder, run the following command: db.disableFreeMonitoring()</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">shihanshuors:PRIMARY&gt; show dbs</span></span><br><span class="line"><span class="string">admin      0.000GB</span></span><br><span class="line"><span class="string">articledb  0.000GB</span></span><br><span class="line"><span class="string">config     0.000GB</span></span><br><span class="line"><span class="string">local      0.000GB</span></span><br><span class="line"><span class="string">testfiles  0.000GB</span></span><br><span class="line"><span class="string"># 切换到上传文件时指定的GridFS数据库testfiles，查看当前数据库下的所有集合，具体命令如下：</span></span><br><span class="line"><span class="string">shihanshuors:PRIMARY&gt; use testfiles</span></span><br><span class="line"><span class="string">switched to db testfiles</span></span><br><span class="line"><span class="string">shihanshuors:PRIMARY&gt; show collections</span></span><br><span class="line"><span class="string">fs.chunks</span></span><br><span class="line"><span class="string">fs.files</span></span><br><span class="line"><span class="string">shihanshuors:PRIMARY&gt; </span></span><br></pre></td></tr></table></figure>

<p>执行查看所有集合命令后，从客户端返回的信息中可以看出数据库testfiles下包含两个集合分别为fs.chunks和fs.files。</p>
<p>下面，演示查看集合fs.files中文件的元数据信息，具体命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; use testfiles</span><br><span class="line"><span class="comment">#查看GridFS中文件的元数据信息</span></span><br><span class="line">shihanshuors:PRIMARY&gt; db.getCollection(<span class="string">&#x27;fs.files&#x27;</span>).find().<span class="function"><span class="title">pretty</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;662cebfecd4641d8a99bc522&quot;</span>),</span><br><span class="line">	<span class="string">&quot;length&quot;</span> : NumberLong(133445425),</span><br><span class="line">	<span class="string">&quot;chunkSize&quot;</span> : 261120,</span><br><span class="line">	<span class="string">&quot;uploadDate&quot;</span> : ISODate(<span class="string">&quot;2024-04-27T12:13:55.251Z&quot;</span>),</span><br><span class="line">	<span class="string">&quot;filename&quot;</span> : <span class="string">&quot;mongodb.tgz&quot;</span>,</span><br><span class="line">	<span class="string">&quot;metadata&quot;</span> : &#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">shihanshuors:PRIMARY&gt; db.fs.files.find().<span class="function"><span class="title">pretty</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;662cebfecd4641d8a99bc522&quot;</span>),</span><br><span class="line">	<span class="string">&quot;length&quot;</span> : NumberLong(133445425),</span><br><span class="line">	<span class="string">&quot;chunkSize&quot;</span> : 261120,</span><br><span class="line">	<span class="string">&quot;uploadDate&quot;</span> : ISODate(<span class="string">&quot;2024-04-27T12:13:55.251Z&quot;</span>),</span><br><span class="line">	<span class="string">&quot;filename&quot;</span> : <span class="string">&quot;mongodb.tgz&quot;</span>,</span><br><span class="line">	<span class="string">&quot;metadata&quot;</span> : &#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行查看GridFS中文件的元数据信息命令后，从客户端返回的信息中可以看出， GridFS中包含一个文件的元数据信息，即已上传的文件mongodb.tgz的元数据信息。</p>
<p>下面，演示查看文件mongodb.tgz被分割后存储在集合fs.chunks中的总块数，具体命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shihanshuors:PRIMARY&gt; db.getCollection(<span class="string">&#x27;fs.chunks&#x27;</span>).find(&#123;files_id:&#123;<span class="variable">$in</span>:[ObjectId(<span class="string">&quot;662cebfecd4641d8a99bc522&quot;</span>)]&#125;&#125;).count()</span><br><span class="line">512</span><br><span class="line">shihanshuors:PRIMARY&gt;</span><br></pre></td></tr></table></figure>

<p>上述命令中，统计在集合fs.chunks中mongodb.tgz的总块数，通过在find()方法中指定files_id为ObjectId(“662cebfecd4641d8a99bc522”（在6.2小节中有所说明，文件块中的files_id与文件元数据信息中的_id相对应），查询出集合fs.chunks中文件mongodb.tgz的总块数为512。因为此时文件是133445425</p>
<p>133445425&#x2F;1024&#x2F;255&#x3D;511.05,因此使用512个chunks</p>
<h4 id="查看GridFS中的文件"><a href="#查看GridFS中的文件" class="headerlink" title="查看GridFS中的文件"></a>查看GridFS中的文件</h4><p>查看GridFS中数据库为testfiles下的所有文件，执行如下命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 datafile]# mongofiles --port=27017 -d testfiles list</span><br><span class="line">2024-04-27T20:24:48.624+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">mongodb.tgz	133445425</span><br><span class="line">[root@Server01 datafile]# </span><br></pre></td></tr></table></figure>

<p>上述命令中，list表示查看GridFS中的所有文件，执行完上述命令后，会返回有关文件的基本信息</p>
<p>条件查询GridFS中数据库为testfiles下的指定文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 datafile]# mongofiles --port=27017 -d testfiles search <span class="string">&quot;mon&quot;</span></span><br><span class="line">2024-04-27T20:26:04.167+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">mongodb.tgz	133445425</span><br><span class="line">[root@Server01 datafile]# </span><br></pre></td></tr></table></figure>

<p>上述命令中 search”mon” 表示检索数据库中文件名包含”mon”的文件，执行完上述命令后，会返回符合检索条件文件的基本信息，即文件名“mongodb.tgz”和文件大小“133445425”。</p>
<h4 id="下载GridFS中的文件"><a href="#下载GridFS中的文件" class="headerlink" title="下载GridFS中的文件"></a>下载GridFS中的文件</h4><p>将GridFS中存储的文件下载到本地文件系统中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 datafile]# mongofiles --port=27017 -d testfiles get mongodb.tgz -l /opt/servers/mongodb_demo/gridfs/datafile/local_mongodb.tgz</span><br><span class="line">2024-04-27T20:27:15.247+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">2024-04-27T20:27:15.459+0800	finished writing to /opt/servers/mongodb_demo/gridfs/datafile/local_mongodb.tgz</span><br><span class="line"></span><br><span class="line">[root@Server01 datafile]# ll</span><br><span class="line">总用量 260640</span><br><span class="line">-rw-r--r-- 1 root root 133445425 4月  27 20:27 local_mongodb.tgz</span><br><span class="line">-rw-r--r-- 1 root root 133445425 4月  27 19:55 mongodb-linux-x86_64-rhel80-4..tgz</span><br><span class="line">[root@Server01 datafile]#</span><br></pre></td></tr></table></figure>

<p>上述命令中，get参数用于指定要下载GridFS中的文件名；<u>-l 参数用于指定将文件下载到本地文件系统的目录并将文件名修改</u>为local_mongodb.tgz。如不指定“-l”选项则默认将文件保存到当前目录下，并且名称不变。</p>
<p>执行完上述命令后，会返回文件下载后存储在本地文件系统的目录信息，即“finished writing to……”。</p>
<h4 id="删除GridFS中的文件"><a href="#删除GridFS中的文件" class="headerlink" title="删除GridFS中的文件"></a>删除GridFS中的文件</h4><p>通过指定GridFS中的文件名删除对应文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 datafile]# mongofiles --port=27017 -d testfiles delete mongodb.tgz</span><br><span class="line">2024-04-27T20:28:11.558+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">2024-04-27T20:28:11.620+0800	successfully deleted all instances of <span class="string">&#x27;mongodb.tgz&#x27;</span> from GridFS</span><br><span class="line"></span><br><span class="line">[root@Server01 datafile]# ll</span><br><span class="line">总用量 260640</span><br><span class="line">-rw-r--r-- 1 root root 133445425 4月  27 20:27 local_mongodb.tgz</span><br><span class="line">-rw-r--r-- 1 root root 133445425 4月  27 19:55 mongodb-linux-x86_64-rhel80-4..tgz</span><br><span class="line">[root@Server01 datafile]# </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Server01 datafile]# mongofiles --port=27017 -d testfiles search <span class="string">&quot;mongo&quot;</span></span><br><span class="line">2024-04-27T20:28:55.247+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">[root@Server01 datafile]# mongofiles --port=27017 -d testfiles list</span><br><span class="line">2024-04-27T20:29:08.518+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">[root@Server01 datafile]# </span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否删除成功</span></span><br><span class="line">[root@localhost datafile]# mongo --port=27017</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;aea70697-f6e0-45a2-af89-6be725669087&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-10-31T20:07:14.191+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-10-31T20:07:14.192+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] </span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] ** WARNING: This replica <span class="built_in">set</span> has a Primary-Secondary-Arbiter architecture, but readConcern:majority is enabled </span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] **          <span class="keyword">for</span> this node. This is not a recommended configuration. Please see </span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] **          https://dochub.mongodb.org/core/psa-disable-rc-majority</span><br><span class="line">2022-10-31T20:07:14.217+0800 I  REPL     [replexec-0] </span><br><span class="line">---</span><br><span class="line">Enable MongoDB<span class="string">&#x27;s free cloud-based monitoring service, which will then receive and display</span></span><br><span class="line"><span class="string">metrics about your deployment (disk utilization, CPU, operation statistics, etc).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The monitoring data will be available on a MongoDB website with a unique URL accessible to you</span></span><br><span class="line"><span class="string">and anyone you share the URL with. MongoDB may use this information to make product</span></span><br><span class="line"><span class="string">improvements and to suggest MongoDB products and deployment options to you.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To enable free monitoring, run the following command: db.enableFreeMonitoring()</span></span><br><span class="line"><span class="string">To permanently disable this reminder, run the following command: db.disableFreeMonitoring()</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">shihanshuors:PRIMARY&gt; show dbs</span></span><br><span class="line"><span class="string">admin      0.000GB</span></span><br><span class="line"><span class="string">articledb  0.000GB</span></span><br><span class="line"><span class="string">config     0.000GB</span></span><br><span class="line"><span class="string">local      0.000GB</span></span><br><span class="line"><span class="string">testfiles  0.000GB</span></span><br><span class="line"><span class="string">shihanshuors:PRIMARY&gt; use testfiles</span></span><br><span class="line"><span class="string">switched to db testfiles</span></span><br><span class="line"><span class="string">shihanshuors:PRIMARY&gt; show collections</span></span><br><span class="line"><span class="string">fs.chunks</span></span><br><span class="line"><span class="string">fs.files</span></span><br><span class="line"><span class="string">shihanshuors:PRIMARY&gt; db.getCollection(&#x27;</span>fs.files<span class="string">&#x27;).find().pretty()</span></span><br><span class="line"><span class="string">shihanshuors:PRIMARY&gt;  </span></span><br></pre></td></tr></table></figure>

<h3 id="使用Java操作MongoDB-GridFS"><a href="#使用Java操作MongoDB-GridFS" class="headerlink" title="使用Java操作MongoDB GridFS"></a>使用Java操作MongoDB GridFS</h3><h4 id="1-创建Maven项目"><a href="#1-创建Maven项目" class="headerlink" title="1. 创建Maven项目"></a>1. 创建Maven项目</h4><p>单击“Create New Project”→“Maven”，选择创建一个Maven项目，命名为GridFS。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="第6章  MongoDB GridFS.https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091452982.png" alt="image-20221109145250843" style="zoom: 80%;" />

<h4 id="2-导入依赖。"><a href="#2-导入依赖。" class="headerlink" title="2. 导入依赖。"></a>2. 导入依赖。</h4><p>在项目中配置pom.xml文件，也就是引入MongoDB相关的依赖和单元测试的依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nosql_chapter06<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--单元测试依赖--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--java操作mongoDB的驱动依赖--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.mongodb/mongo-java-driver --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mongodb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mongo-java-driver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-创建资源文件"><a href="#3-创建资源文件" class="headerlink" title="3. 创建资源文件"></a>3. 创建资源文件</h4><p>指定MongoDB相关参数。在项目GridFS的目录&#x2F;src&#x2F;main&#x2F;resources下创建一个名为mongodb.properties文件，该文件用于存储连接MongoDB中GridFS所需要的参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">host=<span class="number">192.168</span><span class="number">.24</span><span class="number">.105</span></span><br><span class="line">port=<span class="number">27017</span></span><br><span class="line">dbname=testfiles</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="第6章  MongoDB GridFS.https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091500619.png" alt="image-20221109150023549" style="zoom:80%;" />

<h4 id="4-创建Java工具类"><a href="#4-创建Java工具类" class="headerlink" title="4. 创建Java工具类"></a>4. 创建Java工具类</h4><p>连接MongoDB副本集中的GridFS。在项目GridFS目录&#x2F;src&#x2F;main&#x2F;java下创建一个名为com.itcast.mongodb包，并在该包下创建MongoUtils.java文件，该文件用于编写Java连接MongoDB副本集中GridFS的工具类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itcast.mongodb;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: Joker</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/11/915:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> com.mongodb.MongoClientSettings;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.MongoCredential;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.ServerAddress;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.MongoClient;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.MongoClients;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.MongoDatabase;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.gridfs.GridFSBucket;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.gridfs.GridFSBuckets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Properties properties;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String port;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String dbname;</span><br><span class="line">    <span class="comment">//private static String username;</span></span><br><span class="line">    <span class="comment">//private static String password;</span></span><br><span class="line">    <span class="comment">//private static String source;</span></span><br><span class="line"><span class="comment">//1.创建一个静态代码块，用于初始化工具类中的静态变量，该静态代码块在类加载过程中的初始化阶段执行，并且只执行一次</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//判断properties集合对象是否为空，为空则创建一个集合对象</span></span><br><span class="line">        <span class="keyword">if</span> (properties == <span class="literal">null</span>) &#123;</span><br><span class="line">            properties = <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		由于我们调用load方法，而load方法底层抛出了一个IOException异常，此异常为编译时期异常</span></span><br><span class="line"><span class="comment">		所以，我们调用load方法时，需要处理底层抛过来的异常</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建一个InputStream字节输入流对象，用于接收mongodb.properties配置文件中的配置参数</span></span><br><span class="line">            stream = MongoUtils.class.getClassLoader().getResourceAsStream</span><br><span class="line">                    (<span class="string">&quot;mongodb.properties&quot;</span>);</span><br><span class="line">            <span class="comment">//properties集合对象调用load()方法，将配置参数加载到properties集合中</span></span><br><span class="line">            properties.load(stream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//根据mongodb.properties配置文件中的key，获取value值</span></span><br><span class="line">        host = properties.getProperty(<span class="string">&quot;host&quot;</span>);</span><br><span class="line">        port = properties.getProperty(<span class="string">&quot;port&quot;</span>);</span><br><span class="line">        dbname = properties.getProperty(<span class="string">&quot;dbname&quot;</span>);</span><br><span class="line">        <span class="comment">//source = properties.getProperty(&quot;source&quot;);</span></span><br><span class="line">        <span class="comment">//username = properties.getProperty(&quot;username&quot;);</span></span><br><span class="line">        <span class="comment">//password = properties.getProperty(&quot;password&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.定义一个getMongoClient()方法，用于获取MongoDB副本集的连接对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MongoClient <span class="title function_">getMongoClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//指定用户名、用户认证书库、密码进行身份验证</span></span><br><span class="line">        <span class="comment">//MongoCredential credential = MongoCredential</span></span><br><span class="line">        <span class="comment">//        .createCredential(username, source, password.toCharArray());</span></span><br><span class="line">        <span class="comment">//连接mongodb副本集</span></span><br><span class="line">        <span class="type">MongoClient</span> <span class="variable">mongoClient</span> <span class="operator">=</span> MongoClients.create(</span><br><span class="line">                MongoClientSettings.builder()</span><br><span class="line">                        .applyToClusterSettings(builder -&gt;</span><br><span class="line">                                builder.hosts(</span><br><span class="line">                                        Arrays.asList(</span><br><span class="line">                                                <span class="keyword">new</span> <span class="title class_">ServerAddress</span>(<span class="string">&quot;192.168.24.105&quot;</span>, <span class="number">27017</span>)</span><br><span class="line">                                        )))</span><br><span class="line">                        <span class="comment">//.credential(credential)</span></span><br><span class="line">                        .build());</span><br><span class="line">        <span class="keyword">return</span> mongoClient;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.定义一个getGridFSConn()方法，用于实现连接指定的MongoDB GridFS中的数据库</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GridFSBucket <span class="title function_">getGridFSConn</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MongoClient</span> <span class="variable">mongoClient</span> <span class="operator">=</span> getMongoClient();</span><br><span class="line">        <span class="type">MongoDatabase</span> <span class="variable">mongoDatabase</span> <span class="operator">=</span> mongoClient.getDatabase(dbname);</span><br><span class="line">        <span class="comment">//获取GridFS中数据库连接</span></span><br><span class="line">        <span class="type">GridFSBucket</span> <span class="variable">gridFSBucket</span> <span class="operator">=</span> GridFSBuckets.create(mongoDatabase);</span><br><span class="line">        <span class="keyword">return</span> gridFSBucket;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-创建Java测试类"><a href="#5-创建Java测试类" class="headerlink" title="5. 创建Java测试类"></a>5. 创建Java测试类</h4><p>操作GridFS。在项目目录&#x2F;src&#x2F;test&#x2F;java下创建一个名为TestGridFS.java的文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itcast.mongodb;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: Joker</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/11/915:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> com.itcast.mongodb.MongoUtils;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.Block;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.gridfs.GridFSBucket;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.gridfs.GridFSDownloadStream;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.gridfs.GridFSUploadStream;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.gridfs.model.GridFSFile;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.gridfs.model.GridFSUploadOptions;</span><br><span class="line"><span class="keyword">import</span> org.bson.BsonObjectId;</span><br><span class="line"><span class="keyword">import</span> org.bson.Document;</span><br><span class="line"><span class="keyword">import</span> org.bson.types.ObjectId;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestGridFS</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getFiles</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">GridFSBucket</span> <span class="variable">gridFSBucket</span> <span class="operator">=</span> MongoUtils.getGridFSConn();</span><br><span class="line">        gridFSBucket.find().forEach(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Block</span>&lt;GridFSFile&gt;() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(<span class="keyword">final</span> GridFSFile gridFSFile)</span> &#123;</span><br><span class="line">                        System.out.println(</span><br><span class="line">                                <span class="string">&quot;文件名：&quot;</span>+gridFSFile.getFilename()+<span class="string">&quot; &quot;</span></span><br><span class="line">                                        +<span class="string">&quot;文件大小：&quot;</span>+gridFSFile.getLength()+<span class="string">&quot; &quot;</span></span><br><span class="line">                                        +<span class="string">&quot;文件id:&quot;</span>+gridFSFile.getObjectId().toHexString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadFile</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">GridFSBucket</span> <span class="variable">gridFSBucket</span> <span class="operator">=</span> MongoUtils.getGridFSConn();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//配置上传文件的参数</span></span><br><span class="line">            <span class="type">GridFSUploadOptions</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GridFSUploadOptions</span>()</span><br><span class="line">                    .chunkSizeBytes(<span class="number">358400</span>);<span class="comment">//定义块大小</span></span><br><span class="line">            <span class="comment">//创建“上传文件流对象”GridFSUploadStream，并指定配置参数和文件在GridFS上显示的名称</span></span><br><span class="line">            <span class="type">GridFSUploadStream</span> <span class="variable">uploadStream</span> <span class="operator">=</span> gridFSBucket.openUploadStream(<span class="string">&quot;mongodb.tgz&quot;</span>, options);</span><br><span class="line">            <span class="comment">//一次性读取文件，将文件转为Byte[]包含文件内容的字节数组</span></span><br><span class="line">            <span class="type">byte</span>[] data = Files.readAllBytes(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\我的课程\\2023-2024第二学期-NoSQL数据库技术\\软件\\mongodb-linux-x86_64-rhel80-4..tgz&quot;</span>).toPath());</span><br><span class="line">            <span class="comment">//以字节数组形式上传文件流到GridFS</span></span><br><span class="line">            uploadStream.write(data);</span><br><span class="line">            <span class="comment">//手动关闭关闭流</span></span><br><span class="line">            uploadStream.close();</span><br><span class="line">            System.out.println(<span class="string">&quot;文件id为: &quot;</span> + uploadStream.getObjectId().toHexString());</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">            <span class="comment">// handle exception</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">downlodFile</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">GridFSBucket</span> <span class="variable">gridFSBucket</span> <span class="operator">=</span> MongoUtils.getGridFSConn();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建“文件输出流对象”streamToDownloadTo，指定下载的本地路径及文件名</span></span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">streamToDownloadTo</span> <span class="operator">=</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;C:\\Users\\Yico\\Desktop\\down_mongodb.tgz&quot;</span>);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 通过GridFS中的文件名称下载文件，如果有重名文件则默认下载最新版</span></span><br><span class="line"><span class="comment">             *  GridFSDownloadOptions downloadOptions = new GridFSDownloadOptions().revision(0);</span></span><br><span class="line"><span class="comment">             *  gridFSBucket.downloadToStream(&quot;Reids.avi&quot;, streamToDownloadTo, downloadOptions);</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">//通过GridFS中的文件id以数据流的形式下载文件，并将数据流传给输出流对象streamToDownloadTo</span></span><br><span class="line">            gridFSBucket.downloadToStream(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ObjectId</span>(<span class="string">&quot;662e26e70244657c5eeeb434&quot;</span>), streamToDownloadTo);</span><br><span class="line">            <span class="comment">//关闭流</span></span><br><span class="line">            streamToDownloadTo.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// handle exception</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">renameFile</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">GridFSBucket</span> <span class="variable">gridFSBucket</span> <span class="operator">=</span> MongoUtils.getGridFSConn();</span><br><span class="line">        gridFSBucket.rename(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ObjectId</span>(<span class="string">&quot;662e26e70244657c5eeeb434&quot;</span>),<span class="string">&quot;GridFS_NEW_mongodb.tgz&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delFile</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">GridFSBucket</span> <span class="variable">gridFSBucket</span> <span class="operator">=</span> MongoUtils.getGridFSConn();</span><br><span class="line">        gridFSBucket.delete(<span class="keyword">new</span> <span class="title class_">ObjectId</span>(<span class="string">&quot;662e26e70244657c5eeeb434&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（1）上传文件"><a href="#（1）上传文件" class="headerlink" title="（1）上传文件"></a>（1）上传文件</h5><p>![image-20221109152139663](第6章  MongoDB GridFS.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091521754.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091521754.png</a>)</p>
<p>验证是否上传成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost datafile]#  mongofiles --port=27017 -d testfiles list</span><br><span class="line">2022-11-09T15:22:01.119+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">GridFS.mp4	47780752</span><br><span class="line">[root@localhost datafile]# </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mongo --port=27017</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;4f5e348d-0551-431a-bd11-0da3ef37bcaa&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">---</span><br><span class="line">Enable MongoDB<span class="string">&#x27;s free cloud-based monitoring service, which will then receive and display</span></span><br><span class="line"><span class="string">metrics about your deployment (disk utilization, CPU, operation statistics, etc).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The monitoring data will be available on a MongoDB website with a unique URL accessible to you</span></span><br><span class="line"><span class="string">and anyone you share the URL with. MongoDB may use this information to make product</span></span><br><span class="line"><span class="string">improvements and to suggest MongoDB products and deployment options to you.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To enable free monitoring, run the following command: db.enableFreeMonitoring()</span></span><br><span class="line"><span class="string">To permanently disable this reminder, run the following command: db.disableFreeMonitoring()</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt; show dbs</span></span><br><span class="line"><span class="string">admin      0.000GB</span></span><br><span class="line"><span class="string">articledb  0.000GB</span></span><br><span class="line"><span class="string">config     0.000GB</span></span><br><span class="line"><span class="string">cuibindb   0.000GB</span></span><br><span class="line"><span class="string">local      0.000GB</span></span><br><span class="line"><span class="string">testfiles  0.039GB</span></span><br><span class="line"><span class="string">&gt; use testfiles</span></span><br><span class="line"><span class="string">switched to db testfiles</span></span><br><span class="line"><span class="string">&gt; db.getCollection(&#x27;</span>fs.files<span class="string">&#x27;).find().pretty()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;_id&quot; : ObjectId(&quot;636b54a92f0ddd638f185e8e&quot;),</span></span><br><span class="line"><span class="string">	&quot;filename&quot; : &quot;GridFS.mp4&quot;,</span></span><br><span class="line"><span class="string">	&quot;length&quot; : NumberLong(47780752),</span></span><br><span class="line"><span class="string">	&quot;chunkSize&quot; : 358400,</span></span><br><span class="line"><span class="string">	&quot;uploadDate&quot; : ISODate(&quot;2022-11-09T07:20:10.709Z&quot;),</span></span><br><span class="line"><span class="string">	&quot;md5&quot; : &quot;8c36ca6ecc0065ca1ec5278b1ad0ccd6&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&gt; </span></span><br></pre></td></tr></table></figure>

<h5 id="（2）下载文件"><a href="#（2）下载文件" class="headerlink" title="（2）下载文件"></a>（2）下载文件</h5><p>![image-20221109152906589](第6章  MongoDB GridFS.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091529683.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091529683.png</a>)</p>
<p>验证是否下载成功</p>
<p>![image-20221109153118559](第6章  MongoDB GridFS.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091531617.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091531617.png</a>)</p>
<h5 id="（3）重命名"><a href="#（3）重命名" class="headerlink" title="（3）重命名"></a>（3）重命名</h5><p>![image-20221109153234812](第6章  MongoDB GridFS.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091532889.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091532889.png</a>)</p>
<p>验证是否更名成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost datafile]#  mongofiles --port=27017 -d testfiles list</span><br><span class="line">2022-11-09T15:34:10.802+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">GridFS_new.mp4	47780752</span><br><span class="line">[root@localhost datafile]# </span><br><span class="line"></span><br><span class="line">[root@Server01 ~]# mongofiles --port=27017 -d testfiles search <span class="string">&quot;mon&quot;</span></span><br><span class="line">2024-04-28T18:38:46.546+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">GridFS_NEW_mongodb.tgz	133445425</span><br><span class="line">[root@Server01 ~]# mongofiles --port=27018 -d testfiles search <span class="string">&quot;mon&quot;</span></span><br><span class="line">2024-04-28T18:38:51.861+0800	connected to: mongodb://localhost:27018/</span><br><span class="line">GridFS_NEW_mongodb.tgz	133445425</span><br><span class="line">[root@Server01 ~]# </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mongo --port=27017</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;7441b7ce-b624-4374-9a9a-4b126319dbe2&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">---</span><br><span class="line">Enable MongoDB<span class="string">&#x27;s free cloud-based monitoring service, which will then receive and display</span></span><br><span class="line"><span class="string">metrics about your deployment (disk utilization, CPU, operation statistics, etc).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The monitoring data will be available on a MongoDB website with a unique URL accessible to you</span></span><br><span class="line"><span class="string">and anyone you share the URL with. MongoDB may use this information to make product</span></span><br><span class="line"><span class="string">improvements and to suggest MongoDB products and deployment options to you.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To enable free monitoring, run the following command: db.enableFreeMonitoring()</span></span><br><span class="line"><span class="string">To permanently disable this reminder, run the following command: db.disableFreeMonitoring()</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt; use testfiles</span></span><br><span class="line"><span class="string">switched to db testfiles</span></span><br><span class="line"><span class="string">&gt; db.getCollection(&#x27;</span>fs.files<span class="string">&#x27;).find().pretty()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;_id&quot; : ObjectId(&quot;636b54a92f0ddd638f185e8e&quot;),</span></span><br><span class="line"><span class="string">	&quot;filename&quot; : &quot;GridFS_new.mp4&quot;,</span></span><br><span class="line"><span class="string">	&quot;length&quot; : NumberLong(47780752),</span></span><br><span class="line"><span class="string">	&quot;chunkSize&quot; : 358400,</span></span><br><span class="line"><span class="string">	&quot;uploadDate&quot; : ISODate(&quot;2022-11-09T07:20:10.709Z&quot;),</span></span><br><span class="line"><span class="string">	&quot;md5&quot; : &quot;8c36ca6ecc0065ca1ec5278b1ad0ccd6&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&gt; </span></span><br></pre></td></tr></table></figure>

<h5 id="（4）删除文件"><a href="#（4）删除文件" class="headerlink" title="（4）删除文件"></a>（4）删除文件</h5><p>![image-20221109153615981](第6章  MongoDB GridFS.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091536066.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202211091536066.png</a>)</p>
<p>验证是否删除成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost datafile]#  mongofiles --port=27017 -d testfiles list</span><br><span class="line">2022-11-09T15:36:52.141+0800	connected to: mongodb://localhost:27017/</span><br><span class="line">[root@localhost datafile]# </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mongo --port=27017</span><br><span class="line">MongoDB shell version v4.2.18</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">&quot;id&quot;</span> : UUID(<span class="string">&quot;7441b7ce-b624-4374-9a9a-4b126319dbe2&quot;</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.18</span><br><span class="line">Server has startup warnings: </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, <span class="built_in">which</span> is not recommended.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">&#x27;always&#x27;</span>.</span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] **        We suggest setting it to <span class="string">&#x27;never&#x27;</span></span><br><span class="line">2022-11-09T11:13:31.877+0800 I  CONTROL  [initandlisten] </span><br><span class="line">---</span><br><span class="line">Enable MongoDB<span class="string">&#x27;s free cloud-based monitoring service, which will then receive and display</span></span><br><span class="line"><span class="string">metrics about your deployment (disk utilization, CPU, operation statistics, etc).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The monitoring data will be available on a MongoDB website with a unique URL accessible to you</span></span><br><span class="line"><span class="string">and anyone you share the URL with. MongoDB may use this information to make product</span></span><br><span class="line"><span class="string">improvements and to suggest MongoDB products and deployment options to you.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To enable free monitoring, run the following command: db.enableFreeMonitoring()</span></span><br><span class="line"><span class="string">To permanently disable this reminder, run the following command: db.disableFreeMonitoring()</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt; use testfiles</span></span><br><span class="line"><span class="string">switched to db testfiles</span></span><br><span class="line"><span class="string">&gt; db.getCollection(&#x27;</span>fs.files<span class="string">&#x27;).find().pretty()</span></span><br><span class="line"><span class="string">&gt; </span></span><br></pre></td></tr></table></figure>



<h2 id="十五、键值对存储数据库Redis"><a href="#十五、键值对存储数据库Redis" class="headerlink" title="十五、键值对存储数据库Redis"></a>十五、键值对存储数据库Redis</h2><h3 id="Redis的概述"><a href="#Redis的概述" class="headerlink" title="Redis的概述"></a>Redis的概述</h3><h4 id="Redis简介"><a href="#Redis简介" class="headerlink" title="Redis简介"></a>Redis简介</h4><p><strong>Re</strong>mote <strong>Di</strong>ctionary <strong>S</strong>erver，简称Redis，即<strong>远程字典服务器</strong>，它是一个开源的、高性能的、基于<u>键值对</u>的缓存与存储数据库，并且通过提供多种键值数据结构来适应不同场景下的缓存与存储需求。是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave(主从)同步。免费和开源！</p>
<p>![image-20220414215804249](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142158449.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142158449.png</a>)</p>
<h4 id="Redis能干什么？"><a href="#Redis能干什么？" class="headerlink" title="Redis能干什么？"></a>Redis能干什么？</h4><p>1、内存存储、持久化，内存中是断电即失、所以说持久化很重要（两种持久化策略：rdb、aof） </p>
<p>2、效率高，可以用于高速缓存</p>
<p>3、发布订阅系统</p>
<p>4、地图信息分析</p>
<p>5、计时器、计数器（浏览量！）</p>
<p>6、……..</p>
<h4 id="学习中需要用到的东西"><a href="#学习中需要用到的东西" class="headerlink" title="学习中需要用到的东西"></a>学习中需要用到的东西</h4><p>1、官网：<a target="_blank" rel="noopener" href="https://redis.io/">https://redis.io</a></p>
<p>2、![image-20220414220330277](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142203469.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142203469.png</a>)</p>
<p>3、中文网：<a target="_blank" rel="noopener" href="http://www.redis.cn/">http://www.redis.cn/</a></p>
<p>4、下载地址：通过官网下载即可！</p>
<p>![image-20220414220355486](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142203638.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142203638.png</a>)</p>
<p>注意：Windows平台下的redis在 Github上下载（停更很久了！）</p>
<p><strong>Redis推荐都是在Linux服务器上搭建的，我们是基于Linux学习！</strong></p>
<h3 id="Redis支持的数据结构"><a href="#Redis支持的数据结构" class="headerlink" title="Redis支持的数据结构"></a>Redis支持的数据结构</h3><p>Redis数据库提供了多种数据结构，其中最常见的数据结构（五大数据类型，放在安装redis环境之后讲）有String（字符串）、List（列表）、Set（集合）、Hash（散列）、Zset&#x2F;Sorted Sets（有序集合）。</p>
<p>我们会在7.4 使用redis-cli操作五大数据类型中具体讲解。</p>
<h3 id="Redis的部署"><a href="#Redis的部署" class="headerlink" title="Redis的部署"></a>Redis的部署</h3><h4 id="基于Linux平台"><a href="#基于Linux平台" class="headerlink" title="基于Linux平台"></a>基于Linux平台</h4><p>1、拷贝或下载安装包！ redis-6.2.6.tar.gz </p>
<p>![image-20220414223030831](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142230072.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142230072.png</a>)</p>
<p>2、解压Redis的安装包！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# <span class="built_in">cd</span> /opt/</span><br><span class="line">[root@localhost opt]# ll</span><br><span class="line">总用量 132800</span><br><span class="line">drwxr-xr-x  3 root root       135 3月   4 15:21 mongodb-linux-x86_64-rhel70-4.2.18</span><br><span class="line">-rw-r--r--  1 root root 133508918 2月  22 10:13 mongodb-linux-x86_64-rhel70-4.2.18.tgz</span><br><span class="line">-rw-r--r--  1 root root   2476542 2月  22 10:06 redis-6.2.6.tar.gz</span><br><span class="line">drwxr-xr-x. 3 root root        26 2月  21 22:25 rh</span><br><span class="line">[root@localhost opt]# tar -zxvf redis-6.2.6.tar.gz </span><br></pre></td></tr></table></figure>

<p>3、进入解压后的文件，可以看到我们redis的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# <span class="built_in">cd</span> redis-6.2.6/</span><br><span class="line">[root@localhost redis-6.2.6]# ll</span><br><span class="line">总用量 236</span><br><span class="line">-rw-rw-r--  1 root root 33624 10月  4 2021 00-RELEASENOTES</span><br><span class="line">-rw-rw-r--  1 root root    51 10月  4 2021 BUGS</span><br><span class="line">-rw-rw-r--  1 root root  5026 10月  4 2021 CONDUCT</span><br><span class="line">-rw-rw-r--  1 root root  3384 10月  4 2021 CONTRIBUTING</span><br><span class="line">-rw-rw-r--  1 root root  1487 10月  4 2021 COPYING</span><br><span class="line">drwxrwxr-x  7 root root   145 10月  4 2021 deps</span><br><span class="line">-rw-rw-r--  1 root root    11 10月  4 2021 INSTALL</span><br><span class="line">-rw-rw-r--  1 root root   151 10月  4 2021 Makefile</span><br><span class="line">-rw-rw-r--  1 root root  6888 10月  4 2021 MANIFESTO</span><br><span class="line">-rw-rw-r--  1 root root 21567 10月  4 2021 README.md</span><br><span class="line">-rw-rw-r--  1 root root 93724 10月  4 2021 redis.conf</span><br><span class="line">-rwxrwxr-x  1 root root   275 10月  4 2021 runtest</span><br><span class="line">-rwxrwxr-x  1 root root   279 10月  4 2021 runtest-cluster</span><br><span class="line">-rwxrwxr-x  1 root root  1079 10月  4 2021 runtest-moduleapi</span><br><span class="line">-rwxrwxr-x  1 root root   281 10月  4 2021 runtest-sentinel</span><br><span class="line">-rw-rw-r--  1 root root 13768 10月  4 2021 sentinel.conf</span><br><span class="line">drwxrwxr-x  3 root root  4096 10月  4 2021 src</span><br><span class="line">drwxrwxr-x 11 root root   182 10月  4 2021 tests</span><br><span class="line">-rw-rw-r--  1 root root  3055 10月  4 2021 TLS.md</span><br><span class="line">drwxrwxr-x  9 root root  4096 10月  4 2021 utils</span><br></pre></td></tr></table></figure>

<p>4、基本的环境安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">OFFLOAD_TARGET_NAMES=nvptx-none</span><br><span class="line">OFFLOAD_TARGET_DEFAULT=1</span><br><span class="line">Target: x86_64-redhat-linux</span><br><span class="line">Configured with: ../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/opt/rh/gcc-toolset-11/root/usr --mandir=/opt/rh/gcc-toolset-11/root/usr/share/man --infodir=/opt/rh/gcc-toolset-11/root/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-shared --enable-threads=posix --enable-checking=release --enable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --with-isl=/builddir/build/BUILD/gcc-11.2.1-20210728/obj-x86_64-redhat-linux/isl-install --enable-offload-targets=nvptx-none --without-cuda-driver --enable-gnu-indirect-function --enable-cet --with-tune=generic --with-arch_32=x86-64 --build=x86_64-redhat-linux</span><br><span class="line">Thread model: posix</span><br><span class="line">Supported LTO compression algorithms: zlib zstd</span><br><span class="line">gcc version 11.2.1 20210728 (Red Hat 11.2.1-1) (GCC) </span><br><span class="line">[root@Server01 ~]# </span><br></pre></td></tr></table></figure>

<p> 如果gcc的版本比较低，则安装新版本的gcc       </p>
<p>（注意：联网情况下最后升级到最新版本、如果使用本地yum源，安装redis6以上版本必须升级gcc）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# yum install gcc-c++</span><br><span class="line"></span><br><span class="line">[root@Server01 ~]# gcc -v</span><br><span class="line">使用内建 specs。</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/8/lto-wrapper</span><br><span class="line">OFFLOAD_TARGET_NAMES=nvptx-none</span><br><span class="line">OFFLOAD_TARGET_DEFAULT=1</span><br><span class="line">目标：x86_64-redhat-linux</span><br><span class="line">配置为：../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-shared --enable-threads=posix --enable-checking=release --enable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --with-isl --disable-libmpx --enable-offload-targets=nvptx-none --without-cuda-driver --enable-gnu-indirect-function --enable-cet --with-tune=generic --with-arch_32=x86-64 --build=x86_64-redhat-linux</span><br><span class="line">线程模型：posix</span><br><span class="line">gcc 版本 8.5.0 20210514 (Red Hat 8.5.0-4) (GCC) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.更新yum源为阿里云的源</span><br><span class="line"></span><br><span class="line">[root@Server01 opt]# wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class="line">--2023-08-30 22:56:18--  http://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class="line">正在解析主机 mirrors.aliyun.com (mirrors.aliyun.com)... 121.29.38.206, 220.194.69.111, 119.188.91.238, ...</span><br><span class="line">正在连接 mirrors.aliyun.com (mirrors.aliyun.com)|121.29.38.206|:80... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：2590 (2.5K) [application/octet-stream]</span><br><span class="line">正在保存至: “/etc/yum.repos.d/CentOS-Base.repo”</span><br><span class="line"></span><br><span class="line">/etc/yum.repos.d/CentOS-Base.repo                100%[=======================================================================================================&gt;]   2.53K  --.-KB/s  用时 0s      </span><br><span class="line"></span><br><span class="line">2023-08-30 22:56:18 (192 MB/s) - 已保存 “/etc/yum.repos.d/CentOS-Base.repo” [2590/2590])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.centos8下，和centos7不同的是,devtoolset改为了gcc-toolset,这里使用gcc-toolset</span><br><span class="line"></span><br><span class="line">　　1)查看可用的gcc-toolset列表</span><br><span class="line"></span><br><span class="line">[root@Server01 opt]# yum list | grep gcc-toolset</span><br><span class="line"></span><br><span class="line"> 　 2)安装gcc-toolset-11</span><br><span class="line"></span><br><span class="line">[root@Server01 opt]# yum -y install gcc-toolset-11-gcc gcc-toolset-11-gcc-c++ gcc-toolset-11-binutils</span><br><span class="line">上次元数据过期检查：0:02:19 前，执行于 2023年08月30日 星期三 22时56分38秒。</span><br><span class="line">软件包 gcc-toolset-11-gcc-11.2.1-1.2.el8_5.x86_64 已安装。</span><br><span class="line">软件包 gcc-toolset-11-gcc-c++-11.2.1-1.2.el8_5.x86_64 已安装。</span><br><span class="line">软件包 gcc-toolset-11-binutils-2.36.1-1.el8_5.1.x86_64 已安装。</span><br><span class="line">依赖关系解决。</span><br><span class="line">无需任何处理。</span><br><span class="line">完毕！</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Server01 opt]# gcc -v</span><br><span class="line">使用内建 specs。</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/8/lto-wrapper</span><br><span class="line">OFFLOAD_TARGET_NAMES=nvptx-none</span><br><span class="line">OFFLOAD_TARGET_DEFAULT=1</span><br><span class="line">目标：x86_64-redhat-linux</span><br><span class="line">配置为：../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-shared --enable-threads=posix --enable-checking=release --enable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --with-isl --disable-libmpx --enable-offload-targets=nvptx-none --without-cuda-driver --enable-gnu-indirect-function --enable-cet --with-tune=generic --with-arch_32=x86-64 --build=x86_64-redhat-linux</span><br><span class="line">线程模型：posix</span><br><span class="line">gcc 版本 8.5.0 20210514 (Red Hat 8.5.0-4) (GCC) </span><br><span class="line"></span><br><span class="line">[root@Server01 opt]# scl <span class="built_in">enable</span> gcc-toolset-11 bash</span><br><span class="line">[root@Server01 opt]# gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/opt/rh/gcc-toolset-11/root/usr/libexec/gcc/x86_64-redhat-linux/11/lto-wrapper</span><br><span class="line">OFFLOAD_TARGET_NAMES=nvptx-none</span><br><span class="line">OFFLOAD_TARGET_DEFAULT=1</span><br><span class="line">Target: x86_64-redhat-linux</span><br><span class="line">Configured with: ../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/opt/rh/gcc-toolset-11/root/usr --mandir=/opt/rh/gcc-toolset-11/root/usr/share/man --infodir=/opt/rh/gcc-toolset-11/root/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-shared --enable-threads=posix --enable-checking=release --enable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --with-isl=/builddir/build/BUILD/gcc-11.2.1-20210728/obj-x86_64-redhat-linux/isl-install --enable-offload-targets=nvptx-none --without-cuda-driver --enable-gnu-indirect-function --enable-cet --with-tune=generic --with-arch_32=x86-64 --build=x86_64-redhat-linux</span><br><span class="line">Thread model: posix</span><br><span class="line">Supported LTO compression algorithms: zlib zstd</span><br><span class="line">gcc version 11.2.1 20210728 (Red Hat 11.2.1-1) (GCC) </span><br><span class="line"></span><br><span class="line">    3) 使用gcc11版本（需要注意的是scl命令启用只是临时的，退出shell或重启就会恢复原系统gcc版本。）</span><br><span class="line"></span><br><span class="line">　　　　<span class="built_in">echo</span> <span class="string">&quot;source /opt/rh/gcc-toolset-11/enable&quot;</span> &gt;&gt;/etc/profile</span><br><span class="line">　　　　</span><br><span class="line">       这样退出shell重新打开就是新版的gcc了</span><br></pre></td></tr></table></figure>

<p>5、在redis-6.2.6目录下再次执行make命令（make 是用来编译的，它从Makefile中读取指令，然后编译。需要运行一些时间，等待即可。）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-6.2.6]# make</span><br><span class="line"><span class="built_in">cd</span> src &amp;&amp; make all</span><br><span class="line">make[1]: 进入目录“/opt/redis-6.2.6/src”</span><br><span class="line">    CC Makefile.dep</span><br><span class="line">make[1]: 离开目录“/opt/redis-6.2.6/src”</span><br><span class="line">make[1]: 进入目录“/opt/redis-6.2.6/src”</span><br><span class="line">……</span><br><span class="line">   LINK redis-server</span><br><span class="line">    INSTALL redis-sentinel</span><br><span class="line">    CC redis-cli.o</span><br><span class="line">    CC cli_common.o</span><br><span class="line">    LINK redis-cli</span><br><span class="line">    CC redis-benchmark.o</span><br><span class="line">    LINK redis-benchmark</span><br><span class="line">    INSTALL redis-check-rdb</span><br><span class="line">    INSTALL redis-check-aof</span><br><span class="line"></span><br><span class="line">Hint: It<span class="string">&#x27;s a good idea to run &#x27;</span>make <span class="built_in">test</span><span class="string">&#x27; ;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">make[1]: 离开目录“/opt/redis-6.2.6/src”</span></span><br><span class="line"><span class="string">[root@localhost redis-6.2.6]# </span></span><br></pre></td></tr></table></figure>

<p>注意：如果没有准备好C语言编译环境，make 会报错—Jemalloc&#x2F;jemalloc.h：没有那个文件;解决方案：运行make distclean后，再次执行make</p>
<p>6、跳过make test 继续执行: make install；redis的默认安装路径 &#x2F;usr&#x2F;local&#x2F;bin</p>
<p>这里我们可以加上选项 PREFIX&#x3D;&#x2F;usr&#x2F;local&#x2F;redis 来指定具体的安装路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-6.2.6]# make install PREFIX=/usr/local/redis</span><br><span class="line"><span class="built_in">cd</span> src &amp;&amp; make install</span><br><span class="line">make[1]: 进入目录“/opt/redis-6.2.6/src”</span><br><span class="line">    CC Makefile.dep</span><br><span class="line">make[1]: 离开目录“/opt/redis-6.2.6/src”</span><br><span class="line">make[1]: 进入目录“/opt/redis-6.2.6/src”</span><br><span class="line"></span><br><span class="line">Hint: It<span class="string">&#x27;s a good idea to run &#x27;</span>make <span class="built_in">test</span><span class="string">&#x27; ;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    INSTALL redis-server</span></span><br><span class="line"><span class="string">    INSTALL redis-benchmark</span></span><br><span class="line"><span class="string">    INSTALL redis-cli</span></span><br><span class="line"><span class="string">make[1]: 离开目录“/opt/redis-6.2.6/src”</span></span><br><span class="line"><span class="string">[root@localhost redis-6.2.6]# ll /usr/local/redis/bin/</span></span><br><span class="line"><span class="string">总用量 24988</span></span><br><span class="line"><span class="string">-rwxr-xr-x 1 root root  6563376 4月  14 23:25 redis-benchmark</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root       12 4月  14 23:25 redis-check-aof -&gt; redis-server</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root       12 4月  14 23:25 redis-check-rdb -&gt; redis-server</span></span><br><span class="line"><span class="string">-rwxr-xr-x 1 root root  6805528 4月  14 23:25 redis-cli</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root       12 4月  14 23:25 redis-sentinel -&gt; redis-server</span></span><br><span class="line"><span class="string">-rwxr-xr-x 1 root root 12211832 4月  14 23:25 redis-server</span></span><br></pre></td></tr></table></figure>

<p>7、将redis配置文件。复制到我们当前目录下在创建一个自定义目录用于存储redis配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-6.2.6]# <span class="built_in">mkdir</span> /usr/local/redis/etc/</span><br><span class="line">[root@localhost redis-6.2.6]# <span class="built_in">cp</span> /opt/redis-6.2.6/redis.conf /usr/local/redis/etc/</span><br><span class="line">[root@localhost redis-6.2.6]# <span class="built_in">cd</span> /usr/local/redis/etc/</span><br><span class="line">[root@localhost etc]# ll</span><br><span class="line">总用量 92</span><br><span class="line">-rw-r--r-- 1 root root 93724 4月  14 23:30 redis.conf</span><br><span class="line">[root@localhost etc]# </span><br></pre></td></tr></table></figure>

<p>8、我们之后就使用这个配置文件进行启动，注意redis默认不是后台启动的，后台启动设置daemonize no改成yes。 vi修改配置文件！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost etc]# vi redis.conf </span><br></pre></td></tr></table></figure>

<p>连接外网首先有在redis.conf改几个设置</p>
<p>1.配置redis为后台启动：将<strong>daemonize no</strong> 改成daemonize yes</p>
<p>![image-20220414234004249](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142340442.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142340442.png</a>)</p>
<p>2.注释 bind 127.0.0.1</p>
<p>![image-20220414234123500](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142341627.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142341627.png</a>)</p>
<p>3.配置远程访问：将protected-mode yes 改为 no。关闭protected-mode模式，此时外部网络可以直接访问。</p>
<p>![image-20220414234219036](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142342234.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142342234.png</a>)</p>
<p>其次看一下自己防火墙对端口号开没开放</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost etc]# firewall-cmd --query-port=6379/tcp</span><br><span class="line">FirewallD is not running</span><br></pre></td></tr></table></figure>

<p>9、启动Redis服务，并查看redis的进程是否开启！</p>
<p>此时未配置环境变量，因此会出现bash: redis-server: 未找到命令…的现象。需要使用绝对路径+命令来执行操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 bin]# <span class="built_in">cd</span> /usr/local/redis/bin/</span><br><span class="line">[root@Server01 bin]# ll</span><br><span class="line">总用量 23720</span><br><span class="line">-rwxr-xr-x 1 root root  6069712 8月  30 23:04 redis-benchmark</span><br><span class="line">lrwxrwxrwx 1 root root       12 8月  30 23:04 redis-check-aof -&gt; redis-server</span><br><span class="line">lrwxrwxrwx 1 root root       12 8月  30 23:04 redis-check-rdb -&gt; redis-server</span><br><span class="line">-rwxr-xr-x 1 root root  6311024 8月  30 23:04 redis-cli</span><br><span class="line">lrwxrwxrwx 1 root root       12 8月  30 23:04 redis-sentinel -&gt; redis-server</span><br><span class="line">-rwxr-xr-x 1 root root 11903144 8月  30 23:04 redis-server</span><br><span class="line">[root@Server01 bin]# <span class="built_in">cd</span> ..</span><br><span class="line">[root@Server01 redis]# ll</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 2 root root 134 8月  30 23:04 bin</span><br><span class="line">drwxr-xr-x 2 root root  24 8月  30 23:10 etc</span><br><span class="line">[root@Server01 redis]# <span class="built_in">cd</span> etc/</span><br><span class="line">[root@Server01 etc]# ll</span><br><span class="line">总用量 92</span><br><span class="line">-rw-r--r-- 1 root root 93725 8月  30 23:10 redis.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Server01 etc]# <span class="built_in">cd</span> /usr/local/redis/bin/</span><br><span class="line">[root@Server01 bin]# ll</span><br><span class="line">总用量 23720</span><br><span class="line">-rwxr-xr-x 1 root root  6069712 8月  30 23:04 redis-benchmark</span><br><span class="line">lrwxrwxrwx 1 root root       12 8月  30 23:04 redis-check-aof -&gt; redis-server</span><br><span class="line">lrwxrwxrwx 1 root root       12 8月  30 23:04 redis-check-rdb -&gt; redis-server</span><br><span class="line">-rwxr-xr-x 1 root root  6311024 8月  30 23:04 redis-cli</span><br><span class="line">lrwxrwxrwx 1 root root       12 8月  30 23:04 redis-sentinel -&gt; redis-server</span><br><span class="line">-rwxr-xr-x 1 root root 11903144 8月  30 23:04 redis-server</span><br><span class="line">[root@Server01 bin]# redis-server /usr/local/redis/etc/redis.conf</span><br><span class="line">bash: redis-server: 未找到命令...</span><br><span class="line">安装软件包“redis”以提供命令“redis-server”？ [N/y] n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Server01 bin]# /usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf</span><br><span class="line">[root@Server01 bin]# ps -ef | grep redis</span><br><span class="line">root        8353       1  0 23:14 ?        00:00:00 /usr/local/redis/bin/redis-server *:6379</span><br><span class="line">root        8367    3744  0 23:14 pts/0    00:00:00 grep --color=auto redis</span><br><span class="line">[root@Server01 bin]# </span><br></pre></td></tr></table></figure>

<p>10、使用redis-cli 进行连接测试！</p>
<p>由于每次执行脚本都要到指定目录，很麻烦，所以可以配置环境变量，后面需要使用redis命令就可以全局操作。具体步骤如下：</p>
<p>编辑环境变量配置文件：  vim &#x2F;etc&#x2F;profile  按 i 进入编辑模式 光标移至最后一行 开始添加 如下所示</p>
<p>![image-20220415000537086](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204150005236.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204150005236.png</a>)</p>
<p>编辑完成之后按 ESC 输入 wq 保存并退出<br>刷新配置信息：  source &#x2F;etc&#x2F;profile</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# vi /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> REDIS_HOME=/usr/local/redis</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$REDIS_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">[root@localhost bin]# </span><br><span class="line">[root@localhost bin]# <span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>此时在任意目录下 都可以执行redis相关命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# <span class="built_in">cd</span></span><br><span class="line">[root@localhost ~]# redis-cli -p 6379</span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>

<p>11、如何关闭Redis服务呢？ shutdown</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SHUTDOWN</span><br><span class="line">not connected&gt; </span><br><span class="line">not connected&gt; <span class="built_in">exit</span></span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure>

<p>12、再次查看进程是否存在</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ps -ef | grep redis</span><br><span class="line">root      13365   7546  0 00:12 pts/0    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

<p>13、redis-benchmark 是一个压力测试工具！官方自带的性能测试工具！redis-benchmark 命令参数！</p>
<p>![image-20220414221455545](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142214721.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204142214721.png</a>)</p>
<p>测试：100个并发连接 100000请求 启动服务，另开一个终端，键入以下指令做测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-server /usr/local/redis/etc/redis.conf </span><br><span class="line">[root@localhost ~]# ps -ef | grep redis</span><br><span class="line">root      13574      1  0 00:22 ?        00:00:00 redis-server *:6379</span><br><span class="line">root      13590   7546  0 00:22 pts/0    00:00:00 grep --color=auto redis</span><br><span class="line">[root@localhost ~]# redis-benchmark -h localhost -p 6379 -c 100 -n 100000</span><br><span class="line">……</span><br><span class="line">……</span><br><span class="line">……</span><br><span class="line">====== SET ======                                                   </span><br><span class="line">  100000 requests completed <span class="keyword">in</span> 3.24 seconds</span><br><span class="line">  100 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line">  host configuration <span class="string">&quot;save&quot;</span>: 3600 1 300 100 60 10000</span><br><span class="line">  host configuration <span class="string">&quot;appendonly&quot;</span>: no</span><br><span class="line">  multi-thread: no</span><br><span class="line"></span><br><span class="line">Latency by percentile distribution:</span><br><span class="line">0.000% &lt;= 0.279 milliseconds (cumulative count 3)</span><br><span class="line">50.000% &lt;= 1.791 milliseconds (cumulative count 50717)</span><br><span class="line">75.000% &lt;= 2.007 milliseconds (cumulative count 75563)</span><br><span class="line">87.500% &lt;= 2.175 milliseconds (cumulative count 87538)</span><br><span class="line">93.750% &lt;= 2.431 milliseconds (cumulative count 93750)</span><br><span class="line">96.875% &lt;= 2.775 milliseconds (cumulative count 96921)</span><br><span class="line">98.438% &lt;= 3.231 milliseconds (cumulative count 98441)</span><br><span class="line">99.219% &lt;= 3.639 milliseconds (cumulative count 99228)</span><br><span class="line">99.609% &lt;= 4.215 milliseconds (cumulative count 99614)</span><br><span class="line">99.805% &lt;= 4.799 milliseconds (cumulative count 99806)</span><br><span class="line">99.902% &lt;= 6.687 milliseconds (cumulative count 99903)</span><br><span class="line">99.951% &lt;= 8.071 milliseconds (cumulative count 99952)</span><br><span class="line">99.976% &lt;= 8.839 milliseconds (cumulative count 99976)</span><br><span class="line">99.988% &lt;= 9.287 milliseconds (cumulative count 99988)</span><br><span class="line">99.994% &lt;= 9.679 milliseconds (cumulative count 99994)</span><br><span class="line">99.997% &lt;= 9.823 milliseconds (cumulative count 99997)</span><br><span class="line">99.998% &lt;= 9.911 milliseconds (cumulative count 99999)</span><br><span class="line">99.999% &lt;= 9.951 milliseconds (cumulative count 100000)</span><br><span class="line">100.000% &lt;= 9.951 milliseconds (cumulative count 100000)</span><br><span class="line"></span><br><span class="line">Cumulative distribution of latencies:</span><br><span class="line">0.000% &lt;= 0.103 milliseconds (cumulative count 0)</span><br><span class="line">0.014% &lt;= 0.303 milliseconds (cumulative count 14)</span><br><span class="line">0.100% &lt;= 0.407 milliseconds (cumulative count 100)</span><br><span class="line">0.140% &lt;= 0.503 milliseconds (cumulative count 140)</span><br><span class="line">0.207% &lt;= 0.607 milliseconds (cumulative count 207)</span><br><span class="line">0.325% &lt;= 0.703 milliseconds (cumulative count 325)</span><br><span class="line">0.451% &lt;= 0.807 milliseconds (cumulative count 451)</span><br><span class="line">0.772% &lt;= 0.903 milliseconds (cumulative count 772)</span><br><span class="line">1.542% &lt;= 1.007 milliseconds (cumulative count 1542)</span><br><span class="line">3.306% &lt;= 1.103 milliseconds (cumulative count 3306)</span><br><span class="line">7.964% &lt;= 1.207 milliseconds (cumulative count 7964)</span><br><span class="line">15.719% &lt;= 1.303 milliseconds (cumulative count 15719)</span><br><span class="line">24.654% &lt;= 1.407 milliseconds (cumulative count 24654)</span><br><span class="line">30.889% &lt;= 1.503 milliseconds (cumulative count 30889)</span><br><span class="line">36.521% &lt;= 1.607 milliseconds (cumulative count 36521)</span><br><span class="line">42.625% &lt;= 1.703 milliseconds (cumulative count 42625)</span><br><span class="line">52.428% &lt;= 1.807 milliseconds (cumulative count 52428)</span><br><span class="line">63.709% &lt;= 1.903 milliseconds (cumulative count 63709)</span><br><span class="line">75.563% &lt;= 2.007 milliseconds (cumulative count 75563)</span><br><span class="line">83.583% &lt;= 2.103 milliseconds (cumulative count 83583)</span><br><span class="line">98.112% &lt;= 3.103 milliseconds (cumulative count 98112)</span><br><span class="line">99.563% &lt;= 4.103 milliseconds (cumulative count 99563)</span><br><span class="line">99.829% &lt;= 5.103 milliseconds (cumulative count 99829)</span><br><span class="line">99.877% &lt;= 6.103 milliseconds (cumulative count 99877)</span><br><span class="line">99.916% &lt;= 7.103 milliseconds (cumulative count 99916)</span><br><span class="line">99.953% &lt;= 8.103 milliseconds (cumulative count 99953)</span><br><span class="line">99.982% &lt;= 9.103 milliseconds (cumulative count 99982)</span><br><span class="line">100.000% &lt;= 10.103 milliseconds (cumulative count 100000)</span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line">  throughput summary: 30826.14 requests per second</span><br><span class="line">  latency summary (msec):</span><br><span class="line">          avg       min       p50       p95       p99       max</span><br><span class="line">        1.779     0.272     1.791     2.535     3.495     9.951</span><br></pre></td></tr></table></figure>

<p>![image-20220415003127301](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204150031462.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204150031462.png</a>)</p>
<h3 id="使用redis-cli操作Redis"><a href="#使用redis-cli操作Redis" class="headerlink" title="使用redis-cli操作Redis"></a>使用redis-cli操作Redis</h3><h4 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h4><p>redis默认有16个数据库</p>
<p>![image-20220417194341615](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204171943846.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204171943846.png</a>)</p>
<p>默认使用的是第0个可以使用 select 进行切换数据库！</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="第7章 键值对存储数据库Redis.https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204171944679.png" alt="image-20220417194426465" style="zoom:67%;" />

<p>清除当前数据库 flushdb</p>
<p>清除全部数据库的内容 FLUSHALL</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="第7章 键值对存储数据库Redis.https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204171945535.png" alt="image-20220417194508368" style="zoom:67%;" />

<p>Redis 是<strong>单线程</strong>的！</p>
<p>明白Redis是很快的，官方表示，Redis是<strong>基于内存操作</strong>，CPU不是Redis性能瓶颈，Redis的<strong>瓶颈</strong>是根据机器的内存和网络带宽，既然可以使用单线程来实现，就使用单线程了！</p>
<p>Redis 是C 语言写的，官方提供的数据为 100000+ 的QPS，完全不比同样是使用 key-vale的Memecache差！</p>
<p>Redis 为什么单线程还这么快？</p>
<blockquote>
<p>​	误区1：高性能的服务器一定是多线程的？</p>
<p>​	误区2：多线程（CPU上下文会切换！）一定比单线程效率高！</p>
</blockquote>
<p>​	先去CPU&gt;内存&gt;硬盘的速度要有所了解！</p>
<p>核心：redis 是将所有的数据全部放在内存中的，所以说使用单线程去操作效率就是最高的，多线程（CPU上下文会切换：耗时的操作！！！），<strong>对于内存系统来说，如果没有上下文切换效率就是最高的！</strong>多次读写都是在一个CPU上的，在内存情况下，这个就是最佳的方案！</p>
<h4 id="五大数据类型"><a href="#五大数据类型" class="headerlink" title="五大数据类型"></a>五大数据类型</h4><p>![image-20220417194936678](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204171949874.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204171949874.png</a>)</p>
<p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件MQ。 它支持多种类型的数据结构，如 <strong>字符串</strong>（strings）， <strong>散列</strong>（hashes）， <strong>列表</strong>（lists）， <strong>集合</strong>（sets）， <strong>有序集合</strong>（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。</p>
<p>Redis 内置了 复制（replication），LUA脚本（Lua scripting）， LRU驱动事件（LRU eviction），事务（transactions） 和不同级别的 磁盘持久化（persistence）， 并通过Redis哨兵（Sentinel）和自动分区（Cluster）提供高可用性（high availability）。</p>
<p>我们现在讲解的所有命令大家一定要全部记住，后面我们使用SpringBoot、Jedis，所有的方法就是这些命令!</p>
<h5 id="0-操作键"><a href="#0-操作键" class="headerlink" title="0 操作键"></a>0 操作键</h5><p>Redis键操作是Redis数据库中非常重要和常用的操作。下面，通过一张表来介绍一下常用的Redis键操作命令及相关说明，具体如表所示。</p>
<table>
<thead>
<tr>
<th><strong>操作命令</strong></th>
<th><strong>相关说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>SET</td>
<td>为指定键设置值</td>
</tr>
<tr>
<td>MSET</td>
<td>为多个键设置值</td>
</tr>
<tr>
<td>KEYS</td>
<td>查找所有符合给定模式pattern（正则表达式）的键</td>
</tr>
<tr>
<td>GET</td>
<td>获取指定键的值</td>
</tr>
<tr>
<td>MGET</td>
<td>获取多个键的对应值</td>
</tr>
<tr>
<td>DUMP</td>
<td>序列化指定的键，并返回被序列化的值</td>
</tr>
<tr>
<td>EXISTS</td>
<td>判断指定键是否存在</td>
</tr>
<tr>
<td>TYPE</td>
<td>查看指定键的类型</td>
</tr>
<tr>
<td>RENAME</td>
<td>删除指定键的值</td>
</tr>
<tr>
<td>EXPIRE</td>
<td>设置指定键的生存时间，以秒计</td>
</tr>
<tr>
<td>TTL</td>
<td>返回指定键的剩余生存时间</td>
</tr>
<tr>
<td>PERSIST</td>
<td>移除键的生存时间</td>
</tr>
<tr>
<td>DEL</td>
<td>在键存在时，删除key</td>
</tr>
</tbody></table>
<p>Redis-key</p>
<hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动redis-server服务</span></span><br><span class="line">[root@localhost ~]# redis-server /usr/local/redis/etc/redis.conf </span><br><span class="line">[root@localhost ~]# ps -ef | grep redis</span><br><span class="line">root       7670      1  1 20:20 ?        00:00:00 redis-server *:6379</span><br><span class="line">root       7687   7602  0 20:20 pts/0    00:00:00 grep --color=auto redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用redis-cli登入到服务器，如果不指定IP和端口号，则默认登录到redis.conf配置文件中设置的参数</span></span><br><span class="line"><span class="comment"># 默认redis不转义中文，如果在平常开发中 想要看到中文内容。在打开客户端时：./redis-cli  命令后面  加上  --raw 即可。</span></span><br><span class="line">[root@localhost ~]# redis-cli </span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line"></span><br><span class="line"><span class="comment"># set设置键名为 company，值为 itcast</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> company itcast</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置键名为 company0，值为 itcast0 的字符串，且20秒后 company0 过期  -1 表示永不过期；-2 表示已过期</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> company0 itcast0 EX 20</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ttl company0</span><br><span class="line">18</span><br><span class="line">127.0.0.1:6379&gt; ttl company0</span><br><span class="line">7</span><br><span class="line">127.0.0.1:6379&gt; ttl company0</span><br><span class="line">-2</span><br><span class="line"></span><br><span class="line"><span class="comment"># get获取 company 的值</span></span><br><span class="line">127.0.0.1:6379&gt; get company</span><br><span class="line">itcast</span><br><span class="line"></span><br><span class="line"><span class="comment"># mset为多个键设置值。为键brand1设置值heima、键brand2设置值chuanzhihui、键brand3设置值kudingyu、键brand4设置值boxuegu、键brand5设置值czzxxy、键brand6设置值yuanxiaobang。</span></span><br><span class="line">127.0.0.1:6379&gt; MSET brand1 <span class="string">&quot;heima&quot;</span> brand2 <span class="string">&quot;chuanzhihui&quot;</span> brand3 <span class="string">&quot;kudingyu&quot;</span> brand4 <span class="string">&quot;boxuegu&quot;</span> brand5 <span class="string">&quot;czzxxy&quot;</span> brand6 <span class="string">&quot;yuanxiaobang&quot;</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># keys命令查找所有键。从返回结果可以看出，一共有七个键，其中键company是执行“SET”命令创建的，键brand1、brand2、brand3、brand4、brand5、brand6是执行“MSET”命令创建。</span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">company</span><br><span class="line">brand1</span><br><span class="line">brand2</span><br><span class="line">brand4</span><br><span class="line">brand6</span><br><span class="line">brand5</span><br><span class="line">brand3</span><br><span class="line"></span><br><span class="line"><span class="comment"># MGET命令获取多个键的对应值。键brand1、brand2以及brand3的值分别为heima、chuanzhihui及kudingyu，而键brand的值为nil，这是因为键brand并不存在</span></span><br><span class="line">127.0.0.1:6379&gt; MGET brand1 brand2 brand3 brand</span><br><span class="line">heima</span><br><span class="line">chuanzhihui</span><br><span class="line">kudingyu</span><br><span class="line">(nil)</span><br><span class="line"><span class="comment"># DUMP命令序列化指定的键，并返回被序列化的值。</span></span><br><span class="line">127.0.0.1:6379&gt; dump company</span><br><span class="line"><span class="string">&quot;\x00\x06itcast\t\x00\x05\x99\x0bu\x97\x8d\xd4\xc1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EXISTS命令判断指定键是否存在。若存在，则返回1，反之返回0。</span></span><br><span class="line">127.0.0.1:6379&gt; EXISTS brand6</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; EXISTS brand7</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># TYPE命令查看指定键的类型。键company的类型为string类型。</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> company</span><br><span class="line">string</span><br><span class="line"></span><br><span class="line"><span class="comment"># RENAME命令修改指定键的名称。将键company改为newcompany，并执行“keys *”命令，查看键是否被修改成功。</span></span><br><span class="line">127.0.0.1:6379&gt; rename company newcompany</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;brand1&quot;</span></span><br><span class="line">2) <span class="string">&quot;brand2&quot;</span></span><br><span class="line">3) <span class="string">&quot;brand4&quot;</span></span><br><span class="line">4) <span class="string">&quot;brand6&quot;</span></span><br><span class="line">5) <span class="string">&quot;newcompany&quot;</span></span><br><span class="line">6) <span class="string">&quot;brand5&quot;</span></span><br><span class="line">7) <span class="string">&quot;brand3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EXPIRE命令设置键的生存时间。将键brand6的生存时间设置为30s。</span></span><br><span class="line">127.0.0.1:6379&gt; expire brand6 30</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># TTL命令查看指定键的剩余过期时间。返回结果“25”可以看出，键brand6的剩余生存时间为25s。若是键brand6不存在（即过期）则返回“-2”，执行“keys *”命令，我们会发现键brand6已经不存在了。</span></span><br><span class="line">127.0.0.1:6379&gt; ttl brand6</span><br><span class="line">(<span class="built_in">integer</span>) 12</span><br><span class="line">127.0.0.1:6379&gt; ttl brand6</span><br><span class="line">(<span class="built_in">integer</span>) -2</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;brand1&quot;</span></span><br><span class="line">2) <span class="string">&quot;brand2&quot;</span></span><br><span class="line">3) <span class="string">&quot;brand4&quot;</span></span><br><span class="line">4) <span class="string">&quot;newcompany&quot;</span></span><br><span class="line">5) <span class="string">&quot;brand5&quot;</span></span><br><span class="line">6) <span class="string">&quot;brand3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PERSIST命令移除指定键的生存时间，即将键从带生存时间的状态转换为持久存在的状态。将键brand5的生存时间设置为60s，返回结果“56可以看出，键brand5的剩余生存时间为56s，此时移除键brand5的生存时间，返回结果“1”可以看出，键brand6的生存时间已被成功移除。</span></span><br><span class="line">127.0.0.1:6379&gt; expire brand5 60</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl brand5</span><br><span class="line">(<span class="built_in">integer</span>) 56</span><br><span class="line">127.0.0.1:6379&gt; persist brand5</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl brand5</span><br><span class="line">(<span class="built_in">integer</span>) -1</span><br><span class="line"></span><br><span class="line"><span class="comment"># DEL命令删除指定键。</span></span><br><span class="line">127.0.0.1:6379&gt; DEL brand5</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;brand1&quot;</span></span><br><span class="line">2) <span class="string">&quot;brand2&quot;</span></span><br><span class="line">3) <span class="string">&quot;brand4&quot;</span></span><br><span class="line">4) <span class="string">&quot;newcompany&quot;</span></span><br><span class="line">5) <span class="string">&quot;brand3&quot;</span></span><br></pre></td></tr></table></figure>

<p>后面如果遇到不会的命令，可以在官网查看帮助文档！<br><a target="_blank" rel="noopener" href="https://www.redis.net.cn/order/">https://www.redis.net.cn/order/</a></p>
<h5 id="1-操作String字符串"><a href="#1-操作String字符串" class="headerlink" title="1 操作String字符串"></a>1 操作String字符串</h5><p>String字符串是Redis中最基本也是最简单的数据结构，其值是二进制安全的，值的数据类型可以为数字、文本、图片、视频或者序列化的对象等，值的最大长度不能超过512M。</p>
<p>![image-20220417200903660](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172009845.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172009845.png</a>)</p>
<p>将图中的Bookid看作是编程语言中的字符串变量名，那么100020就是该变量名的值。</p>
<table>
<thead>
<tr>
<th><strong>操作命令</strong></th>
<th><strong>相关说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>SET</td>
<td>为指定字符串键设置值</td>
</tr>
<tr>
<td>MSET</td>
<td>为多个字符串键设置值</td>
</tr>
<tr>
<td>GET</td>
<td>获取指定字符串key中的值</td>
</tr>
<tr>
<td>MGET</td>
<td>获取多个字符串键的对应值</td>
</tr>
<tr>
<td>GETSET</td>
<td>获取指定字符串键的旧值并设置新值</td>
</tr>
<tr>
<td>STRLEN</td>
<td>获取字符串值的字节长度</td>
</tr>
<tr>
<td>GETRANGE</td>
<td>获取字符串键指定索引范围的值内容</td>
</tr>
<tr>
<td>SETRANGE</td>
<td>为字符串键的指定索引位置设置值</td>
</tr>
<tr>
<td>APPEND</td>
<td>追加新内容到值的末尾</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SET命令为指定字符串键设置值。</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> website <span class="string">&quot;www.itcast.cn&quot;</span></span><br><span class="line">OK</span><br><span class="line"><span class="comment"># 为字符串键website设置值www.itcast.cn，返回结果“OK”可以看出，我们成功为字符串键website设置值www.itcast.cn。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># setnx (set if not exist) 	不存在在设置。如果mykey不存在，则创建mykey；如果mykey存在，创建失败！分布式锁常用。</span></span><br><span class="line">127.0.0.1:6379&gt; setnx mykey <span class="string">&quot;redis&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> mykey <span class="string">&quot;mongodb&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get mykey</span><br><span class="line"><span class="string">&quot;mongodb&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; setnx mykey <span class="string">&quot;HBase&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; get mykey</span><br><span class="line"><span class="string">&quot;mongodb&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># MSET命令为多个字符串键设置对应的值。</span></span><br><span class="line">127.0.0.1:6379&gt; mset website1 <span class="string">&quot;www.itheima.com&quot;</span> website2 <span class="string">&quot;www.boxuegu.com&quot;</span>  website3 <span class="string">&quot;www.ityxb.com&quot;</span></span><br><span class="line">OK</span><br><span class="line"><span class="comment"># 为字符串键website1设置值www.itheima.com、字符串键website2设置值www.boxuegu.com及字符串键website3设置值www.ityxb.com</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># GET命令获取指定字符串键的值。</span></span><br><span class="line">127.0.0.1:6379&gt; get website</span><br><span class="line"><span class="string">&quot;www.itcast.cn&quot;</span></span><br><span class="line"><span class="comment"># 返回结果可以看出，字符串键website的值为www.itcast.cn，说明我们成功获取到字符串键website的值。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># MGET命令获取多个字符串键的对应值。</span></span><br><span class="line">127.0.0.1:6379&gt; mget website1 website2 website3 website5</span><br><span class="line">1) <span class="string">&quot;www.itheima.com&quot;</span></span><br><span class="line">2) <span class="string">&quot;www.boxuegu.com&quot;</span></span><br><span class="line">3) <span class="string">&quot;www.ityxb.com&quot;</span></span><br><span class="line">4) (nil)</span><br><span class="line"><span class="comment"># 返回结果可以看出，字符串键website1、website2、website3的值分别为www.itheima.com、www.boxuegu.com及www.ityxb.com，而字符串键website5的值为nil，这是因为字符串键website5并不存在，因此返回特殊值nil。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># msetnx 是一个原子性的操作，要么一起成功，要么一起失败。</span></span><br><span class="line">127.0.0.1:6379&gt; mset name <span class="string">&quot;xiaoming&quot;</span> age <span class="string">&quot;18&quot;</span> <span class="built_in">id</span> <span class="string">&quot;123456789&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget name age <span class="built_in">id</span></span><br><span class="line">1) <span class="string">&quot;xiaoming&quot;</span></span><br><span class="line">2) <span class="string">&quot;18&quot;</span></span><br><span class="line">3) <span class="string">&quot;123456789&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; msetnx name <span class="string">&quot;xiaoming&quot;</span> grade <span class="string">&quot;A&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; msetnx class <span class="string">&quot;21.19&quot;</span> grade <span class="string">&quot;B&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; mget name age <span class="built_in">id</span> class grade</span><br><span class="line">1) <span class="string">&quot;xiaoming&quot;</span></span><br><span class="line">2) <span class="string">&quot;18&quot;</span></span><br><span class="line">3) <span class="string">&quot;123456789&quot;</span></span><br><span class="line">4) <span class="string">&quot;20.18&quot;</span></span><br><span class="line">5) <span class="string">&quot;A&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># GETSET命令获取指定字符串键的旧值并设置新值。</span></span><br><span class="line">127.0.0.1:6379&gt; getset website4 <span class="string">&quot;www.kudingyu.com&quot;</span></span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; getset website4 <span class="string">&quot;www.itczh.com&quot;</span></span><br><span class="line"><span class="string">&quot;www.kudingyu.com&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get website4</span><br><span class="line"><span class="string">&quot;www.itczh.com&quot;</span></span><br><span class="line"><span class="comment">#从返回结果可以看出，最开始字符串键website4不存在，因此返回特殊值nil，当第一次执行“getset”命令后，字符串键website4就被指定值为www.kudingyu.com，第二次执行“getset”命令设置字符串键website4新值后，返回了字符串键website4的旧值www.kudingyu.com。然后执行“get website4”命令，查看字符串键website4被成功设置新值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># STRLEN命令获取指定字符串键值的长度。</span></span><br><span class="line">127.0.0.1:6379&gt; strlen  website4</span><br><span class="line">(<span class="built_in">integer</span>) 13</span><br><span class="line"><span class="comment"># 字符串键website4的值的长度为13，即www.itczh.com的长度为13个字节长度。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># GETRANGE命令获取字符串键指定索引范围的值内容。</span></span><br><span class="line">127.0.0.1:6379&gt; getrange website 4 9</span><br><span class="line"><span class="string">&quot;itcast&quot;</span></span><br><span class="line"><span class="comment"># 从上述返回结果“itcast”可以看出，字符串键website的值在索引范围为[4，9]的内容为itcast。getrange key 0 -1，则表示获取全部的字符串和get key效果一样</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment"># SETRANGE命令为字符串键的指定索引位置替换值。</span></span><br><span class="line">127.0.0.1:6379&gt; get website</span><br><span class="line"><span class="string">&quot;www.itcast.cn&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; setrange  website  4  <span class="string">&quot;nosql&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 13</span><br><span class="line">127.0.0.1:6379&gt; get  website</span><br><span class="line"><span class="string">&quot;www.nosqlt.cn&quot;</span></span><br><span class="line"><span class="comment"># 从上述返回结果可以看出，字符串键website在索引为4的位置处替换值为nosql，由于itcast包含5个字节，从位置为0处作为起点，位置为4处作为终点，替换为nosql，因此说明我们成功为字符串键website的指定位置替换值。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># APPEND命令为指定字符串键的值末尾追加新内容。</span></span><br><span class="line">127.0.0.1:6379&gt; append  website  <span class="string">&quot;itcast&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 19</span><br><span class="line">127.0.0.1:6379&gt; get  website</span><br><span class="line"><span class="string">&quot;www.nosqlt.cnitcast&quot;</span></span><br><span class="line"><span class="comment"># 从上述返回结果可以看出，字符串键website的值末尾的内容为itcast，因此说明我们成功为字符串键website的值末尾追加内容itcast。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># redis 巧妙用法</span></span><br><span class="line"><span class="comment"># 设置一个user:1对象的值 作为json字符来保存一个对象！（json这样做会导致可扩展性为0，即后期项目增加词条就没法儿玩了！！！）</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> user:1 &#123;name:zhangsan,age:3,<span class="built_in">id</span>:6789&#125; </span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get user:1</span><br><span class="line"><span class="string">&quot;&#123;name:zhangsan,age:3,id:6789&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里的key是一个巧妙的设计： user:&#123;id&#125;:&#123;filed&#125; , 如此设计在Redis中是完全OK了！这种设计可以做到细粒度的查询，如果对象有很多属性，但只需要一个读取其中一个属性，不用返回整个json对象。即对象中某一个属性经常使用的情况下，第二种方法好用很多，特别是大数据环境</span></span><br><span class="line">127.0.0.1:6379&gt; MSET user:2:name xiaoming user:2:age 3 user:2:<span class="built_in">id</span> 1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get user:2</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get user:2:name</span><br><span class="line"><span class="string">&quot;xiaoming&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get user:2:age</span><br><span class="line"><span class="string">&quot;3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get user:2:<span class="built_in">id</span></span><br><span class="line"><span class="string">&quot;1234&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>

<p>现在学习的key，相当于以后的方法</p>
<p>String类似的使用场景：value除了是我们的字符串还可以是我们的数字！</p>
<p>计数器</p>
<p>统计多单位的数量</p>
<p>粉丝数</p>
<p>对象缓存存储！</p>
<p>比如：设置过期时间，相当于定期持久化</p>
<h5 id="2-操作List列表"><a href="#2-操作List列表" class="headerlink" title="2 操作List列表"></a>2 操作List列表</h5><p>List列表是由若干个字符串元素组成的集合，并且每个字符串元素都是按照插入顺序排序的。我们也可以将列表理解为多个字符串组成一个集合对象，并按照链表（Link List）的插入顺序排序，在读写操作时只能从其头部或尾部开始，而不能从中间开始。</p>
<p>![image-20220417224301160](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172243344.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172243344.png</a>)</p>
<p>LBookid为列表的键名，100020、100021、100022、100022均为列表中键的值，这些值均按照插入顺序排列，其中100020是列表中的第一个字符串元素、100021是列表中的第二个元素、100022是列表中的第三个元素、100022是列表中的第四个元素（也是尾部元素）。由于<strong>List列表中允许出现重复的元素</strong>，因此List列表中的第三个元素和第四个元素均为100022。</p>
<p>List列表是一种线性的有序结构，Redis为List列表提供了相关的操作命令。下面，通过一张表来介绍一下常用的List操作命令及相关说明，具体如表所示。</p>
<table>
<thead>
<tr>
<th><strong>操作命令</strong></th>
<th><strong>相关说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>RPUSH</td>
<td>将一个或多个元素推入到列表的右端</td>
</tr>
<tr>
<td>LPUSH</td>
<td>将一个或多个元素推入到列表的左端</td>
</tr>
<tr>
<td>LRANGE</td>
<td>获取列表指定索引范围内的元素</td>
</tr>
<tr>
<td>LINDEX</td>
<td>获取列表指定索引位置上的元素</td>
</tr>
<tr>
<td>RPOP</td>
<td>弹出列表最右端的元素</td>
</tr>
<tr>
<td>LPOP</td>
<td>弹出列表最左端的元素</td>
</tr>
<tr>
<td>LLEN</td>
<td>获取指定列表的长度</td>
</tr>
<tr>
<td>LREM</td>
<td>移除列表中的指定元素</td>
</tr>
</tbody></table>
<p>Redis列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的<strong>头部（左边）</strong>或者<strong>尾部（右边）</strong></p>
<p>一个列表最多可以包含 <strong>2</strong>32 <strong>- 1</strong> 个元素 (4294967295, 每个列表超过40亿个元素，2的32次方-1也就是大概四亿键值对)。</p>
<p>在redis里面，我们可以把list玩成 ，</p>
<p>​		头进尾出，就是栈；</p>
<p>​		头进头出，就是队列；</p>
<p>​		两边都打开，都可进可取，就是阻塞队列！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RPUSH命令将一个或多个元素推入到列表的右端。插入到列表尾部 （右）</span></span><br><span class="line">127.0.0.1:6379&gt; rpush color <span class="string">&quot;blue&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush color <span class="string">&quot;green&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; rpush color <span class="string">&quot;purple&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; rpush color <span class="string">&quot;red&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; rpush color <span class="string">&quot;white&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line">127.0.0.1:6379&gt; lrange color 0 -1</span><br><span class="line">1) <span class="string">&quot;blue&quot;</span></span><br><span class="line">2) <span class="string">&quot;green&quot;</span></span><br><span class="line">3) <span class="string">&quot;purple&quot;</span></span><br><span class="line">4) <span class="string">&quot;red&quot;</span></span><br><span class="line">5) <span class="string">&quot;white&quot;</span></span><br><span class="line"><span class="comment"># 依次将元素blue、green、purple、red、white推入到列表color的右端，并执行“lrange color 0 -1”命令，查看是否已经将五个元素推入到列表color的右端</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># LPUSH命令将一个或多个元素推入到列表的左端。(双向链表)插入到列表头部 （左），这里相当于头插法，插入一个元素，上一个元素右移。</span></span><br><span class="line">127.0.0.1:6379&gt; lpush color <span class="string">&quot;apple&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; lpush color <span class="string">&quot;banana&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 7</span><br><span class="line">127.0.0.1:6379&gt; lpush color <span class="string">&quot;mango&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 8</span><br><span class="line">127.0.0.1:6379&gt; lrange color 0 -1</span><br><span class="line">1) <span class="string">&quot;mango&quot;</span></span><br><span class="line">2) <span class="string">&quot;banana&quot;</span></span><br><span class="line">3) <span class="string">&quot;apple&quot;</span></span><br><span class="line">4) <span class="string">&quot;blue&quot;</span></span><br><span class="line">5) <span class="string">&quot;green&quot;</span></span><br><span class="line">6) <span class="string">&quot;purple&quot;</span></span><br><span class="line">7) <span class="string">&quot;red&quot;</span></span><br><span class="line">8) <span class="string">&quot;white&quot;</span></span><br><span class="line"><span class="comment"># 依次将元素apple、banana、mango推入到列表color的左端，并执行“lrange color 0 -1”命令，查看是否已经将三个元素推入到列表color的左端。从返回结果可看出，我们成功往列表中推入八个元素，其中有五个元素是执行“rpush”命令推入到列表color中，三个元素是执行“lpush”命令推入到列表color中。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># LRANGE命令获取列表指定索引范围内的元素。</span></span><br><span class="line">127.0.0.1:6379&gt; lrange color 0 7</span><br><span class="line">1) <span class="string">&quot;mango&quot;</span></span><br><span class="line">2) <span class="string">&quot;banana&quot;</span></span><br><span class="line">3) <span class="string">&quot;apple&quot;</span></span><br><span class="line">4) <span class="string">&quot;blue&quot;</span></span><br><span class="line">5) <span class="string">&quot;green&quot;</span></span><br><span class="line">6) <span class="string">&quot;purple&quot;</span></span><br><span class="line">7) <span class="string">&quot;red&quot;</span></span><br><span class="line">8) <span class="string">&quot;white&quot;</span></span><br><span class="line"><span class="comment"># 获取列表color指定索引范围[0，7]的元素，若是想要获取全部元素，则可以指定范围为[0，-1]。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># LINDEX命令获取列表指定索引位置上的元素。</span></span><br><span class="line">127.0.0.1:6379&gt; lindex color 3</span><br><span class="line"><span class="string">&quot;blue&quot;</span></span><br><span class="line"><span class="comment"># 获取列表color中索引位置为3的元素，从上述返回结果“blue”可以看出，列表color中索引位置为3的元素是blue。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># RPOP命令移除列表最右端的元素。</span></span><br><span class="line">127.0.0.1:6379&gt; rpop color</span><br><span class="line"><span class="string">&quot;white&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange color 0 -1</span><br><span class="line">1) <span class="string">&quot;mango&quot;</span></span><br><span class="line">2) <span class="string">&quot;banana&quot;</span></span><br><span class="line">3) <span class="string">&quot;apple&quot;</span></span><br><span class="line">4) <span class="string">&quot;blue&quot;</span></span><br><span class="line">5) <span class="string">&quot;green&quot;</span></span><br><span class="line">6) <span class="string">&quot;purple&quot;</span></span><br><span class="line">7) <span class="string">&quot;red&quot;</span></span><br><span class="line"><span class="comment"># 从返回结果可以看出，列表color最右端的元素white已经不存在了，因此说明我们成功移除列表color最右端的元素。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># LPOP命令移除列表最左端的元素。</span></span><br><span class="line">127.0.0.1:6379&gt; lpop color</span><br><span class="line"><span class="string">&quot;mango&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange color 0 -1</span><br><span class="line">1) <span class="string">&quot;banana&quot;</span></span><br><span class="line">2) <span class="string">&quot;apple&quot;</span></span><br><span class="line">3) <span class="string">&quot;blue&quot;</span></span><br><span class="line">4) <span class="string">&quot;green&quot;</span></span><br><span class="line">5) <span class="string">&quot;purple&quot;</span></span><br><span class="line">6) <span class="string">&quot;red&quot;</span></span><br><span class="line"><span class="comment"># 从返回结果可以看出，列表color最左端的元素mango已经不存在了，因此说明我们成功移除列表color最左端的元素。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># LLEN命令获取列表中值的长度，也就是元素的个数。</span></span><br><span class="line">127.0.0.1:6379&gt; llen color</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line"><span class="comment"># 从上述返回结果“6”可以看出，列表color中值的长度为6，即说明列表color中共有六个元素，即元素banana、apple、blue、green、purple、red。 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># LREM命令移除列表中的指定元素。精确匹配，比如“取关”。</span></span><br><span class="line">127.0.0.1:6379&gt; rpush mycolor <span class="string">&quot;hello&quot;</span> <span class="string">&quot;hello&quot;</span> <span class="string">&quot;world&quot;</span> <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange mycolor 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;world&quot;</span></span><br><span class="line">4) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrem mycolor -2 hello</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lrange mycolor 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line"><span class="comment"># 先执行“rpush color &quot;hello&quot; &quot;hello&quot; &quot;world&quot; &quot;hello&quot;”命令，从列表mycolor的右端推入4个元素，然后再演示从左往右移除列表mycolor中值为hello的两个元素，并执行“lrange mycolor 0 -1命令，查看列表中值为hello的2个元素是否被移除</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 补充知识点</span></span><br><span class="line"><span class="comment"># Ltrim 修剪。list中只想保留一部分元素， 即截断。</span></span><br><span class="line">127.0.0.1:6379&gt; lrange color 0 -1</span><br><span class="line">1) <span class="string">&quot;banana&quot;</span></span><br><span class="line">2) <span class="string">&quot;apple&quot;</span></span><br><span class="line">3) <span class="string">&quot;blue&quot;</span></span><br><span class="line">4) <span class="string">&quot;green&quot;</span></span><br><span class="line">5) <span class="string">&quot;purple&quot;</span></span><br><span class="line">6) <span class="string">&quot;red&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; LTRIM color 1 4</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange color 0 -1</span><br><span class="line">1) <span class="string">&quot;apple&quot;</span></span><br><span class="line">2) <span class="string">&quot;blue&quot;</span></span><br><span class="line">3) <span class="string">&quot;green&quot;</span></span><br><span class="line">4) <span class="string">&quot;purple&quot;</span></span><br><span class="line"><span class="comment"># 通过下标截取指定的长度，即下标[1-4]，list已被改变，只剩下截取的元素！</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># rpoplpush 移除列表的最后一个元素，将他移动到新的列表中！ rpoplpush 组合命令是原子性操作，在处理并发问题的时候占有优势（比如获取添加订单成功的第一个用户，使用lpush操作，再使用RPOPLPUSH，使得第一个用户在秒杀18:08:00中实现付款成功并记录唯一）</span></span><br><span class="line">127.0.0.1:6379&gt; LPUSH order zhangsan</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; LPUSH order lisi</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; LPUSH order wangwu</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; LPUSH order zhaoliu</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; LRANGE order 0 -1</span><br><span class="line">1) <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line">2) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">3) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">4) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; RPOPLPUSH order paylist</span><br><span class="line"><span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; LRANGE paylist 0 -1</span><br><span class="line">1) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br><span class="line"><span class="comment"># Lset将列表中指定下标的值替换为另外一个值，更新操作 Lset（要求列表和下标必须都存在）</span></span><br><span class="line">127.0.0.1:6379&gt; EXISTS mycolor			<span class="comment">#判断这个列表是否存在</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lrange mycolor 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; LPUSH mycolor value</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange mycolor 0 -1</span><br><span class="line">1) <span class="string">&quot;value&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; LSET mycolor 0 newvalue		<span class="comment">#如果存在，更新当前下标的值</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange mycolor 0 -1</span><br><span class="line">1) <span class="string">&quot;newvalue&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; LSET mycolor 4 newworld		<span class="comment">#如果不存在，则会报错！索引（下标）越界异常</span></span><br><span class="line">(error) ERR index out of range</span><br><span class="line">127.0.0.1:6379&gt; LSET mycolor 2 newworld</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange mycolor 0 -1</span><br><span class="line">1) <span class="string">&quot;newvalue&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;newworld&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linsert将某个具体的value插入到列中某个元素的前面或者后面！ </span></span><br><span class="line">127.0.0.1:6379&gt; lrange mycolor 0 -1</span><br><span class="line">1) <span class="string">&quot;newvalue&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;newworld&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; LINSERT mycolor before newworld my</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; LINSERT mycolor after newworld welcome</span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line">127.0.0.1:6379&gt; lrange mycolor 0 -1</span><br><span class="line">1) <span class="string">&quot;newvalue&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;my&quot;</span></span><br><span class="line">4) <span class="string">&quot;newworld&quot;</span></span><br><span class="line">5) <span class="string">&quot;welcome&quot;</span> </span><br></pre></td></tr></table></figure>

<p>小结：</p>
<ul>
<li>实际上是一个双向链表，before Node after ， left，right 都可以插入值</li>
<li>如果 key 不存在，插入即可创建新的链表</li>
<li>如果 key 存在，插入即可新增内容</li>
<li>如果移除了所有值，就是空链表，也就是没有节点，也代表不存在！</li>
<li>在两边插入或者改动值，效率最高！ 如果链表很长，你要操作中间元素，相对来说效率会低一点~（更适合分布式）</li>
</ul>
<p>消息排队！消息队列 （Lpush Rpop）， 栈（ Lpush Lpop）！</p>
<h5 id="3-操作Sets集合"><a href="#3-操作Sets集合" class="headerlink" title="3 操作Sets集合"></a>3 操作Sets集合</h5><p>Set集合由<strong>不重复且无序</strong>的字符串元素组成的，其中，**<u>不重复</u><strong>意味着一个集合中的所有字符串都是唯一的，这是与List列表的第一个区别；</strong><u>无序</u>**意味着所有字符串的读写是任意位置的，而List列表中元素的读写必须要从头部或尾部开始操作，因此，这是与List列表的第二个区别。</p>
<p>![image-20220417224343885](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172243094.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172243094.png</a>)</p>
<p>SBookid为集合的键名，100021、100022、100020、100023均为集合中键的值。由于Set集合中不允许出现重复的元素，因此Set集合中的元素均是唯一的，并且元素都是无序的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SADD 将一个或多个元素添加到集合中</span></span><br><span class="line">127.0.0.1:6379&gt; sadd databases <span class="string">&quot;redis&quot;</span> <span class="string">&quot;mongodb&quot;</span> <span class="string">&quot;hbase&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line"><span class="comment"># 从上述返回结果“3”可以看出，我们成功将三个元素 redis、mongodb、hbase 添加到集合databases中。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># SCARD命令获取集合中的元素数量</span></span><br><span class="line">127.0.0.1:6379&gt; scard databases</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line"><span class="comment"># 从上述返回结果“3”可以看出，集合databases中包含三个元素。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SMEMBERS命令获取集合中的所有元素</span></span><br><span class="line">127.0.0.1:6379&gt; smembers databases</span><br><span class="line">1) <span class="string">&quot;hbase&quot;</span></span><br><span class="line">2) <span class="string">&quot;mongodb&quot;</span></span><br><span class="line">3) <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="comment"># 从上述返回结果可以看出，集合databases中包含的元素为hbase、mongodb以及hbase。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># SISMEMBER命令判断指定元素是否存在于集合中 注意 set中的值是不能重复的！</span></span><br><span class="line">127.0.0.1:6379&gt;  sismember databases redis</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 我们演示检查元素redis是否存在于集合databases，若存在则返回1，反之返回0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># SREM命令移除集合中的一个或多个已存在的元素</span></span><br><span class="line">127.0.0.1:6379&gt; srem databases hbase</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers databases</span><br><span class="line">1) <span class="string">&quot;mongodb&quot;</span></span><br><span class="line">2) <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="comment"># 我们演示移除集合databases中的元素hbase，并执行“smembers databases”命令，查看元素hbase是否被移除</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># SMOVE命令将元素从一个集合移动到另一个集合</span></span><br><span class="line">127.0.0.1:6379&gt; sadd databasesNew <span class="string">&quot;mysql&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMOVE databases databasesNew redis</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS databasesNew</span><br><span class="line">1) <span class="string">&quot;mysql&quot;</span></span><br><span class="line">2) <span class="string">&quot;redis&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS databases</span><br><span class="line">1) <span class="string">&quot;mongodb&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"><span class="comment"># 我们演示将元素redis从集合databases中移动到集合databasesNew中（注：首先执行“sadd databasesNew &quot;mysql&quot;”命令，创建集合databasesNew并插入元素“mysql”，并执行“smove databases databasesNew redis”命令，查看是否成功将元素redis从集合databases中移动到databasesNew中</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 补充</span></span><br><span class="line"><span class="comment"># set 无序不重复集合。抽随机！Srandmember</span></span><br><span class="line">127.0.0.1:6379&gt; sadd myroom zhangsan lisi wangwu zhaoliu</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myroom</span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line">3) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">4) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myroom 		<span class="comment">#随机抽选出一个元素</span></span><br><span class="line"><span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myroom </span><br><span class="line"><span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myroom </span><br><span class="line"><span class="string">&quot;lisi&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myroom 2	<span class="comment">#随机抽选出指定个数的元素</span></span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myroom 2</span><br><span class="line">1) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除定的key，随机删除key！Spop</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myroom</span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line">3) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">4) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sadd myroom tom jacky john </span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myroom</span><br><span class="line">1) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line">3) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">4) <span class="string">&quot;jacky&quot;</span></span><br><span class="line">5) <span class="string">&quot;john&quot;</span></span><br><span class="line">6) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">7) <span class="string">&quot;tom&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; spop myroom			<span class="comment"># 随机删除一个set集合中的元素</span></span><br><span class="line"><span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; spop myroom 3		<span class="comment"># 随机删除制定个数的set集合中的元素</span></span><br><span class="line">1) <span class="string">&quot;jacky&quot;</span></span><br><span class="line">2) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">3) <span class="string">&quot;tom&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myroom</span><br><span class="line">1) <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line">2) <span class="string">&quot;john&quot;</span></span><br><span class="line">3) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 微博，B站，共同关注！(并集) 数字集合类： - -差集 SDIFF -- 交集 SINTER -- 并集 SUNION</span></span><br><span class="line">127.0.0.1:6379&gt; sadd zhoujielun <span class="string">&quot;zhangsan&quot;</span> <span class="string">&quot;lisi&quot;</span> <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; sadd chenyixun <span class="string">&quot;lisi&quot;</span> <span class="string">&quot;wangwu&quot;</span> <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS zhoujielun</span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">3) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS chenyixun</span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line">3) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 差集，所有属于A且不属于B的元素的集合被称为A与B的差集</span></span><br><span class="line">127.0.0.1:6379&gt; sdiff zhoujielun chenyixun	</span><br><span class="line">1) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sdiff chenyixun zhoujielun</span><br><span class="line">1) <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 交集 共同好友就可以这样实现</span></span><br><span class="line">127.0.0.1:6379&gt; sinter zhoujielun chenyixun</span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 并集</span></span><br><span class="line">127.0.0.1:6379&gt; sunion zhoujielun chenyixun</span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhaoliu&quot;</span></span><br><span class="line">3) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">4) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line"><span class="comment"># 微博、B站，A用户将所有关注的人放在一个set集合中！将ta的粉丝也放在一个集合中！</span></span><br><span class="line"><span class="comment"># 可以实现：</span></span><br><span class="line"><span class="comment"># 共同关注（交集），共同爱好，二度好友（好友的好友），推荐好友！（六度分割理论）</span></span><br></pre></td></tr></table></figure>



<h5 id="4-操作Hash散列"><a href="#4-操作Hash散列" class="headerlink" title="4 操作Hash散列"></a>4 操作Hash散列</h5><p>Hash散列可以存储多个键值对之间的映射，属于无序的一种数据集合与字符串类似，Hash散列存储键的类型<strong>必须为字符串</strong>，而值的类型既可以是字符串也可以是数字，但是值必须是唯一的，不可重复。Hash散列的键之间可以采用“：”符号隔开，增加用户的可阅读性，并为用户提供更多的信息。</p>
<p>![image-20220417224410715](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172244929.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172244929.png</a>)</p>
<p>“Book：name”、“Book：id”、“Book：author”以及“Book：price”为散列的键名，“《格局》”、“100022”、“wujun”以及“45”均为散列中键对应的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HSET命令为散列中指定键设置值</span></span><br><span class="line">127.0.0.1:6379&gt; hset article title <span class="string">&quot;greeting&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 我们演示为散列article中的键title设置值greeting，若是散列article中不存在指定键title，则进行创建和赋值操作，并返回1，若是散列article中存在键title，则进行覆盖操作，并返回0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HSET命令为散列中多个键设置值。HMSET是用于为散列中的多个键设置值的命令；key表示散列；field value [field value ...]表示散列中的一个或多个键及其对应的值</span></span><br><span class="line">127.0.0.1:6379&gt; hmset article content <span class="string">&quot;Hello World&quot;</span> author <span class="string">&quot;peter&quot;</span></span><br><span class="line">OK</span><br><span class="line"><span class="comment"># 我们演示为散列article中的键content、author分别设置值Hello World、peter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HGET命令获取散列中指定键的值</span></span><br><span class="line">127.0.0.1:6379&gt; hget article title</span><br><span class="line"><span class="string">&quot;greeting&quot;</span></span><br><span class="line"><span class="comment"># 从上述返回结果可以看出，散列article中键title的值为greeting</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HMGET命令获取散列中多个键的值</span></span><br><span class="line">127.0.0.1:6379&gt; hmget article content author</span><br><span class="line">1) <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">2) <span class="string">&quot;peter&quot;</span></span><br><span class="line"><span class="comment"># 从上述返回结果可以看出，散列article中键content和键author的值分别为Hello World和peter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HGETALL命令获取散列中的所有键值对</span></span><br><span class="line">127.0.0.1:6379&gt;  hgetall article</span><br><span class="line">1) <span class="string">&quot;title&quot;</span></span><br><span class="line">2) <span class="string">&quot;greeting&quot;</span></span><br><span class="line">3) <span class="string">&quot;content&quot;</span></span><br><span class="line">4) <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">5) <span class="string">&quot;author&quot;</span></span><br><span class="line">6) <span class="string">&quot;peter&quot;</span></span><br><span class="line"><span class="comment"># 从上述返回结果可以看出，散列article中所有的键值对均打印出来</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HKEYS命令获取散列中的所有键</span></span><br><span class="line">127.0.0.1:6379&gt; hkeys article</span><br><span class="line">1) <span class="string">&quot;title&quot;</span></span><br><span class="line">2) <span class="string">&quot;content&quot;</span></span><br><span class="line">3) <span class="string">&quot;author&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HVALS命令获取散列中的所有键的值</span></span><br><span class="line">127.0.0.1:6379&gt; hvals article</span><br><span class="line">1) <span class="string">&quot;greeting&quot;</span></span><br><span class="line">2) <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">3) <span class="string">&quot;peter&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HDEL命令删除散列中指定键及其相对应的值</span></span><br><span class="line">127.0.0.1:6379&gt; hdel article title</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall article</span><br><span class="line">1) <span class="string">&quot;content&quot;</span></span><br><span class="line">2) <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">3) <span class="string">&quot;author&quot;</span></span><br><span class="line">4) <span class="string">&quot;peter&quot;</span></span><br><span class="line"><span class="comment"># 我们演示删除散列article中键title及其对应的值greeting，并通过执行“hgetall article”命令，查看键title及其对应的值greeting是否被删除</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 补充</span></span><br><span class="line"><span class="comment"># 想成一个Map集合，key-map&lt;key-value&gt;这个值是一个map集合！ 本质和String类型没有太大区别，还是一个简单的key-vlaue</span></span><br><span class="line"><span class="comment"># key表示散列，field value（map）表示散列中一个或多个键及其对应的值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取散列中键的数量 hlen</span></span><br><span class="line">127.0.0.1:6379&gt; hgetall article</span><br><span class="line">1) <span class="string">&quot;content&quot;</span></span><br><span class="line">2) <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">3) <span class="string">&quot;author&quot;</span></span><br><span class="line">4) <span class="string">&quot;peter&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hlen article</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line"><span class="comment"># 判断散列中的键是否存在HEXISTS</span></span><br><span class="line">127.0.0.1:6379&gt; HEXISTS article author</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># hash变更的数据 user name age,尤其是是用户信息之类的，经常变动的信息！ hash 更适合于对象的存储，String更加适合字符串存储！</span></span><br></pre></td></tr></table></figure>



<h5 id="5-操作Zset-Sorted-Sets有序集合"><a href="#5-操作Zset-Sorted-Sets有序集合" class="headerlink" title="5 操作Zset &#x2F; Sorted Sets有序集合"></a>5 操作Zset &#x2F; Sorted Sets有序集合</h5><p>Sorted Sets有序集合和散列类似，主要区别是有序集合是按照值进行自动排序的，而散列中的值是不排序的；有序集合可以直接对值进行操作，而散列是通过键来查找值。有序集合中的键必须是唯一的，但是值可以是重复的，而散列的值是唯一的。</p>
<p>![image-20220417224446387](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172244717.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204172244717.png</a>)</p>
<p>有序集合是按照值的大小进行排序的，其中，“Book：id04”、“Book：id02”、“Book：id03”以及“Book：id01”为有序集合的键名，100021、100022、100023以及100023均为有序集合中键对应的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ZADD命令为有序集合添加一个或多个键值对</span></span><br><span class="line">127.0.0.1:6379&gt; zadd salary 5000 <span class="string">&quot;Peter&quot;</span> 3500 <span class="string">&quot;Tom&quot;</span> 6000 <span class="string">&quot;Jack&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line"><span class="comment"># 我们演示为有序集合salary添加三个键值对，分别为“分值5000，元素Peter”、“分值3500，元素Tom”以及“分值6000，元素Jack”</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ZCARD命令获取有序集合中元素的个数</span></span><br><span class="line">127.0.0.1:6379&gt; zcard salary</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ZCOUNT命令统计有序集合中指定分值范围内的元素个数</span></span><br><span class="line">127.0.0.1:6379&gt; zcount salary 2000 5000</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line"><span class="comment"># 我们演示统计有序集合salary中分值范围在[2000，5000]内的元素个数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ZRANGE命令获取有序集合中指定索引范围内的元素</span></span><br><span class="line">127.0.0.1:6379&gt; zrange salary 0 1</span><br><span class="line">1) <span class="string">&quot;Tom&quot;</span></span><br><span class="line">2) <span class="string">&quot;Peter&quot;</span></span><br><span class="line"><span class="comment"># 我们演示获取有序集合salary中指定索引范围[0，1]内的元素</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ZSCORE命令获取有序集合中指定元素的分值</span></span><br><span class="line">127.0.0.1:6379&gt; zscore salary <span class="string">&quot;Peter&quot;</span></span><br><span class="line"><span class="string">&quot;5000&quot;</span></span><br><span class="line"><span class="comment"># 我们演示获取有序集合salary中指定元素Peter的分值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ZREM命令移除有序集合中的指定元素</span></span><br><span class="line">127.0.0.1:6379&gt; zrem salary <span class="string">&quot;Jack&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange salary 0 -1</span><br><span class="line">1) <span class="string">&quot;Tom&quot;</span></span><br><span class="line">2) <span class="string">&quot;Peter&quot;</span></span><br><span class="line"><span class="comment"># 我们演示移除有序集合salary中的指定元素Jack，并执行“zrange salary 0 -1”命令，查看元素Jack是否被移除</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 补充</span></span><br><span class="line"><span class="comment"># 在set的基础上，增加了一个值，set k1 v1 -- zset k1 score1 v1</span></span><br><span class="line"><span class="comment"># 为有序集合salary添加三个键值对：分值 5000 - 元素张三、3500-lisi、6000-wangwu等</span></span><br><span class="line">127.0.0.1:6379&gt; zadd 2022salary 5000 <span class="string">&quot;zhangsan&quot;</span> 3500 <span class="string">&quot;lisi&quot;</span> 6000 <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zcard 2022salary			<span class="comment">#获取有序集合中元素的个数</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zrange 2022salary 0 -1		<span class="comment">#获取有序集合中所有的元素</span></span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">3) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zcount 2022salary 1000 5000		<span class="comment">#统计有序集合中指定分值范围内元素的个数</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示全部的用户，按分值从小到大！</span></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore 2022salary -inf +inf	</span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">3) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从大到进行排序</span></span><br><span class="line">127.0.0.1:6379&gt; zrevrange 2022salary 0 -1</span><br><span class="line">1) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">3) <span class="string">&quot;lisi&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示全部的用户（小到大）并且附带分值</span></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore 2022salary -inf +inf withscores</span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;3500&quot;</span></span><br><span class="line">3) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">4) <span class="string">&quot;5000&quot;</span></span><br><span class="line">5) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">6) <span class="string">&quot;6000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示工资小于等于5000员工的升序排序</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf 5000 withscores</span><br><span class="line">1) <span class="string">&quot;lisi&quot;</span></span><br><span class="line">2) <span class="string">&quot;3500&quot;</span></span><br><span class="line">3) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">4) <span class="string">&quot;5000&quot;</span></span><br><span class="line"><span class="comment"># 显示工资大于等于5000员工的升序排序</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary 5000 +inf withscores</span><br><span class="line">1) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">2) <span class="string">&quot;5000&quot;</span></span><br><span class="line">3) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">4) <span class="string">&quot;6000&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>

<ul>
<li>不同的是每个元素都会关联一个double类型的分数（score）。redis正是通过分数来为集合中的成员进行从小到大的排序。</li>
<li>score相同：按字典顺序排序</li>
<li>有序集合的成员是唯一的,但分数(score)却可以重复。</li>
</ul>
<p>案例思路：set 多了一个排序，set能做的原则上zset都可以做。</p>
<p>​	1、存储班级成绩表，工资表排序！</p>
<p>​	2、带权重进行判断，普通消息标1， 重要消息 标2！</p>
<p>​	3、排行榜应用实现，比如B站，所有的播放量、评分全部放到有序集合中，然后进行遍历，设置每天凌晨刷新一次，取Top N 测试！</p>
<h4 id="三种特殊数据类型"><a href="#三种特殊数据类型" class="headerlink" title="三种特殊数据类型"></a>三种特殊数据类型</h4><h5 id="1-Geospatial-地理位置"><a href="#1-Geospatial-地理位置" class="headerlink" title="1 Geospatial(地理位置)"></a>1 Geospatial(地理位置)</h5><p>朋友的定位，附近的人，打车距离计算？</p>
<p>Redis 的 Geo 在Redis3.2 版本就推出了！ <strong>这个功能可以推算地理位置的信息，两地之间的距离，方圆几里的人</strong></p>
<p>只有 六个命令：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="第7章 键值对存储数据库Redis.https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202205012053123.png" alt="image-20220501205319891" style="zoom:80%;" />

<p>官方文档：<a target="_blank" rel="noopener" href="https://redis.io/commands/geoadd/">GEOADD | Redis</a></p>
<p>中文 ：<a target="_blank" rel="noopener" href="https://www.redis.net.cn/order/3685.html">https://www.redis.net.cn/order/3685.html</a></p>
<blockquote>
<p>使用经纬度定位地理坐标并用一个<strong>有序集合zset保存</strong>，所以zset命令也可以使用</p>
</blockquote>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>geoadd key longitud(经度) latitude(纬度) member [..]</code></td>
<td>将具体经纬度的坐标存入一个有序集合</td>
</tr>
<tr>
<td><code>geopos key member [member..]</code></td>
<td>获取集合中的一个&#x2F;多个成员坐标</td>
</tr>
<tr>
<td><code>geodist key member1 member2 [unit]</code></td>
<td>返回两个给定位置之间的距离。默认以米作为单位。</td>
</tr>
<tr>
<td>&#96;georadius key longitude latitude radius m</td>
<td>km</td>
</tr>
<tr>
<td><code>GEORADIUSBYMEMBER key member radius...</code></td>
<td>功能与GEORADIUS相同，只是中心位置不是具体的经纬度，而是使用结合中已有的成员作为中心点。</td>
</tr>
<tr>
<td><code>geohash key member1 [member2..]</code></td>
<td>返回一个或多个位置元素的Geohash表示。使用Geohash位置52点整数编码。</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">----------------geoadd---------------------</span><br><span class="line"><span class="comment"># 添加地理位置</span></span><br><span class="line"> 规则：地球两极无法直接添加，我们一般会下载城市数据，直接通过java程序一次性导入！ </span><br><span class="line"> 有效的经度从-180度到180度。 </span><br><span class="line"> 有效的纬度从-85.05112878度到85.05112878度。 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 当坐标位置超出上述指定范围时，该命令将会返回一个错误。 </span></span><br><span class="line"><span class="comment"># 127.0.0.1:6379&gt; geoadd china:city 39.90 116.40 beijin</span></span><br><span class="line">(error) ERR invalid longitude,latitude pair 39.900000,116.400000</span><br><span class="line"></span><br><span class="line"><span class="comment"># getadd 添加地理位置  </span></span><br><span class="line"><span class="comment"># GEOADD key [ NX | XX] [CH] longitude latitude member [ longitude latitude member ...]</span></span><br><span class="line"><span class="comment"># 参数 key（经度、维度、名称）</span></span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 116.40 39.90 beijing</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 121.47 31.23 shanghai</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 120.16 30.24 hangzhou 108.96 34.26 xian</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 106.50 29.53 chongqing 114.05 22.52 shenzhen</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">----------------geopos---------------------</span><br><span class="line"><span class="comment"># 获取指定的城市的经度和纬度</span></span><br><span class="line">127.0.0.1:6379&gt; GEOPOS china:city beijing	</span><br><span class="line">1) 1) <span class="string">&quot;116.39999896287918091&quot;</span></span><br><span class="line">   2) <span class="string">&quot;39.90000009167092543&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEOPOS china:city beijing chongqing</span><br><span class="line">1) 1) <span class="string">&quot;116.39999896287918091&quot;</span></span><br><span class="line">   2) <span class="string">&quot;39.90000009167092543&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;106.49999767541885376&quot;</span></span><br><span class="line">   2) <span class="string">&quot;29.52999957900659211&quot;</span></span><br><span class="line"></span><br><span class="line">----------------geodist---------------------</span><br><span class="line"><span class="comment"># GEODIST 两人之间的距离！</span></span><br><span class="line"> </span><br><span class="line">指定单位的参数 **unit** 必须是以下单位的其中一个：</span><br><span class="line">m 表示单位为米。</span><br><span class="line">km 表示单位为千米。</span><br><span class="line">mi 表示单位为英里。</span><br><span class="line">ft 表示单位为英尺。</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; GEODIST china:city beijing shanghai km	<span class="comment"># 查看上海到北京的直线距离</span></span><br><span class="line"><span class="string">&quot;1067.3788&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEODIST china:city beijing chongqing km	<span class="comment"># 查看重庆到北京的直线距离</span></span><br><span class="line"><span class="string">&quot;1464.0708&quot;</span></span><br><span class="line"></span><br><span class="line">----------------georadius---------------------</span><br><span class="line"><span class="comment"># georadius 以给定的经纬度为中心， 找出某一半径内的元素 (附近的人)</span></span><br><span class="line"> </span><br><span class="line">我附近的人？ （获得所有附近的人的地址，定位！）通过半径来查询！</span><br><span class="line">获得指定数量的人，200</span><br><span class="line">所有数据应该都录入：china:city ，才会让结果更加请求！</span><br><span class="line">    withcoord:带上坐标；</span><br><span class="line">    withdist:带上距离，单位与半径单位相同；</span><br><span class="line">    COUNT n : 只显示前n个(按距离递增排序)</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 1000 km</span><br><span class="line">		<span class="comment"># 以110，30 这个经纬度为中心，寻找方圆1000km内的城市</span></span><br><span class="line">1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">2) <span class="string">&quot;xian&quot;</span></span><br><span class="line">3) <span class="string">&quot;shengzhen&quot;</span></span><br><span class="line">4) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km</span><br><span class="line">1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">2) <span class="string">&quot;xian&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist	    </span><br><span class="line">1) 1) <span class="string">&quot;chongqing&quot;</span>		<span class="comment"># 查询经纬度(110,30)坐标500km半径内的成员，带距离</span></span><br><span class="line">   2) <span class="string">&quot;341.9374&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xian&quot;</span></span><br><span class="line">   2) <span class="string">&quot;483.8340&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withcoord  </span><br><span class="line">1) 1) <span class="string">&quot;chongqing&quot;</span>		<span class="comment"># 查询经纬度(110,30)坐标500km半径内的成员，带坐标</span></span><br><span class="line">   2) 1) <span class="string">&quot;106.49999767541885376&quot;</span></span><br><span class="line">      2) <span class="string">&quot;29.52999957900659211&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xian&quot;</span></span><br><span class="line">   2) 1) <span class="string">&quot;108.96000176668167114&quot;</span></span><br><span class="line">      2) <span class="string">&quot;34.25999964418929977&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist withcoord count 1</span><br><span class="line">1) 1) <span class="string">&quot;chongqing&quot;</span>	<span class="comment"># 筛选出指定的结果(按距离递增排序)</span></span><br><span class="line">   2) <span class="string">&quot;341.9374&quot;</span></span><br><span class="line">   3) 1) <span class="string">&quot;106.49999767541885376&quot;</span></span><br><span class="line">      2) <span class="string">&quot;29.52999957900659211&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;  GEORADIUS china:city 110 30 500 km withdist withcoord count 2</span><br><span class="line">1) 1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;341.9374&quot;</span></span><br><span class="line">   3) 1) <span class="string">&quot;106.49999767541885376&quot;</span></span><br><span class="line">      2) <span class="string">&quot;29.52999957900659211&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xian&quot;</span></span><br><span class="line">   2) <span class="string">&quot;483.8340&quot;</span></span><br><span class="line">   3) 1) <span class="string">&quot;108.96000176668167114&quot;</span></span><br><span class="line">      2) <span class="string">&quot;34.25999964418929977&quot;</span></span><br><span class="line"></span><br><span class="line">----------------georadiusbymember---------------------</span><br><span class="line"><span class="comment"># GEORADIUSBYMEMBER 找出位于指定元素周围的其他元素！</span></span><br><span class="line">127.0.0.1:6379&gt;  GEORADIUSBYMEMBER china:city beijing 1000 km</span><br><span class="line">1) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">2) <span class="string">&quot;xian&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;  GEORADIUSBYMEMBER china:city shanghai 400 km</span><br><span class="line">1) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">2) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------geohash---------------------</span><br><span class="line"><span class="comment"># GEOHASH 命令 - 返回一个或多个位置元素的 Geohash 表示；该命令将返回11个字符的Geohash字符串！#将二维的经纬度转换为一维的字符串，如果两个字符串越接近，那么则距离越近！</span></span><br><span class="line">127.0.0.1:6379&gt; geohash china:city beijing chongqing shanghai xian</span><br><span class="line">1) <span class="string">&quot;wx4fbxxfke0&quot;</span></span><br><span class="line">2) <span class="string">&quot;wm5xzrybty0&quot;</span></span><br><span class="line">3) <span class="string">&quot;wtw3sj5zbj0&quot;</span></span><br><span class="line">4) <span class="string">&quot;wqj6zky6bn0&quot;</span></span><br><span class="line"><span class="comment"># GEO 底层的实现原理其实就是 Zset！我们可以使用Zset命令来操作geo！</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGE china:city 0 -1	<span class="comment"># 查看地图中全部的元素</span></span><br><span class="line">1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">2) <span class="string">&quot;xian&quot;</span></span><br><span class="line">3) <span class="string">&quot;shengzhen&quot;</span></span><br><span class="line">4) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">5) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">6) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; ZREM china:city beijing <span class="comment"># 比如隐藏或关闭定位</span></span><br></pre></td></tr></table></figure>

<h5 id="2-Hyperloglog-基数统计"><a href="#2-Hyperloglog-基数统计" class="headerlink" title="2 Hyperloglog(基数统计)"></a>2 Hyperloglog(基数统计)</h5><p>什么是基数？</p>
<blockquote>
<p>A  {1,3,5,7,8,7}      B  {1,3,5,7,8}</p>
<p>基数（不重复的元素） &#x3D; 5，可以接受误差！0.81%错误率</p>
</blockquote>
<blockquote>
<p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数。如果用set存储用户ID，对服务器的负载太大。</p>
<p>因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<p>其底层使用string数据类型</p>
</blockquote>
<p><strong>什么是基数？</strong></p>
<blockquote>
<p>数据集中不重复的元素的个数。</p>
</blockquote>
<p><strong>应用场景：</strong></p>
<p>网页的访问量（UV）：页面访问量。一个用户多次访问，也只能算作一个人。</p>
<blockquote>
<p>传统实现，set 保存用户的id, 然后每次进行比较。（垃圾代码）当用户变多之后这种方式及其浪费空间，而我们的目的只是<strong>计数</strong>。</p>
<p>Hyperloglog就能帮助我们利用最小的空间完成。</p>
</blockquote>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>PFADD key element1 [elememt2..]</code></td>
<td>添加指定元素到 HyperLogLog 中</td>
</tr>
<tr>
<td><code>PFCOUNT key [key]</code></td>
<td>返回给定 HyperLogLog 的基数估算值。</td>
</tr>
<tr>
<td><code>PFMERGE destkey sourcekey [sourcekey..]</code></td>
<td>将多个 HyperLogLog 合并为一个 HyperLogLog</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">----------PFADD--PFCOUNT---------------------</span><br><span class="line">127.0.0.1:6379&gt; PFADD myelemx a b c d e f g h i j k <span class="comment"># 创建第一组测试元素</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> myelemx <span class="comment"># hyperloglog底层使用String</span></span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT myelemx <span class="comment"># 估算myelemx的基数</span></span><br><span class="line">(<span class="built_in">integer</span>) 11</span><br><span class="line">127.0.0.1:6379&gt; PFADD myelemy i j k z m c b v p q s <span class="comment"># 创建第二组测试元素</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT myelemy</span><br><span class="line">(<span class="built_in">integer</span>) 11</span><br><span class="line"></span><br><span class="line">----------------PFMERGE-----------------------</span><br><span class="line">127.0.0.1:6379&gt; PFMERGE myelemz myelemx myelemy <span class="comment"># 合并两组测试集合myelemx和myelemy 成为myelemz</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT myelemz <span class="comment"># 估算基数</span></span><br><span class="line">(<span class="built_in">integer</span>) 17</span><br></pre></td></tr></table></figure>

<p>如果允许容错，那么一定可以使用Hyperloglog !</p>
<p>如果不允许容错，就使用set或者自己的数据类型即可 ！</p>
<h5 id="3-BitMaps-位图"><a href="#3-BitMaps-位图" class="headerlink" title="3 BitMaps(位图)"></a>3 BitMaps(位图)</h5><blockquote>
<p>使用位存储，信息状态只有 0 和 1</p>
<p>Bitmap是一串连续的2进制数字（0或1），每一位所在的位置为偏移(offset)，在bitmap上可执行AND,OR,XOR,NOT以及其它位操作。</p>
</blockquote>
<p><strong>应用场景</strong></p>
<p>签到统计、状态统计</p>
<p>为什么其他教程都不喜欢讲这些？这些在生活中或者开发中，都有十分多的应用场景，学习了，就是就是多一个思路！</p>
<p>位存储</p>
<p>统计用户信息，活跃or不活跃！ 登录or未登录！ 点赞orXXX！公告已读or未读！  <strong>两个状态的，且不需要延迟保存的，都可以使用Bitmaps！这样数据库不会臃肿</strong></p>
<p>统计疫情感染人数： 0 0 0 0 1 0 0（感染的用1 没有感染的用0），就可以快速的取出一个差值</p>
<p>Bitmap 位图，数据结构！ 都是操作二进制位来进行记录，就只有0 和 1 两个状态！</p>
<blockquote>
<p>365 天 &#x3D; 365 bit 1字节 &#x3D; 8bit 46 个字节左右！</p>
<p>使用bitmap 来记录 周一到周日的打卡！周一：1 周二：0 周三：0 周四：1 ……（java for循环可以搞定）</p>
</blockquote>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>setbit key offset value</code></td>
<td>为指定key的offset位设置值</td>
</tr>
<tr>
<td><code>getbit key offset</code></td>
<td>获取offset位的值</td>
</tr>
<tr>
<td><code>bitcount key [start end]</code></td>
<td>统计字符串被设置为1的bit数，也可以指定统计范围按字节</td>
</tr>
<tr>
<td><code>bitop operration destkey key[key..]</code></td>
<td>对一个或多个保存二进制位的字符串 key 进行位元操作，并将结果保存到 destkey 上。</td>
</tr>
<tr>
<td><code>BITPOS key bit [start] [end]</code></td>
<td>返回字符串里面第一个被设置为1或者0的bit位。start和end只能按字节,不能按位</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">------------setbit--getbit--------------</span><br><span class="line">使用bitmap 来记录 周一到周日的打卡！</span><br><span class="line">周一：1 周二：0 周三：0 周四：1 ......（java <span class="keyword">for</span>循环可以搞定）</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 0 1	<span class="comment">#周一打卡签到</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 1 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 2 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 3 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 4 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 5 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 6 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit sign 3	<span class="comment">#查看周四是否有打卡！</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit sign 6	<span class="comment">#查看周日是否有打卡！</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">--------------------bitcount-------------------</span><br><span class="line">127.0.0.1:6379&gt; bitcount sign 	<span class="comment"># 统计这周的打卡记录，就可以看到是否有全勤！ 注意，如果需要保存打卡记录，使用redis注意数据持久化。</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure>



<h3 id="使用Java操作Redis"><a href="#使用Java操作Redis" class="headerlink" title="使用Java操作Redis"></a>使用Java操作Redis</h3><h4 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h4><p>1、打开IDEA，新建一个project，可以选择Java项目或者Maven项目（推荐）。并添加项目名称并制定项目的存储路径。</p>
<p>![image-20220429132323149](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291323580.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291323580.png</a>)</p>
<p>下图为选择maven的设置</p>
<p>![image-20220429134048702](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291340978.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291340978.png</a>)</p>
<p>文件 pom.xml 参考代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="line">         xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.itcast.redis&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;nosql_chapter07&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.0</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;!--导入jedis的包--&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/redis.clients/jedis --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;redis.clients&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jedis&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">3.2</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/commons-pool/commons-pool --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-pool&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-pool&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.6</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.hamcrest/hamcrest-core --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.hamcrest&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;hamcrest-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.3</span>&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/junit/junit --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">4.12</span>&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.2</span><span class="number">.75</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;<span class="number">8</span>&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;<span class="number">8</span>&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>![image-20220429134119293](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291341590.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291341590.png</a>)</p>
<p>2、检查或修改该项目中Project和Modules的jdk版本，此处使用1.8版本</p>
<p>![image-20220429134302072](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291343348.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291343348.png</a>)</p>
<p>![image-20220429134336032](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291343331.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291343331.png</a>)</p>
<p>![image-20220429134359905](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291344206.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291344206.png</a>)</p>
<p>3、点击Settings-javac，检查或修改版本为8</p>
<p>![image-20220429134512812](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291345060.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291345060.png</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 永久解决maven启动后JDK版本自动跳转为1.5的方法 写入到pom.xml中</span></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;!--修改Language level--&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;!--修改Java Compiler--&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br></pre></td></tr></table></figure>

<p>4、在项目pom.xml文件中导入对应的依赖jedis、fastjson、commons-pool、hamcrest-core、junit并选择对应的版本 可访问Maven网站进行查询<a target="_blank" rel="noopener" href="https://mvnrepository.com/%EF%BC%8C%E4%BE%8B%E5%A6%82jedis">https://mvnrepository.com/，例如jedis</a></p>
<p>![image-20220429134656341](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291346508.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291346508.png</a>)</p>
<p>![image-20220429134714971](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291347263.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291347263.png</a>)</p>
<p>或者复制代码后 联网重载maven</p>
<p>![image-20220429134845653](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291348883.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291348883.png</a>)</p>
<p>5、新建测试类</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> 连接外网首先有在redis.conf改几个设置</span><br><span class="line">1.daemonize <span class="built_in">yes</span></span><br><span class="line">2.注释 <span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">3.protected-mode no</span><br><span class="line">其次看一下自己防火墙对端口号开没开放</span><br><span class="line">firewall-cmd --query-port=6379/tcp</span><br><span class="line">如果是<span class="built_in">yes</span>就是开放的</span><br><span class="line">然后 redis-server etc/redis.conf</span><br><span class="line">redis-cli -h 自己外网端口号 -p 6379</span><br><span class="line">最后ping一下如果pong就成功了</span><br></pre></td></tr></table></figure>

<p>![image-20220429140334643](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291403954.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202204291403954.png</a>)</p>
<p>测试类Testping.java参考文件如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: Joker</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/4/2913:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Testping</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1、 new Jedis 对象即可</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.24.105&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">// 2、jedis 所有的命令就是我们之前学习的所有指令！所以之前的指令学习很重要</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> jedis.ping();</span><br><span class="line">        System.out.println(<span class="string">&quot;服务启动...&quot;</span> + response); <span class="comment">// PONG</span></span><br><span class="line"></span><br><span class="line">        jedis.flushDB();</span><br><span class="line">        jedis.set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;FeiBaobao&quot;</span>);</span><br><span class="line">        jedis.set(<span class="string">&quot;age&quot;</span>,<span class="string">&quot;28&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//String get = jedis.get(&quot;name&quot;);</span></span><br><span class="line">        System.out.println(<span class="string">&quot;当前数据库中的成员是：&quot;</span> + jedis.get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;当前数据库中的成员的年龄是：&quot;</span> + jedis.get(<span class="string">&quot;age&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="操作键"><a href="#操作键" class="headerlink" title="操作键"></a>操作键</h4><p>在test包下创建TestKeyOperate.java文件，该文件用于编写java操作Redis键的代码。 </p>
<p>![image-20220515223002814](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202205152230303.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202205152230303.png</a>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: Joker</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/5/1522:01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestKeyOperate</span> &#123;</span><br><span class="line">    <span class="comment">//声明Jedis成员对象，用于提供Redis数据库连接</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.24.105&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    <span class="comment">//主程序入口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;服务启动...&quot;</span> + jedis.ping());</span><br><span class="line">        jedis.flushDB();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为指定键company设置值itcast</span></span><br><span class="line"><span class="comment">     * 若返回值结果为OK，则说明成功为指定键设置值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> jedis.set(<span class="string">&quot;company&quot;</span>, <span class="string">&quot;itcast&quot;</span>);</span><br><span class="line">        System.out.println(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为多个键设置值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">msetTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">manyKey</span> <span class="operator">=</span> jedis.mset(<span class="string">&quot;brand1&quot;</span>, <span class="string">&quot;heima&quot;</span>, <span class="string">&quot;brand2&quot;</span>, <span class="string">&quot;chuanzhihui&quot;</span>, <span class="string">&quot;brand3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;kudingyu&quot;</span>,<span class="string">&quot;brand4&quot;</span>,<span class="string">&quot;boxuegu&quot;</span>,<span class="string">&quot;brand5&quot;</span>,<span class="string">&quot;czzxxy&quot;</span>,<span class="string">&quot;brand6&quot;</span>,<span class="string">&quot;yuanxiaobang&quot;</span>);</span><br><span class="line">        System.out.println(manyKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看所有符合给定模式pattern(正则表达式)的键。</span></span><br><span class="line"><span class="comment">     *  通过jedis调用keys()方法，传入参数&quot; * &quot;，则表示查看Redis数据库中所有的键。</span></span><br><span class="line"><span class="comment">     *  调用iterator()方法，将查到的键存放到一个迭代器中，并使用while循环遍历输出符合给定模式的键。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">keysTest</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;String&gt; keys = jedis.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        Iterator&lt;String&gt; itKeys = keys.iterator();</span><br><span class="line">        <span class="keyword">while</span> (itKeys.hasNext())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> itKeys.next();</span><br><span class="line">            System.out.println(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取多个键的对应值</span></span><br><span class="line"><span class="comment">     * 通过for循环遍历输出这三个键对应的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mgetTest</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; values = jedis.mget(<span class="string">&quot;brand1&quot;</span>, <span class="string">&quot;brand3&quot;</span>, <span class="string">&quot;brand&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String value : values) &#123;</span><br><span class="line">            System.out.println(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断键是否存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">existTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">result1</span> <span class="operator">=</span> jedis.exists(<span class="string">&quot;company&quot;</span>);</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">result2</span> <span class="operator">=</span> jedis.exists(<span class="string">&quot;brand0&quot;</span>);</span><br><span class="line">        System.out.println(result1+<span class="string">&quot;------------&quot;</span>+result2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改指定键的名字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">renameTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">rename</span> <span class="operator">=</span> jedis.rename(<span class="string">&quot;company&quot;</span>, <span class="string">&quot;companyNew&quot;</span>);</span><br><span class="line">        System.out.println(rename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除指定键 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> jedis.del(<span class="string">&quot;companyNew&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="操作字符串"><a href="#操作字符串" class="headerlink" title="操作字符串"></a>操作字符串</h4><p>在test包下创建TestStringOperate.java文件，该文件用于编写java操作Redis字符串的代码。</p>
<p>![image-20220515224408393](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202205152244690.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202205152244690.png</a>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: Joker</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/5/1522:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStringOperate</span> &#123;</span><br><span class="line">    <span class="comment">//声明Jedis成员对象，用于提供Redis数据库连接</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.24.105&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    <span class="comment">//主程序入口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;服务启动...&quot;</span> + jedis.ping());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定字符串的旧键，并设置新建。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getsetTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">oldValue</span> <span class="operator">=</span> jedis.getSet(<span class="string">&quot;brand1&quot;</span>, <span class="string">&quot;itcast&quot;</span>);</span><br><span class="line">        System.out.println(oldValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定字符串的键的长度。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">strlenTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">valueLen</span> <span class="operator">=</span> jedis.strlen(<span class="string">&quot;brand6&quot;</span>);</span><br><span class="line">        System.out.println(valueLen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取字符串键指定索引范围的键的内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getrangeTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> jedis.getrange(<span class="string">&quot;brand6&quot;</span>, <span class="number">4</span>, <span class="number">7</span>);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在指定字符串键的值末尾追加新内容 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">appendTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">len</span> <span class="operator">=</span> jedis.append(<span class="string">&quot;brand1&quot;</span>, <span class="string">&quot;heima&quot;</span>);</span><br><span class="line">        System.out.println(len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="操作列表"><a href="#操作列表" class="headerlink" title="操作列表"></a>操作列表</h4><p>在test包下创建TestListOperate.java文件，该文件用于编写java操作Redis字符串的代码。</p>
<p>![image-20220515230116767](第7章 键值对存储数据库Redis.<a target="_blank" rel="noopener" href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202205152301122.png">https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/202205152301122.png</a>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: Joker</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/5/1522:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestListOperate</span> &#123;</span><br><span class="line">    <span class="comment">//声明Jedis成员对象，用于提供Redis数据库连接</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.24.105&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    <span class="comment">//主程序入口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;服务启动...&quot;</span> + jedis.ping());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将一个或多个元素推入到列表中</span></span><br><span class="line"><span class="comment">     * 将元素&quot;blue&quot;, &quot;green&quot;, &quot;purple&quot;, &quot;red&quot;, &quot;white&quot;从列表color的右端推入，并返回color中元素的个数</span></span><br><span class="line"><span class="comment">     * 将元素&quot;black&quot;,&quot;pink&quot;从列表color的左端推入，并返回color中元素的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rpushAndLpushTest</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//将5个元素推入列表color的右端</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">rpush</span> <span class="operator">=</span> jedis.rpush(<span class="string">&quot;color&quot;</span>, <span class="string">&quot;blue&quot;</span>, <span class="string">&quot;green&quot;</span>, <span class="string">&quot;purple&quot;</span>, <span class="string">&quot;red&quot;</span>, <span class="string">&quot;white&quot;</span>);</span><br><span class="line">        <span class="comment">//将3个元素推入列表color的左端</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">lpush</span> <span class="operator">=</span> jedis.lpush(<span class="string">&quot;color&quot;</span>, <span class="string">&quot;black&quot;</span>,<span class="string">&quot;pink&quot;</span>);</span><br><span class="line">        System.out.println(rpush+<span class="string">&quot;-----&quot;</span>+lpush);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取列表指定索引范围内的元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lrangeTest</span> <span class="params">()</span>&#123;</span><br><span class="line">        List&lt;String&gt; values = jedis.lrange(<span class="string">&quot;color&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (String value : values) &#123;</span><br><span class="line">            System.out.println(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取列表指定索引位置上的元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lindexTest</span> <span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> jedis.lindex(<span class="string">&quot;color&quot;</span>, <span class="number">5</span>);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除列表最左端的元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lpopTest</span> <span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> jedis.lpop(<span class="string">&quot;color&quot;</span>);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取列表中元素的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">llenTest</span> <span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">len</span> <span class="operator">=</span> jedis.llen(<span class="string">&quot;color&quot;</span>);</span><br><span class="line">        System.out.println(len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除列表中的指定元素</span></span><br><span class="line"><span class="comment">     * 调用lrem()方法，用于从列表color的表头开始向表尾搜索，移除搜索到的第一个值为red的元素，若返回值为1则说明移除成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lremTest</span> <span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> jedis.lrem(<span class="string">&quot;color&quot;</span>, <span class="number">1</span>, <span class="string">&quot;red&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="作业："><a href="#作业：" class="headerlink" title="作业："></a>作业：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itcast.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.ListPosition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStrL</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Jedis jedis=<span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.24.105&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ping</span> <span class="operator">=</span> jedis.ping();</span><br><span class="line">        System.out.println(<span class="string">&quot;数据库正在连接：&quot;</span>+jedis.ping());</span><br><span class="line">        System.out.println(<span class="string">&quot;数据库正在清空：&quot;</span>+jedis.flushDB());</span><br><span class="line">        System.out.println(<span class="string">&quot;查看当前数据库：&quot;</span>+jedis.keys(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.</span></span><br><span class="line">    <span class="comment">//为指定字符串键“name”设置值（你的姓名），并判断键“name”是否存在。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testKey</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> jedis.set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;张楚岚&quot;</span>);</span><br><span class="line">        System.out.println(key);</span><br><span class="line">        System.out.println(<span class="string">&quot;判断键“name”是否存在:&quot;</span>+jedis.exists(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="comment">//使用 “msetnx”，设置键“age”、“stuNo”的值分别是你的班级、学号，并使用MGET获取姓名、年龄、学号相关信息。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMsetnx</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">manykey</span> <span class="operator">=</span> jedis.msetnx(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;20&quot;</span>, <span class="string">&quot;stuNo&quot;</span>, <span class="string">&quot;123456789&quot;</span>);</span><br><span class="line">        System.out.println(manykey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMget</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;String&gt; mget = jedis.mget(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;stuNo&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String mkey : mget)&#123;</span><br><span class="line">            System.out.println(mkey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.</span></span><br><span class="line">    <span class="comment">//获取指定字符串键“name”的旧值并设置新值为“www.itczh.com”，并查询“name”的值。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetSet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> jedis.getSet(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;www.itczh.com&quot;</span>);</span><br><span class="line">        System.out.println(key);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前name的值：&quot;</span>+jedis.get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.</span></span><br><span class="line">    <span class="comment">//为指定字符串键“name”的值末尾追加新内容“张三”（张三修改为你的姓名），并查询“name”的值。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAppend</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">append</span> <span class="operator">=</span> jedis.append(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;张楚岚&quot;</span>);</span><br><span class="line">        System.out.println(append);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前name的值：&quot;</span>+jedis.get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.</span></span><br><span class="line">    <span class="comment">//将一个或多个元素推入到列表的右端。插入到列表尾部 （右）,将若干个元素（你&lt;放在第一位&gt;及宿舍中的其他人，可以使用中文名字）推入列表dorm 的右端</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRpush</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">rpush</span> <span class="operator">=</span> jedis.rpush(<span class="string">&quot;dorm&quot;</span>, <span class="string">&quot;肖自在&quot;</span>, <span class="string">&quot;黑管儿&quot;</span>, <span class="string">&quot;高二壮&quot;</span>, <span class="string">&quot;老孟&quot;</span>, <span class="string">&quot;王震球&quot;</span>);</span><br><span class="line">        System.out.println(rpush);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.</span></span><br><span class="line">    <span class="comment">//将一个或多个元素推入到列表的左端。(双向链表)插入到列表头部 （左），将以下3个元素（&quot;张楚岚&quot;,&quot;冯宝宝&quot;,&quot;陈朵&quot;）推入列表dorm的左端；并使用命令获取列表“dorm”的指定索引（0，-1）范围内的元素。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLpush</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">lpush</span> <span class="operator">=</span> jedis.lpush(<span class="string">&quot;dorm&quot;</span>, <span class="string">&quot;张楚岚&quot;</span>, <span class="string">&quot;冯宝宝&quot;</span>, <span class="string">&quot;陈朵&quot;</span>);</span><br><span class="line">        System.out.println(lpush);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLrange</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;String&gt; list = jedis.lrange(<span class="string">&quot;dorm&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (String l : list)&#123;</span><br><span class="line">            System.out.println(l);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7.</span></span><br><span class="line">    <span class="comment">//通过命令实现列表中只保留下标[2 - 5]的元素，完成后查询列表中所有的元素。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLtrim</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ltrim</span> <span class="operator">=</span> jedis.ltrim(<span class="string">&quot;dorm&quot;</span>, <span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">        System.out.println(ltrim);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//8.</span></span><br><span class="line">    <span class="comment">//将列表中指定下标[3]的值替换为另外一个值为：张三，完成后查询列表中的所有元素。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLset</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lset</span> <span class="operator">=</span> jedis.lset(<span class="string">&quot;dorm&quot;</span>, <span class="number">3</span>, <span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        System.out.println(lset);</span><br><span class="line">        System.out.println(<span class="string">&quot;列表中指定下标[3]的值:&quot;</span>+jedis.lindex(<span class="string">&quot;dorm&quot;</span>,<span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//9.</span></span><br><span class="line">    <span class="comment">//将某个具体的值（“大数据”）插入到列中元素“张三”的前面，完成后查询列表中的所有元素。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLinsert</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">linsert</span> <span class="operator">=</span> jedis.linsert(<span class="string">&quot;dorm&quot;</span>, ListPosition.BEFORE, <span class="string">&quot;张三&quot;</span>, <span class="string">&quot;大数据&quot;</span>);</span><br><span class="line">        System.out.println(linsert);</span><br><span class="line">        System.out.println(<span class="string">&quot;列表中指定下标[3]的值:&quot;</span>+jedis.lindex(<span class="string">&quot;dorm&quot;</span>,<span class="number">3</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;列表中指定下标[4]的值:&quot;</span>+jedis.lindex(<span class="string">&quot;dorm&quot;</span>,<span class="number">4</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testShutdown</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shutdown</span> <span class="operator">=</span> jedis.shutdown();</span><br><span class="line">        System.out.println(shutdown);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="操作集合"><a href="#操作集合" class="headerlink" title="操作集合"></a>操作集合</h4><h4 id="操作散列"><a href="#操作散列" class="headerlink" title="操作散列"></a>操作散列</h4><h4 id="操作有序集合"><a href="#操作有序集合" class="headerlink" title="操作有序集合"></a>操作有序集合</h4><h2 id="十六、列式存储数据库HBase"><a href="#十六、列式存储数据库HBase" class="headerlink" title="十六、列式存储数据库HBase"></a>十六、列式存储数据库HBase</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231119192614668.png" alt="image-20231119192614668"></p>
<p>列式存储数据库也是NoSQL数据库的一种类型。顾名思义，列式存储数据库中的数据是基于列进行存储的。常见的列式存储数据库有HBase、Cassandra、Riak以及HyperTable。由于HBase数据库基于Hadoop生态系统，利用HBase集群可在多台廉价PC Server上实现结构化数据的分布式数据存储，从而处理海量的数据。</p>
<h3 id="HBase的概述"><a href="#HBase的概述" class="headerlink" title="HBase的概述"></a>HBase的概述</h3><h4 id="Hbase的来源"><a href="#Hbase的来源" class="headerlink" title="Hbase的来源"></a>Hbase的来源</h4><p>2006年Google技术人员Fay Chang发布了一篇文章<code>Bigtable: ADistributed Storage System for Structured Data</code>。该文章向世人介绍了一种分布式的数据库，这种数据库可以在局部几台服务器崩溃的情况下继续提供高性能的服务。</p>
<p>2007年Powerset公司的工作人员基于此文研发了<strong>BigTable的Java开源版本</strong>，即HBase。刚开始它只是Hadoop的一部分。</p>
<p>2008年HBase成为了<strong>Apache的顶级项目</strong>。HBase几乎实现了BigTable的所有特性。它被称为一个开源的非关系型分布式数据库。</p>
<p><strong>2010</strong>年HBase的开发速度打破了一直以来跟Hadoop版本一致的惯例，因为<strong>HBase的版本发布速度已经超越了Hadoop</strong>。它的版本号一下从0.20.x跳跃到了0.89.x。其Logo也进行了更换！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231119192801154.png" alt="image-20231119192801154"></p>
<h4 id="HBase定义"><a href="#HBase定义" class="headerlink" title="HBase定义"></a>HBase定义</h4><p><a target="_blank" rel="noopener" href="https://hbase.apache.org/">Apache HBase – Apache HBase™ Home</a></p>
<p>HBase是一个基于Java、开源的、高可靠性、高性能、面向列、可伸缩的列式非关系型数据库，也可以称为列式分布式数据库（简称HBase分布式数据库）。</p>
<p><strong>Hbase面向列存储，构建于Hadoop之上，类似于Google的BigTable，提供一个十亿级行百万级列级别的表存储，对表中的数据提供实时的随机读写操作！</strong></p>
<p>（1）HBase支持随机写</p>
<p>​		① HBase的读写操作还是借助HDFS完成，要完成随机写，根本上还是需要符合HDFS的特性！</p>
<p>​		② HDFS只支持追加写！</p>
<p>​		③ 随机的操作： Update+Delete 借助  追加写+时间戳(版本号)</p>
<p>​		④ 只允许客户端查询时返回时间戳最新的数据！</p>
<p>（2）HBase支持海量数据的实时读写</p>
<p>​		①分布式</p>
<p>​		②索引，LSM树（MySQL B+Tree 多路平衡查找树）</p>
<p>​		③kv</p>
<p>​		④吃内存</p>
<p>​		⑤列式存储</p>
<p>​		⑥布隆过滤器（查询）</p>
<h4 id="HBase的特点"><a href="#HBase的特点" class="headerlink" title="HBase的特点"></a>HBase的特点</h4><p>1）海量存储</p>
<p>HBase适合存储PB级别的海量数据，在PB级别的数据以及采用廉价PC存储的情况下，能在几十到百毫秒内返回数据。这与HBase的极易扩展性息息相关。正式因为HBase良好的扩展性，才为海量数据的存储提供了便利。</p>
<p>2）列式存储</p>
<p>这里的列式存储其实说的是列族存储，HBase是根据列族来存储数据的。列族下面可以有非常多的列，列族在创建表的时候就必须指定。</p>
<p>3）极易扩展</p>
<p>HBase的扩展性主要体现在两个方面，一个是基于上层处理能力（RegionServer）的扩展，一个是基于存储的扩展（HDFS）。</p>
<p>通过横向添加RegionSever的机器，进行水平扩展，提升HBase上层的处理能力，提升Hbsae服务更多Region的能力。</p>
<p>4）高并发</p>
<p>由于目前大部分使用HBase的架构，都是采用的廉价PC，因此单个IO的延迟其实并不小，一般在几十到上百ms之间。这里说的高并发，主要是在并发的情况下，HBase的单个IO延迟下降并不多。能获得高并发、低延迟的服务。</p>
<p>5）稀疏</p>
<p>稀疏主要是针对HBase列的灵活性，在列族中，你可以指定任意多的列，在列数据为空的情况下，是不会占用存储空间的。</p>
<h4 id="Hbase的优点"><a href="#Hbase的优点" class="headerlink" title="Hbase的优点"></a>Hbase的优点</h4><p>①HDFS有高容错，高扩展的特点，而Hbase基于HDFS实现数据的存储，因此Hbase拥有与生俱来的超强的扩展性和吞吐量。</p>
<p>②HBase采用的是Key&#x2F;Value的存储方式，这意味着，即便面临海量数据的增长，也几乎不会导致查询性能下降。</p>
<p>③HBase是一个列式数据库，相对于于传统的行式数据库而言。当你的单张表字段很多的时候，可以将相同的列(以regin为单位)存在到不同的服务实例上，分散负载压力。</p>
<h4 id="Hbase的缺点"><a href="#Hbase的缺点" class="headerlink" title="Hbase的缺点"></a>Hbase的缺点</h4><p>①架构设计复杂，且使用HDFS作为分布式存储，因此只是存储少量数据，它也不会很快。在大数据量时，它慢的不会很明显！</p>
<p>②Hbase不支持表的关联操作，因此数据分析是HBase的弱项。常见的 group by或order by只能通过编写MapReduce来实现！</p>
<p>③Hbase部分支持了ACID</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231119191732815.png" alt="image-20231119191732815"></p>
<p>HBase作为一种数据库，它与传统数据库相比有很大区别，下面从存储模式、表字段以及可延伸性这三个方面分别进行介绍。</p>
<table>
<thead>
<tr>
<th><strong>存储模式</strong></th>
</tr>
</thead>
<tbody><tr>
<td>传统数据库中是基于行存储的，而HBase是基于列进行存储的。</td>
</tr>
<tr>
<td><strong>表字段</strong></td>
</tr>
<tr>
<td>传统数据库中的表字段不能超过30个，而HBase的表字段不作限制。</td>
</tr>
<tr>
<td><strong>可延伸性</strong></td>
</tr>
<tr>
<td>传统数据库中的列是固定的，需要先确定列有多少才会增加数据去存储，而HBase是根据数据存储的大小去动态的增加列，列是不固定的，但是列族是固定的。</td>
</tr>
</tbody></table>
<p><strong><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231119191824403.png" alt="image-20231119191824403"></strong></p>
<h3 id="HBase的数据模型"><a href="#HBase的数据模型" class="headerlink" title="HBase的数据模型"></a><strong>HBase的数据模型</strong></h3><p>HBase分布式数据库的数据存储在行列式的表格中，它是一个多维度的映射模型，其数据模型如图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231119192132067.png" alt="image-20231119192132067"></p>
<table>
<thead>
<tr>
<th><strong>Row Key（行键）</strong></th>
</tr>
</thead>
<tbody><tr>
<td>RowKey表示行键，每个HBase表中只能有一个行键，类似于主键，它在HBase中以字典序的方式存储。由于RowKey是HBase表的唯一标识，因此Row Key的设计非常重要。数据的存储规则是相近的数据存储到一起。例如，当Row Key格式为<a target="_blank" rel="noopener" href="http://www.apache.org、mail.apache.org以及jira.apache.org这样的网站名称时,可以将网站名称进行反转,反转成org.apache.www、org.apache.mail以及org.apache.jira,然后进行存储,所有org.apache域名将会存储在一起,避免子域名(即www、mail、jira)分散在各处./">www.apache.org、mail.apache.org以及jira.apache.org这样的网站名称时，可以将网站名称进行反转，反转成org.apache.www、org.apache.mail以及org.apache.jira，然后进行存储，所有org.apache域名将会存储在一起，避免子域名（即www、mail、jira）分散在各处。</a></td>
</tr>
<tr>
<td><strong>Column Family（列族）</strong></td>
</tr>
<tr>
<td>在HBase中，列族由多个列组成。HBase会尽量把同一个列族的列放在同一个服务器上，这样可以提高读写数据的性能，并且可以批量管理多个有关联的列。HBase中数据的属性都是定义在列族上，同一个列族内的所有列具有相同的属性。在HBase中创建数据表时，定义的是列族，而不是列。c1、c2、c3均为列族名。</td>
</tr>
<tr>
<td><strong>Column（列）</strong></td>
</tr>
<tr>
<td>HBase表的列是由列族名、限定符以及列名组成的，其中“：”为限定符。创建HBase表不需要指定列，因为列是可变的，非常灵活。</td>
</tr>
<tr>
<td><strong>Timestamp（时间戳）</strong></td>
</tr>
<tr>
<td>表示时间戳，记录每次操作数据的时间，通常记作数据的版本号。</td>
</tr>
</tbody></table>
<p>逻辑上，HBase的数据模型同关系型数据库很类似，数据存储在一张表中，有行有列。但从HBase的底层物理存储结构（K-V）来看，HBase更像是一个multi-dimensional map。</p>
<h4 id="HBase逻辑结构"><a href="#HBase逻辑结构" class="headerlink" title="HBase逻辑结构"></a>HBase逻辑结构</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/wps1.png"> </p>
<h4 id="HBase物理存储结构"><a href="#HBase物理存储结构" class="headerlink" title="HBase物理存储结构"></a>HBase物理存储结构</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/wps2.png"></p>
<h3 id="HBase的架构"><a href="#HBase的架构" class="headerlink" title="HBase的架构"></a><strong>HBase的架构</strong></h3><p>HBase构建在Hadoop分布式文件系统（HDFS）之上，HDFS为HBase提供了高可靠的底层存储支持，Hadoop分布式计算框架（MapReduce）为HBase提供了高性能的计算能力，分布式协作框架（Zookeeper）为HBase提供了稳定服务和容错机制。下面，通过一张图介绍一下HBase的整体架构，具体如图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231119192319247.png" alt="image-20231119192319247"></p>
<p>HBase中存储在HDFS中的数据是通过Zookeeper协调处理的。由于HBase存在单点故障的问题，因此，可以通过Zookeeper部署一个高可用的HBase集群解决。下面，以三台服务器为例（nosql01、nosql02和nosql03），讲解如何安装部署HBase高可用集群。HBase高可用集群的规划方式如图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231119192416792.png" alt="image-20231119192416792"></p>
<p>HBase高可用集群中的nosql01和nosql02是主节点，nosql02和nosql03是从节点。这里之所以将nosql02既部署为主节点也部署为从节点，其目的是为了避免HBase集群主节点宕机导致单点故障问题。</p>
<h3 id="HBase的部署"><a href="#HBase的部署" class="headerlink" title="HBase的部署"></a><strong>HBase的部署</strong></h3><h4 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a><strong>安装JDK</strong></h4><h5 id="1-上传软件包-jdk-8u211-linux-x64-tar-gz"><a href="#1-上传软件包-jdk-8u211-linux-x64-tar-gz" class="headerlink" title="1 上传软件包 jdk-8u211-linux-x64.tar.gz"></a>1 上传软件包 jdk-8u211-linux-x64.tar.gz</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# <span class="built_in">cd</span> /opt/</span><br><span class="line">[root@Server01 opt]# ll</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 3 root root 21 3月   4 21:09 module</span><br><span class="line">drwxr-xr-x 3 root root 28 8月  28 2023 rh</span><br><span class="line">drwxr-xr-x 2 root root 52 3月   4 21:09 soft</span><br><span class="line">[root@Server01 opt]# <span class="built_in">cd</span> soft/</span><br><span class="line">[root@Server01 soft]# ll</span><br><span class="line">总用量 130320</span><br><span class="line">-rw-r--r-- 1 root root 133445425 11月  1 2023 mongodb-linux-x86_64-rhel80-4.2.24.tgz</span><br><span class="line">[root@Server01 soft]# </span><br></pre></td></tr></table></figure>

<p>把安装包上传至服务器该路径下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240528222908619.png" alt="image-20240528222908619"></p>
<h5 id="2-解压软件包-jdk-8u211-linux-x64-tar-gz"><a href="#2-解压软件包-jdk-8u211-linux-x64-tar-gz" class="headerlink" title="2 解压软件包 jdk-8u211-linux-x64.tar.gz"></a>2 解压软件包 jdk-8u211-linux-x64.tar.gz</h5><p>解压安装包，并移动到 &#x2F;opt&#x2F;software&#x2F;下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 soft]# <span class="built_in">mkdir</span> /opt/module/jvm</span><br><span class="line">[root@Server01 soft]# tar -zxvf jdk-8u211-linux-x64.tar.gz </span><br><span class="line">jdk1.8.0_211/</span><br><span class="line">jdk1.8.0_211/lib/</span><br><span class="line">......</span><br><span class="line">jdk1.8.0_211/COPYRIGHT</span><br><span class="line">[root@Server01 soft]# <span class="built_in">mv</span> jdk1.8.0_211 /opt/module/jvm/</span><br><span class="line">[root@Server01 soft]# ll /opt/module/jvm/jdk1.8.0_211/</span><br><span class="line">总用量 25984</span><br><span class="line">drwxr-xr-x 2 10 143     4096 4月   2 2019 bin</span><br><span class="line">-r--r--r-- 1 10 143     3244 4月   2 2019 COPYRIGHT</span><br><span class="line">drwxr-xr-x 3 10 143      132 4月   2 2019 include</span><br><span class="line">-rw-r--r-- 1 10 143  5213268 3月  14 2019 javafx-src.zip</span><br><span class="line">drwxr-xr-x 5 10 143      185 4月   2 2019 jre</span><br><span class="line">drwxr-xr-x 5 10 143      245 4月   2 2019 lib</span><br><span class="line">-r--r--r-- 1 10 143       44 4月   2 2019 LICENSE</span><br><span class="line">drwxr-xr-x 4 10 143       47 4月   2 2019 man</span><br><span class="line">-r--r--r-- 1 10 143      159 4月   2 2019 README.html</span><br><span class="line">-rw-r--r-- 1 10 143      424 4月   2 2019 release</span><br><span class="line">-rw-r--r-- 1 10 143 21105019 4月   2 2019 src.zip</span><br><span class="line">-rw-r--r-- 1 10 143   112748 3月  14 2019 THIRDPARTYLICENSEREADME-JAVAFX.txt</span><br><span class="line">-r--r--r-- 1 10 143   149725 4月   2 2019 THIRDPARTYLICENSEREADME.txt</span><br><span class="line">[root@Server01 soft]# <span class="built_in">cd</span></span><br></pre></td></tr></table></figure>

<h5 id="3-添加环境变量"><a href="#3-添加环境变量" class="headerlink" title="3 添加环境变量"></a>3 添加环境变量</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# vi /etc/profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/module/jvm/jdk1.8.0_211/</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Server01 ~]# <span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment">#获取java进程的状态</span></span><br><span class="line">[root@Server01 ~]# jps -v</span><br><span class="line">4909 Jps -Dapplication.home=/opt/module/jvm/jdk1.8.0_211 -Xms8m</span><br><span class="line">[root@Server01 ~]# </span><br></pre></td></tr></table></figure>

<h4 id="安装Hadoop（伪分布式）"><a href="#安装Hadoop（伪分布式）" class="headerlink" title="安装Hadoop（伪分布式）"></a>安装Hadoop（伪分布式）</h4><h5 id="0-完全分布式集群（了解）"><a href="#0-完全分布式集群（了解）" class="headerlink" title="0 完全分布式集群（了解）"></a>0 完全分布式集群（了解）</h5><p>hadoop的初衷是采用大量的廉价机器，组成一个集群！完成大数据的存储和计算！</p>
<p>​		HDFS（框架）:负责大数据的存储</p>
<p>​		YARN（框架）： 负责大数据的资源调度</p>
<p>​		MR(编程模型)： 使用Hadoop制定的编程要求，编写程序，完成大数据的计算！</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#################### 规划 ############################</span><br><span class="line">Hadoop中的进程在多台机器运行！</span><br><span class="line"></span><br><span class="line">	HDFS:  <span class="number">1</span>个nn+N个DN</span><br><span class="line">			n个<span class="number">2</span>nn</span><br><span class="line">	YARN:  <span class="number">1</span>个RM+N个NM</span><br><span class="line">	</span><br><span class="line">	避免单点故障，NN和RM建议分散到多台机器！</span><br><span class="line">	注意负载均衡</span><br><span class="line">hadoop101 hadoop102 hadoop103</span><br><span class="line">DN			DN			DN</span><br><span class="line">NM			NM			NM</span><br><span class="line">NN			RM			<span class="number">2</span>NN</span><br><span class="line">#####################################################</span><br><span class="line"></span><br><span class="line"># HDFS</span><br><span class="line">负责大数据的存储</span><br><span class="line">	核心进程：</span><br><span class="line">	必须进程：</span><br><span class="line">		<span class="built_in">Namenode</span>(<span class="number">1</span>个)： 负责文件，名称等元数据(属性信息)的存储！</span><br><span class="line">						文件名，大小，文件切分了多少块(block)，创建和修改时间等！</span><br><span class="line">						</span><br><span class="line">				职责： 接受客户端的请求！</span><br><span class="line">					   接受DN的请求！</span><br><span class="line">					   向DN分配任务！</span><br><span class="line">		<span class="built_in">Datanode</span>(N个)： 负责文件中数据的存储！</span><br><span class="line">				职责：  负责接受NM分配的任务！</span><br><span class="line">						负责数据块(block)的管理(读，写)！</span><br><span class="line">		</span><br><span class="line">	可选进程：</span><br><span class="line">		<span class="built_in">SecondaryNamenode</span>(N个):  负责辅助NameNode工作！</span><br><span class="line"></span><br><span class="line"># YARN</span><br><span class="line">		YARN负责集群中所有计算资源的管理和调度！</span><br><span class="line">		</span><br><span class="line">		常见进程：</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">ResourceManager</span>(<span class="number">1</span>个):   负责整个集群所有资源的管理！</span><br><span class="line">				职责： 负责接受客户端的提交Job的请求！</span><br><span class="line">						负责向NM分配任务！</span><br><span class="line">						负责接受NM上报的信息！</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">NodeManager</span>(N个):  负责单台计算机所有资源的管理！</span><br><span class="line">				职责：  负责和RM进行通信，上报本机中的可用资源！</span><br><span class="line">						负责领取RM分配的任务！</span><br><span class="line">						负责为Job中的每个Task分配计算资源！</span><br></pre></td></tr></table></figure>



<h5 id="1-准备工作（至少4G内存）："><a href="#1-准备工作（至少4G内存）：" class="headerlink" title="1 准备工作（至少4G内存）："></a><strong>1 准备工作（至少4G内存）：</strong></h5><p>安装软件，在一台机器安装，再将这台机器的软件复制到其他机器</p>
<h6 id="（1）验证是否安装JDK：Hadoop运行的前提是本机已经安装了JDK，配置JAVA-HOME变量"><a href="#（1）验证是否安装JDK：Hadoop运行的前提是本机已经安装了JDK，配置JAVA-HOME变量" class="headerlink" title="（1）验证是否安装JDK：Hadoop运行的前提是本机已经安装了JDK，配置JAVA_HOME变量"></a><strong>（1）验证是否安装JDK：Hadoop运行的前提是本机已经安装了JDK，配置JAVA_HOME变量</strong></h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@Server01 ~]# jps</span><br><span class="line">3055 Jps</span><br><span class="line">[root@Server01 ~]# </span><br></pre></td></tr></table></figure>

<h5 id="（2）验证是否host映射：在Hadoop中启动多种不同类型的进程"><a href="#（2）验证是否host映射：在Hadoop中启动多种不同类型的进程" class="headerlink" title="（2）验证是否host映射：在Hadoop中启动多种不同类型的进程"></a><strong>（2）验证是否host映射：在Hadoop中启动多种不同类型的进程</strong></h5><p>​		<strong>例如NN,DN，RM,NM，这些进程需要进行通信！</strong><br>​		<strong>在通信时，常用主机名进行通信！</strong></p>
<p>​	<strong>在192.168.24.105机器上的DN进程，希望访问 192.168.24.105 机器的NN进程！</strong><br><strong>​	需要在集群的每台机器上，配置集群中所有机器的host映射！</strong></p>
<p>​			Linux:   &#x2F;etc&#x2F;hosts<br>​			Windows：  C:\Windows\System32\drivers\etc\hosts</p>
<p><strong>​	配置：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Linux:   /etc/hosts   做映射，IP地址在前，主机名在后</span></span><br><span class="line">[root@Server01 ~]# hostname</span><br><span class="line">Server01</span><br><span class="line">[root@Server01 ~]# hostnamectl set-hostname nosql100</span><br><span class="line">[root@Server01 ~]# hostname</span><br><span class="line">nosql100</span><br><span class="line">[root@Server01 ~]# vim /etc/hosts</span><br><span class="line"></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.24.105 nosql100</span><br><span class="line"></span><br><span class="line">[root@Server01 ~]# <span class="built_in">exit</span></span><br><span class="line">注销</span><br><span class="line"></span><br><span class="line">Connection closed.</span><br><span class="line"></span><br><span class="line">Disconnected from remote host(NoSQL) at 22:41:07.</span><br><span class="line"></span><br><span class="line">Type `<span class="built_in">help</span><span class="string">&#x27; to learn how to use Xshell prompt.</span></span><br><span class="line"><span class="string">[C:\~]$ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Connecting to 192.168.24.105:22...</span></span><br><span class="line"><span class="string">Connection established.</span></span><br><span class="line"><span class="string">To escape to local shell, press &#x27;</span>Ctrl+Alt+]<span class="string">&#x27;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Activate the web console with: systemctl enable --now cockpit.socket</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Last login: Tue May 28 22:23:52 2024 from 192.168.10.1</span></span><br><span class="line"><span class="string">[root@nosql100 ~]# </span></span><br><span class="line"><span class="string">[root@nosql100 ~]# nmcli device show ens160 </span></span><br><span class="line"><span class="string">GENERAL.DEVICE:                         ens160</span></span><br><span class="line"><span class="string">GENERAL.TYPE:                           ethernet</span></span><br><span class="line"><span class="string">GENERAL.HWADDR:                         00:0C:29:29:B7:CD</span></span><br><span class="line"><span class="string">GENERAL.MTU:                            1500</span></span><br><span class="line"><span class="string">GENERAL.STATE:                          100（已连接）</span></span><br><span class="line"><span class="string">GENERAL.CONNECTION:                     ens160</span></span><br><span class="line"><span class="string">GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveConnection/1</span></span><br><span class="line"><span class="string">WIRED-PROPERTIES.CARRIER:               开</span></span><br><span class="line"><span class="string">IP4.ADDRESS[1]:                         192.168.24.105/24</span></span><br><span class="line"><span class="string">IP4.GATEWAY:                            192.168.10.254</span></span><br><span class="line"><span class="string">IP4.ROUTE[1]:                           dst = 192.168.10.0/24, nh = 0.0.0.0, mt = 100</span></span><br><span class="line"><span class="string">IP4.ROUTE[2]:                           dst = 0.0.0.0/0, nh = 192.168.10.254, mt = 100</span></span><br><span class="line"><span class="string">IP4.DNS[1]:                             192.168.10.254</span></span><br><span class="line"><span class="string">IP6.ADDRESS[1]:                         fe80::20c:29ff:fe29:b7cd/64</span></span><br><span class="line"><span class="string">IP6.GATEWAY:                            --</span></span><br><span class="line"><span class="string">IP6.ROUTE[1]:                           dst = fe80::/64, nh = ::, mt = 100</span></span><br><span class="line"><span class="string">[root@nosql100 ~]# </span></span><br></pre></td></tr></table></figure>

<p>​	<strong>此时虚拟机IP为 192.168.24.105</strong></p>
<p><strong>重启</strong></p>
<h6 id="（3）注意权限创建并使用普通用户操作"><a href="#（3）注意权限创建并使用普通用户操作" class="headerlink" title="（3）注意权限创建并使用普通用户操作"></a><strong>（3）注意权限创建并使用普通用户操作</strong></h6><p>​		<strong>hadoop框架在运行需要产生很多数据(日志)，数据的保存目录，必须让当前启动hadoop进程的用户拥有写权限！</strong>	</p>
<hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ① 创建普通用户nosql</span></span><br><span class="line">[root@nosql100 ~]# useradd nosql</span><br><span class="line"></span><br><span class="line"><span class="comment">## ② 为nosql用户设置密码123456</span></span><br><span class="line">[root@nosql100 ~]# passwd nosql </span><br><span class="line">更改用户 nosql 的密码 。</span><br><span class="line">新的 密码：</span><br><span class="line">无效的密码： 密码少于 8 个字符</span><br><span class="line">重新输入新的 密码：</span><br><span class="line">passwd：所有的身份验证令牌已经成功更新。</span><br><span class="line">[root@nosql100 ~]# </span><br><span class="line"></span><br><span class="line"><span class="comment">## ③ 赋予nosql用户root权限</span></span><br><span class="line"></span><br><span class="line">[root@nosql100 ~]# vim /etc/sudoers</span><br><span class="line"></span><br><span class="line">【此处省略...】</span><br><span class="line"> 99 <span class="comment">## Allow root to run any commands anywhere </span></span><br><span class="line">100 root    ALL=(ALL)       ALL</span><br><span class="line">101 nosql   ALL=(ALL)       NOPASSWD: ALL</span><br><span class="line">102 <span class="comment">## Allows members of the &#x27;sys&#x27; group to run networking, software, </span></span><br><span class="line">103 <span class="comment">## service management apps and more.</span></span><br><span class="line">104 <span class="comment"># %sys ALL = NETWORKING, SOFTWARE, SERVICES, STORAGE, DELEGATING, PROCESSES, LOCATE, DRIVERS</span></span><br><span class="line">105 </span><br><span class="line">106 <span class="comment">## Allows people in group wheel to run all commands</span></span><br><span class="line">107 %wheel  ALL=(ALL)       ALL</span><br><span class="line">108 </span><br><span class="line">109 <span class="comment">## Same thing without a password</span></span><br><span class="line">110 <span class="comment"># %wheel        ALL=(ALL)       NOPASSWD: ALL</span></span><br><span class="line">【此处省略...】</span><br><span class="line"></span><br><span class="line">:wq!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@nosql100 ~]# su nosql</span><br><span class="line">[nosql@nosql100 root]$ <span class="built_in">cd</span></span><br><span class="line">[nosql@nosql100 ~]$ ll /opt/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 4 root root  32 5月  28 22:30 module</span><br><span class="line">drwxr-xr-x 3 root root  28 8月  28 2023 rh</span><br><span class="line">drwxr-xr-x 2 root root 174 5月  28 22:31 soft</span><br><span class="line">[nosql@nosql100 ~]$ </span><br><span class="line"> </span><br><span class="line">		</span><br><span class="line"><span class="comment">## ④ 将/opt目录下创建的soft目录和module目录的所属主修改为 nosql</span></span><br><span class="line">[nosql@nosql100 ~]$ <span class="built_in">sudo</span> <span class="built_in">chown</span> -R nosql:nosql /opt/module /opt/soft</span><br><span class="line">[nosql@nosql100 ~]$ ll /opt/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 4 nosql nosql  32 5月  28 22:30 module</span><br><span class="line">drwxr-xr-x 3 root  root   28 8月  28 2023 rh</span><br><span class="line">drwxr-xr-x 2 nosql nosql 174 5月  28 22:31 soft</span><br><span class="line">[nosql@nosql100 ~]$  </span><br></pre></td></tr></table></figure>

<h6 id="（4）关闭防火墙-关闭selinux，设置开机不自启动-学习用"><a href="#（4）关闭防火墙-关闭selinux，设置开机不自启动-学习用" class="headerlink" title="（4）关闭防火墙,关闭selinux，设置开机不自启动(学习用)"></a><strong>（4）关闭防火墙,关闭selinux，设置开机不自启动(学习用)</strong></h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看状态</span></span><br><span class="line">systemctl status firewalld.service</span><br><span class="line"></span><br><span class="line"><span class="comment">##关闭防火墙</span></span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line"><span class="comment">##禁用防火墙</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br><span class="line"></span><br><span class="line"><span class="comment">##关闭selinux</span></span><br><span class="line">vim /etc/selinux/config </span><br><span class="line"></span><br><span class="line">SELINUX=disabled</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启生效</span></span><br></pre></td></tr></table></figure>

<h6 id="（5）设置XShell"><a href="#（5）设置XShell" class="headerlink" title="（5）设置XShell"></a><strong>（5）设置XShell</strong></h6><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240528224840957.png" alt="image-20240528224840957"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240528224914134.png" alt="image-20240528224914134"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/%E7%AC%AC8%E7%AB%A0%20%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93HBase.https:/smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231120001200696-17169079832931.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231120001218808.png"></p>
<h5 id="2-测试连通性"><a href="#2-测试连通性" class="headerlink" title="2 测试连通性"></a>2 测试连通性</h5><p>改IP、改主机名后用ping测试连通性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ ping nosql100 -c 4</span><br><span class="line">PING nosql100 (192.168.24.105) 56(84) bytes of data.</span><br><span class="line">64 bytes from nosql100 (192.168.24.105): icmp_seq=1 ttl=64 time=0.051 ms</span><br><span class="line">64 bytes from nosql100 (192.168.24.105): icmp_seq=2 ttl=64 time=0.055 ms</span><br><span class="line">64 bytes from nosql100 (192.168.24.105): icmp_seq=3 ttl=64 time=0.057 ms</span><br><span class="line">64 bytes from nosql100 (192.168.24.105): icmp_seq=4 ttl=64 time=0.060 ms</span><br><span class="line"></span><br><span class="line">--- nosql100 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3099ms</span><br><span class="line">rtt min/avg/max/mdev = 0.051/0.055/0.060/0.009 ms</span><br><span class="line">[nosql@nosql100 ~]$ </span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="%E7%AC%AC8%E7%AB%A0%20%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93HBase.https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240528225816536.png" alt="image-20240528225816536" style="zoom: 80%;" />

<h5 id="3-免密登录"><a href="#3-免密登录" class="headerlink" title="3 免密登录"></a>3 免密登录</h5><p>免输入密码登录，借助SSH实现</p>
<p>​		举例：  A机器的a用户，希望在A机器上，使用b用户的身份登录到B机器！<br>​		实现步骤：	①A机器的a用户，在A机器上生成一对密钥<br>​								ssh-keygen -t rsa<br>​					   		②密钥分为公钥和私钥，a用户需要将公钥拷贝到B机器上b用户的家目录下的<br>​								authorithxxxx_keys<br>​								a)使用b用户登录到B机器<br>​								b)编辑authorithxxxx_keys，将公钥的内容进行添加<br>​								在A机器，使用a用户执行以下命令： ssh-copy-id  b@B<br>​							   ③A机器的a用户，可以使用 ssh  b@B进行登录！<br>​					   		注意： 如果使用ssh 直接登录 主机名<br>​								默认使用当前用户对目标主机进行登录！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ① 生成公钥和私钥</span></span><br><span class="line">[nosql@nosql100 ~]$ ssh-keygen -t rsa</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/home/nosql/.ssh/id_rsa): </span><br><span class="line">Created directory <span class="string">&#x27;/home/nosql/.ssh&#x27;</span>.</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /home/nosql/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /home/nosql/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:azXxjsyKqj0eLD4DsEYZnOv0TEmFKDL07lZAroWedHc nosql@nosql100</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 3072]----+</span></span><br><span class="line"><span class="string">|o.o.o.           |</span></span><br><span class="line"><span class="string">|+==o             |</span></span><br><span class="line"><span class="string">|o+=*.. E  .      |</span></span><br><span class="line"><span class="string">|+=*oo .    o     |</span></span><br><span class="line"><span class="string">|==+. .  S o .    |</span></span><br><span class="line"><span class="string">|oo.+.    = +     |</span></span><br><span class="line"><span class="string">|...oo   o + .    |</span></span><br><span class="line"><span class="string">| .+o.. o .       |</span></span><br><span class="line"><span class="string">|  o=+o. .        |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br><span class="line"><span class="string">[nosql@nosql100 ~]$ cd .ssh/</span></span><br><span class="line"><span class="string">[nosql@nosql100 .ssh]$ cat id_rsa.pub </span></span><br><span class="line"><span class="string">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCdazKvml0Xv8flwDd6gdhrwfPGOGrnQF/4cj2OTETIdQZWj6f7WQKyFzgvE7t4Fc9DxLNlK3zuHfFeg4Q6hWkvG+lONSLeoGiJG6fGLLN7hyV2QbdJMwvAyLESFDpX1PVn8VvJ7dAWdS6/04iQ3ybFu+hyj8j+KZzjWPW+BiG1Amf4G96RJsWAaOVHX7jbquRpFNPawzcr1l3KyKRfL43dlL8KnbFxqeNSehIZalDmLcZV7NvJGr/iJRFNdTPO76Iopl0xEe2JbJx6lI0EiqUw4DgAwtk9tAKUJ9TqKBSI7GuIyr9iy05hXPhtUGw/oyIqgM9lq1zpjjHe0nDnGIX2zMEicH9GNBV5SnbYmoROnf1JMKrIUyXiTBXMYgI+X/1o8WsUL8MSzAkJ+H61rNuQCzre2vEeObxqbz5hR/riUKkmIT/AtcGN/wMfBqvbxlOlnTziPVJ3gliSYuusP/FiktSrrt18vob6P53JA0p1zW33Dp1lwDQAIp97ODvukr8= nosql@nosql100</span></span><br><span class="line"><span class="string">[nosql@nosql100 .ssh]$ </span></span><br><span class="line"><span class="string">[nosql@nosql100 .ssh]$ ssh-copy-id nosql100 </span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/home/nosql/.ssh/id_rsa.pub&quot;</span></span><br><span class="line"><span class="string">The authenticity of host &#x27;</span>nosql100 (192.168.24.105)<span class="string">&#x27; can&#x27;</span>t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:gCplKtOGjblpugS1xzPBVrYXXiibQ8G0uqS43sN9ZEQ.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span> connecting (<span class="built_in">yes</span>/no/[fingerprint])? <span class="built_in">yes</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to <span class="built_in">log</span> <span class="keyword">in</span> with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="keyword">if</span> you are prompted now it is to install the new keys</span><br><span class="line">nosql@nosql100<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Number of key(s) added: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>nosql100<span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">and check to make sure that only the key(s) you wanted were added.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[nosql@nosql100 .ssh]$ ll</span></span><br><span class="line"><span class="string">总用量 16</span></span><br><span class="line"><span class="string">-rw------- 1 nosql nosql  568 5月  28 23:01 authorized_keys</span></span><br><span class="line"><span class="string">-rw------- 1 nosql nosql 2602 5月  28 22:59 id_rsa</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 nosql nosql  568 5月  28 22:59 id_rsa.pub</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 nosql nosql  185 5月  28 23:01 known_hosts</span></span><br><span class="line"><span class="string">[nosql@nosql100 .ssh]$ cat authorized_keys </span></span><br><span class="line"><span class="string">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCdazKvml0Xv8flwDd6gdhrwfPGOGrnQF/4cj2OTETIdQZWj6f7WQKyFzgvE7t4Fc9DxLNlK3zuHfFeg4Q6hWkvG+lONSLeoGiJG6fGLLN7hyV2QbdJMwvAyLESFDpX1PVn8VvJ7dAWdS6/04iQ3ybFu+hyj8j+KZzjWPW+BiG1Amf4G96RJsWAaOVHX7jbquRpFNPawzcr1l3KyKRfL43dlL8KnbFxqeNSehIZalDmLcZV7NvJGr/iJRFNdTPO76Iopl0xEe2JbJx6lI0EiqUw4DgAwtk9tAKUJ9TqKBSI7GuIyr9iy05hXPhtUGw/oyIqgM9lq1zpjjHe0nDnGIX2zMEicH9GNBV5SnbYmoROnf1JMKrIUyXiTBXMYgI+X/1o8WsUL8MSzAkJ+H61rNuQCzre2vEeObxqbz5hR/riUKkmIT/AtcGN/wMfBqvbxlOlnTziPVJ3gliSYuusP/FiktSrrt18vob6P53JA0p1zW33Dp1lwDQAIp97ODvukr8= nosql@nosql100</span></span><br><span class="line"><span class="string">[nosql@nosql100 .ssh]$ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#测试</span></span><br><span class="line"><span class="string">[nosql@nosql100 .ssh]$ ssh nosql100 </span></span><br><span class="line"><span class="string">Activate the web console with: systemctl enable --now cockpit.socket</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Last login: Tue May 28 22:53:35 2024 from 192.168.10.1</span></span><br><span class="line"><span class="string">[nosql@nosql100 ~]$ exit</span></span><br><span class="line"><span class="string">注销</span></span><br><span class="line"><span class="string">Connection to nosql100 closed.</span></span><br><span class="line"><span class="string">[nosql@nosql100 .ssh]$ </span></span><br></pre></td></tr></table></figure>

<h5 id="4-上传软件包hadoop-2-7-4-tar-gz"><a href="#4-上传软件包hadoop-2-7-4-tar-gz" class="headerlink" title="4 上传软件包hadoop-2.7.4.tar.gz"></a>4 上传软件包hadoop-2.7.4.tar.gz</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240528230828299.png" alt="image-20240528230828299"></p>
<h5 id="5-解压软件包hadoop-2-7-4-tar-gz"><a href="#5-解压软件包hadoop-2-7-4-tar-gz" class="headerlink" title="5 解压软件包hadoop-2.7.4.tar.gz"></a>5 解压软件包hadoop-2.7.4.tar.gz</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ <span class="built_in">cd</span> /opt/soft/</span><br><span class="line">[nosql@nosql100 soft]$ ll</span><br><span class="line">总用量 721052</span><br><span class="line">-rw-r--r-- 1 nosql nosql 266688029 5月  28 22:28 hadoop-2.7.4.tar.gz</span><br><span class="line">-rw-r--r-- 1 nosql nosql 108176325 5月  28 22:28 hbase-1.2.1-bin.tar.gz</span><br><span class="line">-rw-r--r-- 1 nosql nosql 194990602 5月  28 22:28 jdk-8u211-linux-x64.tar.gz</span><br><span class="line">-rw-r--r-- 1 nosql nosql 133445425 11月  1 2023 mongodb-linux-x86_64-rhel80-4.2.24.tgz</span><br><span class="line">-rw-r--r-- 1 nosql nosql  35042811 5月  28 22:28 zookeeper-3.4.10.tar.gz</span><br><span class="line">[nosql@nosql100 soft]$ </span><br><span class="line"></span><br><span class="line">[nosql@nosql100 soft]$ tar -zxvf hadoop-2.7.4.tar.gz -C ../module/</span><br><span class="line">......</span><br><span class="line">hadoop-2.7.4/etc/hadoop/httpfs-log4j.properties</span><br><span class="line">[nosql@nosql100 soft]$ <span class="built_in">cd</span> ../module/</span><br><span class="line">[nosql@nosql100 module]$ ll</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 10 nosql nosql 160 8月   1 2017 hadoop-2.7.4</span><br><span class="line">drwxr-xr-x  3 nosql nosql  26 5月  28 22:31 jvm</span><br><span class="line">drwxr-xr-x  4 nosql nosql 151 3月   4 21:51 mongodb</span><br><span class="line">[nosql@nosql100 module]$ </span><br><span class="line"></span><br><span class="line">[nosql@nosql100 module]$ <span class="built_in">cd</span> hadoop-2.7.4/</span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ ll</span><br><span class="line">总用量 116</span><br><span class="line">drwxr-xr-x  2 nosql nosql   194 8月   1 2017 bin</span><br><span class="line">drwxr-xr-x  3 nosql nosql    20 8月   1 2017 etc</span><br><span class="line">drwxr-xr-x  2 nosql nosql   106 8月   1 2017 include</span><br><span class="line">drwxr-xr-x  3 nosql nosql    20 8月   1 2017 lib</span><br><span class="line">drwxr-xr-x  2 nosql nosql   239 8月   1 2017 libexec</span><br><span class="line">-rw-r--r--  1 nosql nosql 86424 8月   1 2017 LICENSE.txt</span><br><span class="line">-rw-r--r--  1 nosql nosql 14978 8月   1 2017 NOTICE.txt</span><br><span class="line">-rw-r--r--  1 nosql nosql  1366 8月   1 2017 README.txt</span><br><span class="line">drwxr-xr-x  2 nosql nosql  4096 8月   1 2017 sbin</span><br><span class="line">drwxr-xr-x  4 nosql nosql    31 8月   1 2017 share</span><br><span class="line">drwxr-xr-x 19 nosql nosql  4096 8月   1 2017 src</span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ </span><br><span class="line"></span><br><span class="line"><span class="comment">#bin：  使用Hdfs和运算MR时，常用的目录！常用hadoop命令！</span></span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ ll bin/</span><br><span class="line">总用量 324</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 111795 8月   1 2017 container-executor</span><br><span class="line">-rwxr-xr-x 1 nosql nosql   6488 8月   1 2017 hadoop</span><br><span class="line">-rwxr-xr-x 1 nosql nosql   8786 8月   1 2017 hadoop.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql  12223 8月   1 2017 hdfs</span><br><span class="line">-rwxr-xr-x 1 nosql nosql   7478 8月   1 2017 hdfs.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql   5953 8月   1 2017 mapred</span><br><span class="line">-rwxr-xr-x 1 nosql nosql   6310 8月   1 2017 mapred.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql   1776 8月   1 2017 rcc</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 125103 8月   1 2017 test-container-executor</span><br><span class="line">-rwxr-xr-x 1 nosql nosql  13352 8月   1 2017 yarn</span><br><span class="line">-rwxr-xr-x 1 nosql nosql  11386 8月   1 2017 yarn.cmd</span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ </span><br><span class="line"></span><br><span class="line"><span class="comment">#sbin:  管理员启动和停止集群使用的命令！</span></span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ ll sbin/</span><br><span class="line">总用量 120</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 2752 8月   1 2017 distribute-exclude.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 6452 8月   1 2017 hadoop-daemon.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1360 8月   1 2017 hadoop-daemons.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1640 8月   1 2017 hdfs-config.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1427 8月   1 2017 hdfs-config.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 2291 8月   1 2017 httpfs.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 3128 8月   1 2017 kms.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 4080 8月   1 2017 mr-jobhistory-daemon.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1648 8月   1 2017 refresh-namenodes.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 2145 8月   1 2017 slaves.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1779 8月   1 2017 start-all.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1471 8月   1 2017 start-all.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1128 8月   1 2017 start-balancer.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1401 8月   1 2017 start-dfs.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 3734 8月   1 2017 start-dfs.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1357 8月   1 2017 start-secure-dns.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1571 8月   1 2017 start-yarn.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1347 8月   1 2017 start-yarn.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1770 8月   1 2017 stop-all.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1462 8月   1 2017 stop-all.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1179 8月   1 2017 stop-balancer.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1455 8月   1 2017 stop-dfs.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 3206 8月   1 2017 stop-dfs.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1340 8月   1 2017 stop-secure-dns.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1642 8月   1 2017 stop-yarn.cmd</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1340 8月   1 2017 stop-yarn.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 4295 8月   1 2017 yarn-daemon.sh</span><br><span class="line">-rwxr-xr-x 1 nosql nosql 1353 8月   1 2017 yarn-daemons.sh</span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ </span><br><span class="line"></span><br><span class="line"><span class="comment">#etc：  hadoop配置文件所在的目录</span></span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ ll etc/hadoop/</span><br><span class="line">总用量 152</span><br><span class="line">-rw-r--r-- 1 nosql nosql  4436 8月   1 2017 capacity-scheduler.xml</span><br><span class="line">-rw-r--r-- 1 nosql nosql  1335 8月   1 2017 configuration.xsl</span><br><span class="line">-rw-r--r-- 1 nosql nosql   318 8月   1 2017 container-executor.cfg</span><br><span class="line">-rw-r--r-- 1 nosql nosql   774 8月   1 2017 core-site.xml</span><br><span class="line">-rw-r--r-- 1 nosql nosql  3670 8月   1 2017 hadoop-env.cmd</span><br><span class="line">-rw-r--r-- 1 nosql nosql  4224 8月   1 2017 hadoop-env.sh</span><br><span class="line">-rw-r--r-- 1 nosql nosql  2598 8月   1 2017 hadoop-metrics2.properties</span><br><span class="line">-rw-r--r-- 1 nosql nosql  2490 8月   1 2017 hadoop-metrics.properties</span><br><span class="line">-rw-r--r-- 1 nosql nosql  9683 8月   1 2017 hadoop-policy.xml</span><br><span class="line">-rw-r--r-- 1 nosql nosql   775 8月   1 2017 hdfs-site.xml</span><br><span class="line">-rw-r--r-- 1 nosql nosql  1449 8月   1 2017 httpfs-env.sh</span><br><span class="line">-rw-r--r-- 1 nosql nosql  1657 8月   1 2017 httpfs-log4j.properties</span><br><span class="line">-rw-r--r-- 1 nosql nosql    21 8月   1 2017 httpfs-signature.secret</span><br><span class="line">-rw-r--r-- 1 nosql nosql   620 8月   1 2017 httpfs-site.xml</span><br><span class="line">-rw-r--r-- 1 nosql nosql  3518 8月   1 2017 kms-acls.xml</span><br><span class="line">-rw-r--r-- 1 nosql nosql  1527 8月   1 2017 kms-env.sh</span><br><span class="line">-rw-r--r-- 1 nosql nosql  1631 8月   1 2017 kms-log4j.properties</span><br><span class="line">-rw-r--r-- 1 nosql nosql  5540 8月   1 2017 kms-site.xml</span><br><span class="line">-rw-r--r-- 1 nosql nosql 11237 8月   1 2017 log4j.properties</span><br><span class="line">-rw-r--r-- 1 nosql nosql   951 8月   1 2017 mapred-env.cmd</span><br><span class="line">-rw-r--r-- 1 nosql nosql  1383 8月   1 2017 mapred-env.sh</span><br><span class="line">-rw-r--r-- 1 nosql nosql  4113 8月   1 2017 mapred-queues.xml.template</span><br><span class="line">-rw-r--r-- 1 nosql nosql   758 8月   1 2017 mapred-site.xml.template</span><br><span class="line">-rw-r--r-- 1 nosql nosql    10 8月   1 2017 slaves</span><br><span class="line">-rw-r--r-- 1 nosql nosql  2316 8月   1 2017 ssl-client.xml.example</span><br><span class="line">-rw-r--r-- 1 nosql nosql  2697 8月   1 2017 ssl-server.xml.example</span><br><span class="line">-rw-r--r-- 1 nosql nosql  2250 8月   1 2017 yarn-env.cmd</span><br><span class="line">-rw-r--r-- 1 nosql nosql  4567 8月   1 2017 yarn-env.sh</span><br><span class="line">-rw-r--r-- 1 nosql nosql   690 8月   1 2017 yarn-site.xml</span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ </span><br></pre></td></tr></table></figure>

<h5 id="6-添加hadoop环境变量"><a href="#6-添加hadoop环境变量" class="headerlink" title="6 添加hadoop环境变量"></a>6 添加hadoop环境变量</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 hadoop-2.7.4]$ <span class="built_in">sudo</span> vim /etc/profile</span><br><span class="line">......</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/module/jvm/jdk1.8.0_211</span><br><span class="line"><span class="built_in">export</span> HADOOP_HOME=/opt/module/hadoop-2.7.4</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$HADOOP_HOME</span>/bin:<span class="variable">$HADOOP_HOME</span>/sbin</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">wq！</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;/etc/profile&quot;</span> 95L, 2466C 已写入</span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ </span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ </span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ <span class="built_in">source</span> /etc/profile</span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ hadoop version</span><br><span class="line">Hadoop 2.7.4</span><br><span class="line">Subversion https://shv@git-wip-us.apache.org/repos/asf/hadoop.git -r cd915e1e8d9d0131462a0b7301586c175728a282</span><br><span class="line">Compiled by kshvachk on 2017-08-01T00:29Z</span><br><span class="line">Compiled with protoc 2.5.0</span><br><span class="line">From <span class="built_in">source</span> with checksum 50b0468318b4ce9bd24dc467b7ce1148</span><br><span class="line">This <span class="built_in">command</span> was run using /opt/module/hadoop-2.7.4/share/hadoop/common/hadoop-common-2.7.4.jar</span><br><span class="line">[nosql@nosql100 hadoop-2.7.4]$ </span><br></pre></td></tr></table></figure>

<h5 id="7-分布式HDFS的安装和启动"><a href="#7-分布式HDFS的安装和启动" class="headerlink" title="7 分布式HDFS的安装和启动"></a>7 分布式HDFS的安装和启动</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">4个默认的配置文件： </span><br><span class="line">		位置：  HADOOP_HOME/share/xxxx.jar/xxx-default.xml</span><br><span class="line">		core-default.xml： 设置hadoop最核心的参数！</span><br><span class="line">		hdfs-default.xml   保存的是hdfs相关的参数！</span><br><span class="line">		</span><br><span class="line">		mapred-default.xml: MR程序在运行时，需要使用的参数！</span><br><span class="line">		yarn-default.xml: yarn在启动时，需要的参数！</span><br><span class="line"></span><br><span class="line">4个用户可以自定义的配置文件： xxx-site.xml</span><br><span class="line">		core-site.xml： 用户自定义的设置hadoop最核心的参数！</span><br><span class="line">		hdfs-site.xml   用户自定义的保存的是hdfs相关的参数！</span><br><span class="line">		</span><br><span class="line">		mapred-site.xml: 用户自定义的MR程序在运行时，需要使用的参数！</span><br><span class="line">		yarn-site.xml: 用户自定义的yarn在启动时，需要的参数！</span><br><span class="line"></span><br><span class="line">用户自定义的配置文件，可以覆盖默认配置文件中同名的参数的值！</span><br><span class="line"></span><br><span class="line">Hadoop在启动时，先加载4个默认的配置文件，再加载用户自定义的配置文件，如果用户自定义的配置文件</span><br><span class="line">中有和4个默认配置文件中门的参数，可以覆盖之前已经加载的值！</span><br></pre></td></tr></table></figure>

<p><strong>hadoop安装后，hadoop的性能和表现取决于用户的配置！</strong>	</p>
<p>如果没有配置，默认读取  HADOOP_HOME&#x2F;etc&#x2F;hadoop 中对应的配置文件！</p>
<p>hadoop-daemon.sh start namenode脚本在执行时，只会去默认的目录中读取配置文件！</p>
<p>Hadoop可以在单个节点（一台机器）上以伪分布式的方式运行，同一个节点既作为名称节点<code>（NameNode）</code>，也作为数据节点<code>（DataNode）</code>，读取的是分布式文件系统 HDFS 中的文件。</p>
<p>需要配置相关文件，才能够让Hadoop在伪分布式模式下顺利运行。Hadoop的配置文件位于<code>$HADOOP_HOME/etc/hadoop/</code>中，进行伪分布式模式配置时，需要修改3个配置文件，即<code>hadoop-env.sh</code>,<code>core-site.xml</code>和<code>hdfs-site.xml</code>。</p>
<h6 id="（1）修改-HADOOP-HOME-etc-hadoop-hadoop-env-sh"><a href="#（1）修改-HADOOP-HOME-etc-hadoop-hadoop-env-sh" class="headerlink" title="（1）修改 $HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;hadoop-env.sh"></a>（1）修改 $HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;hadoop-env.sh</h6><p>可以使用vim编辑器打开<code>hadoop-env.sh</code>文件，进行修改<code>JAVA_HOME</code>配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 hadoop-2.7.4]$ <span class="built_in">cd</span></span><br><span class="line">[nosql@nosql100 ~]$ <span class="built_in">cd</span> /opt/module/hadoop-2.7.4/etc/hadoop/</span><br><span class="line">[nosql@nosql100 hadoop]$ vim hadoop-env.sh </span><br><span class="line">……</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/module/jvm/jdk1.8.0_211</span><br><span class="line">……</span><br></pre></td></tr></table></figure>



<h6 id="（2）修改-HADOOP-HOME-etc-hadoop-core-site-xml"><a href="#（2）修改-HADOOP-HOME-etc-hadoop-core-site-xml" class="headerlink" title="（2）修改 $HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;core-site.xml"></a>（2）修改 $HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;core-site.xml</h6><p>可以使用vim编辑器打开<code>core-site.xml</code>文件，它的初始内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>修改以后，<code>core-site.xml</code>文件的内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 hadoop]$ vim core-site.xml </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br><span class="line">  &lt;!-- 告知NameNode在哪个机器，NN使用哪个端口号接受客户端和DN的RPC请求. --&gt;</span><br><span class="line">  &lt;value&gt;hdfs://nosql100:9000&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;/opt/module/hadoop-2.7.4/data/tmp&lt;/value&gt;</span><br><span class="line">  &lt;description&gt;A base <span class="keyword">for</span> other temporary directories.&lt;/description&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;                                                                                                                  </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;core-site.xml&quot;</span> 30L, 1149C 已写入   </span><br></pre></td></tr></table></figure>

<p>在上面的配置文件中，<code>hadoop.tmp.dir</code>用于保存临时文件，若没有配置<code>hadoop.tmp.dir</code>这个参数，则默认使用的临时目录为<code>/tmp/hadoo-hadoop</code>，而这个目录在Hadoop重启时有可能被系统清理掉，导致一些意想不到的问题，因此，必须配置这个参数。<code>fs.defaultFS</code>这个参数，用于指定<code>HDFS的</code>访问地址，其中，<code>9000</code>是<strong>端口号</strong>。</p>
<h6 id="（3）修改-HADOOP-HOME-etc-hadoop-hdfs-site-xml"><a href="#（3）修改-HADOOP-HOME-etc-hadoop-hdfs-site-xml" class="headerlink" title="（3）修改 $HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;hdfs-site.xml"></a>（3）修改 $HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;hdfs-site.xml</h6><p>同样，需要修改配置文件<code>hdfs-site.xml</code>，修改后的内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[hbase@hadoop102 hadoop]$ vim hdfs-site.xml </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">&lt;!-- 指定Hadoop辅助名称节点主机配置 --&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">   &lt;name&gt;dfs.namenode.secondary.http-address&lt;/name&gt;</span><br><span class="line">   &lt;value&gt;nosql100:50090&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">   &lt;name&gt;dfs.replication&lt;/name&gt;</span><br><span class="line">   &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">   &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;</span><br><span class="line">   &lt;value&gt;file:/opt/module/hadoop-2.7.4/data/tmp/dfs/name&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">   &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;</span><br><span class="line">   &lt;value&gt;file:/opt/module/hadoop-2.7.4/data/tmp/dfs/data&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;hdfs-site.xml&quot;</span> 32L, 1259C 已写入 </span><br></pre></td></tr></table></figure>

<p>在<code>hdfs-site.xml</code>文件中，<code>dfs.replication</code>这个参数用于指定副本的数量，因为，在分布式文件系统<code>HDFS</code>中，数据会被冗余存储多份，以保证可靠性和可用性。但是，由于这里采用伪分布式模式，只有一个节点，因此，只可能有1个副本，因此，设置<code>dfs.replication</code>的值为1。<code>dfs.namenode.name.dir</code>用于设定名称节点的元数据的保存目录，<code>dfs.datanode.data.dir</code>用于设定数据节点的数据保存目录，这两个参数必须设定，否则后面会出错。</p>
<p>需要指出的是，Hadoop的运行方式（比如运行在单机模式下还是运行在伪分布式模式下），是由配置文件决定的，启动Hadoop时会读取配置文件，然后根据配置文件来决定f运行在什么模式下。因此，如果需要从伪分布式模式切换回单机模式，只需要删除<code> core-site.xml</code>中的配置项即可。</p>
<h6 id="（4）格式化Namenode（只需要格式化一次）"><a href="#（4）格式化Namenode（只需要格式化一次）" class="headerlink" title="（4）格式化Namenode（只需要格式化一次）"></a>（4）格式化Namenode（只需要格式化一次）</h6><p>需要在NN所配置的节点进行格式化，即规划时的主机 hadoop101</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 hadoop]$ <span class="built_in">cd</span></span><br><span class="line">[nosql@nosql100 ~]$ hadoop namenode -format</span><br><span class="line">DEPRECATED: Use of this script to execute hdfs <span class="built_in">command</span> is deprecated.</span><br><span class="line">Instead use the hdfs <span class="built_in">command</span> <span class="keyword">for</span> it.</span><br><span class="line"></span><br><span class="line">24/05/28 23:32:06 INFO namenode.NameNode: STARTUP_MSG: </span><br><span class="line">/************************************************************</span><br><span class="line">STARTUP_MSG: Starting NameNode</span><br><span class="line">STARTUP_MSG:   host = nosql100/192.168.24.105</span><br><span class="line">STARTUP_MSG:   args = [-format]</span><br><span class="line">STARTUP_MSG:   version = 2.7.4</span><br><span class="line">……</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[nosql@nosql100 ~]$ <span class="built_in">cd</span> /opt/module/hadoop-2.7.4/data/tmp/</span><br><span class="line">[nosql@nosql100 tmp]$ ll</span><br><span class="line">总用量 0</span><br><span class="line">drwxrwxr-x 3 nosql nosql 18 5月  28 23:32 dfs</span><br><span class="line">[nosql@nosql100 tmp]$ tree</span><br><span class="line">.</span><br><span class="line">└── dfs</span><br><span class="line">    └── name</span><br><span class="line">        └── current</span><br><span class="line">            ├── fsimage_0000000000000000000</span><br><span class="line">            ├── fsimage_0000000000000000000.md5</span><br><span class="line">            ├── seen_txid</span><br><span class="line">            └── VERSION</span><br><span class="line"></span><br><span class="line">3 directories, 4 files</span><br><span class="line">[nosql@nosql100 tmp]$ </span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240528233251620.png" alt="image-20240528233251620"></p>
<h6 id="（5）集群时间同步"><a href="#（5）集群时间同步" class="headerlink" title="（5）集群时间同步"></a><strong>（5）集群时间同步</strong></h6><p>时间同步的方式：找一个机器，作为时间服务器，所有的机器与这台集群时间进行定时的同步，比如，每隔十分钟，同步一次时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 tmp]$ <span class="built_in">date</span></span><br><span class="line">2024年 05月 28日 星期二 23:34:37 CST</span><br><span class="line">[nosql@nosql100 tmp]$ </span><br><span class="line">[nosql@nosql100 tmp]$ su root</span><br><span class="line">密码：</span><br><span class="line">[root@nosql100 tmp]# rpm -qa|grep chrony</span><br><span class="line">chrony-4.1-1.el8.x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##仓库中直接安装</span></span><br><span class="line">[root@nosql100 tmp]# ll /etc/yum.repos.d/</span><br><span class="line">总用量 12</span><br><span class="line">drwxr-xr-x. 2 root root 4096 8月  28 2023 bak</span><br><span class="line">-rw-r--r--. 1 root root 2590 8月   4 2022 CentOS-Base.repo</span><br><span class="line">-rw-r--r--. 1 root root  189 8月  28 2023 dvd.repo</span><br><span class="line">[root@nosql100 tmp]# yum -y install chrony</span><br><span class="line">上次元数据过期检查：0:43:30 前，执行于 2024年05月28日 星期二 22时52分25秒。</span><br><span class="line">软件包 chrony-4.1-1.el8.x86_64 已安装。</span><br><span class="line">依赖关系解决。</span><br><span class="line">无需任何处理。</span><br><span class="line">完毕！</span><br><span class="line">[root@nosql100 tmp]# </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##联网的情况下一般设置时区后会通过网络同步时间</span></span><br><span class="line">[root@nosql100 tmp]# timedatectl set-timezone <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##修改配置加入aliyun pool网络时间，也可以加入多个pool服务器</span></span><br><span class="line">[root@nosql100 tmp]# vim /etc/chrony.conf</span><br><span class="line"><span class="comment"># Use public servers from the pool.ntp.org project.</span></span><br><span class="line"><span class="comment"># Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span><br><span class="line">pool 2.centos.pool.ntp.org iburst</span><br><span class="line">server time1.aliyun.com iburst</span><br><span class="line">server time2.aliyun.com iburst</span><br><span class="line">server time3.aliyun.com iburst</span><br><span class="line">server time4.aliyun.com iburst</span><br><span class="line">server time5.aliyun.com iburst</span><br><span class="line">server time6.aliyun.com iburst</span><br><span class="line">server 0.asia.pool.ntp.org iburst</span><br><span class="line">server 1.asia.pool.ntp.org iburst</span><br><span class="line">server 2.asia.pool.ntp.org iburst</span><br><span class="line">server 3.asia.pool.ntp.org iburst</span><br><span class="line">server cn.ntp.org.cn iburst</span><br><span class="line">server ntp.shu.edu.cn iburst</span><br><span class="line"><span class="comment"># Record the rate at which the system clock gains/losses time.</span></span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow the system clock to be stepped in the first three updates</span></span><br><span class="line"><span class="comment"># if its offset is larger than 1 second.</span></span><br><span class="line">makestep 1.0 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable kernel synchronization of the real-time clock (RTC).</span></span><br><span class="line">rtcsync</span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable hardware timestamping on all interfaces that support it.</span></span><br><span class="line"><span class="comment">#hwtimestamp *</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Increase the minimum number of selectable sources required to adjust</span></span><br><span class="line"><span class="comment"># the system clock.</span></span><br><span class="line"><span class="comment">#minsources 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow NTP client access from local network.</span></span><br><span class="line"><span class="comment">#allow 192.168.0.0/16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Serve time even if not synchronized to a time source.</span></span><br><span class="line"><span class="comment">#local stratum 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify file containing keys for NTP authentication.</span></span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get TAI-UTC offset and leap seconds from the system tz database.</span></span><br><span class="line">leapsectz right/UTC</span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify directory for log files.</span></span><br><span class="line">logdir /var/log/chrony</span><br><span class="line"></span><br><span class="line"><span class="comment"># Select which information is logged.</span></span><br><span class="line"><span class="comment">#log measurements statistics tracking</span></span><br><span class="line">     </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##重新加载配置</span></span><br><span class="line">[root@nosql100 tmp]# systemctl restart chronyd.service</span><br><span class="line"></span><br><span class="line"><span class="comment">##执行时间同步命令</span></span><br><span class="line">[root@nosql100 tmp]# chronyc sources -v</span><br><span class="line"></span><br><span class="line">  .-- Source mode  <span class="string">&#x27;^&#x27;</span> = server, <span class="string">&#x27;=&#x27;</span> = peer, <span class="string">&#x27;#&#x27;</span> = <span class="built_in">local</span> clock.</span><br><span class="line"> / .- Source state <span class="string">&#x27;*&#x27;</span> = current best, <span class="string">&#x27;+&#x27;</span> = combined, <span class="string">&#x27;-&#x27;</span> = not combined,</span><br><span class="line">| /             <span class="string">&#x27;x&#x27;</span> = may be <span class="keyword">in</span> error, <span class="string">&#x27;~&#x27;</span> = too variable, <span class="string">&#x27;?&#x27;</span> = unusable.</span><br><span class="line">||                                                 .- xxxx [ yyyy ] +/- zzzz</span><br><span class="line">||      Reachability register (octal) -.           |  xxxx = adjusted offset,</span><br><span class="line">||      Log2(Polling interval) --.      |          |  yyyy = measured offset,</span><br><span class="line">||                                \     |          |  zzzz = estimated error.</span><br><span class="line">||                                 |    |           \</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample               </span><br><span class="line">===============================================================================</span><br><span class="line">^- ntp7.flashdance.cx            2   6    17     8    -21ms[  -21ms] +/-  144ms</span><br><span class="line">^- ntp1.flashdance.cx            2   6    17     9    -29ms[  -29ms] +/-  141ms</span><br><span class="line">^- ntp.wdc2.us.leaseweb.net      2   6    17     8    +73ms[  +73ms] +/-  344ms</span><br><span class="line">^* time.neu.edu.cn               1   6    17     9  +1410us[  +90us] +/-   17ms</span><br><span class="line">^+ 203.107.6.88                  2   6    17    10  -4353us[-5674us] +/-   27ms</span><br><span class="line">^- 236.99.217.185.interhost&gt;     3   6    33     5    +10ms[  +10ms] +/-  136ms</span><br><span class="line">^? tw.ntp.twds.com.tw            2   7   120    13    -60ms[  -60ms] +/-  172ms</span><br><span class="line">^? ntp7.mum-in.hosts.301-mo&gt;     0   6     0     -     +0ns[   +0ns] +/-    0ns</span><br><span class="line">^? time.cloudflare.com           0   7     0     -     +0ns[   +0ns] +/-    0ns</span><br><span class="line">^- 120.25.115.20                 2   6    33     8  +3573us[+3573us] +/-   21ms</span><br><span class="line">^? 202.120.127.191               0   7     0     -     +0ns[   +0ns] +/-    0ns</span><br><span class="line">[root@nosql100 tmp]# </span><br><span class="line"></span><br><span class="line"><span class="comment">##退出root用户，回到nosql用户登录并验证时间是否已经同步</span></span><br><span class="line">[root@nosql100 tmp]# <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">[nosql@nosql100 tmp]$ <span class="built_in">cd</span></span><br><span class="line">[nosql@nosql100 ~]$ <span class="built_in">date</span></span><br><span class="line">2024年 05月 28日 星期二 23:39:02 CST</span><br><span class="line">[nosql@nosql100 ~]$ </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="（6）运行群启脚本"><a href="#（6）运行群启脚本" class="headerlink" title="（6）运行群启脚本"></a>（6）运行群启脚本</h6><p>①群起脚本的原理是获取集群中所有的节点的主机名<br>        默认读取当前机器 HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;slaves，获取集群中所有的节点的主机名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ <span class="built_in">cd</span> /opt/module/hadoop-2.7.4/etc/hadoop/</span><br><span class="line"></span><br><span class="line">[nosql@nosql100 hadoop]$ vim slaves </span><br><span class="line">nosql100</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>②循环执行 ssh 主机名 hadoop-daemon.sh start xxx<br>        保证当前机器到其他节点，已经配置了ssh免密登录<br>        保证集群中所有当前用户的家目录&#x2F;.bashrc中，已经配置source &#x2F;etc&#x2F;profile</p>
<p>注意：  start-all.sh 时，其实分别调用了start-dfs.sh和start-yarn.sh<br>            start-dfs.sh 可以在集群的任意一台机器使用！可以启动HDFS中的所有进程！<br>            start-yarn.sh 在集群的非RM所在的机器使用时，不会启动resourcemanager!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ start-dfs.sh </span><br><span class="line">Starting namenodes on [nosql100]</span><br><span class="line">nosql100: starting namenode, logging to /opt/module/hadoop-2.7.4/logs/hadoop-nosql-namenode-nosql100.out</span><br><span class="line">nosql100: starting datanode, logging to /opt/module/hadoop-2.7.4/logs/hadoop-nosql-datanode-nosql100.out</span><br><span class="line">Starting secondary namenodes [nosql100]</span><br><span class="line">nosql100: starting secondarynamenode, logging to /opt/module/hadoop-2.7.4/logs/hadoop-nosql-secondarynamenode-nosql100.out</span><br><span class="line">[nosql@nosql100 ~]$ jps</span><br><span class="line">13808 Jps</span><br><span class="line">13257 NameNode</span><br><span class="line">13439 DataNode</span><br><span class="line">13663 SecondaryNameNode</span><br></pre></td></tr></table></figure>



<h6 id="（7）查看"><a href="#（7）查看" class="headerlink" title="（7）查看"></a>（7）查看</h6><ul>
<li>①启动HDFS并查看</li>
</ul>
<p>jps<br>或通过浏览器访问   <a target="_blank" rel="noopener" href="http://namenode所在的主机名/ip:50070">http://NameNode所在的主机名/ip:50070</a> 例如：nosql100:50070</p>
<p><a target="_blank" rel="noopener" href="http://nosql100:50070/dfshealth.html">Namenode information</a></p>
<p>如果NN和DN都在一台机器，且只有一个DN节点，称为伪分布式！</p>
<p>Hadoop成功启动后，可以在Linux系统中（不是Windows系统）打开一个浏览器，在地址栏输入地址<code>http://localhost:9870</code>，就可以查看名称节点和数据节点信息，还可以在线查看 HDFS 中的文件。</p>
<blockquote>
<p>hadoop3.X的Web UI端口为：9870</p>
<p>hadoop2.X的Web UI端口为：50070</p>
<p>旧版本与新版本之间端口号有不一致的地方</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240529000325040.png" alt="image-20240529000325040"></p>
<h6 id="（8）运行群停脚本"><a href="#（8）运行群停脚本" class="headerlink" title="（8）运行群停脚本"></a>（8）运行群停脚本</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ stop-dfs.sh </span><br><span class="line">Stopping namenodes on [nosql100]</span><br><span class="line">nosql100: stopping namenode</span><br><span class="line">nosql100: stopping datanode</span><br><span class="line">Stopping secondary namenodes [nosql100]</span><br><span class="line">nosql100: stopping secondarynamenode</span><br><span class="line">[nosql@nosql100 ~]$ </span><br></pre></td></tr></table></figure>

<p><strong>下次启动Hadoop时，无需进行名称节点的初始化（否则会出错）</strong>，也就是说，不要再次执行<code>hdfs namenode -format</code>命令，每次启动Hadoop只需要直接运行<code>start-dfs.sh</code>命令即可。</p>
<h4 id="安装HBase"><a href="#安装HBase" class="headerlink" title="安装HBase"></a><strong>安装HBase</strong></h4><h5 id="1-上传软件包-hbase-1-2-1-bin-tar-gz"><a href="#1-上传软件包-hbase-1-2-1-bin-tar-gz" class="headerlink" title="1 上传软件包 hbase-1.2.1-bin.tar.gz"></a>1 上传软件包 hbase-1.2.1-bin.tar.gz</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240529001149751.png" alt="image-20240529001149751"></p>
<h5 id="2-解压软件包-hbase-1-2-1-bin-tar-gz"><a href="#2-解压软件包-hbase-1-2-1-bin-tar-gz" class="headerlink" title="2 解压软件包 hbase-1.2.1-bin.tar.gz"></a>2 解压软件包 hbase-1.2.1-bin.tar.gz</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ <span class="built_in">cd</span> /opt/sof/</span><br><span class="line">[nosql@nosql100 soft]$ tar -zxvf hbase-1.2.1-bin.tar.gz -C ../module/</span><br></pre></td></tr></table></figure>

<h5 id="3-HBase的配置"><a href="#3-HBase的配置" class="headerlink" title="3 HBase的配置"></a>3 HBase的配置</h5><h6 id="（1）修改-conf-HBase-env-sh"><a href="#（1）修改-conf-HBase-env-sh" class="headerlink" title="（1）修改 conf&#x2F;HBase-env.sh"></a>（1）修改 conf&#x2F;HBase-env.sh</h6><p>打开<code>hbase-env.sh</code>文件以后，需要在<code>hbase-env.sh</code>文件中配置<code>JAVA_HOME</code>和<code>HBASE_MANAGES_ZK</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ <span class="built_in">cd</span> /opt/module/hbase-1.2.1/</span><br><span class="line">[nosql@nosql100 hbase-1.2.1]$ <span class="built_in">cd</span> conf/</span><br><span class="line">[nosql@nosql100 conf]$ ll</span><br><span class="line">总用量 40</span><br><span class="line">-rw-r--r-- 1 nosql nosql 1811 12月 27 2015 hadoop-metrics2-hbase.properties</span><br><span class="line">-rw-r--r-- 1 nosql nosql 4537 1月  29 2016 hbase-env.cmd</span><br><span class="line">-rw-r--r-- 1 nosql nosql 7468 1月  29 2016 hbase-env.sh</span><br><span class="line">-rw-r--r-- 1 nosql nosql 2257 12月 27 2015 hbase-policy.xml</span><br><span class="line">-rw-r--r-- 1 nosql nosql  934 12月 27 2015 hbase-site.xml</span><br><span class="line">-rw-r--r-- 1 nosql nosql 4339 1月  29 2016 log4j.properties</span><br><span class="line">-rw-r--r-- 1 nosql nosql   10 12月 27 2015 regionservers</span><br><span class="line">[nosql@nosql100 conf]$ vim hbase-env.sh </span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/module/jvm/jdk1.8.0_211</span><br><span class="line"><span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">true</span>		</span><br></pre></td></tr></table></figure>

<h6 id="（2）修改-conf-HBase-site-xml"><a href="#（2）修改-conf-HBase-site-xml" class="headerlink" title="（2）修改 conf&#x2F;HBase-site.xml"></a>（2）修改 conf&#x2F;HBase-site.xml</h6><p>在<code>hbase-site.xml</code>文件中，需要设置属性<code>hbase.rootdir</code>，用于指定HBase数据的存储位置。在HBase伪分布式模式中，是使用伪分布式模式的HDFS存储数据，因此，需要把<code>hbase.rootdir</code>设置为HBase在HDFS上的存储路径，根据Hadoop伪分布式模式的配置可以知道，HDFS的访问路径为<code>hdfs://nosql100:9000/</code>，因为，这里设置<code>hbase.rootdir</code>为<code>hdfs://nosql100:9000/hbase</code>。此外，由于采用了伪分布式模式，因此，还需要将属性<code>hbase.cluter.distributed</code>设置为**<code>true</code>**。修改后的<code>hbase-site.xml</code>文件中的配置信息如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">        &lt;property&gt;  </span><br><span class="line">           &lt;name&gt;hbase.rootdir&lt;/name&gt;  </span><br><span class="line">           &lt;value&gt;hdfs:<span class="comment">//nosql100:9000/hbase&lt;/value&gt;  </span></span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">        &lt;property&gt;  </span><br><span class="line">           &lt;name&gt;hbase.cluster.distributed&lt;/name&gt;</span><br><span class="line">           &lt;value&gt;<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">        &lt;property&gt;</span><br><span class="line">          &lt;name&gt;hbase.unsafe.stream.capability.enforce&lt;/name&gt;</span><br><span class="line">          &lt;value&gt;<span class="literal">false</span>&lt;/value&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<h6 id="（3）修改-conf-regionservers"><a href="#（3）修改-conf-regionservers" class="headerlink" title="（3）修改 conf&#x2F;regionservers"></a>（3）修改 conf&#x2F;regionservers</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 conf]$ vim regionservers </span><br><span class="line">nosql100</span><br></pre></td></tr></table></figure>

<h6 id="（4）配置hbase环境变量"><a href="#（4）配置hbase环境变量" class="headerlink" title="（4）配置hbase环境变量"></a>（4）配置hbase环境变量</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ vi .bashrc </span><br><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/bashrc</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User specific environment</span></span><br><span class="line"><span class="keyword">if</span> ! [[ <span class="string">&quot;<span class="variable">$PATH</span>&quot;</span> =~ <span class="string">&quot;<span class="variable">$HOME</span>/.local/bin:<span class="variable">$HOME</span>/bin:&quot;</span> ]]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    PATH=<span class="string">&quot;<span class="variable">$HOME</span>/.local/bin:<span class="variable">$HOME</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#export PATH</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/module/jvm/jdk1.8.0_211/</span><br><span class="line"><span class="built_in">export</span> HADOOP_HOME=/opt/module/hadoop-2.7.4</span><br><span class="line"><span class="built_in">export</span> HBASE_HOME=/opt/module/hbase-1.2.1</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$HADOOP_HOME</span>/bin:<span class="variable">$HADOOP_HOME</span>/sbin:<span class="variable">$HBASE_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">【此处省略...】</span><br><span class="line">[nosql@nosql100 ~]$ <span class="built_in">source</span> .bashrc </span><br><span class="line">[nosql@nosql100 ~]$ hbase version</span><br><span class="line">HBase 1.2.1</span><br><span class="line">Source code repository git://asf-dev/home/busbey/projects/hbase revision=8d8a7107dc4ccbf36a92f64675dc60392f85c015</span><br><span class="line">Compiled by busbey on Wed Mar 30 11:19:21 CDT 2016</span><br><span class="line">From <span class="built_in">source</span> with checksum f4bb4a14bb4e0b72b46f729dae98a772</span><br><span class="line">[nosql@nosql100 ~]$ hadoop version</span><br><span class="line">Hadoop 2.7.4</span><br><span class="line">Subversion https://shv@git-wip-us.apache.org/repos/asf/hadoop.git -r cd915e1e8d9d0131462a0b7301586c175728a282</span><br><span class="line">Compiled by kshvachk on 2017-08-01T00:29Z</span><br><span class="line">Compiled with protoc 2.5.0</span><br><span class="line">From <span class="built_in">source</span> with checksum 50b0468318b4ce9bd24dc467b7ce1148</span><br><span class="line">This <span class="built_in">command</span> was run using /opt/module/hadoop-2.7.4/share/hadoop/common/hadoop-common-2.7.4.jar</span><br><span class="line">[nosql@nosql100 ~]$ java -version</span><br><span class="line">java version <span class="string">&quot;1.8.0_211&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_211-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)</span><br><span class="line">[nosql@nosql100 ~]$ </span><br></pre></td></tr></table></figure>

<h6 id="（5）XShell的设置"><a href="#（5）XShell的设置" class="headerlink" title="（5）XShell的设置"></a>（5）XShell的设置</h6><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231120001200696.png" alt="image-20231120001200696"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20231120001218808.png" alt="image-20231120001218808"></p>
<h3 id="启动HBase集群"><a href="#启动HBase集群" class="headerlink" title="启动HBase集群"></a><strong>启动HBase集群</strong></h3><h5 id="1-启动hdfs"><a href="#1-启动hdfs" class="headerlink" title="1 启动hdfs"></a>1 启动hdfs</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ start-dfs.sh </span><br><span class="line">Starting namenodes on [nosql100]</span><br><span class="line">nosql100: starting namenode, logging to /opt/module/hadoop-2.7.4/logs/hadoop-nosql-namenode-nosql100.out</span><br><span class="line">nosql100: starting datanode, logging to /opt/module/hadoop-2.7.4/logs/hadoop-nosql-datanode-nosql100.out</span><br><span class="line">Starting secondary namenodes [nosql100]</span><br><span class="line">nosql100: starting secondarynamenode, logging to /opt/module/hadoop-2.7.4/logs/hadoop-nosql-secondarynamenode-nosql100.out</span><br><span class="line">[nosql@nosql100 ~]$ jps</span><br><span class="line">17506 NameNode</span><br><span class="line">17933 SecondaryNameNode</span><br><span class="line">17694 DataNode</span><br><span class="line">18078 Jps</span><br></pre></td></tr></table></figure>

<h5 id="2-启动HBase"><a href="#2-启动HBase" class="headerlink" title="2 启动HBase"></a>2 启动HBase</h5><ul>
<li>① 群启：start-hbase.sh</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ start-hbase.sh </span><br><span class="line">localhost: starting zookeeper, logging to /opt/module/hbase-1.2.1/logs/hbase-nosql-zookeeper-nosql100.out</span><br><span class="line">localhost: SLF4J: Class path contains multiple SLF4J bindings.</span><br><span class="line">localhost: SLF4J: Found binding <span class="keyword">in</span> [jar:file:/opt/module/hbase-1.2.1/lib/slf4j-log4j12-1.7.5.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">localhost: SLF4J: Found binding <span class="keyword">in</span> [jar:file:/opt/module/hadoop-2.7.4/share/hadoop/common/lib/slf4j-log4j12-1.7.10.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">localhost: SLF4J: See http://www.slf4j.org/codes.html#multiple_bindings <span class="keyword">for</span> an explanation.</span><br><span class="line">localhost: SLF4J: Actual binding is of <span class="built_in">type</span> [org.slf4j.impl.Log4jLoggerFactory]</span><br><span class="line">starting master, logging to /opt/module/hbase-1.2.1/logs/hbase-nosql-master-nosql100.out</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM warning: ignoring option PermSize=128m; support was removed <span class="keyword">in</span> 8.0</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM warning: ignoring option MaxPermSize=128m; support was removed <span class="keyword">in</span> 8.0</span><br><span class="line">SLF4J: Class path contains multiple SLF4J bindings.</span><br><span class="line">SLF4J: Found binding <span class="keyword">in</span> [jar:file:/opt/module/hbase-1.2.1/lib/slf4j-log4j12-1.7.5.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">SLF4J: Found binding <span class="keyword">in</span> [jar:file:/opt/module/hadoop-2.7.4/share/hadoop/common/lib/slf4j-log4j12-1.7.10.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">SLF4J: See http://www.slf4j.org/codes.html#multiple_bindings <span class="keyword">for</span> an explanation.</span><br><span class="line">SLF4J: Actual binding is of <span class="built_in">type</span> [org.slf4j.impl.Log4jLoggerFactory]</span><br><span class="line">nosql100: starting regionserver, logging to /opt/module/hbase-1.2.1/logs/hbase-nosql-regionserver-nosql100.out</span><br><span class="line">nosql100: Java HotSpot(TM) 64-Bit Server VM warning: ignoring option PermSize=128m; support was removed <span class="keyword">in</span> 8.0</span><br><span class="line">nosql100: Java HotSpot(TM) 64-Bit Server VM warning: ignoring option MaxPermSize=128m; support was removed <span class="keyword">in</span> 8.0</span><br><span class="line">nosql100: SLF4J: Class path contains multiple SLF4J bindings.</span><br><span class="line">nosql100: SLF4J: Found binding <span class="keyword">in</span> [jar:file:/opt/module/hbase-1.2.1/lib/slf4j-log4j12-1.7.5.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">nosql100: SLF4J: Found binding <span class="keyword">in</span> [jar:file:/opt/module/hadoop-2.7.4/share/hadoop/common/lib/slf4j-log4j12-1.7.10.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">nosql100: SLF4J: See http://www.slf4j.org/codes.html#multiple_bindings <span class="keyword">for</span> an explanation.</span><br><span class="line">nosql100: SLF4J: Actual binding is of <span class="built_in">type</span> [org.slf4j.impl.Log4jLoggerFactory]</span><br><span class="line">[nosql@nosql100 ~]$ jps</span><br><span class="line">17506 NameNode</span><br><span class="line">18487 HMaster</span><br><span class="line">18745 HRegionServer</span><br><span class="line">19081 Jps</span><br><span class="line">17933 SecondaryNameNode</span><br><span class="line">17694 DataNode</span><br><span class="line">18366 HQuorumPeer</span><br><span class="line">[nosql@nosql100 ~]$ </span><br></pre></td></tr></table></figure>

<ul>
<li>② 访问web界面： nosql100:16010</li>
</ul>
<p>访问master进程所在机器 <a target="_blank" rel="noopener" href="http://nosql100:16010/">Master: nosql100</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240529005225791.png" alt="image-20240529005225791"></p>
<ul>
<li>③ 群停：stop-hbase.sh</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[nosql@nosql100 ~]$ stop-hbase.sh </span><br><span class="line">stopping hbase......</span><br><span class="line">localhost: stopping zookeeper.</span><br></pre></td></tr></table></figure>

<h5 id="4-总结：集群停止"><a href="#4-总结：集群停止" class="headerlink" title="4 总结：集群停止"></a>4 总结：集群停止</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stop-hbase.sh</span></span><br><span class="line"><span class="comment"># stop-dfs.sh</span></span><br></pre></td></tr></table></figure>

<h3 id="HBase的操作"><a href="#HBase的操作" class="headerlink" title="HBase的操作"></a><strong>HBase的操作</strong></h3><h4 id="HBase的Shell操作"><a href="#HBase的Shell操作" class="headerlink" title="HBase的Shell操作"></a><strong>HBase的Shell操作</strong></h4><p>HBase Shell提供了大量操作HBase的命令，通过Shell命令可以很方便地操作HBase数据库，例如创建、删除及修改表、向表中添加数据、列出表中的相关信息等操作。不过当使用Shell命令行操作HBase时，需要进入HBase Shell交互界面。在HBase的安装目录下，执行“bin&#x2F;hbase shell”或者“hbase shell”命令进入到HBase Shell界面，具体效果如图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/image-20240529212259124.png" alt="image-20240529212259124"></p>
<p>进入HBase Shell交互界面后，可以通过一系列Shell命令操作HBase，接下来，通过一张表列举一些操作HBase表常见的Shell命令，具体如表所示。</p>
<table>
<thead>
<tr>
<th><strong>命令名称</strong></th>
<th><strong>相关说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>create</td>
<td>创建表</td>
</tr>
<tr>
<td>put</td>
<td>插入或更新数据</td>
</tr>
<tr>
<td>scan</td>
<td>扫描表并返回表的所有数据</td>
</tr>
<tr>
<td>describe</td>
<td>查看表的结构</td>
</tr>
<tr>
<td>get</td>
<td>获取指定行中列的数据</td>
</tr>
<tr>
<td>count</td>
<td>统计表中数据的行数</td>
</tr>
<tr>
<td>delete</td>
<td>删除指定行或者列的数据</td>
</tr>
<tr>
<td>deleteall</td>
<td>删除整个行或列的数据</td>
</tr>
<tr>
<td>truncate</td>
<td>删除整个表中的数据，但是结构还在</td>
</tr>
<tr>
<td>drop</td>
<td>删除整个表，数据和结构都删除（慎用）</td>
</tr>
</tbody></table>
<h5 id="1-创建表"><a href="#1-创建表" class="headerlink" title="1 创建表"></a>1 创建表</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例如，创建一个名称为phone、列族名为info的HBase表，具体如下：</span></span><br><span class="line"></span><br><span class="line">hbase(main):001:0&gt; create <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;info&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 1.3980 seconds</span><br><span class="line"></span><br><span class="line">=&gt; Hbase::Table - phone</span><br><span class="line">hbase(main):002:0&gt; </span><br><span class="line"></span><br><span class="line"><span class="comment">#执行“list”命令，查看数据库中的数据表，具体如下：</span></span><br><span class="line">hbase(main):002:0&gt; list</span><br><span class="line">TABLE                                                                              </span><br><span class="line">phone                                                                                                                          </span><br><span class="line">1 row(s) <span class="keyword">in</span> 0.0180 seconds</span><br><span class="line"></span><br><span class="line">=&gt; [<span class="string">&quot;phone&quot;</span>]</span><br><span class="line"><span class="comment">#从上述返回结果可以看出，出现了数据表phone，因此可以说明成功创建数据表phone。</span></span><br></pre></td></tr></table></figure>



<h5 id="2-插入操作"><a href="#2-插入操作" class="headerlink" title="2 插入操作"></a>2 插入操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例如，向数据表phone的info列族中插入五条数据，具体如下：</span></span><br><span class="line">hbase(main):003:0&gt; put <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;p001&#x27;</span>,<span class="string">&#x27;info:brand&#x27;</span>,<span class="string">&#x27;Apple&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.1090 seconds</span><br><span class="line"></span><br><span class="line">hbase(main):004:0&gt; put <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;p001&#x27;</span>,<span class="string">&#x27;info:name&#x27;</span>,<span class="string">&#x27;iPhone 11 Pro&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.0140 seconds</span><br><span class="line"></span><br><span class="line">hbase(main):005:0&gt; put <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;p002&#x27;</span>,<span class="string">&#x27;info:brand&#x27;</span>,<span class="string">&#x27;HUAWEI&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.0110 seconds</span><br><span class="line"></span><br><span class="line">hbase(main):006:0&gt; put <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;p002&#x27;</span>,<span class="string">&#x27;info:name&#x27;</span>,<span class="string">&#x27;HUAWEI Mate 30 Pro&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.0180 seconds</span><br><span class="line"></span><br><span class="line">hbase(main):007:0&gt; put <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;p002&#x27;</span>,<span class="string">&#x27;info:price&#x27;</span>,<span class="string">&#x27;5899&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.0120 seconds</span><br></pre></td></tr></table></figure>



<h5 id="3-扫描操作"><a href="#3-扫描操作" class="headerlink" title="3 扫描操作"></a>3 扫描操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例如，扫描数据表phone中的所有数据，具体如下：</span></span><br><span class="line">hbase(main):008:0&gt; scan <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">ROW                                                   COLUMN+CELL                                                               </span><br><span class="line"> p001                                                 column=info:brand, timestamp=1716989818342, value=Apple                   </span><br><span class="line"> p001                                                 column=info:name, timestamp=1716989829913, value=iPhone 11 Pro             </span><br><span class="line"> p002                                                 column=info:brand, timestamp=1716989838358, value=HUAWEI                   </span><br><span class="line"> p002                                                 column=info:name, timestamp=1716989846174, value=HUAWEI Mate 30 Pro       </span><br><span class="line"> p002                                                 column=info:price, timestamp=1716989853905, value=5899                     </span><br><span class="line">2 row(s) <span class="keyword">in</span> 0.0290 seconds</span><br></pre></td></tr></table></figure>



<h5 id="4-查看操作"><a href="#4-查看操作" class="headerlink" title="4 查看操作"></a>4 查看操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例如，查看数据表phone的表结构，具体如下：</span></span><br><span class="line">hbase(main):009:0&gt; describe <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">Table phone is ENABLED                                                                                                           </span><br><span class="line">phone                                                                            </span><br><span class="line">COLUMN FAMILIES DESCRIPTION                                                              </span><br><span class="line">&#123;NAME =&gt; <span class="string">&#x27;info&#x27;</span>, BLOOMFILTER =&gt; <span class="string">&#x27;ROW&#x27;</span>, VERSIONS =&gt; <span class="string">&#x27;1&#x27;</span>, IN_MEMORY =&gt; <span class="string">&#x27;false&#x27;</span>, KEEP_DELETED_CELLS =&gt; <span class="string">&#x27;FALSE&#x27;</span>, DATA_BLOCK_ENCODING =&gt; <span class="string">&#x27;NONE&#x27;</span>, TTL =&gt; <span class="string">&#x27;FOREVER&#x27;</span>, COMPRESSION =&gt; <span class="string">&#x27;NONE&#x27;</span>, MIN_VERSIONS =&gt; <span class="string">&#x27;0&#x27;</span>, BLOCKCAC</span><br><span class="line">HE =&gt; <span class="string">&#x27;true&#x27;</span>, BLOCKSIZE =&gt; <span class="string">&#x27;65536&#x27;</span>, REPLICATION_SCOPE =&gt; <span class="string">&#x27;0&#x27;</span>&#125;                                                                   </span><br><span class="line">1 row(s) <span class="keyword">in</span> 0.0340 seconds</span><br></pre></td></tr></table></figure>

<p>从上述返回结果可以看出，数据表phone的表结构包含很多字段，具体介绍如下：<br>    NAME：	表示列族名。<br>    BLOOMFILTER：	表示为列族级别的类型。<br>    VERIONS：	表示版本数。<br>    IN_MEMORY：	设置是否存入内存。<br>    KEEP_DELETED_CELLS：	设置被删除的数据，在基于时间的历史数据查询中是否依然可见。<br>    DATA_BLOCK_ENCODING：	表示数据块的算法。<br>    TTL：	表示版本存活的时间。<br>    COMPRESSION：	表示设置压缩算法。<br>    MIN_VERSIONS：	表示最小版本数。<br>    BLOCKCACHE：	表示是否设置读缓存。<br>    REPLICATION_SCOPE：	表示设置备份。</p>
<h5 id="5-更新操作"><a href="#5-更新操作" class="headerlink" title="5 更新操作"></a>5 更新操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例如，在数据表phone中，将行键为p001、列为info:name的值iPhone 11 Pro更新为iPhone X，具体如下：</span></span><br><span class="line">hbase(main):010:0&gt; put <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;p001&#x27;</span>,<span class="string">&#x27;info:name&#x27;</span>,<span class="string">&#x27;iPhone X&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.0120 seconds</span><br><span class="line"></span><br><span class="line"><span class="comment">#上述命令执行成功后，执行“scan &#x27;phone&#x27;”命令扫描数据表phone中的数据，扫描结果如下：</span></span><br><span class="line">hbase(main):011:0&gt; scan <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">ROW                                                   COLUMN+CELL                                                               </span><br><span class="line"> p001                                                 column=info:brand, timestamp=1716989818342, value=Apple                   </span><br><span class="line"> p001                                                 column=info:name, timestamp=1716990146490, value=iPhone X                 </span><br><span class="line"> p002                                                 column=info:brand, timestamp=1716989838358, value=HUAWEI                   </span><br><span class="line"> p002                                                 column=info:name, timestamp=1716989846174, value=HUAWEI Mate 30 Pro       </span><br><span class="line"> p002                                                 column=info:price, timestamp=1716989853905, value=5899</span><br><span class="line">2 row(s) <span class="keyword">in</span> 0.0220 seconds</span><br><span class="line"><span class="comment">#上述代码中，行键为p001、列为info:name的值iPhone 11 Pro成功更新成iPhone X。</span></span><br></pre></td></tr></table></figure>



<h5 id="6-获取指定字段的操作"><a href="#6-获取指定字段的操作" class="headerlink" title="6 获取指定字段的操作"></a>6 获取指定字段的操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例如，获取数据表phone中行键为p001的数据，具体如下：</span></span><br><span class="line">hbase(main):012:0&gt; get <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;p001&#x27;</span></span><br><span class="line">COLUMN                                                CELL                                                                       </span><br><span class="line"> info:brand                                           timestamp=1716989818342, value=Apple                                       </span><br><span class="line"> info:name                                            timestamp=1716990146490, value=iPhone X                                   </span><br><span class="line">2 row(s) <span class="keyword">in</span> 0.0260 seconds</span><br></pre></td></tr></table></figure>



<h5 id="7-统计操作"><a href="#7-统计操作" class="headerlink" title="7 统计操作"></a>7 统计操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例如，统计数据表phone中数据的行数，具体如下：</span></span><br><span class="line">hbase(main):013:0&gt; count <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">2 row(s) <span class="keyword">in</span> 0.0200 seconds</span><br><span class="line"></span><br><span class="line">=&gt; 2</span><br></pre></td></tr></table></figure>



<h5 id="8-删除操作"><a href="#8-删除操作" class="headerlink" title="8 删除操作"></a>8 删除操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例如，删除数据表phone中行键为p002、列为info:price的数据，具体如下：</span></span><br><span class="line">hbase(main):014:0&gt; delete <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;p002&#x27;</span>,<span class="string">&#x27;info:price&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.0240 seconds</span><br><span class="line"></span><br><span class="line"><span class="comment">#上述命令执行成功后，执行“scan &#x27;phone&#x27;”命令扫描数据表phone中的数据，扫描结果如下：</span></span><br><span class="line">hbase(main):015:0&gt; scan <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">ROW                                                   COLUMN+CELL                                                               </span><br><span class="line"> p001                                                 column=info:brand, timestamp=1716989818342, value=Apple                   </span><br><span class="line"> p001                                                 column=info:name, timestamp=1716990146490, value=iPhone X                 </span><br><span class="line"> p002                                                 column=info:brand, timestamp=1716989838358, value=HUAWEI                   </span><br><span class="line"> p002                                                 column=info:name, timestamp=1716989846174, value=HUAWEI Mate 30 Pro       </span><br><span class="line">2 row(s) <span class="keyword">in</span> 0.0250 seconds</span><br><span class="line"><span class="comment">#从上述返回结果可以看出，行键为p002、列名为info:price的数据已经被删除。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#例如，删除数据表phone中行键为p001的所有数据，具体如下：</span></span><br><span class="line">hbase(main):016:0&gt; deleteall <span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;p001&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.0090 seconds</span><br><span class="line"></span><br><span class="line"><span class="comment">#上述命令执行成功后，执行“scan &#x27;phone&#x27;”命令扫描数据表phone中的数据，扫描结果如下：</span></span><br><span class="line">hbase(main):017:0&gt; scan <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">ROW                                                   COLUMN+CELL                                                               </span><br><span class="line"> p002                                                 column=info:brand, timestamp=1716989838358, value=HUAWEI                   </span><br><span class="line"> p002                                                 column=info:name, timestamp=1716989846174, value=HUAWEI Mate 30 Pro       </span><br><span class="line">1 row(s) <span class="keyword">in</span> 0.0260 seconds</span><br><span class="line"><span class="comment">#从上述返回结果可以看出，行键为p001的所有数据已经被删除了。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#例如，清空数据表phone中的所有数据，具体如下：</span></span><br><span class="line">hbase(main):018:0&gt; <span class="built_in">truncate</span> <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">Truncating <span class="string">&#x27;phone&#x27;</span> table (it may take a <span class="keyword">while</span>):</span><br><span class="line"> - Disabling table...</span><br><span class="line"> - Truncating table...</span><br><span class="line">0 row(s) <span class="keyword">in</span> 3.3890 seconds</span><br><span class="line"></span><br><span class="line"><span class="comment">#上述命令执行成功后，执行“scan &#x27;phone&#x27;”命令扫描数据表phone中的数据，扫描结果如下：</span></span><br><span class="line">hbase(main):019:0&gt; scan <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">ROW                                                   COLUMN+CELL                                                               </span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.3220 seconds</span><br><span class="line"><span class="comment">#从上述返回结果可以看出，数据表phone中的所有数据都已经被清空。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#例如，删除数据表phone</span></span><br><span class="line">hbase(main):020:0&gt; <span class="built_in">disable</span> <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 2.2370 seconds</span><br><span class="line"></span><br><span class="line">hbase(main):021:0&gt; drop <span class="string">&#x27;phone&#x27;</span></span><br><span class="line">0 row(s) <span class="keyword">in</span> 1.2410 seconds</span><br><span class="line"><span class="comment">#上述的代码中，在删除数据表前需要先执行“disable &#x27;phone&#x27;”命令使数据表phone变为禁用状态，然后进行删除表操作。若数据表不是禁用状态，则无法删除。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#通过执行“list”命令获取HBase数据库中的所有数据表，具体如下：</span></span><br><span class="line">hbase(main):022:0&gt; list</span><br><span class="line">TABLE                                                                                                                           </span><br><span class="line">0 row(s) <span class="keyword">in</span> 0.0070 seconds</span><br><span class="line"></span><br><span class="line">=&gt; []</span><br><span class="line"><span class="comment">#从上述返回结果“[ ]”可以看出，数据库已经为空，因此说明数据表phone已经被删除。</span></span><br></pre></td></tr></table></figure>



<h4 id="HBase的Java-API操作"><a href="#HBase的Java-API操作" class="headerlink" title="HBase的Java API操作"></a><strong>HBase的Java API操作</strong></h4><h2 id="十一、实战可视化管理Robo-3T"><a href="#十一、实战可视化管理Robo-3T" class="headerlink" title="十一、实战可视化管理Robo 3T"></a>十一、实战可视化管理Robo 3T</h2><blockquote>
<p><strong>常见的可视化管理工具</strong>：</p>
<ul>
<li><code>adminMongo</code>：WEB&#x2F;PC端口网页管理 <a target="_blank" rel="noopener" href="https://github.com/mrvautin/adminMongo">https://github.com/mrvautin/adminMongo</a></li>
<li><code>Robo 3T *</code>：客户端软件 <a target="_blank" rel="noopener" href="https://robomongo.org/download/">https://robomongo.org/download/</a></li>
<li><code>MongoVUE</code> ：客户端软件</li>
</ul>
</blockquote>
<h3 id="1-下载安装Robo-3T"><a href="#1-下载安装Robo-3T" class="headerlink" title="1. 下载安装Robo 3T"></a>1. 下载安装Robo 3T</h3><p><strong>下载地址</strong>：<a target="_blank" rel="noopener" href="https://robomongo.org/download/">https://robomongo.org/download/</a></p>
<p><code>Studio 3T</code> 和 <code>Robo 3T</code> 的区别：前者是商业付费软件，后者开源免费软件</p>
<p>这里选择仅仅下载<code>Robo 3T</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/0831d523e7c534ee64a24ab73d4733f5png.jpg" alt="image-20210225234019413"><br>填写好信息后点击下载<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/eca69e2f660b8446c6e3f6c988efee71png.jpg" alt="image-20210225234056240"><br>这里选择下载<code>.exe</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/f7b557859172ac781d6fa70950e1e90dpng.jpg" alt="image-20210225234215296"><br>下载后得到<code>exe</code>文件<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/c76a815811648531662425325572674epng.jpg" alt="image-20210225235326178"><br>双击运行进行安装，傻瓜式下一部安装完成即可</p>
<hr>
<h3 id="2-使用Robo-3T"><a href="#2-使用Robo-3T" class="headerlink" title="2. 使用Robo 3T"></a>2. 使用Robo 3T</h3><p>安装完成后打开<br>点击<code>Create</code>创建一个链接，添加连接数据库的相关信息<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/307cf40bc315493d3f0ca03e0a40d4a7png.jpg" alt="image-20210225235717351"><br>我们开启了身份验证，因此需要填写身份验证的用户名和密码，最后<code>Save</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/96c2e173b25d509e8f6eb8ca14f83ff5png.jpg" alt="image-20210226000100699"><br>然后点击<code>Connect</code>进行连接<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/8406a829cb3e2be39ce025b34a28cde1png.jpg" alt="image-20210225235857186"><br>成功连接到数据库<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/6adffdb58c921b56343873bda673c095png.jpg" alt="image-20210226000141593"><br>然后就可以可视化进行各种操作</p>
<hr>
<h2 id="十二、mongoose"><a href="#十二、mongoose" class="headerlink" title="十二、mongoose"></a>十二、mongoose</h2><h3 id="1-简介-1"><a href="#1-简介-1" class="headerlink" title="1. 简介"></a>1. 简介</h3><p><code>mongoose.js</code>是<code>node</code>中操作<code>mongodb</code>的模块，可以通过node语法实现MongoDB数据库的增删改查</p>
<p>中文网：<a target="_blank" rel="noopener" href="http://www.mongoosejs.net/">http://www.mongoosejs.net/</a></p>
<p>英文网：<a target="_blank" rel="noopener" href="https://mongoosejs.com/">https://mongoosejs.com/</a></p>
<p><strong>核心概念</strong>：</p>
<ul>
<li><code>schema</code>：约束字段&#x2F;列数据</li>
<li><code>model</code>：对应集合，用它来实现数据增删改查</li>
</ul>
<hr>
<h3 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h3><p>用<code>Vscode</code>新建并打开一个文件夹，在终端输入如下命令安装<code>mongoose</code>模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装</span></span><br><span class="line">npm install mongoose</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/ddc915bcd68047a98a8acaab71234136png.jpg" alt="image-20210227132121270"></p>
<hr>
<h3 id="3-CURD语法"><a href="#3-CURD语法" class="headerlink" title="3. CURD语法"></a>3. CURD语法</h3><p>新建一个<code>.js</code>文件，用来连接并操作mongodb数据库</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一、导入模块</span></span><br><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二、连接数据库</span></span><br><span class="line"><span class="keyword">const</span> db = mongoose.<span class="title function_">createConnection</span>(<span class="string">&#x27;mongodb://user:pass@localhost:port/database&#x27;</span>,&#123;<span class="attr">useNewUrlParser</span>:<span class="literal">true</span>,<span class="attr">useUnifiedTopology</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接失败&#x27;</span>,err);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接成功&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 三、设置数据类型(声明哪个是集合,限制字段个数和字段类型)</span></span><br><span class="line"><span class="keyword">const</span> model = db.<span class="title function_">model</span>(<span class="string">&#x27;user&#x27;</span>,&#123;</span><br><span class="line">    <span class="attr">name</span>:&#123;<span class="attr">type</span>:<span class="title class_">String</span>,<span class="attr">default</span>:<span class="string">&quot;username&quot;</span>&#125;,</span><br><span class="line">    <span class="attr">age</span>:&#123;<span class="attr">type</span>:<span class="title class_">Number</span>&#125;,</span><br><span class="line">    <span class="attr">sex</span>:&#123;<span class="attr">type</span>:<span class="title class_">String</span>&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 四、创建实例操作(CRUD)</span></span><br><span class="line"><span class="comment">// -----------------增--------------------</span></span><br><span class="line"><span class="keyword">const</span> insertObj = <span class="keyword">new</span> <span class="title function_">model</span>(数据对象)</span><br><span class="line">方法一:inserObj.<span class="title function_">save</span>(<span class="function">(<span class="params">err</span>)=&gt;</span>db.<span class="title function_">close</span>())</span><br><span class="line">方法二:(推荐)</span><br><span class="line">insertObj.<span class="title function_">save</span>()</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;插入失败&#x27;</span>+err)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------删--------------------</span></span><br><span class="line">方法一:model.<span class="property">remove</span>/deleteOne/<span class="title function_">deleteMany</span>(条件对象,<span class="function">(<span class="params">err</span>)=&gt;</span>db.<span class="title function_">close</span>())</span><br><span class="line">方法二:(推荐)</span><br><span class="line">model.<span class="title function_">deleteOne</span>(条件对象)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="property">deletedCount</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除失败&#x27;</span>+err)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------改--------------------</span></span><br><span class="line">方法一:model.<span class="property">update</span>/updateOne/<span class="title function_">updateMany</span>(条件对象,数据对象,<span class="function">(<span class="params">err</span>)=&gt;</span>db.<span class="title function_">close</span>())</span><br><span class="line">方法二:(推荐)</span><br><span class="line">model.<span class="title function_">updateOne</span>(条件对象,数据对象)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="property">nModified</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;修改失败&#x27;</span>+err)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------查--------------------</span></span><br><span class="line">方法一:model.<span class="property">find</span>/<span class="title function_">findOne</span>(条件对象,要显示的字段数据对象,<span class="function">(<span class="params">err,result</span>)=&gt;</span>db.<span class="title function_">close</span>())</span><br><span class="line">方法二:(推荐)</span><br><span class="line">model.<span class="title function_">findOne</span>(条件对象)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询失败&#x27;</span>+err)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-测试"><a href="#4-测试" class="headerlink" title="4. 测试"></a>4. 测试</h3><h4 id="增"><a href="#增" class="headerlink" title="增"></a>增</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一、导入模块</span></span><br><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二、连接数据库</span></span><br><span class="line"><span class="keyword">const</span> db = mongoose.<span class="title function_">createConnection</span>(<span class="string">&#x27;mongodb://shop2:123456@localhost:27017/shop&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">useNewUrlParser</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">useUnifiedTopology</span>: <span class="literal">true</span></span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接失败&#x27;</span>, err);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接成功&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 三、设置数据类型(声明哪个是集合,限制字段个数和字段类型)</span></span><br><span class="line"><span class="keyword">const</span> model = db.<span class="title function_">model</span>(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">name</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">        <span class="attr">default</span>: <span class="string">&quot;username&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">age</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Number</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">sex</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">String</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 四、创建实例操作(CRUD)</span></span><br><span class="line"><span class="comment">// -----------------增--------------------</span></span><br><span class="line"><span class="keyword">const</span> insertObj = <span class="keyword">new</span> <span class="title function_">model</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;zsr&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">21</span>,</span><br><span class="line">    <span class="attr">sex</span>: <span class="string">&quot;男&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line">insertObj.<span class="title function_">save</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;插入失败&#x27;</span> + err)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>然后运行测试：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/3b0df36ea172c029e624b843e8a91827png.jpg" alt="image-20210228101842532"><br>然后打开<code>Robo 3T</code>查看，可以看到成功插入数据<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/09790a34a17b6ec2bf21927b21b4acacpng.jpg" alt="image-20210228101930327"></p>
<h4 id="查"><a href="#查" class="headerlink" title="查"></a>查</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -----------------查--------------------</span></span><br><span class="line">model.<span class="title function_">findOne</span>(&#123;&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询失败&#x27;</span>+err)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//分页</span></span><br><span class="line">model.<span class="title function_">find</span>(&#123;&#125;).<span class="title function_">skip</span>(<span class="number">0</span>).<span class="title function_">limit</span>(<span class="number">1</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询失败&#x27;</span>+err)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/7e310ea29b48d041aa79892de9f0b23dpng.jpg" alt="image-20210228103425937"></p>
<hr>
<h2 id="十三、接口"><a href="#十三、接口" class="headerlink" title="十三、接口"></a>十三、接口</h2><h3 id="1-简介-2"><a href="#1-简介-2" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>随着移动互联网的发展，客户端层出不穷，微信端、 WEB&#x2F;PC、APP等等，而后端业务逻辑基本是一致的，如<br>何做到业务逻辑<code>一次编写，多次/随时接入</code>呢？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/319e5d4a0bdae20bf1a7ee8ee981c822png.jpg" alt="image-20210228103629396"><br>就是定义接口，调用接口；</p>
<p>1️⃣ 什么是接口？</p>
<blockquote>
<p>就是一个文件，主要响应JSON数据（操作方便，体积小）或XML数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/e6bc196adff5115e735d78de2c7e30b4png.jpg" alt="image-20210228103954884"></p>
</blockquote>
<p>2️⃣ 接口能干嘛？</p>
<blockquote>
<ul>
<li>数据角度：让项目静态而数据动态</li>
<li>功能角度：短信接口，天气接口，股票接口</li>
</ul>
</blockquote>
<p>3️⃣ 去哪找？</p>
<blockquote>
<ul>
<li><p>通过node&#x2F;go&#x2F;java&#x2F;php等语言去开发</p>
</li>
<li><p>使用第三方接口</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/74961b5a8d327cd6e1fd07bb83e73e4fpng.jpg" alt="image-20210228104530991"></p>
</blockquote>
<p>4️⃣ 好处</p>
<blockquote>
<p>实现一次编写，多次&#x2F;随机接入，减小后端工作量，方便维护</p>
</blockquote>
<hr>
<h3 id="2-接口开发规范-Restful-API"><a href="#2-接口开发规范-Restful-API" class="headerlink" title="2. 接口开发规范(Restful API)"></a>2. 接口开发规范(Restful API)</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/b083ed714a986b9cb63aa6d8b875d6ebpng.jpg" alt="image-20210228105119801"></p>
<ul>
<li><p><strong>说明</strong>：<code>RESTful</code>是目前最流行的一种互联网软件架构</p>
</li>
<li><p><strong>作用</strong>：声明&#x2F;提供接口设计原则和约束条件</p>
</li>
<li><p><strong>过程</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">后端将资源发布到URL上 =&gt; 前端通过URL进行访问 =&gt; 并通过HTTP动词表示要对资源进行的操作</span><br><span class="line">后端定义接口 =&gt; 前端请求接口 =&gt; HTTP动词表明操作目的(get获取 post新建 put更新)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>举例</strong>：</p>
<table>
<thead>
<tr>
<th>列表页：</th>
<th>访问-&#x2F;模块名</th>
<th>get</th>
</tr>
</thead>
<tbody><tr>
<td>详情页：</td>
<td>访问-&#x2F;模块名&#x2F;编号</td>
<td>get</td>
</tr>
<tr>
<td>添加页：</td>
<td>访问-&#x2F;模块名&#x2F;create</td>
<td>get</td>
</tr>
<tr>
<td>处理：</td>
<td>访问-&#x2F;模块名</td>
<td>post</td>
</tr>
<tr>
<td>修改页：</td>
<td>访问-&#x2F;模块名&#x2F;编号&#x2F;edit</td>
<td>get</td>
</tr>
<tr>
<td>处理：</td>
<td>访问-&#x2F;模块名&#x2F;编号</td>
<td>put</td>
</tr>
<tr>
<td>删除：</td>
<td>访问-&#x2F;模块名&#x2F;编号</td>
<td>delete</td>
</tr>
</tbody></table>
</li>
<li><p><strong>好处</strong>：统一开发规范，便于团队协作</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/8555af9081c342c8c2656f987144f908png.jpg" alt="image-20210301110522075"></p>
<hr>
<h3 id="3-接口测试工具Postman"><a href="#3-接口测试工具Postman" class="headerlink" title="3. 接口测试工具Postman"></a>3. 接口测试工具Postman</h3><h4 id="1-简介-3"><a href="#1-简介-3" class="headerlink" title="1. 简介"></a>1. 简介</h4><p><code>Postman</code>就是一个用来模拟http请求的工具，用于测试接口，查看接口返回数据</p>
<ul>
<li>后端调试接口避免出现bug</li>
<li>前端查看接口是否使用并查看返回的数据内容</li>
</ul>
<p><strong>官网</strong>：<a target="_blank" rel="noopener" href="https://www.postman.com/">https://www.postman.com/</a></p>
<h4 id="2-下载安装"><a href="#2-下载安装" class="headerlink" title="2. 下载安装"></a>2. 下载安装</h4><p><strong>下载地址</strong>：<a target="_blank" rel="noopener" href="https://www.postman.com/downloads/">https://www.postman.com/downloads/</a>，选择合适的版本下载<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/548ccdfa7169e96399e506fbb2a0557bpng.jpg" alt="image-20210301110950957"><br>下载后得到<code>.exe</code>文件，双击进行安装即可<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/5873c1a5875036727ca999c52836a851png.jpg" alt="image-20210301111110959"><br>安装完成自动打开，出现如下界面，我们可以在<a target="_blank" rel="noopener" href="https://www.postman.com/">官网</a>创建一个账户进行登录，然后即可使用<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/c2b5d1e9d3e6325bbd0adc3962c9c959png.jpg" alt="image-20210301111320063"></p>
<h4 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h4><p>新建一个<code>request</code>请求<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/46f9ad820c299230d41b8b2222a1aaf3png.jpg" alt="image-20210301111512474"><br>填写相关信息，然后保存<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/e78f52c624fdb28b86d47d93da0cfd90png.jpg" alt="image-20210301111541303"><br>然后填写请求信息，这里以<code>get</code>方式请求<a target="_blank" rel="noopener" href="https://jsonview.com/example.json">https://jsonview.com/example.json</a><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/c9f1b58ca8fb0f8279bc16869225c990png.jpg" alt="image-20210301111618808"></p>
<p>在下面可以看到请求返回的数据</p>
<hr>
<h2 id="十四、express框架教学系统学生模块接口开发"><a href="#十四、express框架教学系统学生模块接口开发" class="headerlink" title="十四、express框架教学系统学生模块接口开发"></a>十四、express框架教学系统学生模块接口开发</h2><h3 id="1-express快速入门"><a href="#1-express快速入门" class="headerlink" title="1. express快速入门"></a>1. express快速入门</h3><p>1️⃣ <strong>简介</strong>：<code>express</code>是基于nodejs开发第一个框架（原理：基于nodejs内置的http模块进行封装），加快项目开发，便于团队协作</p>
<p><strong>官网</strong>：<a target="_blank" rel="noopener" href="https://www.expressjs.com.cn/">https://www.expressjs.com.cn/</a><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/5b52a19870d46b7e8cd6eb5ccfc0fb7epng.jpg" alt="image-20210301111923298"></p>
<p>2️⃣ <strong>下载</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express --save</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/200582112b7fa8c444351ad18c269677png.jpg" alt="image-20210301112133869"></p>
<p>3️⃣ <strong>简单使用</strong>：创建一个<code>js</code>文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.引入模块</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建app对象(底层原理是http模块的createServer)</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.编写路由</span></span><br><span class="line"><span class="comment">// 语法: app.HTTP请求方式(路径,回调函数)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//send是express用来响应数据</span></span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.启动服务监听端口</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;http://localhost:3000&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>运行该<code>js</code>文件测试，打开浏览器<code>3000</code>端口，可以看到效果<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/43289756a4cdfa29720fd4ef394f8b2bpng.jpg" alt="image-20210301112704649"></p>
<hr>
<h3 id="2-教学系统学生模块接口开发"><a href="#2-教学系统学生模块接口开发" class="headerlink" title="2. 教学系统学生模块接口开发"></a>2. 教学系统学生模块接口开发</h3><blockquote>
<p>项目总结构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/a6a27a0c85e5ac777c6b9ffc78a0e01epng.jpg" alt="image-20210301115034468"></p>
</blockquote>
<h4 id="1-安装模块依赖"><a href="#1-安装模块依赖" class="headerlink" title="1. 安装模块依赖"></a>1. 安装模块依赖</h4><p>新建一个空目录，用vscode打开，首先安装相关模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install express --save</span><br><span class="line">npm install mogoose</span><br><span class="line">npm install body-parser</span><br></pre></td></tr></table></figure>

<h4 id="2-expree框架搭建，定义路由"><a href="#2-expree框架搭建，定义路由" class="headerlink" title="2 expree框架搭建，定义路由"></a>2 expree框架搭建，定义路由</h4><p>新建入口文件<code>student.js</code>，首先快速搭建express框架web服务器，其中定义两个路由：</p>
<ul>
<li><code>get</code>方式请求<code>/stu</code>，用于添加学生，用stuController.add方法处理(后续编写)</li>
<li><code>post</code>方式请求<code>/stu</code>，用于查询所有学生，用stuController.index方法处理(后续编写)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.引入模块</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyparser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="comment">// 2.创建app对象(底层原理是http模块的createServer)</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line">app.<span class="title function_">use</span>(bodyparser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>:<span class="literal">true</span>&#125;))</span><br><span class="line">app.<span class="title function_">use</span>(bodyparser.<span class="title function_">json</span>())</span><br><span class="line"><span class="comment">// 3.编写路由</span></span><br><span class="line"><span class="comment">// ----------添加学生-----------</span></span><br><span class="line"><span class="keyword">const</span> stuController = <span class="built_in">require</span>(process.<span class="title function_">cwd</span>() + <span class="string">&#x27;/controller/stuController&#x27;</span>)</span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/stu&#x27;</span>, stuController.<span class="property">add</span>)</span><br><span class="line"><span class="comment">// ----------查询学生-----------</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/stu&#x27;</span>,stuController.<span class="property">index</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.启动服务监听端口</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;http://localhost:3000&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="3-mongoose模块操作数据库"><a href="#3-mongoose模块操作数据库" class="headerlink" title="3. mongoose模块操作数据库"></a>3. mongoose模块操作数据库</h4><p>在项目目录下新建<code>models</code>包，其中新建<code>stuModels.js</code>，采用<code>mongoose</code>模块实现操作mongodb数据库，定义并暴露两个方法：</p>
<ul>
<li>添加学生<code>insert</code></li>
<li>查询所有学生<code>query</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一、导入模块</span></span><br><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二、连接数据库</span></span><br><span class="line"><span class="keyword">const</span> db = mongoose.<span class="title function_">createConnection</span>(<span class="string">&#x27;mongodb://shop2:123456@localhost:27017/shop&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">useNewUrlParser</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">useUnifiedTopology</span>: <span class="literal">true</span></span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接失败&#x27;</span>, err);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接成功&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 三、设置数据类型(声明哪个是集合,限制字段个数和字段类型)</span></span><br><span class="line"><span class="keyword">const</span> model = db.<span class="title function_">model</span>(<span class="string">&#x27;stu&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">name</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">        <span class="attr">default</span>: <span class="string">&quot;zsr&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">age</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Number</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">sex</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">String</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// insert添加方法</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">insert</span> = postData =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> insertObj = <span class="keyword">new</span> <span class="title function_">model</span>(postData)</span><br><span class="line">    <span class="keyword">return</span> insertObj.<span class="title function_">save</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;插入失败&#x27;</span> + err)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// query查询方法</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">query</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> model.<span class="title function_">find</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询失败&#x27;</span> + err)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出insert方法</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    insert,</span><br><span class="line">    query</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-编写路由处理方法"><a href="#3-编写路由处理方法" class="headerlink" title="3. 编写路由处理方法"></a>3. 编写路由处理方法</h4><p>在项目目录下新建<code>controller</code>包，其中新建<code>stuController.js</code>，用于处理路由，其中暴露两个方法：</p>
<ul>
<li><code>add</code>用于处理post请求<code>/stu</code>添加学生</li>
<li><code>index</code>用于处理get请求<code>/stu</code>查询全部学生</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导入模型</span></span><br><span class="line"><span class="keyword">const</span> stuModel = <span class="built_in">require</span>(process.<span class="title function_">cwd</span>() + <span class="string">&#x27;/models/stuModel&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义add添加学生方法</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">add</span> = <span class="keyword">async</span> (<span class="params">req, res</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">//1.接收数据</span></span><br><span class="line">    <span class="keyword">let</span> postData = req.<span class="property">body</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(postData)</span><br><span class="line">    <span class="comment">//2.过滤(忽略)</span></span><br><span class="line">    <span class="comment">//3.操作数据库</span></span><br><span class="line">    <span class="keyword">let</span> rs = <span class="keyword">await</span> stuModel.<span class="title function_">insert</span>(postData)</span><br><span class="line">    <span class="comment">//4.判断返回</span></span><br><span class="line">    <span class="keyword">if</span> (rs) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="attr">meta</span>: &#123;</span><br><span class="line">                <span class="attr">state</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">msg</span>: <span class="string">&quot;添加成功&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">data</span>: <span class="literal">null</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="attr">meta</span>: &#123;</span><br><span class="line">                <span class="attr">state</span>: <span class="number">500</span>,</span><br><span class="line">                <span class="attr">msg</span>: <span class="string">&quot;添加失败&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">data</span>: <span class="literal">null</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义index查询学生方法</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">index</span> = <span class="keyword">async</span> (<span class="params">req, res</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">//1.获取数据</span></span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> stuModel.<span class="title function_">query</span>()</span><br><span class="line">    <span class="comment">//2.响应数据</span></span><br><span class="line">    res.<span class="title function_">send</span>(&#123;</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">stage</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&quot;查询成功&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">data</span>: data</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//导出方法</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    add,</span><br><span class="line">    index</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-测试-1"><a href="#4-测试-1" class="headerlink" title="4. 测试"></a>4. 测试</h4><p>运行入口文件<code>student.js</code>，然后打开<code>postman</code>进行测试</p>
<p>1️⃣ 首先进行 <strong>添加学生</strong> 测试，以<code>post</code>方式请求<code>http://localhost:3000/stu</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/f8bb5291b35afd5852c4dcf9d4ce5d09png.jpg" alt="image-20210301114056251"><br>根据返回结果，可以看到成功添加，再回到<code>Robo 3T</code>查看数据库结果，成功添加学生<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1ba387eba448621e1be185970ccf6b69png.jpg" alt="image-20210301114214452"></p>
<p>2️⃣ 然后进行 <strong>查询所有学生</strong> 测试，以<code>get</code>方式请求<code>http://localhost:3000/stu</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/e42cbd0237a60fea902f8f45443851fcpng.jpg" alt="image-20210301114311871"><br>根据返回结果，成功查询到学生信息</p>
<hr>
<h3 id="3-接口文档开发apiDoc"><a href="#3-接口文档开发apiDoc" class="headerlink" title="3. 接口文档开发apiDoc"></a>3. 接口文档开发apiDoc</h3><h4 id="1-简介-4"><a href="#1-简介-4" class="headerlink" title="1. 简介"></a>1. 简介</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/ee04aed1f14190a2603fc2b8029b9730png.jpg" alt="image-20210301114547742"><br><code>apiDoc</code>就是nodejs中的一个模块，用于通过注释快速生成接口文档</p>
<p><strong>官网</strong>：<a target="_blank" rel="noopener" href="https://apidocjs.com/">https://apidocjs.com/</a></p>
<h4 id="2-使用"><a href="#2-使用" class="headerlink" title="2. 使用"></a>2. 使用</h4><p>1️⃣ 下载模块，后期通过注释生成接口文档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install apidoc -g</span><br></pre></td></tr></table></figure>

<p>2️⃣ 项目根目录下创建<code>apidoc.json</code>文件，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;example&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apiDoc basic example&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Custom apiDoc browser title&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;url&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;https://api.github.com/v1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/ac1e42b2cb703c5ecbefe4c07faf1965png.jpg" alt="image-20210301115008245"></p>
<p>3️⃣ 添加接口注释，在<code>stuController.js</code>处理路由方法中添加注释</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导入模型</span></span><br><span class="line"><span class="keyword">const</span> stuModel = <span class="built_in">require</span>(process.<span class="title function_">cwd</span>() + <span class="string">&#x27;/models/stuModel&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义add添加学生方法</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@api</span> &#123;<span class="type">post</span>&#125; /stu 添加学生</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiName</span> <span class="variable">add</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiGroup</span> <span class="variable">Stu</span></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiParam</span> &#123;<span class="type">String</span>&#125; name 学生姓名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiParam</span> &#123;<span class="type">Number</span>&#125; age 学生年龄</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiParam</span> &#123;<span class="type">String</span>&#125; sex 学生性别</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiSuccess</span> &#123;<span class="type">String</span>&#125; meta 状态码&amp;提示信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiSuccess</span> &#123;<span class="type">String</span>&#125; data 数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">add</span> = <span class="keyword">async</span> (<span class="params">req, res</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">//1.接收数据</span></span><br><span class="line">    <span class="keyword">let</span> postData = req.<span class="property">body</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(postData)</span><br><span class="line">    <span class="comment">//2.过滤(忽略)</span></span><br><span class="line">    <span class="comment">//3.操作数据库</span></span><br><span class="line">    <span class="keyword">let</span> rs = <span class="keyword">await</span> stuModel.<span class="title function_">insert</span>(postData)</span><br><span class="line">    <span class="comment">//4.判断返回</span></span><br><span class="line">    <span class="keyword">if</span> (rs) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="attr">meta</span>: &#123;</span><br><span class="line">                <span class="attr">state</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">msg</span>: <span class="string">&quot;添加成功&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">data</span>: <span class="literal">null</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="attr">meta</span>: &#123;</span><br><span class="line">                <span class="attr">state</span>: <span class="number">500</span>,</span><br><span class="line">                <span class="attr">msg</span>: <span class="string">&quot;添加失败&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">data</span>: <span class="literal">null</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义index查询学生方法</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@api</span> &#123;<span class="type">get</span>&#125; /stu 查询学生列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiName</span> <span class="variable">index</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiGroup</span> <span class="variable">Stu</span></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiParam</span> &#123;<span class="type">Number</span>&#125; id Users unique ID.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiSuccess</span> &#123;<span class="type">String</span>&#125; meta 状态码&amp;提示信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiSuccess</span> &#123;<span class="type">String</span>&#125; data 数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">index</span> = <span class="keyword">async</span> (<span class="params">req, res</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">//1.获取数据</span></span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> stuModel.<span class="title function_">query</span>()</span><br><span class="line">    <span class="comment">//2.响应数据</span></span><br><span class="line">    res.<span class="title function_">send</span>(&#123;</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">stage</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&quot;查询成功&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">data</span>: data</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//导出方法</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    add,</span><br><span class="line">    index</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4️⃣ 生成接口文档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apidoc -i ./接口注释目录 -o ./接口文档存放目录</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/4f553445c63679816e011884da6766e9png.jpg" alt="image-20210301115225423"></p>
<p>运行以上命令后，项目根目录下生成了<code>doc</code>目录，找到其中的<code>index.html</code>文件<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/51cc9da148ded8085bcc53b521138055png.jpg" alt="image-20210301115308615"><br>用浏览器打开，就是生成的接口文档<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/39be440d1f79510725e367df9ddc0567png.jpg" alt="image-20210301115327070"></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d20f536c64d06e5fcf4bfe2ec5dc25d.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d20f536c64d06e5fcf4bfe2ec5dc25d.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Smith</div><div class="post-copyright__author_desc">人生太短，要干的事太多，我要争分夺秒</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://smithhs.cn/2024/09/05/2024-09-05-MongoDB/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://smithhs.cn/2024/09/05/2024-09-05-MongoDB/')">MongoDB超详细教程</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/1.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/2.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://smithhs.cn/2024/09/05/2024-09-05-MongoDB/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=MongoDB超详细教程&amp;url=https://smithhs.cn/2024/09/05/2024-09-05-MongoDB/&amp;pic=https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/MongoDB.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://smithhs.cn" target="_blank">Smith</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/MongoDB/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>MongoDB<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/git.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/02/2024-07-02-Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/Docker1.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Docker常用命令</div></div></a></div><div class="next-post pull-right"><a href="/2024/09/05/2024-09-05-mongodb%20%E5%9B%BE%E5%BD%A2%E7%95%8C%E9%9D%A2%E5%B7%A5%E5%85%B7%20--%20Studio%203T/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/Studio%203T.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">mongodb 图形界面工具 -- Studio 3T</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">一、简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">1. 简单介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%B8%9A%E5%8A%A1%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.0.0.2.</span> <span class="toc-text">2. 业务应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E9%80%89%E6%8B%A9MongoDB"><span class="toc-number">1.0.0.3.</span> <span class="toc-text">3. 什么时候选择MongoDB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E4%BD%93%E7%B3%BB%E6%9C%BA%E6%9E%84"><span class="toc-number">1.0.0.4.</span> <span class="toc-text">4. 体系机构</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.0.0.4.1.</span> <span class="toc-text">数字类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.0.0.4.2.</span> <span class="toc-text">日期类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.0.0.4.3.</span> <span class="toc-text">数组类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ObjectId%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.0.0.4.4.</span> <span class="toc-text">ObjectId类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%B5%8C%E6%96%87%E6%A1%A3"><span class="toc-number">1.0.0.4.5.</span> <span class="toc-text">内嵌文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Code%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.0.0.4.6.</span> <span class="toc-text">Code类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.0.0.5.</span> <span class="toc-text">5. 数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E7%89%B9%E7%82%B9"><span class="toc-number">1.0.0.6.</span> <span class="toc-text">6. 特点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Windows%E5%AE%89%E8%A3%85-%E5%90%AF%E5%8A%A8-%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.1.</span> <span class="toc-text">二、Windows安装&amp;启动&amp;连接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD%E5%8E%8B%E7%BC%A9%E5%8C%85"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">1. 下载压缩包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%A7%A3%E5%8E%8B"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">2. 解压</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">3. 安装服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.0.4.</span> <span class="toc-text">4. 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-shell%E8%BF%9E%E6%8E%A5%E7%99%BB%E5%BD%95-%E9%80%80%E5%87%BA"><span class="toc-number">1.1.0.5.</span> <span class="toc-text">5. shell连接登录&amp;退出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-Compass%E5%9B%BE%E5%BD%A2%E5%8C%96%E8%BF%9E%E6%8E%A5%E7%99%BB%E5%BD%95"><span class="toc-number">1.1.0.6.</span> <span class="toc-text">6. Compass图形化连接登录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Linux%E5%AE%89%E8%A3%85-%E5%90%AF%E5%8A%A8-%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.2.</span> <span class="toc-text">三、Linux安装&amp;启动&amp;连接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99%E7%9A%84%E8%A7%A3%E5%86%B3%EF%BC%9A"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">启动报错的解决：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-Compass%E5%9B%BE%E5%BD%A2%E5%8C%96%E8%BF%9E%E6%8E%A5%E7%99%BB%E5%BD%95-1"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">6. Compass图形化连接登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%98%B2%E7%81%AB%E5%A2%99%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">查看防火墙是否开启</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%98%B2%E7%81%AB%E5%A2%99%E6%89%80%E5%BC%80%E6%94%BE%E7%9A%84%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.2.0.4.</span> <span class="toc-text">查看防火墙所开放的端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E6%94%BE90%E7%AB%AF%E5%8F%A3-%E2%80%93premanent%E8%A1%A8%E7%A4%BA%E6%B0%B8%E4%B9%85%E6%B7%BB%E5%8A%A0"><span class="toc-number">1.2.0.5.</span> <span class="toc-text">开放90端口(–premanent表示永久添加)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%90%AF%E9%98%B2%E7%81%AB%E5%A2%99-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E5%90%8E%E8%A6%81%E9%87%8D%E5%90%AF%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">1.2.0.6.</span> <span class="toc-text">重启防火墙(修改配置后要重启防火墙)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%9F%BA%E6%9C%AC%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.</span> <span class="toc-text">四、基本常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 数据库相关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%9B%86%E5%90%88%E7%9B%B8%E5%85%B3"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 集合相关</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81CURD"><span class="toc-number">1.4.</span> <span class="toc-text">五、CURD</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%EF%BC%9A%E6%8F%92%E5%85%A5%E6%96%87%E6%A1%A3"><span class="toc-number">1.4.1.</span> <span class="toc-text">增：插入文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%EF%BC%9A%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-number">1.4.2.</span> <span class="toc-text">删：删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B9%EF%BC%9A%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="toc-number">1.4.3.</span> <span class="toc-text">改：修改文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%EF%BC%9A%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">1.4.4.</span> <span class="toc-text">查：查询文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">统计查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%8E%92%E5%BA%8F-%E5%88%86%E9%A1%B5-%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.</span> <span class="toc-text">六、排序&amp;分页&amp;复杂查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F"><span class="toc-number">1.5.1.</span> <span class="toc-text">排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5"><span class="toc-number">1.5.2.</span> <span class="toc-text">分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.3.</span> <span class="toc-text">复杂查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%9A%84%E6%AD%A3%E5%88%99%E5%A4%8D%E6%9D%82%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">文档的正则复杂条件查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%9A%84%E6%AF%94%E8%BE%83%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">文档的比较查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%9A%84%E5%8C%85%E5%90%AB%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">文档的包含查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%9A%84%E6%9D%A1%E4%BB%B6%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.3.4.</span> <span class="toc-text">文档的条件连接查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.5.4.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.6.</span> <span class="toc-text">七、聚合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%AF%AD%E6%B3%95"><span class="toc-number">1.6.1.</span> <span class="toc-text">1. 语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.2.</span> <span class="toc-text">2. 测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Map-Reduce%E6%93%8D%E4%BD%9C"><span class="toc-number">1.6.3.</span> <span class="toc-text">Map-Reduce操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E7%B4%A2%E5%BC%95"><span class="toc-number">1.7.</span> <span class="toc-text">八、索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.7.1.</span> <span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%AF%AD%E6%B3%95"><span class="toc-number">1.7.2.</span> <span class="toc-text">2. 语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BB%83%E4%B9%A0"><span class="toc-number">1.7.3.</span> <span class="toc-text">3. 练习</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%86%E6%9E%90%E7%B4%A2%E5%BC%95-explain"><span class="toc-number">1.7.4.</span> <span class="toc-text">4. 分析索引(explain)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%80%89%E6%8B%A9%E8%A7%84%E5%88%99"><span class="toc-number">1.7.5.</span> <span class="toc-text">5. 选择规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%9D%83%E9%99%90%E6%9C%BA%E5%88%B6"><span class="toc-number">1.8.</span> <span class="toc-text">九、权限机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%B4%A6%E5%8F%B7%E8%AF%AD%E6%B3%95"><span class="toc-number">1.8.1.</span> <span class="toc-text">创建账号语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E9%AA%8C%E8%AF%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.8.2.</span> <span class="toc-text">开启验证模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0%E8%B6%85%E7%BA%A7%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E5%8F%B7"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">1. 添加超级管理员账号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8D%B8%E8%BD%BD%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">2. 卸载服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85%E9%9C%80%E8%A6%81%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">3. 安装需要身份验证的服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-1"><span class="toc-number">1.8.2.4.</span> <span class="toc-text">4. 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E7%99%BB%E5%BD%95%E6%B5%8B%E8%AF%95"><span class="toc-number">1.8.2.5.</span> <span class="toc-text">5. 登录测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E9%80%9A%E8%BF%87%E8%B6%85%E7%BA%A7%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E5%8F%B7%E7%99%BB%E5%BD%95"><span class="toc-number">1.8.2.6.</span> <span class="toc-text">6. 通过超级管理员账号登录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0"><span class="toc-number">1.8.3.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F"><span class="toc-number">1.9.</span> <span class="toc-text">十、备份还原</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDMongoDB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B7%A5%E5%85%B7"><span class="toc-number">1.9.1.</span> <span class="toc-text">下载MongoDB数据库工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E5%BA%93mongodump"><span class="toc-number">1.9.2.</span> <span class="toc-text">备份数据库mongodump</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%98%E5%8E%9F%E6%95%B0%E6%8D%AE%E5%BA%93mongorestore"><span class="toc-number">1.9.3.</span> <span class="toc-text">还原数据库mongorestore</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8Java%E6%93%8D%E4%BD%9CMongoDB"><span class="toc-number">1.10.</span> <span class="toc-text">十一、测试使用Java操作MongoDB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAJava%E7%8E%AF%E5%A2%83"><span class="toc-number">1.10.1.</span> <span class="toc-text">搭建Java环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JDK%E7%9A%84%E5%8D%B8%E8%BD%BD"><span class="toc-number">1.10.1.1.</span> <span class="toc-text">JDK的卸载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%96%B0%E7%89%88%E7%9A%84JDK"><span class="toc-number">1.10.1.2.</span> <span class="toc-text">安装新版的JDK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#maven%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">1.10.1.3.</span> <span class="toc-text">maven的安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EJava-API%E6%93%8D%E4%BD%9CMongoDB"><span class="toc-number">1.10.2.</span> <span class="toc-text">基于Java API操作MongoDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#idea%E9%A1%B9%E7%9B%AE%E5%BB%BA%E7%AB%8B"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">idea项目建立</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%AE%AD-%E6%96%87%E7%AB%A0%E8%AF%84%E8%AE%BA"><span class="toc-number">1.10.3.</span> <span class="toc-text">项目实训  文章评论</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">需要实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97%E6%90%AD%E5%BB%BA"><span class="toc-number">1.10.4.</span> <span class="toc-text">文章微服务模块搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%B7%A5%E7%A8%8Barticle%EF%BC%8C%E5%B9%B6%E8%AE%BE%E7%BD%AEpom-xml%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96%EF%BC%9A"><span class="toc-number">1.10.4.1.</span> <span class="toc-text">（1）搭建项目工程article，并设置pom.xml引入依赖：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E5%9C%A8article-src-main-resources%E4%B8%8B%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6application-yml"><span class="toc-number">1.10.4.2.</span> <span class="toc-text">（2）在article\src\main\resources下创建文件application.yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.10.4.3.</span> <span class="toc-text">（3）创建启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE%EF%BC%8C%E7%9C%8B%E6%98%AF%E5%90%A6%E8%83%BD%E6%AD%A3%E5%B8%B8%E5%90%AF%E5%8A%A8%EF%BC%8C%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%B2%A1%E6%9C%89%E9%94%99%E8%AF%AF%E3%80%82"><span class="toc-number">1.10.4.4.</span> <span class="toc-text">（4）启动项目，看是否能正常启动，控制台没有错误。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E8%AF%84%E8%AE%BA%E5%AE%9E%E4%BD%93%E7%B1%BB%E7%9A%84%E7%BC%96%E5%86%99"><span class="toc-number">1.10.5.</span> <span class="toc-text">文章评论实体类的编写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E8%AF%84%E8%AE%BA%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">1.10.6.</span> <span class="toc-text">文章评论的基本增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E6%8E%A5%E5%8F%A3-cn-itcast-article%E5%8C%85%E4%B8%8B%E5%88%9B%E5%BB%BAdao%E5%8C%85%EF%BC%8C%E5%8C%85%E4%B8%8B%E5%88%9B%E5%BB%BA%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.10.6.1.</span> <span class="toc-text">（1）创建数据访问接口 cn.itcast.article包下创建dao包，包下创建接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E5%88%9B%E5%BB%BA%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E7%B1%BB-cn-itcast-article%E5%8C%85%E4%B8%8B%E5%88%9B%E5%BB%BAservice%E5%8C%85%EF%BC%8C%E5%8C%85%E4%B8%8B%E5%88%9B%E5%BB%BA%E7%B1%BB"><span class="toc-number">1.10.6.2.</span> <span class="toc-text">（2）创建业务逻辑类 cn.itcast.article包下创建service包，包下创建类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E6%96%B0%E5%BB%BAJunit%E6%B5%8B%E8%AF%95%E7%B1%BB%EF%BC%8C%E6%B5%8B%E8%AF%95%E4%BF%9D%E5%AD%98%E5%92%8C%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%EF%BC%9A"><span class="toc-number">1.10.6.3.</span> <span class="toc-text">（3）新建Junit测试类，测试保存和查询所有：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81MongoDB%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.11.</span> <span class="toc-text">十二、MongoDB副本集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E6%A6%82%E8%BF%B0"><span class="toc-number">1.11.1.</span> <span class="toc-text">副本集概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E6%88%90%E5%91%98"><span class="toc-number">1.11.2.</span> <span class="toc-text">副本集成员</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E6%88%90%E5%91%98%E6%9E%B6%E6%9E%84"><span class="toc-number">1.11.2.1.</span> <span class="toc-text">副本集成员架构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.11.3.</span> <span class="toc-text">部署副本集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E6%96%B9%E6%A1%88"><span class="toc-number">1.11.3.1.</span> <span class="toc-text">推荐方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">1.11.3.2.</span> <span class="toc-text">1.创建主节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9"><span class="toc-number">1.11.3.3.</span> <span class="toc-text">2.创建副本节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9"><span class="toc-number">1.11.3.4.</span> <span class="toc-text">3.创建仲裁节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-2"><span class="toc-number">1.11.3.5.</span> <span class="toc-text">4.启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE%E5%89%AF%E6%9C%AC%E9%9B%86%E5%92%8C%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">1.11.3.6.</span> <span class="toc-text">5.初始化配置副本集和主节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9"><span class="toc-number">1.11.3.7.</span> <span class="toc-text">6.查看副本集的配置内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8A%B6%E6%80%81"><span class="toc-number">1.11.3.8.</span> <span class="toc-text">7.查看副本集状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E6%B7%BB%E5%8A%A0%E5%89%AF%E6%9C%AC%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="toc-number">1.11.3.9.</span> <span class="toc-text">8.添加副本从节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-%E6%B7%BB%E5%8A%A0%E4%BB%B2%E8%A3%81%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="toc-number">1.11.3.10.</span> <span class="toc-text">9.添加仲裁从节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-%E5%8F%AF%E4%BD%BF%E7%94%A8%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.11.3.11.</span> <span class="toc-text">10.可使用可视化工具创建连接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E6%93%8D%E4%BD%9C"><span class="toc-number">1.11.4.</span> <span class="toc-text">副本集操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">1.11.4.1.</span> <span class="toc-text">副本集的数据读写操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%99%BB%E5%BD%95%E4%B8%BB%E8%8A%82%E7%82%B927017"><span class="toc-number">1.11.4.1.1.</span> <span class="toc-text">1.登录主节点27017</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%99%BB%E5%BD%95%E4%BB%8E%E8%8A%82%E7%82%B927018%EF%BC%9A"><span class="toc-number">1.11.4.1.2.</span> <span class="toc-text">2.登录从节点27018：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E7%99%BB%E5%BD%95%E4%BB%B2%E8%A3%81%E8%80%85%E8%8A%82%E7%82%B927019"><span class="toc-number">1.11.4.1.3.</span> <span class="toc-text">3.登录仲裁者节点27019</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9C%BA%E5%88%B6"><span class="toc-number">1.11.5.</span> <span class="toc-text">副本集机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6"><span class="toc-number">1.11.5.1.</span> <span class="toc-text">同步机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6"><span class="toc-number">1.11.5.2.</span> <span class="toc-text">选举机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%B8%BB%E8%8A%82%E7%82%B9%E7%9A%84%E9%80%89%E4%B8%BE%E5%8E%9F%E5%88%99"><span class="toc-number">1.11.5.2.1.</span> <span class="toc-text">1.主节点的选举原则</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.11.5.3.</span> <span class="toc-text">故障测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.11.5.3.1.</span> <span class="toc-text">1.副本节点故障测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E4%B8%BB%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.11.5.3.2.</span> <span class="toc-text">2.主节点故障测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9%E5%92%8C%E4%B8%BB%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="toc-number">1.11.5.3.3.</span> <span class="toc-text">3.仲裁节点和主节点故障</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9%E5%92%8C%E4%BB%8E%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="toc-number">1.11.5.3.4.</span> <span class="toc-text">4.仲裁节点和从节点故障</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%83%E8%B7%B3%E6%A3%80%E6%B5%8B%E6%9C%BA%E5%88%B6"><span class="toc-number">1.11.5.4.</span> <span class="toc-text">心跳检测机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">1.11.6.</span> <span class="toc-text">安全认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%89%AF%E6%9C%AC%E9%9B%86%E4%B8%AD%E5%BC%80%E5%90%AFKeyFile%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD"><span class="toc-number">1.11.6.1.</span> <span class="toc-text">在副本集中开启KeyFile安全认证功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%E5%90%AF%E5%8A%A8"><span class="toc-number">1.11.6.2.</span> <span class="toc-text">验证安全认证是否成功启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81MongoDB%E5%88%86%E7%89%87"><span class="toc-number">1.12.</span> <span class="toc-text">十三、MongoDB分片</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E6%A6%82%E8%BF%B0"><span class="toc-number">1.12.1.</span> <span class="toc-text">分片概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="toc-number">1.12.2.</span> <span class="toc-text">分片策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87"><span class="toc-number">1.12.2.1.</span> <span class="toc-text">范围分片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E5%88%86%E7%89%87"><span class="toc-number">1.12.2.2.</span> <span class="toc-text">哈希分片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">1.12.2.3.</span> <span class="toc-text">分片集群架构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4"><span class="toc-number">1.12.3.</span> <span class="toc-text">部署分片集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%EF%BC%88%E5%AD%98%E5%82%A8%EF%BC%89%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">1.12.3.1.</span> <span class="toc-text">分片（存储）节点副本集的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%AC%AC%E4%B8%80%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.12.3.1.1.</span> <span class="toc-text">1.第一套副本集</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#27018%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.3.1.1.1.</span> <span class="toc-text">27018的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#27118%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.3.1.1.2.</span> <span class="toc-text">27118的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#27218%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.3.1.1.3.</span> <span class="toc-text">27218的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%B8%80%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.12.3.1.1.4.</span> <span class="toc-text">启动第一套副本集</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%AC%AC%E4%B8%80%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.12.3.1.1.5.</span> <span class="toc-text">初始化第一套副本集</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%AC%AC%E4%BA%8C%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.12.3.1.2.</span> <span class="toc-text">2.第二套副本集</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#27318%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.3.1.2.1.</span> <span class="toc-text">27318的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#27418%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.3.1.2.2.</span> <span class="toc-text">27418的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#27518%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.3.1.2.3.</span> <span class="toc-text">27518的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%BA%8C%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.12.3.1.2.4.</span> <span class="toc-text">启动第二套副本集</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%AC%AC%E4%BA%8C%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.12.3.1.2.5.</span> <span class="toc-text">初始化第二套副本集</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">1.12.4.</span> <span class="toc-text">配置节点副本集的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#27019%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.4.0.0.1.</span> <span class="toc-text">27019的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#27119%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.4.0.0.2.</span> <span class="toc-text">27119的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#27219%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.4.0.0.3.</span> <span class="toc-text">27219的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.12.4.0.0.4.</span> <span class="toc-text">启动配置副本集</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.12.4.0.0.5.</span> <span class="toc-text">初始化配置节点副本集</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E6%93%8D%E4%BD%9C"><span class="toc-number">1.12.4.1.</span> <span class="toc-text">路由节点的创建和操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%AC%AC%E4%B8%80%E5%A5%97%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E6%93%8D%E4%BD%9C"><span class="toc-number">1.12.4.1.1.</span> <span class="toc-text">1.第一套路由节点的创建和操作</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#27017%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.4.1.1.1.</span> <span class="toc-text">27017的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%B7%AF%E7%94%B1mongos"><span class="toc-number">1.12.4.1.1.2.</span> <span class="toc-text">启动第一个路由mongos</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E4%B8%8A%E8%BF%9B%E8%A1%8C%E5%88%86%E7%89%87%E9%85%8D%E7%BD%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">1.12.4.1.2.</span> <span class="toc-text">2.在路由节点上进行分片配置操作</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E6%B7%BB%E5%8A%A0%E5%88%86%E7%89%87"><span class="toc-number">1.12.4.1.2.1.</span> <span class="toc-text">（1）添加分片</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E5%BC%80%E5%90%AF%E5%88%86%E7%89%87%E5%8A%9F%E8%83%BD"><span class="toc-number">1.12.4.1.2.2.</span> <span class="toc-text">（2）开启分片功能</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E9%9B%86%E5%90%88%E5%88%86%E7%89%87"><span class="toc-number">1.12.4.1.2.3.</span> <span class="toc-text">（3）集合分片</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E7%89%87%E8%A7%84%E5%88%99%E4%B8%80%EF%BC%9A%E5%93%88%E5%B8%8C%E7%AD%96%E7%95%A5"><span class="toc-number">1.12.4.1.2.4.</span> <span class="toc-text">分片规则一：哈希策略</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E7%89%87%E8%A7%84%E5%88%99%E4%BA%8C%EF%BC%9A%E8%8C%83%E5%9B%B4%E7%AD%96%E7%95%A5"><span class="toc-number">1.12.4.1.2.5.</span> <span class="toc-text">分片规则二：范围策略</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%8C%83%E5%9B%B4%E7%9A%84%E5%88%86%E7%89%87%E6%96%B9%E5%BC%8F%E4%B8%8E%E5%9F%BA%E4%BA%8E%E5%93%88%E5%B8%8C%E7%9A%84%E5%88%86%E7%89%87%E6%96%B9%E5%BC%8F%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%EF%BC%9A"><span class="toc-number">1.12.4.1.2.6.</span> <span class="toc-text">基于范围的分片方式与基于哈希的分片方式性能对比：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%88%86%E7%89%87%E5%90%8E%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">1.12.4.1.3.</span> <span class="toc-text">3.分片后插入数据测试</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%B8%80%EF%BC%88%E5%93%88%E5%B8%8C%E8%A7%84%E5%88%99%EF%BC%89%EF%BC%9A"><span class="toc-number">1.12.4.1.3.1.</span> <span class="toc-text">测试一（哈希规则）：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%EF%BC%88%E8%8C%83%E5%9B%B4%E8%A7%84%E5%88%99%EF%BC%89%EF%BC%9A"><span class="toc-number">1.12.4.1.3.2.</span> <span class="toc-text">测试二（范围规则）：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%86%8D%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9"><span class="toc-number">1.12.4.1.4.</span> <span class="toc-text">4.再增加一个路由节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%A5%97%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E6%93%8D%E4%BD%9C"><span class="toc-number">1.12.4.1.4.1.</span> <span class="toc-text">第二套路由节点的创建和操作</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#27117%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.4.1.4.2.</span> <span class="toc-text">27117的配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%BA%8C%E4%B8%AA%E8%B7%AF%E7%94%B1mongos"><span class="toc-number">1.12.4.1.4.3.</span> <span class="toc-text">启动第二个路由mongos</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.12.4.2.</span> <span class="toc-text">可视化工具连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringDataMongoDB%E8%BF%9E%E6%8E%A5%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4"><span class="toc-number">1.12.4.3.</span> <span class="toc-text">SpringDataMongoDB连接分片集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%90%AF%E5%8A%A8mongod%E5%92%8Cmongos%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.12.4.3.1.</span> <span class="toc-text">1.启动mongod和mongos服务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%90%AF%E5%8A%A8idea%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.12.4.4.</span> <span class="toc-text">2.启动idea项目</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mongod-%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8"><span class="toc-number">1.12.5.</span> <span class="toc-text">mongod 无法启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-number">1.12.5.1.</span> <span class="toc-text">解决方案：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-number">1.12.5.2.</span> <span class="toc-text">具体操作示例：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%87%8D%E5%90%AF%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%88%96%E8%80%85%E9%9D%9E%E6%B3%95%E6%93%8D%E4%BD%9C%E5%85%B3%E9%97%AD%E8%8A%82%E7%82%B9%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%AF%BC%E8%87%B4mongod%E6%9C%8D%E5%8A%A1%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E5%90%AF%E5%8A%A8%E3%80%82"><span class="toc-number">1.12.5.2.1.</span> <span class="toc-text">1、服务器重启之后，或者非法操作关闭节点之后，导致mongod服务无法正常启动。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E4%BE%9D%E6%AC%A1%E5%90%AF%E5%8A%A8%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%8C%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E5%92%8C%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%AD%A3%E5%B8%B8%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%8F%AA%E9%9C%80%E8%A6%81%E4%BF%AE%E5%A4%8D2%E4%B8%AA%E5%88%86%E7%89%87%E8%8A%82%E7%82%B9%E7%9A%84%E5%89%AF%E6%9C%AC%E9%9B%86%E3%80%82"><span class="toc-number">1.12.5.2.2.</span> <span class="toc-text">2、依次启动其他服务发现，配置节点和路由节点服务启动正常，因此只需要修复2个分片节点的副本集。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E5%9C%A8%E6%9C%AC%E6%AC%A1%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E4%B8%8B%EF%BC%8C%E5%8F%AA%E9%9C%80%E4%BF%AE%E5%A4%8D%E5%88%86%E7%89%87%E8%8A%82%E7%82%B9%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%E5%9B%A0%E6%AD%A4%E5%88%A0%E9%99%A4db%E7%9B%AE%E5%BD%95%E9%87%8C%E9%9D%A2%E7%9A%84-mongod-lock-%E5%92%8C-%E5%88%A0%E9%99%A4db%E7%9B%AE%E5%BD%95%E9%87%8C%E9%9D%A2%E7%9A%84storage-bson"><span class="toc-number">1.12.5.2.3.</span> <span class="toc-text">3、在本次运行环境下，只需修复分片节点的数据。因此删除db目录里面的&#x2F;mongod.lock 和 删除db目录里面的storage.bson</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E3%80%81%E4%BF%AE%E5%A4%8D%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BE%9D%E6%AC%A1%E4%BF%AE%E5%A4%8D27018%E2%80%9327518%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">1.12.5.2.4.</span> <span class="toc-text">4、修复数据，依次修复27018–27518的数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%E3%80%81%E5%85%88%E4%BB%A5%E4%BF%AE%E5%A4%8D%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8mongodb%EF%BC%8C%E5%86%8D%E6%8E%A5%E7%9D%80%E6%AD%A3%E5%B8%B8%E5%90%AF%E5%8A%A8%E4%B8%80%E6%AC%A1"><span class="toc-number">1.12.5.2.5.</span> <span class="toc-text">5、先以修复方式启动mongodb，再接着正常启动一次</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81MongoDB-GridFS"><span class="toc-number">1.13.</span> <span class="toc-text">十四、MongoDB GridFS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GridFS%E6%A6%82%E8%BF%B0"><span class="toc-number">1.13.1.</span> <span class="toc-text">GridFS概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GridFS%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.13.2.</span> <span class="toc-text">GridFS存储结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GridFS%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">1.13.3.</span> <span class="toc-text">GridFS基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%9C%AC%E5%9C%B0%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E5%88%B0GridFS"><span class="toc-number">1.13.3.1.</span> <span class="toc-text">上传本地系统文件到GridFS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8BGridFS%E9%9B%86%E5%90%88"><span class="toc-number">1.13.3.2.</span> <span class="toc-text">查看GridFS集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8BGridFS%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-number">1.13.3.3.</span> <span class="toc-text">查看GridFS中的文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDGridFS%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-number">1.13.3.4.</span> <span class="toc-text">下载GridFS中的文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4GridFS%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-number">1.13.3.5.</span> <span class="toc-text">删除GridFS中的文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Java%E6%93%8D%E4%BD%9CMongoDB-GridFS"><span class="toc-number">1.13.4.</span> <span class="toc-text">使用Java操作MongoDB GridFS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BAMaven%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.13.4.1.</span> <span class="toc-text">1. 创建Maven项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96%E3%80%82"><span class="toc-number">1.13.4.2.</span> <span class="toc-text">2. 导入依赖。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6"><span class="toc-number">1.13.4.3.</span> <span class="toc-text">3. 创建资源文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%88%9B%E5%BB%BAJava%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">1.13.4.4.</span> <span class="toc-text">4. 创建Java工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%88%9B%E5%BB%BAJava%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-number">1.13.4.5.</span> <span class="toc-text">5. 创建Java测试类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-number">1.13.4.5.1.</span> <span class="toc-text">（1）上传文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-number">1.13.4.5.2.</span> <span class="toc-text">（2）下载文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E9%87%8D%E5%91%BD%E5%90%8D"><span class="toc-number">1.13.4.5.3.</span> <span class="toc-text">（3）重命名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"><span class="toc-number">1.13.4.5.4.</span> <span class="toc-text">（4）删除文件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%94%E3%80%81%E9%94%AE%E5%80%BC%E5%AF%B9%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93Redis"><span class="toc-number">1.14.</span> <span class="toc-text">十五、键值对存储数据库Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="toc-number">1.14.1.</span> <span class="toc-text">Redis的概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E7%AE%80%E4%BB%8B"><span class="toc-number">1.14.1.1.</span> <span class="toc-text">Redis简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.14.1.2.</span> <span class="toc-text">Redis能干什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E4%B8%AD%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%9C%E8%A5%BF"><span class="toc-number">1.14.1.3.</span> <span class="toc-text">学习中需要用到的东西</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.14.2.</span> <span class="toc-text">Redis支持的数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E7%9A%84%E9%83%A8%E7%BD%B2"><span class="toc-number">1.14.3.</span> <span class="toc-text">Redis的部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ELinux%E5%B9%B3%E5%8F%B0"><span class="toc-number">1.14.3.1.</span> <span class="toc-text">基于Linux平台</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8redis-cli%E6%93%8D%E4%BD%9CRedis"><span class="toc-number">1.14.4.</span> <span class="toc-text">使用redis-cli操作Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.14.4.1.</span> <span class="toc-text">基础知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.14.4.2.</span> <span class="toc-text">五大数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#0-%E6%93%8D%E4%BD%9C%E9%94%AE"><span class="toc-number">1.14.4.2.1.</span> <span class="toc-text">0 操作键</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%93%8D%E4%BD%9CString%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.14.4.2.2.</span> <span class="toc-text">1 操作String字符串</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%93%8D%E4%BD%9CList%E5%88%97%E8%A1%A8"><span class="toc-number">1.14.4.2.3.</span> <span class="toc-text">2 操作List列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%93%8D%E4%BD%9CSets%E9%9B%86%E5%90%88"><span class="toc-number">1.14.4.2.4.</span> <span class="toc-text">3 操作Sets集合</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%93%8D%E4%BD%9CHash%E6%95%A3%E5%88%97"><span class="toc-number">1.14.4.2.5.</span> <span class="toc-text">4 操作Hash散列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E6%93%8D%E4%BD%9CZset-Sorted-Sets%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88"><span class="toc-number">1.14.4.2.6.</span> <span class="toc-text">5 操作Zset &#x2F; Sorted Sets有序集合</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.14.4.3.</span> <span class="toc-text">三种特殊数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Geospatial-%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.14.4.3.1.</span> <span class="toc-text">1 Geospatial(地理位置)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Hyperloglog-%E5%9F%BA%E6%95%B0%E7%BB%9F%E8%AE%A1"><span class="toc-number">1.14.4.3.2.</span> <span class="toc-text">2 Hyperloglog(基数统计)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-BitMaps-%E4%BD%8D%E5%9B%BE"><span class="toc-number">1.14.4.3.3.</span> <span class="toc-text">3 BitMaps(位图)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Java%E6%93%8D%E4%BD%9CRedis"><span class="toc-number">1.14.5.</span> <span class="toc-text">使用Java操作Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.14.5.1.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E9%94%AE"><span class="toc-number">1.14.5.2.</span> <span class="toc-text">操作键</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.14.5.3.</span> <span class="toc-text">操作字符串</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E5%88%97%E8%A1%A8"><span class="toc-number">1.14.5.4.</span> <span class="toc-text">操作列表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%EF%BC%9A"><span class="toc-number">1.14.5.4.1.</span> <span class="toc-text">作业：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E9%9B%86%E5%90%88"><span class="toc-number">1.14.5.5.</span> <span class="toc-text">操作集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%95%A3%E5%88%97"><span class="toc-number">1.14.5.6.</span> <span class="toc-text">操作散列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88"><span class="toc-number">1.14.5.7.</span> <span class="toc-text">操作有序集合</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E5%85%AD%E3%80%81%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93HBase"><span class="toc-number">1.15.</span> <span class="toc-text">十六、列式存储数据库HBase</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HBase%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="toc-number">1.15.1.</span> <span class="toc-text">HBase的概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Hbase%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="toc-number">1.15.1.1.</span> <span class="toc-text">Hbase的来源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HBase%E5%AE%9A%E4%B9%89"><span class="toc-number">1.15.1.2.</span> <span class="toc-text">HBase定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HBase%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">1.15.1.3.</span> <span class="toc-text">HBase的特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hbase%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-number">1.15.1.4.</span> <span class="toc-text">Hbase的优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hbase%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">1.15.1.5.</span> <span class="toc-text">Hbase的缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HBase%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.15.2.</span> <span class="toc-text">HBase的数据模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HBase%E9%80%BB%E8%BE%91%E7%BB%93%E6%9E%84"><span class="toc-number">1.15.2.1.</span> <span class="toc-text">HBase逻辑结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HBase%E7%89%A9%E7%90%86%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.15.2.2.</span> <span class="toc-text">HBase物理存储结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HBase%E7%9A%84%E6%9E%B6%E6%9E%84"><span class="toc-number">1.15.3.</span> <span class="toc-text">HBase的架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HBase%E7%9A%84%E9%83%A8%E7%BD%B2"><span class="toc-number">1.15.4.</span> <span class="toc-text">HBase的部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85JDK"><span class="toc-number">1.15.4.1.</span> <span class="toc-text">安装JDK</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%B8%8A%E4%BC%A0%E8%BD%AF%E4%BB%B6%E5%8C%85-jdk-8u211-linux-x64-tar-gz"><span class="toc-number">1.15.4.1.1.</span> <span class="toc-text">1 上传软件包 jdk-8u211-linux-x64.tar.gz</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E8%A7%A3%E5%8E%8B%E8%BD%AF%E4%BB%B6%E5%8C%85-jdk-8u211-linux-x64-tar-gz"><span class="toc-number">1.15.4.1.2.</span> <span class="toc-text">2 解压软件包 jdk-8u211-linux-x64.tar.gz</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%B7%BB%E5%8A%A0%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.15.4.1.3.</span> <span class="toc-text">3 添加环境变量</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Hadoop%EF%BC%88%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%EF%BC%89"><span class="toc-number">1.15.4.2.</span> <span class="toc-text">安装Hadoop（伪分布式）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#0-%E5%AE%8C%E5%85%A8%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">1.15.4.2.1.</span> <span class="toc-text">0 完全分布式集群（了解）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C%EF%BC%88%E8%87%B3%E5%B0%914G%E5%86%85%E5%AD%98%EF%BC%89%EF%BC%9A"><span class="toc-number">1.15.4.2.2.</span> <span class="toc-text">1 准备工作（至少4G内存）：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E5%AE%89%E8%A3%85JDK%EF%BC%9AHadoop%E8%BF%90%E8%A1%8C%E7%9A%84%E5%89%8D%E6%8F%90%E6%98%AF%E6%9C%AC%E6%9C%BA%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E4%BA%86JDK%EF%BC%8C%E9%85%8D%E7%BD%AEJAVA-HOME%E5%8F%98%E9%87%8F"><span class="toc-number">1.15.4.2.2.1.</span> <span class="toc-text">（1）验证是否安装JDK：Hadoop运行的前提是本机已经安装了JDK，配置JAVA_HOME变量</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6host%E6%98%A0%E5%B0%84%EF%BC%9A%E5%9C%A8Hadoop%E4%B8%AD%E5%90%AF%E5%8A%A8%E5%A4%9A%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.15.4.2.3.</span> <span class="toc-text">（2）验证是否host映射：在Hadoop中启动多种不同类型的进程</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E6%B3%A8%E6%84%8F%E6%9D%83%E9%99%90%E5%88%9B%E5%BB%BA%E5%B9%B6%E4%BD%BF%E7%94%A8%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.4.2.3.1.</span> <span class="toc-text">（3）注意权限创建并使用普通用户操作</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99-%E5%85%B3%E9%97%ADselinux%EF%BC%8C%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E4%B8%8D%E8%87%AA%E5%90%AF%E5%8A%A8-%E5%AD%A6%E4%B9%A0%E7%94%A8"><span class="toc-number">1.15.4.2.3.2.</span> <span class="toc-text">（4）关闭防火墙,关闭selinux，设置开机不自启动(学习用)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E8%AE%BE%E7%BD%AEXShell"><span class="toc-number">1.15.4.2.3.3.</span> <span class="toc-text">（5）设置XShell</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%B5%8B%E8%AF%95%E8%BF%9E%E9%80%9A%E6%80%A7"><span class="toc-number">1.15.4.2.4.</span> <span class="toc-text">2 测试连通性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="toc-number">1.15.4.2.5.</span> <span class="toc-text">3 免密登录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E4%B8%8A%E4%BC%A0%E8%BD%AF%E4%BB%B6%E5%8C%85hadoop-2-7-4-tar-gz"><span class="toc-number">1.15.4.2.6.</span> <span class="toc-text">4 上传软件包hadoop-2.7.4.tar.gz</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E8%A7%A3%E5%8E%8B%E8%BD%AF%E4%BB%B6%E5%8C%85hadoop-2-7-4-tar-gz"><span class="toc-number">1.15.4.2.7.</span> <span class="toc-text">5 解压软件包hadoop-2.7.4.tar.gz</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E6%B7%BB%E5%8A%A0hadoop%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.15.4.2.8.</span> <span class="toc-text">6 添加hadoop环境变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E5%88%86%E5%B8%83%E5%BC%8FHDFS%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E5%90%AF%E5%8A%A8"><span class="toc-number">1.15.4.2.9.</span> <span class="toc-text">7 分布式HDFS的安装和启动</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E4%BF%AE%E6%94%B9-HADOOP-HOME-etc-hadoop-hadoop-env-sh"><span class="toc-number">1.15.4.2.9.1.</span> <span class="toc-text">（1）修改 $HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;hadoop-env.sh</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E4%BF%AE%E6%94%B9-HADOOP-HOME-etc-hadoop-core-site-xml"><span class="toc-number">1.15.4.2.9.2.</span> <span class="toc-text">（2）修改 $HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;core-site.xml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E4%BF%AE%E6%94%B9-HADOOP-HOME-etc-hadoop-hdfs-site-xml"><span class="toc-number">1.15.4.2.9.3.</span> <span class="toc-text">（3）修改 $HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;hdfs-site.xml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E6%A0%BC%E5%BC%8F%E5%8C%96Namenode%EF%BC%88%E5%8F%AA%E9%9C%80%E8%A6%81%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%80%E6%AC%A1%EF%BC%89"><span class="toc-number">1.15.4.2.9.4.</span> <span class="toc-text">（4）格式化Namenode（只需要格式化一次）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E9%9B%86%E7%BE%A4%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="toc-number">1.15.4.2.9.5.</span> <span class="toc-text">（5）集群时间同步</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E8%BF%90%E8%A1%8C%E7%BE%A4%E5%90%AF%E8%84%9A%E6%9C%AC"><span class="toc-number">1.15.4.2.9.6.</span> <span class="toc-text">（6）运行群启脚本</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%887%EF%BC%89%E6%9F%A5%E7%9C%8B"><span class="toc-number">1.15.4.2.9.7.</span> <span class="toc-text">（7）查看</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%888%EF%BC%89%E8%BF%90%E8%A1%8C%E7%BE%A4%E5%81%9C%E8%84%9A%E6%9C%AC"><span class="toc-number">1.15.4.2.9.8.</span> <span class="toc-text">（8）运行群停脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85HBase"><span class="toc-number">1.15.4.3.</span> <span class="toc-text">安装HBase</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%B8%8A%E4%BC%A0%E8%BD%AF%E4%BB%B6%E5%8C%85-hbase-1-2-1-bin-tar-gz"><span class="toc-number">1.15.4.3.1.</span> <span class="toc-text">1 上传软件包 hbase-1.2.1-bin.tar.gz</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E8%A7%A3%E5%8E%8B%E8%BD%AF%E4%BB%B6%E5%8C%85-hbase-1-2-1-bin-tar-gz"><span class="toc-number">1.15.4.3.2.</span> <span class="toc-text">2 解压软件包 hbase-1.2.1-bin.tar.gz</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-HBase%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">1.15.4.3.3.</span> <span class="toc-text">3 HBase的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E4%BF%AE%E6%94%B9-conf-HBase-env-sh"><span class="toc-number">1.15.4.3.3.1.</span> <span class="toc-text">（1）修改 conf&#x2F;HBase-env.sh</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E4%BF%AE%E6%94%B9-conf-HBase-site-xml"><span class="toc-number">1.15.4.3.3.2.</span> <span class="toc-text">（2）修改 conf&#x2F;HBase-site.xml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E4%BF%AE%E6%94%B9-conf-regionservers"><span class="toc-number">1.15.4.3.3.3.</span> <span class="toc-text">（3）修改 conf&#x2F;regionservers</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E9%85%8D%E7%BD%AEhbase%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.15.4.3.3.4.</span> <span class="toc-text">（4）配置hbase环境变量</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%EF%BC%885%EF%BC%89XShell%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.15.4.3.3.5.</span> <span class="toc-text">（5）XShell的设置</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8HBase%E9%9B%86%E7%BE%A4"><span class="toc-number">1.15.5.</span> <span class="toc-text">启动HBase集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%90%AF%E5%8A%A8hdfs"><span class="toc-number">1.15.5.0.1.</span> <span class="toc-text">1 启动hdfs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%90%AF%E5%8A%A8HBase"><span class="toc-number">1.15.5.0.2.</span> <span class="toc-text">2 启动HBase</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%80%BB%E7%BB%93%EF%BC%9A%E9%9B%86%E7%BE%A4%E5%81%9C%E6%AD%A2"><span class="toc-number">1.15.5.0.3.</span> <span class="toc-text">4 总结：集群停止</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HBase%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.</span> <span class="toc-text">HBase的操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HBase%E7%9A%84Shell%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.1.</span> <span class="toc-text">HBase的Shell操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-number">1.15.6.1.1.</span> <span class="toc-text">1 创建表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%8F%92%E5%85%A5%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.1.2.</span> <span class="toc-text">2 插入操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%89%AB%E6%8F%8F%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.1.3.</span> <span class="toc-text">3 扫描操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8B%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.1.4.</span> <span class="toc-text">4 查看操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E6%9B%B4%E6%96%B0%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.1.5.</span> <span class="toc-text">5 更新操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.1.6.</span> <span class="toc-text">6 获取指定字段的操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E7%BB%9F%E8%AE%A1%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.1.7.</span> <span class="toc-text">7 统计操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-%E5%88%A0%E9%99%A4%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.1.8.</span> <span class="toc-text">8 删除操作</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HBase%E7%9A%84Java-API%E6%93%8D%E4%BD%9C"><span class="toc-number">1.15.6.2.</span> <span class="toc-text">HBase的Java API操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E5%AE%9E%E6%88%98%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AE%A1%E7%90%86Robo-3T"><span class="toc-number">1.16.</span> <span class="toc-text">十一、实战可视化管理Robo 3T</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85Robo-3T"><span class="toc-number">1.16.1.</span> <span class="toc-text">1. 下载安装Robo 3T</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8Robo-3T"><span class="toc-number">1.16.2.</span> <span class="toc-text">2. 使用Robo 3T</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81mongoose"><span class="toc-number">1.17.</span> <span class="toc-text">十二、mongoose</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B-1"><span class="toc-number">1.17.1.</span> <span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85"><span class="toc-number">1.17.2.</span> <span class="toc-text">2. 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-CURD%E8%AF%AD%E6%B3%95"><span class="toc-number">1.17.3.</span> <span class="toc-text">3. CURD语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.17.4.</span> <span class="toc-text">4. 测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A2%9E"><span class="toc-number">1.17.4.1.</span> <span class="toc-text">增</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5"><span class="toc-number">1.17.4.2.</span> <span class="toc-text">查</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.18.</span> <span class="toc-text">十三、接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B-2"><span class="toc-number">1.18.1.</span> <span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83-Restful-API"><span class="toc-number">1.18.2.</span> <span class="toc-text">2. 接口开发规范(Restful API)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7Postman"><span class="toc-number">1.18.3.</span> <span class="toc-text">3. 接口测试工具Postman</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B-3"><span class="toc-number">1.18.3.1.</span> <span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85"><span class="toc-number">1.18.3.2.</span> <span class="toc-text">2. 下载安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8"><span class="toc-number">1.18.3.3.</span> <span class="toc-text">3. 使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81express%E6%A1%86%E6%9E%B6%E6%95%99%E5%AD%A6%E7%B3%BB%E7%BB%9F%E5%AD%A6%E7%94%9F%E6%A8%A1%E5%9D%97%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">1.19.</span> <span class="toc-text">十四、express框架教学系统学生模块接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-express%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">1.19.1.</span> <span class="toc-text">1. express快速入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%95%99%E5%AD%A6%E7%B3%BB%E7%BB%9F%E5%AD%A6%E7%94%9F%E6%A8%A1%E5%9D%97%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">1.19.2.</span> <span class="toc-text">2. 教学系统学生模块接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96"><span class="toc-number">1.19.2.1.</span> <span class="toc-text">1. 安装模块依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-expree%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA%EF%BC%8C%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1"><span class="toc-number">1.19.2.2.</span> <span class="toc-text">2 expree框架搭建，定义路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-mongoose%E6%A8%A1%E5%9D%97%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.19.2.3.</span> <span class="toc-text">3. mongoose模块操作数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%BC%96%E5%86%99%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="toc-number">1.19.2.4.</span> <span class="toc-text">3. 编写路由处理方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%B5%8B%E8%AF%95-1"><span class="toc-number">1.19.2.5.</span> <span class="toc-text">4. 测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E5%BC%80%E5%8F%91apiDoc"><span class="toc-number">1.19.3.</span> <span class="toc-text">3. 接口文档开发apiDoc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B-4"><span class="toc-number">1.19.3.1.</span> <span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8"><span class="toc-number">1.19.3.2.</span> <span class="toc-text">2. 使用</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2022 - 2024 By <a class="footer-bar-link" href="/" title="Smith" target="_blank">Smith</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/Smithhss/smithhs.github.io.git" title="Hexo">Hexo</a></div></div></div></footer></div></div></div><div id="sidebar"><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://smith-1315833455.cos.ap-beijing.myqcloud.com/blog/d20f536c64d06e5fcf4bfe2ec5dc25d.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">77</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">55</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于我</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8805965276" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/my/m/music/playlist?id=464586318&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.6/translate/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.js"></script><script>var meting_api = "https://meting.qjqq.cn/?server=:server&type=:type&id=:id&auth=:auth&r=:r";
</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("07/01/2022 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2022 By 安知鱼 V1.5.3",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Smith 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "visitor@anheyu.com";</script><script>//动态标题
let leaveTitle = '再看看嘛🌈！';
let backTitle = '欢迎回来✌️！';
let OriginTitile = document.title
let titleTime
document.addEventListener('visibilitychange', function () {
  if (document.hidden) {
    //离开当前页面时标签显示内容
    document.title = leaveTitle
    clearTimeout(titleTime)
  } else {
    //返回当前页面时标签显示内容
    document.title = backTitle + OriginTitile
    //两秒后变回正常标题
    titleTime = setTimeout(function () {
      document.title = OriginTitile
    }, 2000)
  }
})</script><script async data-pjax src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/waterfall.js/1.1.0/waterfall.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script>// 初始化函数
let rm = {};

//禁止图片与超链接拖拽
let aElements = document.getElementsByTagName("a");
for (let i = 0; i < aElements.length; i++) {
  aElements[i].setAttribute("draggable", "false");
  let imgElements = aElements[i].getElementsByTagName("img");
  for (let j = 0; j < imgElements.length; j++) {
    imgElements[j].setAttribute("draggable", "false");
  }
}

// 显示菜单
rm.showRightMenu = function (isTrue, x = 0, y = 0) {
  console.info(x, y)
  let rightMenu = document.getElementById("rightMenu");
  rightMenu.style.top = x + "px";
  rightMenu.style.left = y + "px";
  if (isTrue) {
    rightMenu.style.display = "block";
    stopMaskScroll();
  } else {
    rightMenu.style.display = "none";
  }
};

// 隐藏菜单
rm.hideRightMenu = function () {
  rm.showRightMenu(false);
  let rightMenuMask = document.querySelector("#rightmenu-mask");
  rightMenuMask.style.display = "none";
};

// 尺寸
let rmWidth = document.getElementById("rightMenu").offsetWidth;
let rmHeight = document.getElementById("rightMenu").offsetHeight;

// 重新定义尺寸
rm.reloadrmSize = function () {
  rightMenu.style.visibility = "hidden";
  rightMenu.style.display = "block";
  // 获取宽度和高度
  rmWidth = document.getElementById("rightMenu").offsetWidth;
  rmHeight = document.getElementById("rightMenu").offsetHeight;
  rightMenu.style.visibility = "visible";
};

// 获取点击的href
let domhref = "";
let domImgSrc = "";
let globalEvent = null;

var oncontextmenuFunction = function (event) {
  if (document.body.clientWidth > 768) {
    let pageX = event.clientX + 10; //加10是为了防止显示时鼠标遮在菜单上
    let pageY = event.clientY;

    //其他额外菜单
    const $rightMenuOther = document.querySelector(".rightMenuOther");
    const $rightMenuPlugin = document.querySelector(".rightMenuPlugin");
    const $rightMenuCopyText = document.querySelector("#menu-copytext");
    const $rightMenuPasteText = document.querySelector("#menu-pastetext");
    const $rightMenuCommentText = document.querySelector("#menu-commenttext");
    const $rightMenuNewWindow = document.querySelector("#menu-newwindow");
    const $rightMenuNewWindowImg = document.querySelector("#menu-newwindowimg");
    const $rightMenuCopyLink = document.querySelector("#menu-copylink");
    const $rightMenuCopyImg = document.querySelector("#menu-copyimg");
    const $rightMenuDownloadImg = document.querySelector("#menu-downloadimg");
    const $rightMenuSearch = document.querySelector("#menu-search");
    const $rightMenuSearchBaidu = document.querySelector("#menu-searchBaidu");
    const $rightMenuMusicToggle = document.querySelector("#menu-music-toggle");
    const $rightMenuMusicBack = document.querySelector("#menu-music-back");
    const $rightMenuMusicForward = document.querySelector("#menu-music-forward");
    const $rightMenuMusicPlaylist = document.querySelector("#menu-music-playlist");
    const $rightMenuMusicCopyMusicName = document.querySelector("#menu-music-copyMusicName");

    let href = event.target.href;
    let imgsrc = event.target.currentSrc;

    // 判断模式 扩展模式为有事件
    let pluginMode = false;
    $rightMenuOther.style.display = "block";
    globalEvent = event;

    // 检查是否需要复制 是否有选中文本
    if (selectTextNow && window.getSelection()) {
      pluginMode = true;
      $rightMenuCopyText.style.display = "block";
      $rightMenuCommentText.style.display = "block";
      $rightMenuSearch.style.display = "block";
      $rightMenuSearchBaidu.style.display = "block";
    } else {
      $rightMenuCopyText.style.display = "none";
      $rightMenuCommentText.style.display = "none";
      $rightMenuSearchBaidu.style.display = "none";
      $rightMenuSearch.style.display = "none";
    }

    //检查是否右键点击了链接a标签
    if (href) {
      pluginMode = true;
      $rightMenuNewWindow.style.display = "block";
      $rightMenuCopyLink.style.display = "block";
      domhref = href;
    } else {
      $rightMenuNewWindow.style.display = "none";
      $rightMenuCopyLink.style.display = "none";
    }

    //检查是否需要复制图片
    if (imgsrc) {
      pluginMode = true;
      $rightMenuCopyImg.style.display = "block";
      $rightMenuDownloadImg.style.display = "block";
      $rightMenuNewWindowImg.style.display = "block";
      document.getElementById("rightMenu").style.width="12rem"
      domImgSrc = imgsrc;
    } else {
      $rightMenuCopyImg.style.display = "none";
      $rightMenuDownloadImg.style.display = "none";
      $rightMenuNewWindowImg.style.display = "none";
    }

    // 判断是否为输入框
    if (event.target.tagName.toLowerCase() === "input" || event.target.tagName.toLowerCase() === "textarea") {
      pluginMode = true;
      $rightMenuPasteText.style.display = "block";
    } else {
      $rightMenuPasteText.style.display = "none";
    }
    const navMusicEl = document.querySelector("#nav-music");
    //判断是否是音乐
    if (navMusicEl && navMusicEl.contains(event.target)) {
      pluginMode = true;
      $rightMenuMusicToggle.style.display = "block";
      $rightMenuMusicBack.style.display = "block";
      $rightMenuMusicForward.style.display = "block";
      $rightMenuMusicPlaylist.style.display = "block";
      $rightMenuMusicCopyMusicName.style.display = "block";
    } else {
      $rightMenuMusicToggle.style.display = "none";
      $rightMenuMusicBack.style.display = "none";
      $rightMenuMusicForward.style.display = "none";
      $rightMenuMusicPlaylist.style.display = "none";
      $rightMenuMusicCopyMusicName.style.display = "none";
    }

    // 如果不是扩展模式则隐藏扩展模块
    if (pluginMode) {
      $rightMenuOther.style.display = "none";
      $rightMenuPlugin.style.display = "block";
    } else {
      $rightMenuPlugin.style.display = "none";
    }

    rm.reloadrmSize();

    // 鼠标默认显示在鼠标右下方，当鼠标靠右或靠下时，将菜单显示在鼠标左方\上方
    if (pageX + rmWidth > window.innerWidth) {
      pageX -= rmWidth + 10;
    }
    if (pageY + rmHeight > window.innerHeight) {
      pageY -= pageY + rmHeight - window.innerHeight;
    }

    rm.showRightMenu(true, pageY, pageX);
    document.getElementById("rightmenu-mask").style.display = "flex";
    return false;
  }
};

// 监听右键初始化
window.oncontextmenu = oncontextmenuFunction

// 下载图片状态
rm.downloadimging = false;

// 复制图片到剪贴板
rm.writeClipImg = function (imgsrc) {
  console.log("按下复制");
  rm.hideRightMenu();
  anzhiyu.snackbarShow("正在下载中，请稍后", false, 10000);
  if (rm.downloadimging == false) {
    rm.downloadimging = true;
    setTimeout(function () {
      copyImage(imgsrc);
      anzhiyu.snackbarShow("复制成功！图片已添加盲水印，请遵守版权协议");
      rm.downloadimging = false;
    }, "10000");
  }
};

function imageToBlob(imageURL) {
  const img = new Image();
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  img.crossOrigin = "";
  img.src = imageURL;
  return new Promise(resolve => {
    img.onload = function () {
      c.width = this.naturalWidth;
      c.height = this.naturalHeight;
      ctx.drawImage(this, 0, 0);
      c.toBlob(
        blob => {
          // here the image is a blob
          resolve(blob);
        },
        "image/png",
        0.75
      );
    };
  });
}

async function copyImage(imageURL) {
  const blob = await imageToBlob(imageURL);
  const item = new ClipboardItem({ "image/png": blob });
  navigator.clipboard.write([item]);
}

rm.copyUrl = function (id) {
  const input = document.createElement("input"); // Create a new <input> element
  input.id = "copyVal"; // Set the id of the new element to "copyVal"
  document.body.appendChild(input); // Append the new element to the end of the <body> element
  
  const text = id;
  input.value = text;
  input.select();
  input.setSelectionRange(0, input.value.length);
  document.execCommand("copy");
  
  input.remove(); // Remove the <input> element from the DOM
};

function stopMaskScroll() {
  if (document.getElementById("rightmenu-mask")) {
    let xscroll = document.getElementById("rightmenu-mask");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //阻止浏览器默认方法
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
  if (document.getElementById("rightMenu")) {
    let xscroll = document.getElementById("rightMenu");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //阻止浏览器默认方法
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
}

rm.rightmenuCopyText = function (txt) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt);
  }
  rm.hideRightMenu();
};

rm.copyPageUrl = function (url) {
  if (!url) {
    url = window.location.href;
  }
  rm.copyUrl(url);
  anzhiyu.snackbarShow("复制链接地址成功", false, 2000);
  rm.hideRightMenu();
};

rm.sharePage = function () {
  var content = window.location.href;
  rm.copyUrl(url);
  anzhiyu.snackbarShow("复制链接地址成功", false, 2000);
  rm.hideRightMenu();
};

// 复制当前选中文本
var selectTextNow = "";
document.onmouseup = document.ondblclick = selceText;

function selceText() {
  var txt;
  if (document.selection) {
    txt = document.selection.createRange().text;
  } else {
    txt = window.getSelection().toString();
  }
  selectTextNow = txt !== "" ? txt : "";
}

// 读取剪切板
rm.readClipboard = function () {
  if (navigator.clipboard) {
    navigator.clipboard.readText().then(clipText => rm.insertAtCaret(globalEvent.target, clipText));
  }
};

// 粘贴文本到焦点
rm.insertAtCaret = function (elemt, value) {
  const startPos = elemt.selectionStart,
    endPos = elemt.selectionEnd;
  if (document.selection) {
    elemt.focus();
    var sel = document.selection.createRange();
    sel.text = value;
    elemt.focus();
  } else {
    if (startPos || startPos == "0") {
      var scrollTop = elemt.scrollTop;
      elemt.value = elemt.value.substring(0, startPos) + value + elemt.value.substring(endPos, elemt.value.length);
      elemt.focus();
      elemt.selectionStart = startPos + value.length;
      elemt.selectionEnd = startPos + value.length;
      elemt.scrollTop = scrollTop;
    } else {
      elemt.value += value;
      elemt.focus();
    }
  }
};

//粘贴文本
rm.pasteText = function () {
  const result = rm.readClipboard() || "";
  rm.hideRightMenu();
};

//引用到评论
rm.rightMenuCommentText = function (txt) {
  rm.hideRightMenu();
  const postCommentDom = document.getElementById("post-comment");
  var domTop = postCommentDom.offsetTop;
  window.scrollTo(0, domTop - 80);
  if (txt == "undefined" || txt == "null") txt = "好棒！";
  function setText() {
    setTimeout(() => {
      var input = document.getElementsByClassName("el-textarea__inner")[0];
      if (!input) setText();
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("input", true, true);
      let inputValue = replaceAll(txt, "\n", "\n> ");
      input.value = "> " + inputValue + "\n\n";
      input.dispatchEvent(evt);
      input.focus();
      input.setSelectionRange(-1, -1);
      if (document.getElementById("comment-tips")) {
        document.getElementById("comment-tips").classList.add("show");
      }
    }, 100);
  }
  setText();
};

//替换所有内容
function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

// 百度搜索
rm.searchBaidu = function () {
  anzhiyu.snackbarShow("即将跳转到百度搜索", false, 2000);
  setTimeout(function () {
    window.open("https://www.baidu.com/s?wd=" + selectTextNow);
  }, "2000");
  rm.hideRightMenu();
};

//分享链接
rm.copyLink = function () {
  rm.rightmenuCopyText(domhref);
  anzhiyu.snackbarShow("已复制链接地址");
};

function addRightMenuClickEvent() {
  // 添加点击事件
  document.getElementById("menu-backward").addEventListener("click", function () {
  window.history.back();
    rm.hideRightMenu();
  });

  document.getElementById("menu-forward").addEventListener("click", function () {
    window.history.forward();
    rm.hideRightMenu();
  });

  document.getElementById("menu-refresh").addEventListener("click", function () {
    window.location.reload();
  });

  document.getElementById("menu-top").addEventListener("click", function () {
    anzhiyu.scrollToDest(0, 500);
    rm.hideRightMenu();
  });

  const menuLinks = document.querySelectorAll(".menu-link");
  menuLinks.forEach(function (link) {
    link.addEventListener("click", rm.hideRightMenu);
  });

  document.getElementById("menu-darkmode").addEventListener("click", anzhiyu.switchDarkMode);

  document.getElementById("menu-home") && document.getElementById("menu-home").addEventListener("click", function () {
    window.location.href = window.location.origin;
  });

  document.getElementById("menu-randomPost").addEventListener("click", function () {
    toRandomPost();
  });

  document.getElementById("menu-commentBarrage").addEventListener("click", anzhiyu.switchCommentBarrage);

  document.getElementById("rightmenu-mask").addEventListener("click", rm.hideRightMenu);

  document.getElementById("rightmenu-mask").addEventListener("contextmenu", function (event) {
    rm.hideRightMenu();
    event.preventDefault(); // Prevent the default context menu from appearing
  });

  document.getElementById("menu-copy").addEventListener("click", rm.copyPageUrl);

  document.getElementById("menu-pastetext").addEventListener("click", rm.pasteText);

  document.getElementById("menu-copytext").addEventListener("click", function () {
    rm.rightmenuCopyText(selectTextNow);
    anzhiyu.snackbarShow("复制成功，复制和转载请标注本文地址");
  });

  document.getElementById("menu-commenttext").addEventListener("click", function () {
    rm.rightMenuCommentText(selectTextNow);
  });

  document.getElementById("menu-newwindow").addEventListener("click", function () {
    window.open(domhref, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copylink").addEventListener("click", rm.copyLink);

  document.getElementById("menu-downloadimg").addEventListener("click", function () {
    anzhiyu.downloadImage(domImgSrc, "anzhiyu");
  });

  document.getElementById("menu-newwindowimg").addEventListener("click", function () {
    window.open(domImgSrc, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copyimg").addEventListener("click", function () {
    rm.writeClipImg(domImgSrc);
  });

  document.getElementById("menu-searchBaidu").addEventListener("click", rm.searchBaidu);

  //音乐
  document.getElementById("menu-music-toggle").addEventListener("click", anzhiyu.musicToggle);

  document.getElementById("menu-music-back").addEventListener("click", anzhiyu.musicSkipBack);

  document.getElementById("menu-music-forward").addEventListener("click", anzhiyu.musicSkipForward);

  document.getElementById("menu-music-copyMusicName").addEventListener("click", function () {
    rm.rightmenuCopyText(anzhiyu.musicGetName());
    anzhiyu.snackbarShow("复制歌曲名称成功", false, 3000);
  });

}

addRightMenuClickEvent();</script><script data-pjax>var themeColorMeta = document.querySelector('meta[name="theme-color"]');
var pageHeaderEl = document.getElementById("page-header");
var navMusicEl = document.getElementById("nav-music");
var consoleEl = document.getElementById("console");
// 已随机的歌曲
var selectRandomSong = [];
// 音乐默认声音大小
var musicVolume = 0.8;
// 是否切换了周杰伦音乐列表
var changeMusicListFlag = false;
// 当前默认播放列表
var defaultPlayMusicList = [];

document.getElementById("page-name").innerText = document.title.split(" | Smith")[0];
anzhiyu.initIndexEssay();
anzhiyu.changeTimeInEssay();
anzhiyu.removeBodyPaceClass();
anzhiyu.qrcodeCreate();
anzhiyu.changeTimeInAlbumDetail();
anzhiyu.reflashEssayWaterFall();
anzhiyu.sayhi();
anzhiyu.stopImgRightDrag();
anzhiyu.addNavBackgroundInit();
anzhiyu.setValueToBodyType();
anzhiyu.catalogActive();
anzhiyu.tagsPageActive();
anzhiyu.categoriesBarActive();
anzhiyu.topCategoriesBarScroll();
anzhiyu.switchRightClickMenuHotReview();
anzhiyu.getCustomPlayList();
anzhiyu.addEventListenerConsoleMusicList(false);
setTimeout(() => {if (typeof addFriendLinksInFooter === "function") {addFriendLinksInFooter();}}, 200)</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://npm.elemecdn.com/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div></body></html>